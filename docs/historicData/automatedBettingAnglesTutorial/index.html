
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Documentation, guides and articles on creating, developing and implementing automated betting strategies, using data analysis to inform betting models and how to interact with the Betfair API.">
      
      
        <meta name="author" content="Betfair Data Scientists">
      
      
        <link rel="canonical" href="https://betfair-datascientists.github.io/historicData/automatedBettingAnglesTutorial/">
      
      <link rel="icon" href="../../img/BetfairFavicon.ico">
      <meta name="generator" content="mkdocs-1.3.0, mkdocs-material-8.2.9">
    
    
      
        <title>Automated betting angles in Python - The Automation Hub</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.120efc48.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.9647289d.min.css">
        
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/betfair.css">
    
      <link rel="stylesheet" href="../../css/ansi-colours.css">
    
      <link rel="stylesheet" href="../../css/jupyter-cells.css">
    
      <link rel="stylesheet" href="../../css/pandas-dataframe.css">
    
    <script>__md_scope=new URL("../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  


  <script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-125973915-1","auto"),ga("set","anonymizeIp",!0),ga("send","pageview"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){var e;this.value&&(e=document.location.pathname,ga("send","pageview",e+"?q="+this.value))}),"undefined"!=typeof location$&&location$.subscribe(function(e){ga("send","pageview",e.pathname)})})</script>
  <script async src="https://www.google-analytics.com/analytics.js"></script>


    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="betfair" data-md-color-primary="amber" data-md-color-accent="orange">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#automated-betting-angles-in-python" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      
  
  <header class="md-header" data-md-component="header">
    <nav class="md-header__inner md-grid" aria-label="Header">
      <a href="../.." title="The Automation Hub" class="md-header__button md-logo" aria-label="The Automation Hub" data-md-component="logo">
        
  <img src="../../img/logo.svg" alt="logo">

      </a>
      <label class="md-header__button md-icon" for="__drawer">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
      </label>
      <div class="md-header__title" data-md-component="header-title">
        <div class="md-header__ellipsis">
          <div class="md-header__topic">
            <span class="md-ellipsis">
              The Automation Hub
            </span>
          </div>
          <div class="md-header__topic" data-md-component="header-topic">
            <span class="md-ellipsis">
              
                Automated betting angles in Python
              
            </span>
          </div>
        </div>
      </div>

      
        <form class="md-header__option" data-md-component="palette">
          
            
            
            <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="betfair" data-md-color-primary="amber" data-md-color-accent="orange"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
            
              <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3 3.19.09m3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95 2.06.05m-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31Z"/></svg>
              </label>
            
          
            
            
            <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="amber" data-md-color-accent="orange"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
            
              <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5c-.84 0-1.65.15-2.39.42L12 2M3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29L3.34 7m.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14L3.36 17M20.65 7l-1.77 3.79a7.023 7.023 0 0 0-2.38-4.15l4.15.36m-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29L20.64 17M12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44L12 22Z"/></svg>
              </label>
            
          
        </form>
      
      

      
        <label class="md-header__button md-icon" for="__search">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
     
      <div class="bf-nav">
        <a class="bf-hidable" href="https://www.betfair.com.au/exchange/plus/"><svg class="exchangeLogo" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:cc="http://creativecommons.org/ns#"
          xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 38.775 4.59" width="24" height="17">
          <path class="st1" d="m 160.3,-136.95 v 26" />
          <g transform="translate(18.8,-137.15)">
            <path d="m 2.2901089,126.53441 v 5.20093 H -3.3107216 L 7.4888397,144.33446 18.2884,131.73534 h -5.598633 v -5.20093 z m -8.6000974,8.10132 -10.8017585,12.59913 h 5.60083 v 5.2998 h 10.3996581 v -5.2998 h 5.6008306 z" />
          </g>
        </svg><span> Exchange</span></a>
        <a href="https://www.betfair.com.au/hub/">Hub</a>
      </div>

      

    </nav>
    
  </header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href="../.." class="md-tabs__link">
      Home
    </a>
  </li>

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../api/apiResources/" class="md-tabs__link">
        API
      </a>
    </li>
  

      
        
  
  
    
  


  
  
  
    <li class="md-tabs__item">
      <a href="../dataSources/" class="md-tabs__link md-tabs__link--active">
        Historic Data
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../modelling/howToModel/" class="md-tabs__link">
        Modelling
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../autoTools/overview/" class="md-tabs__link">
        Auto Tools
      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="The Automation Hub" class="md-nav__button md-logo" aria-label="The Automation Hub" data-md-component="logo">
      
  <img src="../../img/logo.svg" alt="logo">

    </a>
    The Automation Hub
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" data-md-state="indeterminate" type="checkbox" id="__nav_2" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          API
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="API" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          API
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../api/apiResources/" class="md-nav__link">
        API resources
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../api/apiappkey/" class="md-nav__link">
        How to access the Betfair API
      </a>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_3" data-md-state="indeterminate" type="checkbox" id="__nav_2_3" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_2_3">
          Tutorials
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Tutorials" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_3">
          <span class="md-nav__icon md-icon"></span>
          Tutorials
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../api/apiRtutorial/" class="md-nav__link">
        API tutorials in R
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../api/apiPythontutorial/" class="md-nav__link">
        API tutorial in Python
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../api/GoldenRulesofAutomation/" class="md-nav__link">
        Golden rules of automation
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          Historic Data
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Historic Data" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Historic Data
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../dataSources/" class="md-nav__link">
        Pricing Data Sources
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_2" type="checkbox" id="__nav_3_2" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_3_2">
          Tutorials
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Tutorials" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_2">
          <span class="md-nav__icon md-icon"></span>
          Tutorials
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../jsonToCsvTutorial/" class="md-nav__link">
        JSON to CSV in Python
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../jsonToCsvRevisited/" class="md-nav__link">
        JSON to CSV | Revisited
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../backtestingRatingsTutorial/" class="md-nav__link">
        Back testing ratings in Python
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Automated betting angles in Python
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Automated betting angles in Python
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#workshop" class="md-nav__link">
    Workshop
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cheat-sheet" class="md-nav__link">
    Cheat sheet
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#01-setup" class="md-nav__link">
    0.1 Setup
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#02-context" class="md-nav__link">
    0.2 Context
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#03-examples" class="md-nav__link">
    0.3 Examples
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#10-data" class="md-nav__link">
    1.0 Data
  </a>
  
    <nav class="md-nav" aria-label="1.0 Data">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#11-betfair-odds-data" class="md-nav__link">
    1.1 Betfair Odds Data
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#12-race-data" class="md-nav__link">
    1.2 Race Data
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#extract-betfair-racing-markets-for-a-given-date" class="md-nav__link">
    Extract Betfair Racing Markets for a Given Date
  </a>
  
    <nav class="md-nav" aria-label="Extract Betfair Racing Markets for a Given Date">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#extract-key-race-metadata" class="md-nav__link">
    Extract Key Race Metadata
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#wrapper-function" class="md-nav__link">
    Wrapper Function
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#20-analysis" class="md-nav__link">
    2.0 Analysis
  </a>
  
    <nav class="md-nav" aria-label="2.0 Analysis">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21-assemble-data" class="md-nav__link">
    2.1 Assemble Data
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22-methodology" class="md-nav__link">
    2.2 Methodology
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#231-chunking" class="md-nav__link">
    2.3.1 Chunking
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#232-in-sample-vs-out-of-sample" class="md-nav__link">
    2.3.2 In Sample vs Out of Sample
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#233-statistically-measuring-profit" class="md-nav__link">
    2.3.3 Statistically Measuring Profit
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#24-angle-1-track-distance-barrier" class="md-nav__link">
    2.4 Angle 1: Track | Distance | Barrier
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#25-angle-2-jockeys-market-opinion" class="md-nav__link">
    2.5 Angle 2: Jockeys + Market Opinion
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#26-angle-3-backing-to-lay" class="md-nav__link">
    2.6 Angle 3: Backing To Lay
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#30-conclusion" class="md-nav__link">
    3.0 Conclusion
  </a>
  
    <nav class="md-nav" aria-label="3.0 Conclusion">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#complete-code" class="md-nav__link">
    Complete code
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#disclaimer" class="md-nav__link">
    Disclaimer
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../analysingAndPredictingMarketMovements/" class="md-nav__link">
        Do &#35theyknow? Analysing Betfair market formation & market movements
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../analysingAndPredictingBSP/" class="md-nav__link">
        Wisdom of the crowd? Analysing & understanding BSP
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" data-md-state="indeterminate" type="checkbox" id="__nav_4" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          Modelling
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Modelling" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Modelling
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/howToModel/" class="md-nav__link">
        Intro to modelling
      </a>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_2" data-md-state="indeterminate" type="checkbox" id="__nav_4_2" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_4_2">
          Racing
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Racing" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_2">
          <span class="md-nav__icon md-icon"></span>
          Racing
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/fasttrackTutorial/" class="md-nav__link">
        Greyhound form FastTrack API
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/greyhoundModellingPython/" class="md-nav__link">
        Greyhound modelling in Python
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_3" data-md-state="indeterminate" type="checkbox" id="__nav_4_3" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_4_3">
          Soccer
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Soccer" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_3">
          <span class="md-nav__icon md-icon"></span>
          Soccer
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/soccerEloTutorialR/" class="md-nav__link">
        Elo soccer tutorial in R
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/soccerModellingTutorialPython/" class="md-nav__link">
        Soccer modelling tutorial in Python
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/soccerModellingTutorialR/" class="md-nav__link">
        Soccer modelling tutorial in R
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/EPLmlPython/" class="md-nav__link">
        EPL ML walk through in Python
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_4" data-md-state="indeterminate" type="checkbox" id="__nav_4_4" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_4_4">
          AFL
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="AFL" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_4">
          <span class="md-nav__icon md-icon"></span>
          AFL
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/AFLmodellingPython/" class="md-nav__link">
        AFL modelling walk through in Python
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/brownlowModelTutorial/" class="md-nav__link">
        Modelling the Brownlow Medal in Python
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_5" data-md-state="indeterminate" type="checkbox" id="__nav_4_5" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_4_5">
          Tennis
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Tennis" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_5">
          <span class="md-nav__icon md-icon"></span>
          Tennis
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/howToModelTheAusOpen/" class="md-nav__link">
        How to model the Australian Open
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/AusOpenRTutorial/" class="md-nav__link">
        Aus Open R Tutorial
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/AusOpenPythonTutorial/" class="md-nav__link">
        Aus Open Python Tutorial
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" data-md-state="indeterminate" type="checkbox" id="__nav_5" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_5">
          Auto Tools
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Auto Tools" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Auto Tools
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../autoTools/overview/" class="md-nav__link">
        Tools Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_2" data-md-state="indeterminate" type="checkbox" id="__nav_5_2" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_5_2">
          Bet Angel
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Bet Angel" data-md-level="2">
        <label class="md-nav__title" for="__nav_5_2">
          <span class="md-nav__icon md-icon"></span>
          Bet Angel
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../autoTools/betAngel/betAngel/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../autoTools/betAngelbeginners/" class="md-nav__link">
        Beginner's guide
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../autoTools/betAngelintermediate/" class="md-nav__link">
        Intermediate guide
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../autoTools/betAngeladvanced/" class="md-nav__link">
        Advanced guide
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../autoTools/betAngelRatingsAutomation/" class="md-nav__link">
        Ratings auto
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../autoTools/betAngelMarketFavouriteAutomation/" class="md-nav__link">
        Market fav auto
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../autoTools/betAngelTippingAutomation/" class="md-nav__link">
        Tipping auto
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../autoTools/betAngelSimultaneousMarkets/" class="md-nav__link">
        Simultaneous markets
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../autoTools/betAngelKellyStake/" class="md-nav__link">
        Kelly criterion staking
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_3" data-md-state="indeterminate" type="checkbox" id="__nav_5_3" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_5_3">
          Gruss Betting Assistant
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Gruss Betting Assistant" data-md-level="2">
        <label class="md-nav__title" for="__nav_5_3">
          <span class="md-nav__icon md-icon"></span>
          Gruss Betting Assistant
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../autoTools/Gruss/Gruss/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../autoTools/GrussSettingupbasicmarketview/" class="md-nav__link">
        Setup basic market view and one click betting
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../autoTools/grussRatingsAutomation/" class="md-nav__link">
        Ratings auto
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../autoTools/grussMarketFavouriteAutomation/" class="md-nav__link">
        Market fav auto
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../autoTools/grusslSimultaneousMarkets/" class="md-nav__link">
        Simultaneous markets
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../autoTools/grussKellyStake/" class="md-nav__link">
        Kelly criterion staking
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_4" data-md-state="indeterminate" type="checkbox" id="__nav_5_4" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_5_4">
          Cymatic Trader
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Cymatic Trader" data-md-level="2">
        <label class="md-nav__title" for="__nav_5_4">
          <span class="md-nav__icon md-icon"></span>
          Cymatic Trader
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../autoTools/CymaticTrader/CymaticTrader/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../autoTools/cymaticTraderRatingsAutomation/" class="md-nav__link">
        Ratings auto
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_5" data-md-state="indeterminate" type="checkbox" id="__nav_5_5" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_5_5">
          Geeks Toy
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Geeks Toy" data-md-level="2">
        <label class="md-nav__title" for="__nav_5_5">
          <span class="md-nav__icon md-icon"></span>
          Geeks Toy
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../autoTools/GeeksToyinstallationandsetup/" class="md-nav__link">
        Installation and setup
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../autoTools/GeeksToybasicmarketviewstakingandoneclickbetting/" class="md-nav__link">
        Setup basic market view and one click betting
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../autoTools/geeksToyRefreshSettings/" class="md-nav__link">
        Optimising refresh settings
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script>
(function() {
  function addWidgetsRenderer() {
    var requireJsScript = document.createElement('script');
    requireJsScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js';

    var mimeElement = document.querySelector('script[type="application/vnd.jupyter.widget-view+json"]');
    var jupyterWidgetsScript = document.createElement('script');
    var widgetRendererSrc = 'https://unpkg.com/@jupyter-widgets/html-manager@*/dist/embed-amd.js';
    var widgetState;

    // Fallback for older version:
    try {
      widgetState = mimeElement && JSON.parse(mimeElement.innerHTML);

      if (widgetState && (widgetState.version_major < 2 || !widgetState.version_major)) {
        widgetRendererSrc = 'jupyter-js-widgets@*/dist/embed.js';
      }
    } catch(e) {}

    jupyterWidgetsScript.src = widgetRendererSrc;

    document.body.appendChild(requireJsScript);
    document.body.appendChild(jupyterWidgetsScript);
  }

  document.addEventListener('DOMContentLoaded', addWidgetsRenderer);
}());
</script>

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="automated-betting-angles-in-python">Automated betting angles in Python</h1>
<p>| Betting strategies based on your existing insights: no modelling required</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<hr />
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="workshop">Workshop</h3>
<iframe allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen="allowfullscreen" frameborder="0" height="315" src="https://www.youtube.com/embed/qdfwldinJOg" title="YouTube video player" width="560"></iframe>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<hr />
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This tutorial was written by <a href="https://github.com/TMBish">Tom Bishop</a> and was <a href="https://github.com/TMBish/bfStreamTutorials/blob/main/02-angles/article/angles.ipynb">originally published on Github</a>. It is shared here with his permission. </p>
<p>This tutorial follows on logically from the <a href="https://betfair-datascientists.github.io/historicData/jsonToCsvTutorial/">JSON to CSV tutorial</a> and <a href="https://betfair-datascientists.github.io/historicData/jsonToCsvTutorial/">backteseting ratings in Python tutorial</a> we shared previously. If you're still new to working with the JSON data sets we suggest you take a look at those tutorials before diving into this one. </p>
<p>As always please <a href="mailto:automation@betfair.com.au">reach out</a> with feedback, suggestions or queries, or feel free to submit a <a href="https://github.com/betfair-down-under/autoHubTutorials/pulls">pull request</a> if you catch some bugs or have other improvements! </p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="cheat-sheet">Cheat sheet</h3>
<ul>
<li>This is presented as a Jupyter notebook as this format is interactive and lets you run snippets of code from wihtin the notebook. To use this functionality <a href="https://github.com/betfair-down-under/autoHubTutorials/blob/master/automatedBettingAngles/automatedBettingAnglesTutorial.ipynb">you'll need to download a copy of the <code>ipynb</code> file locally</a> and open it in a text editor (i.e. VS code).</li>
<li>If you're looking for the complete code <a href="https://betfair-datascientists.github.io/historicData/automatedBettingAnglesTutorial/#complete-code">head to the bottom of the page</a> or <a href="https://github.com/betfair-down-under/autoHubTutorials/blob/404ec04284e2ac3ac2f97f4117c77bf27d72be1e/automatedBettingAngles/main.py">download the script from Github</a>.</li>
<li>To run the code, save it to your machine, open a command prompt, or a terminal in your text editor of choice (we're using <a href="https://code.visualstudio.com/download">VS code</a>), make sure you've navigated in the terminal to the folder you've saved the script in and then type <code>py main.py</code> (or whatever you've called your script file if not main) then hit enter. To stop the code running use Ctrl C. </li>
<li>Make sure you amend your data path to point to your data file. We'll be taking in an input of a historical tar file downloaded from the <a href="https://historicdata.betfair.com/#/help">Betfair historic data site</a>. We're using a PRO version, though the code should work on ADVANCED too. This approach won't work with the BASIC data tier. </li>
<li>We're using the <a href="https://github.com/liampauling/betfair/tree/master/betfairlightweight"><code>betfairlightweight</code></a> package to do the heavy lifting</li>
<li>We've also posted the completed code logic on the <a href="https://github.com/betfair-down-under/autoHubTutorials/blob/404ec04284e2ac3ac2f97f4117c77bf27d72be1e/automatedBettingAngles/main.py"><code>betfair-downunder</code> Github repo</a>.</li>
</ul>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<hr />
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="01-setup">0.1 Setup</h2>
<p>Once again I'll be presenting the analysis in a jupyter notebook and will be using python as a programming language.</p>
<p>Some of the data processing code takes a while to execute - that code will be in cells that are commented out - and will require a bit of adjustment to point to places on your computer where you want to locally store the intermediate data files.</p>
<p>You'll also need <code>betfairlightweight</code> which you can install with something like <code>pip install betfairlightweight</code>.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="kn">import</span> <span class="nn">requests</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">date</span><span class="p">,</span> <span class="n">timedelta</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="kn">import</span> <span class="nn">os</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="kn">import</span> <span class="nn">re</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="kn">import</span> <span class="nn">tarfile</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="kn">import</span> <span class="nn">zipfile</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="kn">import</span> <span class="nn">bz2</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="kn">import</span> <span class="nn">glob</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="kn">import</span> <span class="nn">logging</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="kn">import</span> <span class="nn">yaml</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a><span class="kn">from</span> <span class="nn">unittest.mock</span> <span class="kn">import</span> <span class="n">patch</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Set</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Optional</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a><span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">zip_longest</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a><span class="kn">import</span> <span class="nn">betfairlightweight</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a><span class="kn">from</span> <span class="nn">betfairlightweight</span> <span class="kn">import</span> <span class="n">StreamListener</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a><span class="kn">from</span> <span class="nn">betfairlightweight.resources.bettingresources</span> <span class="kn">import</span> <span class="p">(</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>    <span class="n">PriceSize</span><span class="p">,</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>    <span class="n">MarketBook</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a><span class="p">)</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a><span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">t</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a><span class="kn">import</span> <span class="nn">plotly.express</span> <span class="k">as</span> <span class="nn">px</span>
</code></pre></div>

</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<hr />
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="02-context">0.2 Context</h2>
<p>Formulating betting angles (or "strategies" as some call them) is quite a common pasttime for some. These angles can range all the way from very simple to quite sophisticated, and could include things like:</p>
<ul>
<li>Laying NBA teams playing on the second night of a back-to-back</li>
<li>Laying AFL team coming off a bye when matched against a team who played last week</li>
<li>Backing a greyhound in boxes 1 or 2 in short sprint style races</li>
<li>Backing a horse pre-race who typically runs at the front of the field and placing an order to lay the same horse if it shortens to some lower price in-play, locking in a profit</li>
</ul>
<p>Beyond the complexity of the actual concept what really seperates these angles is evidence. You might have heard TV personalities and betting ads suggest a certain strategy (resembling one of the above) are real-world predictive trends but they rarely are. They are rarely derived from the right historical data or are concluded without the necessary statistical rigour. Most simply formulated their angles off intuition or observing a trend across a small sample of data.</p>
<p>There <strong>are</strong> many users on betting exchanges who profit off these angles. In fact, when most people talk about automated or sophisticated exchange betting they are often talking about automating these kind of betting angles, as opposed to betting ratings produced from a sophisticated bottom-up fundemental modelling. That's because profitable fundemental modelling (where your model which arrives at some estimation of fair value from first principles) is very hard.</p>
<p>The reason this approach is so much easier is that you assume the market odds are right <strong>except x</strong> and go from there, applying small top-down adjustments for factors that haven't historically been incorporated in the market opinion. The challenge lies in finding those factors and making sure you aren't tricking yourself in thinking you've found one that you can profit off in the future.</p>
<p>Once again this is another example of the uses of the Betfair historical stream data. To get cracking - as always - we need historical odds and the best place to get that is to self serve the historical stream files.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<hr />
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="03-examples">0.3 Examples</h2>
<p>I'll go through an end-to-end example of 3 different betting angles on Australian thoroughbred racing. Which will include: Which will include:</p>
<ul>
<li>Sourcing data</li>
<li>Assembling data</li>
<li>Formulating hypotheses</li>
<li>Testing Hypotheses</li>
<li>Discussion about implementation</li>
</ul>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<hr />
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="10-data">1.0 Data</h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="11-betfair-odds-data">1.1 Betfair Odds Data</h3>
<p>We'll follow a very similar template as other tutorials extracting key information from the betfair stream data.</p>
<p>It's important to note that given the volume of data you need to handle with these stream files, your workflow will probably involve choosing some methods of aggregation / summary that you'll reconsider after your first cut of analysis. Parsing and saving a dataset, using it to test some hypotheses which likely results in more questions that need to be examined by reparsing the stream files in a slightly different way. Your workflow will likely follow something like this diagram.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><img alt="" src="../img/streamCycle.png" /></p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>For the purposes of this article I'm interested in backtesting some betting angles at the BSP, using some indication of price momentum/market support in some angles, and testing some back to lay strategies so we'll need to pull out some information about each runners in-play trading. </p>
<p>So we'll extract the following for each runner:
- BSP
- Last Traded Price
- Volume Weighted Avg Price (top 3 boxes) 5 mins before the scheduled jump time
- Volume Weighted Avg Price (top 3 boxes) 30 seconds before the scheduled jump time
- The volume traded on the selection
- The minimum "best available to lay" price offered inplay (which is a measure of how low the selection traded during the race)</p>
<p>First we'll establish some utility functions needed to parse the data. Most of these were discussed in the previous <a href="https://betfair-datascientists.github.io/historicData/backtestingRatingsTutorial/">backtest your ratings</a> tutorial.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="c1"># Utility Functions For Stream Parsing</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="c1"># _________________________________</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="k">def</span> <span class="nf">as_str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>    <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">v</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">float</span> <span class="k">else</span> <span class="n">v</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a>
<a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a><span class="k">def</span> <span class="nf">split_anz_horse_market_name</span><span class="p">(</span><span class="n">market_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a>    <span class="n">parts</span> <span class="o">=</span> <span class="n">market_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
<a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a>    <span class="n">race_no</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># return example R6</span>
<a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a>    <span class="n">race_len</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># return example 1400m</span>
<a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a>    <span class="n">race_type</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="c1"># return example grp1, trot, pace</span>
<a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a>    <span class="k">return</span> <span class="p">(</span><span class="n">race_no</span><span class="p">,</span> <span class="n">race_len</span><span class="p">,</span> <span class="n">race_type</span><span class="p">)</span>
<a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a>
<a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a><span class="k">def</span> <span class="nf">filter_market</span><span class="p">(</span><span class="n">market</span><span class="p">:</span> <span class="n">MarketBook</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span> 
<a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a>    <span class="n">d</span> <span class="o">=</span> <span class="n">market</span><span class="o">.</span><span class="n">market_definition</span>
<a id="__codelineno-1-16" name="__codelineno-1-16" href="#__codelineno-1-16"></a>    <span class="k">return</span> <span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">country_code</span> <span class="o">==</span> <span class="s1">&#39;AU&#39;</span> 
<a id="__codelineno-1-17" name="__codelineno-1-17" href="#__codelineno-1-17"></a>        <span class="ow">and</span> <span class="n">d</span><span class="o">.</span><span class="n">market_type</span> <span class="o">==</span> <span class="s1">&#39;WIN&#39;</span> 
<a id="__codelineno-1-18" name="__codelineno-1-18" href="#__codelineno-1-18"></a>        <span class="ow">and</span> <span class="p">(</span><span class="n">c</span> <span class="o">:=</span> <span class="n">split_anz_horse_market_name</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">name</span><span class="p">)[</span><span class="mi">2</span><span class="p">])</span> <span class="o">!=</span> <span class="s1">&#39;trot&#39;</span> <span class="ow">and</span> <span class="n">c</span> <span class="o">!=</span> <span class="s1">&#39;pace&#39;</span><span class="p">)</span>
<a id="__codelineno-1-19" name="__codelineno-1-19" href="#__codelineno-1-19"></a>
<a id="__codelineno-1-20" name="__codelineno-1-20" href="#__codelineno-1-20"></a><span class="k">def</span> <span class="nf">load_markets</span><span class="p">(</span><span class="n">file_paths</span><span class="p">):</span>
<a id="__codelineno-1-21" name="__codelineno-1-21" href="#__codelineno-1-21"></a>    <span class="k">for</span> <span class="n">file_path</span> <span class="ow">in</span> <span class="n">file_paths</span><span class="p">:</span>
<a id="__codelineno-1-22" name="__codelineno-1-22" href="#__codelineno-1-22"></a>        <span class="nb">print</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
<a id="__codelineno-1-23" name="__codelineno-1-23" href="#__codelineno-1-23"></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
<a id="__codelineno-1-24" name="__codelineno-1-24" href="#__codelineno-1-24"></a>            <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">iglob</span><span class="p">(</span><span class="n">file_path</span> <span class="o">+</span> <span class="s1">&#39;**/**/*.bz2&#39;</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<a id="__codelineno-1-25" name="__codelineno-1-25" href="#__codelineno-1-25"></a>                <span class="n">f</span> <span class="o">=</span> <span class="n">bz2</span><span class="o">.</span><span class="n">BZ2File</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
<a id="__codelineno-1-26" name="__codelineno-1-26" href="#__codelineno-1-26"></a>                <span class="k">yield</span> <span class="n">f</span>
<a id="__codelineno-1-27" name="__codelineno-1-27" href="#__codelineno-1-27"></a>                <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<a id="__codelineno-1-28" name="__codelineno-1-28" href="#__codelineno-1-28"></a>        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
<a id="__codelineno-1-29" name="__codelineno-1-29" href="#__codelineno-1-29"></a>            <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file_path</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-1-30" name="__codelineno-1-30" href="#__codelineno-1-30"></a>            <span class="c1"># iterate through a tar archive</span>
<a id="__codelineno-1-31" name="__codelineno-1-31" href="#__codelineno-1-31"></a>            <span class="k">if</span> <span class="n">ext</span> <span class="o">==</span> <span class="s1">&#39;.tar&#39;</span><span class="p">:</span>
<a id="__codelineno-1-32" name="__codelineno-1-32" href="#__codelineno-1-32"></a>                <span class="k">with</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">TarFile</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">archive</span><span class="p">:</span>
<a id="__codelineno-1-33" name="__codelineno-1-33" href="#__codelineno-1-33"></a>                    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">archive</span><span class="p">:</span>
<a id="__codelineno-1-34" name="__codelineno-1-34" href="#__codelineno-1-34"></a>                        <span class="k">yield</span> <span class="n">bz2</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">archive</span><span class="o">.</span><span class="n">extractfile</span><span class="p">(</span><span class="n">file</span><span class="p">))</span>
<a id="__codelineno-1-35" name="__codelineno-1-35" href="#__codelineno-1-35"></a>            <span class="c1"># or a zip archive</span>
<a id="__codelineno-1-36" name="__codelineno-1-36" href="#__codelineno-1-36"></a>            <span class="k">elif</span> <span class="n">ext</span> <span class="o">==</span> <span class="s1">&#39;.zip&#39;</span><span class="p">:</span>
<a id="__codelineno-1-37" name="__codelineno-1-37" href="#__codelineno-1-37"></a>                <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">archive</span><span class="p">:</span>
<a id="__codelineno-1-38" name="__codelineno-1-38" href="#__codelineno-1-38"></a>                    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">archive</span><span class="o">.</span><span class="n">namelist</span><span class="p">():</span>
<a id="__codelineno-1-39" name="__codelineno-1-39" href="#__codelineno-1-39"></a>                        <span class="k">yield</span> <span class="n">bz2</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">archive</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file</span><span class="p">))</span>
<a id="__codelineno-1-40" name="__codelineno-1-40" href="#__codelineno-1-40"></a>
<a id="__codelineno-1-41" name="__codelineno-1-41" href="#__codelineno-1-41"></a>    <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-1-42" name="__codelineno-1-42" href="#__codelineno-1-42"></a>
<a id="__codelineno-1-43" name="__codelineno-1-43" href="#__codelineno-1-43"></a><span class="k">def</span> <span class="nf">slicePrice</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
<a id="__codelineno-1-44" name="__codelineno-1-44" href="#__codelineno-1-44"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-1-45" name="__codelineno-1-45" href="#__codelineno-1-45"></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">price</span>
<a id="__codelineno-1-46" name="__codelineno-1-46" href="#__codelineno-1-46"></a>    <span class="k">except</span><span class="p">:</span>
<a id="__codelineno-1-47" name="__codelineno-1-47" href="#__codelineno-1-47"></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
<a id="__codelineno-1-48" name="__codelineno-1-48" href="#__codelineno-1-48"></a>    <span class="k">return</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-1-49" name="__codelineno-1-49" href="#__codelineno-1-49"></a>
<a id="__codelineno-1-50" name="__codelineno-1-50" href="#__codelineno-1-50"></a><span class="k">def</span> <span class="nf">sliceSize</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
<a id="__codelineno-1-51" name="__codelineno-1-51" href="#__codelineno-1-51"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-1-52" name="__codelineno-1-52" href="#__codelineno-1-52"></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">size</span>
<a id="__codelineno-1-53" name="__codelineno-1-53" href="#__codelineno-1-53"></a>    <span class="k">except</span><span class="p">:</span>
<a id="__codelineno-1-54" name="__codelineno-1-54" href="#__codelineno-1-54"></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
<a id="__codelineno-1-55" name="__codelineno-1-55" href="#__codelineno-1-55"></a>    <span class="k">return</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-1-56" name="__codelineno-1-56" href="#__codelineno-1-56"></a>
<a id="__codelineno-1-57" name="__codelineno-1-57" href="#__codelineno-1-57"></a><span class="k">def</span> <span class="nf">wapPrice</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
<a id="__codelineno-1-58" name="__codelineno-1-58" href="#__codelineno-1-58"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-1-59" name="__codelineno-1-59" href="#__codelineno-1-59"></a>        <span class="n">x</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span> <span class="p">[</span><span class="n">rung</span><span class="o">.</span><span class="n">price</span> <span class="o">*</span> <span class="n">rung</span><span class="o">.</span><span class="n">size</span> <span class="k">for</span> <span class="n">rung</span> <span class="ow">in</span> <span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">:(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span> <span class="p">]</span> <span class="p">)</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span> <span class="p">[</span><span class="n">rung</span><span class="o">.</span><span class="n">size</span> <span class="k">for</span> <span class="n">rung</span> <span class="ow">in</span> <span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">:(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span> <span class="p">]),</span><span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-1-60" name="__codelineno-1-60" href="#__codelineno-1-60"></a>    <span class="k">except</span><span class="p">:</span>
<a id="__codelineno-1-61" name="__codelineno-1-61" href="#__codelineno-1-61"></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
<a id="__codelineno-1-62" name="__codelineno-1-62" href="#__codelineno-1-62"></a>    <span class="k">return</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-1-63" name="__codelineno-1-63" href="#__codelineno-1-63"></a>
<a id="__codelineno-1-64" name="__codelineno-1-64" href="#__codelineno-1-64"></a><span class="k">def</span> <span class="nf">ladder_traded_volume</span><span class="p">(</span><span class="n">ladder</span><span class="p">):</span>
<a id="__codelineno-1-65" name="__codelineno-1-65" href="#__codelineno-1-65"></a>    <span class="k">return</span><span class="p">(</span><span class="nb">sum</span><span class="p">([</span><span class="n">rung</span><span class="o">.</span><span class="n">size</span> <span class="k">for</span> <span class="n">rung</span> <span class="ow">in</span> <span class="n">ladder</span><span class="p">]))</span>
</code></pre></div>

</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Then we'll create our core execution functions that will scan over the historical stream files and use <code>betfairlightweight</code> to recreate the state of the exchange for each thoroughbred market and extract key information for each selection</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="c1"># Core Execution Fucntions</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="c1"># _________________________________</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="k">def</span> <span class="nf">extract_components_from_stream</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a>    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s2">&quot;builtins.open&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">f</span><span class="p">,</span> <span class="n">_</span><span class="p">:</span> <span class="n">f</span><span class="p">):</span>   
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a>
<a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a>        <span class="n">evaluate_market</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a>        <span class="n">prev_market</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a>        <span class="n">postplay</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a>        <span class="n">preplay</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a>        <span class="n">t5m</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a>        <span class="n">t30s</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a>        <span class="n">inplay_min_lay</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a>
<a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a>        <span class="n">gen</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">get_generator</span><span class="p">()</span>
<a id="__codelineno-2-17" name="__codelineno-2-17" href="#__codelineno-2-17"></a>
<a id="__codelineno-2-18" name="__codelineno-2-18" href="#__codelineno-2-18"></a>        <span class="k">for</span> <span class="n">market_books</span> <span class="ow">in</span> <span class="n">gen</span><span class="p">():</span>
<a id="__codelineno-2-19" name="__codelineno-2-19" href="#__codelineno-2-19"></a>
<a id="__codelineno-2-20" name="__codelineno-2-20" href="#__codelineno-2-20"></a>            <span class="k">for</span> <span class="n">market_book</span> <span class="ow">in</span> <span class="n">market_books</span><span class="p">:</span>
<a id="__codelineno-2-21" name="__codelineno-2-21" href="#__codelineno-2-21"></a>
<a id="__codelineno-2-22" name="__codelineno-2-22" href="#__codelineno-2-22"></a>                <span class="c1"># If markets don&#39;t meet filter return None&#39;s</span>
<a id="__codelineno-2-23" name="__codelineno-2-23" href="#__codelineno-2-23"></a>                <span class="k">if</span> <span class="n">evaluate_market</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">((</span><span class="n">evaluate_market</span> <span class="o">:=</span> <span class="n">filter_market</span><span class="p">(</span><span class="n">market_book</span><span class="p">))</span> <span class="o">==</span> <span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-2-24" name="__codelineno-2-24" href="#__codelineno-2-24"></a>                    <span class="k">return</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-2-25" name="__codelineno-2-25" href="#__codelineno-2-25"></a>
<a id="__codelineno-2-26" name="__codelineno-2-26" href="#__codelineno-2-26"></a>                <span class="c1"># final market view before market goes in play</span>
<a id="__codelineno-2-27" name="__codelineno-2-27" href="#__codelineno-2-27"></a>                <span class="k">if</span> <span class="n">prev_market</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">prev_market</span><span class="o">.</span><span class="n">inplay</span> <span class="o">!=</span> <span class="n">market_book</span><span class="o">.</span><span class="n">inplay</span><span class="p">:</span>
<a id="__codelineno-2-28" name="__codelineno-2-28" href="#__codelineno-2-28"></a>                    <span class="n">preplay</span> <span class="o">=</span> <span class="n">market_book</span>
<a id="__codelineno-2-29" name="__codelineno-2-29" href="#__codelineno-2-29"></a>
<a id="__codelineno-2-30" name="__codelineno-2-30" href="#__codelineno-2-30"></a>                <span class="c1"># final market view before market goes is closed for settlement</span>
<a id="__codelineno-2-31" name="__codelineno-2-31" href="#__codelineno-2-31"></a>                <span class="k">if</span> <span class="n">prev_market</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">prev_market</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;OPEN&quot;</span> <span class="ow">and</span> <span class="n">market_book</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="n">prev_market</span><span class="o">.</span><span class="n">status</span><span class="p">:</span>
<a id="__codelineno-2-32" name="__codelineno-2-32" href="#__codelineno-2-32"></a>                    <span class="n">postplay</span> <span class="o">=</span> <span class="n">market_book</span>
<a id="__codelineno-2-33" name="__codelineno-2-33" href="#__codelineno-2-33"></a>
<a id="__codelineno-2-34" name="__codelineno-2-34" href="#__codelineno-2-34"></a>                <span class="c1"># Calculate Seconds Till Scheduled Market Start Time</span>
<a id="__codelineno-2-35" name="__codelineno-2-35" href="#__codelineno-2-35"></a>                <span class="n">seconds_to_start</span> <span class="o">=</span> <span class="p">(</span><span class="n">market_book</span><span class="o">.</span><span class="n">market_definition</span><span class="o">.</span><span class="n">market_time</span> <span class="o">-</span> <span class="n">market_book</span><span class="o">.</span><span class="n">publish_time</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
<a id="__codelineno-2-36" name="__codelineno-2-36" href="#__codelineno-2-36"></a>
<a id="__codelineno-2-37" name="__codelineno-2-37" href="#__codelineno-2-37"></a>                <span class="c1"># Market at 30 seconds before scheduled off</span>
<a id="__codelineno-2-38" name="__codelineno-2-38" href="#__codelineno-2-38"></a>                <span class="k">if</span> <span class="n">t30s</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">seconds_to_start</span> <span class="o">&lt;</span> <span class="mi">30</span><span class="p">:</span>
<a id="__codelineno-2-39" name="__codelineno-2-39" href="#__codelineno-2-39"></a>                    <span class="n">t30s</span> <span class="o">=</span> <span class="n">market_book</span>
<a id="__codelineno-2-40" name="__codelineno-2-40" href="#__codelineno-2-40"></a>
<a id="__codelineno-2-41" name="__codelineno-2-41" href="#__codelineno-2-41"></a>                <span class="c1"># Market at 5 mins before scheduled off</span>
<a id="__codelineno-2-42" name="__codelineno-2-42" href="#__codelineno-2-42"></a>                <span class="k">if</span> <span class="n">t5m</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">seconds_to_start</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="o">*</span><span class="mi">60</span><span class="p">:</span>
<a id="__codelineno-2-43" name="__codelineno-2-43" href="#__codelineno-2-43"></a>                    <span class="n">t5m</span> <span class="o">=</span> <span class="n">market_book</span>
<a id="__codelineno-2-44" name="__codelineno-2-44" href="#__codelineno-2-44"></a>
<a id="__codelineno-2-45" name="__codelineno-2-45" href="#__codelineno-2-45"></a>                <span class="c1"># Manage Inplay Vectors</span>
<a id="__codelineno-2-46" name="__codelineno-2-46" href="#__codelineno-2-46"></a>                <span class="k">if</span> <span class="n">market_book</span><span class="o">.</span><span class="n">inplay</span><span class="p">:</span>
<a id="__codelineno-2-47" name="__codelineno-2-47" href="#__codelineno-2-47"></a>
<a id="__codelineno-2-48" name="__codelineno-2-48" href="#__codelineno-2-48"></a>                    <span class="k">if</span> <span class="n">inplay_min_lay</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-2-49" name="__codelineno-2-49" href="#__codelineno-2-49"></a>                        <span class="n">inplay_min_lay</span> <span class="o">=</span> <span class="p">[</span> <span class="n">slicePrice</span><span class="p">(</span><span class="n">runner</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">available_to_lay</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">runner</span> <span class="ow">in</span> <span class="n">market_book</span><span class="o">.</span><span class="n">runners</span><span class="p">]</span>
<a id="__codelineno-2-50" name="__codelineno-2-50" href="#__codelineno-2-50"></a>                    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-2-51" name="__codelineno-2-51" href="#__codelineno-2-51"></a>                        <span class="n">inplay_min_lay</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fmin</span><span class="p">(</span><span class="n">inplay_min_lay</span><span class="p">,</span> <span class="p">[</span> <span class="n">slicePrice</span><span class="p">(</span><span class="n">runner</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">available_to_lay</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">runner</span> <span class="ow">in</span> <span class="n">market_book</span><span class="o">.</span><span class="n">runners</span><span class="p">])</span>
<a id="__codelineno-2-52" name="__codelineno-2-52" href="#__codelineno-2-52"></a>
<a id="__codelineno-2-53" name="__codelineno-2-53" href="#__codelineno-2-53"></a>                <span class="c1"># update reference to previous market</span>
<a id="__codelineno-2-54" name="__codelineno-2-54" href="#__codelineno-2-54"></a>                <span class="n">prev_market</span> <span class="o">=</span> <span class="n">market_book</span>
<a id="__codelineno-2-55" name="__codelineno-2-55" href="#__codelineno-2-55"></a>
<a id="__codelineno-2-56" name="__codelineno-2-56" href="#__codelineno-2-56"></a>        <span class="c1"># If market didn&#39;t go inplay</span>
<a id="__codelineno-2-57" name="__codelineno-2-57" href="#__codelineno-2-57"></a>        <span class="k">if</span> <span class="n">postplay</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">preplay</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-2-58" name="__codelineno-2-58" href="#__codelineno-2-58"></a>            <span class="n">preplay</span> <span class="o">=</span> <span class="n">postplay</span>
<a id="__codelineno-2-59" name="__codelineno-2-59" href="#__codelineno-2-59"></a>            <span class="n">inplay_min_lay</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&quot;</span> <span class="k">for</span> <span class="n">runner</span> <span class="ow">in</span> <span class="n">market_book</span><span class="o">.</span><span class="n">runners</span><span class="p">]</span>
<a id="__codelineno-2-60" name="__codelineno-2-60" href="#__codelineno-2-60"></a>
<a id="__codelineno-2-61" name="__codelineno-2-61" href="#__codelineno-2-61"></a>        <span class="k">return</span> <span class="p">(</span><span class="n">t5m</span><span class="p">,</span> <span class="n">t30s</span><span class="p">,</span> <span class="n">preplay</span><span class="p">,</span> <span class="n">postplay</span><span class="p">,</span> <span class="n">inplay_min_lay</span><span class="p">,</span> <span class="n">prev_market</span><span class="p">)</span> <span class="c1"># Final market is last prev_market</span>
<a id="__codelineno-2-62" name="__codelineno-2-62" href="#__codelineno-2-62"></a>
<a id="__codelineno-2-63" name="__codelineno-2-63" href="#__codelineno-2-63"></a><span class="k">def</span> <span class="nf">parse_stream</span><span class="p">(</span><span class="n">stream_files</span><span class="p">,</span> <span class="n">output_file</span><span class="p">):</span>
<a id="__codelineno-2-64" name="__codelineno-2-64" href="#__codelineno-2-64"></a>
<a id="__codelineno-2-65" name="__codelineno-2-65" href="#__codelineno-2-65"></a>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="s2">&quot;w+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">output</span><span class="p">:</span>
<a id="__codelineno-2-66" name="__codelineno-2-66" href="#__codelineno-2-66"></a>
<a id="__codelineno-2-67" name="__codelineno-2-67" href="#__codelineno-2-67"></a>        <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;market_id,selection_id,selection_name,wap_5m,wap_30s,bsp,ltp,traded_vol,inplay_min_lay</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-2-68" name="__codelineno-2-68" href="#__codelineno-2-68"></a>
<a id="__codelineno-2-69" name="__codelineno-2-69" href="#__codelineno-2-69"></a>        <span class="k">for</span> <span class="n">file_obj</span> <span class="ow">in</span> <span class="n">load_markets</span><span class="p">(</span><span class="n">stream_files</span><span class="p">):</span>
<a id="__codelineno-2-70" name="__codelineno-2-70" href="#__codelineno-2-70"></a>
<a id="__codelineno-2-71" name="__codelineno-2-71" href="#__codelineno-2-71"></a>            <span class="n">stream</span> <span class="o">=</span> <span class="n">trading</span><span class="o">.</span><span class="n">streaming</span><span class="o">.</span><span class="n">create_historical_generator_stream</span><span class="p">(</span>
<a id="__codelineno-2-72" name="__codelineno-2-72" href="#__codelineno-2-72"></a>                <span class="n">file_path</span><span class="o">=</span><span class="n">file_obj</span><span class="p">,</span>
<a id="__codelineno-2-73" name="__codelineno-2-73" href="#__codelineno-2-73"></a>                <span class="n">listener</span><span class="o">=</span><span class="n">listener</span><span class="p">,</span>
<a id="__codelineno-2-74" name="__codelineno-2-74" href="#__codelineno-2-74"></a>            <span class="p">)</span>
<a id="__codelineno-2-75" name="__codelineno-2-75" href="#__codelineno-2-75"></a>
<a id="__codelineno-2-76" name="__codelineno-2-76" href="#__codelineno-2-76"></a>            <span class="p">(</span><span class="n">t5m</span><span class="p">,</span> <span class="n">t30s</span><span class="p">,</span> <span class="n">preplay</span><span class="p">,</span> <span class="n">postplay</span><span class="p">,</span> <span class="n">inplayMin</span><span class="p">,</span> <span class="n">final</span><span class="p">)</span> <span class="o">=</span> <span class="n">extract_components_from_stream</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
<a id="__codelineno-2-77" name="__codelineno-2-77" href="#__codelineno-2-77"></a>
<a id="__codelineno-2-78" name="__codelineno-2-78" href="#__codelineno-2-78"></a>            <span class="c1"># If no price data for market don&#39;t write to file</span>
<a id="__codelineno-2-79" name="__codelineno-2-79" href="#__codelineno-2-79"></a>            <span class="k">if</span> <span class="n">postplay</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">final</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">t30s</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-2-80" name="__codelineno-2-80" href="#__codelineno-2-80"></a>                <span class="k">continue</span><span class="p">;</span> 
<a id="__codelineno-2-81" name="__codelineno-2-81" href="#__codelineno-2-81"></a>
<a id="__codelineno-2-82" name="__codelineno-2-82" href="#__codelineno-2-82"></a>            <span class="c1"># All runner removed</span>
<a id="__codelineno-2-83" name="__codelineno-2-83" href="#__codelineno-2-83"></a>            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">runner</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;REMOVED&quot;</span> <span class="k">for</span> <span class="n">runner</span> <span class="ow">in</span> <span class="n">final</span><span class="o">.</span><span class="n">runners</span><span class="p">):</span>
<a id="__codelineno-2-84" name="__codelineno-2-84" href="#__codelineno-2-84"></a>                <span class="k">continue</span>
<a id="__codelineno-2-85" name="__codelineno-2-85" href="#__codelineno-2-85"></a>
<a id="__codelineno-2-86" name="__codelineno-2-86" href="#__codelineno-2-86"></a>            <span class="n">runnerMeta</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-2-87" name="__codelineno-2-87" href="#__codelineno-2-87"></a>                <span class="p">{</span>
<a id="__codelineno-2-88" name="__codelineno-2-88" href="#__codelineno-2-88"></a>                    <span class="s1">&#39;selection_id&#39;</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">selection_id</span><span class="p">,</span>
<a id="__codelineno-2-89" name="__codelineno-2-89" href="#__codelineno-2-89"></a>                    <span class="s1">&#39;selection_name&#39;</span><span class="p">:</span> <span class="nb">next</span><span class="p">((</span><span class="n">rd</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">rd</span> <span class="ow">in</span> <span class="n">final</span><span class="o">.</span><span class="n">market_definition</span><span class="o">.</span><span class="n">runners</span> <span class="k">if</span> <span class="n">rd</span><span class="o">.</span><span class="n">selection_id</span> <span class="o">==</span> <span class="n">r</span><span class="o">.</span><span class="n">selection_id</span><span class="p">),</span> <span class="kc">None</span><span class="p">),</span>
<a id="__codelineno-2-90" name="__codelineno-2-90" href="#__codelineno-2-90"></a>                    <span class="s1">&#39;selection_status&#39;</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
<a id="__codelineno-2-91" name="__codelineno-2-91" href="#__codelineno-2-91"></a>                    <span class="s1">&#39;sp&#39;</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">actual_sp</span>
<a id="__codelineno-2-92" name="__codelineno-2-92" href="#__codelineno-2-92"></a>                <span class="p">}</span>
<a id="__codelineno-2-93" name="__codelineno-2-93" href="#__codelineno-2-93"></a>                <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">final</span><span class="o">.</span><span class="n">runners</span> 
<a id="__codelineno-2-94" name="__codelineno-2-94" href="#__codelineno-2-94"></a>            <span class="p">]</span>
<a id="__codelineno-2-95" name="__codelineno-2-95" href="#__codelineno-2-95"></a>
<a id="__codelineno-2-96" name="__codelineno-2-96" href="#__codelineno-2-96"></a>            <span class="n">ltp</span> <span class="o">=</span> <span class="p">[</span><span class="n">runner</span><span class="o">.</span><span class="n">last_price_traded</span> <span class="k">for</span> <span class="n">runner</span> <span class="ow">in</span> <span class="n">preplay</span><span class="o">.</span><span class="n">runners</span><span class="p">]</span>
<a id="__codelineno-2-97" name="__codelineno-2-97" href="#__codelineno-2-97"></a>
<a id="__codelineno-2-98" name="__codelineno-2-98" href="#__codelineno-2-98"></a>            <span class="n">tradedVol</span> <span class="o">=</span> <span class="p">[</span> <span class="n">ladder_traded_volume</span><span class="p">(</span><span class="n">runner</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">traded_volume</span><span class="p">)</span> <span class="k">for</span> <span class="n">runner</span> <span class="ow">in</span> <span class="n">postplay</span><span class="o">.</span><span class="n">runners</span> <span class="p">]</span>
<a id="__codelineno-2-99" name="__codelineno-2-99" href="#__codelineno-2-99"></a>
<a id="__codelineno-2-100" name="__codelineno-2-100" href="#__codelineno-2-100"></a>            <span class="n">wapBack30s</span> <span class="o">=</span> <span class="p">[</span> <span class="n">wapPrice</span><span class="p">(</span><span class="n">runner</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">available_to_back</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="k">for</span> <span class="n">runner</span> <span class="ow">in</span> <span class="n">t30s</span><span class="o">.</span><span class="n">runners</span><span class="p">]</span>
<a id="__codelineno-2-101" name="__codelineno-2-101" href="#__codelineno-2-101"></a>
<a id="__codelineno-2-102" name="__codelineno-2-102" href="#__codelineno-2-102"></a>            <span class="n">wapBack5m</span> <span class="o">=</span> <span class="p">[</span> <span class="n">wapPrice</span><span class="p">(</span><span class="n">runner</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">available_to_back</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="k">for</span> <span class="n">runner</span> <span class="ow">in</span> <span class="n">t5m</span><span class="o">.</span><span class="n">runners</span><span class="p">]</span>
<a id="__codelineno-2-103" name="__codelineno-2-103" href="#__codelineno-2-103"></a>
<a id="__codelineno-2-104" name="__codelineno-2-104" href="#__codelineno-2-104"></a>            <span class="c1"># Writing To CSV</span>
<a id="__codelineno-2-105" name="__codelineno-2-105" href="#__codelineno-2-105"></a>            <span class="c1"># ______________________</span>
<a id="__codelineno-2-106" name="__codelineno-2-106" href="#__codelineno-2-106"></a>
<a id="__codelineno-2-107" name="__codelineno-2-107" href="#__codelineno-2-107"></a>            <span class="k">for</span> <span class="p">(</span><span class="n">runnerMeta</span><span class="p">,</span> <span class="n">ltp</span><span class="p">,</span> <span class="n">tradedVol</span><span class="p">,</span> <span class="n">inplayMin</span><span class="p">,</span> <span class="n">wapBack5m</span><span class="p">,</span> <span class="n">wapBack30s</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">runnerMeta</span><span class="p">,</span> <span class="n">ltp</span><span class="p">,</span> <span class="n">tradedVol</span><span class="p">,</span> <span class="n">inplayMin</span><span class="p">,</span> <span class="n">wapBack5m</span><span class="p">,</span> <span class="n">wapBack30s</span><span class="p">):</span>
<a id="__codelineno-2-108" name="__codelineno-2-108" href="#__codelineno-2-108"></a>
<a id="__codelineno-2-109" name="__codelineno-2-109" href="#__codelineno-2-109"></a>                <span class="k">if</span> <span class="n">runnerMeta</span><span class="p">[</span><span class="s1">&#39;selection_status&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;REMOVED&#39;</span><span class="p">:</span>
<a id="__codelineno-2-110" name="__codelineno-2-110" href="#__codelineno-2-110"></a>
<a id="__codelineno-2-111" name="__codelineno-2-111" href="#__codelineno-2-111"></a>                    <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
<a id="__codelineno-2-112" name="__codelineno-2-112" href="#__codelineno-2-112"></a>                        <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
<a id="__codelineno-2-113" name="__codelineno-2-113" href="#__codelineno-2-113"></a>                            <span class="nb">str</span><span class="p">(</span><span class="n">final</span><span class="o">.</span><span class="n">market_id</span><span class="p">),</span>
<a id="__codelineno-2-114" name="__codelineno-2-114" href="#__codelineno-2-114"></a>                            <span class="n">runnerMeta</span><span class="p">[</span><span class="s1">&#39;selection_id&#39;</span><span class="p">],</span>
<a id="__codelineno-2-115" name="__codelineno-2-115" href="#__codelineno-2-115"></a>                            <span class="n">runnerMeta</span><span class="p">[</span><span class="s1">&#39;selection_name&#39;</span><span class="p">],</span>
<a id="__codelineno-2-116" name="__codelineno-2-116" href="#__codelineno-2-116"></a>                            <span class="n">wapBack5m</span><span class="p">,</span>
<a id="__codelineno-2-117" name="__codelineno-2-117" href="#__codelineno-2-117"></a>                            <span class="n">wapBack30s</span><span class="p">,</span>
<a id="__codelineno-2-118" name="__codelineno-2-118" href="#__codelineno-2-118"></a>                            <span class="n">runnerMeta</span><span class="p">[</span><span class="s1">&#39;sp&#39;</span><span class="p">],</span>
<a id="__codelineno-2-119" name="__codelineno-2-119" href="#__codelineno-2-119"></a>                            <span class="n">ltp</span><span class="p">,</span>
<a id="__codelineno-2-120" name="__codelineno-2-120" href="#__codelineno-2-120"></a>                            <span class="nb">round</span><span class="p">(</span><span class="n">tradedVol</span><span class="p">),</span>
<a id="__codelineno-2-121" name="__codelineno-2-121" href="#__codelineno-2-121"></a>                            <span class="n">inplayMin</span>
<a id="__codelineno-2-122" name="__codelineno-2-122" href="#__codelineno-2-122"></a>                        <span class="p">)</span>
<a id="__codelineno-2-123" name="__codelineno-2-123" href="#__codelineno-2-123"></a>                    <span class="p">)</span>
</code></pre></div>

</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Finally, after sourcing and downloading 12 months of stream files (ask automation@betfair.com.au for more info if you don't know how to do this) we'll use the above code to parse each file and write to a single csv file to be used for analysis.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="c1"># Description:</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="c1">#   Will loop through a set of stream data archive files and extract a few key pricing measures for each selection</span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="c1"># Estimated Time:</span>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="c1">#   ~6 hours</span>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a>
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="c1"># Parameters</span>
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a><span class="c1"># _________________________________</span>
<a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a>
<a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a><span class="c1"># trading = betfairlightweight.APIClient(&quot;username&quot;, &quot;password&quot;)</span>
<a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a>
<a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a><span class="c1"># listener = StreamListener(max_latency=None)</span>
<a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a>
<a id="__codelineno-3-13" name="__codelineno-3-13" href="#__codelineno-3-13"></a><span class="c1"># stream_files = glob.glob(&quot;[PATH TO LOCAL FOLDER STORING ARCHIVE FILES]*.tar&quot;)</span>
<a id="__codelineno-3-14" name="__codelineno-3-14" href="#__codelineno-3-14"></a><span class="c1"># output_file = &quot;[SOME OUTPUT DIRECTORY]/thoroughbred-odds-2021.csv&quot;</span>
<a id="__codelineno-3-15" name="__codelineno-3-15" href="#__codelineno-3-15"></a>
<a id="__codelineno-3-16" name="__codelineno-3-16" href="#__codelineno-3-16"></a><span class="c1"># Run</span>
<a id="__codelineno-3-17" name="__codelineno-3-17" href="#__codelineno-3-17"></a><span class="c1"># _________________________________</span>
<a id="__codelineno-3-18" name="__codelineno-3-18" href="#__codelineno-3-18"></a>
<a id="__codelineno-3-19" name="__codelineno-3-19" href="#__codelineno-3-19"></a><span class="c1"># if __name__ == &#39;__main__&#39;:</span>
<a id="__codelineno-3-20" name="__codelineno-3-20" href="#__codelineno-3-20"></a><span class="c1">#     parse_stream(stream_files, output_file)</span>
</code></pre></div>

</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="12-race-data">1.2 Race Data</h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>If you're building a fundamental bottom-up model, finding and managing ETL from an appropriate data source is a large part of the exercise. If your needs are simpler (for these types of automated strategies for example) there's plenty of good information that's available right inside the betfair API itself. </p>
<p>The <code>RUNNER_METADATA</code> slot inside the <code>listMarketCatalogue</code> response for example will return a pretty good slice of metadata about the horses racing in upcoming races including but not limited to: the trainer, the jockey, the horses age, and a class rating. The <a href="https://docs.developer.betfair.com/display/1smk3cen4v3lu3yomq5qye0ni/listMarketCatalogue">documentaion for this endpoint</a> will give you the full extent of this what's inside this response.</p>
<p>Our problem for this exercise is that the historical stream files don't include this <code>RUNNER_METADATA</code> so we weren't able to extract it in the previous step. However, a sneaky workaround is to use an unsuppoerted back-end endpoint, one which Betfair use for <a href="https://www.betfair.com.au/hub/racing-results/">the Hub racing results page</a>.  </p>
<p>These API endpoints are:</p>
<ul>
<li>Market result data: <a href="https://apigateway.betfair.com.au/hub/raceevent/1.154620281">https://apigateway.betfair.com.au/hub/raceevent/1.154620281</a></li>
<li>Days markets: <a href="https://apigateway.betfair.com.au/hub/racecard?date=2018-12-18">https://apigateway.betfair.com.au/hub/racecard?date=2018-12-18</a></li>
</ul>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="extract-betfair-racing-markets-for-a-given-date">Extract Betfair Racing Markets for a Given Date</h3>
<p>First we'll hit the <code>https://apigateway.betfair.com.au/hub/racecard</code> endpoint to get the racing markets available on Betfair for a given day in the past:</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="k">def</span> <span class="nf">getBfMarkets</span><span class="p">(</span><span class="n">dte</span><span class="p">):</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>    <span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;https://apigateway.betfair.com.au/hub/racecard?date=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dte</span><span class="p">)</span>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a>
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a>    <span class="n">responseJson</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a>
<a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a>    <span class="n">marketList</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a>
<a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a>    <span class="k">for</span> <span class="n">meeting</span> <span class="ow">in</span> <span class="n">responseJson</span><span class="p">[</span><span class="s1">&#39;MEETINGS&#39;</span><span class="p">]:</span>
<a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a>        <span class="k">for</span> <span class="n">markets</span> <span class="ow">in</span> <span class="n">meeting</span><span class="p">[</span><span class="s1">&#39;MARKETS&#39;</span><span class="p">]:</span>
<a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a>            <span class="n">marketList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
<a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a>                <span class="p">{</span>
<a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a>                    <span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="n">dte</span><span class="p">,</span>
<a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a>                    <span class="s1">&#39;track&#39;</span><span class="p">:</span> <span class="n">meeting</span><span class="p">[</span><span class="s1">&#39;VENUE_NAME&#39;</span><span class="p">],</span>
<a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a>                    <span class="s1">&#39;country&#39;</span><span class="p">:</span> <span class="n">meeting</span><span class="p">[</span><span class="s1">&#39;COUNTRY&#39;</span><span class="p">],</span>
<a id="__codelineno-4-16" name="__codelineno-4-16" href="#__codelineno-4-16"></a>                    <span class="s1">&#39;race_type&#39;</span><span class="p">:</span> <span class="n">meeting</span><span class="p">[</span><span class="s1">&#39;RACE_TYPE&#39;</span><span class="p">],</span>
<a id="__codelineno-4-17" name="__codelineno-4-17" href="#__codelineno-4-17"></a>                    <span class="s1">&#39;race_number&#39;</span><span class="p">:</span> <span class="n">markets</span><span class="p">[</span><span class="s1">&#39;RACE_NO&#39;</span><span class="p">],</span>
<a id="__codelineno-4-18" name="__codelineno-4-18" href="#__codelineno-4-18"></a>                    <span class="s1">&#39;market_id&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="s1">&#39;1.&#39;</span> <span class="o">+</span> <span class="n">markets</span><span class="p">[</span><span class="s1">&#39;MARKET_ID&#39;</span><span class="p">]),</span>
<a id="__codelineno-4-19" name="__codelineno-4-19" href="#__codelineno-4-19"></a>                    <span class="s1">&#39;start_time&#39;</span><span class="p">:</span> <span class="n">markets</span><span class="p">[</span><span class="s1">&#39;START_TIME&#39;</span><span class="p">]</span>
<a id="__codelineno-4-20" name="__codelineno-4-20" href="#__codelineno-4-20"></a>                <span class="p">}</span>
<a id="__codelineno-4-21" name="__codelineno-4-21" href="#__codelineno-4-21"></a>            <span class="p">)</span>
<a id="__codelineno-4-22" name="__codelineno-4-22" href="#__codelineno-4-22"></a>
<a id="__codelineno-4-23" name="__codelineno-4-23" href="#__codelineno-4-23"></a>    <span class="n">marketDf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">marketList</span><span class="p">)</span>
<a id="__codelineno-4-24" name="__codelineno-4-24" href="#__codelineno-4-24"></a>
<a id="__codelineno-4-25" name="__codelineno-4-25" href="#__codelineno-4-25"></a>    <span class="k">return</span><span class="p">(</span><span class="n">marketDf</span><span class="p">)</span>
</code></pre></div>

</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="extract-key-race-metadata">Extract Key Race Metadata</h4>
<p>Then (for one of these <code>market_id</code>s) we'll hit the <code>https://apigateway.betfair.com.au/hub/raceevent/</code> enpdoint to get some key runner metadata for the runners in this race. It's important to note that this information is available through the Betfair API so we won't need to go to a secondary datasource to find it at the point of implementation, this would add a large layer of complexity to the project including things like string cleaning and matching.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="k">def</span> <span class="nf">getBfRaceMeta</span><span class="p">(</span><span class="n">market_id</span><span class="p">):</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>    <span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;https://apigateway.betfair.com.au/hub/raceevent/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">market_id</span><span class="p">)</span>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a>    <span class="n">responseJson</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a>
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a>    <span class="k">if</span> <span class="s1">&#39;error&#39;</span> <span class="ow">in</span> <span class="n">responseJson</span><span class="p">:</span>
<a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a>        <span class="k">return</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">())</span>
<a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a>
<a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a>    <span class="n">raceList</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a>
<a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a>    <span class="k">for</span> <span class="n">runner</span> <span class="ow">in</span> <span class="n">responseJson</span><span class="p">[</span><span class="s1">&#39;runners&#39;</span><span class="p">]:</span>
<a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a>
<a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a>        <span class="k">if</span> <span class="s1">&#39;isScratched&#39;</span> <span class="ow">in</span> <span class="n">runner</span> <span class="ow">and</span> <span class="n">runner</span><span class="p">[</span><span class="s1">&#39;isScratched&#39;</span><span class="p">]:</span>
<a id="__codelineno-5-15" name="__codelineno-5-15" href="#__codelineno-5-15"></a>            <span class="k">continue</span>
<a id="__codelineno-5-16" name="__codelineno-5-16" href="#__codelineno-5-16"></a>
<a id="__codelineno-5-17" name="__codelineno-5-17" href="#__codelineno-5-17"></a>        <span class="c1"># Jockey not always populated</span>
<a id="__codelineno-5-18" name="__codelineno-5-18" href="#__codelineno-5-18"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-5-19" name="__codelineno-5-19" href="#__codelineno-5-19"></a>            <span class="n">jockey</span> <span class="o">=</span> <span class="n">runner</span><span class="p">[</span><span class="s1">&#39;jockeyName&#39;</span><span class="p">]</span>
<a id="__codelineno-5-20" name="__codelineno-5-20" href="#__codelineno-5-20"></a>        <span class="k">except</span><span class="p">:</span>
<a id="__codelineno-5-21" name="__codelineno-5-21" href="#__codelineno-5-21"></a>            <span class="n">jockey</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-5-22" name="__codelineno-5-22" href="#__codelineno-5-22"></a>
<a id="__codelineno-5-23" name="__codelineno-5-23" href="#__codelineno-5-23"></a>        <span class="c1"># Place not always populated</span>
<a id="__codelineno-5-24" name="__codelineno-5-24" href="#__codelineno-5-24"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-5-25" name="__codelineno-5-25" href="#__codelineno-5-25"></a>            <span class="n">placeResult</span> <span class="o">=</span> <span class="n">runner</span><span class="p">[</span><span class="s1">&#39;placedResult&#39;</span><span class="p">]</span>
<a id="__codelineno-5-26" name="__codelineno-5-26" href="#__codelineno-5-26"></a>        <span class="k">except</span><span class="p">:</span>
<a id="__codelineno-5-27" name="__codelineno-5-27" href="#__codelineno-5-27"></a>            <span class="n">placeResult</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-5-28" name="__codelineno-5-28" href="#__codelineno-5-28"></a>
<a id="__codelineno-5-29" name="__codelineno-5-29" href="#__codelineno-5-29"></a>        <span class="c1"># Place not always populated</span>
<a id="__codelineno-5-30" name="__codelineno-5-30" href="#__codelineno-5-30"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-5-31" name="__codelineno-5-31" href="#__codelineno-5-31"></a>            <span class="n">trainer</span> <span class="o">=</span> <span class="n">runner</span><span class="p">[</span><span class="s1">&#39;trainerName&#39;</span><span class="p">]</span>
<a id="__codelineno-5-32" name="__codelineno-5-32" href="#__codelineno-5-32"></a>        <span class="k">except</span><span class="p">:</span>
<a id="__codelineno-5-33" name="__codelineno-5-33" href="#__codelineno-5-33"></a>            <span class="n">trainer</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-5-34" name="__codelineno-5-34" href="#__codelineno-5-34"></a>
<a id="__codelineno-5-35" name="__codelineno-5-35" href="#__codelineno-5-35"></a>        <span class="n">raceList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
<a id="__codelineno-5-36" name="__codelineno-5-36" href="#__codelineno-5-36"></a>            <span class="p">{</span>
<a id="__codelineno-5-37" name="__codelineno-5-37" href="#__codelineno-5-37"></a>                <span class="s1">&#39;market_id&#39;</span><span class="p">:</span> <span class="n">market_id</span><span class="p">,</span>
<a id="__codelineno-5-38" name="__codelineno-5-38" href="#__codelineno-5-38"></a>                <span class="s1">&#39;weather&#39;</span><span class="p">:</span> <span class="n">responseJson</span><span class="p">[</span><span class="s1">&#39;weather&#39;</span><span class="p">],</span>
<a id="__codelineno-5-39" name="__codelineno-5-39" href="#__codelineno-5-39"></a>                <span class="s1">&#39;track_condition&#39;</span><span class="p">:</span> <span class="n">responseJson</span><span class="p">[</span><span class="s1">&#39;trackCondition&#39;</span><span class="p">],</span>
<a id="__codelineno-5-40" name="__codelineno-5-40" href="#__codelineno-5-40"></a>                <span class="s1">&#39;race_distance&#39;</span><span class="p">:</span> <span class="n">responseJson</span><span class="p">[</span><span class="s1">&#39;raceLength&#39;</span><span class="p">],</span>
<a id="__codelineno-5-41" name="__codelineno-5-41" href="#__codelineno-5-41"></a>                <span class="s1">&#39;selection_id&#39;</span><span class="p">:</span> <span class="n">runner</span><span class="p">[</span><span class="s1">&#39;selectionId&#39;</span><span class="p">],</span>
<a id="__codelineno-5-42" name="__codelineno-5-42" href="#__codelineno-5-42"></a>                <span class="s1">&#39;selection_name&#39;</span><span class="p">:</span> <span class="n">runner</span><span class="p">[</span><span class="s1">&#39;runnerName&#39;</span><span class="p">],</span>
<a id="__codelineno-5-43" name="__codelineno-5-43" href="#__codelineno-5-43"></a>                <span class="s1">&#39;barrier&#39;</span><span class="p">:</span> <span class="n">runner</span><span class="p">[</span><span class="s1">&#39;barrierNo&#39;</span><span class="p">],</span>
<a id="__codelineno-5-44" name="__codelineno-5-44" href="#__codelineno-5-44"></a>                <span class="s1">&#39;place&#39;</span><span class="p">:</span> <span class="n">placeResult</span><span class="p">,</span>
<a id="__codelineno-5-45" name="__codelineno-5-45" href="#__codelineno-5-45"></a>                <span class="s1">&#39;trainer&#39;</span><span class="p">:</span> <span class="n">trainer</span><span class="p">,</span>
<a id="__codelineno-5-46" name="__codelineno-5-46" href="#__codelineno-5-46"></a>                <span class="s1">&#39;jockey&#39;</span><span class="p">:</span> <span class="n">jockey</span><span class="p">,</span>
<a id="__codelineno-5-47" name="__codelineno-5-47" href="#__codelineno-5-47"></a>                <span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="n">runner</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">]</span>
<a id="__codelineno-5-48" name="__codelineno-5-48" href="#__codelineno-5-48"></a>            <span class="p">}</span>
<a id="__codelineno-5-49" name="__codelineno-5-49" href="#__codelineno-5-49"></a>        <span class="p">)</span>
<a id="__codelineno-5-50" name="__codelineno-5-50" href="#__codelineno-5-50"></a>
<a id="__codelineno-5-51" name="__codelineno-5-51" href="#__codelineno-5-51"></a>    <span class="n">raceDf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">raceList</span><span class="p">)</span>
<a id="__codelineno-5-52" name="__codelineno-5-52" href="#__codelineno-5-52"></a>
<a id="__codelineno-5-53" name="__codelineno-5-53" href="#__codelineno-5-53"></a>    <span class="k">return</span><span class="p">(</span><span class="n">raceDf</span><span class="p">)</span>
</code></pre></div>

</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="wrapper-function">Wrapper Function</h4>
<p>Stiching these two functions together we can create a wrapper function that hits both endpoints for all the thoroughbred races in a given day and extract all the runner metadata and results.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="k">def</span> <span class="nf">scrapeThoroughbredBfDate</span><span class="p">(</span><span class="n">dte</span><span class="p">):</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a>    <span class="n">markets</span> <span class="o">=</span> <span class="n">getBfMarkets</span><span class="p">(</span><span class="n">dte</span><span class="p">)</span>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a>
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a>    <span class="k">if</span> <span class="n">markets</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a>        <span class="k">return</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">())</span>
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a>
<a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a>    <span class="n">thoMarkets</span> <span class="o">=</span> <span class="n">markets</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;country == &quot;AUS&quot; and race_type == &quot;R&quot;&#39;</span><span class="p">)</span>
<a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a>
<a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a>    <span class="k">if</span> <span class="n">thoMarkets</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a>        <span class="k">return</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">())</span>
<a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a>
<a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a>    <span class="n">raceMetaList</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-6-14" name="__codelineno-6-14" href="#__codelineno-6-14"></a>
<a id="__codelineno-6-15" name="__codelineno-6-15" href="#__codelineno-6-15"></a>    <span class="k">for</span> <span class="n">market</span> <span class="ow">in</span> <span class="n">thoMarkets</span><span class="o">.</span><span class="n">market_id</span><span class="p">:</span>
<a id="__codelineno-6-16" name="__codelineno-6-16" href="#__codelineno-6-16"></a>        <span class="n">raceMetaList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">getBfRaceMeta</span><span class="p">(</span><span class="n">market</span><span class="p">))</span>
<a id="__codelineno-6-17" name="__codelineno-6-17" href="#__codelineno-6-17"></a>
<a id="__codelineno-6-18" name="__codelineno-6-18" href="#__codelineno-6-18"></a>    <span class="n">raceMeta</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">raceMetaList</span><span class="p">)</span>
<a id="__codelineno-6-19" name="__codelineno-6-19" href="#__codelineno-6-19"></a>
<a id="__codelineno-6-20" name="__codelineno-6-20" href="#__codelineno-6-20"></a>    <span class="k">return</span><span class="p">(</span><span class="n">markets</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">raceMeta</span><span class="p">,</span> <span class="n">on</span> <span class="o">=</span> <span class="s1">&#39;market_id&#39;</span><span class="p">))</span>
</code></pre></div>

</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="c1"># Executing the wrapper for an example date</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="n">scrapeThoroughbredBfDate</span><span class="p">(</span><span class="n">date</span><span class="p">(</span><span class="mi">2021</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
</code></pre></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped="scoped">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
    <tr style="text-align: right;">
      <th></th>
      <th>date</th>
      <th>track</th>
      <th>country</th>
      <th>race_type</th>
      <th>race_number</th>
      <th>market_id</th>
      <th>start_time</th>
      <th>weather</th>
      <th>track_condition</th>
      <th>race_distance</th>
      <th>selection_id</th>
      <th>selection_name</th>
      <th>barrier</th>
      <th>place</th>
      <th>trainer</th>
      <th>jockey</th>
      <th>weight</th>
    </tr>
  </thead>
<tbody>
    <tr>
      <th>0</th>
      <td>2021-02-10</td>
      <td>Ascot</td>
      <td>AUS</td>
      <td>R</td>
      <td>1</td>
      <td>1.179077389</td>
      <td>2021-02-10 04:34:00</td>
      <td>None</td>
      <td>None</td>
      <td>1000</td>
      <td>38448397</td>
      <td>Triple Missile</td>
      <td>3</td>
      <td>1</td>
      <td>Todd Harvey</td>
      <td>Paul Harvey</td>
      <td>60.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2021-02-10</td>
      <td>Ascot</td>
      <td>AUS</td>
      <td>R</td>
      <td>1</td>
      <td>1.179077389</td>
      <td>2021-02-10 04:34:00</td>
      <td>None</td>
      <td>None</td>
      <td>1000</td>
      <td>28763768</td>
      <td>Shock Result</td>
      <td>5</td>
      <td>4</td>
      <td>P H Jordan</td>
      <td>Craig Staples</td>
      <td>59.5</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2021-02-10</td>
      <td>Ascot</td>
      <td>AUS</td>
      <td>R</td>
      <td>1</td>
      <td>1.179077389</td>
      <td>2021-02-10 04:34:00</td>
      <td>None</td>
      <td>None</td>
      <td>1000</td>
      <td>8772321</td>
      <td>Secret Plan</td>
      <td>6</td>
      <td>3</td>
      <td>G &amp; A Williams</td>
      <td>William Pike</td>
      <td>59.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2021-02-10</td>
      <td>Ascot</td>
      <td>AUS</td>
      <td>R</td>
      <td>1</td>
      <td>1.179077389</td>
      <td>2021-02-10 04:34:00</td>
      <td>None</td>
      <td>None</td>
      <td>1000</td>
      <td>9021011</td>
      <td>Command Force</td>
      <td>2</td>
      <td>0</td>
      <td>Daniel &amp; Ben Pearce</td>
      <td>J Azzopardi</td>
      <td>58.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2021-02-10</td>
      <td>Ascot</td>
      <td>AUS</td>
      <td>R</td>
      <td>1</td>
      <td>1.179077389</td>
      <td>2021-02-10 04:34:00</td>
      <td>None</td>
      <td>None</td>
      <td>1000</td>
      <td>38448398</td>
      <td>Fish Hook</td>
      <td>7</td>
      <td>2</td>
      <td>M P Allan</td>
      <td>Madi Derrick</td>
      <td>57.5</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>458</th>
      <td>2021-02-10</td>
      <td>Warwick Farm</td>
      <td>AUS</td>
      <td>R</td>
      <td>7</td>
      <td>1.179081635</td>
      <td>2021-02-10 06:50:00</td>
      <td>None</td>
      <td>None</td>
      <td>1200</td>
      <td>133456</td>
      <td>Sedition</td>
      <td>12</td>
      <td>2</td>
      <td>Richard Litt</td>
      <td>Ms Rachel King</td>
      <td>58.0</td>
    </tr>
    <tr>
      <th>459</th>
      <td>2021-02-10</td>
      <td>Warwick Farm</td>
      <td>AUS</td>
      <td>R</td>
      <td>7</td>
      <td>1.179081635</td>
      <td>2021-02-10 06:50:00</td>
      <td>None</td>
      <td>None</td>
      <td>1200</td>
      <td>38447782</td>
      <td>Amusez Moi</td>
      <td>9</td>
      <td>6</td>
      <td>Richard Litt</td>
      <td>Josh Parr</td>
      <td>57.0</td>
    </tr>
    <tr>
      <th>460</th>
      <td>2021-02-10</td>
      <td>Warwick Farm</td>
      <td>AUS</td>
      <td>R</td>
      <td>7</td>
      <td>1.179081635</td>
      <td>2021-02-10 06:50:00</td>
      <td>None</td>
      <td>None</td>
      <td>1200</td>
      <td>25388274</td>
      <td>Savoury</td>
      <td>1</td>
      <td>5</td>
      <td>Bjorn Baker</td>
      <td>Jason Collett</td>
      <td>57.0</td>
    </tr>
    <tr>
      <th>461</th>
      <td>2021-02-10</td>
      <td>Warwick Farm</td>
      <td>AUS</td>
      <td>R</td>
      <td>7</td>
      <td>1.179081635</td>
      <td>2021-02-10 06:50:00</td>
      <td>None</td>
      <td>None</td>
      <td>1200</td>
      <td>38447783</td>
      <td>Born A Warrior</td>
      <td>7</td>
      <td>3</td>
      <td>Michael &amp; Wayne &amp; John Hawkes</td>
      <td>Tommy Berry</td>
      <td>56.5</td>
    </tr>
    <tr>
      <th>462</th>
      <td>2021-02-10</td>
      <td>Warwick Farm</td>
      <td>AUS</td>
      <td>R</td>
      <td>7</td>
      <td>1.179081635</td>
      <td>2021-02-10 06:50:00</td>
      <td>None</td>
      <td>None</td>
      <td>1200</td>
      <td>38447784</td>
      <td>Newsreader</td>
      <td>10</td>
      <td>1</td>
      <td>John O'shea</td>
      <td>James Mcdonald</td>
      <td>55.5</td>
    </tr>
  </tbody>
</table>
<p>463 rows  17 columns</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Then to produce a historical slice of all races between two dates we could just loop over a set of dates and append each results set</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="c1"># Description:</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="c1">#   Will loop through a set of dates (starting July 2020 in this instance) and return race metadata from betfair </span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="c1"># Estimated Time:</span>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="c1">#   ~60 mins</span>
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a><span class="c1"># </span>
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a><span class="c1"># dataList = []</span>
<a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a><span class="c1"># dateList = pd.date_range(date(2020,7,1),date.today()-timedelta(days=1),freq=&#39;d&#39;)</span>
<a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a><span class="c1"># for dte in dateList:</span>
<a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a><span class="c1">#     dte = dte.date()</span>
<a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a><span class="c1">#     print(dte)</span>
<a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a><span class="c1">#     races = scrapeThoroughbredBfDate(dte)</span>
<a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a><span class="c1">#     dataList.append(races)</span>
<a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a><span class="c1"># data = pd.concat(dataList)</span>
<a id="__codelineno-8-14" name="__codelineno-8-14" href="#__codelineno-8-14"></a><span class="c1"># data.to_csv(&quot;[LOCAL PATH SOMEWHERE]&quot;, index=False)</span>
</code></pre></div>

</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<hr />
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="20-analysis">2.0 Analysis</h2>
<p>I'll be running through 3 simple betting angles, one easy, one medium, and one hard to illustrate different types of angles you might want to try at home. The process I lay out is very similar (if not identical) but the implementation might be a bit trickier in each case and might take a little more programming skill to get up and running.</p>
<p>We'll use a simple evaluation function (POT and strike rate) to evaluate each of these strategies.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="k">def</span> <span class="nf">bet_eval_metrics</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">side</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a>    <span class="n">metrics</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">d</span>
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a>    <span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s2">&quot;npl&quot;</span><span class="p">:</span> <span class="s2">&quot;sum&quot;</span><span class="p">,</span> <span class="s2">&quot;stake&quot;</span><span class="p">:</span> <span class="s2">&quot;sum&quot;</span><span class="p">,</span> <span class="s2">&quot;win&quot;</span><span class="p">:</span> <span class="s2">&quot;mean&quot;</span><span class="p">})</span>
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a>    <span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">pot</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;npl&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;stake&#39;</span><span class="p">])</span>
<a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a>
<a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a>    <span class="k">return</span><span class="p">(</span><span class="n">metrics</span><span class="p">[</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;stake&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">])</span>
</code></pre></div>

</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="21-assemble-data">2.1 Assemble Data</h3>
<p>Now that we have our 2 core datasets (odds + race / runner metadata) we can join them together and do some analysis</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="c1"># Local Paths (will be different on your machine)</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="n">path_odds_local</span> <span class="o">=</span> <span class="s2">&quot;[PATH TO YOUR LOCAL FILES]/thoroughbred-odds-2021.csv&quot;</span>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="n">path_race_local</span> <span class="o">=</span> <span class="s2">&quot;[PATH TO YOUR LOCAL FILES]/thoroughbred-race-data.csv&quot;</span>
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a>
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a><span class="n">odds</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path_odds_local</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;market_id&#39;</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="s1">&#39;selection_id&#39;</span><span class="p">:</span> <span class="nb">object</span><span class="p">})</span>
<a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a><span class="n">race</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path_race_local</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;market_id&#39;</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="s1">&#39;selection_id&#39;</span><span class="p">:</span> <span class="nb">object</span><span class="p">})</span>
</code></pre></div>

</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="n">odds</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</code></pre></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped="scoped">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
    <tr style="text-align: right;">
      <th></th>
      <th>market_id</th>
      <th>selection_id</th>
      <th>selection_name</th>
      <th>wap_5m</th>
      <th>wap_30s</th>
      <th>bsp</th>
      <th>ltp</th>
      <th>traded_vol</th>
      <th>inplay_min_lay</th>
    </tr>
  </thead>
<tbody>
    <tr>
      <th>0</th>
      <td>1.179845158</td>
      <td>23493550</td>
      <td>1. Larmour</td>
      <td>6.27</td>
      <td>5.84</td>
      <td>6.20</td>
      <td>6.2</td>
      <td>8277</td>
      <td>1.19</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1.179845158</td>
      <td>16374800</td>
      <td>3. Careering Away</td>
      <td>3.31</td>
      <td>3.67</td>
      <td>3.60</td>
      <td>3.65</td>
      <td>18592</td>
      <td>1.08</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1.179845158</td>
      <td>19740699</td>
      <td>4. Bells N Bows</td>
      <td>6.87</td>
      <td>6.36</td>
      <td>6.62</td>
      <td>6.4</td>
      <td>7413</td>
      <td>1.42</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="n">race</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</code></pre></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped="scoped">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
    <tr style="text-align: right;">
      <th></th>
      <th>date</th>
      <th>track</th>
      <th>country</th>
      <th>race_type</th>
      <th>race_number</th>
      <th>market_id</th>
      <th>start_time</th>
      <th>weather</th>
      <th>track_condition</th>
      <th>race_distance</th>
      <th>selection_id</th>
      <th>selection_name</th>
      <th>barrier</th>
      <th>place</th>
      <th>trainer</th>
      <th>jockey</th>
      <th>weight</th>
    </tr>
  </thead>
<tbody>
    <tr>
      <th>0</th>
      <td>2020-07-01</td>
      <td>Balaklava</td>
      <td>AUS</td>
      <td>R</td>
      <td>1</td>
      <td>1.171091087</td>
      <td>2020-07-01 02:40:00</td>
      <td>FINE</td>
      <td>GOOD4</td>
      <td>2200</td>
      <td>19674744</td>
      <td>Baldy</td>
      <td>2</td>
      <td>4.0</td>
      <td>Peter Nolan</td>
      <td>Karl Zechner</td>
      <td>59.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2020-07-01</td>
      <td>Balaklava</td>
      <td>AUS</td>
      <td>R</td>
      <td>1</td>
      <td>1.171091087</td>
      <td>2020-07-01 02:40:00</td>
      <td>FINE</td>
      <td>GOOD4</td>
      <td>2200</td>
      <td>401615</td>
      <td>Nostrovia</td>
      <td>4</td>
      <td>7.0</td>
      <td>Dennis O'leary</td>
      <td>Margaret Collett</td>
      <td>59.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2020-07-01</td>
      <td>Balaklava</td>
      <td>AUS</td>
      <td>R</td>
      <td>1</td>
      <td>1.171091087</td>
      <td>2020-07-01 02:40:00</td>
      <td>FINE</td>
      <td>GOOD4</td>
      <td>2200</td>
      <td>26789410</td>
      <td>Ammo Loco</td>
      <td>5</td>
      <td>1.0</td>
      <td>John Hickmott</td>
      <td>Barend Vorster</td>
      <td>58.5</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="c1"># Joining two datasets</span>
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="n">df</span> <span class="o">=</span> <span class="n">race</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">odds</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">odds</span><span class="o">.</span><span class="n">columns</span> <span class="o">!=</span> <span class="s1">&#39;selection_name&#39;</span><span class="p">],</span> <span class="n">how</span> <span class="o">=</span> <span class="s2">&quot;inner&quot;</span><span class="p">,</span> <span class="n">on</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;market_id&#39;</span><span class="p">,</span> <span class="s1">&#39;selection_id&#39;</span><span class="p">])</span>
</code></pre></div>

</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="c1"># I&#39;ll also add columns for the net profit from backing and laying each selection to be picked up in subsequent sections</span>
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="n">df</span><span class="p">[</span><span class="s1">&#39;back_npl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;place&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.95</span> <span class="o">*</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;bsp&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="n">df</span><span class="p">[</span><span class="s1">&#39;lay_npl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;place&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;bsp&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="mf">0.95</span><span class="p">)</span>
</code></pre></div>

</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="22-methodology">2.2 Methodology</h3>
<p>Looping back around to the context discussion in part 0.2 we need to decide on how to set up our analysis that will help us: find angles, formulate strategies, and test them with enough rigour that will give us a good estimate of our forward looking profitability on any that we choose to implement and automate.</p>
<p>The 3 key tricks I'll lay out in this piece are:
- Using a <strong>statistical estimate</strong> to quantify the <strong>robustness</strong> of historical profitibalility
- Using <strong>out-of-sample</strong> validation (much like a you would in a model building exercise) to get an accurate view of forward looking profitability
- Using domain knowledge to <strong>chunk</strong> selections to get broader sample for more stable estimate of profitability</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="231-chunking">2.3.1 Chunking</h3>
<p>This is a technique you can use to group together variables in conceptually similar groups. For example, thoroughbred races are run over many different exact distances (800m, 810m, 850m, 860m etc) which - using a domain overlay - are all very short sprint style races for a horse race. Similarly, barriers 1, 2 and 3 being on the very inside of the race field and closest to the rail all present similar early race challenges and advantages for horses jumping from those barriers.</p>
<p>So formulating your betting angles you may want to overlay semantically similar variable groups to test your betting hypothesis.</p>
<p>I'll add variable chunks for race distance and barrier for now but you may want to test more (for example horse experience, trainer stable size etc)</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="k">def</span> <span class="nf">distance_group</span><span class="p">(</span><span class="n">distance</span><span class="p">):</span>
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a>
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a>    <span class="k">if</span> <span class="n">distance</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a>        <span class="k">return</span><span class="p">(</span><span class="s2">&quot;missing&quot;</span><span class="p">)</span>
<a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a>    <span class="k">elif</span> <span class="n">distance</span> <span class="o">&lt;</span> <span class="mi">1100</span><span class="p">:</span>
<a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a>        <span class="k">return</span><span class="p">(</span><span class="s2">&quot;sprint&quot;</span><span class="p">)</span>
<a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a>    <span class="k">elif</span> <span class="n">distance</span> <span class="o">&lt;</span> <span class="mi">1400</span><span class="p">:</span>
<a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a>        <span class="k">return</span><span class="p">(</span><span class="s2">&quot;mid_short&quot;</span><span class="p">)</span>
<a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a>    <span class="k">elif</span> <span class="n">distance</span> <span class="o">&lt;</span> <span class="mi">1800</span><span class="p">:</span>
<a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a>        <span class="k">return</span><span class="p">(</span><span class="s2">&quot;mid_long&quot;</span><span class="p">)</span>
<a id="__codelineno-15-11" name="__codelineno-15-11" href="#__codelineno-15-11"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-15-12" name="__codelineno-15-12" href="#__codelineno-15-12"></a>        <span class="k">return</span><span class="p">(</span><span class="s2">&quot;long&quot;</span><span class="p">)</span>
<a id="__codelineno-15-13" name="__codelineno-15-13" href="#__codelineno-15-13"></a>
<a id="__codelineno-15-14" name="__codelineno-15-14" href="#__codelineno-15-14"></a><span class="k">def</span> <span class="nf">barrier_group</span><span class="p">(</span><span class="n">barrier</span><span class="p">):</span>
<a id="__codelineno-15-15" name="__codelineno-15-15" href="#__codelineno-15-15"></a>    <span class="k">if</span> <span class="n">barrier</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-15-16" name="__codelineno-15-16" href="#__codelineno-15-16"></a>        <span class="k">return</span><span class="p">(</span><span class="s2">&quot;missing&quot;</span><span class="p">)</span>
<a id="__codelineno-15-17" name="__codelineno-15-17" href="#__codelineno-15-17"></a>    <span class="k">elif</span> <span class="n">barrier</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
<a id="__codelineno-15-18" name="__codelineno-15-18" href="#__codelineno-15-18"></a>        <span class="k">return</span><span class="p">(</span><span class="s2">&quot;inside&quot;</span><span class="p">)</span>
<a id="__codelineno-15-19" name="__codelineno-15-19" href="#__codelineno-15-19"></a>    <span class="k">elif</span> <span class="n">barrier</span> <span class="o">&lt;</span> <span class="mi">9</span><span class="p">:</span>
<a id="__codelineno-15-20" name="__codelineno-15-20" href="#__codelineno-15-20"></a>        <span class="k">return</span><span class="p">(</span><span class="s2">&quot;mid_field&quot;</span><span class="p">)</span>
<a id="__codelineno-15-21" name="__codelineno-15-21" href="#__codelineno-15-21"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-15-22" name="__codelineno-15-22" href="#__codelineno-15-22"></a>        <span class="k">return</span><span class="p">(</span><span class="s2">&quot;outside&quot;</span><span class="p">)</span>
<a id="__codelineno-15-23" name="__codelineno-15-23" href="#__codelineno-15-23"></a>
<a id="__codelineno-15-24" name="__codelineno-15-24" href="#__codelineno-15-24"></a>
<a id="__codelineno-15-25" name="__codelineno-15-25" href="#__codelineno-15-25"></a><span class="n">df</span><span class="p">[</span><span class="s1">&#39;distance_group&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">race_distance</span><span class="p">,</span> <span class="n">errors</span> <span class="o">=</span> <span class="s2">&quot;coerce&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">distance_group</span><span class="p">)</span>
<a id="__codelineno-15-26" name="__codelineno-15-26" href="#__codelineno-15-26"></a><span class="n">df</span><span class="p">[</span><span class="s1">&#39;barrier_group&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">barrier</span><span class="p">,</span> <span class="n">errors</span> <span class="o">=</span> <span class="s2">&quot;coerce&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">barrier_group</span><span class="p">)</span>
</code></pre></div>

</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="232-in-sample-vs-out-of-sample">2.3.2 In Sample vs Out of Sample</h3>
<p>The first thing I'm going to do is to split off a largish chunk of my data before even looking at it. I'll ultimately use it to paper trade some of my candidate angles but I want it to be as seperate from the idea generation process as possible. </p>
<p>I'll use the model building nomenclature "train" and "test" even though I'm not really doing any "training". My data contains all AUS thoroughbred races from July 2020 until end of June 2021 so I'll cut off the period Apr-June 2021 as my "test" set.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="n">dfTrain</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;date &lt; &quot;2021-04-01&quot;&#39;</span><span class="p">)</span>
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="n">dfTest</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;date &gt;= &quot;2021-04-01&quot;&#39;</span><span class="p">)</span>
<a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a>
<a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> rows in the &quot;training&quot; set and </span><span class="si">{}</span><span class="s1"> rows in the &quot;test&quot; data&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dfTrain</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dfTest</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</code></pre></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_text output_subarea output_execute_result">
<pre>
<code>&#39;119244 rows in the &#34;training&#34; set and 40783 rows in the &#34;test&#34; data&#39;</code>
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="233-statistically-measuring-profit">2.3.3 Statistically Measuring Profit</h3>
<p>Betting outcomes, and the randomness associated with them, at their core are the types of things the discipline of statistics was created to solve. Concepts like sample size, expected value, and variance are terms you might hear from sophisticated (and some novice) bettors and they are all drawn from the field of statistics. Though you don't need to become a PHD of statistics every little extra technique or concept you can glean from the field will help your betting if you want it to.</p>
<p>To illustrate with an example, let's group by net backing profit on turnover for a horse to see which horses have the highest historical back POT:</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="p">(</span>
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a>    <span class="n">dfTrain</span>
<a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a>    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">stake</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a>    <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;selection_name&#39;</span><span class="p">,</span> <span class="n">as_index</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a>    <span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s1">&#39;back_npl&#39;</span><span class="p">:</span> <span class="s1">&#39;sum&#39;</span><span class="p">,</span> <span class="s1">&#39;stake&#39;</span><span class="p">:</span> <span class="s1">&#39;sum&#39;</span><span class="p">})</span>
<a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a>    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">pot</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;back_npl&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;stake&#39;</span><span class="p">])</span>
<a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a>    <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;pot&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  
<a id="__codelineno-17-8" name="__codelineno-17-8" href="#__codelineno-17-8"></a>    <span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> 
<a id="__codelineno-17-9" name="__codelineno-17-9" href="#__codelineno-17-9"></a><span class="p">)</span>
</code></pre></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped="scoped">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
    <tr style="text-align: right;">
      <th></th>
      <th>selection_name</th>
      <th>back_npl</th>
      <th>stake</th>
      <th>pot</th>
    </tr>
  </thead>
<tbody>
    <tr>
      <th>12247</th>
      <td>Little Vulpine</td>
      <td>274.550</td>
      <td>1</td>
      <td>274.550000</td>
    </tr>
    <tr>
      <th>15384</th>
      <td>Not Tonight Dear</td>
      <td>130.701</td>
      <td>1</td>
      <td>130.701000</td>
    </tr>
    <tr>
      <th>9987</th>
      <td>Im Cheeky</td>
      <td>617.307</td>
      <td>7</td>
      <td>88.186714</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>So back Little Vulpine whenever it races? We all know intuitively what's wrong with that betting angle - it's raced one time in our sample and happened to win at a bsp of 270. Sample size and variance are dominating this simple measure of historical POT.</p>
<p>Instead what we can do is treat the historical betting outcomes as a random variable and apply some statistical tests of signifance to them. A more detailed discussion of this particular test can be found <a href="https://www.football-data.co.uk/blog/testing_reliabiity_of_t-test_approximation_for_testing_betting_recrods.php">here</a> as can an excel calculator you can input your stats into. I'll simply translate the test to python to enable it's use when formulating our betting angles.</p>
<p>The TLDR version of this test is that; based on your bet sample size, your profit, and the average odds across that sample of bets, the calculation produces a p value which estimates the probability your profit (or loss) happened by pure chance (where chance would be an expectation of breakeven betting simply at fair odds).</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="k">def</span> <span class="nf">pl_pValue</span><span class="p">(</span><span class="n">number_bets</span><span class="p">,</span> <span class="n">npl</span><span class="p">,</span> <span class="n">stake</span><span class="p">,</span> <span class="n">average_odds</span><span class="p">):</span>
<a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a>
<a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a>    <span class="n">pot</span> <span class="o">=</span> <span class="n">npl</span> <span class="o">/</span> <span class="n">stake</span>
<a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a>
<a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a>    <span class="n">tStatistic</span> <span class="o">=</span> <span class="p">(</span><span class="n">pot</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">number_bets</span><span class="p">))</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">pot</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">average_odds</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">pot</span><span class="p">)</span> <span class="p">)</span>
<a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a>
<a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a>    <span class="n">pValue</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">t</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="o">-</span><span class="nb">abs</span><span class="p">(</span><span class="n">tStatistic</span><span class="p">),</span> <span class="n">number_bets</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a>
<a id="__codelineno-18-9" name="__codelineno-18-9" href="#__codelineno-18-9"></a>    <span class="k">return</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">pValue</span><span class="p">),</span> <span class="n">pValue</span> <span class="o">==</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">pValue</span><span class="p">))</span>
</code></pre></div>

</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>That doesn't mean we can formulate our angles and use this metric (and this metric alone) to validate their profitability. You'll find that it will give you misleading results in some instances. As analysts we're also prone to finding infinite different ways to unintentionally overfit our analysis as you might have heard elsewhere described as the concept of p-hacking, but it does give us an extra filter to cast over our hypotheses before really validating them with out-of-sample testing.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="24-angle-1-track-distance-barrier">2.4 Angle 1: Track | Distance | Barrier</h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The first thing I'll test is whether or not there are any combinations of track/distance/barrier where backing or laying could produce robust long term profit. This probably fits within the types of betting angles people before you have already sucked all the value out of long before you started reading this article. That's not to say that you shouldn't test them though, as people have made livings on betting angles as simple as these.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="c1"># Calculate the profit (back and lay) and average odds across all track / distance / barrier group combos</span>
<a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a><span class="n">trackDistanceBarrier</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a>    <span class="n">dfTrain</span>
<a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a>    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">stake</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a>    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">odds</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;bsp&#39;</span><span class="p">])</span>
<a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a>    <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;track&#39;</span><span class="p">,</span> <span class="s1">&#39;race_distance&#39;</span><span class="p">,</span> <span class="s1">&#39;barrier_group&#39;</span><span class="p">],</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a>    <span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s1">&#39;back_npl&#39;</span><span class="p">:</span> <span class="s1">&#39;sum&#39;</span><span class="p">,</span> <span class="s1">&#39;lay_npl&#39;</span><span class="p">:</span> <span class="s1">&#39;sum&#39;</span><span class="p">,</span><span class="s1">&#39;stake&#39;</span><span class="p">:</span> <span class="s1">&#39;sum&#39;</span><span class="p">,</span> <span class="s1">&#39;odds&#39;</span><span class="p">:</span> <span class="s1">&#39;mean&#39;</span><span class="p">})</span>
<a id="__codelineno-19-8" name="__codelineno-19-8" href="#__codelineno-19-8"></a><span class="p">)</span>
<a id="__codelineno-19-9" name="__codelineno-19-9" href="#__codelineno-19-9"></a>
<a id="__codelineno-19-10" name="__codelineno-19-10" href="#__codelineno-19-10"></a><span class="n">trackDistanceBarrier</span>
</code></pre></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped="scoped">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
    <tr style="text-align: right;">
      <th></th>
      <th>track</th>
      <th>race_distance</th>
      <th>barrier_group</th>
      <th>back_npl</th>
      <th>lay_npl</th>
      <th>stake</th>
      <th>odds</th>
    </tr>
  </thead>
<tbody>
    <tr>
      <th>0</th>
      <td>Albany</td>
      <td>1000</td>
      <td>inside</td>
      <td>11.2550</td>
      <td>-11.95</td>
      <td>2</td>
      <td>15.450000</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Albany</td>
      <td>1000</td>
      <td>mid_field</td>
      <td>-5.0000</td>
      <td>4.75</td>
      <td>5</td>
      <td>101.136000</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Albany</td>
      <td>1000</td>
      <td>outside</td>
      <td>-5.0000</td>
      <td>4.75</td>
      <td>5</td>
      <td>88.374000</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Albany</td>
      <td>1100</td>
      <td>inside</td>
      <td>-3.0525</td>
      <td>2.70</td>
      <td>6</td>
      <td>29.430000</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Albany</td>
      <td>1100</td>
      <td>mid_field</td>
      <td>-6.4040</td>
      <td>5.92</td>
      <td>9</td>
      <td>37.483333</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>6325</th>
      <td>York</td>
      <td>1500</td>
      <td>inside</td>
      <td>1.8995</td>
      <td>-2.41</td>
      <td>6</td>
      <td>41.195000</td>
    </tr>
    <tr>
      <th>6326</th>
      <td>York</td>
      <td>1500</td>
      <td>mid_field</td>
      <td>-7.0000</td>
      <td>6.65</td>
      <td>7</td>
      <td>32.472857</td>
    </tr>
    <tr>
      <th>6327</th>
      <td>York</td>
      <td>1920</td>
      <td>inside</td>
      <td>-3.0000</td>
      <td>2.85</td>
      <td>3</td>
      <td>21.883333</td>
    </tr>
    <tr>
      <th>6328</th>
      <td>York</td>
      <td>1920</td>
      <td>mid_field</td>
      <td>-0.3520</td>
      <td>-0.04</td>
      <td>5</td>
      <td>20.978000</td>
    </tr>
    <tr>
      <th>6329</th>
      <td>York</td>
      <td>1920</td>
      <td>outside</td>
      <td>-2.0000</td>
      <td>1.90</td>
      <td>2</td>
      <td>21.450000</td>
    </tr>
  </tbody>
</table>
<p>6330 rows  7 columns</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>So it looks like over 2 selections jumping from the inside 3 barriers at Albany 1000m you would have made a healthy profit if you'd decide to back them historically. </p>
<p>Let's use our lense of statistical significance to view these profit figures</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="n">trackDistanceBarrier</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a>    <span class="n">trackDistanceBarrier</span>
<a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a>    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">backPL_pValue</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">pl_pValue</span><span class="p">(</span><span class="n">number_bets</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;stake&#39;</span><span class="p">],</span> <span class="n">npl</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;back_npl&#39;</span><span class="p">],</span> <span class="n">stake</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;stake&#39;</span><span class="p">],</span> <span class="n">average_odds</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;odds&#39;</span><span class="p">]))</span>
<a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a>    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">layPL_pValue</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">pl_pValue</span><span class="p">(</span><span class="n">number_bets</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;stake&#39;</span><span class="p">],</span> <span class="n">npl</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;lay_npl&#39;</span><span class="p">],</span> <span class="n">stake</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;stake&#39;</span><span class="p">],</span> <span class="n">average_odds</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;odds&#39;</span><span class="p">]))</span>
<a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a><span class="p">)</span>
<a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a>
<a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a><span class="n">trackDistanceBarrier</span>
</code></pre></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_subarea output_stream output_stderr output_text">
<pre>
<code>/home/tmbish/.local/lib/python3.9/site-packages/pandas/core/arraylike.py:364: RuntimeWarning: invalid value encountered in sqrt
  result = getattr(ufunc, method)(*inputs, **kwargs)
</code>
</pre>
</div>
</div>
<div class="output_area">
<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped="scoped">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
    <tr style="text-align: right;">
      <th></th>
      <th>track</th>
      <th>race_distance</th>
      <th>barrier_group</th>
      <th>back_npl</th>
      <th>lay_npl</th>
      <th>stake</th>
      <th>odds</th>
      <th>backPL_pValue</th>
      <th>layPL_pValue</th>
    </tr>
  </thead>
<tbody>
    <tr>
      <th>0</th>
      <td>Albany</td>
      <td>1000</td>
      <td>inside</td>
      <td>11.2550</td>
      <td>-11.95</td>
      <td>2</td>
      <td>15.450000</td>
      <td>0.487280</td>
      <td>1.000000</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Albany</td>
      <td>1000</td>
      <td>mid_field</td>
      <td>-5.0000</td>
      <td>4.75</td>
      <td>5</td>
      <td>101.136000</td>
      <td>1.000000</td>
      <td>0.885995</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Albany</td>
      <td>1000</td>
      <td>outside</td>
      <td>-5.0000</td>
      <td>4.75</td>
      <td>5</td>
      <td>88.374000</td>
      <td>1.000000</td>
      <td>0.877954</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Albany</td>
      <td>1100</td>
      <td>inside</td>
      <td>-3.0525</td>
      <td>2.70</td>
      <td>6</td>
      <td>29.430000</td>
      <td>0.754412</td>
      <td>0.869397</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Albany</td>
      <td>1100</td>
      <td>mid_field</td>
      <td>-6.4040</td>
      <td>5.92</td>
      <td>9</td>
      <td>37.483333</td>
      <td>0.532857</td>
      <td>0.804366</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>6325</th>
      <td>York</td>
      <td>1500</td>
      <td>inside</td>
      <td>1.8995</td>
      <td>-2.41</td>
      <td>6</td>
      <td>41.195000</td>
      <td>0.918934</td>
      <td>0.849635</td>
    </tr>
    <tr>
      <th>6326</th>
      <td>York</td>
      <td>1500</td>
      <td>mid_field</td>
      <td>-7.0000</td>
      <td>6.65</td>
      <td>7</td>
      <td>32.472857</td>
      <td>1.000000</td>
      <td>0.755643</td>
    </tr>
    <tr>
      <th>6327</th>
      <td>York</td>
      <td>1920</td>
      <td>inside</td>
      <td>-3.0000</td>
      <td>2.85</td>
      <td>3</td>
      <td>21.883333</td>
      <td>1.000000</td>
      <td>0.816546</td>
    </tr>
    <tr>
      <th>6328</th>
      <td>York</td>
      <td>1920</td>
      <td>mid_field</td>
      <td>-0.3520</td>
      <td>-0.04</td>
      <td>5</td>
      <td>20.978000</td>
      <td>0.972659</td>
      <td>0.996987</td>
    </tr>
    <tr>
      <th>6329</th>
      <td>York</td>
      <td>1920</td>
      <td>outside</td>
      <td>-2.0000</td>
      <td>1.90</td>
      <td>2</td>
      <td>21.450000</td>
      <td>1.000000</td>
      <td>0.863432</td>
    </tr>
  </tbody>
</table>
<p>6330 rows  9 columns</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>So as you can see, whilst having a back POT of nearly 500% because the results were generated over 2 runners at quite high odds the p value (50%) suggest that it's quite likely we could have seen these exact results due to randomness, which is very intuitive.</p>
<p>Let's have a look to see if there's any statistically significant edge to be gained on the lay side</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="c1"># Top 5 lay combos Track | Distance | Barrier (TDB)</span>
<a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a><span class="n">TDB_bestLay</span> <span class="o">=</span> <span class="n">trackDistanceBarrier</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;lay_npl&gt;0&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;layPL_pValue&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a><span class="n">TDB_bestLay</span>
</code></pre></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped="scoped">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
    <tr style="text-align: right;">
      <th></th>
      <th>track</th>
      <th>race_distance</th>
      <th>barrier_group</th>
      <th>back_npl</th>
      <th>lay_npl</th>
      <th>stake</th>
      <th>odds</th>
      <th>backPL_pValue</th>
      <th>layPL_pValue</th>
    </tr>
  </thead>
<tbody>
    <tr>
      <th>188</th>
      <td>Ascot</td>
      <td>1000</td>
      <td>inside</td>
      <td>-83.6395</td>
      <td>77.06</td>
      <td>115</td>
      <td>24.616870</td>
      <td>0.003054</td>
      <td>0.248157</td>
    </tr>
    <tr>
      <th>3619</th>
      <td>Moonee Valley</td>
      <td>1200</td>
      <td>inside</td>
      <td>-52.2195</td>
      <td>48.81</td>
      <td>64</td>
      <td>17.725313</td>
      <td>0.000565</td>
      <td>0.254399</td>
    </tr>
    <tr>
      <th>6299</th>
      <td>Yeppoon</td>
      <td>1400</td>
      <td>inside</td>
      <td>-11.0000</td>
      <td>10.45</td>
      <td>11</td>
      <td>6.022727</td>
      <td>1.000000</td>
      <td>0.289686</td>
    </tr>
    <tr>
      <th>959</th>
      <td>Caulfield</td>
      <td>1400</td>
      <td>mid_field</td>
      <td>-74.3150</td>
      <td>67.45</td>
      <td>114</td>
      <td>24.828772</td>
      <td>0.018780</td>
      <td>0.301137</td>
    </tr>
    <tr>
      <th>1366</th>
      <td>Darwin</td>
      <td>1200</td>
      <td>mid_field</td>
      <td>-47.3980</td>
      <td>43.94</td>
      <td>64</td>
      <td>19.354531</td>
      <td>0.009844</td>
      <td>0.318178</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>So despite high lay POT none of these angles suggest an irrefutablely profitable angle laying these combinations. However, that doesn't mean we shouldn't test them on our out of sample set of races. These are our statistically most promising examples, we'll just take the top 5 for now and see how we would have performed if we had of started betting them on April first 2021.</p>
<p>Keep in mind this should give us a pretty good indication of what we could get over the next 3 months into the future if we started today because we haven't contaminated/leaked any data from the post April period into our angle formulation. </p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="c1"># First let&#39;s test laying on the train set (by definition we know these will be profitable)</span>
<a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a><span class="n">train_TDB_bestLay</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a>    <span class="n">dfTrain</span>
<a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a>    <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">TDB_bestLay</span><span class="p">[[</span><span class="s1">&#39;track&#39;</span><span class="p">,</span> <span class="s1">&#39;race_distance&#39;</span><span class="p">]])</span>
<a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a>    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">npl</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;lay_npl&#39;</span><span class="p">])</span>
<a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a>    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">stake</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-22-7" name="__codelineno-22-7" href="#__codelineno-22-7"></a>    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">win</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;lay_npl&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
<a id="__codelineno-22-8" name="__codelineno-22-8" href="#__codelineno-22-8"></a><span class="p">)</span>
<a id="__codelineno-22-9" name="__codelineno-22-9" href="#__codelineno-22-9"></a>
<a id="__codelineno-22-10" name="__codelineno-22-10" href="#__codelineno-22-10"></a><span class="c1"># This is the key test (non of the races has been part of analysis to this point)</span>
<a id="__codelineno-22-11" name="__codelineno-22-11" href="#__codelineno-22-11"></a><span class="n">test_TDB_bestLay</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-22-12" name="__codelineno-22-12" href="#__codelineno-22-12"></a>    <span class="n">dfTest</span>
<a id="__codelineno-22-13" name="__codelineno-22-13" href="#__codelineno-22-13"></a>    <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">TDB_bestLay</span><span class="p">[[</span><span class="s1">&#39;track&#39;</span><span class="p">,</span> <span class="s1">&#39;race_distance&#39;</span><span class="p">]])</span>
<a id="__codelineno-22-14" name="__codelineno-22-14" href="#__codelineno-22-14"></a>    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">npl</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;lay_npl&#39;</span><span class="p">])</span>
<a id="__codelineno-22-15" name="__codelineno-22-15" href="#__codelineno-22-15"></a>    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">stake</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-22-16" name="__codelineno-22-16" href="#__codelineno-22-16"></a>    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">win</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;lay_npl&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
<a id="__codelineno-22-17" name="__codelineno-22-17" href="#__codelineno-22-17"></a><span class="p">)</span>
<a id="__codelineno-22-18" name="__codelineno-22-18" href="#__codelineno-22-18"></a>
<a id="__codelineno-22-19" name="__codelineno-22-19" href="#__codelineno-22-19"></a><span class="c1"># Peaking at the bets in the test set</span>
<a id="__codelineno-22-20" name="__codelineno-22-20" href="#__codelineno-22-20"></a><span class="n">test_TDB_bestLay</span><span class="p">[[</span><span class="s1">&#39;track&#39;</span><span class="p">,</span> <span class="s1">&#39;race_distance&#39;</span><span class="p">,</span> <span class="s1">&#39;barrier&#39;</span><span class="p">,</span> <span class="s1">&#39;barrier_group&#39;</span><span class="p">,</span> <span class="s1">&#39;bsp&#39;</span><span class="p">,</span> <span class="s1">&#39;lay_npl&#39;</span><span class="p">,</span> <span class="s1">&#39;win&#39;</span><span class="p">,</span> <span class="s1">&#39;stake&#39;</span><span class="p">]]</span>
</code></pre></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped="scoped">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
    <tr style="text-align: right;">
      <th></th>
      <th>track</th>
      <th>race_distance</th>
      <th>barrier</th>
      <th>barrier_group</th>
      <th>bsp</th>
      <th>lay_npl</th>
      <th>win</th>
      <th>stake</th>
    </tr>
  </thead>
<tbody>
    <tr>
      <th>0</th>
      <td>Ascot</td>
      <td>1000</td>
      <td>4</td>
      <td>mid_field</td>
      <td>11.08</td>
      <td>0.95</td>
      <td>1</td>
      <td>1</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Ascot</td>
      <td>1000</td>
      <td>11</td>
      <td>outside</td>
      <td>5.41</td>
      <td>0.95</td>
      <td>1</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Ascot</td>
      <td>1000</td>
      <td>1</td>
      <td>inside</td>
      <td>4.73</td>
      <td>-3.73</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Ascot</td>
      <td>1000</td>
      <td>5</td>
      <td>mid_field</td>
      <td>7.35</td>
      <td>0.95</td>
      <td>1</td>
      <td>1</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Ascot</td>
      <td>1000</td>
      <td>10</td>
      <td>outside</td>
      <td>4.97</td>
      <td>0.95</td>
      <td>1</td>
      <td>1</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>219</th>
      <td>Darwin</td>
      <td>1200</td>
      <td>10</td>
      <td>outside</td>
      <td>18.31</td>
      <td>0.95</td>
      <td>1</td>
      <td>1</td>
    </tr>
    <tr>
      <th>220</th>
      <td>Darwin</td>
      <td>1200</td>
      <td>8</td>
      <td>mid_field</td>
      <td>42.00</td>
      <td>0.95</td>
      <td>1</td>
      <td>1</td>
    </tr>
    <tr>
      <th>221</th>
      <td>Darwin</td>
      <td>1200</td>
      <td>6</td>
      <td>mid_field</td>
      <td>29.91</td>
      <td>0.95</td>
      <td>1</td>
      <td>1</td>
    </tr>
    <tr>
      <th>222</th>
      <td>Darwin</td>
      <td>1200</td>
      <td>11</td>
      <td>outside</td>
      <td>6.60</td>
      <td>-5.60</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>223</th>
      <td>Darwin</td>
      <td>1200</td>
      <td>7</td>
      <td>mid_field</td>
      <td>5.74</td>
      <td>0.95</td>
      <td>1</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
<p>224 rows  8 columns</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="c1"># Let&#39;s run our evaluation on the training set</span>
<a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a><span class="n">bet_eval_metrics</span><span class="p">(</span><span class="n">train_TDB_bestLay</span><span class="p">)</span>
</code></pre></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped="scoped">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
    <tr style="text-align: right;">
      <th></th>
      <th>npl</th>
      <th>stake</th>
      <th>win</th>
      <th>pot</th>
    </tr>
  </thead>
<tbody>
    <tr>
      <th>0</th>
      <td>98.1</td>
      <td>1047.0</td>
      <td>0.892073</td>
      <td>0.093696</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="c1"># And on the test set</span>
<a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a><span class="n">bet_eval_metrics</span><span class="p">(</span><span class="n">test_TDB_bestLay</span><span class="p">)</span>
</code></pre></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped="scoped">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
    <tr style="text-align: right;">
      <th></th>
      <th>npl</th>
      <th>stake</th>
      <th>win</th>
      <th>pot</th>
    </tr>
  </thead>
<tbody>
    <tr>
      <th>0</th>
      <td>18.44</td>
      <td>224.0</td>
      <td>0.870536</td>
      <td>0.082321</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>That's promising results. Our test set shows similar betting performance as our training set and we're still seeing a profitble trend. These are lay strategies so they aren't as robust as backing strategies as your profit distribution is lots of small wins and some large losses, but this is potentially a profitble betting angle!</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="25-angle-2-jockeys-market-opinion">2.5 Angle 2: Jockeys + Market Opinion</h3>
<p>Moving up slightly in level of difficulty our angles could include different kinds of reference points. Jockeys seem to be a divisive form factor in thoroughbred racing, and their quality can be hard to isolate relative to the quality of the horse and its preperation etc.</p>
<p>I'm going to look at isolating jockeys that are either favoured or unfavoured by the market to see if I can formulate a betting angle that could generate me expected profit.</p>
<p>The metric I'm going to use to determine market favour will be the ratio between back price 5 minutes before the scheduled jump and 30 seconds before the scheduled jump. Plotting this ratio for jockeys in our training set we can see which jockeys tend to have high market support by a high ratio (horses they are riding tend to shorten before the off)</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="p">(</span>
<a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a>    <span class="n">dfTrain</span>
<a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a>    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">market_support</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;wap_5m&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;wap_30s&#39;</span><span class="p">])</span>
<a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a>    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">races</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-25-5" name="__codelineno-25-5" href="#__codelineno-25-5"></a>    <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;jockey&#39;</span><span class="p">)</span>
<a id="__codelineno-25-6" name="__codelineno-25-6" href="#__codelineno-25-6"></a>    <span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s1">&#39;market_support&#39;</span><span class="p">:</span> <span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;races&#39;</span><span class="p">:</span> <span class="s1">&#39;count&#39;</span><span class="p">})</span>
<a id="__codelineno-25-7" name="__codelineno-25-7" href="#__codelineno-25-7"></a>    <span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;races &gt; 10&#39;</span><span class="p">)</span>
<a id="__codelineno-25-8" name="__codelineno-25-8" href="#__codelineno-25-8"></a>    <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;market_support&#39;</span><span class="p">,</span> <span class="n">ascending</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-25-9" name="__codelineno-25-9" href="#__codelineno-25-9"></a>    <span class="o">.</span><span class="n">head</span><span class="p">()</span>
<a id="__codelineno-25-10" name="__codelineno-25-10" href="#__codelineno-25-10"></a><span class="p">)</span>
</code></pre></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped="scoped">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
    <tr style="text-align: right;">
      <th></th>
      <th>market_support</th>
      <th>races</th>
    </tr>
    <tr>
      <th>jockey</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
<tbody>
    <tr>
      <th>Scott Sheargold</th>
      <td>1.133095</td>
      <td>192</td>
    </tr>
    <tr>
      <th>Lorelle Crow</th>
      <td>1.056582</td>
      <td>106</td>
    </tr>
    <tr>
      <th>Chris Mc Carthy</th>
      <td>1.051022</td>
      <td>26</td>
    </tr>
    <tr>
      <th>Anthony Darmanin</th>
      <td>1.048931</td>
      <td>142</td>
    </tr>
    <tr>
      <th>James Winks</th>
      <td>1.048893</td>
      <td>12</td>
    </tr>
    <tr>
      <th>Bob El-Issa</th>
      <td>1.046756</td>
      <td>196</td>
    </tr>
    <tr>
      <th>Elyce Smith</th>
      <td>1.043593</td>
      <td>164</td>
    </tr>
    <tr>
      <th>Jessica Gray</th>
      <td>1.043376</td>
      <td>108</td>
    </tr>
    <tr>
      <th>Paul Francis Hamblin</th>
      <td>1.042248</td>
      <td>61</td>
    </tr>
    <tr>
      <th>Alana Livesey</th>
      <td>1.042188</td>
      <td>32</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Next, let's split the sample of each jockey's races between two scenarios a) the market firmed for their horse b) their horse drifted in the market in the last 5 minutes of trading.</p>
<p>We then calculate the same summary table of inputs (profit, average odds etc) for backing these jockeys at the BSP given some market move. We can then feed these metrics into our statistical significance test to get an idea of the profitability of each combination.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="c1"># Group By Jockey and Market Support</span>
<a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a><span class="n">jockeys</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a>    <span class="n">dfTrain</span>
<a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a>    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">stake</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-26-5" name="__codelineno-26-5" href="#__codelineno-26-5"></a>    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">odds</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;bsp&#39;</span><span class="p">])</span>
<a id="__codelineno-26-6" name="__codelineno-26-6" href="#__codelineno-26-6"></a>    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">npl</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;place&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.95</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;odds&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
<a id="__codelineno-26-7" name="__codelineno-26-7" href="#__codelineno-26-7"></a>    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">market_support</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;wap_5m&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;wap_30s&#39;</span><span class="p">],</span> <span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="s2">&quot;N&quot;</span><span class="p">))</span>
<a id="__codelineno-26-8" name="__codelineno-26-8" href="#__codelineno-26-8"></a>    <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;jockey&#39;</span><span class="p">,</span> <span class="s1">&#39;market_support&#39;</span><span class="p">],</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-26-9" name="__codelineno-26-9" href="#__codelineno-26-9"></a>    <span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s1">&#39;odds&#39;</span><span class="p">:</span> <span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;stake&#39;</span><span class="p">:</span> <span class="s1">&#39;sum&#39;</span><span class="p">,</span> <span class="s1">&#39;npl&#39;</span><span class="p">:</span> <span class="s1">&#39;sum&#39;</span><span class="p">})</span>
<a id="__codelineno-26-10" name="__codelineno-26-10" href="#__codelineno-26-10"></a>    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">pValue</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">pl_pValue</span><span class="p">(</span><span class="n">number_bets</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;stake&#39;</span><span class="p">],</span> <span class="n">npl</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;npl&#39;</span><span class="p">],</span> <span class="n">stake</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;stake&#39;</span><span class="p">],</span> <span class="n">average_odds</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;odds&#39;</span><span class="p">]))</span>
<a id="__codelineno-26-11" name="__codelineno-26-11" href="#__codelineno-26-11"></a><span class="p">)</span>
<a id="__codelineno-26-12" name="__codelineno-26-12" href="#__codelineno-26-12"></a>
<a id="__codelineno-26-13" name="__codelineno-26-13" href="#__codelineno-26-13"></a><span class="n">jockeys</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;pValue&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;npl &gt; 0&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</code></pre></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped="scoped">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
    <tr style="text-align: right;">
      <th></th>
      <th>jockey</th>
      <th>market_support</th>
      <th>odds</th>
      <th>stake</th>
      <th>npl</th>
      <th>pValue</th>
    </tr>
  </thead>
<tbody>
    <tr>
      <th>624</th>
      <td>K Jennings</td>
      <td>Y</td>
      <td>18.106118</td>
      <td>85</td>
      <td>178.6955</td>
      <td>0.005643</td>
    </tr>
    <tr>
      <th>496</th>
      <td>Jade Darose</td>
      <td>Y</td>
      <td>87.343333</td>
      <td>39</td>
      <td>579.4265</td>
      <td>0.008942</td>
    </tr>
    <tr>
      <th>263</th>
      <td>Clayton Gallagher</td>
      <td>Y</td>
      <td>24.225338</td>
      <td>148</td>
      <td>226.7145</td>
      <td>0.012994</td>
    </tr>
    <tr>
      <th>906</th>
      <td>Ms T Harrison</td>
      <td>Y</td>
      <td>27.944125</td>
      <td>160</td>
      <td>241.3065</td>
      <td>0.018095</td>
    </tr>
    <tr>
      <th>615</th>
      <td>Justin P Stanley</td>
      <td>N</td>
      <td>13.084502</td>
      <td>231</td>
      <td>155.7305</td>
      <td>0.019913</td>
    </tr>
    <tr>
      <th>802</th>
      <td>Michael Dee</td>
      <td>N</td>
      <td>36.338213</td>
      <td>263</td>
      <td>299.7255</td>
      <td>0.031634</td>
    </tr>
    <tr>
      <th>753</th>
      <td>Madeleine Wishart</td>
      <td>Y</td>
      <td>25.249872</td>
      <td>78</td>
      <td>156.5065</td>
      <td>0.033329</td>
    </tr>
    <tr>
      <th>433</th>
      <td>Hannah Fitzgerald</td>
      <td>Y</td>
      <td>32.171944</td>
      <td>72</td>
      <td>170.1830</td>
      <td>0.045334</td>
    </tr>
    <tr>
      <th>937</th>
      <td>Nick Heywood</td>
      <td>N</td>
      <td>17.172857</td>
      <td>98</td>
      <td>111.8905</td>
      <td>0.049176</td>
    </tr>
    <tr>
      <th>745</th>
      <td>M Pateman</td>
      <td>N</td>
      <td>22.690808</td>
      <td>260</td>
      <td>189.2050</td>
      <td>0.052283</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>You can think of each of these scenarios representing different cases. If profitable:
- Under market support this could indicate the jockey is being correctly favoured to maximise their horse's chances of winning the race or perhaps even some kind of insider knowledge coming out of certain stables
- Under market drift this could indicate some incorrect skepticism about the jockeys ability and thus their horse has been overlayed</p>
<p>Either way we're interested to see how these combinations would perform paper trading in our out of sample set</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="c1"># First evaluate on our training set</span>
<a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a><span class="n">train_jockeyMarket</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a>    <span class="n">dfTrain</span>
<a id="__codelineno-27-4" name="__codelineno-27-4" href="#__codelineno-27-4"></a>    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">market_support</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;wap_5m&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;wap_30s&#39;</span><span class="p">],</span> <span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="s2">&quot;N&quot;</span><span class="p">))</span>
<a id="__codelineno-27-5" name="__codelineno-27-5" href="#__codelineno-27-5"></a>    <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">jockeys</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;pValue&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;npl &gt; 0&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)[[</span><span class="s1">&#39;jockey&#39;</span><span class="p">,</span> <span class="s1">&#39;market_support&#39;</span><span class="p">]])</span>
<a id="__codelineno-27-6" name="__codelineno-27-6" href="#__codelineno-27-6"></a>    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">stake</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-27-7" name="__codelineno-27-7" href="#__codelineno-27-7"></a>    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">odds</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;bsp&#39;</span><span class="p">])</span>
<a id="__codelineno-27-8" name="__codelineno-27-8" href="#__codelineno-27-8"></a>    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">npl</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;place&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.95</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;odds&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
<a id="__codelineno-27-9" name="__codelineno-27-9" href="#__codelineno-27-9"></a>    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">win</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;npl&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
<a id="__codelineno-27-10" name="__codelineno-27-10" href="#__codelineno-27-10"></a><span class="p">)</span>
<a id="__codelineno-27-11" name="__codelineno-27-11" href="#__codelineno-27-11"></a>
<a id="__codelineno-27-12" name="__codelineno-27-12" href="#__codelineno-27-12"></a><span class="c1"># And on the test set</span>
<a id="__codelineno-27-13" name="__codelineno-27-13" href="#__codelineno-27-13"></a><span class="n">test_jockeyMarket</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-27-14" name="__codelineno-27-14" href="#__codelineno-27-14"></a>    <span class="n">dfTest</span>
<a id="__codelineno-27-15" name="__codelineno-27-15" href="#__codelineno-27-15"></a>    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">market_support</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;wap_5m&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;wap_30s&#39;</span><span class="p">],</span> <span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="s2">&quot;N&quot;</span><span class="p">))</span>
<a id="__codelineno-27-16" name="__codelineno-27-16" href="#__codelineno-27-16"></a>    <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">jockeys</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;pValue&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;npl &gt; 0&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)[[</span><span class="s1">&#39;jockey&#39;</span><span class="p">,</span> <span class="s1">&#39;market_support&#39;</span><span class="p">]])</span>
<a id="__codelineno-27-17" name="__codelineno-27-17" href="#__codelineno-27-17"></a>    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">stake</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-27-18" name="__codelineno-27-18" href="#__codelineno-27-18"></a>    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">odds</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;bsp&#39;</span><span class="p">])</span>
<a id="__codelineno-27-19" name="__codelineno-27-19" href="#__codelineno-27-19"></a>    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">npl</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;place&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.95</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;odds&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
<a id="__codelineno-27-20" name="__codelineno-27-20" href="#__codelineno-27-20"></a>    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">win</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;npl&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
<a id="__codelineno-27-21" name="__codelineno-27-21" href="#__codelineno-27-21"></a><span class="p">)</span>
</code></pre></div>

</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a><span class="n">bet_eval_metrics</span><span class="p">(</span><span class="n">train_jockeyMarket</span><span class="p">)</span>
</code></pre></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped="scoped">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
    <tr style="text-align: right;">
      <th></th>
      <th>npl</th>
      <th>stake</th>
      <th>win</th>
      <th>pot</th>
    </tr>
  </thead>
<tbody>
    <tr>
      <th>0</th>
      <td>2309.384</td>
      <td>1434.0</td>
      <td>0.154812</td>
      <td>1.610449</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a><span class="n">bet_eval_metrics</span><span class="p">(</span><span class="n">test_jockeyMarket</span><span class="p">)</span>
</code></pre></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped="scoped">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
    <tr style="text-align: right;">
      <th></th>
      <th>npl</th>
      <th>stake</th>
      <th>win</th>
      <th>pot</th>
    </tr>
  </thead>
<tbody>
    <tr>
      <th>0</th>
      <td>36.329</td>
      <td>375.0</td>
      <td>0.109333</td>
      <td>0.096877</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>You can see overfitting in full effect here with the train set performance. However, our out-of-sample performance is still decently profitable. We might have found another profitable betting angle!</p>
<p>It's worth noting that implementing this strategy would be slightly more complex than implementing our first strategy. Our code (or third party tool) would need to be able to check whether the market had firmed between 2 distinct time points before the jump of the race and cross reference that with the jockey name. Trivial for someone who is comfortable with bet placement and the betfair API but a little more involved for the uninitiated. It's important to formulate angles that you would know how and are capable of implementing.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="26-angle-3-backing-to-lay">2.6 Angle 3: Backing To Lay</h3>
<p>Now let's try to use some of our inplay price data we extracted from the stream files. I'm interested in testing some back-to-lay strategies where a horse is backed preplay with the intention to get some tradeout lay order filled during the race. The types of scenarios where this could be conceivably profitable would be on certain kinds of horses or jockeys that show promise or strength early in the race but generally fade late and might not convert those early advantages often.</p>
<p>Things we could look at here are:
- Horses that typically trade lower than their preplay odds but don't win often
- Jockeys that typically trade lower than their preplay odds but don't win often
- Certain combinations of jockey / trainer / horse / race distance that meet these criteria</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a><span class="c1"># First Investigate The Average Inplay Minimums And Loss Rates of Certain Jockeys</span>
<a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a><span class="n">tradeOutIndex</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-30-3" name="__codelineno-30-3" href="#__codelineno-30-3"></a>    <span class="n">dfTrain</span>
<a id="__codelineno-30-4" name="__codelineno-30-4" href="#__codelineno-30-4"></a>    <span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;distance_group in [&quot;long&quot;, &quot;mid_long&quot;]&#39;</span><span class="p">)</span>
<a id="__codelineno-30-5" name="__codelineno-30-5" href="#__codelineno-30-5"></a>    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">inplay_odds_ratio</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;inplay_min_lay&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;bsp&#39;</span><span class="p">])</span>
<a id="__codelineno-30-6" name="__codelineno-30-6" href="#__codelineno-30-6"></a>    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">win</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;place&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
<a id="__codelineno-30-7" name="__codelineno-30-7" href="#__codelineno-30-7"></a>    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">races</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-30-8" name="__codelineno-30-8" href="#__codelineno-30-8"></a>    <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;jockey&#39;</span><span class="p">],</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-30-9" name="__codelineno-30-9" href="#__codelineno-30-9"></a>    <span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s1">&#39;inplay_odds_ratio&#39;</span><span class="p">:</span> <span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;win&#39;</span><span class="p">:</span> <span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;races&#39;</span><span class="p">:</span> <span class="s1">&#39;sum&#39;</span><span class="p">})</span>
<a id="__codelineno-30-10" name="__codelineno-30-10" href="#__codelineno-30-10"></a>    <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;inplay_odds_ratio&#39;</span><span class="p">)</span>
<a id="__codelineno-30-11" name="__codelineno-30-11" href="#__codelineno-30-11"></a>    <span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;races &gt;= 5&#39;</span><span class="p">)</span>
<a id="__codelineno-30-12" name="__codelineno-30-12" href="#__codelineno-30-12"></a><span class="p">)</span>
<a id="__codelineno-30-13" name="__codelineno-30-13" href="#__codelineno-30-13"></a>
<a id="__codelineno-30-14" name="__codelineno-30-14" href="#__codelineno-30-14"></a><span class="n">tradeOutIndex</span>
</code></pre></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped="scoped">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
    <tr style="text-align: right;">
      <th></th>
      <th>jockey</th>
      <th>inplay_odds_ratio</th>
      <th>win</th>
      <th>races</th>
    </tr>
  </thead>
<tbody>
    <tr>
      <th>291</th>
      <td>John Rudd</td>
      <td>0.352796</td>
      <td>0.000000</td>
      <td>8</td>
    </tr>
    <tr>
      <th>457</th>
      <td>Natalie M Morton</td>
      <td>0.357216</td>
      <td>0.142857</td>
      <td>7</td>
    </tr>
    <tr>
      <th>451</th>
      <td>Murray Henderson</td>
      <td>0.455943</td>
      <td>0.166667</td>
      <td>6</td>
    </tr>
    <tr>
      <th>92</th>
      <td>Bridget Grylls</td>
      <td>0.474635</td>
      <td>0.000000</td>
      <td>11</td>
    </tr>
    <tr>
      <th>431</th>
      <td>Ms Heather Poland</td>
      <td>0.478529</td>
      <td>0.000000</td>
      <td>5</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>438</th>
      <td>Ms K Stanley</td>
      <td>0.898819</td>
      <td>0.000000</td>
      <td>21</td>
    </tr>
    <tr>
      <th>619</th>
      <td>Yasuhiro Nishitani</td>
      <td>0.902459</td>
      <td>0.043478</td>
      <td>23</td>
    </tr>
    <tr>
      <th>99</th>
      <td>Cameron Quilty</td>
      <td>0.907503</td>
      <td>0.000000</td>
      <td>20</td>
    </tr>
    <tr>
      <th>87</th>
      <td>Brett Fliedner</td>
      <td>0.923814</td>
      <td>0.000000</td>
      <td>20</td>
    </tr>
    <tr>
      <th>169</th>
      <td>Desiree Stra</td>
      <td>0.949329</td>
      <td>0.000000</td>
      <td>5</td>
    </tr>
  </tbody>
</table>
<p>558 rows  4 columns</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Ok so what we have here is a list of all jockeys with over 5 races on long and mid-long race distance groups (over 1800m) ordered by their average ratio of inplay minimum traded price compared with their jump price.</p>
<p>If this trend is predictive we could assume that these jockeys tend to have an agressive race style and like to get out and lead the race. We'd like to capitalise on that race style by backing the jockeys pre-play and putting in a lay order which we'll leave inplay hoping to get matched during the race.</p>
<p>For simplicity let's just assume we're flat staking on both sides so that our payoff profile looks like this:
- Horse never trades at &lt;50% of it's BSP our lay bet never get's matched and we lose 1 unit
- Horse trades at &lt;50% of it's BSP but loses (our lay bet gets filled) we're breakeven for the market
- Horse trades wins (our lay bet get's filled) and we profit on our back bet and lose our lay bet so our profit is: <code>(BSP-1) - (0.5*BSP-1)</code></p>
<p>Let's run this backtest on the top 20 jockeys in our tradeOutIndex dataframe to see how we'd perform on the train and test set.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a><span class="n">targetTradeoutFraction</span> <span class="o">=</span> <span class="mf">0.5</span>
<a id="__codelineno-31-2" name="__codelineno-31-2" href="#__codelineno-31-2"></a>
<a id="__codelineno-31-3" name="__codelineno-31-3" href="#__codelineno-31-3"></a><span class="n">train_JockeyBackToLay</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-31-4" name="__codelineno-31-4" href="#__codelineno-31-4"></a>    <span class="n">dfTrain</span>
<a id="__codelineno-31-5" name="__codelineno-31-5" href="#__codelineno-31-5"></a>    <span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;distance_group in [&quot;long&quot;, &quot;mid_long&quot;]&#39;</span><span class="p">)</span>
<a id="__codelineno-31-6" name="__codelineno-31-6" href="#__codelineno-31-6"></a>    <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">tradeOutIndex</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">20</span><span class="p">)[</span><span class="s1">&#39;jockey&#39;</span><span class="p">])</span>
<a id="__codelineno-31-7" name="__codelineno-31-7" href="#__codelineno-31-7"></a>    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">npl</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;inplay_min_lay&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">targetTradeoutFraction</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;bsp&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;place&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.95</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;bsp&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;bsp&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)),</span> <span class="mi">0</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
<a id="__codelineno-31-8" name="__codelineno-31-8" href="#__codelineno-31-8"></a>    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">stake</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;npl&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<a id="__codelineno-31-9" name="__codelineno-31-9" href="#__codelineno-31-9"></a>    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">win</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;npl&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
<a id="__codelineno-31-10" name="__codelineno-31-10" href="#__codelineno-31-10"></a><span class="p">)</span>
<a id="__codelineno-31-11" name="__codelineno-31-11" href="#__codelineno-31-11"></a>
<a id="__codelineno-31-12" name="__codelineno-31-12" href="#__codelineno-31-12"></a><span class="n">bet_eval_metrics</span><span class="p">(</span><span class="n">train_JockeyBackToLay</span><span class="p">)</span>
</code></pre></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped="scoped">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
    <tr style="text-align: right;">
      <th></th>
      <th>npl</th>
      <th>stake</th>
      <th>win</th>
      <th>pot</th>
    </tr>
  </thead>
<tbody>
    <tr>
      <th>0</th>
      <td>23.797</td>
      <td>671.0</td>
      <td>0.5181</td>
      <td>0.035465</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a><span class="n">test_JockeyBackToLay</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-32-2" name="__codelineno-32-2" href="#__codelineno-32-2"></a>    <span class="n">dfTest</span>
<a id="__codelineno-32-3" name="__codelineno-32-3" href="#__codelineno-32-3"></a>    <span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;distance_group in [&quot;long&quot;, &quot;mid_long&quot;]&#39;</span><span class="p">)</span>
<a id="__codelineno-32-4" name="__codelineno-32-4" href="#__codelineno-32-4"></a>    <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">tradeOutIndex</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">20</span><span class="p">)[</span><span class="s1">&#39;jockey&#39;</span><span class="p">])</span>
<a id="__codelineno-32-5" name="__codelineno-32-5" href="#__codelineno-32-5"></a>    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">npl</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;inplay_min_lay&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">targetTradeoutFraction</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;bsp&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;place&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.95</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;bsp&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;bsp&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)),</span> <span class="mi">0</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
<a id="__codelineno-32-6" name="__codelineno-32-6" href="#__codelineno-32-6"></a>    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">stake</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;npl&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<a id="__codelineno-32-7" name="__codelineno-32-7" href="#__codelineno-32-7"></a>    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">win</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;npl&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
<a id="__codelineno-32-8" name="__codelineno-32-8" href="#__codelineno-32-8"></a>
<a id="__codelineno-32-9" name="__codelineno-32-9" href="#__codelineno-32-9"></a><span class="p">)</span>
<a id="__codelineno-32-10" name="__codelineno-32-10" href="#__codelineno-32-10"></a>
<a id="__codelineno-32-11" name="__codelineno-32-11" href="#__codelineno-32-11"></a><span class="n">bet_eval_metrics</span><span class="p">(</span><span class="n">test_JockeyBackToLay</span><span class="p">)</span>
</code></pre></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped="scoped">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
    <tr style="text-align: right;">
      <th></th>
      <th>npl</th>
      <th>stake</th>
      <th>win</th>
      <th>pot</th>
    </tr>
  </thead>
<tbody>
    <tr>
      <th>0</th>
      <td>45.62475</td>
      <td>255.0</td>
      <td>0.342105</td>
      <td>0.178921</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Not bad! Looks like we found another possibly promising lead.</p>
<p>Again it's worth noting that this is probably another step up in implementation complexity again from previous angles. It's not very hard when you're familiar with betfair order types and placing them through the API but it requires some additional API savviness. But the documentation is quite good and there's plenty of resources available online to help you understand how to automate something like this.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<hr />
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="30-conclusion">3.0 Conclusion</h2>
<p>This analysis is just a sketch. Hopefully it helps inspire you to think about what kinds of betting angles you could test for a sport or racing code you're interested in. It should give you a framework for thinking about this kind of automated betting, and how it differs from fundamental modelling. It should also give you a few tricks for coming up with your own angles and testing them with the rigour needed to have any realistic expectations of profit. Most of the betting angles you're sold are faulty or have long evaporated from the market by people long before you even knew the rules of the sport. You'll need to be creative and scientific to create your own profitable betting angles, but it's certainly worth it to try.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<hr />
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="complete-code">Complete code</h3>
<p>Run the code from your ide by using <code>py &lt;filename&gt;.py</code>, making sure you amend the path to point to your input data. </p>
<p><a href="https://github.com/betfair-down-under/autoHubTutorials/blob/404ec04284e2ac3ac2f97f4117c77bf27d72be1e/automatedBettingAngles/main.py">Download from Github</a></p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a><span class="kn">import</span> <span class="nn">requests</span>
<a id="__codelineno-33-2" name="__codelineno-33-2" href="#__codelineno-33-2"></a><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<a id="__codelineno-33-3" name="__codelineno-33-3" href="#__codelineno-33-3"></a><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">date</span><span class="p">,</span> <span class="n">timedelta</span>
<a id="__codelineno-33-4" name="__codelineno-33-4" href="#__codelineno-33-4"></a><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<a id="__codelineno-33-5" name="__codelineno-33-5" href="#__codelineno-33-5"></a><span class="kn">import</span> <span class="nn">os</span>
<a id="__codelineno-33-6" name="__codelineno-33-6" href="#__codelineno-33-6"></a><span class="kn">import</span> <span class="nn">re</span>
<a id="__codelineno-33-7" name="__codelineno-33-7" href="#__codelineno-33-7"></a><span class="kn">import</span> <span class="nn">tarfile</span>
<a id="__codelineno-33-8" name="__codelineno-33-8" href="#__codelineno-33-8"></a><span class="kn">import</span> <span class="nn">zipfile</span>
<a id="__codelineno-33-9" name="__codelineno-33-9" href="#__codelineno-33-9"></a><span class="kn">import</span> <span class="nn">bz2</span>
<a id="__codelineno-33-10" name="__codelineno-33-10" href="#__codelineno-33-10"></a><span class="kn">import</span> <span class="nn">glob</span>
<a id="__codelineno-33-11" name="__codelineno-33-11" href="#__codelineno-33-11"></a><span class="kn">import</span> <span class="nn">logging</span>
<a id="__codelineno-33-12" name="__codelineno-33-12" href="#__codelineno-33-12"></a><span class="kn">import</span> <span class="nn">yaml</span>
<a id="__codelineno-33-13" name="__codelineno-33-13" href="#__codelineno-33-13"></a><span class="kn">from</span> <span class="nn">unittest.mock</span> <span class="kn">import</span> <span class="n">patch</span>
<a id="__codelineno-33-14" name="__codelineno-33-14" href="#__codelineno-33-14"></a><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Set</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Optional</span>
<a id="__codelineno-33-15" name="__codelineno-33-15" href="#__codelineno-33-15"></a><span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">zip_longest</span>
<a id="__codelineno-33-16" name="__codelineno-33-16" href="#__codelineno-33-16"></a><span class="kn">import</span> <span class="nn">betfairlightweight</span>
<a id="__codelineno-33-17" name="__codelineno-33-17" href="#__codelineno-33-17"></a><span class="kn">from</span> <span class="nn">betfairlightweight</span> <span class="kn">import</span> <span class="n">StreamListener</span>
<a id="__codelineno-33-18" name="__codelineno-33-18" href="#__codelineno-33-18"></a><span class="kn">from</span> <span class="nn">betfairlightweight.resources.bettingresources</span> <span class="kn">import</span> <span class="p">(</span>
<a id="__codelineno-33-19" name="__codelineno-33-19" href="#__codelineno-33-19"></a>    <span class="n">PriceSize</span><span class="p">,</span>
<a id="__codelineno-33-20" name="__codelineno-33-20" href="#__codelineno-33-20"></a>    <span class="n">MarketBook</span>
<a id="__codelineno-33-21" name="__codelineno-33-21" href="#__codelineno-33-21"></a><span class="p">)</span>
<a id="__codelineno-33-22" name="__codelineno-33-22" href="#__codelineno-33-22"></a><span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">t</span>
<a id="__codelineno-33-23" name="__codelineno-33-23" href="#__codelineno-33-23"></a><span class="kn">import</span> <span class="nn">plotly.express</span> <span class="k">as</span> <span class="nn">px</span>
<a id="__codelineno-33-24" name="__codelineno-33-24" href="#__codelineno-33-24"></a>
<a id="__codelineno-33-25" name="__codelineno-33-25" href="#__codelineno-33-25"></a>
<a id="__codelineno-33-26" name="__codelineno-33-26" href="#__codelineno-33-26"></a><span class="c1"># Utility Functions</span>
<a id="__codelineno-33-27" name="__codelineno-33-27" href="#__codelineno-33-27"></a><span class="c1">#   + Stream Parsing</span>
<a id="__codelineno-33-28" name="__codelineno-33-28" href="#__codelineno-33-28"></a><span class="c1">#   + Betfair Race Data Scraping</span>
<a id="__codelineno-33-29" name="__codelineno-33-29" href="#__codelineno-33-29"></a><span class="c1">#   + Various utilities</span>
<a id="__codelineno-33-30" name="__codelineno-33-30" href="#__codelineno-33-30"></a><span class="c1"># _________________________________</span>
<a id="__codelineno-33-31" name="__codelineno-33-31" href="#__codelineno-33-31"></a>
<a id="__codelineno-33-32" name="__codelineno-33-32" href="#__codelineno-33-32"></a><span class="k">def</span> <span class="nf">as_str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-33-33" name="__codelineno-33-33" href="#__codelineno-33-33"></a>    <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">v</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">float</span> <span class="k">else</span> <span class="n">v</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
<a id="__codelineno-33-34" name="__codelineno-33-34" href="#__codelineno-33-34"></a>
<a id="__codelineno-33-35" name="__codelineno-33-35" href="#__codelineno-33-35"></a><span class="k">def</span> <span class="nf">split_anz_horse_market_name</span><span class="p">(</span><span class="n">market_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-33-36" name="__codelineno-33-36" href="#__codelineno-33-36"></a>    <span class="n">parts</span> <span class="o">=</span> <span class="n">market_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
<a id="__codelineno-33-37" name="__codelineno-33-37" href="#__codelineno-33-37"></a>    <span class="n">race_no</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># return example R6</span>
<a id="__codelineno-33-38" name="__codelineno-33-38" href="#__codelineno-33-38"></a>    <span class="n">race_len</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># return example 1400m</span>
<a id="__codelineno-33-39" name="__codelineno-33-39" href="#__codelineno-33-39"></a>    <span class="n">race_type</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="c1"># return example grp1, trot, pace</span>
<a id="__codelineno-33-40" name="__codelineno-33-40" href="#__codelineno-33-40"></a>    <span class="k">return</span> <span class="p">(</span><span class="n">race_no</span><span class="p">,</span> <span class="n">race_len</span><span class="p">,</span> <span class="n">race_type</span><span class="p">)</span>
<a id="__codelineno-33-41" name="__codelineno-33-41" href="#__codelineno-33-41"></a>
<a id="__codelineno-33-42" name="__codelineno-33-42" href="#__codelineno-33-42"></a><span class="k">def</span> <span class="nf">filter_market</span><span class="p">(</span><span class="n">market</span><span class="p">:</span> <span class="n">MarketBook</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span> 
<a id="__codelineno-33-43" name="__codelineno-33-43" href="#__codelineno-33-43"></a>    <span class="n">d</span> <span class="o">=</span> <span class="n">market</span><span class="o">.</span><span class="n">market_definition</span>
<a id="__codelineno-33-44" name="__codelineno-33-44" href="#__codelineno-33-44"></a>    <span class="k">return</span> <span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">country_code</span> <span class="o">==</span> <span class="s1">&#39;AU&#39;</span> 
<a id="__codelineno-33-45" name="__codelineno-33-45" href="#__codelineno-33-45"></a>        <span class="ow">and</span> <span class="n">d</span><span class="o">.</span><span class="n">market_type</span> <span class="o">==</span> <span class="s1">&#39;WIN&#39;</span> 
<a id="__codelineno-33-46" name="__codelineno-33-46" href="#__codelineno-33-46"></a>        <span class="ow">and</span> <span class="p">(</span><span class="n">c</span> <span class="o">:=</span> <span class="n">split_anz_horse_market_name</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">name</span><span class="p">)[</span><span class="mi">2</span><span class="p">])</span> <span class="o">!=</span> <span class="s1">&#39;trot&#39;</span> <span class="ow">and</span> <span class="n">c</span> <span class="o">!=</span> <span class="s1">&#39;pace&#39;</span><span class="p">)</span>
<a id="__codelineno-33-47" name="__codelineno-33-47" href="#__codelineno-33-47"></a>
<a id="__codelineno-33-48" name="__codelineno-33-48" href="#__codelineno-33-48"></a><span class="k">def</span> <span class="nf">load_markets</span><span class="p">(</span><span class="n">file_paths</span><span class="p">):</span>
<a id="__codelineno-33-49" name="__codelineno-33-49" href="#__codelineno-33-49"></a>    <span class="k">for</span> <span class="n">file_path</span> <span class="ow">in</span> <span class="n">file_paths</span><span class="p">:</span>
<a id="__codelineno-33-50" name="__codelineno-33-50" href="#__codelineno-33-50"></a>        <span class="nb">print</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
<a id="__codelineno-33-51" name="__codelineno-33-51" href="#__codelineno-33-51"></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
<a id="__codelineno-33-52" name="__codelineno-33-52" href="#__codelineno-33-52"></a>            <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">iglob</span><span class="p">(</span><span class="n">file_path</span> <span class="o">+</span> <span class="s1">&#39;**/**/*.bz2&#39;</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<a id="__codelineno-33-53" name="__codelineno-33-53" href="#__codelineno-33-53"></a>                <span class="n">f</span> <span class="o">=</span> <span class="n">bz2</span><span class="o">.</span><span class="n">BZ2File</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
<a id="__codelineno-33-54" name="__codelineno-33-54" href="#__codelineno-33-54"></a>                <span class="k">yield</span> <span class="n">f</span>
<a id="__codelineno-33-55" name="__codelineno-33-55" href="#__codelineno-33-55"></a>                <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<a id="__codelineno-33-56" name="__codelineno-33-56" href="#__codelineno-33-56"></a>        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
<a id="__codelineno-33-57" name="__codelineno-33-57" href="#__codelineno-33-57"></a>            <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file_path</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-33-58" name="__codelineno-33-58" href="#__codelineno-33-58"></a>            <span class="c1"># iterate through a tar archive</span>
<a id="__codelineno-33-59" name="__codelineno-33-59" href="#__codelineno-33-59"></a>            <span class="k">if</span> <span class="n">ext</span> <span class="o">==</span> <span class="s1">&#39;.tar&#39;</span><span class="p">:</span>
<a id="__codelineno-33-60" name="__codelineno-33-60" href="#__codelineno-33-60"></a>                <span class="k">with</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">TarFile</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">archive</span><span class="p">:</span>
<a id="__codelineno-33-61" name="__codelineno-33-61" href="#__codelineno-33-61"></a>                    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">archive</span><span class="p">:</span>
<a id="__codelineno-33-62" name="__codelineno-33-62" href="#__codelineno-33-62"></a>                        <span class="k">yield</span> <span class="n">bz2</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">archive</span><span class="o">.</span><span class="n">extractfile</span><span class="p">(</span><span class="n">file</span><span class="p">))</span>
<a id="__codelineno-33-63" name="__codelineno-33-63" href="#__codelineno-33-63"></a>            <span class="c1"># or a zip archive</span>
<a id="__codelineno-33-64" name="__codelineno-33-64" href="#__codelineno-33-64"></a>            <span class="k">elif</span> <span class="n">ext</span> <span class="o">==</span> <span class="s1">&#39;.zip&#39;</span><span class="p">:</span>
<a id="__codelineno-33-65" name="__codelineno-33-65" href="#__codelineno-33-65"></a>                <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">archive</span><span class="p">:</span>
<a id="__codelineno-33-66" name="__codelineno-33-66" href="#__codelineno-33-66"></a>                    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">archive</span><span class="o">.</span><span class="n">namelist</span><span class="p">():</span>
<a id="__codelineno-33-67" name="__codelineno-33-67" href="#__codelineno-33-67"></a>                        <span class="k">yield</span> <span class="n">bz2</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">archive</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file</span><span class="p">))</span>
<a id="__codelineno-33-68" name="__codelineno-33-68" href="#__codelineno-33-68"></a>
<a id="__codelineno-33-69" name="__codelineno-33-69" href="#__codelineno-33-69"></a>    <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-33-70" name="__codelineno-33-70" href="#__codelineno-33-70"></a>
<a id="__codelineno-33-71" name="__codelineno-33-71" href="#__codelineno-33-71"></a><span class="k">def</span> <span class="nf">slicePrice</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
<a id="__codelineno-33-72" name="__codelineno-33-72" href="#__codelineno-33-72"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-33-73" name="__codelineno-33-73" href="#__codelineno-33-73"></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">price</span>
<a id="__codelineno-33-74" name="__codelineno-33-74" href="#__codelineno-33-74"></a>    <span class="k">except</span><span class="p">:</span>
<a id="__codelineno-33-75" name="__codelineno-33-75" href="#__codelineno-33-75"></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
<a id="__codelineno-33-76" name="__codelineno-33-76" href="#__codelineno-33-76"></a>    <span class="k">return</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-33-77" name="__codelineno-33-77" href="#__codelineno-33-77"></a>
<a id="__codelineno-33-78" name="__codelineno-33-78" href="#__codelineno-33-78"></a><span class="k">def</span> <span class="nf">sliceSize</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
<a id="__codelineno-33-79" name="__codelineno-33-79" href="#__codelineno-33-79"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-33-80" name="__codelineno-33-80" href="#__codelineno-33-80"></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">size</span>
<a id="__codelineno-33-81" name="__codelineno-33-81" href="#__codelineno-33-81"></a>    <span class="k">except</span><span class="p">:</span>
<a id="__codelineno-33-82" name="__codelineno-33-82" href="#__codelineno-33-82"></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
<a id="__codelineno-33-83" name="__codelineno-33-83" href="#__codelineno-33-83"></a>    <span class="k">return</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-33-84" name="__codelineno-33-84" href="#__codelineno-33-84"></a>
<a id="__codelineno-33-85" name="__codelineno-33-85" href="#__codelineno-33-85"></a><span class="k">def</span> <span class="nf">wapPrice</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
<a id="__codelineno-33-86" name="__codelineno-33-86" href="#__codelineno-33-86"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-33-87" name="__codelineno-33-87" href="#__codelineno-33-87"></a>        <span class="n">x</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span> <span class="p">[</span><span class="n">rung</span><span class="o">.</span><span class="n">price</span> <span class="o">*</span> <span class="n">rung</span><span class="o">.</span><span class="n">size</span> <span class="k">for</span> <span class="n">rung</span> <span class="ow">in</span> <span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">:(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span> <span class="p">]</span> <span class="p">)</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span> <span class="p">[</span><span class="n">rung</span><span class="o">.</span><span class="n">size</span> <span class="k">for</span> <span class="n">rung</span> <span class="ow">in</span> <span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">:(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span> <span class="p">]),</span><span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-33-88" name="__codelineno-33-88" href="#__codelineno-33-88"></a>    <span class="k">except</span><span class="p">:</span>
<a id="__codelineno-33-89" name="__codelineno-33-89" href="#__codelineno-33-89"></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
<a id="__codelineno-33-90" name="__codelineno-33-90" href="#__codelineno-33-90"></a>    <span class="k">return</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-33-91" name="__codelineno-33-91" href="#__codelineno-33-91"></a>
<a id="__codelineno-33-92" name="__codelineno-33-92" href="#__codelineno-33-92"></a><span class="k">def</span> <span class="nf">ladder_traded_volume</span><span class="p">(</span><span class="n">ladder</span><span class="p">):</span>
<a id="__codelineno-33-93" name="__codelineno-33-93" href="#__codelineno-33-93"></a>    <span class="k">return</span><span class="p">(</span><span class="nb">sum</span><span class="p">([</span><span class="n">rung</span><span class="o">.</span><span class="n">size</span> <span class="k">for</span> <span class="n">rung</span> <span class="ow">in</span> <span class="n">ladder</span><span class="p">]))</span>
<a id="__codelineno-33-94" name="__codelineno-33-94" href="#__codelineno-33-94"></a>
<a id="__codelineno-33-95" name="__codelineno-33-95" href="#__codelineno-33-95"></a><span class="c1"># Core Execution Fucntions</span>
<a id="__codelineno-33-96" name="__codelineno-33-96" href="#__codelineno-33-96"></a><span class="c1"># _________________________________</span>
<a id="__codelineno-33-97" name="__codelineno-33-97" href="#__codelineno-33-97"></a>
<a id="__codelineno-33-98" name="__codelineno-33-98" href="#__codelineno-33-98"></a><span class="k">def</span> <span class="nf">extract_components_from_stream</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
<a id="__codelineno-33-99" name="__codelineno-33-99" href="#__codelineno-33-99"></a>
<a id="__codelineno-33-100" name="__codelineno-33-100" href="#__codelineno-33-100"></a>    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s2">&quot;builtins.open&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">f</span><span class="p">,</span> <span class="n">_</span><span class="p">:</span> <span class="n">f</span><span class="p">):</span>   
<a id="__codelineno-33-101" name="__codelineno-33-101" href="#__codelineno-33-101"></a>
<a id="__codelineno-33-102" name="__codelineno-33-102" href="#__codelineno-33-102"></a>        <span class="n">evaluate_market</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-33-103" name="__codelineno-33-103" href="#__codelineno-33-103"></a>        <span class="n">prev_market</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-33-104" name="__codelineno-33-104" href="#__codelineno-33-104"></a>        <span class="n">postplay</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-33-105" name="__codelineno-33-105" href="#__codelineno-33-105"></a>        <span class="n">preplay</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-33-106" name="__codelineno-33-106" href="#__codelineno-33-106"></a>        <span class="n">t5m</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-33-107" name="__codelineno-33-107" href="#__codelineno-33-107"></a>        <span class="n">t30s</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-33-108" name="__codelineno-33-108" href="#__codelineno-33-108"></a>        <span class="n">inplay_min_lay</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-33-109" name="__codelineno-33-109" href="#__codelineno-33-109"></a>
<a id="__codelineno-33-110" name="__codelineno-33-110" href="#__codelineno-33-110"></a>        <span class="n">gen</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">get_generator</span><span class="p">()</span>
<a id="__codelineno-33-111" name="__codelineno-33-111" href="#__codelineno-33-111"></a>
<a id="__codelineno-33-112" name="__codelineno-33-112" href="#__codelineno-33-112"></a>        <span class="k">for</span> <span class="n">market_books</span> <span class="ow">in</span> <span class="n">gen</span><span class="p">():</span>
<a id="__codelineno-33-113" name="__codelineno-33-113" href="#__codelineno-33-113"></a>
<a id="__codelineno-33-114" name="__codelineno-33-114" href="#__codelineno-33-114"></a>            <span class="k">for</span> <span class="n">market_book</span> <span class="ow">in</span> <span class="n">market_books</span><span class="p">:</span>
<a id="__codelineno-33-115" name="__codelineno-33-115" href="#__codelineno-33-115"></a>
<a id="__codelineno-33-116" name="__codelineno-33-116" href="#__codelineno-33-116"></a>                <span class="c1"># If markets don&#39;t meet filter return None&#39;s</span>
<a id="__codelineno-33-117" name="__codelineno-33-117" href="#__codelineno-33-117"></a>                <span class="k">if</span> <span class="n">evaluate_market</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">((</span><span class="n">evaluate_market</span> <span class="o">:=</span> <span class="n">filter_market</span><span class="p">(</span><span class="n">market_book</span><span class="p">))</span> <span class="o">==</span> <span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-33-118" name="__codelineno-33-118" href="#__codelineno-33-118"></a>                    <span class="k">return</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-33-119" name="__codelineno-33-119" href="#__codelineno-33-119"></a>
<a id="__codelineno-33-120" name="__codelineno-33-120" href="#__codelineno-33-120"></a>                <span class="c1"># final market view before market goes in play</span>
<a id="__codelineno-33-121" name="__codelineno-33-121" href="#__codelineno-33-121"></a>                <span class="k">if</span> <span class="n">prev_market</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">prev_market</span><span class="o">.</span><span class="n">inplay</span> <span class="o">!=</span> <span class="n">market_book</span><span class="o">.</span><span class="n">inplay</span><span class="p">:</span>
<a id="__codelineno-33-122" name="__codelineno-33-122" href="#__codelineno-33-122"></a>                    <span class="n">preplay</span> <span class="o">=</span> <span class="n">market_book</span>
<a id="__codelineno-33-123" name="__codelineno-33-123" href="#__codelineno-33-123"></a>
<a id="__codelineno-33-124" name="__codelineno-33-124" href="#__codelineno-33-124"></a>                <span class="c1"># final market view before market goes is closed for settlement</span>
<a id="__codelineno-33-125" name="__codelineno-33-125" href="#__codelineno-33-125"></a>                <span class="k">if</span> <span class="n">prev_market</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">prev_market</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;OPEN&quot;</span> <span class="ow">and</span> <span class="n">market_book</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="n">prev_market</span><span class="o">.</span><span class="n">status</span><span class="p">:</span>
<a id="__codelineno-33-126" name="__codelineno-33-126" href="#__codelineno-33-126"></a>                    <span class="n">postplay</span> <span class="o">=</span> <span class="n">market_book</span>
<a id="__codelineno-33-127" name="__codelineno-33-127" href="#__codelineno-33-127"></a>
<a id="__codelineno-33-128" name="__codelineno-33-128" href="#__codelineno-33-128"></a>                <span class="c1"># Calculate Seconds Till Scheduled Market Start Time</span>
<a id="__codelineno-33-129" name="__codelineno-33-129" href="#__codelineno-33-129"></a>                <span class="n">seconds_to_start</span> <span class="o">=</span> <span class="p">(</span><span class="n">market_book</span><span class="o">.</span><span class="n">market_definition</span><span class="o">.</span><span class="n">market_time</span> <span class="o">-</span> <span class="n">market_book</span><span class="o">.</span><span class="n">publish_time</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
<a id="__codelineno-33-130" name="__codelineno-33-130" href="#__codelineno-33-130"></a>
<a id="__codelineno-33-131" name="__codelineno-33-131" href="#__codelineno-33-131"></a>                <span class="c1"># Market at 30 seconds before scheduled off</span>
<a id="__codelineno-33-132" name="__codelineno-33-132" href="#__codelineno-33-132"></a>                <span class="k">if</span> <span class="n">t30s</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">seconds_to_start</span> <span class="o">&lt;</span> <span class="mi">30</span><span class="p">:</span>
<a id="__codelineno-33-133" name="__codelineno-33-133" href="#__codelineno-33-133"></a>                    <span class="n">t30s</span> <span class="o">=</span> <span class="n">market_book</span>
<a id="__codelineno-33-134" name="__codelineno-33-134" href="#__codelineno-33-134"></a>
<a id="__codelineno-33-135" name="__codelineno-33-135" href="#__codelineno-33-135"></a>                <span class="c1"># Market at 5 mins before scheduled off</span>
<a id="__codelineno-33-136" name="__codelineno-33-136" href="#__codelineno-33-136"></a>                <span class="k">if</span> <span class="n">t5m</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">seconds_to_start</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="o">*</span><span class="mi">60</span><span class="p">:</span>
<a id="__codelineno-33-137" name="__codelineno-33-137" href="#__codelineno-33-137"></a>                    <span class="n">t5m</span> <span class="o">=</span> <span class="n">market_book</span>
<a id="__codelineno-33-138" name="__codelineno-33-138" href="#__codelineno-33-138"></a>
<a id="__codelineno-33-139" name="__codelineno-33-139" href="#__codelineno-33-139"></a>                <span class="c1"># Manage Inplay Vectors</span>
<a id="__codelineno-33-140" name="__codelineno-33-140" href="#__codelineno-33-140"></a>                <span class="k">if</span> <span class="n">market_book</span><span class="o">.</span><span class="n">inplay</span><span class="p">:</span>
<a id="__codelineno-33-141" name="__codelineno-33-141" href="#__codelineno-33-141"></a>
<a id="__codelineno-33-142" name="__codelineno-33-142" href="#__codelineno-33-142"></a>                    <span class="k">if</span> <span class="n">inplay_min_lay</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-33-143" name="__codelineno-33-143" href="#__codelineno-33-143"></a>                        <span class="n">inplay_min_lay</span> <span class="o">=</span> <span class="p">[</span> <span class="n">slicePrice</span><span class="p">(</span><span class="n">runner</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">available_to_lay</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">runner</span> <span class="ow">in</span> <span class="n">market_book</span><span class="o">.</span><span class="n">runners</span><span class="p">]</span>
<a id="__codelineno-33-144" name="__codelineno-33-144" href="#__codelineno-33-144"></a>                    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-33-145" name="__codelineno-33-145" href="#__codelineno-33-145"></a>                        <span class="n">inplay_min_lay</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fmin</span><span class="p">(</span><span class="n">inplay_min_lay</span><span class="p">,</span> <span class="p">[</span> <span class="n">slicePrice</span><span class="p">(</span><span class="n">runner</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">available_to_lay</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">runner</span> <span class="ow">in</span> <span class="n">market_book</span><span class="o">.</span><span class="n">runners</span><span class="p">])</span>
<a id="__codelineno-33-146" name="__codelineno-33-146" href="#__codelineno-33-146"></a>
<a id="__codelineno-33-147" name="__codelineno-33-147" href="#__codelineno-33-147"></a>                <span class="c1"># update reference to previous market</span>
<a id="__codelineno-33-148" name="__codelineno-33-148" href="#__codelineno-33-148"></a>                <span class="n">prev_market</span> <span class="o">=</span> <span class="n">market_book</span>
<a id="__codelineno-33-149" name="__codelineno-33-149" href="#__codelineno-33-149"></a>
<a id="__codelineno-33-150" name="__codelineno-33-150" href="#__codelineno-33-150"></a>        <span class="c1"># If market didn&#39;t go inplay</span>
<a id="__codelineno-33-151" name="__codelineno-33-151" href="#__codelineno-33-151"></a>        <span class="k">if</span> <span class="n">postplay</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">preplay</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-33-152" name="__codelineno-33-152" href="#__codelineno-33-152"></a>            <span class="n">preplay</span> <span class="o">=</span> <span class="n">postplay</span>
<a id="__codelineno-33-153" name="__codelineno-33-153" href="#__codelineno-33-153"></a>            <span class="n">inplay_min_lay</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&quot;</span> <span class="k">for</span> <span class="n">runner</span> <span class="ow">in</span> <span class="n">market_book</span><span class="o">.</span><span class="n">runners</span><span class="p">]</span>
<a id="__codelineno-33-154" name="__codelineno-33-154" href="#__codelineno-33-154"></a>
<a id="__codelineno-33-155" name="__codelineno-33-155" href="#__codelineno-33-155"></a>        <span class="k">return</span> <span class="p">(</span><span class="n">t5m</span><span class="p">,</span> <span class="n">t30s</span><span class="p">,</span> <span class="n">preplay</span><span class="p">,</span> <span class="n">postplay</span><span class="p">,</span> <span class="n">inplay_min_lay</span><span class="p">,</span> <span class="n">prev_market</span><span class="p">)</span> <span class="c1"># Final market is last prev_market</span>
<a id="__codelineno-33-156" name="__codelineno-33-156" href="#__codelineno-33-156"></a>
<a id="__codelineno-33-157" name="__codelineno-33-157" href="#__codelineno-33-157"></a><span class="k">def</span> <span class="nf">parse_stream</span><span class="p">(</span><span class="n">stream_files</span><span class="p">,</span> <span class="n">output_file</span><span class="p">):</span>
<a id="__codelineno-33-158" name="__codelineno-33-158" href="#__codelineno-33-158"></a>
<a id="__codelineno-33-159" name="__codelineno-33-159" href="#__codelineno-33-159"></a>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="s2">&quot;w+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">output</span><span class="p">:</span>
<a id="__codelineno-33-160" name="__codelineno-33-160" href="#__codelineno-33-160"></a>
<a id="__codelineno-33-161" name="__codelineno-33-161" href="#__codelineno-33-161"></a>        <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;market_id,selection_id,selection_name,wap_5m,wap_30s,bsp,ltp,traded_vol,inplay_min_lay</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-33-162" name="__codelineno-33-162" href="#__codelineno-33-162"></a>
<a id="__codelineno-33-163" name="__codelineno-33-163" href="#__codelineno-33-163"></a>        <span class="k">for</span> <span class="n">file_obj</span> <span class="ow">in</span> <span class="n">load_markets</span><span class="p">(</span><span class="n">stream_files</span><span class="p">):</span>
<a id="__codelineno-33-164" name="__codelineno-33-164" href="#__codelineno-33-164"></a>
<a id="__codelineno-33-165" name="__codelineno-33-165" href="#__codelineno-33-165"></a>            <span class="n">stream</span> <span class="o">=</span> <span class="n">trading</span><span class="o">.</span><span class="n">streaming</span><span class="o">.</span><span class="n">create_historical_generator_stream</span><span class="p">(</span>
<a id="__codelineno-33-166" name="__codelineno-33-166" href="#__codelineno-33-166"></a>                <span class="n">file_path</span><span class="o">=</span><span class="n">file_obj</span><span class="p">,</span>
<a id="__codelineno-33-167" name="__codelineno-33-167" href="#__codelineno-33-167"></a>                <span class="n">listener</span><span class="o">=</span><span class="n">listener</span><span class="p">,</span>
<a id="__codelineno-33-168" name="__codelineno-33-168" href="#__codelineno-33-168"></a>            <span class="p">)</span>
<a id="__codelineno-33-169" name="__codelineno-33-169" href="#__codelineno-33-169"></a>
<a id="__codelineno-33-170" name="__codelineno-33-170" href="#__codelineno-33-170"></a>            <span class="p">(</span><span class="n">t5m</span><span class="p">,</span> <span class="n">t30s</span><span class="p">,</span> <span class="n">preplay</span><span class="p">,</span> <span class="n">postplay</span><span class="p">,</span> <span class="n">inplayMin</span><span class="p">,</span> <span class="n">final</span><span class="p">)</span> <span class="o">=</span> <span class="n">extract_components_from_stream</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
<a id="__codelineno-33-171" name="__codelineno-33-171" href="#__codelineno-33-171"></a>
<a id="__codelineno-33-172" name="__codelineno-33-172" href="#__codelineno-33-172"></a>            <span class="c1"># If no price data for market don&#39;t write to file</span>
<a id="__codelineno-33-173" name="__codelineno-33-173" href="#__codelineno-33-173"></a>            <span class="k">if</span> <span class="n">postplay</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">final</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">t30s</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-33-174" name="__codelineno-33-174" href="#__codelineno-33-174"></a>                <span class="k">continue</span><span class="p">;</span> 
<a id="__codelineno-33-175" name="__codelineno-33-175" href="#__codelineno-33-175"></a>
<a id="__codelineno-33-176" name="__codelineno-33-176" href="#__codelineno-33-176"></a>            <span class="c1"># All runner removed</span>
<a id="__codelineno-33-177" name="__codelineno-33-177" href="#__codelineno-33-177"></a>            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">runner</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;REMOVED&quot;</span> <span class="k">for</span> <span class="n">runner</span> <span class="ow">in</span> <span class="n">final</span><span class="o">.</span><span class="n">runners</span><span class="p">):</span>
<a id="__codelineno-33-178" name="__codelineno-33-178" href="#__codelineno-33-178"></a>                <span class="k">continue</span>
<a id="__codelineno-33-179" name="__codelineno-33-179" href="#__codelineno-33-179"></a>
<a id="__codelineno-33-180" name="__codelineno-33-180" href="#__codelineno-33-180"></a>            <span class="n">runnerMeta</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-33-181" name="__codelineno-33-181" href="#__codelineno-33-181"></a>                <span class="p">{</span>
<a id="__codelineno-33-182" name="__codelineno-33-182" href="#__codelineno-33-182"></a>                    <span class="s1">&#39;selection_id&#39;</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">selection_id</span><span class="p">,</span>
<a id="__codelineno-33-183" name="__codelineno-33-183" href="#__codelineno-33-183"></a>                    <span class="s1">&#39;selection_name&#39;</span><span class="p">:</span> <span class="nb">next</span><span class="p">((</span><span class="n">rd</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">rd</span> <span class="ow">in</span> <span class="n">final</span><span class="o">.</span><span class="n">market_definition</span><span class="o">.</span><span class="n">runners</span> <span class="k">if</span> <span class="n">rd</span><span class="o">.</span><span class="n">selection_id</span> <span class="o">==</span> <span class="n">r</span><span class="o">.</span><span class="n">selection_id</span><span class="p">),</span> <span class="kc">None</span><span class="p">),</span>
<a id="__codelineno-33-184" name="__codelineno-33-184" href="#__codelineno-33-184"></a>                    <span class="s1">&#39;selection_status&#39;</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
<a id="__codelineno-33-185" name="__codelineno-33-185" href="#__codelineno-33-185"></a>                    <span class="s1">&#39;sp&#39;</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">actual_sp</span>
<a id="__codelineno-33-186" name="__codelineno-33-186" href="#__codelineno-33-186"></a>                <span class="p">}</span>
<a id="__codelineno-33-187" name="__codelineno-33-187" href="#__codelineno-33-187"></a>                <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">final</span><span class="o">.</span><span class="n">runners</span> 
<a id="__codelineno-33-188" name="__codelineno-33-188" href="#__codelineno-33-188"></a>            <span class="p">]</span>
<a id="__codelineno-33-189" name="__codelineno-33-189" href="#__codelineno-33-189"></a>
<a id="__codelineno-33-190" name="__codelineno-33-190" href="#__codelineno-33-190"></a>            <span class="n">ltp</span> <span class="o">=</span> <span class="p">[</span><span class="n">runner</span><span class="o">.</span><span class="n">last_price_traded</span> <span class="k">for</span> <span class="n">runner</span> <span class="ow">in</span> <span class="n">preplay</span><span class="o">.</span><span class="n">runners</span><span class="p">]</span>
<a id="__codelineno-33-191" name="__codelineno-33-191" href="#__codelineno-33-191"></a>
<a id="__codelineno-33-192" name="__codelineno-33-192" href="#__codelineno-33-192"></a>            <span class="n">tradedVol</span> <span class="o">=</span> <span class="p">[</span> <span class="n">ladder_traded_volume</span><span class="p">(</span><span class="n">runner</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">traded_volume</span><span class="p">)</span> <span class="k">for</span> <span class="n">runner</span> <span class="ow">in</span> <span class="n">postplay</span><span class="o">.</span><span class="n">runners</span> <span class="p">]</span>
<a id="__codelineno-33-193" name="__codelineno-33-193" href="#__codelineno-33-193"></a>
<a id="__codelineno-33-194" name="__codelineno-33-194" href="#__codelineno-33-194"></a>            <span class="n">wapBack30s</span> <span class="o">=</span> <span class="p">[</span> <span class="n">wapPrice</span><span class="p">(</span><span class="n">runner</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">available_to_back</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="k">for</span> <span class="n">runner</span> <span class="ow">in</span> <span class="n">t30s</span><span class="o">.</span><span class="n">runners</span><span class="p">]</span>
<a id="__codelineno-33-195" name="__codelineno-33-195" href="#__codelineno-33-195"></a>
<a id="__codelineno-33-196" name="__codelineno-33-196" href="#__codelineno-33-196"></a>            <span class="n">wapBack5m</span> <span class="o">=</span> <span class="p">[</span> <span class="n">wapPrice</span><span class="p">(</span><span class="n">runner</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">available_to_back</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="k">for</span> <span class="n">runner</span> <span class="ow">in</span> <span class="n">t5m</span><span class="o">.</span><span class="n">runners</span><span class="p">]</span>
<a id="__codelineno-33-197" name="__codelineno-33-197" href="#__codelineno-33-197"></a>
<a id="__codelineno-33-198" name="__codelineno-33-198" href="#__codelineno-33-198"></a>            <span class="c1"># Writing To CSV</span>
<a id="__codelineno-33-199" name="__codelineno-33-199" href="#__codelineno-33-199"></a>            <span class="c1"># ______________________</span>
<a id="__codelineno-33-200" name="__codelineno-33-200" href="#__codelineno-33-200"></a>
<a id="__codelineno-33-201" name="__codelineno-33-201" href="#__codelineno-33-201"></a>            <span class="k">for</span> <span class="p">(</span><span class="n">runnerMeta</span><span class="p">,</span> <span class="n">ltp</span><span class="p">,</span> <span class="n">tradedVol</span><span class="p">,</span> <span class="n">inplayMin</span><span class="p">,</span> <span class="n">wapBack5m</span><span class="p">,</span> <span class="n">wapBack30s</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">runnerMeta</span><span class="p">,</span> <span class="n">ltp</span><span class="p">,</span> <span class="n">tradedVol</span><span class="p">,</span> <span class="n">inplayMin</span><span class="p">,</span> <span class="n">wapBack5m</span><span class="p">,</span> <span class="n">wapBack30s</span><span class="p">):</span>
<a id="__codelineno-33-202" name="__codelineno-33-202" href="#__codelineno-33-202"></a>
<a id="__codelineno-33-203" name="__codelineno-33-203" href="#__codelineno-33-203"></a>                <span class="k">if</span> <span class="n">runnerMeta</span><span class="p">[</span><span class="s1">&#39;selection_status&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;REMOVED&#39;</span><span class="p">:</span>
<a id="__codelineno-33-204" name="__codelineno-33-204" href="#__codelineno-33-204"></a>
<a id="__codelineno-33-205" name="__codelineno-33-205" href="#__codelineno-33-205"></a>                    <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
<a id="__codelineno-33-206" name="__codelineno-33-206" href="#__codelineno-33-206"></a>                        <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
<a id="__codelineno-33-207" name="__codelineno-33-207" href="#__codelineno-33-207"></a>                            <span class="nb">str</span><span class="p">(</span><span class="n">final</span><span class="o">.</span><span class="n">market_id</span><span class="p">),</span>
<a id="__codelineno-33-208" name="__codelineno-33-208" href="#__codelineno-33-208"></a>                            <span class="n">runnerMeta</span><span class="p">[</span><span class="s1">&#39;selection_id&#39;</span><span class="p">],</span>
<a id="__codelineno-33-209" name="__codelineno-33-209" href="#__codelineno-33-209"></a>                            <span class="n">runnerMeta</span><span class="p">[</span><span class="s1">&#39;selection_name&#39;</span><span class="p">],</span>
<a id="__codelineno-33-210" name="__codelineno-33-210" href="#__codelineno-33-210"></a>                            <span class="n">wapBack5m</span><span class="p">,</span>
<a id="__codelineno-33-211" name="__codelineno-33-211" href="#__codelineno-33-211"></a>                            <span class="n">wapBack30s</span><span class="p">,</span>
<a id="__codelineno-33-212" name="__codelineno-33-212" href="#__codelineno-33-212"></a>                            <span class="n">runnerMeta</span><span class="p">[</span><span class="s1">&#39;sp&#39;</span><span class="p">],</span>
<a id="__codelineno-33-213" name="__codelineno-33-213" href="#__codelineno-33-213"></a>                            <span class="n">ltp</span><span class="p">,</span>
<a id="__codelineno-33-214" name="__codelineno-33-214" href="#__codelineno-33-214"></a>                            <span class="nb">round</span><span class="p">(</span><span class="n">tradedVol</span><span class="p">),</span>
<a id="__codelineno-33-215" name="__codelineno-33-215" href="#__codelineno-33-215"></a>                            <span class="n">inplayMin</span>
<a id="__codelineno-33-216" name="__codelineno-33-216" href="#__codelineno-33-216"></a>                        <span class="p">)</span>
<a id="__codelineno-33-217" name="__codelineno-33-217" href="#__codelineno-33-217"></a>                    <span class="p">)</span>
<a id="__codelineno-33-218" name="__codelineno-33-218" href="#__codelineno-33-218"></a>
<a id="__codelineno-33-219" name="__codelineno-33-219" href="#__codelineno-33-219"></a><span class="k">def</span> <span class="nf">get_bf_markets</span><span class="p">(</span><span class="n">dte</span><span class="p">):</span>
<a id="__codelineno-33-220" name="__codelineno-33-220" href="#__codelineno-33-220"></a>
<a id="__codelineno-33-221" name="__codelineno-33-221" href="#__codelineno-33-221"></a>    <span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;https://apigateway.betfair.com.au/hub/racecard?date=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dte</span><span class="p">)</span>
<a id="__codelineno-33-222" name="__codelineno-33-222" href="#__codelineno-33-222"></a>
<a id="__codelineno-33-223" name="__codelineno-33-223" href="#__codelineno-33-223"></a>    <span class="n">responseJson</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
<a id="__codelineno-33-224" name="__codelineno-33-224" href="#__codelineno-33-224"></a>
<a id="__codelineno-33-225" name="__codelineno-33-225" href="#__codelineno-33-225"></a>    <span class="n">marketList</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-33-226" name="__codelineno-33-226" href="#__codelineno-33-226"></a>
<a id="__codelineno-33-227" name="__codelineno-33-227" href="#__codelineno-33-227"></a>    <span class="k">for</span> <span class="n">meeting</span> <span class="ow">in</span> <span class="n">responseJson</span><span class="p">[</span><span class="s1">&#39;MEETINGS&#39;</span><span class="p">]:</span>
<a id="__codelineno-33-228" name="__codelineno-33-228" href="#__codelineno-33-228"></a>        <span class="k">for</span> <span class="n">markets</span> <span class="ow">in</span> <span class="n">meeting</span><span class="p">[</span><span class="s1">&#39;MARKETS&#39;</span><span class="p">]:</span>
<a id="__codelineno-33-229" name="__codelineno-33-229" href="#__codelineno-33-229"></a>            <span class="n">marketList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
<a id="__codelineno-33-230" name="__codelineno-33-230" href="#__codelineno-33-230"></a>                <span class="p">{</span>
<a id="__codelineno-33-231" name="__codelineno-33-231" href="#__codelineno-33-231"></a>                    <span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="n">dte</span><span class="p">,</span>
<a id="__codelineno-33-232" name="__codelineno-33-232" href="#__codelineno-33-232"></a>                    <span class="s1">&#39;track&#39;</span><span class="p">:</span> <span class="n">meeting</span><span class="p">[</span><span class="s1">&#39;VENUE_NAME&#39;</span><span class="p">],</span>
<a id="__codelineno-33-233" name="__codelineno-33-233" href="#__codelineno-33-233"></a>                    <span class="s1">&#39;country&#39;</span><span class="p">:</span> <span class="n">meeting</span><span class="p">[</span><span class="s1">&#39;COUNTRY&#39;</span><span class="p">],</span>
<a id="__codelineno-33-234" name="__codelineno-33-234" href="#__codelineno-33-234"></a>                    <span class="s1">&#39;race_type&#39;</span><span class="p">:</span> <span class="n">meeting</span><span class="p">[</span><span class="s1">&#39;RACE_TYPE&#39;</span><span class="p">],</span>
<a id="__codelineno-33-235" name="__codelineno-33-235" href="#__codelineno-33-235"></a>                    <span class="s1">&#39;race_number&#39;</span><span class="p">:</span> <span class="n">markets</span><span class="p">[</span><span class="s1">&#39;RACE_NO&#39;</span><span class="p">],</span>
<a id="__codelineno-33-236" name="__codelineno-33-236" href="#__codelineno-33-236"></a>                    <span class="s1">&#39;market_id&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="s1">&#39;1.&#39;</span> <span class="o">+</span> <span class="n">markets</span><span class="p">[</span><span class="s1">&#39;MARKET_ID&#39;</span><span class="p">]),</span>
<a id="__codelineno-33-237" name="__codelineno-33-237" href="#__codelineno-33-237"></a>                    <span class="s1">&#39;start_time&#39;</span><span class="p">:</span> <span class="n">markets</span><span class="p">[</span><span class="s1">&#39;START_TIME&#39;</span><span class="p">]</span>
<a id="__codelineno-33-238" name="__codelineno-33-238" href="#__codelineno-33-238"></a>                <span class="p">}</span>
<a id="__codelineno-33-239" name="__codelineno-33-239" href="#__codelineno-33-239"></a>            <span class="p">)</span>
<a id="__codelineno-33-240" name="__codelineno-33-240" href="#__codelineno-33-240"></a>
<a id="__codelineno-33-241" name="__codelineno-33-241" href="#__codelineno-33-241"></a>    <span class="n">marketDf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">marketList</span><span class="p">)</span>
<a id="__codelineno-33-242" name="__codelineno-33-242" href="#__codelineno-33-242"></a>
<a id="__codelineno-33-243" name="__codelineno-33-243" href="#__codelineno-33-243"></a>    <span class="k">return</span><span class="p">(</span><span class="n">marketDf</span><span class="p">)</span>
<a id="__codelineno-33-244" name="__codelineno-33-244" href="#__codelineno-33-244"></a>
<a id="__codelineno-33-245" name="__codelineno-33-245" href="#__codelineno-33-245"></a><span class="k">def</span> <span class="nf">get_bf_race_meta</span><span class="p">(</span><span class="n">market_id</span><span class="p">):</span>
<a id="__codelineno-33-246" name="__codelineno-33-246" href="#__codelineno-33-246"></a>
<a id="__codelineno-33-247" name="__codelineno-33-247" href="#__codelineno-33-247"></a>    <span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;https://apigateway.betfair.com.au/hub/raceevent/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">market_id</span><span class="p">)</span>
<a id="__codelineno-33-248" name="__codelineno-33-248" href="#__codelineno-33-248"></a>
<a id="__codelineno-33-249" name="__codelineno-33-249" href="#__codelineno-33-249"></a>    <span class="n">responseJson</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
<a id="__codelineno-33-250" name="__codelineno-33-250" href="#__codelineno-33-250"></a>
<a id="__codelineno-33-251" name="__codelineno-33-251" href="#__codelineno-33-251"></a>    <span class="k">if</span> <span class="s1">&#39;error&#39;</span> <span class="ow">in</span> <span class="n">responseJson</span><span class="p">:</span>
<a id="__codelineno-33-252" name="__codelineno-33-252" href="#__codelineno-33-252"></a>        <span class="k">return</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">())</span>
<a id="__codelineno-33-253" name="__codelineno-33-253" href="#__codelineno-33-253"></a>
<a id="__codelineno-33-254" name="__codelineno-33-254" href="#__codelineno-33-254"></a>    <span class="n">raceList</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-33-255" name="__codelineno-33-255" href="#__codelineno-33-255"></a>
<a id="__codelineno-33-256" name="__codelineno-33-256" href="#__codelineno-33-256"></a>    <span class="k">for</span> <span class="n">runner</span> <span class="ow">in</span> <span class="n">responseJson</span><span class="p">[</span><span class="s1">&#39;runners&#39;</span><span class="p">]:</span>
<a id="__codelineno-33-257" name="__codelineno-33-257" href="#__codelineno-33-257"></a>
<a id="__codelineno-33-258" name="__codelineno-33-258" href="#__codelineno-33-258"></a>        <span class="k">if</span> <span class="s1">&#39;isScratched&#39;</span> <span class="ow">in</span> <span class="n">runner</span> <span class="ow">and</span> <span class="n">runner</span><span class="p">[</span><span class="s1">&#39;isScratched&#39;</span><span class="p">]:</span>
<a id="__codelineno-33-259" name="__codelineno-33-259" href="#__codelineno-33-259"></a>            <span class="k">continue</span>
<a id="__codelineno-33-260" name="__codelineno-33-260" href="#__codelineno-33-260"></a>
<a id="__codelineno-33-261" name="__codelineno-33-261" href="#__codelineno-33-261"></a>        <span class="c1"># Jockey not always populated</span>
<a id="__codelineno-33-262" name="__codelineno-33-262" href="#__codelineno-33-262"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-33-263" name="__codelineno-33-263" href="#__codelineno-33-263"></a>            <span class="n">jockey</span> <span class="o">=</span> <span class="n">runner</span><span class="p">[</span><span class="s1">&#39;jockeyName&#39;</span><span class="p">]</span>
<a id="__codelineno-33-264" name="__codelineno-33-264" href="#__codelineno-33-264"></a>        <span class="k">except</span><span class="p">:</span>
<a id="__codelineno-33-265" name="__codelineno-33-265" href="#__codelineno-33-265"></a>            <span class="n">jockey</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-33-266" name="__codelineno-33-266" href="#__codelineno-33-266"></a>
<a id="__codelineno-33-267" name="__codelineno-33-267" href="#__codelineno-33-267"></a>        <span class="c1"># Place not always populated</span>
<a id="__codelineno-33-268" name="__codelineno-33-268" href="#__codelineno-33-268"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-33-269" name="__codelineno-33-269" href="#__codelineno-33-269"></a>            <span class="n">placeResult</span> <span class="o">=</span> <span class="n">runner</span><span class="p">[</span><span class="s1">&#39;placedResult&#39;</span><span class="p">]</span>
<a id="__codelineno-33-270" name="__codelineno-33-270" href="#__codelineno-33-270"></a>        <span class="k">except</span><span class="p">:</span>
<a id="__codelineno-33-271" name="__codelineno-33-271" href="#__codelineno-33-271"></a>            <span class="n">placeResult</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-33-272" name="__codelineno-33-272" href="#__codelineno-33-272"></a>
<a id="__codelineno-33-273" name="__codelineno-33-273" href="#__codelineno-33-273"></a>        <span class="c1"># Place not always populated</span>
<a id="__codelineno-33-274" name="__codelineno-33-274" href="#__codelineno-33-274"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-33-275" name="__codelineno-33-275" href="#__codelineno-33-275"></a>            <span class="n">trainer</span> <span class="o">=</span> <span class="n">runner</span><span class="p">[</span><span class="s1">&#39;trainerName&#39;</span><span class="p">]</span>
<a id="__codelineno-33-276" name="__codelineno-33-276" href="#__codelineno-33-276"></a>        <span class="k">except</span><span class="p">:</span>
<a id="__codelineno-33-277" name="__codelineno-33-277" href="#__codelineno-33-277"></a>            <span class="n">trainer</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-33-278" name="__codelineno-33-278" href="#__codelineno-33-278"></a>
<a id="__codelineno-33-279" name="__codelineno-33-279" href="#__codelineno-33-279"></a>        <span class="n">raceList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
<a id="__codelineno-33-280" name="__codelineno-33-280" href="#__codelineno-33-280"></a>            <span class="p">{</span>
<a id="__codelineno-33-281" name="__codelineno-33-281" href="#__codelineno-33-281"></a>                <span class="s1">&#39;market_id&#39;</span><span class="p">:</span> <span class="n">market_id</span><span class="p">,</span>
<a id="__codelineno-33-282" name="__codelineno-33-282" href="#__codelineno-33-282"></a>                <span class="s1">&#39;weather&#39;</span><span class="p">:</span> <span class="n">responseJson</span><span class="p">[</span><span class="s1">&#39;weather&#39;</span><span class="p">],</span>
<a id="__codelineno-33-283" name="__codelineno-33-283" href="#__codelineno-33-283"></a>                <span class="s1">&#39;track_condition&#39;</span><span class="p">:</span> <span class="n">responseJson</span><span class="p">[</span><span class="s1">&#39;trackCondition&#39;</span><span class="p">],</span>
<a id="__codelineno-33-284" name="__codelineno-33-284" href="#__codelineno-33-284"></a>                <span class="s1">&#39;race_distance&#39;</span><span class="p">:</span> <span class="n">responseJson</span><span class="p">[</span><span class="s1">&#39;raceLength&#39;</span><span class="p">],</span>
<a id="__codelineno-33-285" name="__codelineno-33-285" href="#__codelineno-33-285"></a>                <span class="s1">&#39;selection_id&#39;</span><span class="p">:</span> <span class="n">runner</span><span class="p">[</span><span class="s1">&#39;selectionId&#39;</span><span class="p">],</span>
<a id="__codelineno-33-286" name="__codelineno-33-286" href="#__codelineno-33-286"></a>                <span class="s1">&#39;selection_name&#39;</span><span class="p">:</span> <span class="n">runner</span><span class="p">[</span><span class="s1">&#39;runnerName&#39;</span><span class="p">],</span>
<a id="__codelineno-33-287" name="__codelineno-33-287" href="#__codelineno-33-287"></a>                <span class="s1">&#39;barrier&#39;</span><span class="p">:</span> <span class="n">runner</span><span class="p">[</span><span class="s1">&#39;barrierNo&#39;</span><span class="p">],</span>
<a id="__codelineno-33-288" name="__codelineno-33-288" href="#__codelineno-33-288"></a>                <span class="s1">&#39;place&#39;</span><span class="p">:</span> <span class="n">placeResult</span><span class="p">,</span>
<a id="__codelineno-33-289" name="__codelineno-33-289" href="#__codelineno-33-289"></a>                <span class="s1">&#39;trainer&#39;</span><span class="p">:</span> <span class="n">trainer</span><span class="p">,</span>
<a id="__codelineno-33-290" name="__codelineno-33-290" href="#__codelineno-33-290"></a>                <span class="s1">&#39;jockey&#39;</span><span class="p">:</span> <span class="n">jockey</span><span class="p">,</span>
<a id="__codelineno-33-291" name="__codelineno-33-291" href="#__codelineno-33-291"></a>                <span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="n">runner</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">]</span>
<a id="__codelineno-33-292" name="__codelineno-33-292" href="#__codelineno-33-292"></a>            <span class="p">}</span>
<a id="__codelineno-33-293" name="__codelineno-33-293" href="#__codelineno-33-293"></a>        <span class="p">)</span>
<a id="__codelineno-33-294" name="__codelineno-33-294" href="#__codelineno-33-294"></a>
<a id="__codelineno-33-295" name="__codelineno-33-295" href="#__codelineno-33-295"></a>    <span class="n">raceDf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">raceList</span><span class="p">)</span>
<a id="__codelineno-33-296" name="__codelineno-33-296" href="#__codelineno-33-296"></a>
<a id="__codelineno-33-297" name="__codelineno-33-297" href="#__codelineno-33-297"></a>    <span class="k">return</span><span class="p">(</span><span class="n">raceDf</span><span class="p">)</span>
<a id="__codelineno-33-298" name="__codelineno-33-298" href="#__codelineno-33-298"></a>
<a id="__codelineno-33-299" name="__codelineno-33-299" href="#__codelineno-33-299"></a><span class="k">def</span> <span class="nf">scrape_thoroughbred_bf_date</span><span class="p">(</span><span class="n">dte</span><span class="p">):</span>
<a id="__codelineno-33-300" name="__codelineno-33-300" href="#__codelineno-33-300"></a>
<a id="__codelineno-33-301" name="__codelineno-33-301" href="#__codelineno-33-301"></a>    <span class="n">markets</span> <span class="o">=</span> <span class="n">get_bf_markets</span><span class="p">(</span><span class="n">dte</span><span class="p">)</span>
<a id="__codelineno-33-302" name="__codelineno-33-302" href="#__codelineno-33-302"></a>
<a id="__codelineno-33-303" name="__codelineno-33-303" href="#__codelineno-33-303"></a>    <span class="k">if</span> <span class="n">markets</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-33-304" name="__codelineno-33-304" href="#__codelineno-33-304"></a>        <span class="k">return</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">())</span>
<a id="__codelineno-33-305" name="__codelineno-33-305" href="#__codelineno-33-305"></a>
<a id="__codelineno-33-306" name="__codelineno-33-306" href="#__codelineno-33-306"></a>    <span class="n">thoMarkets</span> <span class="o">=</span> <span class="n">markets</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;country == &quot;AUS&quot; and race_type == &quot;R&quot;&#39;</span><span class="p">)</span>
<a id="__codelineno-33-307" name="__codelineno-33-307" href="#__codelineno-33-307"></a>
<a id="__codelineno-33-308" name="__codelineno-33-308" href="#__codelineno-33-308"></a>    <span class="k">if</span> <span class="n">thoMarkets</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-33-309" name="__codelineno-33-309" href="#__codelineno-33-309"></a>        <span class="k">return</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">())</span>
<a id="__codelineno-33-310" name="__codelineno-33-310" href="#__codelineno-33-310"></a>
<a id="__codelineno-33-311" name="__codelineno-33-311" href="#__codelineno-33-311"></a>    <span class="n">raceMetaList</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-33-312" name="__codelineno-33-312" href="#__codelineno-33-312"></a>
<a id="__codelineno-33-313" name="__codelineno-33-313" href="#__codelineno-33-313"></a>    <span class="k">for</span> <span class="n">market</span> <span class="ow">in</span> <span class="n">thoMarkets</span><span class="o">.</span><span class="n">market_id</span><span class="p">:</span>
<a id="__codelineno-33-314" name="__codelineno-33-314" href="#__codelineno-33-314"></a>        <span class="n">raceMetaList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">get_bf_race_meta</span><span class="p">(</span><span class="n">market</span><span class="p">))</span>
<a id="__codelineno-33-315" name="__codelineno-33-315" href="#__codelineno-33-315"></a>
<a id="__codelineno-33-316" name="__codelineno-33-316" href="#__codelineno-33-316"></a>    <span class="n">raceMeta</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">raceMetaList</span><span class="p">)</span>
<a id="__codelineno-33-317" name="__codelineno-33-317" href="#__codelineno-33-317"></a>
<a id="__codelineno-33-318" name="__codelineno-33-318" href="#__codelineno-33-318"></a>    <span class="k">return</span><span class="p">(</span><span class="n">markets</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">raceMeta</span><span class="p">,</span> <span class="n">on</span> <span class="o">=</span> <span class="s1">&#39;market_id&#39;</span><span class="p">))</span>
<a id="__codelineno-33-319" name="__codelineno-33-319" href="#__codelineno-33-319"></a>
<a id="__codelineno-33-320" name="__codelineno-33-320" href="#__codelineno-33-320"></a>
<a id="__codelineno-33-321" name="__codelineno-33-321" href="#__codelineno-33-321"></a><span class="c1"># Execute Data Pipeline</span>
<a id="__codelineno-33-322" name="__codelineno-33-322" href="#__codelineno-33-322"></a><span class="c1"># _________________________________</span>
<a id="__codelineno-33-323" name="__codelineno-33-323" href="#__codelineno-33-323"></a>
<a id="__codelineno-33-324" name="__codelineno-33-324" href="#__codelineno-33-324"></a><span class="c1"># Description:</span>
<a id="__codelineno-33-325" name="__codelineno-33-325" href="#__codelineno-33-325"></a><span class="c1">#   Will loop through a set of dates (starting July 2020 in this instance) and return race metadata from betfair </span>
<a id="__codelineno-33-326" name="__codelineno-33-326" href="#__codelineno-33-326"></a><span class="c1"># Estimated Time:</span>
<a id="__codelineno-33-327" name="__codelineno-33-327" href="#__codelineno-33-327"></a><span class="c1">#   ~60 mins</span>
<a id="__codelineno-33-328" name="__codelineno-33-328" href="#__codelineno-33-328"></a><span class="c1"># </span>
<a id="__codelineno-33-329" name="__codelineno-33-329" href="#__codelineno-33-329"></a><span class="c1"># if __name__ == &#39;__main__&#39;:</span>
<a id="__codelineno-33-330" name="__codelineno-33-330" href="#__codelineno-33-330"></a>    <span class="c1"># dataList = []</span>
<a id="__codelineno-33-331" name="__codelineno-33-331" href="#__codelineno-33-331"></a>    <span class="c1"># dateList = pd.date_range(date(2020,7,1),date.today()-timedelta(days=1),freq=&#39;d&#39;)</span>
<a id="__codelineno-33-332" name="__codelineno-33-332" href="#__codelineno-33-332"></a>    <span class="c1"># for dte in dateList:</span>
<a id="__codelineno-33-333" name="__codelineno-33-333" href="#__codelineno-33-333"></a>    <span class="c1">#     dte = dte.date()</span>
<a id="__codelineno-33-334" name="__codelineno-33-334" href="#__codelineno-33-334"></a>    <span class="c1">#     print(dte)</span>
<a id="__codelineno-33-335" name="__codelineno-33-335" href="#__codelineno-33-335"></a>    <span class="c1">#     races = scrapeThoroughbredBfDate(dte)</span>
<a id="__codelineno-33-336" name="__codelineno-33-336" href="#__codelineno-33-336"></a>    <span class="c1">#     dataList.append(races)</span>
<a id="__codelineno-33-337" name="__codelineno-33-337" href="#__codelineno-33-337"></a>    <span class="c1"># data = pd.concat(dataList)</span>
<a id="__codelineno-33-338" name="__codelineno-33-338" href="#__codelineno-33-338"></a>    <span class="c1"># data.to_csv(&quot;[LOCAL PATH SOMEWHERE]&quot;, index=False)</span>
<a id="__codelineno-33-339" name="__codelineno-33-339" href="#__codelineno-33-339"></a>
<a id="__codelineno-33-340" name="__codelineno-33-340" href="#__codelineno-33-340"></a>
<a id="__codelineno-33-341" name="__codelineno-33-341" href="#__codelineno-33-341"></a><span class="c1"># Description:</span>
<a id="__codelineno-33-342" name="__codelineno-33-342" href="#__codelineno-33-342"></a><span class="c1">#   Will loop through a set of stream data archive files and extract a few key pricing measures for each selection</span>
<a id="__codelineno-33-343" name="__codelineno-33-343" href="#__codelineno-33-343"></a><span class="c1"># Estimated Time:</span>
<a id="__codelineno-33-344" name="__codelineno-33-344" href="#__codelineno-33-344"></a><span class="c1">#   ~6 hours</span>
<a id="__codelineno-33-345" name="__codelineno-33-345" href="#__codelineno-33-345"></a><span class="c1">#</span>
<a id="__codelineno-33-346" name="__codelineno-33-346" href="#__codelineno-33-346"></a><span class="c1"># trading = betfairlightweight.APIClient(&quot;username&quot;, &quot;password&quot;)</span>
<a id="__codelineno-33-347" name="__codelineno-33-347" href="#__codelineno-33-347"></a><span class="c1"># listener = StreamListener(max_latency=None)</span>
<a id="__codelineno-33-348" name="__codelineno-33-348" href="#__codelineno-33-348"></a><span class="c1"># stream_files = glob.glob(&quot;[PATH TO LOCAL FOLDER STORING ARCHIVE FILES]*.tar&quot;)</span>
<a id="__codelineno-33-349" name="__codelineno-33-349" href="#__codelineno-33-349"></a><span class="c1"># output_file = &quot;[SOME OUTPUT DIRECTORY]/thoroughbred-odds-2021.csv&quot;</span>
<a id="__codelineno-33-350" name="__codelineno-33-350" href="#__codelineno-33-350"></a><span class="c1"># if __name__ == &#39;__main__&#39;:</span>
<a id="__codelineno-33-351" name="__codelineno-33-351" href="#__codelineno-33-351"></a><span class="c1">#     parse_stream(stream_files, output_file)</span>
<a id="__codelineno-33-352" name="__codelineno-33-352" href="#__codelineno-33-352"></a>
<a id="__codelineno-33-353" name="__codelineno-33-353" href="#__codelineno-33-353"></a>
<a id="__codelineno-33-354" name="__codelineno-33-354" href="#__codelineno-33-354"></a><span class="c1"># Analysis</span>
<a id="__codelineno-33-355" name="__codelineno-33-355" href="#__codelineno-33-355"></a><span class="c1"># _________________________________</span>
<a id="__codelineno-33-356" name="__codelineno-33-356" href="#__codelineno-33-356"></a>
<a id="__codelineno-33-357" name="__codelineno-33-357" href="#__codelineno-33-357"></a>
<a id="__codelineno-33-358" name="__codelineno-33-358" href="#__codelineno-33-358"></a><span class="c1"># Functions ++++++++</span>
<a id="__codelineno-33-359" name="__codelineno-33-359" href="#__codelineno-33-359"></a>
<a id="__codelineno-33-360" name="__codelineno-33-360" href="#__codelineno-33-360"></a><span class="k">def</span> <span class="nf">bet_eval_metrics</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">side</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-33-361" name="__codelineno-33-361" href="#__codelineno-33-361"></a>
<a id="__codelineno-33-362" name="__codelineno-33-362" href="#__codelineno-33-362"></a>    <span class="n">metrics</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">d</span>
<a id="__codelineno-33-363" name="__codelineno-33-363" href="#__codelineno-33-363"></a>    <span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s2">&quot;npl&quot;</span><span class="p">:</span> <span class="s2">&quot;sum&quot;</span><span class="p">,</span> <span class="s2">&quot;stake&quot;</span><span class="p">:</span> <span class="s2">&quot;sum&quot;</span><span class="p">,</span> <span class="s2">&quot;win&quot;</span><span class="p">:</span> <span class="s2">&quot;mean&quot;</span><span class="p">})</span>
<a id="__codelineno-33-364" name="__codelineno-33-364" href="#__codelineno-33-364"></a>    <span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">pot</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;npl&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;stake&#39;</span><span class="p">])</span>
<a id="__codelineno-33-365" name="__codelineno-33-365" href="#__codelineno-33-365"></a>
<a id="__codelineno-33-366" name="__codelineno-33-366" href="#__codelineno-33-366"></a>    <span class="k">return</span><span class="p">(</span><span class="n">metrics</span><span class="p">[</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;stake&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">])</span>
<a id="__codelineno-33-367" name="__codelineno-33-367" href="#__codelineno-33-367"></a>
<a id="__codelineno-33-368" name="__codelineno-33-368" href="#__codelineno-33-368"></a><span class="k">def</span> <span class="nf">pl_pValue</span><span class="p">(</span><span class="n">number_bets</span><span class="p">,</span> <span class="n">npl</span><span class="p">,</span> <span class="n">stake</span><span class="p">,</span> <span class="n">average_odds</span><span class="p">):</span>
<a id="__codelineno-33-369" name="__codelineno-33-369" href="#__codelineno-33-369"></a>
<a id="__codelineno-33-370" name="__codelineno-33-370" href="#__codelineno-33-370"></a>    <span class="n">pot</span> <span class="o">=</span> <span class="n">npl</span> <span class="o">/</span> <span class="n">stake</span>
<a id="__codelineno-33-371" name="__codelineno-33-371" href="#__codelineno-33-371"></a>
<a id="__codelineno-33-372" name="__codelineno-33-372" href="#__codelineno-33-372"></a>    <span class="n">tStatistic</span> <span class="o">=</span> <span class="p">(</span><span class="n">pot</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">number_bets</span><span class="p">))</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">pot</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">average_odds</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">pot</span><span class="p">)</span> <span class="p">)</span>
<a id="__codelineno-33-373" name="__codelineno-33-373" href="#__codelineno-33-373"></a>
<a id="__codelineno-33-374" name="__codelineno-33-374" href="#__codelineno-33-374"></a>    <span class="n">pValue</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">t</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="o">-</span><span class="nb">abs</span><span class="p">(</span><span class="n">tStatistic</span><span class="p">),</span> <span class="n">number_bets</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-33-375" name="__codelineno-33-375" href="#__codelineno-33-375"></a>
<a id="__codelineno-33-376" name="__codelineno-33-376" href="#__codelineno-33-376"></a>    <span class="k">return</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">pValue</span><span class="p">),</span> <span class="n">pValue</span> <span class="o">==</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">pValue</span><span class="p">))</span>
<a id="__codelineno-33-377" name="__codelineno-33-377" href="#__codelineno-33-377"></a>
<a id="__codelineno-33-378" name="__codelineno-33-378" href="#__codelineno-33-378"></a><span class="k">def</span> <span class="nf">distance_group</span><span class="p">(</span><span class="n">distance</span><span class="p">):</span>
<a id="__codelineno-33-379" name="__codelineno-33-379" href="#__codelineno-33-379"></a>
<a id="__codelineno-33-380" name="__codelineno-33-380" href="#__codelineno-33-380"></a>    <span class="k">if</span> <span class="n">distance</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-33-381" name="__codelineno-33-381" href="#__codelineno-33-381"></a>        <span class="k">return</span><span class="p">(</span><span class="s2">&quot;missing&quot;</span><span class="p">)</span>
<a id="__codelineno-33-382" name="__codelineno-33-382" href="#__codelineno-33-382"></a>    <span class="k">elif</span> <span class="n">distance</span> <span class="o">&lt;</span> <span class="mi">1100</span><span class="p">:</span>
<a id="__codelineno-33-383" name="__codelineno-33-383" href="#__codelineno-33-383"></a>        <span class="k">return</span><span class="p">(</span><span class="s2">&quot;sprint&quot;</span><span class="p">)</span>
<a id="__codelineno-33-384" name="__codelineno-33-384" href="#__codelineno-33-384"></a>    <span class="k">elif</span> <span class="n">distance</span> <span class="o">&lt;</span> <span class="mi">1400</span><span class="p">:</span>
<a id="__codelineno-33-385" name="__codelineno-33-385" href="#__codelineno-33-385"></a>        <span class="k">return</span><span class="p">(</span><span class="s2">&quot;mid_short&quot;</span><span class="p">)</span>
<a id="__codelineno-33-386" name="__codelineno-33-386" href="#__codelineno-33-386"></a>    <span class="k">elif</span> <span class="n">distance</span> <span class="o">&lt;</span> <span class="mi">1800</span><span class="p">:</span>
<a id="__codelineno-33-387" name="__codelineno-33-387" href="#__codelineno-33-387"></a>        <span class="k">return</span><span class="p">(</span><span class="s2">&quot;mid_long&quot;</span><span class="p">)</span>
<a id="__codelineno-33-388" name="__codelineno-33-388" href="#__codelineno-33-388"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-33-389" name="__codelineno-33-389" href="#__codelineno-33-389"></a>        <span class="k">return</span><span class="p">(</span><span class="s2">&quot;long&quot;</span><span class="p">)</span>
<a id="__codelineno-33-390" name="__codelineno-33-390" href="#__codelineno-33-390"></a>
<a id="__codelineno-33-391" name="__codelineno-33-391" href="#__codelineno-33-391"></a><span class="k">def</span> <span class="nf">barrier_group</span><span class="p">(</span><span class="n">barrier</span><span class="p">):</span>
<a id="__codelineno-33-392" name="__codelineno-33-392" href="#__codelineno-33-392"></a>    <span class="k">if</span> <span class="n">barrier</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-33-393" name="__codelineno-33-393" href="#__codelineno-33-393"></a>        <span class="k">return</span><span class="p">(</span><span class="s2">&quot;missing&quot;</span><span class="p">)</span>
<a id="__codelineno-33-394" name="__codelineno-33-394" href="#__codelineno-33-394"></a>    <span class="k">elif</span> <span class="n">barrier</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
<a id="__codelineno-33-395" name="__codelineno-33-395" href="#__codelineno-33-395"></a>        <span class="k">return</span><span class="p">(</span><span class="s2">&quot;inside&quot;</span><span class="p">)</span>
<a id="__codelineno-33-396" name="__codelineno-33-396" href="#__codelineno-33-396"></a>    <span class="k">elif</span> <span class="n">barrier</span> <span class="o">&lt;</span> <span class="mi">9</span><span class="p">:</span>
<a id="__codelineno-33-397" name="__codelineno-33-397" href="#__codelineno-33-397"></a>        <span class="k">return</span><span class="p">(</span><span class="s2">&quot;mid_field&quot;</span><span class="p">)</span>
<a id="__codelineno-33-398" name="__codelineno-33-398" href="#__codelineno-33-398"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-33-399" name="__codelineno-33-399" href="#__codelineno-33-399"></a>        <span class="k">return</span><span class="p">(</span><span class="s2">&quot;outside&quot;</span><span class="p">)</span>
<a id="__codelineno-33-400" name="__codelineno-33-400" href="#__codelineno-33-400"></a>
<a id="__codelineno-33-401" name="__codelineno-33-401" href="#__codelineno-33-401"></a><span class="c1"># Analysis ++++++++</span>
<a id="__codelineno-33-402" name="__codelineno-33-402" href="#__codelineno-33-402"></a>
<a id="__codelineno-33-403" name="__codelineno-33-403" href="#__codelineno-33-403"></a><span class="c1"># Local Paths (will be different on your machine)</span>
<a id="__codelineno-33-404" name="__codelineno-33-404" href="#__codelineno-33-404"></a><span class="n">path_odds_local</span> <span class="o">=</span> <span class="s2">&quot;[PATH TO YOUR LOCAL FILES]/thoroughbred-odds-2021.csv&quot;</span>
<a id="__codelineno-33-405" name="__codelineno-33-405" href="#__codelineno-33-405"></a><span class="n">path_race_local</span> <span class="o">=</span> <span class="s2">&quot;[PATH TO YOUR LOCAL FILES]/thoroughbred-race-data.csv&quot;</span>
<a id="__codelineno-33-406" name="__codelineno-33-406" href="#__codelineno-33-406"></a>
<a id="__codelineno-33-407" name="__codelineno-33-407" href="#__codelineno-33-407"></a><span class="n">odds</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path_odds_local</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;market_id&#39;</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="s1">&#39;selection_id&#39;</span><span class="p">:</span> <span class="nb">object</span><span class="p">})</span>
<a id="__codelineno-33-408" name="__codelineno-33-408" href="#__codelineno-33-408"></a><span class="n">race</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path_race_local</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;market_id&#39;</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="s1">&#39;selection_id&#39;</span><span class="p">:</span> <span class="nb">object</span><span class="p">})</span>
<a id="__codelineno-33-409" name="__codelineno-33-409" href="#__codelineno-33-409"></a>
<a id="__codelineno-33-410" name="__codelineno-33-410" href="#__codelineno-33-410"></a><span class="c1"># Joining two datasets</span>
<a id="__codelineno-33-411" name="__codelineno-33-411" href="#__codelineno-33-411"></a><span class="n">df</span> <span class="o">=</span> <span class="n">race</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">odds</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">odds</span><span class="o">.</span><span class="n">columns</span> <span class="o">!=</span> <span class="s1">&#39;selection_name&#39;</span><span class="p">],</span> <span class="n">how</span> <span class="o">=</span> <span class="s2">&quot;inner&quot;</span><span class="p">,</span> <span class="n">on</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;market_id&#39;</span><span class="p">,</span> <span class="s1">&#39;selection_id&#39;</span><span class="p">])</span>
<a id="__codelineno-33-412" name="__codelineno-33-412" href="#__codelineno-33-412"></a>
<a id="__codelineno-33-413" name="__codelineno-33-413" href="#__codelineno-33-413"></a><span class="c1"># I&#39;ll also add columns for the net profit from backing and laying each selection to be picked up in subsequent sections</span>
<a id="__codelineno-33-414" name="__codelineno-33-414" href="#__codelineno-33-414"></a><span class="n">df</span><span class="p">[</span><span class="s1">&#39;back_npl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;place&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.95</span> <span class="o">*</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;bsp&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-33-415" name="__codelineno-33-415" href="#__codelineno-33-415"></a><span class="n">df</span><span class="p">[</span><span class="s1">&#39;lay_npl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;place&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;bsp&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="mf">0.95</span><span class="p">)</span>
<a id="__codelineno-33-416" name="__codelineno-33-416" href="#__codelineno-33-416"></a>
<a id="__codelineno-33-417" name="__codelineno-33-417" href="#__codelineno-33-417"></a><span class="c1"># Adding Variable Chunks</span>
<a id="__codelineno-33-418" name="__codelineno-33-418" href="#__codelineno-33-418"></a><span class="n">df</span><span class="p">[</span><span class="s1">&#39;distance_group&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">race_distance</span><span class="p">,</span> <span class="n">errors</span> <span class="o">=</span> <span class="s2">&quot;coerce&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">distance_group</span><span class="p">)</span>
<a id="__codelineno-33-419" name="__codelineno-33-419" href="#__codelineno-33-419"></a><span class="n">df</span><span class="p">[</span><span class="s1">&#39;barrier_group&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">barrier</span><span class="p">,</span> <span class="n">errors</span> <span class="o">=</span> <span class="s2">&quot;coerce&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">barrier_group</span><span class="p">)</span>
<a id="__codelineno-33-420" name="__codelineno-33-420" href="#__codelineno-33-420"></a>
<a id="__codelineno-33-421" name="__codelineno-33-421" href="#__codelineno-33-421"></a><span class="c1"># Data Partitioning</span>
<a id="__codelineno-33-422" name="__codelineno-33-422" href="#__codelineno-33-422"></a><span class="n">dfTrain</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;date &lt; &quot;2021-04-01&quot;&#39;</span><span class="p">)</span>
<a id="__codelineno-33-423" name="__codelineno-33-423" href="#__codelineno-33-423"></a><span class="n">dfTest</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;date &gt;= &quot;2021-04-01&quot;&#39;</span><span class="p">)</span>
<a id="__codelineno-33-424" name="__codelineno-33-424" href="#__codelineno-33-424"></a>
<a id="__codelineno-33-425" name="__codelineno-33-425" href="#__codelineno-33-425"></a><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> rows in the &quot;training&quot; set and </span><span class="si">{}</span><span class="s1"> rows in the &quot;test&quot; data&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dfTrain</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dfTest</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<a id="__codelineno-33-426" name="__codelineno-33-426" href="#__codelineno-33-426"></a>
<a id="__codelineno-33-427" name="__codelineno-33-427" href="#__codelineno-33-427"></a><span class="c1"># Angle 1 ++++++++++++++++++++++++++++++++++++++++++++++</span>
<a id="__codelineno-33-428" name="__codelineno-33-428" href="#__codelineno-33-428"></a>
<a id="__codelineno-33-429" name="__codelineno-33-429" href="#__codelineno-33-429"></a><span class="p">(</span>
<a id="__codelineno-33-430" name="__codelineno-33-430" href="#__codelineno-33-430"></a>    <span class="n">dfTrain</span>
<a id="__codelineno-33-431" name="__codelineno-33-431" href="#__codelineno-33-431"></a>    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">stake</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-33-432" name="__codelineno-33-432" href="#__codelineno-33-432"></a>    <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;selection_name&#39;</span><span class="p">,</span> <span class="n">as_index</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-33-433" name="__codelineno-33-433" href="#__codelineno-33-433"></a>    <span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s1">&#39;back_npl&#39;</span><span class="p">:</span> <span class="s1">&#39;sum&#39;</span><span class="p">,</span> <span class="s1">&#39;stake&#39;</span><span class="p">:</span> <span class="s1">&#39;sum&#39;</span><span class="p">})</span>
<a id="__codelineno-33-434" name="__codelineno-33-434" href="#__codelineno-33-434"></a>    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">pot</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;back_npl&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;stake&#39;</span><span class="p">])</span>
<a id="__codelineno-33-435" name="__codelineno-33-435" href="#__codelineno-33-435"></a>    <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;pot&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  
<a id="__codelineno-33-436" name="__codelineno-33-436" href="#__codelineno-33-436"></a>    <span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> 
<a id="__codelineno-33-437" name="__codelineno-33-437" href="#__codelineno-33-437"></a><span class="p">)</span>
<a id="__codelineno-33-438" name="__codelineno-33-438" href="#__codelineno-33-438"></a>
<a id="__codelineno-33-439" name="__codelineno-33-439" href="#__codelineno-33-439"></a><span class="c1"># Calculate the profit (back and lay) and average odds across all track / distance / barrier group combos</span>
<a id="__codelineno-33-440" name="__codelineno-33-440" href="#__codelineno-33-440"></a><span class="n">trackDistanceBarrier</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-33-441" name="__codelineno-33-441" href="#__codelineno-33-441"></a>    <span class="n">dfTrain</span>
<a id="__codelineno-33-442" name="__codelineno-33-442" href="#__codelineno-33-442"></a>    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">stake</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-33-443" name="__codelineno-33-443" href="#__codelineno-33-443"></a>    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">odds</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;bsp&#39;</span><span class="p">])</span>
<a id="__codelineno-33-444" name="__codelineno-33-444" href="#__codelineno-33-444"></a>    <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;track&#39;</span><span class="p">,</span> <span class="s1">&#39;race_distance&#39;</span><span class="p">,</span> <span class="s1">&#39;barrier_group&#39;</span><span class="p">],</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-33-445" name="__codelineno-33-445" href="#__codelineno-33-445"></a>    <span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s1">&#39;back_npl&#39;</span><span class="p">:</span> <span class="s1">&#39;sum&#39;</span><span class="p">,</span> <span class="s1">&#39;lay_npl&#39;</span><span class="p">:</span> <span class="s1">&#39;sum&#39;</span><span class="p">,</span><span class="s1">&#39;stake&#39;</span><span class="p">:</span> <span class="s1">&#39;sum&#39;</span><span class="p">,</span> <span class="s1">&#39;odds&#39;</span><span class="p">:</span> <span class="s1">&#39;mean&#39;</span><span class="p">})</span>
<a id="__codelineno-33-446" name="__codelineno-33-446" href="#__codelineno-33-446"></a><span class="p">)</span>
<a id="__codelineno-33-447" name="__codelineno-33-447" href="#__codelineno-33-447"></a>
<a id="__codelineno-33-448" name="__codelineno-33-448" href="#__codelineno-33-448"></a><span class="n">trackDistanceBarrier</span>
<a id="__codelineno-33-449" name="__codelineno-33-449" href="#__codelineno-33-449"></a>
<a id="__codelineno-33-450" name="__codelineno-33-450" href="#__codelineno-33-450"></a><span class="n">trackDistanceBarrier</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-33-451" name="__codelineno-33-451" href="#__codelineno-33-451"></a>    <span class="n">trackDistanceBarrier</span>
<a id="__codelineno-33-452" name="__codelineno-33-452" href="#__codelineno-33-452"></a>    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">backPL_pValue</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">pl_pValue</span><span class="p">(</span><span class="n">number_bets</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;stake&#39;</span><span class="p">],</span> <span class="n">npl</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;back_npl&#39;</span><span class="p">],</span> <span class="n">stake</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;stake&#39;</span><span class="p">],</span> <span class="n">average_odds</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;odds&#39;</span><span class="p">]))</span>
<a id="__codelineno-33-453" name="__codelineno-33-453" href="#__codelineno-33-453"></a>    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">layPL_pValue</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">pl_pValue</span><span class="p">(</span><span class="n">number_bets</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;stake&#39;</span><span class="p">],</span> <span class="n">npl</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;lay_npl&#39;</span><span class="p">],</span> <span class="n">stake</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;stake&#39;</span><span class="p">],</span> <span class="n">average_odds</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;odds&#39;</span><span class="p">]))</span>
<a id="__codelineno-33-454" name="__codelineno-33-454" href="#__codelineno-33-454"></a><span class="p">)</span>
<a id="__codelineno-33-455" name="__codelineno-33-455" href="#__codelineno-33-455"></a>
<a id="__codelineno-33-456" name="__codelineno-33-456" href="#__codelineno-33-456"></a><span class="n">trackDistanceBarrier</span>
<a id="__codelineno-33-457" name="__codelineno-33-457" href="#__codelineno-33-457"></a>
<a id="__codelineno-33-458" name="__codelineno-33-458" href="#__codelineno-33-458"></a><span class="c1"># Top 5 lay combos Track | Distance | Barrier (TDB)</span>
<a id="__codelineno-33-459" name="__codelineno-33-459" href="#__codelineno-33-459"></a><span class="n">TDB_bestLay</span> <span class="o">=</span> <span class="n">trackDistanceBarrier</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;lay_npl&gt;0&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;layPL_pValue&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<a id="__codelineno-33-460" name="__codelineno-33-460" href="#__codelineno-33-460"></a><span class="n">TDB_bestLay</span>
<a id="__codelineno-33-461" name="__codelineno-33-461" href="#__codelineno-33-461"></a>
<a id="__codelineno-33-462" name="__codelineno-33-462" href="#__codelineno-33-462"></a><span class="c1"># First let&#39;s test laying on the train set (by definition we know these will be profitable)</span>
<a id="__codelineno-33-463" name="__codelineno-33-463" href="#__codelineno-33-463"></a><span class="n">train_TDB_bestLay</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-33-464" name="__codelineno-33-464" href="#__codelineno-33-464"></a>    <span class="n">dfTrain</span>
<a id="__codelineno-33-465" name="__codelineno-33-465" href="#__codelineno-33-465"></a>    <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">TDB_bestLay</span><span class="p">[[</span><span class="s1">&#39;track&#39;</span><span class="p">,</span> <span class="s1">&#39;race_distance&#39;</span><span class="p">]])</span>
<a id="__codelineno-33-466" name="__codelineno-33-466" href="#__codelineno-33-466"></a>    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">npl</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;lay_npl&#39;</span><span class="p">])</span>
<a id="__codelineno-33-467" name="__codelineno-33-467" href="#__codelineno-33-467"></a>    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">stake</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-33-468" name="__codelineno-33-468" href="#__codelineno-33-468"></a>    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">win</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;lay_npl&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
<a id="__codelineno-33-469" name="__codelineno-33-469" href="#__codelineno-33-469"></a><span class="p">)</span>
<a id="__codelineno-33-470" name="__codelineno-33-470" href="#__codelineno-33-470"></a>
<a id="__codelineno-33-471" name="__codelineno-33-471" href="#__codelineno-33-471"></a><span class="c1"># This is the key test (non of the races has been part of analysis to this point)</span>
<a id="__codelineno-33-472" name="__codelineno-33-472" href="#__codelineno-33-472"></a><span class="n">test_TDB_bestLay</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-33-473" name="__codelineno-33-473" href="#__codelineno-33-473"></a>    <span class="n">dfTest</span>
<a id="__codelineno-33-474" name="__codelineno-33-474" href="#__codelineno-33-474"></a>    <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">TDB_bestLay</span><span class="p">[[</span><span class="s1">&#39;track&#39;</span><span class="p">,</span> <span class="s1">&#39;race_distance&#39;</span><span class="p">]])</span>
<a id="__codelineno-33-475" name="__codelineno-33-475" href="#__codelineno-33-475"></a>    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">npl</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;lay_npl&#39;</span><span class="p">])</span>
<a id="__codelineno-33-476" name="__codelineno-33-476" href="#__codelineno-33-476"></a>    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">stake</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-33-477" name="__codelineno-33-477" href="#__codelineno-33-477"></a>    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">win</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;lay_npl&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
<a id="__codelineno-33-478" name="__codelineno-33-478" href="#__codelineno-33-478"></a><span class="p">)</span>
<a id="__codelineno-33-479" name="__codelineno-33-479" href="#__codelineno-33-479"></a>
<a id="__codelineno-33-480" name="__codelineno-33-480" href="#__codelineno-33-480"></a><span class="c1"># Peaking at the bets in the test set</span>
<a id="__codelineno-33-481" name="__codelineno-33-481" href="#__codelineno-33-481"></a><span class="n">test_TDB_bestLay</span><span class="p">[[</span><span class="s1">&#39;track&#39;</span><span class="p">,</span> <span class="s1">&#39;race_distance&#39;</span><span class="p">,</span> <span class="s1">&#39;barrier&#39;</span><span class="p">,</span> <span class="s1">&#39;barrier_group&#39;</span><span class="p">,</span> <span class="s1">&#39;bsp&#39;</span><span class="p">,</span> <span class="s1">&#39;lay_npl&#39;</span><span class="p">,</span> <span class="s1">&#39;win&#39;</span><span class="p">,</span> <span class="s1">&#39;stake&#39;</span><span class="p">]]</span>
<a id="__codelineno-33-482" name="__codelineno-33-482" href="#__codelineno-33-482"></a>
<a id="__codelineno-33-483" name="__codelineno-33-483" href="#__codelineno-33-483"></a><span class="c1"># Let&#39;s run our evaluation on the training set</span>
<a id="__codelineno-33-484" name="__codelineno-33-484" href="#__codelineno-33-484"></a><span class="n">bet_eval_metrics</span><span class="p">(</span><span class="n">train_TDB_bestLay</span><span class="p">)</span>
<a id="__codelineno-33-485" name="__codelineno-33-485" href="#__codelineno-33-485"></a>
<a id="__codelineno-33-486" name="__codelineno-33-486" href="#__codelineno-33-486"></a><span class="c1"># And on the test set</span>
<a id="__codelineno-33-487" name="__codelineno-33-487" href="#__codelineno-33-487"></a><span class="n">bet_eval_metrics</span><span class="p">(</span><span class="n">test_TDB_bestLay</span><span class="p">)</span>
<a id="__codelineno-33-488" name="__codelineno-33-488" href="#__codelineno-33-488"></a>
<a id="__codelineno-33-489" name="__codelineno-33-489" href="#__codelineno-33-489"></a><span class="c1"># Angle 2 ++++++++++++++++++++++++++++++++++++++++++++++</span>
<a id="__codelineno-33-490" name="__codelineno-33-490" href="#__codelineno-33-490"></a>
<a id="__codelineno-33-491" name="__codelineno-33-491" href="#__codelineno-33-491"></a><span class="p">(</span>
<a id="__codelineno-33-492" name="__codelineno-33-492" href="#__codelineno-33-492"></a>    <span class="n">dfTrain</span>
<a id="__codelineno-33-493" name="__codelineno-33-493" href="#__codelineno-33-493"></a>    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">market_support</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;wap_5m&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;wap_30s&#39;</span><span class="p">])</span>
<a id="__codelineno-33-494" name="__codelineno-33-494" href="#__codelineno-33-494"></a>    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">races</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-33-495" name="__codelineno-33-495" href="#__codelineno-33-495"></a>    <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;jockey&#39;</span><span class="p">)</span>
<a id="__codelineno-33-496" name="__codelineno-33-496" href="#__codelineno-33-496"></a>    <span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s1">&#39;market_support&#39;</span><span class="p">:</span> <span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;races&#39;</span><span class="p">:</span> <span class="s1">&#39;count&#39;</span><span class="p">})</span>
<a id="__codelineno-33-497" name="__codelineno-33-497" href="#__codelineno-33-497"></a>    <span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;races &gt; 10&#39;</span><span class="p">)</span>
<a id="__codelineno-33-498" name="__codelineno-33-498" href="#__codelineno-33-498"></a>    <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;market_support&#39;</span><span class="p">,</span> <span class="n">ascending</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-33-499" name="__codelineno-33-499" href="#__codelineno-33-499"></a>    <span class="o">.</span><span class="n">head</span><span class="p">()</span>
<a id="__codelineno-33-500" name="__codelineno-33-500" href="#__codelineno-33-500"></a><span class="p">)</span>
<a id="__codelineno-33-501" name="__codelineno-33-501" href="#__codelineno-33-501"></a>
<a id="__codelineno-33-502" name="__codelineno-33-502" href="#__codelineno-33-502"></a><span class="c1"># Group By Jockey and Market Support</span>
<a id="__codelineno-33-503" name="__codelineno-33-503" href="#__codelineno-33-503"></a><span class="n">jockeys</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-33-504" name="__codelineno-33-504" href="#__codelineno-33-504"></a>    <span class="n">dfTrain</span>
<a id="__codelineno-33-505" name="__codelineno-33-505" href="#__codelineno-33-505"></a>    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">stake</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-33-506" name="__codelineno-33-506" href="#__codelineno-33-506"></a>    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">odds</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;bsp&#39;</span><span class="p">])</span>
<a id="__codelineno-33-507" name="__codelineno-33-507" href="#__codelineno-33-507"></a>    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">npl</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;place&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.95</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;odds&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
<a id="__codelineno-33-508" name="__codelineno-33-508" href="#__codelineno-33-508"></a>    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">market_support</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;wap_5m&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;wap_30s&#39;</span><span class="p">],</span> <span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="s2">&quot;N&quot;</span><span class="p">))</span>
<a id="__codelineno-33-509" name="__codelineno-33-509" href="#__codelineno-33-509"></a>    <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;jockey&#39;</span><span class="p">,</span> <span class="s1">&#39;market_support&#39;</span><span class="p">],</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-33-510" name="__codelineno-33-510" href="#__codelineno-33-510"></a>    <span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s1">&#39;odds&#39;</span><span class="p">:</span> <span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;stake&#39;</span><span class="p">:</span> <span class="s1">&#39;sum&#39;</span><span class="p">,</span> <span class="s1">&#39;npl&#39;</span><span class="p">:</span> <span class="s1">&#39;sum&#39;</span><span class="p">})</span>
<a id="__codelineno-33-511" name="__codelineno-33-511" href="#__codelineno-33-511"></a>    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">pValue</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">pl_pValue</span><span class="p">(</span><span class="n">number_bets</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;stake&#39;</span><span class="p">],</span> <span class="n">npl</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;npl&#39;</span><span class="p">],</span> <span class="n">stake</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;stake&#39;</span><span class="p">],</span> <span class="n">average_odds</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;odds&#39;</span><span class="p">]))</span>
<a id="__codelineno-33-512" name="__codelineno-33-512" href="#__codelineno-33-512"></a><span class="p">)</span>
<a id="__codelineno-33-513" name="__codelineno-33-513" href="#__codelineno-33-513"></a>
<a id="__codelineno-33-514" name="__codelineno-33-514" href="#__codelineno-33-514"></a><span class="n">jockeys</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;pValue&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;npl &gt; 0&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<a id="__codelineno-33-515" name="__codelineno-33-515" href="#__codelineno-33-515"></a>
<a id="__codelineno-33-516" name="__codelineno-33-516" href="#__codelineno-33-516"></a><span class="c1"># First evaluate on our training set</span>
<a id="__codelineno-33-517" name="__codelineno-33-517" href="#__codelineno-33-517"></a><span class="n">train_jockeyMarket</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-33-518" name="__codelineno-33-518" href="#__codelineno-33-518"></a>    <span class="n">dfTrain</span>
<a id="__codelineno-33-519" name="__codelineno-33-519" href="#__codelineno-33-519"></a>    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">market_support</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;wap_5m&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;wap_30s&#39;</span><span class="p">],</span> <span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="s2">&quot;N&quot;</span><span class="p">))</span>
<a id="__codelineno-33-520" name="__codelineno-33-520" href="#__codelineno-33-520"></a>    <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">jockeys</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;pValue&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;npl &gt; 0&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)[[</span><span class="s1">&#39;jockey&#39;</span><span class="p">,</span> <span class="s1">&#39;market_support&#39;</span><span class="p">]])</span>
<a id="__codelineno-33-521" name="__codelineno-33-521" href="#__codelineno-33-521"></a>    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">stake</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-33-522" name="__codelineno-33-522" href="#__codelineno-33-522"></a>    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">odds</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;bsp&#39;</span><span class="p">])</span>
<a id="__codelineno-33-523" name="__codelineno-33-523" href="#__codelineno-33-523"></a>    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">npl</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;place&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.95</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;odds&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
<a id="__codelineno-33-524" name="__codelineno-33-524" href="#__codelineno-33-524"></a>    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">win</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;npl&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
<a id="__codelineno-33-525" name="__codelineno-33-525" href="#__codelineno-33-525"></a><span class="p">)</span>
<a id="__codelineno-33-526" name="__codelineno-33-526" href="#__codelineno-33-526"></a>
<a id="__codelineno-33-527" name="__codelineno-33-527" href="#__codelineno-33-527"></a><span class="c1"># And on the test set</span>
<a id="__codelineno-33-528" name="__codelineno-33-528" href="#__codelineno-33-528"></a><span class="n">test_jockeyMarket</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-33-529" name="__codelineno-33-529" href="#__codelineno-33-529"></a>    <span class="n">dfTest</span>
<a id="__codelineno-33-530" name="__codelineno-33-530" href="#__codelineno-33-530"></a>    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">market_support</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;wap_5m&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;wap_30s&#39;</span><span class="p">],</span> <span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="s2">&quot;N&quot;</span><span class="p">))</span>
<a id="__codelineno-33-531" name="__codelineno-33-531" href="#__codelineno-33-531"></a>    <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">jockeys</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;pValue&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;npl &gt; 0&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)[[</span><span class="s1">&#39;jockey&#39;</span><span class="p">,</span> <span class="s1">&#39;market_support&#39;</span><span class="p">]])</span>
<a id="__codelineno-33-532" name="__codelineno-33-532" href="#__codelineno-33-532"></a>    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">stake</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-33-533" name="__codelineno-33-533" href="#__codelineno-33-533"></a>    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">odds</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;bsp&#39;</span><span class="p">])</span>
<a id="__codelineno-33-534" name="__codelineno-33-534" href="#__codelineno-33-534"></a>    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">npl</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;place&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.95</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;odds&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
<a id="__codelineno-33-535" name="__codelineno-33-535" href="#__codelineno-33-535"></a>    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">win</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;npl&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
<a id="__codelineno-33-536" name="__codelineno-33-536" href="#__codelineno-33-536"></a><span class="p">)</span>
<a id="__codelineno-33-537" name="__codelineno-33-537" href="#__codelineno-33-537"></a>
<a id="__codelineno-33-538" name="__codelineno-33-538" href="#__codelineno-33-538"></a><span class="n">bet_eval_metrics</span><span class="p">(</span><span class="n">train_jockeyMarket</span><span class="p">)</span>
<a id="__codelineno-33-539" name="__codelineno-33-539" href="#__codelineno-33-539"></a>
<a id="__codelineno-33-540" name="__codelineno-33-540" href="#__codelineno-33-540"></a><span class="n">bet_eval_metrics</span><span class="p">(</span><span class="n">test_jockeyMarket</span><span class="p">)</span>
<a id="__codelineno-33-541" name="__codelineno-33-541" href="#__codelineno-33-541"></a>
<a id="__codelineno-33-542" name="__codelineno-33-542" href="#__codelineno-33-542"></a><span class="c1"># Angle 3 ++++++++++++++++++++++++++++++++++++++++++++++</span>
<a id="__codelineno-33-543" name="__codelineno-33-543" href="#__codelineno-33-543"></a>
<a id="__codelineno-33-544" name="__codelineno-33-544" href="#__codelineno-33-544"></a>
<a id="__codelineno-33-545" name="__codelineno-33-545" href="#__codelineno-33-545"></a><span class="c1"># First Investigate The Average Inplay Minimums And Loss Rates of Certain Jockeys</span>
<a id="__codelineno-33-546" name="__codelineno-33-546" href="#__codelineno-33-546"></a><span class="n">tradeOutIndex</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-33-547" name="__codelineno-33-547" href="#__codelineno-33-547"></a>    <span class="n">dfTrain</span>
<a id="__codelineno-33-548" name="__codelineno-33-548" href="#__codelineno-33-548"></a>    <span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;distance_group in [&quot;long&quot;, &quot;mid_long&quot;]&#39;</span><span class="p">)</span>
<a id="__codelineno-33-549" name="__codelineno-33-549" href="#__codelineno-33-549"></a>    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">inplay_odds_ratio</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;inplay_min_lay&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;bsp&#39;</span><span class="p">])</span>
<a id="__codelineno-33-550" name="__codelineno-33-550" href="#__codelineno-33-550"></a>    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">win</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;place&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
<a id="__codelineno-33-551" name="__codelineno-33-551" href="#__codelineno-33-551"></a>    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">races</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-33-552" name="__codelineno-33-552" href="#__codelineno-33-552"></a>    <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;jockey&#39;</span><span class="p">],</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-33-553" name="__codelineno-33-553" href="#__codelineno-33-553"></a>    <span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s1">&#39;inplay_odds_ratio&#39;</span><span class="p">:</span> <span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;win&#39;</span><span class="p">:</span> <span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;races&#39;</span><span class="p">:</span> <span class="s1">&#39;sum&#39;</span><span class="p">})</span>
<a id="__codelineno-33-554" name="__codelineno-33-554" href="#__codelineno-33-554"></a>    <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;inplay_odds_ratio&#39;</span><span class="p">)</span>
<a id="__codelineno-33-555" name="__codelineno-33-555" href="#__codelineno-33-555"></a>    <span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;races &gt;= 5&#39;</span><span class="p">)</span>
<a id="__codelineno-33-556" name="__codelineno-33-556" href="#__codelineno-33-556"></a><span class="p">)</span>
<a id="__codelineno-33-557" name="__codelineno-33-557" href="#__codelineno-33-557"></a>
<a id="__codelineno-33-558" name="__codelineno-33-558" href="#__codelineno-33-558"></a><span class="n">tradeOutIndex</span>
<a id="__codelineno-33-559" name="__codelineno-33-559" href="#__codelineno-33-559"></a>
<a id="__codelineno-33-560" name="__codelineno-33-560" href="#__codelineno-33-560"></a><span class="n">targetTradeoutFraction</span> <span class="o">=</span> <span class="mf">0.5</span>
<a id="__codelineno-33-561" name="__codelineno-33-561" href="#__codelineno-33-561"></a>
<a id="__codelineno-33-562" name="__codelineno-33-562" href="#__codelineno-33-562"></a><span class="n">train_JockeyBackToLay</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-33-563" name="__codelineno-33-563" href="#__codelineno-33-563"></a>    <span class="n">dfTrain</span>
<a id="__codelineno-33-564" name="__codelineno-33-564" href="#__codelineno-33-564"></a>    <span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;distance_group in [&quot;long&quot;, &quot;mid_long&quot;]&#39;</span><span class="p">)</span>
<a id="__codelineno-33-565" name="__codelineno-33-565" href="#__codelineno-33-565"></a>    <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">tradeOutIndex</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">20</span><span class="p">)[</span><span class="s1">&#39;jockey&#39;</span><span class="p">])</span>
<a id="__codelineno-33-566" name="__codelineno-33-566" href="#__codelineno-33-566"></a>    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">npl</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;inplay_min_lay&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">targetTradeoutFraction</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;bsp&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;place&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.95</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;bsp&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;bsp&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)),</span> <span class="mi">0</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
<a id="__codelineno-33-567" name="__codelineno-33-567" href="#__codelineno-33-567"></a>    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">stake</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;npl&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<a id="__codelineno-33-568" name="__codelineno-33-568" href="#__codelineno-33-568"></a>    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">win</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;npl&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
<a id="__codelineno-33-569" name="__codelineno-33-569" href="#__codelineno-33-569"></a><span class="p">)</span>
<a id="__codelineno-33-570" name="__codelineno-33-570" href="#__codelineno-33-570"></a>
<a id="__codelineno-33-571" name="__codelineno-33-571" href="#__codelineno-33-571"></a><span class="n">bet_eval_metrics</span><span class="p">(</span><span class="n">train_JockeyBackToLay</span><span class="p">)</span>
<a id="__codelineno-33-572" name="__codelineno-33-572" href="#__codelineno-33-572"></a>
<a id="__codelineno-33-573" name="__codelineno-33-573" href="#__codelineno-33-573"></a><span class="n">test_JockeyBackToLay</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-33-574" name="__codelineno-33-574" href="#__codelineno-33-574"></a>    <span class="n">dfTest</span>
<a id="__codelineno-33-575" name="__codelineno-33-575" href="#__codelineno-33-575"></a>    <span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;distance_group in [&quot;long&quot;, &quot;mid_long&quot;]&#39;</span><span class="p">)</span>
<a id="__codelineno-33-576" name="__codelineno-33-576" href="#__codelineno-33-576"></a>    <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">tradeOutIndex</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">20</span><span class="p">)[</span><span class="s1">&#39;jockey&#39;</span><span class="p">])</span>
<a id="__codelineno-33-577" name="__codelineno-33-577" href="#__codelineno-33-577"></a>    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">npl</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;inplay_min_lay&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">targetTradeoutFraction</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;bsp&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;place&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.95</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;bsp&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;bsp&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)),</span> <span class="mi">0</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
<a id="__codelineno-33-578" name="__codelineno-33-578" href="#__codelineno-33-578"></a>    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">stake</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;npl&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<a id="__codelineno-33-579" name="__codelineno-33-579" href="#__codelineno-33-579"></a>    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">win</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;npl&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
<a id="__codelineno-33-580" name="__codelineno-33-580" href="#__codelineno-33-580"></a>
<a id="__codelineno-33-581" name="__codelineno-33-581" href="#__codelineno-33-581"></a><span class="p">)</span>
<a id="__codelineno-33-582" name="__codelineno-33-582" href="#__codelineno-33-582"></a>
<a id="__codelineno-33-583" name="__codelineno-33-583" href="#__codelineno-33-583"></a><span class="n">bet_eval_metrics</span><span class="p">(</span><span class="n">test_JockeyBackToLay</span><span class="p">)</span>
</code></pre></div>

</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<hr />
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="disclaimer">Disclaimer</h3>
<p>Note that whilst models and automated strategies are fun and rewarding to create, we can't promise that your model or betting strategy will be profitable, and we make no representations in relation to the code shared or information on this page. If you're using this code or implementing your own strategies, you do so entirely at your own risk and you are responsible for any winnings/losses incurred. Under no circumstances will Betfair be liable for any loss or damage you suffer.</p>
</div>
</div>
</div>

              
            </article>
          </div>
        </div>
        
          <a href="#" class="md-top md-icon" data-md-component="top" data-md-state="hidden">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
            Back to top
          </a>
        
      </main>
      
        <footer class="md-footer">
    
      <nav class="md-footer__inner md-grid" aria-label="Footer">
        
          
          <a href="../backtestingRatingsTutorial/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Back testing ratings in Python" rel="prev">
            <div class="md-footer__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
            </div>
            <div class="md-footer__title">
              <div class="md-ellipsis">
                <span class="md-footer__direction">
                  Previous
                </span>
                Back testing ratings in Python
              </div>
            </div>
          </a>
        
        
          
          <a href="../analysingAndPredictingMarketMovements/" class="md-footer__link md-footer__link--next" aria-label="Next: Do &amp;#35theyknow? Analysing Betfair market formation &amp; market movements" rel="next">
            <div class="md-footer__title">
              <div class="md-ellipsis">
                <span class="md-footer__direction">
                  Next
                </span>
                Do &#35theyknow? Analysing Betfair market formation & market movements
              </div>
            </div>
            <div class="md-footer__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
            </div>
          </a>
        
      </nav>
    
    <div class="md-footer-meta md-typeset">
      <div class="md-footer-meta__inner md-grid">
        <div class="md-copyright">
  
  
</div>
        
          <div class="md-social">
  
    
    
      
      
    
    <a href="https://twitter.com/Betfair_Aus" target="_blank" rel="noopener" title="twitter.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
    </a>
  
    
    
      
      
    
    <a href="https://linkedin.com/company/betfair-australia" target="_blank" rel="noopener" title="linkedin.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg>
    </a>
  
    
    
      
      
    
    <a href="https://facebook.com/betfairaustralia" target="_blank" rel="noopener" title="facebook.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M504 256C504 119 393 8 256 8S8 119 8 256c0 123.78 90.69 226.38 209.25 245V327.69h-63V256h63v-54.64c0-62.15 37-96.48 93.67-96.48 27.14 0 55.52 4.84 55.52 4.84v61h-31.28c-30.8 0-40.41 19.12-40.41 38.73V256h68.78l-11 71.69h-57.78V501C413.31 482.38 504 379.78 504 256z"/></svg>
    </a>
  
    
    
      
      
    
    <a href="https://youtube.com/user/betfairaus" target="_blank" rel="noopener" title="youtube.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M549.655 124.083c-6.281-23.65-24.787-42.276-48.284-48.597C458.781 64 288 64 288 64S117.22 64 74.629 75.486c-23.497 6.322-42.003 24.947-48.284 48.597-11.412 42.867-11.412 132.305-11.412 132.305s0 89.438 11.412 132.305c6.281 23.65 24.787 41.5 48.284 47.821C117.22 448 288 448 288 448s170.78 0 213.371-11.486c23.497-6.321 42.003-24.171 48.284-47.821 11.412-42.867 11.412-132.305 11.412-132.305s0-89.438-11.412-132.305zm-317.51 213.508V175.185l142.739 81.205-142.739 81.201z"/></svg>
    </a>
  
    
    
      
      
    
    <a href="https://github.com/betfair-datascientists" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
</div>
        
      </div>

      <div class="bf-footer">
          <div class="bf-footer-inner">
              <p class="bf-light">Betfair Pty Limited is licensed and regulated by the Northern Territory Government of Australia.</p>
              <p class="bf-dark">Betfair Pty Limited's gambling operations are governed by its <a class='inner-link' href="https://www.betfair.com.au/info/responsible-gambling/">Responsible Gambling Code of Conduct</a> and for South
              Australian residents by the <a class='inner-link' href="https://www.betfair.com.au/info/pdf/SA-GCoP.pdf">South Australian Responsible Gambling Code of Practice.</a><br /> Think! About your choices. Stay in control. Leave before you lose it. Gamble responsibly. Call Gambling Help 1800 858 858 <a href="https://gamblinghelponline.org.au">www.gamblinghelponline.org.au</a></p>
          
              <ul class="bf-links">
                <li><a href="https://www.betfair.com.au/hub/help/account-help/responsible-gambling/">Responsible Gambling</a><span>|</span></li>
                <li><a href="http://www.betfair.com/AUS_NZL/aboutUs/Terms.and.Conditions/">Terms & Conditions</a><span>|</span></li>
                <li><a href="https://www.betfair.com.au/info/privacy-policy/">Privacy Policy</a><span>|</span></li>
                <li><a href="http://www.betfair.com/en/aboutUs/Rules.and.Regulations/">Rules & Regulations</a><span>|</span></li>
                <li><a href="https://www.betfair.com/AUS_NZL/aboutUs/Dispute.Resolution">Dispute Resolution</a></li>
              </ul>
          </div>
      </div>
    </div>

    <script src="https://js.adsrvr.org/up_loader.1.1.0.js" type="text/javascript"></script>
    <script type="text/javascript">
        ttd_dom_ready( function() {
            if (typeof TTDUniversalPixelApi === 'function') {
                var universalPixelApi = new TTDUniversalPixelApi();
                universalPixelApi.init("y12d1ir", ["8ml4f17"], "https://insight.adsrvr.org/track/up");
            }
        });
    </script>

</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": ["toc.integrate", "navigation.instant", "navigation.tabs", "navigation.top", "navigation.expand", "navigation.sections", "search.suggest", "search.highlight", "search.share"], "search": "../../assets/javascripts/workers/search.2a1c317c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.6e54b5cd.min.js"></script>
      
    
  </body>
</html>