



<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="Documentation, guides and articles on creating, developing and implementing automated betting strategies, using data analysis to inform betting models and how to interact with the Betfair API.">
      
      
        <link rel="canonical" href="https://betfair-datascientists.github.io/historicData/backtestingRatingsTutorial/">
      
      
        <meta name="author" content="Betfair Data Scientists">
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../img/BetfairFavicon.ico">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-3.0.4">
    
    
      
        <title>Backtesting ratings tutorial - The Automation Hub</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application.0028e27e.css">
      
      
    
    
      <script src="../../assets/javascripts/modernizr.dd00d4b7.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../assets/fonts/material-icons.css">
    <link rel="stylesheet" href="../../assets/fonts/clarke-regular.css">
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#backtesting-wagering-models-with-betfair-json-stream-data" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="https://betfair-datascientists.github.io" title="The Automation Hub" class="md-header-nav__button md-logo">
          
            <img src="../../img/logo.svg" height="24">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                The Automation Hub
              </span>
              <span class="md-header-nav__topic">
                Backtesting ratings tutorial
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      <div class="bf-nav md-flex__cell">
        <a class="bf-hidable" href="https://www.betfair.com.au/exchange/plus/"><svg class="exchangeLogo" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:cc="http://creativecommons.org/ns#" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 38.775 4.59" width="24" height="17">
          <path class="st1" d="m 160.3,-136.95 v 26"/>
          <g transform="translate(18.8,-137.15)">
            <path d="m 2.2901089,126.53441 v 5.20093 H -3.3107216 L 7.4888397,144.33446 18.2884,131.73534 h -5.598633 v -5.20093 z m -8.6000974,8.10132 -10.8017585,12.59913 h 5.60083 v 5.2998 h 10.3996581 v -5.2998 h 5.6008306 z"/>
          </g>
        </svg><span> Exchange</span></a>
        <a href="https://www.betfair.com.au/hub/">Hub</a>
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
        

  

<nav class="md-tabs md-tabs--active" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../.." title="Home" class="md-tabs__link">
          Home
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../thirdPartyTools/overview/" title="Tutorials" class="md-tabs__link">
          Tutorials
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../api/apiResources/" title="API" class="md-tabs__link">
          API
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../dataSources/" title="Historic Data" class="md-tabs__link md-tabs__link--active">
          Historic Data
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../modelling/howToModel/" title="Modelling" class="md-tabs__link">
          Modelling
        </a>
      
    </li>
  

      
    </ul>
  </div>
</nav>
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="https://betfair-datascientists.github.io" title="The Automation Hub" class="md-nav__button md-logo">
      
        <img src="../../img/logo.svg" width="48" height="48">
      
    </a>
    The Automation Hub
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-1" type="checkbox" id="nav-1">
    
    <label class="md-nav__link" for="nav-1">
      Home
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-1">
        Home
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../.." title="The Automation Hub" class="md-nav__link">
      The Automation Hub
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      Tutorials
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Tutorials
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../thirdPartyTools/overview/" title="Tools Overview" class="md-nav__link">
      Tools Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-2" type="checkbox" id="nav-2-2">
    
    <label class="md-nav__link" for="nav-2-2">
      Bet Angel Professional
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-2-2">
        Bet Angel Professional
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../thirdPartyTools/betAngel/betAngel/" title="Overview - Bet Angel Pro" class="md-nav__link">
      Overview - Bet Angel Pro
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../thirdPartyTools/betAngelbeginners/" title="Bet Angel - A beginner's guide" class="md-nav__link">
      Bet Angel - A beginner's guide
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../thirdPartyTools/betAngelintermediate/" title="Bet Angel - An intermediate guide" class="md-nav__link">
      Bet Angel - An intermediate guide
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../thirdPartyTools/betAngeladvanced/" title="Bet Angel - An advanced guide" class="md-nav__link">
      Bet Angel - An advanced guide
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../thirdPartyTools/betAngelRatingsAutomation/" title="Ratings automation" class="md-nav__link">
      Ratings automation
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../thirdPartyTools/betAngelMarketFavouriteAutomation/" title="Market favourite automation" class="md-nav__link">
      Market favourite automation
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../thirdPartyTools/betAngelTippingAutomation/" title="Tipping automation" class="md-nav__link">
      Tipping automation
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../thirdPartyTools/betAngelSimultaneousMarkets/" title="Simultaneous markets" class="md-nav__link">
      Simultaneous markets
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../thirdPartyTools/betAngelKellyStake/" title="Kelly Criterion staking" class="md-nav__link">
      Kelly Criterion staking
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-3" type="checkbox" id="nav-2-3">
    
    <label class="md-nav__link" for="nav-2-3">
      Gruss Betting Assistant
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-2-3">
        Gruss Betting Assistant
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../thirdPartyTools/Gruss/Gruss/" title="Overview - Gruss" class="md-nav__link">
      Overview - Gruss
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../thirdPartyTools/grussRatingsAutomation/" title="Ratings automation" class="md-nav__link">
      Ratings automation
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../thirdPartyTools/grussMarketFavouriteAutomation/" title="Market favourite automation" class="md-nav__link">
      Market favourite automation
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../thirdPartyTools/grusslSimultaneousMarkets/" title="Simultaneous markets" class="md-nav__link">
      Simultaneous markets
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../thirdPartyTools/grussKellyStake/" title="Kelly Criterion staking" class="md-nav__link">
      Kelly Criterion staking
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-4" type="checkbox" id="nav-2-4">
    
    <label class="md-nav__link" for="nav-2-4">
      Cymatic Trader
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-2-4">
        Cymatic Trader
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../thirdPartyTools/CymaticTrader/CymaticTrader/" title="Overview - Cymatic Trader" class="md-nav__link">
      Overview - Cymatic Trader
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../thirdPartyTools/cymaticTraderRatingsAutomation/" title="Ratings automation" class="md-nav__link">
      Ratings automation
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      API
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        API
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../api/apiResources/" title="API resources" class="md-nav__link">
      API resources
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../api/apiappkey/" title="How to access the Betfair API" class="md-nav__link">
      How to access the Betfair API
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../api/apiRtutorial/" title="API tutorials in R" class="md-nav__link">
      API tutorials in R
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../api/apiPythontutorial/" title="API tutorial in Python" class="md-nav__link">
      API tutorial in Python
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4" checked>
    
    <label class="md-nav__link" for="nav-4">
      Historic Data
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        Historic Data
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../dataSources/" title="Historic Data Sources" class="md-nav__link">
      Historic Data Sources
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../usingHistoricDataSite/" title="Downloading from the Historic Data site" class="md-nav__link">
      Downloading from the Historic Data site
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../jsonToCsvTutorial/" title="JSON to CSV tutorial" class="md-nav__link">
      JSON to CSV tutorial
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Backtesting ratings tutorial
      </label>
    
    <a href="./" title="Backtesting ratings tutorial" class="md-nav__link md-nav__link--active">
      Backtesting ratings tutorial
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#set-up" title="Set up" class="md-nav__link">
    Set up
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#context" title="Context" class="md-nav__link">
    Context
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#backtesting-on-betfair" title="Backtesting on Betfair" class="md-nav__link">
    Backtesting on Betfair
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#betfair-stream-data" title="Betfair Stream Data" class="md-nav__link">
    Betfair Stream Data
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#this-example-backtesting-betfair-hub-thoroughbred-model" title="This example: backtesting Betfair Hub thoroughbred model" class="md-nav__link">
    This example: backtesting Betfair Hub thoroughbred model
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#scrape-the-model-ratings" title="Scrape The Model Ratings" class="md-nav__link">
    Scrape The Model Ratings
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#assembling-the-odds-file" title="Assembling the odds file" class="md-nav__link">
    Assembling the odds file
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-data" title="The Data" class="md-nav__link">
    The Data
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#unpacking-flattening-the-data" title="Unpacking / flattening the data" class="md-nav__link">
    Unpacking / flattening the data
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-tar-load" title="1: .tar load" class="md-nav__link">
    1: .tar load
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-scan-across-market-states-and-extract-useful-objects" title="2: Scan across market states and extract useful objects" class="md-nav__link">
    2: Scan across market states and extract useful objects
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-4-summarise-those-useful-objects-and-write-to-csv" title="3 &amp; 4: Summarise those useful objects and write to .csv" class="md-nav__link">
    3 &amp; 4: Summarise those useful objects and write to .csv
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#extending-this-code" title="Extending this code" class="md-nav__link">
    Extending this code
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#backtesting-analysis" title="Backtesting Analysis" class="md-nav__link">
    Backtesting Analysis
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#setting-up-your-master-data" title="Setting up your master data" class="md-nav__link">
    Setting up your master data
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#staking-outcome-functions" title="Staking + Outcome Functions" class="md-nav__link">
    Staking + Outcome Functions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#evaluation-functions" title="Evaluation Functions" class="md-nav__link">
    Evaluation Functions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#testing-different-approaches" title="Testing different approaches" class="md-nav__link">
    Testing different approaches
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#searching-for-profit" title="Searching For Profit" class="md-nav__link">
    Searching For Profit
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conclusion-and-next-steps" title="Conclusion and Next Steps" class="md-nav__link">
    Conclusion and Next Steps
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#over-to-you" title="Over to you" class="md-nav__link">
    Over to you
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#complete-code" title="Complete code" class="md-nav__link">
    Complete code
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#disclaimer" title="Disclaimer" class="md-nav__link">
    Disclaimer
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      Modelling
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        Modelling
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../modelling/howToModel/" title="Intro to modelling" class="md-nav__link">
      Intro to modelling
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-2" type="checkbox" id="nav-5-2">
    
    <label class="md-nav__link" for="nav-5-2">
      Soccer
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-2">
        Soccer
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../modelling/soccerEloTutorialR/" title="Elo soccer tutorial in R" class="md-nav__link">
      Elo soccer tutorial in R
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../modelling/soccerModellingTutorialPython/" title="Soccer modelling tutorial in Python" class="md-nav__link">
      Soccer modelling tutorial in Python
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../modelling/soccerModellingTutorialR/" title="Soccer modelling tutorial in R" class="md-nav__link">
      Soccer modelling tutorial in R
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../modelling/EPLmlPython/" title="EPL ML walkthrough in Python" class="md-nav__link">
      EPL ML walkthrough in Python
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-3" type="checkbox" id="nav-5-3">
    
    <label class="md-nav__link" for="nav-5-3">
      AFL
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-3">
        AFL
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../modelling/AFLmodellingPython/" title="AFL modelling walkthrough in Python" class="md-nav__link">
      AFL modelling walkthrough in Python
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../modelling/brownlowModelTutorial/" title="Modelling the Brownlow Medal in Python" class="md-nav__link">
      Modelling the Brownlow Medal in Python
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-4" type="checkbox" id="nav-5-4">
    
    <label class="md-nav__link" for="nav-5-4">
      Tennis
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-4">
        Tennis
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../modelling/howToModelTheAusOpen/" title="How to model the Australian Open" class="md-nav__link">
      How to model the Australian Open
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../modelling/AusOpenRTutorial/" title="Aus Open R Tutorial" class="md-nav__link">
      Aus Open R Tutorial
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../modelling/AusOpenPythonTutorial/" title="Aus Open Python Tutorial" class="md-nav__link">
      Aus Open Python Tutorial
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#set-up" title="Set up" class="md-nav__link">
    Set up
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#context" title="Context" class="md-nav__link">
    Context
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#backtesting-on-betfair" title="Backtesting on Betfair" class="md-nav__link">
    Backtesting on Betfair
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#betfair-stream-data" title="Betfair Stream Data" class="md-nav__link">
    Betfair Stream Data
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#this-example-backtesting-betfair-hub-thoroughbred-model" title="This example: backtesting Betfair Hub thoroughbred model" class="md-nav__link">
    This example: backtesting Betfair Hub thoroughbred model
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#scrape-the-model-ratings" title="Scrape The Model Ratings" class="md-nav__link">
    Scrape The Model Ratings
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#assembling-the-odds-file" title="Assembling the odds file" class="md-nav__link">
    Assembling the odds file
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-data" title="The Data" class="md-nav__link">
    The Data
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#unpacking-flattening-the-data" title="Unpacking / flattening the data" class="md-nav__link">
    Unpacking / flattening the data
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-tar-load" title="1: .tar load" class="md-nav__link">
    1: .tar load
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-scan-across-market-states-and-extract-useful-objects" title="2: Scan across market states and extract useful objects" class="md-nav__link">
    2: Scan across market states and extract useful objects
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-4-summarise-those-useful-objects-and-write-to-csv" title="3 &amp; 4: Summarise those useful objects and write to .csv" class="md-nav__link">
    3 &amp; 4: Summarise those useful objects and write to .csv
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#extending-this-code" title="Extending this code" class="md-nav__link">
    Extending this code
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#backtesting-analysis" title="Backtesting Analysis" class="md-nav__link">
    Backtesting Analysis
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#setting-up-your-master-data" title="Setting up your master data" class="md-nav__link">
    Setting up your master data
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#staking-outcome-functions" title="Staking + Outcome Functions" class="md-nav__link">
    Staking + Outcome Functions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#evaluation-functions" title="Evaluation Functions" class="md-nav__link">
    Evaluation Functions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#testing-different-approaches" title="Testing different approaches" class="md-nav__link">
    Testing different approaches
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#searching-for-profit" title="Searching For Profit" class="md-nav__link">
    Searching For Profit
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conclusion-and-next-steps" title="Conclusion and Next Steps" class="md-nav__link">
    Conclusion and Next Steps
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#over-to-you" title="Over to you" class="md-nav__link">
    Over to you
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#complete-code" title="Complete code" class="md-nav__link">
    Complete code
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#disclaimer" title="Disclaimer" class="md-nav__link">
    Disclaimer
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="backtesting-wagering-models-with-betfair-json-stream-data">Backtesting wagering models with Betfair JSON stream data<a class="headerlink" href="#backtesting-wagering-models-with-betfair-json-stream-data" title="Permanent link">&para;</a></h1>
<hr />
<p>This tutorial was written by <a href="https://github.com/TMBish">Tom Bishop</a> and was <a href="https://github.com/TMBish/bfStreamTutorials/blob/main/01-hub-backtesting.ipynb">originally published on Github</a>. It is shared here with his permission. </p>
<p>This tutorial follows on logically from the <a href="https://betfair-datascientists.github.io/historicData/jsonToCsvTutorial/">JSON to CSV tutorial</a> we shared previously. If you're still new to working with the JSON data sets we suggest you take a look at that tutorial before diving into this one. </p>
<p>As always please <a href="mailto:data@betfair.com.au">reach out</a> with feedback, suggestions or queries, or feel free to submit a <a href="https://github.com/betfair-down-under/autoHubTutorials/pulls">pull request</a> if you catch some bugs or have other improvements! </p>
<div class="admonition note">
<p class="admonition-title">Cheat sheet</p>
<ul>
<li>
<p>If you're looking for the complete code <a href="http://127.0.0.1:8000/historicData/backtestingRatingsTutorial/#complete-code">head to the bottom of the page</a> or <a href="https://github.com/betfair-down-under/autoHubTutorials/blob/aa76784071aad7703266d53dead7a713815e6107/backtestRatings/main.py">download the script from Github</a>.</p>
</li>
<li>
<p>To run the code, save it to your machine, open a command prompt, or a terminal in your text editor of choice (we're using <a href="https://code.visualstudio.com/download">VS code</a>), make sure you've navigated in the terminal to the folder you've saved the script in and then type <code>py main.py</code> (or whatever you've called your script file if not main) then hit enter. To stop the code running use Ctrl C. </p>
</li>
<li>
<p>Make sure you amend your data path to point to your data file. We'll be taking in an input of a historical tar file downloaded from the <a href="https://historicdata.betfair.com/#/help">Betfair historic data site</a>. We're using a PRO version, though the code should work on ADVANCED too. This approach won't work with the BASIC data tier. </p>
</li>
<li>
<p>We're using the <a href="https://github.com/liampauling/betfair/tree/master/betfairlightweight"><code>betfairlightweight</code></a> package to do the heavy lifting</p>
</li>
<li>
<p>We've also posted the completed code logic on the <a href="https://github.com/betfair-down-under/autoHubTutorials/blob/aa76784071aad7703266d53dead7a713815e6107/backtestRatings/main.py"><code>betfair-downunder</code> Github repo</a>.</p>
</li>
</ul>
</div>
<hr />
<h3 id="set-up">Set up<a class="headerlink" href="#set-up" title="Permanent link">&para;</a></h3>
<p>I'm going to be using a jupyter notebook for this investigation which is a special type of data analysis output that is used to combine code, outputs and explanatory text in a readable single document. It's mostly closely associated with python data analysis code which is the language I'll be using here also. The entire body of python code used will be repeated at the bottom of the article where you can copy it and repurpose it for yourself.</p>
<p>If you're not familiar with python, don't worry neither am I really! I'm inexperienced with python so if you have experience with some other programming language you should be able to follow along with the logic here too. If you don't have experience using another programming language this all might appear intimidating but it's heavy on the explanatory text so you should get something out of it.</p>
<p>We need a few non standard python libraries so make sure to install <code>betfairlightweight</code> and <code>plotly</code> before you get started with something like <code>pip install betfairlightweight</code> &amp; <code>pip install plotly</code>. We'll load all our libraries and do some setup here.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">date</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">tarfile</span>
<span class="kn">import</span> <span class="nn">zipfile</span>
<span class="kn">import</span> <span class="nn">bz2</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">unittest.mock</span> <span class="kn">import</span> <span class="n">patch</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Set</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">zip_longest</span>
<span class="kn">import</span> <span class="nn">plotly.express</span> <span class="k">as</span> <span class="nn">px</span>

<span class="kn">import</span> <span class="nn">betfairlightweight</span>
<span class="kn">from</span> <span class="nn">betfairlightweight</span> <span class="kn">import</span> <span class="n">StreamListener</span>
<span class="kn">from</span> <span class="nn">betfairlightweight.resources.bettingresources</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">PriceSize</span><span class="p">,</span>
    <span class="n">MarketBook</span>
<span class="p">)</span>

<span class="o">%</span><span class="n">config</span> <span class="n">IPCompleter</span><span class="o">.</span><span class="n">greedy</span><span class="o">=</span><span class="kc">True</span>
</code></pre></div>
<hr />
<h3 id="context">Context<a class="headerlink" href="#context" title="Permanent link">&para;</a></h3>
<p>Backtesting is the life-blood of most successful wagering systems. In short it attempts to answer a single question for you:</p>
<blockquote>
<p>&#120591; : How much money will I win or lose if I started using this system to place bets with real money?</p>
</blockquote>
<p>Without a rigorous and quantitative backtesting approach it's really quite hard to estimate the answer to this question $ \tau $ that will be even reliably on the right side of zero.</p>
<p>You could live test your system with real bets at small stakes, however, this isn't the panacea it seems. It will take time (more than you think) for your results to converge to their long term expectation. How long? Answering this question will require some expertise with probability and statistics you might not have. Even more than that though is that depending on where you're betting your results at small stakes could be very different than at larger stakes. You might not be able get a good answer to $ \tau $ until betting at full stakes at which point finding the answer might coincide with blowing up your gambling bankroll.</p>
<p>Backtesting is also very hard. To perfectly backtest your own predicted probability on a historical race or sporting match you need to produce 2 things:</p>
<blockquote>
<p>(1) What would my predicted chance have been exactly for this selection in this market on this day in the past?</p>
<p>(2) What would have I decided to bet at what odds (exactly) and for how much stake (exactly) based on this prediction?</p>
</blockquote>
<p>The devil in the detail of backtesting tends to be in those exactlys.</p>
<p>The aim of the backtesting game is answering (2) as accurately as possible because it tells you exactly how much you would have made over your backtesting period, from there you can confidently project that rate of profitability forward.</p>
<p>It's easy to make mistakes and small errors in the quantitative reasoning can lead you to extremely misguided projections downstream.</p>
<p>Question (1) won't be in the scope of this notebook but it's equally (and probably more) important that (2) but it is the key challenge of all predictive modelling exercises so there's plenty of discussion about it elsewhere.</p>
<hr />
<h3 id="backtesting-on-betfair">Backtesting on Betfair<a class="headerlink" href="#backtesting-on-betfair" title="Permanent link">&para;</a></h3>
<p>Answering question (2) for betting on the Betfair Exchange is difficult. The Exchange is a dynamic system that changes from one micro second to the next.</p>
<blockquote>
<p>What number should you use for odds? How much could you assume to get down at those odds?</p>
</blockquote>
<p>The conventional and easiest approach is to backtest at the BSP. The BSP is simple because it's a single number (to use for both back and lay bets) and is a taken price (there's no uncertainty about getting matched). Depending on the liquidity of the market a reasonably sized stake might also not move the BSP very much. For some markets you may be able to safely assume you could be $10s of dollars at the BSP without moving it an inch. However, that's definitely not true of all BSP markets and you need to be generally aware that your Betfair orders in the future will change the state of the exchange, and large bets will move the BSP in an unfavourable direction.</p>
<p>Aside from uncertainty around the liquidity and resilience of the BSP, many many markets don't have a BSP. So what do we do then?</p>
<p>Typically what a lot of people (who have a relationship with Betfair Australia) do at this point is request a data dump. They might request an odds file for all Australian harness race win markets since June 2018 with results and 4 different price points: the BSP, the last traded price, the weighted average price (WAP) traded in 3 minutes before the race starts, and the WAP for all bets matched prior to 3 mins before the race.</p>
<p>However, you will likely need to be an existing VIP customer to get this file and it's not a perfect solution: it might take 2 weeks to get, you can't refresh it, you can't test more hypothetical price points after your initial analysis amongst many other problems.</p>
<blockquote>
<p>What if you could produce this valuable data file yourself?</p>
</blockquote>
<hr />
<h3 id="betfair-stream-data">Betfair Stream Data<a class="headerlink" href="#betfair-stream-data" title="Permanent link">&para;</a></h3>
<p>Betfair's historical stream data is an extremely rich source of data. However, in it's raw form it's difficult to handle for the uninitiated. It also might not be immediately obvious how many different things this dataset could be used for without seeing some examples. These guides will hopefully demystify how to turn this raw data into a familiar and usable format whilst also hopefully providing some inspiration for the kinds of value that can be excavated from it.</p>
<hr />
<h3 id="this-example-backtesting-betfair-hub-thoroughbred-model">This example: backtesting Betfair Hub thoroughbred model<a class="headerlink" href="#this-example-backtesting-betfair-hub-thoroughbred-model" title="Permanent link">&para;</a></h3>
<p>To illustrate how you can use the stream files to backtest the outputs of a rating system we'll use the Australian Thoroughbred Rating model available on the Betfair Hub. The most recent model iteration only goes back till Feb 28<sup>th</sup> 2021 however as an illustrative example this is fine. We'd normally want to backtest with a lot more historical data than this, which just means in this case our estimation of future performance will be unreliable.</p>
<p>I'm interested to see how we would have fared betting all selections rated by this model according to a few different staking schemes and also at a few different times / price points.</p>
<div class="admonition note">
<p class="admonition-title">Old ratings</p>
<p>If you want to pull in ratings from before Feb 2021 to add to your database for more complete backtesting these are available in a <a href="../resources/oldRatingsDump.7z">data dump here</a>.</p>
</div>
<hr />
<h2 id="scrape-the-model-ratings">Scrape The Model Ratings<a class="headerlink" href="#scrape-the-model-ratings" title="Permanent link">&para;</a></h2>
<p>If you travel to the Betfair hub ratings page you'll find that URL links behind the ratings download buttons have a consistent URL pattern that looks very scrape friendly.</p>
<p><img alt="Betfair Hub Ratings" src="../img/ratingsExample.png" /></p>
<p>We can take advantage of this consistency and use some simple python code to scrape all the ratings into a pandas dataframe.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Function to return Pandas DF of hub ratings for a particular date</span>
<span class="k">def</span> <span class="nf">getHubRatings</span><span class="p">(</span><span class="n">dte</span><span class="p">):</span>

    <span class="c1"># Substitute the date into the URL</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;https://betfair-data-supplier-prod.herokuapp.com/api/widgets/kash-ratings-model/datasets?date=</span><span class="si">{}</span><span class="s1">presenter=RatingsPresenter&amp;json=true&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dte</span><span class="p">)</span>

    <span class="c1"># Convert the response into JSON</span>
    <span class="n">responseJson</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>

    <span class="n">hubList</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">responseJson</span><span class="p">:</span>
        <span class="k">return</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>


    <span class="c1"># Want an normalised table (1 row per selection)</span>
    <span class="c1"># Brute force / simple approach is to loop through meetings / races / runners and pull out the key fields</span>
    <span class="k">for</span> <span class="n">meeting</span> <span class="ow">in</span> <span class="n">responseJson</span><span class="p">[</span><span class="s1">&#39;meetings&#39;</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">race</span> <span class="ow">in</span> <span class="n">meeting</span><span class="p">[</span><span class="s1">&#39;races&#39;</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">runner</span> <span class="ow">in</span> <span class="n">race</span><span class="p">[</span><span class="s1">&#39;runners&#39;</span><span class="p">]:</span>
                <span class="n">hubList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="n">dte</span><span class="p">,</span>
                        <span class="s1">&#39;track&#39;</span><span class="p">:</span> <span class="n">meeting</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
                        <span class="s1">&#39;race_number&#39;</span><span class="p">:</span> <span class="n">race</span><span class="p">[</span><span class="s1">&#39;number&#39;</span><span class="p">],</span>
                        <span class="s1">&#39;race_name&#39;</span><span class="p">:</span> <span class="n">race</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
                        <span class="s1">&#39;market_id&#39;</span><span class="p">:</span> <span class="n">race</span><span class="p">[</span><span class="s1">&#39;bfExchangeMarketId&#39;</span><span class="p">],</span>
                        <span class="s1">&#39;selection_id&#39;</span><span class="p">:</span>  <span class="nb">str</span><span class="p">(</span><span class="n">runner</span><span class="p">[</span><span class="s1">&#39;bfExchangeSelectionId&#39;</span><span class="p">]),</span>
                        <span class="s1">&#39;selection_name&#39;</span><span class="p">:</span> <span class="n">runner</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
                        <span class="s1">&#39;model_odds&#39;</span><span class="p">:</span> <span class="n">runner</span><span class="p">[</span><span class="s1">&#39;ratedPrice&#39;</span><span class="p">]</span>
                    <span class="p">}</span>
                <span class="p">)</span>

    <span class="n">out</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">hubList</span><span class="p">)</span>

    <span class="k">return</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># See the response from a single day</span>
<span class="n">getHubRatings</span><span class="p">(</span><span class="n">date</span><span class="p">(</span><span class="mi">2021</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</code></pre></div>
<table>
<thead>
<tr>
<th>date</th>
<th>track</th>
<th>race_number</th>
<th>race_name</th>
<th>market_id</th>
<th>selection_id</th>
<th>selection_name</th>
<th>model_odds</th>
</tr>
</thead>
<tbody>
<tr>
<td>2021-03-01</td>
<td>COWRA</td>
<td>1</td>
<td>R1 1375m Mdn</td>
<td>1.179845154</td>
<td>38620052</td>
<td>1. Military Affair</td>
<td>6.44</td>
</tr>
<tr>
<td>2021-03-01</td>
<td>COWRA</td>
<td>1</td>
<td>R1 1375m Mdn</td>
<td>1.179845154</td>
<td>5889703</td>
<td>3. Proverbial</td>
<td>21.11</td>
</tr>
<tr>
<td>2021-03-01</td>
<td>COWRA</td>
<td>1</td>
<td>R1 1375m Mdn</td>
<td>1.179845154</td>
<td>38177688</td>
<td>4. A Real Wag</td>
<td>9.97</td>
</tr>
<tr>
<td>2021-03-01</td>
<td>COWRA</td>
<td>1</td>
<td>R1 1375m Mdn</td>
<td>1.179845154</td>
<td>38620053</td>
<td>5. El Jay</td>
<td>44.12</td>
</tr>
<tr>
<td>2021-03-01</td>
<td>COWRA</td>
<td>1</td>
<td>R1 1375m Mdn</td>
<td>1.179845154</td>
<td>37263264</td>
<td>6. Flying Honour</td>
<td>3.39</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre><span></span><code><span class="n">dateDFList</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">dateList</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">date</span><span class="p">(</span><span class="mi">2021</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">18</span><span class="p">),</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">-</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span><span class="n">freq</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">dte</span> <span class="ow">in</span> <span class="n">dateList</span><span class="p">:</span>
    <span class="n">dateDFList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">getHubRatings</span><span class="p">(</span><span class="n">dte</span><span class="p">))</span>

<span class="c1"># Concatenate (add rows to rows) all the dataframes within the list</span>
<span class="n">hubRatings</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">dateDFList</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">hubRatings</span><span class="o">.</span><span class="n">shape</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="p">(</span><span class="mi">32519</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
</code></pre></div>
<hr />
<h2 id="assembling-the-odds-file">Assembling the odds file<a class="headerlink" href="#assembling-the-odds-file" title="Permanent link">&para;</a></h2>
<p>So part 1 was very painless. This is how we like data: served by some API or available in a nice tabular format on a webpage ready to be scraped with standard tools available in popular languages.</p>
<p>Unfortunately, it won't be so painless to assemble our odds file. We'll find out why it's tricky as we go.</p>
<hr />
<h3 id="the-data">The Data<a class="headerlink" href="#the-data" title="Permanent link">&para;</a></h3>
<p>The data we'll be using is the historical Exchange data available from this website. The data available through this service is called streaming JSON data. There are a few options available relating to granularity (how many time points per second the data updates at) but we'll be using the most granular "PRO" set which has updates every 50 milliseconds.</p>
<p>Essentially what the data allows us to do is, for a particular market, recreate the exact state of the Betfair Exchange at say: 150 milliseconds before the market closed. When people say the state of the Exchange they mean two things a) what are all the current open orders on all the selections b) what are the current traded volumes on each selection at each price point. We obviously don't have access to any information about which accounts are putting up which prices and other things Betfair has themselves. We're essentially getting a snapshot of everything you can see through the website by clicking on each selection manually and looking at the graphs, tables and ladders.</p>
<p>However, with just these 2 sets of information we can build a rich view of the dynamics of exchange and also build out all of the summary metrics (WAP etc) we might have previously needed Betfair to help with.</p>
<p>For our purposes 50 milli-second intervaled data is huge overkill. But you could imagine needing this kind of granularity for other kinds of wagering systems - eg a high frequency trading algorithm of some sort that needs to make many decisions and actions every second.</p>
<p>Let's take a look at what the stream data looks like for a single market:</p>
<p><img alt="Stream Data Example" src="../img/streamDataExample.png" /></p>
<p>So it looks pretty intractable. For this particular market there's 14,384 lines of data where each line consists of a single JSON packet of data. If you're not a data engineer (neither am I) your head might explode thinking about how you could read this into your computer and transform it into something usable.</p>
<p>The data looks like this because it is saved from a special Betfair API called the Stream API which which is used by high end Betfair API users and which delivers fast speeds other performance improvements over the normal "polling" API.</p>
<p>Now what's good about that, for the purposes of our exercise, is that the very nice python package <code>betfairlightweight</code> has the functionality built to not only parse the Stream API when connected live but also these historical saved versions of the stream data. Without it we'd be very far away from the finish line, with <code>betfairlightweight</code> we're pretty close.</p>
<hr />
<h3 id="unpacking-flattening-the-data">Unpacking / flattening the data<a class="headerlink" href="#unpacking-flattening-the-data" title="Permanent link">&para;</a></h3>
<p>Because these files are so large and unprocessed this process won't look the same as your normal data ETL in python: where you can read a raw data file (csv, JSON, text etc.) into memory and use python functions to transform into usable format.</p>
<p>I personally had no idea how to use python and <code>betfairlightweight</code> to parse these data until I saw <a href="https://betfair-datascientists.github.io/historicData/jsonToCsvTutorial/">Betfair's very instructive overview</a> which you should read for a more detailed look at some of the below code.</p>
<p>By my count there were 4 key conceptual components that I had to get my head around to understand and be able to re-purpose that code. So if you're like me (a bit confused by some of the steps in that piece) this explanation might help.</p>
<p>I'll assume you don't do any decompression and keep the monthly PRO files as the .tar archives as they are.</p>
<p>Conceptually the process looks something like this:</p>
<ol>
<li>Load the "archives" into a "generator"</li>
<li>Scan across the generator (market_ids) and the market states within those markets to extract useful objects</li>
<li>Process those useful objects to pull out some metadata + useful summary numbers derived from the available orders and traded volumes snapshot data</li>
<li>Write this useful summarised data to a file that can be read and understood with normal data analysis workflows
First we'll run a bunch of setup code setting up my libraries and creating some utility functions that will be used throughout the main parsing component. It'll also point to the two stream files I'll be parsing for this exercise.</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="c1"># create trading instance (don&#39;t need username/password)</span>
<span class="n">trading</span> <span class="o">=</span> <span class="n">betfairlightweight</span><span class="o">.</span><span class="n">APIClient</span><span class="p">(</span><span class="s2">&quot;username&quot;</span><span class="p">,</span> <span class="s2">&quot;password&quot;</span><span class="p">)</span>

<span class="c1"># create listener</span>
<span class="n">listener</span> <span class="o">=</span> <span class="n">StreamListener</span><span class="p">(</span><span class="n">max_latency</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

<span class="c1">### Utility Functions</span>

<span class="c1"># rounding to 2 decimal places or returning &#39;&#39; if blank</span>
<span class="k">def</span> <span class="nf">as_str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">v</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">float</span> <span class="k">else</span> <span class="n">v</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>

<span class="c1"># splitting race name and returning the parts </span>
<span class="k">def</span> <span class="nf">split_anz_horse_market_name</span><span class="p">(</span><span class="n">market_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
    <span class="c1"># return race no, length, race type</span>
    <span class="c1"># input sample: R6 1400m Grp1</span>
    <span class="n">parts</span> <span class="o">=</span> <span class="n">market_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
    <span class="n">race_no</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># return example R6</span>
    <span class="n">race_len</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># return example 1400m</span>
    <span class="n">race_type</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="c1"># return example grp1, trot, pace</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">race_no</span><span class="p">,</span> <span class="n">race_len</span><span class="p">,</span> <span class="n">race_type</span><span class="p">)</span>

<span class="c1"># creating a flag that is True when markets are australian thoroughbreds</span>
<span class="k">def</span> <span class="nf">filter_market</span><span class="p">(</span><span class="n">market</span><span class="p">:</span> <span class="n">MarketBook</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span> 
    <span class="n">d</span> <span class="o">=</span> <span class="n">market</span><span class="o">.</span><span class="n">market_definition</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">country_code</span> <span class="o">==</span> <span class="s1">&#39;AU&#39;</span> 
        <span class="ow">and</span> <span class="n">d</span><span class="o">.</span><span class="n">market_type</span> <span class="o">==</span> <span class="s1">&#39;WIN&#39;</span> 
        <span class="ow">and</span> <span class="p">(</span><span class="n">c</span> <span class="o">:=</span> <span class="n">split_anz_horse_market_name</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">name</span><span class="p">)[</span><span class="mi">2</span><span class="p">])</span> <span class="o">!=</span> <span class="s1">&#39;trot&#39;</span> <span class="ow">and</span> <span class="n">c</span> <span class="o">!=</span> <span class="s1">&#39;pace&#39;</span><span class="p">)</span>
</code></pre></div>
<h4 id="1-tar-load">1: .tar load<a class="headerlink" href="#1-tar-load" title="Permanent link">&para;</a></h4>
<ul>
<li>This function I stole from <a href="https://betfair-datascientists.github.io/historicData/jsonToCsvTutorial/">Betfair's instructional article</a></li>
<li>The stream files are downloaded as .tar archive files which are a special kind of file that we'll need to unpack</li>
<li>Instead of loading each file into memory this function returns a "generator" which is a special python object that is to be iterated over</li>
<li>This basically means it contains the instructions to unpack and scan over files on the fly</li>
<li>This function also contains the logic to deal with if these files are zip archives or you've manually unpacked the archive and have the .bz2 zipped files</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1"># loading from tar and extracting files</span>
<span class="k">def</span> <span class="nf">load_markets</span><span class="p">(</span><span class="n">file_paths</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">file_path</span> <span class="ow">in</span> <span class="n">file_paths</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">iglob</span><span class="p">(</span><span class="n">file_path</span> <span class="o">+</span> <span class="s1">&#39;**/**/*.bz2&#39;</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">bz2</span><span class="o">.</span><span class="n">BZ2File</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
                <span class="k">yield</span> <span class="n">f</span>
                <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
            <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file_path</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="c1"># iterate through a tar archive</span>
            <span class="k">if</span> <span class="n">ext</span> <span class="o">==</span> <span class="s1">&#39;.tar&#39;</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">TarFile</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">archive</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">archive</span><span class="p">:</span>
                        <span class="k">yield</span> <span class="n">bz2</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">archive</span><span class="o">.</span><span class="n">extractfile</span><span class="p">(</span><span class="n">file</span><span class="p">))</span>
            <span class="c1"># or a zip archive</span>
            <span class="k">elif</span> <span class="n">ext</span> <span class="o">==</span> <span class="s1">&#39;.zip&#39;</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">archive</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">archive</span><span class="o">.</span><span class="n">namelist</span><span class="p">():</span>
                        <span class="k">yield</span> <span class="n">bz2</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">archive</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file</span><span class="p">))</span>

    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div>
<h4 id="2-scan-across-market-states-and-extract-useful-objects">2: Scan across market states and extract useful objects<a class="headerlink" href="#2-scan-across-market-states-and-extract-useful-objects" title="Permanent link">&para;</a></h4>
<ul>
<li>So this function will take a special "stream" object which we'll create with <code>betfairlightweight</code></li>
<li>The function takes a stream object input and returns 4 instances of the market state</li>
<li>The market state 3 mins before the scheduled off</li>
<li>The market state immediately before it goes inplay</li>
<li>The market state immediately before it closes for settlement</li>
<li>The final market state with outcomes</li>
<li>It basically just loops over all the market states and has a few checks to determine if it should save the current market state as key variables and then returns those</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1"># Extract Components From Generated Stream</span>
<span class="k">def</span> <span class="nf">extract_components_from_stream</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>

    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s2">&quot;builtins.open&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">f</span><span class="p">,</span> <span class="n">_</span><span class="p">:</span> <span class="n">f</span><span class="p">):</span>   

        <span class="c1"># Will return 3 market books t-3mins marketbook, the last preplay marketbook and the final market book</span>
        <span class="n">evaluate_market</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">prev_market</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">postplay_market</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">preplay_market</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">t3m_market</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">gen</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">get_generator</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">market_books</span> <span class="ow">in</span> <span class="n">gen</span><span class="p">():</span>

            <span class="k">for</span> <span class="n">market_book</span> <span class="ow">in</span> <span class="n">market_books</span><span class="p">:</span>

                <span class="c1"># If markets don&#39;t meet filter return None&#39;s</span>
                <span class="k">if</span> <span class="n">evaluate_market</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">((</span><span class="n">evaluate_market</span> <span class="o">:=</span> <span class="n">filter_market</span><span class="p">(</span><span class="n">market_book</span><span class="p">))</span> <span class="o">==</span> <span class="kc">False</span><span class="p">):</span>
                    <span class="k">return</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

                <span class="c1"># final market view before market goes in play</span>
                <span class="k">if</span> <span class="n">prev_market</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">prev_market</span><span class="o">.</span><span class="n">inplay</span> <span class="o">!=</span> <span class="n">market_book</span><span class="o">.</span><span class="n">inplay</span><span class="p">:</span>
                    <span class="n">preplay_market</span> <span class="o">=</span> <span class="n">market_book</span>

                <span class="c1"># final market view before market goes is closed for settlement</span>
                <span class="k">if</span> <span class="n">prev_market</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">prev_market</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;OPEN&quot;</span> <span class="ow">and</span> <span class="n">market_book</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="n">prev_market</span><span class="o">.</span><span class="n">status</span><span class="p">:</span>
                    <span class="n">postplay_market</span> <span class="o">=</span> <span class="n">market_book</span>

                <span class="c1"># Calculate Seconds Till Scheduled Market Start Time</span>
                <span class="n">seconds_to_start</span> <span class="o">=</span> <span class="p">(</span><span class="n">market_book</span><span class="o">.</span><span class="n">market_definition</span><span class="o">.</span><span class="n">market_time</span> <span class="o">-</span> <span class="n">market_book</span><span class="o">.</span><span class="n">publish_time</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>

                <span class="c1"># Market at 3 mins before scheduled off</span>
                <span class="k">if</span> <span class="n">t3m_market</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">seconds_to_start</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="o">*</span><span class="mi">60</span><span class="p">:</span>
                    <span class="n">t3m_market</span> <span class="o">=</span> <span class="n">market_book</span>

                <span class="c1"># update reference to previous market</span>
                <span class="n">prev_market</span> <span class="o">=</span> <span class="n">market_book</span>

        <span class="c1"># If market didn&#39;t go inplay</span>
        <span class="k">if</span> <span class="n">postplay_market</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">preplay_market</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">preplay_market</span> <span class="o">=</span> <span class="n">postplay_market</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">t3m_market</span><span class="p">,</span> <span class="n">preplay_market</span><span class="p">,</span> <span class="n">postplay_market</span><span class="p">,</span> <span class="n">prev_market</span><span class="p">)</span> <span class="c1"># Final market is last prev_market</span>
</code></pre></div>
<h4 id="3-4-summarise-those-useful-objects-and-write-to-csv">3 &amp; 4: Summarise those useful objects and write to .csv<a class="headerlink" href="#3-4-summarise-those-useful-objects-and-write-to-csv" title="Permanent link">&para;</a></h4>
<ul>
<li>This next chunk contains a wrapper function that will do all the execution</li>
<li>It will open a csv output file</li>
<li>Use the load_markets utility to iterate over the .tar files</li>
<li>Use <code>betfairlightweight</code> to instantiate the special stream object</li>
<li>Pass that stream object to the extract_components_from_stream which will scan across the market states and pull out 4 key market books</li>
<li>Convert those marketbooks into simple summary numbers or dictionaries that will be written to the output .csv file</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">run_stream_parsing</span><span class="p">():</span>

    <span class="c1"># Run Pipeline</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;outputs/tho-odds.csv&quot;</span><span class="p">,</span> <span class="s2">&quot;w+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">output</span><span class="p">:</span>

        <span class="c1"># Write Column Headers To File</span>
        <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;market_id,event_date,country,track,market_name,selection_id,selection_name,result,bsp,ltp,matched_volume,atb_ladder_3m,atl_ladder_3m</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">file_obj</span> <span class="ow">in</span> <span class="n">load_markets</span><span class="p">(</span><span class="n">data_path</span><span class="p">):</span>

            <span class="c1"># Instantiate a &quot;stream&quot; object</span>
            <span class="n">stream</span> <span class="o">=</span> <span class="n">trading</span><span class="o">.</span><span class="n">streaming</span><span class="o">.</span><span class="n">create_historical_generator_stream</span><span class="p">(</span>
                <span class="n">file_path</span><span class="o">=</span><span class="n">file_obj</span><span class="p">,</span>
                <span class="n">listener</span><span class="o">=</span><span class="n">listener</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Extract key components according to the custom function above (outputs 4 objects)</span>
            <span class="p">(</span><span class="n">t3m_market</span><span class="p">,</span> <span class="n">preplay_market</span><span class="p">,</span> <span class="n">postplay_market</span><span class="p">,</span> <span class="n">final_market</span><span class="p">)</span> <span class="o">=</span> <span class="n">extract_components_from_stream</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>

            <span class="c1"># If no price data for market don&#39;t write to file</span>
            <span class="k">if</span> <span class="n">postplay_market</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span><span class="p">;</span> 

            <span class="c1"># Runner metadata and key fields available from final market book</span>
            <span class="n">runner_data</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s1">&#39;selection_id&#39;</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">selection_id</span><span class="p">,</span>
                    <span class="s1">&#39;selection_name&#39;</span><span class="p">:</span> <span class="nb">next</span><span class="p">((</span><span class="n">rd</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">rd</span> <span class="ow">in</span> <span class="n">final_market</span><span class="o">.</span><span class="n">market_definition</span><span class="o">.</span><span class="n">runners</span> <span class="k">if</span> <span class="n">rd</span><span class="o">.</span><span class="n">selection_id</span> <span class="o">==</span> <span class="n">r</span><span class="o">.</span><span class="n">selection_id</span><span class="p">),</span> <span class="kc">None</span><span class="p">),</span>
                    <span class="s1">&#39;selection_status&#39;</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
                    <span class="s1">&#39;sp&#39;</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">actual_sp</span>
                <span class="p">}</span>
                <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">final_market</span><span class="o">.</span><span class="n">runners</span> 
            <span class="p">]</span>

            <span class="c1"># Last Traded Price</span>
            <span class="c1"># _____________________</span>

            <span class="c1"># From the last marketbook before inplay or close</span>
            <span class="n">ltp</span> <span class="o">=</span> <span class="p">[</span><span class="n">runner</span><span class="o">.</span><span class="n">last_price_traded</span> <span class="k">for</span> <span class="n">runner</span> <span class="ow">in</span> <span class="n">preplay_market</span><span class="o">.</span><span class="n">runners</span><span class="p">]</span>

            <span class="c1"># Total Matched Volume  </span>
            <span class="c1"># _____________________</span>

            <span class="c1"># Calculates the traded volume across all traded price points for each selection</span>
            <span class="k">def</span> <span class="nf">ladder_traded_volume</span><span class="p">(</span><span class="n">ladder</span><span class="p">):</span>
                <span class="k">return</span><span class="p">(</span><span class="nb">sum</span><span class="p">([</span><span class="n">rung</span><span class="o">.</span><span class="n">size</span> <span class="k">for</span> <span class="n">rung</span> <span class="ow">in</span> <span class="n">ladder</span><span class="p">]))</span>

            <span class="n">selection_traded_volume</span> <span class="o">=</span> <span class="p">[</span> <span class="n">ladder_traded_volume</span><span class="p">(</span><span class="n">runner</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">traded_volume</span><span class="p">)</span> <span class="k">for</span> <span class="n">runner</span> <span class="ow">in</span> <span class="n">postplay_market</span><span class="o">.</span><span class="n">runners</span> <span class="p">]</span>

            <span class="c1"># Top 3 Ladder</span>
            <span class="c1"># ______________________</span>

            <span class="c1"># Extracts the top 3 price / stakes in available orders on both back and lay sides. Returns python dictionaries</span>

            <span class="k">def</span> <span class="nf">top_3_ladder</span><span class="p">(</span><span class="n">availableLadder</span><span class="p">):</span>
                <span class="n">out</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">price</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">volume</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">availableLadder</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>        
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">rung</span> <span class="ow">in</span> <span class="n">availableLadder</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]:</span>
                        <span class="n">price</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rung</span><span class="o">.</span><span class="n">price</span><span class="p">)</span>
                        <span class="n">volume</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rung</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
                    <span class="n">out</span><span class="p">[</span><span class="s2">&quot;price&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">price</span>
                    <span class="n">out</span><span class="p">[</span><span class="s2">&quot;volume&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">volume</span>
                    <span class="k">return</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

            <span class="c1"># Sometimes t-3 mins market book is empty</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">atb_ladder_3m</span> <span class="o">=</span> <span class="p">[</span> <span class="n">top_3_ladder</span><span class="p">(</span><span class="n">runner</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">available_to_back</span><span class="p">)</span> <span class="k">for</span> <span class="n">runner</span> <span class="ow">in</span> <span class="n">t3m_market</span><span class="o">.</span><span class="n">runners</span><span class="p">]</span>
                <span class="n">atl_ladder_3m</span> <span class="o">=</span> <span class="p">[</span> <span class="n">top_3_ladder</span><span class="p">(</span><span class="n">runner</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">available_to_lay</span><span class="p">)</span> <span class="k">for</span> <span class="n">runner</span> <span class="ow">in</span> <span class="n">t3m_market</span><span class="o">.</span><span class="n">runners</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">atb_ladder_3m</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">atl_ladder_3m</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="c1"># Writing To CSV</span>
            <span class="c1"># ______________________</span>

            <span class="k">for</span> <span class="p">(</span><span class="n">runnerMeta</span><span class="p">,</span> <span class="n">ltp</span><span class="p">,</span> <span class="n">selection_traded_volume</span><span class="p">,</span> <span class="n">atb_ladder_3m</span><span class="p">,</span> <span class="n">atl_ladder_3m</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">runner_data</span><span class="p">,</span> <span class="n">ltp</span><span class="p">,</span> <span class="n">selection_traded_volume</span><span class="p">,</span> <span class="n">atb_ladder_3m</span><span class="p">,</span> <span class="n">atl_ladder_3m</span><span class="p">):</span>

                <span class="k">if</span> <span class="n">runnerMeta</span><span class="p">[</span><span class="s1">&#39;selection_status&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;REMOVED&#39;</span><span class="p">:</span>

                    <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">final_market</span><span class="o">.</span><span class="n">market_id</span><span class="p">),</span>
                            <span class="n">final_market</span><span class="o">.</span><span class="n">market_definition</span><span class="o">.</span><span class="n">market_time</span><span class="p">,</span>
                            <span class="n">final_market</span><span class="o">.</span><span class="n">market_definition</span><span class="o">.</span><span class="n">country_code</span><span class="p">,</span>
                            <span class="n">final_market</span><span class="o">.</span><span class="n">market_definition</span><span class="o">.</span><span class="n">venue</span><span class="p">,</span>
                            <span class="n">final_market</span><span class="o">.</span><span class="n">market_definition</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                            <span class="n">runnerMeta</span><span class="p">[</span><span class="s1">&#39;selection_id&#39;</span><span class="p">],</span>
                            <span class="n">runnerMeta</span><span class="p">[</span><span class="s1">&#39;selection_name&#39;</span><span class="p">],</span>
                            <span class="n">runnerMeta</span><span class="p">[</span><span class="s1">&#39;selection_status&#39;</span><span class="p">],</span>
                            <span class="n">runnerMeta</span><span class="p">[</span><span class="s1">&#39;sp&#39;</span><span class="p">],</span>
                            <span class="n">ltp</span><span class="p">,</span>
                            <span class="n">selection_traded_volume</span><span class="p">,</span>
                            <span class="s1">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">atb_ladder_3m</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="c1"># Forcing the dictionaries to strings so we don&#39;t run into issues loading the csvs with the dictionary commas</span>
                            <span class="s1">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">atl_ladder_3m</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># This will execute the files (it took me ~2 hours for 2 months of data)</span>
<span class="c1">#run_stream_parsing()</span>
</code></pre></div>
<hr />
<h3 id="extending-this-code">Extending this code<a class="headerlink" href="#extending-this-code" title="Permanent link">&para;</a></h3>
<ul>
<li>Because this process is very slow you might want to save much more information than you think you need</li>
<li>For example I currently think I only want the best back and lay prices at t-3 mins before the off but I've saved the top 3 boxes in the available to back and lay ladders as dictionary strings</li>
<li>From these ladders I can retroactively calculate not only just the best back and lay prices but also WAP prices and also sizes at those boxes which I could use for much more accurate backtesting if I wanted to later without having can across the entire stream files again</li>
<li>I could easily save the entire open and traded orders ladders in the same way amongst many other ways of retaining more of the data for post-processing analysis</li>
</ul>
<p><img alt="Stream Ladder Columns" src="../img/ladderColumns.png" /></p>
<hr />
<h2 id="backtesting-analysis">Backtesting Analysis<a class="headerlink" href="#backtesting-analysis" title="Permanent link">&para;</a></h2>
<p>Let's take stock of where we are. We currently have model ratings (about 1.5 months worth) and Betfair Odds (2 months worth).</p>
<p>Circling back to the original backtesting context we needed to solve for 2 key questions:</p>
<ol>
<li>What would my predicted chance have been exactly for this selection in this market on this day in the past?</li>
<li>What would have I decided to bet at what odds (exactly) and for how much stake (exactly) based on this prediction?</li>
</ol>
<p>Backtesting with someone else's publicly available and historically logged ratings solves question 1. With these particular ratings we're fine but generally we should just be aware there are some sketchy services that might make retroactive adjustments to historical ratings to juice their performance which obviously violates 1.</p>
<p>For the second part we now have several real Betfair odds values to combine with the ratings and some chosen staking formula to simulate actual bets. I won't dwell too much on the stake size component but it's important.</p>
<p>Similarly we aren't out of the woods with the "what odds exactly" question either. I'll show performance of backtesting at the "Last Traded Price" however, there's literally no way of actually being the last bet matched order on every exchange market so there's some uncertainty in a few of these prices.</p>
<p>Further, and from experience, if you placing bets at the BSP and you're using some form of proportional staking (like Kelly) then you're calculated stake size will need to include a quantity (the BSP) which you will literally never be 100% sure of. You'll need to estimate the BSP as close to market suspension as you can and place your BSP bets with a stake sized derived from that estimation. This imprecision in stake calculation WILL cost you some profit relative to your backtested expectation.</p>
<p>These might seem like minor considerations but you should be aware of some of the gory details of the many ways becoming successful on Betfair is really difficult. To be reliably profitable on Betfair you don't just need a good model, you'll likely need to spend hours and hours thinking about these things: testing things, ironing out all these little kinks and trying to account for all your uncertainties. I'll just be running over the skeleton of what you should do.</p>
<hr />
<h3 id="setting-up-your-master-data">Setting up your master data<a class="headerlink" href="#setting-up-your-master-data" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># First we&#39;ll load and tidy our odds data</span>

<span class="c1"># Load in odds file we created above</span>
<span class="n">bfOdds</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;outputs/tho-odds.csv&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;market_id&#39;</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="s1">&#39;selection_id&#39;</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="s1">&#39;atb_ladder_3m&#39;</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="s1">&#39;atl_ladder_3m&#39;</span><span class="p">:</span> <span class="nb">object</span><span class="p">})</span>

<span class="c1"># Convert dictionary columns</span>
<span class="kn">import</span> <span class="nn">ast</span>
<span class="n">bfOdds</span><span class="p">[</span><span class="s1">&#39;atb_ladder_3m&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">bfOdds</span><span class="p">[</span><span class="s1">&#39;atb_ladder_3m&#39;</span><span class="p">]]</span>
<span class="n">bfOdds</span><span class="p">[</span><span class="s1">&#39;atl_ladder_3m&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">bfOdds</span><span class="p">[</span><span class="s1">&#39;atl_ladder_3m&#39;</span><span class="p">]]</span>

<span class="c1"># Convert LTP to Numeric</span>
<span class="n">bfOdds</span><span class="p">[</span><span class="s1">&#39;ltp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">bfOdds</span><span class="p">[</span><span class="s1">&#39;ltp&#39;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;coerce&#39;</span><span class="p">)</span>

<span class="c1"># Filter after 18th Feb</span>
<span class="n">bfOdds</span> <span class="o">=</span> <span class="n">bfOdds</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;event_date &gt;= &quot;2021-02-18&quot;&#39;</span><span class="p">)</span>

<span class="n">bfOdds</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</code></pre></div>
<table>
<thead>
<tr>
<th>market_id</th>
<th>event_date</th>
<th>country</th>
<th>track</th>
<th>market_name</th>
<th>selection_id</th>
<th>selection_name</th>
<th>result</th>
<th>bsp</th>
<th>ltp</th>
<th>matched_volume</th>
<th>atb_ladder_3m</th>
<th>atl_ladder_3m</th>
</tr>
</thead>
<tbody>
<tr>
<td>1.179776179</td>
<td>2021-02-27 10:48:00</td>
<td>AU</td>
<td>Toowoomba</td>
<td>R7 1000m Mdn</td>
<td>31552374</td>
<td>2. Chubascos</td>
<td>LOSER</td>
<td>5.84</td>
<td>5.9</td>
<td>7390.59</td>
<td>{'price': [6, 5.9, 5.8], 'volume': [30.99, 82....</td>
<td>{'price': [6.2, 6.4, 6.6], 'volume': [4.99, 22...</td>
</tr>
<tr>
<td>1.179776179</td>
<td>2021-02-27 10:48:00</td>
<td>AU</td>
<td>Toowoomba</td>
<td>R7 1000m Mdn</td>
<td>38620171</td>
<td>3. Love You More</td>
<td>LOSER</td>
<td>65.00</td>
<td>70.0</td>
<td>1297.27</td>
<td>{'price': [65, 60, 55], 'volume': [2, 2.9, 15....</td>
<td>{'price': [75, 80, 85], 'volume': [0.66, 3.24,...</td>
</tr>
<tr>
<td>1.179776179</td>
<td>2021-02-27 10:48:00</td>
<td>AU</td>
<td>Toowoomba</td>
<td>R7 1000m Mdn</td>
<td>38620172</td>
<td>4. Splashing Rossa</td>
<td>LOSER</td>
<td>10.98</td>
<td>10.5</td>
<td>2665.94</td>
<td>{'price': [9, 8.8, 8.6], 'volume': [21.92, 10....</td>
<td>{'price': [9.6, 9.8, 10], 'volume': [13.43, 7....</td>
</tr>
<tr>
<td>1.179776179</td>
<td>2021-02-27 10:48:00</td>
<td>AU</td>
<td>Toowoomba</td>
<td>R7 1000m Mdn</td>
<td>38620173</td>
<td>5. The Fairytale</td>
<td>LOSER</td>
<td>54.56</td>
<td>50.0</td>
<td>221.13</td>
<td>{'price': [55, 50, 48], 'volume': [4.85, 2.85,...</td>
<td>{'price': [65, 70, 75], 'volume': [2.1, 7.18, ...</td>
</tr>
<tr>
<td>1.179776179</td>
<td>2021-02-27 10:48:00</td>
<td>AU</td>
<td>Toowoomba</td>
<td>R7 1000m Mdn</td>
<td>38620174</td>
<td>6. My Boy Dragon</td>
<td>LOSER</td>
<td>166.90</td>
<td>160.0</td>
<td>199.00</td>
<td>{'price': [140, 120, 110], 'volume': [0.36, 1....</td>
<td>{'price': [260, 270, 340], 'volume': [1.29, 2....</td>
</tr>
</tbody>
</table>
<p>When backtesting, and developing wagering systems more generally, I've found it really helpful to have a set of standard patterns or ways of representing common datasets. For a task like this it's really helpful to keep everything joined and together in a wide table.</p>
<p>So we want a dataframe with everything we need to conduct the backtest: your model ratings, the odds you're betting at, the results on the bets, and ultimately betting logic will all become columns in a dataframe.</p>
<p>It's helpful to have consistent column names so that the code for any new test you run looks much like previous tests and you can leverage custom functions that can be reused across tests and other projects. I like to have the following columns in my backtesting dataframe:</p>
<ul>
<li>date</li>
<li>market_id (can be a surrogate id if dealing with fixed odds markets)</li>
<li>selection_id (could be selection name)</li>
<li>win (a binary win loss)</li>
<li>model_odds</li>
<li>model_prob</li>
<li>market_odds</li>
<li>market_prob</li>
<li>bet_side</li>
<li>stake</li>
<li>gpl</li>
<li>commission</li>
<li>npl</li>
</ul>
<p>This analysis will be a little more complex as we're considering different price points so I'll leave out the <code>market_odds</code> and <code>market_prob</code> columns.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Joining the ratings data and odds data and combining</span>
<span class="n">rawDF</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
        <span class="n">hubRatings</span><span class="p">[</span><span class="n">hubRatings</span><span class="p">[</span><span class="s1">&#39;market_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">bfOdds</span><span class="o">.</span><span class="n">market_id</span><span class="o">.</span><span class="n">unique</span><span class="p">())],</span> 
        <span class="n">bfOdds</span><span class="p">[[</span><span class="s1">&#39;market_name&#39;</span><span class="p">,</span> <span class="s1">&#39;market_id&#39;</span><span class="p">,</span> <span class="s1">&#39;selection_id&#39;</span><span class="p">,</span> <span class="s1">&#39;result&#39;</span><span class="p">,</span> <span class="s1">&#39;matched_volume&#39;</span><span class="p">,</span> <span class="s1">&#39;bsp&#39;</span><span class="p">,</span> <span class="s1">&#39;ltp&#39;</span><span class="p">,</span> <span class="s1">&#39;atb_ladder_3m&#39;</span><span class="p">,</span> <span class="s1">&#39;atl_ladder_3m&#39;</span><span class="p">]],</span>
        <span class="n">on</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;market_id&#39;</span><span class="p">,</span> <span class="s1">&#39;selection_id&#39;</span><span class="p">],</span>
        <span class="n">how</span> <span class="o">=</span> <span class="s1">&#39;inner&#39;</span>
    <span class="p">)</span>

<span class="n">rawDF</span>
</code></pre></div>
<table>
<thead>
<tr>
<th>date</th>
<th>track</th>
<th>race_number</th>
<th>race_name</th>
<th>market_id</th>
<th>selection_id</th>
<th>selection_name</th>
<th>model_odds</th>
<th>market_name</th>
<th>result</th>
<th>matched_volume</th>
<th>bsp</th>
<th>ltp</th>
<th>atb_ladder_3m</th>
<th>atl_ladder_3m</th>
</tr>
</thead>
<tbody>
<tr>
<td>2021-02-18</td>
<td>DOOMBEN</td>
<td>1</td>
<td>R1 1200m 3yo</td>
<td>1.179418181</td>
<td>38523320</td>
<td>11. Vast Kama</td>
<td>34.28</td>
<td>R1 1200m 3yo</td>
<td>LOSER</td>
<td>1934.49</td>
<td>42.00</td>
<td>42.0</td>
<td>{'price': [30, 29, 28], 'volume': [4.01, 6.15,...</td>
<td>{'price': [32, 34, 36], 'volume': [1.76, 27.55...</td>
</tr>
<tr>
<td>2021-02-18</td>
<td>DOOMBEN</td>
<td>1</td>
<td>R1 1200m 3yo</td>
<td>1.179418181</td>
<td>38523319</td>
<td>10. Triptonic</td>
<td>21.22</td>
<td>R1 1200m 3yo</td>
<td>LOSER</td>
<td>1710.76</td>
<td>23.87</td>
<td>23.0</td>
<td>{'price': [30, 29, 28], 'volume': [24.72, 2.99...</td>
<td>{'price': [32, 34, 36], 'volume': [0.4, 5.87, ...</td>
</tr>
<tr>
<td>2021-02-18</td>
<td>DOOMBEN</td>
<td>1</td>
<td>R1 1200m 3yo</td>
<td>1.179418181</td>
<td>35773035</td>
<td>9. Right Reason</td>
<td>10.23</td>
<td>R1 1200m 3yo</td>
<td>LOSER</td>
<td>5524.11</td>
<td>12.50</td>
<td>11.5</td>
<td>{'price': [9.4, 9.2, 9], 'volume': [6.22, 15.1...</td>
<td>{'price': [9.6, 9.8, 10], 'volume': [11.19, 0....</td>
</tr>
<tr>
<td>2021-02-18</td>
<td>DOOMBEN</td>
<td>1</td>
<td>R1 1200m 3yo</td>
<td>1.179418181</td>
<td>38523318</td>
<td>8. Off Road</td>
<td>40.75</td>
<td>R1 1200m 3yo</td>
<td>LOSER</td>
<td>1506.51</td>
<td>35.31</td>
<td>34.0</td>
<td>{'price': [30, 29, 28], 'volume': [5.52, 3.61,...</td>
<td>{'price': [36, 38, 40], 'volume': [6.37, 3.87,...</td>
</tr>
<tr>
<td>2021-02-18</td>
<td>DOOMBEN</td>
<td>1</td>
<td>R1 1200m 3yo</td>
<td>1.179418181</td>
<td>38523317</td>
<td>7. More Than Value</td>
<td>77.49</td>
<td>R1 1200m 3yo</td>
<td>LOSER</td>
<td>617.18</td>
<td>55.00</td>
<td>55.0</td>
<td>{'price': [65, 60, 55], 'volume': [0.26, 4, 8....</td>
<td>{'price': [70, 75, 80], 'volume': [0.67, 3.68,...</td>
</tr>
<tr>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr>
<td>2021-03-31</td>
<td>WARWICK FARM</td>
<td>8</td>
<td>R8 1300m Hcap</td>
<td>1.181250426</td>
<td>28092381</td>
<td>11. Born A Warrior</td>
<td>10.67</td>
<td>R8 1300m Hcap</td>
<td>LOSER</td>
<td>905.55</td>
<td>6.97</td>
<td>6.2</td>
<td>{'price': [6.2, 5.8, 5.1], 'volume': [7.98, 40...</td>
<td>{'price': [6.8, 7, 7.8], 'volume': [6.26, 41.5...</td>
</tr>
<tr>
<td>2021-03-31</td>
<td>WARWICK FARM</td>
<td>8</td>
<td>R8 1300m Hcap</td>
<td>1.181250426</td>
<td>38698010</td>
<td>12. Diva Bella</td>
<td>25.77</td>
<td>R8 1300m Hcap</td>
<td>LOSER</td>
<td>11.06</td>
<td>23.60</td>
<td>18.5</td>
<td>{'price': [23, 22, 18], 'volume': [0.31, 24.91...</td>
<td>{'price': [70, 75, 95], 'volume': [0.61, 3.5, ...</td>
</tr>
<tr>
<td>2021-03-31</td>
<td>WARWICK FARM</td>
<td>8</td>
<td>R8 1300m Hcap</td>
<td>1.181250426</td>
<td>28224034</td>
<td>13. Twice As Special</td>
<td>51.23</td>
<td>R8 1300m Hcap</td>
<td>LOSER</td>
<td>52.49</td>
<td>36.37</td>
<td>26.0</td>
<td>{'price': [30, 29, 26], 'volume': [13.84, 5.92...</td>
<td>{'price': [44, 50, 95], 'volume': [2.76, 1.66,...</td>
</tr>
<tr>
<td>2021-03-31</td>
<td>WARWICK FARM</td>
<td>8</td>
<td>R8 1300m Hcap</td>
<td>1.181250426</td>
<td>38913296</td>
<td>15. Rosie Riveter</td>
<td>24.92</td>
<td>R8 1300m Hcap</td>
<td>LOSER</td>
<td>58.65</td>
<td>9.72</td>
<td>11.0</td>
<td>{'price': [10.5, 10, 9.6], 'volume': [0.69, 28...</td>
<td>{'price': [11, 12.5, 19], 'volume': [3.87, 2.7...</td>
</tr>
<tr>
<td>2021-03-31</td>
<td>WARWICK FARM</td>
<td>8</td>
<td>R8 1300m Hcap</td>
<td>1.181250426</td>
<td>4973624</td>
<td>8. Celer</td>
<td>26.23</td>
<td>R8 1300m Hcap</td>
<td>LOSER</td>
<td>22.14</td>
<td>21.73</td>
<td>28.0</td>
<td>{'price': [24, 23, 20], 'volume': [1.55, 18.26...</td>
<td>{'price': [30, 65, 70], 'volume': [0.55, 1.55,...</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre><span></span><code><span class="n">df</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">rawDF</span>
    <span class="c1"># Extra Best Back + Lay 3 mins before of</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">best_back_3m</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;price&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;price&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;atb_ladder_3m&#39;</span><span class="p">]])</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">best_lay_3m</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;price&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;price&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;atl_ladder_3m&#39;</span><span class="p">]])</span>
    <span class="c1"># Coalesce LTP to BSP (about 60 rows)</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">ltp</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;ltp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">(),</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;bsp&quot;</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;ltp&quot;</span><span class="p">]))</span>
    <span class="c1"># Add a binary win / loss column</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">win</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;WINNER&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="c1"># Extra columns</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">model_prob</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;model_odds&#39;</span><span class="p">])</span>
    <span class="c1"># Reorder Columns</span>
    <span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;track&#39;</span><span class="p">,</span> <span class="s1">&#39;race_number&#39;</span><span class="p">,</span> <span class="s1">&#39;market_id&#39;</span><span class="p">,</span> <span class="s1">&#39;selection_id&#39;</span><span class="p">,</span> <span class="s1">&#39;bsp&#39;</span><span class="p">,</span> <span class="s1">&#39;ltp&#39;</span><span class="p">,</span><span class="s1">&#39;best_back_3m&#39;</span><span class="p">,</span><span class="s1">&#39;best_lay_3m&#39;</span><span class="p">,</span><span class="s1">&#39;atb_ladder_3m&#39;</span><span class="p">,</span> <span class="s1">&#39;atl_ladder_3m&#39;</span><span class="p">,</span> <span class="s1">&#39;model_prob&#39;</span><span class="p">,</span> <span class="s1">&#39;model_odds&#39;</span><span class="p">,</span> <span class="s1">&#39;win&#39;</span><span class="p">])</span>

<span class="p">)</span>

<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</code></pre></div>
<table>
<thead>
<tr>
<th>date</th>
<th>track</th>
<th>race_number</th>
<th>market_id</th>
<th>selection_id</th>
<th>bsp</th>
<th>ltp</th>
<th>best_back_3m</th>
<th>best_lay_3m</th>
<th>atb_ladder_3m</th>
<th>atl_ladder_3m</th>
<th>model_prob</th>
<th>model_odds</th>
<th>win</th>
</tr>
</thead>
<tbody>
<tr>
<td>2021-02-18</td>
<td>DOOMBEN</td>
<td>1</td>
<td>1.179418181</td>
<td>38523320</td>
<td>42.00</td>
<td>42.0</td>
<td>30.0</td>
<td>32.0</td>
<td>{'price': [30, 29, 28], 'volume': [4.01, 6.15,...</td>
<td>{'price': [32, 34, 36], 'volume': [1.76, 27.55...</td>
<td>0.029172</td>
<td>34.28</td>
<td>0</td>
</tr>
<tr>
<td>2021-02-18</td>
<td>DOOMBEN</td>
<td>1</td>
<td>1.179418181</td>
<td>38523319</td>
<td>23.87</td>
<td>23.0</td>
<td>30.0</td>
<td>32.0</td>
<td>{'price': [30, 29, 28], 'volume': [24.72, 2.99...</td>
<td>{'price': [32, 34, 36], 'volume': [0.4, 5.87, ...</td>
<td>0.047125</td>
<td>21.22</td>
<td>0</td>
</tr>
<tr>
<td>2021-02-18</td>
<td>DOOMBEN</td>
<td>1</td>
<td>1.179418181</td>
<td>35773035</td>
<td>12.50</td>
<td>11.5</td>
<td>9.4</td>
<td>9.6</td>
<td>{'price': [9.4, 9.2, 9], 'volume': [6.22, 15.1...</td>
<td>{'price': [9.6, 9.8, 10], 'volume': [11.19, 0....</td>
<td>0.097752</td>
<td>10.23</td>
<td>0</td>
</tr>
<tr>
<td>2021-02-18</td>
<td>DOOMBEN</td>
<td>1</td>
<td>1.179418181</td>
<td>38523318</td>
<td>35.31</td>
<td>34.0</td>
<td>30.0</td>
<td>36.0</td>
<td>{'price': [30, 29, 28], 'volume': [5.52, 3.61,...</td>
<td>{'price': [36, 38, 40], 'volume': [6.37, 3.87,...</td>
<td>0.024540</td>
<td>40.75</td>
<td>0</td>
</tr>
<tr>
<td>2021-02-18</td>
<td>DOOMBEN</td>
<td>1</td>
<td>1.179418181</td>
<td>38523317</td>
<td>55.00</td>
<td>55.0</td>
<td>65.0</td>
<td>70.0</td>
<td>{'price': [65, 60, 55], 'volume': [0.26, 4, 8....</td>
<td>{'price': [70, 75, 80], 'volume': [0.67, 3.68,...</td>
<td>0.012905</td>
<td>77.49</td>
<td>0</td>
</tr>
</tbody>
</table>
<hr />
<h3 id="staking-outcome-functions">Staking + Outcome Functions<a class="headerlink" href="#staking-outcome-functions" title="Permanent link">&para;</a></h3>
<p>Now we can create a set of standard staking functions that a dataframe with an expected set of columns and add staking and bet outcome fields.</p>
<p>We'll also add the ability of these functions to reference a different odds column so that we can backtest against our different price points.</p>
<p>For simplicity we'll assume you're paying 5% commission on winnings however it could be higher or lower and depends on the MBR of the market.</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">bet_apply_commission</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">com</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">):</span>

    <span class="c1"># Total Market GPL</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;market_gpl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;market_id&#39;</span><span class="p">)[</span><span class="s1">&#39;gpl&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="nb">sum</span><span class="p">)</span>

    <span class="c1"># Apply 5% commission</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;market_commission&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;market_gpl&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;market_gpl&#39;</span><span class="p">])</span>

    <span class="c1"># Sum of Market Winning Bets</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;floored_gpl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;gpl&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;gpl&#39;</span><span class="p">])</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;market_netwinnings&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;market_id&#39;</span><span class="p">)[</span><span class="s1">&#39;floored_gpl&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="nb">sum</span><span class="p">)</span>

    <span class="c1"># Partition Commission According to Selection GPL</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;commission&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;market_netwinnings&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;market_commission&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;floored_gpl&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;market_netwinnings&#39;</span><span class="p">]))</span>

    <span class="c1"># Calculate Selection NPL</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;npl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;gpl&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;commission&#39;</span><span class="p">]</span>

    <span class="c1"># Drop excess columns</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;floored_gpl&#39;</span><span class="p">,</span> <span class="s1">&#39;market_netwinnings&#39;</span><span class="p">,</span> <span class="s1">&#39;market_commission&#39;</span><span class="p">,</span> <span class="s1">&#39;market_gpl&#39;</span><span class="p">])</span>

    <span class="k">return</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">bet_flat</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">stake</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">back_odds</span> <span class="o">=</span> <span class="s1">&#39;market_odds&#39;</span><span class="p">,</span> <span class="n">lay_odds</span> <span class="o">=</span> <span class="s1">&#39;market_odds&#39;</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Betting DF should always contain: model_odds, and win (binary encoded), and the specified odds column columns</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;bet_side&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;model_odds&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">df</span><span class="p">[</span><span class="n">back_odds</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;model_odds&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">df</span><span class="p">[</span><span class="n">lay_odds</span><span class="p">]),</span>
                        <span class="s2">&quot;P&quot;</span><span class="p">,</span> <span class="c1"># PUSH</span>
                       <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;model_odds&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">df</span><span class="p">[</span><span class="n">back_odds</span><span class="p">],</span>
                            <span class="s2">&quot;B&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;L&quot;</span>
                        <span class="p">)</span>
                       <span class="p">)</span>

    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;stake&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;bet_side&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;P&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">stake</span><span class="p">)</span>

    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;gpl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;bet_side&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;B&quot;</span><span class="p">,</span> 
                         <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;win&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;stake&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">back_odds</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="o">-</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;stake&#39;</span><span class="p">]),</span> <span class="c1"># PL for back bets</span>
                         <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;win&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;stake&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">lay_odds</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;stake&#39;</span><span class="p">])</span> <span class="c1"># PL for lay bets</span>
                        <span class="p">)</span>   

    <span class="c1"># Apply commission and NPL</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">bet_apply_commission</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

    <span class="k">return</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">bet_kelly</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">stake</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">back_odds</span> <span class="o">=</span> <span class="s1">&#39;market_odds&#39;</span><span class="p">,</span> <span class="n">lay_odds</span> <span class="o">=</span> <span class="s1">&#39;market_odds&#39;</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Betting DF should always contain: model_odds, and win (binary encoded), and the specified odds column columns</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;bet_side&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;model_odds&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">df</span><span class="p">[</span><span class="n">back_odds</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;model_odds&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">df</span><span class="p">[</span><span class="n">lay_odds</span><span class="p">]),</span>
                            <span class="s2">&quot;P&quot;</span><span class="p">,</span> <span class="c1"># PUSH</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                                <span class="n">df</span><span class="p">[</span><span class="s2">&quot;model_odds&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">df</span><span class="p">[</span><span class="n">back_odds</span><span class="p">],</span>
                                <span class="s2">&quot;B&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;L&quot;</span>
                            <span class="p">)</span>
                       <span class="p">)</span>

    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;stake&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;bet_side&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;P&quot;</span><span class="p">,</span> <span class="c1"># PUSH</span>
                           <span class="mi">0</span><span class="p">,</span>
                           <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                             <span class="n">df</span><span class="p">[</span><span class="s1">&#39;bet_side&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;B&quot;</span><span class="p">,</span>
                             <span class="p">(</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;model_odds&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="n">back_odds</span><span class="p">])</span> <span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="n">back_odds</span><span class="p">])),</span>
                             <span class="p">(</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="n">lay_odds</span><span class="p">])</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;model_odds&#39;</span><span class="p">])</span> <span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="n">lay_odds</span><span class="p">])),</span>
                           <span class="p">)</span>
                          <span class="p">)</span>

    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;gpl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;bet_side&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;B&quot;</span><span class="p">,</span> 
                         <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;win&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;stake&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">back_odds</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="o">-</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;stake&#39;</span><span class="p">]),</span> <span class="c1"># PL for back bets</span>
                         <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;win&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;stake&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">lay_odds</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;stake&#39;</span><span class="p">])</span> <span class="c1"># PL for lay bets</span>
                        <span class="p">)</span>

    <span class="c1"># Apply commission and NPL</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">bet_apply_commission</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

    <span class="k">return</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># Testing one of these functions</span>
<span class="n">flat_bets_bsp</span> <span class="o">=</span> <span class="n">bet_flat</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">stake</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">back_odds</span> <span class="o">=</span> <span class="s1">&#39;bsp&#39;</span><span class="p">,</span> <span class="n">lay_odds</span> <span class="o">=</span> <span class="s1">&#39;bsp&#39;</span><span class="p">)</span>
<span class="n">flat_bets_bsp</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</code></pre></div>
<table>
<thead>
<tr>
<th>date</th>
<th>track</th>
<th>race_number</th>
<th>market_id</th>
<th>selection_id</th>
<th>bsp</th>
<th>ltp</th>
<th>best_back_3m</th>
<th>best_lay_3m</th>
<th>atb_ladder_3m</th>
<th>atl_ladder_3m</th>
<th>model_prob</th>
<th>model_odds</th>
<th>win</th>
<th>bet_side</th>
<th>stake</th>
<th>gpl</th>
<th>commission</th>
<th>npl</th>
</tr>
</thead>
<tbody>
<tr>
<td>2021-02-18</td>
<td>DOOMBEN</td>
<td>1</td>
<td>1.179418181</td>
<td>38523320</td>
<td>42.00</td>
<td>42.0</td>
<td>30.0</td>
<td>32.0</td>
<td>{'price': [30, 29, 28], 'volume': [4.01, 6.15,...</td>
<td>{'price': [32, 34, 36], 'volume': [1.76, 27.55...</td>
<td>0.029172</td>
<td>34.28</td>
<td>0</td>
<td>B</td>
<td>1</td>
<td>-1.0</td>
<td>0.0</td>
<td>-1.0</td>
</tr>
<tr>
<td>2021-02-18</td>
<td>DOOMBEN</td>
<td>1</td>
<td>1.179418181</td>
<td>38523319</td>
<td>23.87</td>
<td>23.0</td>
<td>30.0</td>
<td>32.0</td>
<td>{'price': [30, 29, 28], 'volume': [24.72, 2.99...</td>
<td>{'price': [32, 34, 36], 'volume': [0.4, 5.87, ...</td>
<td>0.047125</td>
<td>21.22</td>
<td>0</td>
<td>B</td>
<td>1</td>
<td>-1.0</td>
<td>0.0</td>
<td>-1.0</td>
</tr>
<tr>
<td>2021-02-18</td>
<td>DOOMBEN</td>
<td>1</td>
<td>1.179418181</td>
<td>35773035</td>
<td>12.50</td>
<td>11.5</td>
<td>9.4</td>
<td>9.6</td>
<td>{'price': [9.4, 9.2, 9], 'volume': [6.22, 15.1...</td>
<td>{'price': [9.6, 9.8, 10], 'volume': [11.19, 0....</td>
<td>0.097752</td>
<td>10.23</td>
<td>0</td>
<td>B</td>
<td>1</td>
<td>-1.0</td>
<td>0.0</td>
<td>-1.0</td>
</tr>
<tr>
<td>2021-02-18</td>
<td>DOOMBEN</td>
<td>1</td>
<td>1.179418181</td>
<td>38523318</td>
<td>35.31</td>
<td>34.0</td>
<td>30.0</td>
<td>36.0</td>
<td>{'price': [30, 29, 28], 'volume': [5.52, 3.61,...</td>
<td>{'price': [36, 38, 40], 'volume': [6.37, 3.87,...</td>
<td>0.024540</td>
<td>40.75</td>
<td>0</td>
<td>L</td>
<td>1</td>
<td>1.0</td>
<td>0.0</td>
<td>1.0</td>
</tr>
<tr>
<td>2021-02-18</td>
<td>DOOMBEN</td>
<td>1</td>
<td>1.179418181</td>
<td>38523317</td>
<td>55.00</td>
<td>55.0</td>
<td>65.0</td>
<td>70.0</td>
<td>{'price': [65, 60, 55], 'volume': [0.26, 4, 8....</td>
<td>{'price': [70, 75, 80], 'volume': [0.67, 3.68,...</td>
<td>0.012905</td>
<td>77.49</td>
<td>0</td>
<td>L</td>
<td>1</td>
<td>1.0</td>
<td>0.0</td>
<td>1.0</td>
</tr>
</tbody>
</table>
<hr />
<h3 id="evaluation-functions">Evaluation Functions<a class="headerlink" href="#evaluation-functions" title="Permanent link">&para;</a></h3>
<p>In my experience it's great to develop a suite of functions and analytical tools that really dig into every aspect of your simulated betting performance. You want to be as thorough and critical as possible, even when you're results are good.</p>
<p>Another tip to guide this process is to have a reasonable benchmark. Essentially no one wins at 10% POT on thoroughbreds at the BSP so if your analysis suggests you can... there's a bug. Similarly you almost certainly won't lose at more than &lt;-10%. Different sports and codes will have different realistic profitability ranges depending on the efficiency of the markets (will be roughly correlated to matched volume). Ruling out unreasonable results can save you a lot of time and delusion.</p>
<p>I'm keeping it pretty simple here but you might also want to create functions to analyse:</p>
<ul>
<li>Track / distance based performance</li>
<li>Performance across odds ranges</li>
<li>Profit volatility (maybe using sharpe ratio to optimise volatility - adjusted profit)</li>
<li>Date ranges (weeks / months etc)</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1"># Create simple PL and POT table</span>
<span class="k">def</span> <span class="nf">bet_eval_metrics</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">side</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">side</span><span class="p">:</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="p">(</span><span class="n">d</span>
         <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;bet_side&#39;</span><span class="p">,</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
         <span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s2">&quot;npl&quot;</span><span class="p">:</span> <span class="s2">&quot;sum&quot;</span><span class="p">,</span> <span class="s2">&quot;stake&quot;</span><span class="p">:</span> <span class="s2">&quot;sum&quot;</span><span class="p">})</span>
         <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">pot</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;npl&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;stake&#39;</span><span class="p">])</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">d</span>
         <span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s2">&quot;npl&quot;</span><span class="p">:</span> <span class="s2">&quot;sum&quot;</span><span class="p">,</span> <span class="s2">&quot;stake&quot;</span><span class="p">:</span> <span class="s2">&quot;sum&quot;</span><span class="p">})</span>
        <span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">pot</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;npl&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;stake&#39;</span><span class="p">])</span>

    <span class="k">return</span><span class="p">(</span><span class="n">metrics</span><span class="p">[</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;stake&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">])</span>

<span class="c1"># Cumulative PL by market to visually see trend and consistency</span>
<span class="k">def</span> <span class="nf">bet_eval_chart_cPl</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>

    <span class="n">d</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">d</span>
        <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;market_id&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s1">&#39;npl&#39;</span><span class="p">:</span> <span class="s1">&#39;sum&#39;</span><span class="p">})</span>
    <span class="p">)</span>

    <span class="n">d</span><span class="p">[</span><span class="s1">&#39;market_number&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>
    <span class="n">d</span><span class="p">[</span><span class="s1">&#39;cNpl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">npl</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>

    <span class="n">chart</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;market_number&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;cNpl&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Cumulative Net Profit&#39;</span><span class="p">,</span> <span class="n">template</span><span class="o">=</span><span class="s1">&#39;simple_white&#39;</span><span class="p">)</span>

    <span class="k">return</span><span class="p">(</span><span class="n">chart</span><span class="p">)</span>
</code></pre></div>
<p>To illustrate these evaluation functions let's analyse flat staking at the BSP.</p>
<div class="highlight"><pre><span></span><code><span class="n">bets</span> <span class="o">=</span> <span class="n">bet_flat</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">stake</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">back_odds</span> <span class="o">=</span> <span class="s1">&#39;bsp&#39;</span><span class="p">,</span> <span class="n">lay_odds</span> <span class="o">=</span> <span class="s1">&#39;bsp&#39;</span><span class="p">)</span>

<span class="n">bet_eval_metrics</span><span class="p">(</span><span class="n">bets</span><span class="p">,</span> <span class="n">side</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</code></pre></div>
<table>
<thead>
<tr>
<th>bet_side</th>
<th>npl</th>
<th>stake</th>
<th>pot</th>
</tr>
</thead>
<tbody>
<tr>
<td>B</td>
<td>-749.493788</td>
<td>8356</td>
<td>-0.089695</td>
</tr>
<tr>
<td>L</td>
<td>-268.499212</td>
<td>8592</td>
<td>-0.031250</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre><span></span><code><span class="n">bet_eval_chart_cPl</span><span class="p">(</span><span class="n">bets</span><span class="p">)</span>
</code></pre></div>
<p>So this isn't gonna build us an art gallery! This is to be expected though, it's not easy to make consistent profit certainly from free ratings sources available online.</p>
<p><img alt="Output graph" src="../img/graph1.png" /></p>
<hr />
<h3 id="testing-different-approaches">Testing different approaches<a class="headerlink" href="#testing-different-approaches" title="Permanent link">&para;</a></h3>
<p>We pulled those extra price points for a reason. Let's set up a little test harness that enables us to use different price points and bet using different staking functions.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># We&#39;ll test a 2 different staking schemes on 3 different price points</span>
<span class="n">grid</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;flat_bsp&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">bet_flat</span><span class="p">,</span> <span class="s2">&quot;bsp&quot;</span><span class="p">,</span> <span class="s2">&quot;bsp&quot;</span><span class="p">),</span>
        <span class="s2">&quot;flat_ltp&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">bet_flat</span><span class="p">,</span> <span class="s2">&quot;ltp&quot;</span><span class="p">,</span> <span class="s2">&quot;ltp&quot;</span><span class="p">),</span>
        <span class="s2">&quot;flat_3m&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">bet_flat</span><span class="p">,</span> <span class="s2">&quot;best_back_3m&quot;</span><span class="p">,</span> <span class="s2">&quot;best_lay_3m&quot;</span><span class="p">),</span>
        <span class="s2">&quot;kelly_bsp&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">bet_kelly</span><span class="p">,</span> <span class="s2">&quot;bsp&quot;</span><span class="p">,</span> <span class="s2">&quot;bsp&quot;</span><span class="p">),</span>
        <span class="s2">&quot;kelly_ltp&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">bet_kelly</span><span class="p">,</span> <span class="s2">&quot;ltp&quot;</span><span class="p">,</span> <span class="s2">&quot;ltp&quot;</span><span class="p">),</span>
        <span class="s2">&quot;kelly_3m&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">bet_kelly</span><span class="p">,</span> <span class="s2">&quot;best_back_3m&quot;</span><span class="p">,</span> <span class="s2">&quot;best_lay_3m&quot;</span><span class="p">)</span>
    <span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">metricSummary</span> <span class="o">=</span> <span class="kc">None</span>
<span class="k">for</span> <span class="n">strategy</span><span class="p">,</span> <span class="n">objects</span> <span class="ow">in</span> <span class="n">grid</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

    <span class="c1"># Assemble bets based on staking function and odds column</span>
    <span class="c1"># objects[0] is the staking function itself</span>
    <span class="n">bets</span> <span class="o">=</span> <span class="n">objects</span><span class="p">[</span><span class="mi">0</span><span class="p">](</span><span class="n">df</span><span class="p">,</span> <span class="n">back_odds</span> <span class="o">=</span> <span class="n">objects</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">lay_odds</span> <span class="o">=</span> <span class="n">objects</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

    <span class="c1"># Calculate the metrics and tag with strategy label</span>
    <span class="n">betMetrics</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">bet_eval_metrics</span><span class="p">(</span><span class="n">bets</span><span class="p">)</span>
        <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">strategy</span><span class="p">)</span>
        <span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;strategy&#39;</span><span class="p">,</span> <span class="s1">&#39;stake&#39;</span><span class="p">,</span> <span class="s1">&#39;npl&#39;</span><span class="p">,</span> <span class="s1">&#39;pot&#39;</span><span class="p">])</span>
    <span class="p">)</span>

    <span class="c1"># Init the betMetrics df or append if already exists</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">metricSummary</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">metricSummary</span><span class="p">,</span> <span class="n">betMetrics</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">metricSummary</span> <span class="o">=</span> <span class="n">betMetrics</span>

<span class="n">metricSummary</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;pot&#39;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div>
<table>
<thead>
<tr>
<th>strategy</th>
<th>stake</th>
<th>npl</th>
<th>pot</th>
</tr>
</thead>
<tbody>
<tr>
<td>kelly_ltp</td>
<td>754.496453</td>
<td>-31.814150</td>
<td>-0.042166</td>
</tr>
<tr>
<td>kelly_bsp</td>
<td>732.165110</td>
<td>-34.613773</td>
<td>-0.047276</td>
</tr>
<tr>
<td>flat_bsp</td>
<td>16948.000000</td>
<td>-1017.993000</td>
<td>-0.060066</td>
</tr>
<tr>
<td>flat_ltp</td>
<td>16949.000000</td>
<td>-1184.546000</td>
<td>-0.069889</td>
</tr>
<tr>
<td>flat_3m</td>
<td>15712.000000</td>
<td>-1225.123000</td>
<td>-0.077974</td>
</tr>
<tr>
<td>kelly_3m</td>
<td>614.135601</td>
<td>-50.469295</td>
<td>-0.082179</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre><span></span><code><span class="c1"># Compare Cumulative PL Charts</span>
<span class="n">cumulativePLs</span> <span class="o">=</span> <span class="kc">None</span>
<span class="k">for</span> <span class="n">strategy</span><span class="p">,</span> <span class="n">objects</span> <span class="ow">in</span> <span class="n">grid</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

    <span class="c1"># Assemble bets based on staking function and odds column</span>
    <span class="n">bets</span> <span class="o">=</span> <span class="n">objects</span><span class="p">[</span><span class="mi">0</span><span class="p">](</span><span class="n">df</span><span class="p">,</span> <span class="n">back_odds</span> <span class="o">=</span> <span class="n">objects</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">lay_odds</span> <span class="o">=</span> <span class="n">objects</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

    <span class="n">d</span> <span class="o">=</span> <span class="p">(</span>
           <span class="n">bets</span>
           <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;market_id&#39;</span><span class="p">)</span>
           <span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s1">&#39;npl&#39;</span><span class="p">:</span> <span class="s1">&#39;sum&#39;</span><span class="p">,</span> <span class="s1">&#39;stake&#39;</span><span class="p">:</span> <span class="s1">&#39;sum&#39;</span><span class="p">})</span>
    <span class="p">)</span>

    <span class="n">d</span><span class="p">[</span><span class="s1">&#39;market_number&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>
    <span class="c1"># Normalise to $10,000 stake for visual comparison</span>
    <span class="n">d</span><span class="p">[</span><span class="s1">&#39;npl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;npl&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">stake</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="mi">10000</span><span class="p">)</span>
    <span class="n">d</span><span class="p">[</span><span class="s1">&#39;cNpl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">npl</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
    <span class="n">d</span><span class="p">[</span><span class="s1">&#39;strategy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">strategy</span>

    <span class="c1"># Init the cumulativePLs df or append if already exists</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">cumulativePLs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">cumulativePLs</span><span class="p">,</span> <span class="n">d</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">cumulativePLs</span> <span class="o">=</span> <span class="n">d</span>

<span class="n">px</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">cumulativePLs</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;market_number&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;cNpl&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;strategy&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Cumulative Net Profit&#39;</span><span class="p">,</span> <span class="n">template</span><span class="o">=</span><span class="s1">&#39;simple_white&#39;</span><span class="p">)</span>
</code></pre></div>
<p><img alt="Output graph" src="../img/graph2.png" /></p>
<hr />
<h3 id="searching-for-profit">Searching For Profit<a class="headerlink" href="#searching-for-profit" title="Permanent link">&para;</a></h3>
<p>So this is often where you're going to arrive developing many wagering models: there's no indication of reliable long term profit. Where do you go from here?</p>
<p>TBH I think most people give up here. Because you're not a quitter though you've got 3 main option categories:</p>
<ol>
<li>Make the underlying model better</li>
<li>Search for better prices via detailed price analysis and clever bet placement</li>
<li>Try to find a subset of these selections with these ratings and these price points that are sustainably profitable</li>
</ol>
<p>Obviously each situation is different but I think option 3 isn't a bad way to go initially because it will definitely help you understand your model better. For a racing model you might want to split your performance by:</p>
<ul>
<li>tracks or states</li>
<li>track conditions or weather</li>
<li>barriers</li>
<li>race quality or grade</li>
<li>odds ranges</li>
<li>selection sample size (you likely perform worse on horses with little form for eg)</li>
<li>perceived model value</li>
</ul>
<p>Finding a big enough slice across those dimensions that's either really profitable or really losing might reveal to you a bug in the data or workflow in your model development that you can go back and fix.</p>
<p>As an example of a simple approach to selectiveness I'll quickly run through how being more selective about your perceived value might make a difference in final profitability.</p>
<p>So our best performing strategy using our simple analysis above was Kelly staking at the last traded price. We'll start with that but be aware of that there's no way of implementing a LTP bet placement engine, you could imagine a proxy being placing limit bets "just before" the race jumps which is a whole other kettle of fish.</p>
<p>Anyway, let's plot our profitability under this strategy at different perceived "edges". If we are more selective of only large overlays according to the hub's rated chance you can see we can increase the profitability.</p>
<div class="highlight"><pre><span></span><code><span class="n">bets</span> <span class="o">=</span> <span class="n">bet_kelly</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">back_odds</span> <span class="o">=</span> <span class="s1">&#39;ltp&#39;</span><span class="p">,</span> <span class="n">lay_odds</span> <span class="o">=</span> <span class="s1">&#39;ltp&#39;</span><span class="p">)</span>

<span class="n">metricSummary</span> <span class="o">=</span> <span class="kc">None</span>

<span class="k">for</span> <span class="n">bVal</span> <span class="ow">in</span> <span class="p">[</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">]:</span>
    <span class="k">for</span> <span class="n">lVal</span> <span class="ow">in</span> <span class="p">[</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">]:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">bets</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;((ltp-model_odds) / ltp) &gt; </span><span class="si">{}</span><span class="s1">  | ((model_odds-ltp) / ltp) &gt; </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bVal</span><span class="p">,</span> <span class="n">lVal</span><span class="p">))</span>

        <span class="n">betMetrics</span> <span class="o">=</span> <span class="n">bet_eval_metrics</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">side</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">betMetrics</span><span class="p">[</span><span class="s1">&#39;bVal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bVal</span>
        <span class="n">betMetrics</span><span class="p">[</span><span class="s1">&#39;lVal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lVal</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">metricSummary</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">metricSummary</span><span class="p">,</span> <span class="n">betMetrics</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">metricSummary</span> <span class="o">=</span> <span class="n">betMetrics</span>

<span class="n">metricSummary</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;pot&#39;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</code></pre></div>
<table>
<thead>
<tr>
<th>npl</th>
<th>stake</th>
<th>pot</th>
<th>bVal</th>
<th>lVal</th>
</tr>
</thead>
<tbody>
<tr>
<td>-18.059813</td>
<td>574.944431</td>
<td>-0.031411</td>
<td>0.3</td>
<td>0.30</td>
</tr>
<tr>
<td>-22.887791</td>
<td>628.302349</td>
<td>-0.036428</td>
<td>0.3</td>
<td>0.20</td>
</tr>
<tr>
<td>-24.509182</td>
<td>669.482514</td>
<td>-0.036609</td>
<td>0.3</td>
<td>0.05</td>
</tr>
<tr>
<td>-22.997908</td>
<td>614.528386</td>
<td>-0.037424</td>
<td>0.2</td>
<td>0.30</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre><span></span><code><span class="n">betsFilters</span> <span class="o">=</span> <span class="n">bets</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;((ltp-model_odds) / ltp) &gt; </span><span class="si">{}</span><span class="s1">  | ((model_odds-ltp) / ltp) &gt; </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">))</span>
<span class="n">bet_eval_chart_cPl</span><span class="p">(</span><span class="n">betsFilters</span><span class="p">)</span>
</code></pre></div>
<p><img alt="Output graph" src="../img/graph4.png" /></p>
<p>We were doing ok till the last 200 market nightmare! Might be one to test with more data.</p>
<ul>
<li>So we still haven't found a clear profitable edge with these ratings, however we got a bit closer to break even which is positive.</li>
<li>This step also indicates that this rating system performs better for large overlays which is a good model indicator (if you can't improve by selecting for larger overlays it's usually a sign you need to go back to the drawing board)</li>
<li>You could imagine a few more iterations of analysis you might be able to eek out a slight edge</li>
<li>However, be wary as these steps optimisation steps are very prone to overfitting so you need to be careful.</li>
</ul>
<hr />
<h2 id="conclusion-and-next-steps">Conclusion and Next Steps<a class="headerlink" href="#conclusion-and-next-steps" title="Permanent link">&para;</a></h2>
<p>While using someone else's model is easy it's also not likely to end in personal riches. Developing your own model with your own tools and on a sport or racing code you know about is probably where you should start. However, hopefully this short guide helps you think about what to do when you finish the modelling component:</p>
<blockquote>
<p>How much money will I win or lose if I started using this system to place bets with real money?</p>
</blockquote>
<p>If you want to expand this backtesting analysis, here's a list (in no particular order) of things that I've omitted or angles I might look at next:</p>
<ul>
<li>Get more data
-- more rating data and odds data is needed for draw a good conclusion about long term expectation</li>
<li>Cross reference performance against race or selection metadata (track, # races run etc.) to improve performance with betting selectivity</li>
<li>Extract more price points from the stream data to try to gain an pricing edge on these ratings</li>
</ul>
<hr />
<h3 id="over-to-you">Over to you<a class="headerlink" href="#over-to-you" title="Permanent link">&para;</a></h3>
<p>We're planning on writing some more tutorials to help make it easier to work with the JSON data sets. If there are particular examples or data sets you'd like to see us walk through <a href="mailto:data@betfair.com.au">please reach out</a>.</p>
<div class="admonition note">
<p class="admonition-title">Community support</p>
<ul>
<li>There's a really active <a href="https://betfairlightweight.herokuapp.com/"><code>betfairlightweight</code> Slack community</a> that's a great place to go to ask questions about the library and get support from other people who are also working in the space</li>
</ul>
</div>
<hr />
<h3 id="complete-code">Complete code<a class="headerlink" href="#complete-code" title="Permanent link">&para;</a></h3>
<p>Run the code from your ide by using <code>py &lt;filename&gt;.py</code>, making sure you amend the path to point to your input data. </p>
<p><a href="https://github.com/betfair-down-under/autoHubTutorials/blob/aa76784071aad7703266d53dead7a713815e6107/backtestRatings/main.py">Download from Github</a></p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">date</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">tarfile</span>
<span class="kn">import</span> <span class="nn">zipfile</span>
<span class="kn">import</span> <span class="nn">bz2</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">unittest.mock</span> <span class="kn">import</span> <span class="n">patch</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Set</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">zip_longest</span>
<span class="kn">import</span> <span class="nn">plotly.express</span> <span class="k">as</span> <span class="nn">px</span>

<span class="kn">import</span> <span class="nn">betfairlightweight</span>
<span class="kn">from</span> <span class="nn">betfairlightweight</span> <span class="kn">import</span> <span class="n">StreamListener</span>
<span class="kn">from</span> <span class="nn">betfairlightweight.resources.bettingresources</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">PriceSize</span><span class="p">,</span>
    <span class="n">MarketBook</span>
<span class="p">)</span>

<span class="o">%</span><span class="n">config</span> <span class="n">IPCompleter</span><span class="o">.</span><span class="n">greedy</span><span class="o">=</span><span class="kc">True</span>

<span class="c1">#### --------------------------</span>
<span class="c1">#### FUNCTIONS</span>
<span class="c1">#### --------------------------</span>

<span class="c1"># Function to return Pandas DF of hub ratings for a particular date</span>
<span class="k">def</span> <span class="nf">getHubRatings</span><span class="p">(</span><span class="n">dte</span><span class="p">):</span>

    <span class="c1"># Substitute the date into the URL</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;https://betfair-data-supplier-prod.herokuapp.com/api/widgets/kash-ratings-model/datasets?date=</span><span class="si">{}</span><span class="s1">presenter=RatingsPresenter&amp;json=true&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dte</span><span class="p">)</span>

    <span class="c1"># Convert the response into JSON</span>
    <span class="n">responseJson</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>

    <span class="n">hubList</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">responseJson</span><span class="p">:</span>
        <span class="k">return</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>


    <span class="c1"># Want an normalised table (1 row per selection)</span>
    <span class="c1"># Brute force / simple approach is to loop through meetings / races / runners and pull out the key fields</span>
    <span class="k">for</span> <span class="n">meeting</span> <span class="ow">in</span> <span class="n">responseJson</span><span class="p">[</span><span class="s1">&#39;meetings&#39;</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">race</span> <span class="ow">in</span> <span class="n">meeting</span><span class="p">[</span><span class="s1">&#39;races&#39;</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">runner</span> <span class="ow">in</span> <span class="n">race</span><span class="p">[</span><span class="s1">&#39;runners&#39;</span><span class="p">]:</span>
                <span class="n">hubList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="n">dte</span><span class="p">,</span>
                        <span class="s1">&#39;track&#39;</span><span class="p">:</span> <span class="n">meeting</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
                        <span class="s1">&#39;race_number&#39;</span><span class="p">:</span> <span class="n">race</span><span class="p">[</span><span class="s1">&#39;number&#39;</span><span class="p">],</span>
                        <span class="s1">&#39;race_name&#39;</span><span class="p">:</span> <span class="n">race</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
                        <span class="s1">&#39;market_id&#39;</span><span class="p">:</span> <span class="n">race</span><span class="p">[</span><span class="s1">&#39;bfExchangeMarketId&#39;</span><span class="p">],</span>
                        <span class="s1">&#39;selection_id&#39;</span><span class="p">:</span>  <span class="nb">str</span><span class="p">(</span><span class="n">runner</span><span class="p">[</span><span class="s1">&#39;bfExchangeSelectionId&#39;</span><span class="p">]),</span>
                        <span class="s1">&#39;selection_name&#39;</span><span class="p">:</span> <span class="n">runner</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
                        <span class="s1">&#39;model_odds&#39;</span><span class="p">:</span> <span class="n">runner</span><span class="p">[</span><span class="s1">&#39;ratedPrice&#39;</span><span class="p">]</span>
                    <span class="p">}</span>
                <span class="p">)</span>

    <span class="n">out</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">hubList</span><span class="p">)</span>

    <span class="k">return</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

<span class="c1"># rounding to 2 decimal places or returning &#39;&#39; if blank</span>
<span class="k">def</span> <span class="nf">as_str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">v</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">float</span> <span class="k">else</span> <span class="n">v</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>

<span class="c1"># splitting race name and returning the parts </span>
<span class="k">def</span> <span class="nf">split_anz_horse_market_name</span><span class="p">(</span><span class="n">market_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
    <span class="c1"># return race no, length, race type</span>
    <span class="c1"># input sample: R6 1400m Grp1</span>
    <span class="n">parts</span> <span class="o">=</span> <span class="n">market_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
    <span class="n">race_no</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># return example R6</span>
    <span class="n">race_len</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># return example 1400m</span>
    <span class="n">race_type</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="c1"># return example grp1, trot, pace</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">race_no</span><span class="p">,</span> <span class="n">race_len</span><span class="p">,</span> <span class="n">race_type</span><span class="p">)</span>

<span class="c1"># creating a flag that is True when markets are australian thoroughbreds</span>
<span class="k">def</span> <span class="nf">filter_market</span><span class="p">(</span><span class="n">market</span><span class="p">:</span> <span class="n">MarketBook</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span> 
    <span class="n">d</span> <span class="o">=</span> <span class="n">market</span><span class="o">.</span><span class="n">market_definition</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">country_code</span> <span class="o">==</span> <span class="s1">&#39;AU&#39;</span> 
        <span class="ow">and</span> <span class="n">d</span><span class="o">.</span><span class="n">market_type</span> <span class="o">==</span> <span class="s1">&#39;WIN&#39;</span> 
        <span class="ow">and</span> <span class="p">(</span><span class="n">c</span> <span class="o">:=</span> <span class="n">split_anz_horse_market_name</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">name</span><span class="p">)[</span><span class="mi">2</span><span class="p">])</span> <span class="o">!=</span> <span class="s1">&#39;trot&#39;</span> <span class="ow">and</span> <span class="n">c</span> <span class="o">!=</span> <span class="s1">&#39;pace&#39;</span><span class="p">)</span>

<span class="c1"># loading from tar and extracting files</span>
<span class="k">def</span> <span class="nf">load_markets</span><span class="p">(</span><span class="n">file_paths</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">file_path</span> <span class="ow">in</span> <span class="n">file_paths</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">iglob</span><span class="p">(</span><span class="n">file_path</span> <span class="o">+</span> <span class="s1">&#39;**/**/*.bz2&#39;</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">bz2</span><span class="o">.</span><span class="n">BZ2File</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
                <span class="k">yield</span> <span class="n">f</span>
                <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
            <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file_path</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="c1"># iterate through a tar archive</span>
            <span class="k">if</span> <span class="n">ext</span> <span class="o">==</span> <span class="s1">&#39;.tar&#39;</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">TarFile</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">archive</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">archive</span><span class="p">:</span>
                        <span class="k">yield</span> <span class="n">bz2</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">archive</span><span class="o">.</span><span class="n">extractfile</span><span class="p">(</span><span class="n">file</span><span class="p">))</span>
            <span class="c1"># or a zip archive</span>
            <span class="k">elif</span> <span class="n">ext</span> <span class="o">==</span> <span class="s1">&#39;.zip&#39;</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">archive</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">archive</span><span class="o">.</span><span class="n">namelist</span><span class="p">():</span>
                        <span class="k">yield</span> <span class="n">bz2</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">archive</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file</span><span class="p">))</span>

    <span class="k">return</span> <span class="kc">None</span>

<span class="c1"># Extract Components From Generated Stream</span>
<span class="k">def</span> <span class="nf">extract_components_from_stream</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>

    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s2">&quot;builtins.open&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">f</span><span class="p">,</span> <span class="n">_</span><span class="p">:</span> <span class="n">f</span><span class="p">):</span>   

        <span class="c1"># Will return 3 market books t-3mins marketbook, the last preplay marketbook and the final market book</span>
        <span class="n">evaluate_market</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">prev_market</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">postplay_market</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">preplay_market</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">t3m_market</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">gen</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">get_generator</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">market_books</span> <span class="ow">in</span> <span class="n">gen</span><span class="p">():</span>

            <span class="k">for</span> <span class="n">market_book</span> <span class="ow">in</span> <span class="n">market_books</span><span class="p">:</span>

                <span class="c1"># If markets don&#39;t meet filter return None&#39;s</span>
                <span class="k">if</span> <span class="n">evaluate_market</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">((</span><span class="n">evaluate_market</span> <span class="o">:=</span> <span class="n">filter_market</span><span class="p">(</span><span class="n">market_book</span><span class="p">))</span> <span class="o">==</span> <span class="kc">False</span><span class="p">):</span>
                    <span class="k">return</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

                <span class="c1"># final market view before market goes in play</span>
                <span class="k">if</span> <span class="n">prev_market</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">prev_market</span><span class="o">.</span><span class="n">inplay</span> <span class="o">!=</span> <span class="n">market_book</span><span class="o">.</span><span class="n">inplay</span><span class="p">:</span>
                    <span class="n">preplay_market</span> <span class="o">=</span> <span class="n">market_book</span>

                <span class="c1"># final market view before market goes is closed for settlement</span>
                <span class="k">if</span> <span class="n">prev_market</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">prev_market</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;OPEN&quot;</span> <span class="ow">and</span> <span class="n">market_book</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="n">prev_market</span><span class="o">.</span><span class="n">status</span><span class="p">:</span>
                    <span class="n">postplay_market</span> <span class="o">=</span> <span class="n">market_book</span>

                <span class="c1"># Calculate Seconds Till Scheduled Market Start Time</span>
                <span class="n">seconds_to_start</span> <span class="o">=</span> <span class="p">(</span><span class="n">market_book</span><span class="o">.</span><span class="n">market_definition</span><span class="o">.</span><span class="n">market_time</span> <span class="o">-</span> <span class="n">market_book</span><span class="o">.</span><span class="n">publish_time</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>

                <span class="c1"># Market at 3 mins before scheduled off</span>
                <span class="k">if</span> <span class="n">t3m_market</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">seconds_to_start</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="o">*</span><span class="mi">60</span><span class="p">:</span>
                    <span class="n">t3m_market</span> <span class="o">=</span> <span class="n">market_book</span>

                <span class="c1"># update reference to previous market</span>
                <span class="n">prev_market</span> <span class="o">=</span> <span class="n">market_book</span>

        <span class="c1"># If market didn&#39;t go inplay</span>
        <span class="k">if</span> <span class="n">postplay_market</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">preplay_market</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">preplay_market</span> <span class="o">=</span> <span class="n">postplay_market</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">t3m_market</span><span class="p">,</span> <span class="n">preplay_market</span><span class="p">,</span> <span class="n">postplay_market</span><span class="p">,</span> <span class="n">prev_market</span><span class="p">)</span> <span class="c1"># Final market is last prev_market</span>

<span class="k">def</span> <span class="nf">run_stream_parsing</span><span class="p">():</span>

    <span class="c1"># Run Pipeline</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;outputs/tho-odds.csv&quot;</span><span class="p">,</span> <span class="s2">&quot;w+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">output</span><span class="p">:</span>

        <span class="c1"># Write Column Headers To File</span>
        <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;market_id,event_date,country,track,market_name,selection_id,selection_name,result,bsp,ltp,matched_volume,atb_ladder_3m,atl_ladder_3m</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">file_obj</span> <span class="ow">in</span> <span class="n">load_markets</span><span class="p">(</span><span class="n">data_path</span><span class="p">):</span>

            <span class="c1"># Instantiate a &quot;stream&quot; object</span>
            <span class="n">stream</span> <span class="o">=</span> <span class="n">trading</span><span class="o">.</span><span class="n">streaming</span><span class="o">.</span><span class="n">create_historical_generator_stream</span><span class="p">(</span>
                <span class="n">file_path</span><span class="o">=</span><span class="n">file_obj</span><span class="p">,</span>
                <span class="n">listener</span><span class="o">=</span><span class="n">listener</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Extract key components according to the custom function above (outputs 4 objects)</span>
            <span class="p">(</span><span class="n">t3m_market</span><span class="p">,</span> <span class="n">preplay_market</span><span class="p">,</span> <span class="n">postplay_market</span><span class="p">,</span> <span class="n">final_market</span><span class="p">)</span> <span class="o">=</span> <span class="n">extract_components_from_stream</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>

            <span class="c1"># If no price data for market don&#39;t write to file</span>
            <span class="k">if</span> <span class="n">postplay_market</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span><span class="p">;</span> 

            <span class="c1"># Runner metadata and key fields available from final market book</span>
            <span class="n">runner_data</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s1">&#39;selection_id&#39;</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">selection_id</span><span class="p">,</span>
                    <span class="s1">&#39;selection_name&#39;</span><span class="p">:</span> <span class="nb">next</span><span class="p">((</span><span class="n">rd</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">rd</span> <span class="ow">in</span> <span class="n">final_market</span><span class="o">.</span><span class="n">market_definition</span><span class="o">.</span><span class="n">runners</span> <span class="k">if</span> <span class="n">rd</span><span class="o">.</span><span class="n">selection_id</span> <span class="o">==</span> <span class="n">r</span><span class="o">.</span><span class="n">selection_id</span><span class="p">),</span> <span class="kc">None</span><span class="p">),</span>
                    <span class="s1">&#39;selection_status&#39;</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
                    <span class="s1">&#39;sp&#39;</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">actual_sp</span>
                <span class="p">}</span>
                <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">final_market</span><span class="o">.</span><span class="n">runners</span> 
            <span class="p">]</span>

            <span class="c1"># Last Traded Price</span>
            <span class="c1"># _____________________</span>

            <span class="c1"># From the last marketbook before inplay or close</span>
            <span class="n">ltp</span> <span class="o">=</span> <span class="p">[</span><span class="n">runner</span><span class="o">.</span><span class="n">last_price_traded</span> <span class="k">for</span> <span class="n">runner</span> <span class="ow">in</span> <span class="n">preplay_market</span><span class="o">.</span><span class="n">runners</span><span class="p">]</span>

            <span class="c1"># Total Matched Volume  </span>
            <span class="c1"># _____________________</span>

            <span class="c1"># Calculates the traded volume across all traded price points for each selection</span>
            <span class="k">def</span> <span class="nf">ladder_traded_volume</span><span class="p">(</span><span class="n">ladder</span><span class="p">):</span>
                <span class="k">return</span><span class="p">(</span><span class="nb">sum</span><span class="p">([</span><span class="n">rung</span><span class="o">.</span><span class="n">size</span> <span class="k">for</span> <span class="n">rung</span> <span class="ow">in</span> <span class="n">ladder</span><span class="p">]))</span>

            <span class="n">selection_traded_volume</span> <span class="o">=</span> <span class="p">[</span> <span class="n">ladder_traded_volume</span><span class="p">(</span><span class="n">runner</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">traded_volume</span><span class="p">)</span> <span class="k">for</span> <span class="n">runner</span> <span class="ow">in</span> <span class="n">postplay_market</span><span class="o">.</span><span class="n">runners</span> <span class="p">]</span>

            <span class="c1"># Top 3 Ladder</span>
            <span class="c1"># ______________________</span>

            <span class="c1"># Extracts the top 3 price / stakes in available orders on both back and lay sides. Returns python dictionaries</span>

            <span class="k">def</span> <span class="nf">top_3_ladder</span><span class="p">(</span><span class="n">availableLadder</span><span class="p">):</span>
                <span class="n">out</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">price</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">volume</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">availableLadder</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>        
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">rung</span> <span class="ow">in</span> <span class="n">availableLadder</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]:</span>
                        <span class="n">price</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rung</span><span class="o">.</span><span class="n">price</span><span class="p">)</span>
                        <span class="n">volume</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rung</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
                    <span class="n">out</span><span class="p">[</span><span class="s2">&quot;price&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">price</span>
                    <span class="n">out</span><span class="p">[</span><span class="s2">&quot;volume&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">volume</span>
                    <span class="k">return</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

            <span class="c1"># Sometimes t-3 mins market book is empty</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">atb_ladder_3m</span> <span class="o">=</span> <span class="p">[</span> <span class="n">top_3_ladder</span><span class="p">(</span><span class="n">runner</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">available_to_back</span><span class="p">)</span> <span class="k">for</span> <span class="n">runner</span> <span class="ow">in</span> <span class="n">t3m_market</span><span class="o">.</span><span class="n">runners</span><span class="p">]</span>
                <span class="n">atl_ladder_3m</span> <span class="o">=</span> <span class="p">[</span> <span class="n">top_3_ladder</span><span class="p">(</span><span class="n">runner</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">available_to_lay</span><span class="p">)</span> <span class="k">for</span> <span class="n">runner</span> <span class="ow">in</span> <span class="n">t3m_market</span><span class="o">.</span><span class="n">runners</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">atb_ladder_3m</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">atl_ladder_3m</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="c1"># Writing To CSV</span>
            <span class="c1"># ______________________</span>

            <span class="k">for</span> <span class="p">(</span><span class="n">runnerMeta</span><span class="p">,</span> <span class="n">ltp</span><span class="p">,</span> <span class="n">selection_traded_volume</span><span class="p">,</span> <span class="n">atb_ladder_3m</span><span class="p">,</span> <span class="n">atl_ladder_3m</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">runner_data</span><span class="p">,</span> <span class="n">ltp</span><span class="p">,</span> <span class="n">selection_traded_volume</span><span class="p">,</span> <span class="n">atb_ladder_3m</span><span class="p">,</span> <span class="n">atl_ladder_3m</span><span class="p">):</span>

                <span class="k">if</span> <span class="n">runnerMeta</span><span class="p">[</span><span class="s1">&#39;selection_status&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;REMOVED&#39;</span><span class="p">:</span>

                    <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">final_market</span><span class="o">.</span><span class="n">market_id</span><span class="p">),</span>
                            <span class="n">final_market</span><span class="o">.</span><span class="n">market_definition</span><span class="o">.</span><span class="n">market_time</span><span class="p">,</span>
                            <span class="n">final_market</span><span class="o">.</span><span class="n">market_definition</span><span class="o">.</span><span class="n">country_code</span><span class="p">,</span>
                            <span class="n">final_market</span><span class="o">.</span><span class="n">market_definition</span><span class="o">.</span><span class="n">venue</span><span class="p">,</span>
                            <span class="n">final_market</span><span class="o">.</span><span class="n">market_definition</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                            <span class="n">runnerMeta</span><span class="p">[</span><span class="s1">&#39;selection_id&#39;</span><span class="p">],</span>
                            <span class="n">runnerMeta</span><span class="p">[</span><span class="s1">&#39;selection_name&#39;</span><span class="p">],</span>
                            <span class="n">runnerMeta</span><span class="p">[</span><span class="s1">&#39;selection_status&#39;</span><span class="p">],</span>
                            <span class="n">runnerMeta</span><span class="p">[</span><span class="s1">&#39;sp&#39;</span><span class="p">],</span>
                            <span class="n">ltp</span><span class="p">,</span>
                            <span class="n">selection_traded_volume</span><span class="p">,</span>
                            <span class="s1">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">atb_ladder_3m</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="c1"># Forcing the dictionaries to strings so we don&#39;t run into issues loading the csvs with the dictionary commas</span>
                            <span class="s1">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">atl_ladder_3m</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span>
                        <span class="p">)</span>
                    <span class="p">)</span>


<span class="k">def</span> <span class="nf">bet_apply_commission</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">com</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">):</span>

    <span class="c1"># Total Market GPL</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;market_gpl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;market_id&#39;</span><span class="p">)[</span><span class="s1">&#39;gpl&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="nb">sum</span><span class="p">)</span>

    <span class="c1"># Apply 5% commission</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;market_commission&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;market_gpl&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;market_gpl&#39;</span><span class="p">])</span>

    <span class="c1"># Sum of Market Winning Bets</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;floored_gpl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;gpl&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;gpl&#39;</span><span class="p">])</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;market_netwinnings&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;market_id&#39;</span><span class="p">)[</span><span class="s1">&#39;floored_gpl&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="nb">sum</span><span class="p">)</span>

    <span class="c1"># Partition Commission According to Selection GPL</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;commission&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;market_netwinnings&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;market_commission&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;floored_gpl&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;market_netwinnings&#39;</span><span class="p">]))</span>

    <span class="c1"># Calculate Selection NPL</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;npl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;gpl&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;commission&#39;</span><span class="p">]</span>

    <span class="c1"># Drop excess columns</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;floored_gpl&#39;</span><span class="p">,</span> <span class="s1">&#39;market_netwinnings&#39;</span><span class="p">,</span> <span class="s1">&#39;market_commission&#39;</span><span class="p">,</span> <span class="s1">&#39;market_gpl&#39;</span><span class="p">])</span>

    <span class="k">return</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">bet_flat</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">stake</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">back_odds</span> <span class="o">=</span> <span class="s1">&#39;market_odds&#39;</span><span class="p">,</span> <span class="n">lay_odds</span> <span class="o">=</span> <span class="s1">&#39;market_odds&#39;</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Betting DF should always contain: model_odds, and win (binary encoded), and the specified odds column columns</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;bet_side&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;model_odds&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">df</span><span class="p">[</span><span class="n">back_odds</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;model_odds&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">df</span><span class="p">[</span><span class="n">lay_odds</span><span class="p">]),</span>
                        <span class="s2">&quot;P&quot;</span><span class="p">,</span>
                       <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;model_odds&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">df</span><span class="p">[</span><span class="n">back_odds</span><span class="p">],</span>
                            <span class="s2">&quot;B&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;L&quot;</span>
                        <span class="p">)</span>
                       <span class="p">)</span>

    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;stake&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;bet_side&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;P&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">stake</span><span class="p">)</span>

    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;gpl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;bet_side&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;B&quot;</span><span class="p">,</span> 
                         <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;win&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;stake&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">back_odds</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="o">-</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;stake&#39;</span><span class="p">]),</span> <span class="c1"># PL for back bets</span>
                         <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;win&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;stake&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">lay_odds</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;stake&#39;</span><span class="p">])</span> <span class="c1"># PL for lay bets</span>
                        <span class="p">)</span>   

    <span class="c1"># Apply commission and NPL</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">bet_apply_commission</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

    <span class="k">return</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">bet_kelly</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">stake</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">back_odds</span> <span class="o">=</span> <span class="s1">&#39;market_odds&#39;</span><span class="p">,</span> <span class="n">lay_odds</span> <span class="o">=</span> <span class="s1">&#39;market_odds&#39;</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Betting DF should always contain: model_odds, and win (binary encoded), and the specified odds column columns</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;bet_side&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;model_odds&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">df</span><span class="p">[</span><span class="n">back_odds</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;model_odds&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">df</span><span class="p">[</span><span class="n">lay_odds</span><span class="p">]),</span>
                            <span class="s2">&quot;P&quot;</span><span class="p">,</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                                <span class="n">df</span><span class="p">[</span><span class="s2">&quot;model_odds&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">df</span><span class="p">[</span><span class="n">back_odds</span><span class="p">],</span>
                                <span class="s2">&quot;B&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;L&quot;</span>
                            <span class="p">)</span>
                       <span class="p">)</span>

    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;stake&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;bet_side&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;P&quot;</span><span class="p">,</span>
                           <span class="mi">0</span><span class="p">,</span>
                           <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                             <span class="n">df</span><span class="p">[</span><span class="s1">&#39;bet_side&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;B&quot;</span><span class="p">,</span>
                             <span class="p">(</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;model_odds&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="n">back_odds</span><span class="p">])</span> <span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="n">back_odds</span><span class="p">])),</span>
                             <span class="p">(</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="n">lay_odds</span><span class="p">])</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;model_odds&#39;</span><span class="p">])</span> <span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="n">lay_odds</span><span class="p">])),</span>
                           <span class="p">)</span>
                          <span class="p">)</span>

    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;gpl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;bet_side&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;B&quot;</span><span class="p">,</span> 
                         <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;win&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;stake&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">back_odds</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="o">-</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;stake&#39;</span><span class="p">]),</span> <span class="c1"># PL for back bets</span>
                         <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;win&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;stake&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">lay_odds</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;stake&#39;</span><span class="p">])</span> <span class="c1"># PL for lay bets</span>
                        <span class="p">)</span>

    <span class="c1"># Apply commission and NPL</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">bet_apply_commission</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

    <span class="k">return</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>


<span class="c1"># Create simple PL and POT table</span>
<span class="k">def</span> <span class="nf">bet_eval_metrics</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">side</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">side</span><span class="p">:</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="p">(</span><span class="n">d</span>
         <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;bet_side&#39;</span><span class="p">,</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
         <span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s2">&quot;npl&quot;</span><span class="p">:</span> <span class="s2">&quot;sum&quot;</span><span class="p">,</span> <span class="s2">&quot;stake&quot;</span><span class="p">:</span> <span class="s2">&quot;sum&quot;</span><span class="p">})</span>
         <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">pot</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;npl&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;stake&#39;</span><span class="p">])</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">d</span>
         <span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s2">&quot;npl&quot;</span><span class="p">:</span> <span class="s2">&quot;sum&quot;</span><span class="p">,</span> <span class="s2">&quot;stake&quot;</span><span class="p">:</span> <span class="s2">&quot;sum&quot;</span><span class="p">})</span>
        <span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">pot</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;npl&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;stake&#39;</span><span class="p">])</span>

    <span class="k">return</span><span class="p">(</span><span class="n">metrics</span><span class="p">[</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;stake&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">])</span>

<span class="c1"># Cumulative PL by market to visually see trend and consistency</span>
<span class="k">def</span> <span class="nf">bet_eval_chart_cPl</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>

    <span class="n">d</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">d</span>
        <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;market_id&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s1">&#39;npl&#39;</span><span class="p">:</span> <span class="s1">&#39;sum&#39;</span><span class="p">})</span>
    <span class="p">)</span>

    <span class="n">d</span><span class="p">[</span><span class="s1">&#39;market_number&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>
    <span class="n">d</span><span class="p">[</span><span class="s1">&#39;cNpl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">npl</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>

    <span class="n">chart</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;market_number&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;cNpl&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Cumulative Net Profit&#39;</span><span class="p">,</span> <span class="n">template</span><span class="o">=</span><span class="s1">&#39;simple_white&#39;</span><span class="p">)</span>

    <span class="k">return</span><span class="p">(</span><span class="n">chart</span><span class="p">)</span>


<span class="c1">#### --------------------------</span>
<span class="c1">#### EXECUTION</span>
<span class="c1">#### --------------------------</span>


<span class="c1"># Loop through all recent history</span>
<span class="n">dateDFList</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">dateList</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">date</span><span class="p">(</span><span class="mi">2021</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">18</span><span class="p">),</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">-</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span><span class="n">freq</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">dte</span> <span class="ow">in</span> <span class="n">dateList</span><span class="p">:</span>
    <span class="n">dateDFList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">getHubRatings</span><span class="p">(</span><span class="n">dte</span><span class="p">))</span>

<span class="c1"># Concatenate (add rows to rows) all the dataframes within the list</span>
<span class="n">hubRatings</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">dateDFList</span><span class="p">)</span>

<span class="c1"># create trading instance (don&#39;t need username/password)</span>
<span class="n">trading</span> <span class="o">=</span> <span class="n">betfairlightweight</span><span class="o">.</span><span class="n">APIClient</span><span class="p">(</span><span class="s2">&quot;username&quot;</span><span class="p">,</span> <span class="s2">&quot;password&quot;</span><span class="p">)</span>

<span class="c1"># create listener</span>
<span class="n">listener</span> <span class="o">=</span> <span class="n">StreamListener</span><span class="p">(</span><span class="n">max_latency</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

<span class="c1"># This will execute the files (it took me ~2 hours for 2 months of data)</span>
<span class="c1">#run_stream_parsing()</span>

<span class="c1"># Load in odds file we created above</span>
<span class="n">bfOdds</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;outputs/tho-odds.csv&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;market_id&#39;</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="s1">&#39;selection_id&#39;</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="s1">&#39;atb_ladder_3m&#39;</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="s1">&#39;atl_ladder_3m&#39;</span><span class="p">:</span> <span class="nb">object</span><span class="p">})</span>

<span class="c1"># Convert dictionary columns</span>
<span class="kn">import</span> <span class="nn">ast</span>
<span class="n">bfOdds</span><span class="p">[</span><span class="s1">&#39;atb_ladder_3m&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">bfOdds</span><span class="p">[</span><span class="s1">&#39;atb_ladder_3m&#39;</span><span class="p">]]</span>
<span class="n">bfOdds</span><span class="p">[</span><span class="s1">&#39;atl_ladder_3m&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">bfOdds</span><span class="p">[</span><span class="s1">&#39;atl_ladder_3m&#39;</span><span class="p">]]</span>

<span class="c1"># Convert LTP to Numeric</span>
<span class="n">bfOdds</span><span class="p">[</span><span class="s1">&#39;ltp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">bfOdds</span><span class="p">[</span><span class="s1">&#39;ltp&#39;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;coerce&#39;</span><span class="p">)</span>

<span class="c1"># Filter after 18th Feb</span>
<span class="n">bfOdds</span> <span class="o">=</span> <span class="n">bfOdds</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;event_date &gt;= &quot;2021-02-18&quot;&#39;</span><span class="p">)</span>

<span class="c1"># Joining the ratings data and odds data and combining</span>
<span class="n">rawDF</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
        <span class="n">hubRatings</span><span class="p">[</span><span class="n">hubRatings</span><span class="p">[</span><span class="s1">&#39;market_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">bfOdds</span><span class="o">.</span><span class="n">market_id</span><span class="o">.</span><span class="n">unique</span><span class="p">())],</span> 
        <span class="n">bfOdds</span><span class="p">[[</span><span class="s1">&#39;market_name&#39;</span><span class="p">,</span> <span class="s1">&#39;market_id&#39;</span><span class="p">,</span> <span class="s1">&#39;selection_id&#39;</span><span class="p">,</span> <span class="s1">&#39;result&#39;</span><span class="p">,</span> <span class="s1">&#39;matched_volume&#39;</span><span class="p">,</span> <span class="s1">&#39;bsp&#39;</span><span class="p">,</span> <span class="s1">&#39;ltp&#39;</span><span class="p">,</span> <span class="s1">&#39;atb_ladder_3m&#39;</span><span class="p">,</span> <span class="s1">&#39;atl_ladder_3m&#39;</span><span class="p">]],</span>
        <span class="n">on</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;market_id&#39;</span><span class="p">,</span> <span class="s1">&#39;selection_id&#39;</span><span class="p">],</span>
        <span class="n">how</span> <span class="o">=</span> <span class="s1">&#39;inner&#39;</span>
    <span class="p">)</span>

<span class="c1"># Join and clean up columns</span>
<span class="n">df</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">rawDF</span>
    <span class="c1"># Extra Best Back + Lay 3 mins before of</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">best_back_3m</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;price&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;price&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;atb_ladder_3m&#39;</span><span class="p">]])</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">best_lay_3m</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;price&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;price&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;atl_ladder_3m&#39;</span><span class="p">]])</span>
    <span class="c1"># Coalesce LTP to BSP (about 60 rows)</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">ltp</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;ltp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">(),</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;bsp&quot;</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;ltp&quot;</span><span class="p">]))</span>
    <span class="c1"># Add a binary win / loss column</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">win</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;WINNER&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="c1"># Extra columns</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">model_prob</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;model_odds&#39;</span><span class="p">])</span>
    <span class="c1"># Reorder Columns</span>
    <span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;track&#39;</span><span class="p">,</span> <span class="s1">&#39;race_number&#39;</span><span class="p">,</span> <span class="s1">&#39;market_id&#39;</span><span class="p">,</span> <span class="s1">&#39;selection_id&#39;</span><span class="p">,</span> <span class="s1">&#39;bsp&#39;</span><span class="p">,</span> <span class="s1">&#39;ltp&#39;</span><span class="p">,</span><span class="s1">&#39;best_back_3m&#39;</span><span class="p">,</span><span class="s1">&#39;best_lay_3m&#39;</span><span class="p">,</span><span class="s1">&#39;atb_ladder_3m&#39;</span><span class="p">,</span> <span class="s1">&#39;atl_ladder_3m&#39;</span><span class="p">,</span> <span class="s1">&#39;model_prob&#39;</span><span class="p">,</span> <span class="s1">&#39;model_odds&#39;</span><span class="p">,</span> <span class="s1">&#39;win&#39;</span><span class="p">])</span>

<span class="p">)</span>


<span class="n">bets</span> <span class="o">=</span> <span class="n">bet_flat</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">stake</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">back_odds</span> <span class="o">=</span> <span class="s1">&#39;bsp&#39;</span><span class="p">,</span> <span class="n">lay_odds</span> <span class="o">=</span> <span class="s1">&#39;bsp&#39;</span><span class="p">)</span>

<span class="n">bet_eval_metrics</span><span class="p">(</span><span class="n">bets</span><span class="p">,</span> <span class="n">side</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

<span class="n">bet_eval_chart_cPl</span><span class="p">(</span><span class="n">bets</span><span class="p">)</span>


<span class="c1"># We&#39;ll test a 2 different staking schemes on 3 different price points</span>
<span class="n">grid</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;flat_bsp&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">bet_flat</span><span class="p">,</span> <span class="s2">&quot;bsp&quot;</span><span class="p">,</span> <span class="s2">&quot;bsp&quot;</span><span class="p">),</span>
        <span class="s2">&quot;flat_ltp&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">bet_flat</span><span class="p">,</span> <span class="s2">&quot;ltp&quot;</span><span class="p">,</span> <span class="s2">&quot;ltp&quot;</span><span class="p">),</span>
        <span class="s2">&quot;flat_3m&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">bet_flat</span><span class="p">,</span> <span class="s2">&quot;best_back_3m&quot;</span><span class="p">,</span> <span class="s2">&quot;best_lay_3m&quot;</span><span class="p">),</span>
        <span class="s2">&quot;kelly_bsp&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">bet_kelly</span><span class="p">,</span> <span class="s2">&quot;bsp&quot;</span><span class="p">,</span> <span class="s2">&quot;bsp&quot;</span><span class="p">),</span>
        <span class="s2">&quot;kelly_ltp&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">bet_kelly</span><span class="p">,</span> <span class="s2">&quot;ltp&quot;</span><span class="p">,</span> <span class="s2">&quot;ltp&quot;</span><span class="p">),</span>
        <span class="s2">&quot;kelly_3m&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">bet_kelly</span><span class="p">,</span> <span class="s2">&quot;best_back_3m&quot;</span><span class="p">,</span> <span class="s2">&quot;best_lay_3m&quot;</span><span class="p">)</span>
    <span class="p">}</span>


<span class="c1"># Evaluate Metrics For Strategy Grid</span>
<span class="n">metricSummary</span> <span class="o">=</span> <span class="kc">None</span>
<span class="k">for</span> <span class="n">strategy</span><span class="p">,</span> <span class="n">objects</span> <span class="ow">in</span> <span class="n">grid</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

    <span class="c1"># Assemble bets based on staking function and odds column</span>
    <span class="c1"># objects[0] is the staking function itself</span>
    <span class="n">bets</span> <span class="o">=</span> <span class="n">objects</span><span class="p">[</span><span class="mi">0</span><span class="p">](</span><span class="n">df</span><span class="p">,</span> <span class="n">back_odds</span> <span class="o">=</span> <span class="n">objects</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">lay_odds</span> <span class="o">=</span> <span class="n">objects</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

    <span class="n">betMetrics</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">bet_eval_metrics</span><span class="p">(</span><span class="n">bets</span><span class="p">)</span>
        <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">strategy</span><span class="p">)</span>
        <span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;strategy&#39;</span><span class="p">,</span> <span class="s1">&#39;stake&#39;</span><span class="p">,</span> <span class="s1">&#39;npl&#39;</span><span class="p">,</span> <span class="s1">&#39;pot&#39;</span><span class="p">])</span>
    <span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">metricSummary</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">metricSummary</span><span class="p">,</span> <span class="n">betMetrics</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">metricSummary</span> <span class="o">=</span> <span class="n">betMetrics</span>

<span class="n">metricSummary</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;pot&#39;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<span class="c1"># Compare Cumulative PL Charts</span>
<span class="n">cumulativePLs</span> <span class="o">=</span> <span class="kc">None</span>
<span class="k">for</span> <span class="n">strategy</span><span class="p">,</span> <span class="n">objects</span> <span class="ow">in</span> <span class="n">grid</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

    <span class="c1"># Assemble bets based on staking function and odds column</span>
    <span class="n">bets</span> <span class="o">=</span> <span class="n">objects</span><span class="p">[</span><span class="mi">0</span><span class="p">](</span><span class="n">df</span><span class="p">,</span> <span class="n">back_odds</span> <span class="o">=</span> <span class="n">objects</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">lay_odds</span> <span class="o">=</span> <span class="n">objects</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

    <span class="n">d</span> <span class="o">=</span> <span class="p">(</span>
           <span class="n">bets</span>
           <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;market_id&#39;</span><span class="p">)</span>
           <span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s1">&#39;npl&#39;</span><span class="p">:</span> <span class="s1">&#39;sum&#39;</span><span class="p">,</span> <span class="s1">&#39;stake&#39;</span><span class="p">:</span> <span class="s1">&#39;sum&#39;</span><span class="p">})</span>
    <span class="p">)</span>

    <span class="n">d</span><span class="p">[</span><span class="s1">&#39;market_number&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>
    <span class="c1"># Normalise to $10,000 stake for visual comparison</span>
    <span class="n">d</span><span class="p">[</span><span class="s1">&#39;npl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;npl&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">stake</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="mi">10000</span><span class="p">)</span>
    <span class="n">d</span><span class="p">[</span><span class="s1">&#39;cNpl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">npl</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
    <span class="n">d</span><span class="p">[</span><span class="s1">&#39;strategy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">strategy</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">cumulativePLs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">cumulativePLs</span><span class="p">,</span> <span class="n">d</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">cumulativePLs</span> <span class="o">=</span> <span class="n">d</span>

<span class="n">px</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">cumulativePLs</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;market_number&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;cNpl&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;strategy&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Cumulative Net Profit&#39;</span><span class="p">,</span> <span class="n">template</span><span class="o">=</span><span class="s1">&#39;simple_white&#39;</span><span class="p">)</span>


<span class="n">bets</span> <span class="o">=</span> <span class="n">bet_kelly</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">back_odds</span> <span class="o">=</span> <span class="s1">&#39;ltp&#39;</span><span class="p">,</span> <span class="n">lay_odds</span> <span class="o">=</span> <span class="s1">&#39;ltp&#39;</span><span class="p">)</span>

<span class="n">metricSummary</span> <span class="o">=</span> <span class="kc">None</span>

<span class="k">for</span> <span class="n">bVal</span> <span class="ow">in</span> <span class="p">[</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">]:</span>
    <span class="k">for</span> <span class="n">lVal</span> <span class="ow">in</span> <span class="p">[</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">]:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">bets</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;((ltp-model_odds) / ltp) &gt; </span><span class="si">{}</span><span class="s1">  | ((model_odds-ltp) / ltp) &gt; </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bVal</span><span class="p">,</span> <span class="n">lVal</span><span class="p">))</span>

        <span class="n">betMetrics</span> <span class="o">=</span> <span class="n">bet_eval_metrics</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">side</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">betMetrics</span><span class="p">[</span><span class="s1">&#39;bVal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bVal</span>
        <span class="n">betMetrics</span><span class="p">[</span><span class="s1">&#39;lVal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lVal</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">metricSummary</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">metricSummary</span><span class="p">,</span> <span class="n">betMetrics</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">metricSummary</span> <span class="o">=</span> <span class="n">betMetrics</span>

<span class="n">metricSummary</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;pot&#39;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>

<span class="n">betsFilters</span> <span class="o">=</span> <span class="n">bets</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;((ltp-model_odds) / ltp) &gt; </span><span class="si">{}</span><span class="s1">  | ((model_odds-ltp) / ltp) &gt; </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">))</span>
<span class="n">bet_eval_chart_cPl</span><span class="p">(</span><span class="n">betsFilters</span><span class="p">)</span>
</code></pre></div>
<hr />
<h3 id="disclaimer">Disclaimer<a class="headerlink" href="#disclaimer" title="Permanent link">&para;</a></h3>
<p>Note that whilst models and automated strategies are fun and rewarding to create, we can't promise that your model or betting strategy will be profitable, and we make no representations in relation to the code shared or information on this page. If you're using this code or implementing your own strategies, you do so entirely at your own risk and you are responsible for any winnings/losses incurred. Under no circumstances will Betfair be liable for any loss or damage you suffer.</p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../jsonToCsvTutorial/" title="JSON to CSV tutorial" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                JSON to CSV tutorial
              </span>
            </div>
          </a>
        
        
          <a href="../../modelling/howToModel/" title="Intro to modelling" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Intro to modelling
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
      </div>
      
        
  <div class="md-footer-social">
    <link rel="stylesheet" href="../../assets/fonts/font-awesome.css">
    
      <a href="https://twitter.com/Betfair_Aus" class="md-footer-social__link fa fa-twitter"></a>
    
      <a href="https://linkedin.com/company/betfair-australia" class="md-footer-social__link fa fa-linkedin"></a>
    
      <a href="https://facebook.com/betfairaustralia" class="md-footer-social__link fa fa-facebook"></a>
    
      <a href="https://youtube.com/user/betfairaus" class="md-footer-social__link fa fa-youtube"></a>
    
      <a href="https://github.com/betfair-datascientists" class="md-footer-social__link fa fa-github"></a>
    
  </div>

      
    </div>
    <div class="bf-footer">
      <p class="bf-light">Betfair Pty Limited is licensed and regulated by the Northern Territory Government of Australia.</p>
      <p class="bf-dark">Betfair Pty Limited's gambling operations are governed by its Responsible Gambling Code of Conduct and for South
      Australian residents by the South Australian Responsible Gambling Code of Practice.<br> Think! About your choices. Dont chase your losses. Walk away. Gamble responsibly. Call Gambling Help 1800 858 858 <a href="https://gamblinghelponline.org.au">www.gamblinghelponline.org.au</a></p>
      <ul class="bf-links">
        <li><a href="https://www.betfair.com.au/hub/help/account-help/responsible-gambling/">Responsible Gambling</a><span>|</span></li>
        <li><a href="http://www.betfair.com/AUS_NZL/aboutUs/Terms.and.Conditions/">Terms & Conditions</a><span>|</span></li>
        <li><a href="https://www.betfair.com.au/info/privacy-policy/">Privacy Policy</a><span>|</span></li>
        <li><a href="http://www.betfair.com/en/aboutUs/Rules.and.Regulations/">Rules & Regulations</a><span>|</span></li>
        <li><a href="https://www.betfair.com/AUS_NZL/aboutUs/Dispute.Resolution">Dispute Resolution</a></li>
      </ul>
    </div>
  </div>
  <script src="https://js.adsrvr.org/up_loader.1.1.0.js"></script>
  <script>ttd_dom_ready(function(){"function"==typeof TTDUniversalPixelApi&&(new TTDUniversalPixelApi).init("y12d1ir",["8ml4f17"],"https://insight.adsrvr.org/track/up")})</script>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application.07363bc3.js"></script>
      
      <script>app.initialize({version:"1.1.2",url:{base:"../.."}})</script>
      
        <script src="../../search/main.js"></script>
      
    
    
      
        <script>!function(e,a,t,n,o,c,i){e.GoogleAnalyticsObject=o,e.ga=e.ga||function(){(e.ga.q=e.ga.q||[]).push(arguments)},e.ga.l=1*new Date,c=a.createElement(t),i=a.getElementsByTagName(t)[0],c.async=1,c.src="https://www.google-analytics.com/analytics.js",i.parentNode.insertBefore(c,i)}(window,document,"script",0,"ga"),ga("create","UA-125973915-1","auto"),ga("set","anonymizeIp",!0),ga("send","pageview");var links=document.getElementsByTagName("a");if(Array.prototype.map.call(links,function(e){e.host!=document.location.host&&e.addEventListener("click",function(){var a=e.getAttribute("data-md-action")||"follow";ga("send","event","outbound",a,e.href)})}),document.forms.search){var query=document.forms.search.query;query.addEventListener("blur",function(){if(this.value){var e=document.location.pathname;ga("send","pageview",e+"?q="+this.value)}})}</script>
      
    
  </body>
</html>