
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Documentation, guides and articles on creating, developing and implementing automated betting strategies, using data analysis to inform betting models and how to interact with the Betfair API.">
      
      
        <meta name="author" content="Betfair Data Scientists">
      
      
        <link rel="canonical" href="https://betfair-datascientists.github.io/modelling/AFLmodellingPython/">
      
      
        <link rel="prev" href="../modellingTheBrownlowMedal/">
      
      
        <link rel="next" href="../brownlowModelTutorial/">
      
      
      <link rel="icon" href="../../img/BetfairFavicon.ico">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.5">
    
    
      
        <title>AFL modelling walk through in Python - The Automation Hub</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.8608ea7d.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/betfair.css">
    
      <link rel="stylesheet" href="../../css/buttons_and_animations.css">
    
      <link rel="stylesheet" href="../../css/fonts.css">
    
      <link rel="stylesheet" href="../../css/ansi-colours.css">
    
      <link rel="stylesheet" href="../../css/jupyter-cells.css">
    
      <link rel="stylesheet" href="../../css/pandas-dataframe.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","UA-125973915-1"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","UA-125973915-1",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=UA-125973915-1",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="betfair" data-md-color-primary="amber" data-md-color-accent="orange">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#afl-modelling-walkthrough" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      
  
  <header class="md-header" data-md-component="header">
    <nav class="md-header__inner md-grid" aria-label="header.title">
      <a href="../.." title="The Automation Hub" class="md-header__button md-logo" aria-label="The Automation Hub" data-md-component="logo">
        
  <img src="../../img/logo.svg" alt="logo">

      </a>
      <label class="md-header__button md-icon" for="__drawer">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
      </label>
      <div class="md-header__title" data-md-component="header-title">
        <div class="md-header__ellipsis">
          <div class="md-header__topic">
            <span class="md-ellipsis">
              The Automation Hub
            </span>
          </div>
          <div class="md-header__topic" data-md-component="header-topic">
            <span class="md-ellipsis">
              
                AFL modelling walk through in Python
              
            </span>
          </div>
        </div>
      </div>

      
        <form class="md-header__option" data-md-component="palette">
          
            
            
            <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="betfair" data-md-color-primary="amber" data-md-color-accent="orange"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
            
              <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg>
              </label>
            
          
            
            
            <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="amber" data-md-color-accent="orange"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
            
              <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"/></svg>
              </label>
            
          
        </form>
      
      

      
     
      <div class="bf-nav">
        <a class="bf-hidable" href="https://www.betfair.com.au/exchange/plus/"><svg class="exchangeLogo" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:cc="http://creativecommons.org/ns#"
          xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 38.775 4.59" width="24" height="17">
          <path class="st1" d="m 160.3,-136.95 v 26" />
          <g transform="translate(18.8,-137.15)">
            <path d="m 2.2901089,126.53441 v 5.20093 H -3.3107216 L 7.4888397,144.33446 18.2884,131.73534 h -5.598633 v -5.20093 z m -8.6000974,8.10132 -10.8017585,12.59913 h 5.60083 v 5.2998 h 10.3996581 v -5.2998 h 5.6008306 z" />
          </g>
        </svg><span> Exchange</span></a>
        <a href="https://www.betfair.com.au/hub/">Hub</a>
      </div>

      

    </nav>
    
  </header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../data/dataListing/" class="md-tabs__link">
          
  
  Data

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../wagering/betfairHowTo/" class="md-tabs__link">
          
  
  Wagering

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../api/apiResources/" class="md-tabs__link">
          
  
  API

        </a>
      </li>
    
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../brownlowDatathon/" class="md-tabs__link">
          
  
  Modelling

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../tutorials/How_to_Automate_1/" class="md-tabs__link">
          
  
  Tutorials

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../mentalGame/intro/" class="md-tabs__link">
          
  
  Mental Game

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../contactUs/test/" class="md-tabs__link">
          
  
  Contact Us

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="The Automation Hub" class="md-nav__button md-logo" aria-label="The Automation Hub" data-md-component="logo">
      
  <img src="../../img/logo.svg" alt="logo">

    </a>
    The Automation Hub
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Data
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Data
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../data/dataListing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CSV Files
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../data/usingHistoricDataSite/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Historic Data Site
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Wagering
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Wagering
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../wagering/betfairHowTo/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Betfair How-To
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../wagering/bettingGlossary/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Betting Glossary
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../wagering/stakingMethods/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Staking Methods and Bankroll Management
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../wagering/valueAndOdds/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Value and Odds
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../wagering/commission/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Commission and other charges
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../wagering/hubPredictionsModel/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Hub Predictions Model
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../wagering/2ndPlaceVoid/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Cashback 2nd Markets
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../wagering/exactaQuinella/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Exactas & Quinella
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    API
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            API
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/apiResources/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    API resources
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/apiappkey/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to access the Betfair API
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/apiRtutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    API tutorial in R
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/apiPythontutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    API tutorial in Python
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" checked>
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Modelling
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Modelling
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../brownlowDatathon/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Brownlow Medal Datathon
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../howToModel/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Intro to modelling
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../dataSources/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Pricing Data Sources
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cloudOrLocalMachine/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Cloud or Local
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../monteCarloSimulations/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Monte Carlo Simulations
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_6" >
        
          
          <label class="md-nav__link" for="__nav_5_6" id="__nav_5_6_label" tabindex="">
            
  
  <span class="md-ellipsis">
    AFL
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_6">
            <span class="md-nav__icon md-icon"></span>
            AFL
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../AFLPlayerDisposalsTutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Player Disposal Lines
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../AFLPlayerDisposalsFlumine/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Betting Player Disposal Markets
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../modellingTheBrownlowMedal/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How does a Data Scientist model the Brownlow?
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_7" checked>
        
          
          <label class="md-nav__link" for="__nav_5_7" id="__nav_5_7_label" tabindex="">
            
  
  <span class="md-ellipsis">
    AFL (Archive)
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_7_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_5_7">
            <span class="md-nav__icon md-icon"></span>
            AFL (Archive)
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    AFL modelling walk through in Python
    
  </span>
  

      </a>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../brownlowModelTutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Modelling the Brownlow Medal in Python
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_8" >
        
          
          <label class="md-nav__link" for="__nav_5_8" id="__nav_5_8_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Greyhounds
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_8">
            <span class="md-nav__icon md-icon"></span>
            Greyhounds
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../topazTutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Greyhound Topaz API (Python)
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_9" >
        
          
          <label class="md-nav__link" for="__nav_5_9" id="__nav_5_9_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Greyhounds (Archive)
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_9">
            <span class="md-nav__icon md-icon"></span>
            Greyhounds (Archive)
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../fasttrackTutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Greyhound FastTrack API (Python)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../greyhoundModellingPython/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Greyhound modelling (Python)
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_10" >
        
          
          <label class="md-nav__link" for="__nav_5_10" id="__nav_5_10_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Soccer
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_10">
            <span class="md-nav__icon md-icon"></span>
            Soccer
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../howToBuildASoccerBotPartI/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How To Build A Soccer Bot P1
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../howToBuildASoccerBotPartII/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How To Build A Soccer Bot P2
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../howToBuildASoccerBotPartIII/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How To Build A Soccer Bot P3
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_11" >
        
          
          <label class="md-nav__link" for="__nav_5_11" id="__nav_5_11_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Soccer (Archive)
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_11_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_11">
            <span class="md-nav__icon md-icon"></span>
            Soccer (Archive)
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../soccerModellingTutorialPython/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Soccer modelling (Python)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../EPLmlPython/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    EPL Machine Learning (Python)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../soccerModellingELO2022WorldCup/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Soccer modelling (R) - 2022 FIFA World Cup
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../soccerEloTutorialR/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Elo soccer tutorial (R)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../soccerModellingTutorialR/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Soccer modelling (R)
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_12" >
        
          
          <label class="md-nav__link" for="__nav_5_12" id="__nav_5_12_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Tennis (Archive)
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_12_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_12">
            <span class="md-nav__icon md-icon"></span>
            Tennis (Archive)
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../howToModelTheAusOpen/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to model the Australian Open
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../AusOpenRTutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Aus Open R Tutorial
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../AusOpenPythonTutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Aus Open Python Tutorial
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Tutorials
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Tutorials
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/How_to_Automate_1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to Automate 1
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/How_to_Automate_2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to Automate 2
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/How_to_Automate_3/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to Automate 3
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/How_to_Automate_4/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to Automate 4
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/How_to_Automate_5/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to Automate 5
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/flumineSimulations/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Flumine Simulations
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/processingTarFiles101/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Take away the pain! Processing TAR Files 101
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/jsonToCsvRevisited/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    JSON to CSV | Revisited
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/backtestingRatingsTutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Back testing ratings in Python
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/automatedBettingAnglesTutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Automated betting angles in Python
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/analysingAndPredictingMarketMovements/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Do they know? Analysing Betfair market formation & market movements
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/analysingAndPredictingBSP/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Wisdom of the crowd? Analysing & understanding BSP
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Mental Game
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            Mental Game
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/intro/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Intro
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/roleOfEmotions/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Part 1
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/mapYourEmotions/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Part 2
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/handlingBadVariance/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Part 3
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/winbyBeingGreatatLosing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Part 4
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/correctingyouremotions/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Part 5
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/responsibleGambling/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Part 6
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/InchwormConcept/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Part 7
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/HighExpectations/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Part 8
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/TappingYourIntuition/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Part 9
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_8" >
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Contact Us
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            Contact Us
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../contactUs/test/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Meet the Team
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="afl-modelling-walkthrough">AFL Modelling Walkthrough</h1>
<hr />
<h1 id="01-data-cleaning">01. Data Cleaning</h1>
<p>These tutorials will walk you through how to construct your own basic AFL model, using publicly available data. The output will be odds for each team to win, which will be shown on <a href="https://www.betfair.com.au/hub/sports/afl/how-to-build-an-afl-model/">The Hub</a>.</p>
<p>In this notebook we will walk you through the basics of cleaning this dataset and how we have done it. If you want to get straight to feature creation or modelling, feel free to jump ahead!</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="c1"># Import libraries</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.max_columns&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</code></pre></div>
<p>We will first explore the DataFrames, and then create functions to wrangle them and clean them into more consistent sets of data.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="c1"># Read/clean each DataFrame</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="n">match_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;data/afl_match_results.csv&quot;</span><span class="p">)</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="n">odds</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;data/afl_odds.csv&quot;</span><span class="p">)</span>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="n">player_stats</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;data/afl_player_stats.csv&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="n">odds</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</code></pre></div>
<table>
<thead>
<tr>
<th></th>
<th>trunc</th>
<th>event_name</th>
<th>path</th>
<th>selection_name</th>
<th>odds</th>
</tr>
</thead>
<tbody>
<tr>
<td>4179</td>
<td>2018-09-01</td>
<td>Match Odds</td>
<td>VFL/Richmond Reserves v Williamstown</td>
<td>Williamstown</td>
<td>2.3878</td>
</tr>
<tr>
<td>4180</td>
<td>2018-09-01</td>
<td>Match Odds</td>
<td>WAFL/South Fremantle v West Perth</td>
<td>South Fremantle</td>
<td>1.5024</td>
</tr>
<tr>
<td>4181</td>
<td>2018-09-01</td>
<td>Match Odds</td>
<td>WAFL/South Fremantle v West Perth</td>
<td>West Perth</td>
<td>2.7382</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="n">match_results</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</code></pre></div>
<table>
<thead>
<tr>
<th></th>
<th>Game</th>
<th>Date</th>
<th>Round</th>
<th>Home.Team</th>
<th>Home.Goals</th>
<th>Home.Behinds</th>
<th>Home.Points</th>
<th>Away.Team</th>
<th>Away.Goals</th>
<th>Away.Behinds</th>
<th>Away.Points</th>
<th>Venue</th>
<th>Margin</th>
<th>Season</th>
<th>Round.Type</th>
<th>Round.Number</th>
</tr>
</thead>
<tbody>
<tr>
<td>15395</td>
<td>15396</td>
<td>2018-08-26</td>
<td>R23</td>
<td>Brisbane Lions</td>
<td>11</td>
<td>6</td>
<td>72</td>
<td>West Coast</td>
<td>14</td>
<td>14</td>
<td>98</td>
<td>Gabba</td>
<td>-26</td>
<td>2018</td>
<td>Regular</td>
<td>23</td>
</tr>
<tr>
<td>15396</td>
<td>15397</td>
<td>2018-08-26</td>
<td>R23</td>
<td>Melbourne</td>
<td>15</td>
<td>12</td>
<td>102</td>
<td>GWS</td>
<td>8</td>
<td>9</td>
<td>57</td>
<td>M.C.G.</td>
<td>45</td>
<td>2018</td>
<td>Regular</td>
<td>23</td>
</tr>
<tr>
<td>15397</td>
<td>15398</td>
<td>2018-08-26</td>
<td>R23</td>
<td>St Kilda</td>
<td>14</td>
<td>10</td>
<td>94</td>
<td>North Melbourne</td>
<td>17</td>
<td>15</td>
<td>117</td>
<td>Docklands</td>
<td>-23</td>
<td>2018</td>
<td>Regular</td>
<td>23</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="n">player_stats</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</code></pre></div>
<table>
<thead>
<tr>
<th style="text-align: center;"></th>
<th style="text-align: center;">AF</th>
<th style="text-align: center;">B</th>
<th style="text-align: center;">BO</th>
<th style="text-align: center;">CCL</th>
<th style="text-align: center;">CG</th>
<th style="text-align: center;">CL</th>
<th style="text-align: center;">CM</th>
<th style="text-align: center;">CP</th>
<th style="text-align: center;">D</th>
<th style="text-align: center;">DE</th>
<th style="text-align: center;">Date</th>
<th style="text-align: center;">ED</th>
<th style="text-align: center;">FA</th>
<th style="text-align: center;">FF</th>
<th style="text-align: center;">G</th>
<th style="text-align: center;">GA</th>
<th style="text-align: center;">HB</th>
<th style="text-align: center;">HO</th>
<th style="text-align: center;">I50</th>
<th style="text-align: center;">ITC</th>
<th style="text-align: center;">K</th>
<th style="text-align: center;">M</th>
<th style="text-align: center;">MG</th>
<th style="text-align: center;">MI5</th>
<th style="text-align: center;">Match_id</th>
<th style="text-align: center;">One.Percenters</th>
<th style="text-align: center;">Opposition</th>
<th style="text-align: center;">Player</th>
<th style="text-align: center;">R50</th>
<th style="text-align: center;">Round</th>
<th style="text-align: center;">SC</th>
<th style="text-align: center;">SCL</th>
<th style="text-align: center;">SI</th>
<th style="text-align: center;">Season</th>
<th style="text-align: center;">Status</th>
<th style="text-align: center;">T</th>
<th style="text-align: center;">T5</th>
<th style="text-align: center;">TO</th>
<th style="text-align: center;">TOG</th>
<th style="text-align: center;">Team</th>
<th style="text-align: center;">UP</th>
<th style="text-align: center;">Venue</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">89317</td>
<td style="text-align: center;">38</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">0.0</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">2</td>
<td style="text-align: center;">9</td>
<td style="text-align: center;">55.6</td>
<td style="text-align: center;">25/08/2018</td>
<td style="text-align: center;">5</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">2.0</td>
<td style="text-align: center;">6</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">132.0</td>
<td style="text-align: center;">2</td>
<td style="text-align: center;">9711</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">Fremantle</td>
<td style="text-align: center;">Christopher Mayne</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">Round 23</td>
<td style="text-align: center;">35</td>
<td style="text-align: center;">0.0</td>
<td style="text-align: center;">2.0</td>
<td style="text-align: center;">2018</td>
<td style="text-align: center;">Away</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">0.0</td>
<td style="text-align: center;">1.0</td>
<td style="text-align: center;">57</td>
<td style="text-align: center;">Collingwood</td>
<td style="text-align: center;">7</td>
<td style="text-align: center;">Optus Stadium</td>
</tr>
<tr>
<td style="text-align: center;">89318</td>
<td style="text-align: center;">38</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">0.0</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">9</td>
<td style="text-align: center;">55.6</td>
<td style="text-align: center;">25/08/2018</td>
<td style="text-align: center;">5</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">4.0</td>
<td style="text-align: center;">6</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">172.0</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">9711</td>
<td style="text-align: center;">2</td>
<td style="text-align: center;">Fremantle</td>
<td style="text-align: center;">Nathan Murphy</td>
<td style="text-align: center;">5</td>
<td style="text-align: center;">Round 23</td>
<td style="text-align: center;">29</td>
<td style="text-align: center;">0.0</td>
<td style="text-align: center;">0.0</td>
<td style="text-align: center;">2018</td>
<td style="text-align: center;">Away</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">0.0</td>
<td style="text-align: center;">3.0</td>
<td style="text-align: center;">70</td>
<td style="text-align: center;">Collingwood</td>
<td style="text-align: center;">6</td>
<td style="text-align: center;">Optus Stadium</td>
</tr>
<tr>
<td style="text-align: center;">89319</td>
<td style="text-align: center;">56</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">0.0</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">8</td>
<td style="text-align: center;">62.5</td>
<td style="text-align: center;">25/08/2018</td>
<td style="text-align: center;">5</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">2</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">2</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">2.0</td>
<td style="text-align: center;">6</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">180.0</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">9711</td>
<td style="text-align: center;">2</td>
<td style="text-align: center;">Fremantle</td>
<td style="text-align: center;">Jaidyn Stephenson</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">Round 23</td>
<td style="text-align: center;">56</td>
<td style="text-align: center;">0.0</td>
<td style="text-align: center;">4.0</td>
<td style="text-align: center;">2018</td>
<td style="text-align: center;">Away</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">1.0</td>
<td style="text-align: center;">2.0</td>
<td style="text-align: center;">87</td>
<td style="text-align: center;">Collingwood</td>
<td style="text-align: center;">5</td>
<td style="text-align: center;">Optus Stadium</td>
</tr>
</tbody>
</table>
<p>Have a look at the structure of the DataFrames. Notice that for the odds DataFrame, each game is split between two rows, whilst for the match_results each game is on one row. We will have to get around this by splitting the games up onto two rows, as this will allow our feature transformation functions to be applied more easily later on. For the player_stats DataFrame we will aggregate these stats into each game on separate rows.</p>
<p>First, we will write functions to make the odds data look a bit nicer, with only a team column, a date column and a 'home_game' column which takes the values 0 or 1 depending on if it was a home game for that team. To do this we will use the <a href="https://docs.python.org/3/howto/regex.html">regex</a> module to extract the team names from the path column, as well as the to_datetime function from pandas. We will also replace all the inconsistent team names with consistent team names.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_cleaned_odds</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>    <span class="c1"># If a df hasn&#39;t been specified as a parameter, read the odds df</span>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>    <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a>        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;data/afl_odds.csv&quot;</span><span class="p">)</span>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a>
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a>    <span class="c1"># Get a dictionary of team names we want to change and their new values</span>
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a>    <span class="n">team_name_mapping</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a>    <span class="s1">&#39;Adelaide Crows&#39;</span><span class="p">:</span> <span class="s1">&#39;Adelaide&#39;</span><span class="p">,</span>
<a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a>    <span class="s1">&#39;Brisbane Lions&#39;</span><span class="p">:</span> <span class="s1">&#39;Brisbane&#39;</span><span class="p">,</span>
<a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a>    <span class="s1">&#39;Carlton Blues&#39;</span><span class="p">:</span> <span class="s1">&#39;Carlton&#39;</span><span class="p">,</span>
<a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a>    <span class="s1">&#39;Collingwood Magpies&#39;</span><span class="p">:</span> <span class="s1">&#39;Collingwood&#39;</span><span class="p">,</span>
<a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a>    <span class="s1">&#39;Essendon Bombers&#39;</span><span class="p">:</span> <span class="s1">&#39;Essendon&#39;</span><span class="p">,</span>
<a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a>    <span class="s1">&#39;Fremantle Dockers&#39;</span><span class="p">:</span> <span class="s1">&#39;Fremantle&#39;</span><span class="p">,</span>
<a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a>    <span class="s1">&#39;GWS Giants&#39;</span><span class="p">:</span> <span class="s1">&#39;GWS&#39;</span><span class="p">,</span>
<a id="__codelineno-5-15" name="__codelineno-5-15" href="#__codelineno-5-15"></a>    <span class="s1">&#39;Geelong Cats&#39;</span><span class="p">:</span> <span class="s1">&#39;Geelong&#39;</span><span class="p">,</span>
<a id="__codelineno-5-16" name="__codelineno-5-16" href="#__codelineno-5-16"></a>    <span class="s1">&#39;Gold Coast Suns&#39;</span><span class="p">:</span> <span class="s1">&#39;Gold Coast&#39;</span><span class="p">,</span>
<a id="__codelineno-5-17" name="__codelineno-5-17" href="#__codelineno-5-17"></a>    <span class="s1">&#39;Greater Western Sydney&#39;</span><span class="p">:</span> <span class="s1">&#39;GWS&#39;</span><span class="p">,</span>
<a id="__codelineno-5-18" name="__codelineno-5-18" href="#__codelineno-5-18"></a>    <span class="s1">&#39;Greater Western Sydney Giants&#39;</span><span class="p">:</span> <span class="s1">&#39;GWS&#39;</span><span class="p">,</span>
<a id="__codelineno-5-19" name="__codelineno-5-19" href="#__codelineno-5-19"></a>    <span class="s1">&#39;Hawthorn Hawks&#39;</span><span class="p">:</span> <span class="s1">&#39;Hawthorn&#39;</span><span class="p">,</span>
<a id="__codelineno-5-20" name="__codelineno-5-20" href="#__codelineno-5-20"></a>    <span class="s1">&#39;Melbourne Demons&#39;</span><span class="p">:</span> <span class="s1">&#39;Melbourne&#39;</span><span class="p">,</span> 
<a id="__codelineno-5-21" name="__codelineno-5-21" href="#__codelineno-5-21"></a>    <span class="s1">&#39;North Melbourne Kangaroos&#39;</span><span class="p">:</span> <span class="s1">&#39;North Melbourne&#39;</span><span class="p">,</span>
<a id="__codelineno-5-22" name="__codelineno-5-22" href="#__codelineno-5-22"></a>    <span class="s1">&#39;Port Adelaide Magpies&#39;</span><span class="p">:</span> <span class="s1">&#39;Port Adelaide&#39;</span><span class="p">,</span>
<a id="__codelineno-5-23" name="__codelineno-5-23" href="#__codelineno-5-23"></a>    <span class="s1">&#39;Port Adelaide Power&#39;</span><span class="p">:</span> <span class="s1">&#39;Port Adelaide&#39;</span><span class="p">,</span> 
<a id="__codelineno-5-24" name="__codelineno-5-24" href="#__codelineno-5-24"></a>    <span class="s1">&#39;P Adelaide&#39;</span><span class="p">:</span> <span class="s1">&#39;Port Adelaide&#39;</span><span class="p">,</span>
<a id="__codelineno-5-25" name="__codelineno-5-25" href="#__codelineno-5-25"></a>    <span class="s1">&#39;Richmond Tigers&#39;</span><span class="p">:</span> <span class="s1">&#39;Richmond&#39;</span><span class="p">,</span>
<a id="__codelineno-5-26" name="__codelineno-5-26" href="#__codelineno-5-26"></a>    <span class="s1">&#39;St Kilda Saints&#39;</span><span class="p">:</span> <span class="s1">&#39;St Kilda&#39;</span><span class="p">,</span> 
<a id="__codelineno-5-27" name="__codelineno-5-27" href="#__codelineno-5-27"></a>    <span class="s1">&#39;Sydney Swans&#39;</span><span class="p">:</span> <span class="s1">&#39;Sydney&#39;</span><span class="p">,</span>
<a id="__codelineno-5-28" name="__codelineno-5-28" href="#__codelineno-5-28"></a>    <span class="s1">&#39;West Coast Eagles&#39;</span><span class="p">:</span> <span class="s1">&#39;West Coast&#39;</span><span class="p">,</span>
<a id="__codelineno-5-29" name="__codelineno-5-29" href="#__codelineno-5-29"></a>    <span class="s1">&#39;Wetsern Bulldogs&#39;</span><span class="p">:</span> <span class="s1">&#39;Western Bulldogs&#39;</span><span class="p">,</span>
<a id="__codelineno-5-30" name="__codelineno-5-30" href="#__codelineno-5-30"></a>    <span class="s1">&#39;Western Bullbogs&#39;</span><span class="p">:</span> <span class="s1">&#39;Western Bulldogs&#39;</span>
<a id="__codelineno-5-31" name="__codelineno-5-31" href="#__codelineno-5-31"></a>    <span class="p">}</span>
<a id="__codelineno-5-32" name="__codelineno-5-32" href="#__codelineno-5-32"></a>
<a id="__codelineno-5-33" name="__codelineno-5-33" href="#__codelineno-5-33"></a>    <span class="c1"># Add columns</span>
<a id="__codelineno-5-34" name="__codelineno-5-34" href="#__codelineno-5-34"></a>    <span class="n">df</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">date</span><span class="o">=</span><span class="k">lambda</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">trunc</span><span class="p">),</span> <span class="c1"># Create a datetime column</span>
<a id="__codelineno-5-35" name="__codelineno-5-35" href="#__codelineno-5-35"></a>                    <span class="n">home_team</span><span class="o">=</span><span class="k">lambda</span> <span class="n">df</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="s1">&#39;(([\w\s]+) v ([\w\s]+))&#39;</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span>
<a id="__codelineno-5-36" name="__codelineno-5-36" href="#__codelineno-5-36"></a>                    <span class="n">away_team</span><span class="o">=</span><span class="k">lambda</span> <span class="n">df</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="s1">&#39;(([\w\s]+) v ([\w\s]+))&#39;</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
<a id="__codelineno-5-37" name="__codelineno-5-37" href="#__codelineno-5-37"></a>            <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">,</span> <span class="s1">&#39;trunc&#39;</span><span class="p">,</span> <span class="s1">&#39;event_name&#39;</span><span class="p">])</span> <span class="c1"># Drop irrelevant columns</span>
<a id="__codelineno-5-38" name="__codelineno-5-38" href="#__codelineno-5-38"></a>            <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;selection_name&#39;</span><span class="p">:</span> <span class="s1">&#39;team&#39;</span><span class="p">})</span> <span class="c1"># Rename columns</span>
<a id="__codelineno-5-39" name="__codelineno-5-39" href="#__codelineno-5-39"></a>            <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">team_name_mapping</span><span class="p">)</span>
<a id="__codelineno-5-40" name="__codelineno-5-40" href="#__codelineno-5-40"></a>            <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;date&#39;</span><span class="p">)</span>
<a id="__codelineno-5-41" name="__codelineno-5-41" href="#__codelineno-5-41"></a>            <span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-5-42" name="__codelineno-5-42" href="#__codelineno-5-42"></a>            <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">home_game</span><span class="o">=</span><span class="k">lambda</span> <span class="n">df</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">home_team</span> <span class="o">==</span> <span class="n">row</span><span class="o">.</span><span class="n">team</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;columns&#39;</span><span class="p">))</span>
<a id="__codelineno-5-43" name="__codelineno-5-43" href="#__codelineno-5-43"></a>            <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;home_team&#39;</span><span class="p">,</span> <span class="s1">&#39;away_team&#39;</span><span class="p">]))</span>
<a id="__codelineno-5-44" name="__codelineno-5-44" href="#__codelineno-5-44"></a>    <span class="k">return</span> <span class="n">df</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="c1"># Apply the wrangling and cleaning function</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="n">odds</span> <span class="o">=</span> <span class="n">get_cleaned_odds</span><span class="p">(</span><span class="n">odds</span><span class="p">)</span>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="n">odds</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span>
</code></pre></div>
<table>
<thead>
<tr>
<th></th>
<th>team</th>
<th>odds</th>
<th>date</th>
<th>home_game</th>
</tr>
</thead>
<tbody>
<tr>
<td>4177</td>
<td>South Fremantle</td>
<td>1.5024</td>
<td>2018-09-01</td>
<td>1</td>
</tr>
<tr>
<td>4178</td>
<td>Port Melbourne</td>
<td>2.8000</td>
<td>2018-09-01</td>
<td>0</td>
</tr>
<tr>
<td>4179</td>
<td>Box Hill Hawks</td>
<td>1.4300</td>
<td>2018-09-01</td>
<td>1</td>
</tr>
<tr>
<td>4180</td>
<td>Casey Demons</td>
<td>1.9000</td>
<td>2018-09-01</td>
<td>1</td>
</tr>
<tr>
<td>4181</td>
<td>West Perth</td>
<td>2.7382</td>
<td>2018-09-01</td>
<td>0</td>
</tr>
</tbody>
</table>
<p>We now have a DataFrame that looks nice and easy to join with our other DataFrames. Now let's lean up the match_details DataFrame.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="c1"># Define a function which cleans the match results df, and separates each teams&#39; stats onto individual rows</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_cleaned_match_results</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>    <span class="c1"># If a df hasn&#39;t been specified as a parameter, read the match_results df</span>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a>    <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a>        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;data/afl_match_results.csv&quot;</span><span class="p">)</span>
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a>
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a>    <span class="c1"># Create column lists to loop through - these are the columns we want in home and away dfs</span>
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a>    <span class="n">home_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Game&#39;</span><span class="p">,</span> <span class="s1">&#39;Date&#39;</span><span class="p">,</span> <span class="s1">&#39;Round.Number&#39;</span><span class="p">,</span> <span class="s1">&#39;Home.Team&#39;</span><span class="p">,</span> <span class="s1">&#39;Home.Goals&#39;</span><span class="p">,</span> <span class="s1">&#39;Home.Behinds&#39;</span><span class="p">,</span> <span class="s1">&#39;Home.Points&#39;</span><span class="p">,</span> <span class="s1">&#39;Margin&#39;</span><span class="p">,</span> <span class="s1">&#39;Venue&#39;</span><span class="p">,</span> <span class="s1">&#39;Away.Team&#39;</span><span class="p">,</span> <span class="s1">&#39;Away.Goals&#39;</span><span class="p">,</span> <span class="s1">&#39;Away.Behinds&#39;</span><span class="p">,</span> <span class="s1">&#39;Away.Points&#39;</span><span class="p">]</span>
<a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a>    <span class="n">away_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Game&#39;</span><span class="p">,</span> <span class="s1">&#39;Date&#39;</span><span class="p">,</span> <span class="s1">&#39;Round.Number&#39;</span><span class="p">,</span> <span class="s1">&#39;Away.Team&#39;</span><span class="p">,</span> <span class="s1">&#39;Away.Goals&#39;</span><span class="p">,</span> <span class="s1">&#39;Away.Behinds&#39;</span><span class="p">,</span> <span class="s1">&#39;Away.Points&#39;</span><span class="p">,</span> <span class="s1">&#39;Margin&#39;</span><span class="p">,</span> <span class="s1">&#39;Venue&#39;</span><span class="p">,</span> <span class="s1">&#39;Home.Team&#39;</span><span class="p">,</span> <span class="s1">&#39;Home.Goals&#39;</span><span class="p">,</span> <span class="s1">&#39;Home.Behinds&#39;</span><span class="p">,</span> <span class="s1">&#39;Home.Points&#39;</span><span class="p">]</span>
<a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a>
<a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a>    <span class="n">mapping</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;game&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;round&#39;</span><span class="p">,</span> <span class="s1">&#39;team&#39;</span><span class="p">,</span> <span class="s1">&#39;goals&#39;</span><span class="p">,</span> <span class="s1">&#39;behinds&#39;</span><span class="p">,</span> <span class="s1">&#39;points&#39;</span><span class="p">,</span> <span class="s1">&#39;margin&#39;</span><span class="p">,</span> <span class="s1">&#39;venue&#39;</span><span class="p">,</span> <span class="s1">&#39;opponent&#39;</span><span class="p">,</span> <span class="s1">&#39;opponent_goals&#39;</span><span class="p">,</span> <span class="s1">&#39;opponent_behinds&#39;</span><span class="p">,</span> <span class="s1">&#39;opponent_points&#39;</span><span class="p">]</span>
<a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a>
<a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a>    <span class="n">team_name_mapping</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a>    <span class="s1">&#39;Brisbane Lions&#39;</span><span class="p">:</span> <span class="s1">&#39;Brisbane&#39;</span><span class="p">,</span>
<a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a>    <span class="s1">&#39;Footscray&#39;</span><span class="p">:</span> <span class="s1">&#39;Western Bulldogs&#39;</span>
<a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a>    <span class="p">}</span>
<a id="__codelineno-7-17" name="__codelineno-7-17" href="#__codelineno-7-17"></a>
<a id="__codelineno-7-18" name="__codelineno-7-18" href="#__codelineno-7-18"></a>    <span class="c1"># Create a df with only home games</span>
<a id="__codelineno-7-19" name="__codelineno-7-19" href="#__codelineno-7-19"></a>    <span class="n">df_home</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">home_columns</span><span class="p">]</span>
<a id="__codelineno-7-20" name="__codelineno-7-20" href="#__codelineno-7-20"></a>                <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">old_col</span><span class="p">:</span> <span class="n">new_col</span> <span class="k">for</span> <span class="n">old_col</span><span class="p">,</span> <span class="n">new_col</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">home_columns</span><span class="p">,</span> <span class="n">mapping</span><span class="p">)})</span>
<a id="__codelineno-7-21" name="__codelineno-7-21" href="#__codelineno-7-21"></a>                <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">home_game</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<a id="__codelineno-7-22" name="__codelineno-7-22" href="#__codelineno-7-22"></a>
<a id="__codelineno-7-23" name="__codelineno-7-23" href="#__codelineno-7-23"></a>    <span class="c1"># Create a df with only away games</span>
<a id="__codelineno-7-24" name="__codelineno-7-24" href="#__codelineno-7-24"></a>    <span class="n">df_away</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">away_columns</span><span class="p">]</span>
<a id="__codelineno-7-25" name="__codelineno-7-25" href="#__codelineno-7-25"></a>                <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">old_col</span><span class="p">:</span> <span class="n">new_col</span> <span class="k">for</span> <span class="n">old_col</span><span class="p">,</span> <span class="n">new_col</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">away_columns</span><span class="p">,</span> <span class="n">mapping</span><span class="p">)})</span>
<a id="__codelineno-7-26" name="__codelineno-7-26" href="#__codelineno-7-26"></a>                <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">home_game</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-7-27" name="__codelineno-7-27" href="#__codelineno-7-27"></a>                        <span class="n">margin</span><span class="o">=</span><span class="k">lambda</span> <span class="n">df</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">margin</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
<a id="__codelineno-7-28" name="__codelineno-7-28" href="#__codelineno-7-28"></a>
<a id="__codelineno-7-29" name="__codelineno-7-29" href="#__codelineno-7-29"></a>    <span class="c1"># Append these dfs together</span>
<a id="__codelineno-7-30" name="__codelineno-7-30" href="#__codelineno-7-30"></a>    <span class="n">new_df</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_home</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_away</span><span class="p">)</span>
<a id="__codelineno-7-31" name="__codelineno-7-31" href="#__codelineno-7-31"></a>                     <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;game&#39;</span><span class="p">)</span> <span class="c1"># Sort by game ID</span>
<a id="__codelineno-7-32" name="__codelineno-7-32" href="#__codelineno-7-32"></a>                     <span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># Reset index</span>
<a id="__codelineno-7-33" name="__codelineno-7-33" href="#__codelineno-7-33"></a>                     <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">date</span><span class="o">=</span><span class="k">lambda</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">date</span><span class="p">))</span> <span class="c1"># Create a datetime column</span>
<a id="__codelineno-7-34" name="__codelineno-7-34" href="#__codelineno-7-34"></a>                     <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">team_name_mapping</span><span class="p">))</span> <span class="c1"># Rename team names to be consistent with other dfs</span>
<a id="__codelineno-7-35" name="__codelineno-7-35" href="#__codelineno-7-35"></a>    <span class="k">return</span> <span class="n">new_df</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="n">match_results</span> <span class="o">=</span> <span class="n">get_cleaned_match_results</span><span class="p">(</span><span class="n">match_results</span><span class="p">)</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="n">match_results</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</code></pre></div>
<table>
<thead>
<tr>
<th></th>
<th>game</th>
<th>date</th>
<th>round</th>
<th>team</th>
<th>goals</th>
<th>behinds</th>
<th>points</th>
<th>margin</th>
<th>venue</th>
<th>opponent</th>
<th>opponent_goals</th>
<th>opponent_behinds</th>
<th>opponent_points</th>
<th>home_game</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>1</td>
<td>1897-05-08</td>
<td>1</td>
<td>Fitzroy</td>
<td>6</td>
<td>13</td>
<td>49</td>
<td>33</td>
<td>Brunswick St</td>
<td>Carlton</td>
<td>2</td>
<td>4</td>
<td>16</td>
<td>1</td>
</tr>
<tr>
<td>1</td>
<td>1</td>
<td>1897-05-08</td>
<td>1</td>
<td>Carlton</td>
<td>2</td>
<td>4</td>
<td>16</td>
<td>-33</td>
<td>Brunswick St</td>
<td>Fitzroy</td>
<td>6</td>
<td>13</td>
<td>49</td>
<td>0</td>
</tr>
<tr>
<td>2</td>
<td>2</td>
<td>1897-05-08</td>
<td>1</td>
<td>Collingwood</td>
<td>5</td>
<td>11</td>
<td>41</td>
<td>25</td>
<td>Victoria Park</td>
<td>St Kilda</td>
<td>2</td>
<td>4</td>
<td>16</td>
<td>1</td>
</tr>
<tr>
<td>3</td>
<td>2</td>
<td>1897-05-08</td>
<td>1</td>
<td>St Kilda</td>
<td>2</td>
<td>4</td>
<td>16</td>
<td>-25</td>
<td>Victoria Park</td>
<td>Collingwood</td>
<td>5</td>
<td>11</td>
<td>41</td>
<td>0</td>
</tr>
<tr>
<td>4</td>
<td>3</td>
<td>1897-05-08</td>
<td>1</td>
<td>Geelong</td>
<td>3</td>
<td>6</td>
<td>24</td>
<td>-23</td>
<td>Corio Oval</td>
<td>Essendon</td>
<td>7</td>
<td>5</td>
<td>47</td>
<td>1</td>
</tr>
</tbody>
</table>
<p>Now we have both the odds DataFrame and match_results DataFrame ready for feature creation! Finally, we will aggregate the player_stats DataFrame stats for each game rather than individual player stats. For this DataFrame we have regular stats, such as disposals, marks etc. and Advanced Stats, such as Tackles Inside 50 and Metres Gained. However these advanced stats are only available from 2015, so we will not be using them in this tutorial - as there isn't enough data from 2015 to train our models.</p>
<p>Let's now aggregate the player_stats DataFrame.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_cleaned_aggregate_player_stats</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>    <span class="c1"># If a df hasn&#39;t been specified as a parameter, read the player_stats df</span>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a>    <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a>        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;data/afl_player_stats.csv&quot;</span><span class="p">)</span>
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a>
<a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a>    <span class="n">agg_stats</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span> <span class="c1"># Rename columns to lowercase</span>
<a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a>                    <span class="s1">&#39;Season&#39;</span><span class="p">:</span> <span class="s1">&#39;season&#39;</span><span class="p">,</span>
<a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a>                    <span class="s1">&#39;Round&#39;</span><span class="p">:</span> <span class="s1">&#39;round&#39;</span><span class="p">,</span>
<a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a>                    <span class="s1">&#39;Team&#39;</span><span class="p">:</span> <span class="s1">&#39;team&#39;</span><span class="p">,</span>
<a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a>                    <span class="s1">&#39;Opposition&#39;</span><span class="p">:</span> <span class="s1">&#39;opponent&#39;</span><span class="p">,</span>
<a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a>                    <span class="s1">&#39;Date&#39;</span><span class="p">:</span> <span class="s1">&#39;date&#39;</span>
<a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a>                    <span class="p">})</span>
<a id="__codelineno-9-13" name="__codelineno-9-13" href="#__codelineno-9-13"></a>                   <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;season&#39;</span><span class="p">,</span> <span class="s1">&#39;team&#39;</span><span class="p">,</span> <span class="s1">&#39;opponent&#39;</span><span class="p">],</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="c1"># Groupby to aggregate the stats for each game</span>
<a id="__codelineno-9-14" name="__codelineno-9-14" href="#__codelineno-9-14"></a>                   <span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<a id="__codelineno-9-15" name="__codelineno-9-15" href="#__codelineno-9-15"></a>                   <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;DE&#39;</span><span class="p">,</span> <span class="s1">&#39;TOG&#39;</span><span class="p">,</span> <span class="s1">&#39;Match_id&#39;</span><span class="p">])</span> <span class="c1"># Drop columns</span>
<a id="__codelineno-9-16" name="__codelineno-9-16" href="#__codelineno-9-16"></a>                   <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">date</span><span class="o">=</span><span class="k">lambda</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">/%m/%Y&quot;</span><span class="p">))</span> <span class="c1"># Create a datetime object</span>
<a id="__codelineno-9-17" name="__codelineno-9-17" href="#__codelineno-9-17"></a>                   <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;date&#39;</span><span class="p">)</span>
<a id="__codelineno-9-18" name="__codelineno-9-18" href="#__codelineno-9-18"></a>                   <span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
<a id="__codelineno-9-19" name="__codelineno-9-19" href="#__codelineno-9-19"></a>    <span class="k">return</span> <span class="n">agg_stats</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="n">agg_stats</span> <span class="o">=</span> <span class="n">get_cleaned_aggregate_player_stats</span><span class="p">(</span><span class="n">player_stats</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="n">agg_stats</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span>
</code></pre></div>
<table>
<thead>
<tr>
<th></th>
<th>date</th>
<th>season</th>
<th>team</th>
<th>opponent</th>
<th>AF</th>
<th>B</th>
<th>BO</th>
<th>CCL</th>
<th>CG</th>
<th>CL</th>
<th>CM</th>
<th>CP</th>
<th>D</th>
<th>ED</th>
<th>FA</th>
<th>FF</th>
<th>G</th>
<th>GA</th>
<th>HB</th>
<th>HO</th>
<th>I50</th>
<th>ITC</th>
<th>K</th>
<th>M</th>
<th>MG</th>
<th>MI5</th>
<th>One.Percenters</th>
<th>R50</th>
<th>SC</th>
<th>SCL</th>
<th>SI</th>
<th>T</th>
<th>T5</th>
<th>TO</th>
<th>UP</th>
</tr>
</thead>
<tbody>
<tr>
<td>3621</td>
<td>2018-08-26</td>
<td>2018</td>
<td>Brisbane</td>
<td>West Coast</td>
<td>1652</td>
<td>5</td>
<td>0</td>
<td>14.0</td>
<td>49</td>
<td>37</td>
<td>8</td>
<td>132</td>
<td>394</td>
<td>302</td>
<td>20</td>
<td>18</td>
<td>11</td>
<td>9</td>
<td>167</td>
<td>48</td>
<td>49</td>
<td>59.0</td>
<td>227</td>
<td>104</td>
<td>5571.0</td>
<td>6</td>
<td>48</td>
<td>39</td>
<td>1645</td>
<td>23.0</td>
<td>86.0</td>
<td>62</td>
<td>13.0</td>
<td>69.0</td>
<td>256</td>
</tr>
<tr>
<td>3622</td>
<td>2018-08-26</td>
<td>2018</td>
<td>West Coast</td>
<td>Brisbane</td>
<td>1548</td>
<td>11</td>
<td>5</td>
<td>13.0</td>
<td>49</td>
<td>42</td>
<td>9</td>
<td>141</td>
<td>360</td>
<td>262</td>
<td>18</td>
<td>20</td>
<td>14</td>
<td>8</td>
<td>137</td>
<td>39</td>
<td>56</td>
<td>70.0</td>
<td>223</td>
<td>95</td>
<td>5809.0</td>
<td>12</td>
<td>39</td>
<td>34</td>
<td>1655</td>
<td>29.0</td>
<td>94.0</td>
<td>55</td>
<td>6.0</td>
<td>59.0</td>
<td>217</td>
</tr>
<tr>
<td>3623</td>
<td>2018-08-26</td>
<td>2018</td>
<td>St Kilda</td>
<td>North Melbourne</td>
<td>1587</td>
<td>8</td>
<td>11</td>
<td>19.0</td>
<td>48</td>
<td>33</td>
<td>7</td>
<td>125</td>
<td>383</td>
<td>299</td>
<td>18</td>
<td>14</td>
<td>14</td>
<td>13</td>
<td>173</td>
<td>23</td>
<td>48</td>
<td>68.0</td>
<td>210</td>
<td>112</td>
<td>5522.0</td>
<td>14</td>
<td>46</td>
<td>35</td>
<td>1568</td>
<td>14.0</td>
<td>95.0</td>
<td>50</td>
<td>7.0</td>
<td>77.0</td>
<td>269</td>
</tr>
<tr>
<td>3624</td>
<td>2018-08-26</td>
<td>2018</td>
<td>GWS</td>
<td>Melbourne</td>
<td>1449</td>
<td>7</td>
<td>17</td>
<td>14.0</td>
<td>42</td>
<td>31</td>
<td>12</td>
<td>111</td>
<td>355</td>
<td>274</td>
<td>19</td>
<td>13</td>
<td>8</td>
<td>7</td>
<td>159</td>
<td>18</td>
<td>50</td>
<td>54.0</td>
<td>196</td>
<td>110</td>
<td>5416.0</td>
<td>10</td>
<td>62</td>
<td>34</td>
<td>1532</td>
<td>17.0</td>
<td>78.0</td>
<td>46</td>
<td>5.0</td>
<td>58.0</td>
<td>254</td>
</tr>
<tr>
<td>3625</td>
<td>2018-08-26</td>
<td>2018</td>
<td>Melbourne</td>
<td>GWS</td>
<td>1712</td>
<td>8</td>
<td>12</td>
<td>10.0</td>
<td>38</td>
<td>30</td>
<td>12</td>
<td>139</td>
<td>403</td>
<td>302</td>
<td>13</td>
<td>19</td>
<td>15</td>
<td>14</td>
<td>181</td>
<td>48</td>
<td>54</td>
<td>59.0</td>
<td>222</td>
<td>106</td>
<td>6198.0</td>
<td>16</td>
<td>34</td>
<td>39</td>
<td>1768</td>
<td>20.0</td>
<td>147.0</td>
<td>60</td>
<td>2.0</td>
<td>53.0</td>
<td>269</td>
</tr>
</tbody>
</table>
<p>We now have a three fully prepared DataFrames which are almost ready to be analysed and for a model to be built on! Let's have a look at how they look and then merge them together into our final DataFrame.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="n">odds</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</code></pre></div>
<table>
<thead>
<tr>
<th></th>
<th>team</th>
<th>odds</th>
<th>date</th>
<th>home_game</th>
</tr>
</thead>
<tbody>
<tr>
<td>4179</td>
<td>Box Hill Hawks</td>
<td>1.4300</td>
<td>2018-09-01</td>
<td>1</td>
</tr>
<tr>
<td>4180</td>
<td>Casey Demons</td>
<td>1.9000</td>
<td>2018-09-01</td>
<td>1</td>
</tr>
<tr>
<td>4181</td>
<td>West Perth</td>
<td>2.7382</td>
<td>2018-09-01</td>
<td>0</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="n">match_results</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</code></pre></div>
<table>
<thead>
<tr>
<th></th>
<th>game</th>
<th>date</th>
<th>round</th>
<th>team</th>
<th>goals</th>
<th>behinds</th>
<th>points</th>
<th>margin</th>
<th>venue</th>
<th>opponent</th>
<th>opponent_goals</th>
<th>opponent_behinds</th>
<th>opponent_points</th>
<th>home_game</th>
</tr>
</thead>
<tbody>
<tr>
<td>30793</td>
<td>15397</td>
<td>2018-08-26</td>
<td>23</td>
<td>Melbourne</td>
<td>15</td>
<td>12</td>
<td>102</td>
<td>45</td>
<td>M.C.G.</td>
<td>GWS</td>
<td>8</td>
<td>9</td>
<td>57</td>
<td>1</td>
</tr>
<tr>
<td>30794</td>
<td>15398</td>
<td>2018-08-26</td>
<td>23</td>
<td>St Kilda</td>
<td>14</td>
<td>10</td>
<td>94</td>
<td>-23</td>
<td>Docklands</td>
<td>North Melbourne</td>
<td>17</td>
<td>15</td>
<td>117</td>
<td>1</td>
</tr>
<tr>
<td>30795</td>
<td>15398</td>
<td>2018-08-26</td>
<td>23</td>
<td>North Melbourne</td>
<td>17</td>
<td>15</td>
<td>117</td>
<td>23</td>
<td>Docklands</td>
<td>St Kilda</td>
<td>14</td>
<td>10</td>
<td>94</td>
<td>0</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="n">agg_stats</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</code></pre></div>
<table>
<thead>
<tr>
<th></th>
<th>date</th>
<th>season</th>
<th>team</th>
<th>opponent</th>
<th>AF</th>
<th>B</th>
<th>BO</th>
<th>CCL</th>
<th>CG</th>
<th>CL</th>
<th>CM</th>
<th>CP</th>
<th>D</th>
<th>ED</th>
<th>FA</th>
<th>FF</th>
<th>G</th>
<th>GA</th>
<th>HB</th>
<th>HO</th>
<th>I50</th>
<th>ITC</th>
<th>K</th>
<th>M</th>
<th>MG</th>
<th>MI5</th>
<th>One.Percenters</th>
<th>R50</th>
<th>SC</th>
<th>SCL</th>
<th>SI</th>
<th>T</th>
<th>T5</th>
<th>TO</th>
<th>UP</th>
</tr>
</thead>
<tbody>
<tr>
<td>3623</td>
<td>2018-08-26</td>
<td>2018</td>
<td>St Kilda</td>
<td>North Melbourne</td>
<td>1587</td>
<td>8</td>
<td>11</td>
<td>19.0</td>
<td>48</td>
<td>33</td>
<td>7</td>
<td>125</td>
<td>383</td>
<td>299</td>
<td>18</td>
<td>14</td>
<td>14</td>
<td>13</td>
<td>173</td>
<td>23</td>
<td>48</td>
<td>68.0</td>
<td>210</td>
<td>112</td>
<td>5522.0</td>
<td>14</td>
<td>46</td>
<td>35</td>
<td>1568</td>
<td>14.0</td>
<td>95.0</td>
<td>50</td>
<td>7.0</td>
<td>77.0</td>
<td>269</td>
</tr>
<tr>
<td>3624</td>
<td>2018-08-26</td>
<td>2018</td>
<td>GWS</td>
<td>Melbourne</td>
<td>1449</td>
<td>7</td>
<td>17</td>
<td>14.0</td>
<td>42</td>
<td>31</td>
<td>12</td>
<td>111</td>
<td>355</td>
<td>274</td>
<td>19</td>
<td>13</td>
<td>8</td>
<td>7</td>
<td>159</td>
<td>18</td>
<td>50</td>
<td>54.0</td>
<td>196</td>
<td>110</td>
<td>5416.0</td>
<td>10</td>
<td>62</td>
<td>34</td>
<td>1532</td>
<td>17.0</td>
<td>78.0</td>
<td>46</td>
<td>5.0</td>
<td>58.0</td>
<td>254</td>
</tr>
<tr>
<td>3625</td>
<td>2018-08-26</td>
<td>2018</td>
<td>Melbourne</td>
<td>GWS</td>
<td>1712</td>
<td>8</td>
<td>12</td>
<td>10.0</td>
<td>38</td>
<td>30</td>
<td>12</td>
<td>139</td>
<td>403</td>
<td>302</td>
<td>13</td>
<td>19</td>
<td>15</td>
<td>14</td>
<td>181</td>
<td>48</td>
<td>54</td>
<td>59.0</td>
<td>222</td>
<td>106</td>
<td>6198.0</td>
<td>16</td>
<td>34</td>
<td>39</td>
<td>1768</td>
<td>20.0</td>
<td>147.0</td>
<td>60</td>
<td>2.0</td>
<td>53.0</td>
<td>269</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="n">merged_df</span> <span class="o">=</span> <span class="p">(</span><span class="n">odds</span><span class="p">[</span><span class="n">odds</span><span class="o">.</span><span class="n">team</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">agg_stats</span><span class="o">.</span><span class="n">team</span><span class="o">.</span><span class="n">unique</span><span class="p">())]</span>
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a>                <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">,</span> <span class="n">match_results</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;team&#39;</span><span class="p">,</span> <span class="s1">&#39;home_game&#39;</span><span class="p">])</span>
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a>                <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">,</span> <span class="n">agg_stats</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;team&#39;</span><span class="p">,</span> <span class="s1">&#39;opponent&#39;</span><span class="p">])</span>
<a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a>                <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;game&#39;</span><span class="p">]))</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="n">merged_df</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</code></pre></div>
<table>
<thead>
<tr>
<th></th>
<th>team</th>
<th>odds</th>
<th>date</th>
<th>home_game</th>
<th>game</th>
<th>round</th>
<th>goals</th>
<th>behinds</th>
<th>points</th>
<th>margin</th>
<th>venue</th>
<th>opponent</th>
<th>opponent_goals</th>
<th>opponent_behinds</th>
<th>opponent_points</th>
<th>season</th>
<th>AF</th>
<th>B</th>
<th>BO</th>
<th>CCL</th>
<th>CG</th>
<th>CL</th>
<th>CM</th>
<th>CP</th>
<th>D</th>
<th>ED</th>
<th>FA</th>
<th>FF</th>
<th>G</th>
<th>GA</th>
<th>HB</th>
<th>HO</th>
<th>I50</th>
<th>ITC</th>
<th>K</th>
<th>M</th>
<th>MG</th>
<th>MI5</th>
<th>One.Percenters</th>
<th>R50</th>
<th>SC</th>
<th>SCL</th>
<th>SI</th>
<th>T</th>
<th>T5</th>
<th>TO</th>
<th>UP</th>
</tr>
</thead>
<tbody>
<tr>
<td>3199</td>
<td>Melbourne</td>
<td>1.5116</td>
<td>2018-08-26</td>
<td>1</td>
<td>15397</td>
<td>23</td>
<td>15</td>
<td>12</td>
<td>102</td>
<td>45</td>
<td>M.C.G.</td>
<td>GWS</td>
<td>8</td>
<td>9</td>
<td>57</td>
<td>2018</td>
<td>1712</td>
<td>8</td>
<td>12</td>
<td>10.0</td>
<td>38</td>
<td>30</td>
<td>12</td>
<td>139</td>
<td>403</td>
<td>302</td>
<td>13</td>
<td>19</td>
<td>15</td>
<td>14</td>
<td>181</td>
<td>48</td>
<td>54</td>
<td>59.0</td>
<td>222</td>
<td>106</td>
<td>6198.0</td>
<td>16</td>
<td>34</td>
<td>39</td>
<td>1768</td>
<td>20.0</td>
<td>147.0</td>
<td>60</td>
<td>2.0</td>
<td>53.0</td>
<td>269</td>
</tr>
<tr>
<td>3195</td>
<td>North Melbourne</td>
<td>1.3936</td>
<td>2018-08-26</td>
<td>0</td>
<td>15398</td>
<td>23</td>
<td>17</td>
<td>15</td>
<td>117</td>
<td>23</td>
<td>Docklands</td>
<td>St Kilda</td>
<td>14</td>
<td>10</td>
<td>94</td>
<td>2018</td>
<td>1707</td>
<td>13</td>
<td>7</td>
<td>15.0</td>
<td>50</td>
<td>24</td>
<td>6</td>
<td>131</td>
<td>425</td>
<td>322</td>
<td>14</td>
<td>18</td>
<td>17</td>
<td>13</td>
<td>201</td>
<td>32</td>
<td>59</td>
<td>77.0</td>
<td>224</td>
<td>106</td>
<td>5833.0</td>
<td>23</td>
<td>33</td>
<td>29</td>
<td>1735</td>
<td>9.0</td>
<td>154.0</td>
<td>48</td>
<td>9.0</td>
<td>66.0</td>
<td>300</td>
</tr>
<tr>
<td>3200</td>
<td>St Kilda</td>
<td>3.5178</td>
<td>2018-08-26</td>
<td>1</td>
<td>15398</td>
<td>23</td>
<td>14</td>
<td>10</td>
<td>94</td>
<td>-23</td>
<td>Docklands</td>
<td>North Melbourne</td>
<td>17</td>
<td>15</td>
<td>117</td>
<td>2018</td>
<td>1587</td>
<td>8</td>
<td>11</td>
<td>19.0</td>
<td>48</td>
<td>33</td>
<td>7</td>
<td>125</td>
<td>383</td>
<td>299</td>
<td>18</td>
<td>14</td>
<td>14</td>
<td>13</td>
<td>173</td>
<td>23</td>
<td>48</td>
<td>68.0</td>
<td>210</td>
<td>112</td>
<td>5522.0</td>
<td>14</td>
<td>46</td>
<td>35</td>
<td>1568</td>
<td>14.0</td>
<td>95.0</td>
<td>50</td>
<td>7.0</td>
<td>77.0</td>
<td>269</td>
</tr>
</tbody>
</table>
<p>Great! We now have a clean looking datset with each row representing one team in a game. Let's now eliminate the outliers from a dataset. We know that Essendon had a doping scandal which resulted in their entire team being banned for a year in 2016, so let's remove all of their 2016 games. To do this we will filter based on the team and season, and then invert this with ~.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="c1"># Define a function which eliminates outliers</span>
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">outlier_eliminator</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
<a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a>    <span class="c1"># Eliminate Essendon 2016 games</span>
<a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a>    <span class="n">essendon_filter_criteria</span> <span class="o">=</span> <span class="o">~</span><span class="p">(((</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;team&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Essendon&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;season&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2016</span><span class="p">))</span> <span class="o">|</span> <span class="p">((</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;opponent&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Essendon&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;season&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2016</span><span class="p">)))</span>
<a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a>    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">essendon_filter_criteria</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a>
<a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a>    <span class="k">return</span> <span class="n">df</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="n">afl_data</span> <span class="o">=</span> <span class="n">outlier_eliminator</span><span class="p">(</span><span class="n">merged_df</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="n">afl_data</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</code></pre></div>
<table>
<thead>
<tr>
<th></th>
<th>team</th>
<th>odds</th>
<th>date</th>
<th>home_game</th>
<th>game</th>
<th>round</th>
<th>goals</th>
<th>behinds</th>
<th>points</th>
<th>margin</th>
<th>venue</th>
<th>opponent</th>
<th>opponent_goals</th>
<th>opponent_behinds</th>
<th>opponent_points</th>
<th>season</th>
<th>AF</th>
<th>B</th>
<th>BO</th>
<th>CCL</th>
<th>CG</th>
<th>CL</th>
<th>CM</th>
<th>CP</th>
<th>D</th>
<th>ED</th>
<th>FA</th>
<th>FF</th>
<th>G</th>
<th>GA</th>
<th>HB</th>
<th>HO</th>
<th>I50</th>
<th>ITC</th>
<th>K</th>
<th>M</th>
<th>MG</th>
<th>MI5</th>
<th>One.Percenters</th>
<th>R50</th>
<th>SC</th>
<th>SCL</th>
<th>SI</th>
<th>T</th>
<th>T5</th>
<th>TO</th>
<th>UP</th>
</tr>
</thead>
<tbody>
<tr>
<td>3154</td>
<td>Melbourne</td>
<td>1.5116</td>
<td>2018-08-26</td>
<td>1</td>
<td>15397</td>
<td>23</td>
<td>15</td>
<td>12</td>
<td>102</td>
<td>45</td>
<td>M.C.G.</td>
<td>GWS</td>
<td>8</td>
<td>9</td>
<td>57</td>
<td>2018</td>
<td>1712</td>
<td>8</td>
<td>12</td>
<td>10.0</td>
<td>38</td>
<td>30</td>
<td>12</td>
<td>139</td>
<td>403</td>
<td>302</td>
<td>13</td>
<td>19</td>
<td>15</td>
<td>14</td>
<td>181</td>
<td>48</td>
<td>54</td>
<td>59.0</td>
<td>222</td>
<td>106</td>
<td>6198.0</td>
<td>16</td>
<td>34</td>
<td>39</td>
<td>1768</td>
<td>20.0</td>
<td>147.0</td>
<td>60</td>
<td>2.0</td>
<td>53.0</td>
<td>269</td>
</tr>
<tr>
<td>3155</td>
<td>North Melbourne</td>
<td>1.3936</td>
<td>2018-08-26</td>
<td>0</td>
<td>15398</td>
<td>23</td>
<td>17</td>
<td>15</td>
<td>117</td>
<td>23</td>
<td>Docklands</td>
<td>St Kilda</td>
<td>14</td>
<td>10</td>
<td>94</td>
<td>2018</td>
<td>1707</td>
<td>13</td>
<td>7</td>
<td>15.0</td>
<td>50</td>
<td>24</td>
<td>6</td>
<td>131</td>
<td>425</td>
<td>322</td>
<td>14</td>
<td>18</td>
<td>17</td>
<td>13</td>
<td>201</td>
<td>32</td>
<td>59</td>
<td>77.0</td>
<td>224</td>
<td>106</td>
<td>5833.0</td>
<td>23</td>
<td>33</td>
<td>29</td>
<td>1735</td>
<td>9.0</td>
<td>154.0</td>
<td>48</td>
<td>9.0</td>
<td>66.0</td>
<td>300</td>
</tr>
<tr>
<td>3156</td>
<td>St Kilda</td>
<td>3.5178</td>
<td>2018-08-26</td>
<td>1</td>
<td>15398</td>
<td>23</td>
<td>14</td>
<td>10</td>
<td>94</td>
<td>-23</td>
<td>Docklands</td>
<td>North Melbourne</td>
<td>17</td>
<td>15</td>
<td>117</td>
<td>2018</td>
<td>1587</td>
<td>8</td>
<td>11</td>
<td>19.0</td>
<td>48</td>
<td>33</td>
<td>7</td>
<td>125</td>
<td>383</td>
<td>299</td>
<td>18</td>
<td>14</td>
<td>14</td>
<td>13</td>
<td>173</td>
<td>23</td>
<td>48</td>
<td>68.0</td>
<td>210</td>
<td>112</td>
<td>5522.0</td>
<td>14</td>
<td>46</td>
<td>35</td>
<td>1568</td>
<td>14.0</td>
<td>95.0</td>
<td>50</td>
<td>7.0</td>
<td>77.0</td>
<td>269</td>
</tr>
</tbody>
</table>
<p>Finally, let's mark all of the columns that we are going to use in feature creation with the string 'f_' at the start of their column name so that we can easily filter for these columns.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="n">non_feature_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;team&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;home_game&#39;</span><span class="p">,</span> <span class="s1">&#39;game&#39;</span><span class="p">,</span> <span class="s1">&#39;round&#39;</span><span class="p">,</span> <span class="s1">&#39;venue&#39;</span><span class="p">,</span> <span class="s1">&#39;opponent&#39;</span><span class="p">,</span> <span class="s1">&#39;season&#39;</span><span class="p">]</span>
<a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a><span class="n">afl_data</span> <span class="o">=</span> <span class="n">afl_data</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">col</span><span class="p">:</span> <span class="s1">&#39;f_&#39;</span> <span class="o">+</span> <span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">afl_data</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">non_feature_cols</span><span class="p">})</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="n">afl_data</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</code></pre></div>
<table>
<thead>
<tr>
<th></th>
<th>team</th>
<th>f_odds</th>
<th>date</th>
<th>home_game</th>
<th>game</th>
<th>round</th>
<th>f_goals</th>
<th>f_behinds</th>
<th>f_points</th>
<th>f_margin</th>
<th>venue</th>
<th>opponent</th>
<th>f_opponent_goals</th>
<th>f_opponent_behinds</th>
<th>f_opponent_points</th>
<th>season</th>
<th>f_AF</th>
<th>f_B</th>
<th>f_BO</th>
<th>f_CCL</th>
<th>f_CG</th>
<th>f_CL</th>
<th>f_CM</th>
<th>f_CP</th>
<th>f_D</th>
<th>f_ED</th>
<th>f_FA</th>
<th>f_FF</th>
<th>f_G</th>
<th>f_GA</th>
<th>f_HB</th>
<th>f_HO</th>
<th>f_I50</th>
<th>f_ITC</th>
<th>f_K</th>
<th>f_M</th>
<th>f_MG</th>
<th>f_MI5</th>
<th>f_One.Percenters</th>
<th>f_R50</th>
<th>f_SC</th>
<th>f_SCL</th>
<th>f_SI</th>
<th>f_T</th>
<th>f_T5</th>
<th>f_TO</th>
<th>f_UP</th>
</tr>
</thead>
<tbody>
<tr>
<td>3154</td>
<td>Melbourne</td>
<td>1.5116</td>
<td>2018-08-26</td>
<td>1</td>
<td>15397</td>
<td>23</td>
<td>15</td>
<td>12</td>
<td>102</td>
<td>45</td>
<td>M.C.G.</td>
<td>GWS</td>
<td>8</td>
<td>9</td>
<td>57</td>
<td>2018</td>
<td>1712</td>
<td>8</td>
<td>12</td>
<td>10.0</td>
<td>38</td>
<td>30</td>
<td>12</td>
<td>139</td>
<td>403</td>
<td>302</td>
<td>13</td>
<td>19</td>
<td>15</td>
<td>14</td>
<td>181</td>
<td>48</td>
<td>54</td>
<td>59.0</td>
<td>222</td>
<td>106</td>
<td>6198.0</td>
<td>16</td>
<td>34</td>
<td>39</td>
<td>1768</td>
<td>20.0</td>
<td>147.0</td>
<td>60</td>
<td>2.0</td>
<td>53.0</td>
<td>269</td>
</tr>
<tr>
<td>3155</td>
<td>North Melbourne</td>
<td>1.3936</td>
<td>2018-08-26</td>
<td>0</td>
<td>15398</td>
<td>23</td>
<td>17</td>
<td>15</td>
<td>117</td>
<td>23</td>
<td>Docklands</td>
<td>St Kilda</td>
<td>14</td>
<td>10</td>
<td>94</td>
<td>2018</td>
<td>1707</td>
<td>13</td>
<td>7</td>
<td>15.0</td>
<td>50</td>
<td>24</td>
<td>6</td>
<td>131</td>
<td>425</td>
<td>322</td>
<td>14</td>
<td>18</td>
<td>17</td>
<td>13</td>
<td>201</td>
<td>32</td>
<td>59</td>
<td>77.0</td>
<td>224</td>
<td>106</td>
<td>5833.0</td>
<td>23</td>
<td>33</td>
<td>29</td>
<td>1735</td>
<td>9.0</td>
<td>154.0</td>
<td>48</td>
<td>9.0</td>
<td>66.0</td>
<td>300</td>
</tr>
<tr>
<td>3156</td>
<td>St Kilda</td>
<td>3.5178</td>
<td>2018-08-26</td>
<td>1</td>
<td>15398</td>
<td>23</td>
<td>14</td>
<td>10</td>
<td>94</td>
<td>-23</td>
<td>Docklands</td>
<td>North Melbourne</td>
<td>17</td>
<td>15</td>
<td>117</td>
<td>2018</td>
<td>1587</td>
<td>8</td>
<td>11</td>
<td>19.0</td>
<td>48</td>
<td>33</td>
<td>7</td>
<td>125</td>
<td>383</td>
<td>299</td>
<td>18</td>
<td>14</td>
<td>14</td>
<td>13</td>
<td>173</td>
<td>23</td>
<td>48</td>
<td>68.0</td>
<td>210</td>
<td>112</td>
<td>5522.0</td>
<td>14</td>
<td>46</td>
<td>35</td>
<td>1568</td>
<td>14.0</td>
<td>95.0</td>
<td>50</td>
<td>7.0</td>
<td>77.0</td>
<td>269</td>
</tr>
</tbody>
</table>
<p>Our data is now fully ready to be explored and for features to be created.</p>
<hr />
<h1 id="02-feature-creation">02. Feature Creation</h1>
<p>These tutorials will walk you through how to construct your own basic AFL model. The output will be odds for each team to win, which will be shown on <a href="https://www.betfair.com.au/hub/sports/afl/how-to-build-an-afl-model/">The Hub</a>.</p>
<p>In this notebook we will walk you through creating features from our dataset, which was cleaned in the first tutorial. Feature engineering is an integral part of the Data Science process. Creative and smart features can be the difference between an average performing model and a model profitable which beats the market odds.</p>
<hr />
<h2 id="grabbing-our-dataset">Grabbing Our Dataset</h2>
<p>First, we will import our required modules, as well as the prepare_afl_data function which we created in our afl_data_cleaning script. This essentially cleans all the data for us so that we're ready to explore the data and make some features.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="c1"># Import modules</span>
<a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">afl_data_cleaning_v2</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">afl_data_cleaning_v2</span>
<a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a><span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.max_columns&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<a id="__codelineno-22-7" name="__codelineno-22-7" href="#__codelineno-22-7"></a><span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
<a id="__codelineno-22-8" name="__codelineno-22-8" href="#__codelineno-22-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="c1"># Use the prepare_afl_data function to prepare the data for us; this function condenses what we walked through in the previous tutorial</span>
<a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a><span class="n">afl_data</span> <span class="o">=</span> <span class="n">prepare_afl_data</span><span class="p">()</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="n">afl_data</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</code></pre></div>
<table>
<thead>
<tr>
<th></th>
<th>team</th>
<th>f_odds</th>
<th>date</th>
<th>home_game</th>
<th>game</th>
<th>round</th>
<th>f_goals</th>
<th>f_behinds</th>
<th>f_points</th>
<th>f_margin</th>
<th>venue</th>
<th>opponent</th>
<th>f_opponent_goals</th>
<th>f_opponent_behinds</th>
<th>f_opponent_points</th>
<th>season</th>
<th>f_AF</th>
<th>f_B</th>
<th>f_BO</th>
<th>f_CCL</th>
<th>f_CG</th>
<th>f_CL</th>
<th>f_CM</th>
<th>f_CP</th>
<th>f_D</th>
<th>f_ED</th>
<th>f_FA</th>
<th>f_FF</th>
<th>f_G</th>
<th>f_GA</th>
<th>f_HB</th>
<th>f_HO</th>
<th>f_I50</th>
<th>f_ITC</th>
<th>f_K</th>
<th>f_M</th>
<th>f_MG</th>
<th>f_MI5</th>
<th>f_One.Percenters</th>
<th>f_R50</th>
<th>f_SC</th>
<th>f_SCL</th>
<th>f_SI</th>
<th>f_T</th>
<th>f_T5</th>
<th>f_TO</th>
<th>f_UP</th>
</tr>
</thead>
<tbody>
<tr>
<td>3154</td>
<td>Melbourne</td>
<td>1.5116</td>
<td>2018-08-26</td>
<td>1</td>
<td>15397</td>
<td>23</td>
<td>15</td>
<td>12</td>
<td>102</td>
<td>45</td>
<td>M.C.G.</td>
<td>GWS</td>
<td>8</td>
<td>9</td>
<td>57</td>
<td>2018</td>
<td>1712</td>
<td>8</td>
<td>12</td>
<td>10.0</td>
<td>38</td>
<td>30</td>
<td>12</td>
<td>139</td>
<td>403</td>
<td>302</td>
<td>13</td>
<td>19</td>
<td>15</td>
<td>14</td>
<td>181</td>
<td>48</td>
<td>54</td>
<td>59.0</td>
<td>222</td>
<td>106</td>
<td>6198.0</td>
<td>16</td>
<td>34</td>
<td>39</td>
<td>1768</td>
<td>20.0</td>
<td>147.0</td>
<td>60</td>
<td>2.0</td>
<td>53.0</td>
<td>269</td>
</tr>
<tr>
<td>3155</td>
<td>North Melbourne</td>
<td>1.3936</td>
<td>2018-08-26</td>
<td>0</td>
<td>15398</td>
<td>23</td>
<td>17</td>
<td>15</td>
<td>117</td>
<td>23</td>
<td>Docklands</td>
<td>St Kilda</td>
<td>14</td>
<td>10</td>
<td>94</td>
<td>2018</td>
<td>1707</td>
<td>13</td>
<td>7</td>
<td>15.0</td>
<td>50</td>
<td>24</td>
<td>6</td>
<td>131</td>
<td>425</td>
<td>322</td>
<td>14</td>
<td>18</td>
<td>17</td>
<td>13</td>
<td>201</td>
<td>32</td>
<td>59</td>
<td>77.0</td>
<td>224</td>
<td>106</td>
<td>5833.0</td>
<td>23</td>
<td>33</td>
<td>29</td>
<td>1735</td>
<td>9.0</td>
<td>154.0</td>
<td>48</td>
<td>9.0</td>
<td>66.0</td>
<td>300</td>
</tr>
<tr>
<td>3156</td>
<td>St Kilda</td>
<td>3.5178</td>
<td>2018-08-26</td>
<td>1</td>
<td>15398</td>
<td>23</td>
<td>14</td>
<td>10</td>
<td>94</td>
<td>-23</td>
<td>Docklands</td>
<td>North Melbourne</td>
<td>17</td>
<td>15</td>
<td>117</td>
<td>2018</td>
<td>1587</td>
<td>8</td>
<td>11</td>
<td>19.0</td>
<td>48</td>
<td>33</td>
<td>7</td>
<td>125</td>
<td>383</td>
<td>299</td>
<td>18</td>
<td>14</td>
<td>14</td>
<td>13</td>
<td>173</td>
<td>23</td>
<td>48</td>
<td>68.0</td>
<td>210</td>
<td>112</td>
<td>5522.0</td>
<td>14</td>
<td>46</td>
<td>35</td>
<td>1568</td>
<td>14.0</td>
<td>95.0</td>
<td>50</td>
<td>7.0</td>
<td>77.0</td>
<td>269</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="creating-a-feature-dataframe">Creating A Feature DataFrame</h2>
<p>Let's create a feature DataFrame and merge all of our features into this DataFrame as we go.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="n">features</span> <span class="o">=</span> <span class="n">afl_data</span><span class="p">[[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;game&#39;</span><span class="p">,</span> <span class="s1">&#39;team&#39;</span><span class="p">,</span> <span class="s1">&#39;opponent&#39;</span><span class="p">,</span> <span class="s1">&#39;venue&#39;</span><span class="p">,</span> <span class="s1">&#39;home_game&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</code></pre></div>
<h3 id="what-each-column-refers-to">What Each Column Refers To</h3>
<p>Below is a DataFrame which outlines what each column refers to.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="n">column_abbreviations</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;data/afl_data_columns_mapping.csv&quot;</span><span class="p">)</span>
<a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a><span class="n">column_abbreviations</span>
</code></pre></div>
<table>
<thead>
<tr>
<th></th>
<th>Feature Abbreviated</th>
<th>Feature</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>GA</td>
<td>Goal Assists</td>
</tr>
<tr>
<td>1</td>
<td>CP</td>
<td>Contested Possessions</td>
</tr>
<tr>
<td>2</td>
<td>UP</td>
<td>Uncontested Possessions</td>
</tr>
<tr>
<td>3</td>
<td>ED</td>
<td>Effective Disposals</td>
</tr>
<tr>
<td>4</td>
<td>CM</td>
<td>Contested Marks</td>
</tr>
<tr>
<td>5</td>
<td>MI5</td>
<td>Marks Inside 50</td>
</tr>
<tr>
<td>6</td>
<td>One.Percenters</td>
<td>One Percenters</td>
</tr>
<tr>
<td>7</td>
<td>BO</td>
<td>Bounces</td>
</tr>
<tr>
<td>8</td>
<td>K</td>
<td>Kicks</td>
</tr>
<tr>
<td>9</td>
<td>HB</td>
<td>Handballs</td>
</tr>
<tr>
<td>10</td>
<td>D</td>
<td>Disposals</td>
</tr>
<tr>
<td>11</td>
<td>M</td>
<td>Marks</td>
</tr>
<tr>
<td>12</td>
<td>G</td>
<td>Goals</td>
</tr>
<tr>
<td>13</td>
<td>B</td>
<td>Behinds</td>
</tr>
<tr>
<td>14</td>
<td>T</td>
<td>Tackles</td>
</tr>
<tr>
<td>15</td>
<td>HO</td>
<td>Hitouts</td>
</tr>
<tr>
<td>16</td>
<td>I50</td>
<td>Inside 50s</td>
</tr>
<tr>
<td>17</td>
<td>CL</td>
<td>Clearances</td>
</tr>
<tr>
<td>18</td>
<td>CG</td>
<td>Clangers</td>
</tr>
<tr>
<td>19</td>
<td>R50</td>
<td>Rebound 50s</td>
</tr>
<tr>
<td>20</td>
<td>FF</td>
<td>Frees For</td>
</tr>
<tr>
<td>21</td>
<td>FA</td>
<td>Frees Against</td>
</tr>
<tr>
<td>22</td>
<td>AF</td>
<td>AFL Fantasy Points</td>
</tr>
<tr>
<td>23</td>
<td>SC</td>
<td>Supercoach Points</td>
</tr>
<tr>
<td>24</td>
<td>CCL</td>
<td>Centre Clearances</td>
</tr>
<tr>
<td>25</td>
<td>SCL</td>
<td>Stoppage Clearances</td>
</tr>
<tr>
<td>26</td>
<td>SI</td>
<td>Score Involvements</td>
</tr>
<tr>
<td>27</td>
<td>MG</td>
<td>Metres Gained</td>
</tr>
<tr>
<td>28</td>
<td>TO</td>
<td>Turnovers</td>
</tr>
<tr>
<td>29</td>
<td>ITC</td>
<td>Intercepts</td>
</tr>
<tr>
<td>30</td>
<td>T5</td>
<td>Tackles Inside 50</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="feature-creation">Feature Creation</h2>
<p>Now let's think about what features we can create. We have a enormous amount of stats to sift through. To start, let's create some simple features based on our domain knowledge of Aussie Rules.</p>
<h3 id="creating-expontentially-weighted-rolling-averages-as-features">Creating Expontentially Weighted Rolling Averages as Features</h3>
<p>Next, we will create rolling averages of statistics such as Tackles, which we will use as features.</p>
<p>It is fair to assume that a team's performance in a certain stat may have predictive power to the overall result. And in general, if a team consistently performs well in this stat, this may have predictive power to the result of their future games. We can't simply train a model on stats from the game which we are trying to predict (i.e. data that we don't have before the game begins), as this will leak the result. We need to train our model on past data. One way of doing this is to train our model on average stats over a certain amount of games. If a team is averaging high in this stat, this may give insight into if they are a strong team. Similarly, if the team is averaging poorly in this stat (relative to the team they are playing), this may have predictive power and give rise to a predicted loss.</p>
<p>To do this we will create a function which calculates the rolling averages, known as create_exp_weighted_avgs, which takes our cleaned DataFrame as an input, as well as the alpha which, when higher, weights recent performances more than old performances. To read more about expontentially weighted moving averages, please read the documentation <a href="https://pandas.pydata.org/pandas-docs/stable/generated/pandas.DataFrame.ewm.html">here</a>.</p>
<p>First, we will grab all the columns which we want to create EMAs for, and then use our function to create the average for that column. We will create a new DataFrame and add these columns to this new DataFrame.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="c1"># Define a function which returns a DataFrame with the expontential moving average for each numeric stat</span>
<a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">create_exp_weighted_avgs</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">span</span><span class="p">):</span>
<a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a>    <span class="c1"># Create a copy of the df with only the game id and the team - we will add cols to this df</span>
<a id="__codelineno-27-4" name="__codelineno-27-4" href="#__codelineno-27-4"></a>    <span class="n">ema_features</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;game&#39;</span><span class="p">,</span> <span class="s1">&#39;team&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-27-5" name="__codelineno-27-5" href="#__codelineno-27-5"></a>
<a id="__codelineno-27-6" name="__codelineno-27-6" href="#__codelineno-27-6"></a>    <span class="n">feature_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;f_&#39;</span><span class="p">)]</span> <span class="c1"># Get a list of columns we will iterate over</span>
<a id="__codelineno-27-7" name="__codelineno-27-7" href="#__codelineno-27-7"></a>
<a id="__codelineno-27-8" name="__codelineno-27-8" href="#__codelineno-27-8"></a>    <span class="k">for</span> <span class="n">feature_name</span> <span class="ow">in</span> <span class="n">feature_names</span><span class="p">:</span>
<a id="__codelineno-27-9" name="__codelineno-27-9" href="#__codelineno-27-9"></a>        <span class="n">feature_ema</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;team&#39;</span><span class="p">)[</span><span class="n">feature_name</span><span class="p">]</span>
<a id="__codelineno-27-10" name="__codelineno-27-10" href="#__codelineno-27-10"></a>                         <span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">ewm</span><span class="p">(</span><span class="n">span</span><span class="o">=</span><span class="n">span</span><span class="p">)</span>
<a id="__codelineno-27-11" name="__codelineno-27-11" href="#__codelineno-27-11"></a>                                                    <span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<a id="__codelineno-27-12" name="__codelineno-27-12" href="#__codelineno-27-12"></a>                                                    <span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">))))</span>
<a id="__codelineno-27-13" name="__codelineno-27-13" href="#__codelineno-27-13"></a>        <span class="n">ema_features</span><span class="p">[</span><span class="n">feature_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">feature_ema</span>
<a id="__codelineno-27-14" name="__codelineno-27-14" href="#__codelineno-27-14"></a>
<a id="__codelineno-27-15" name="__codelineno-27-15" href="#__codelineno-27-15"></a>    <span class="k">return</span> <span class="n">ema_features</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a><span class="n">features_rolling_averages</span> <span class="o">=</span> <span class="n">create_exp_weighted_avgs</span><span class="p">(</span><span class="n">afl_data</span><span class="p">,</span> <span class="n">span</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a><span class="n">features_rolling_averages</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span>
</code></pre></div>
<table>
<thead>
<tr>
<th></th>
<th>game</th>
<th>team</th>
<th>f_odds</th>
<th>f_goals</th>
<th>f_behinds</th>
<th>f_points</th>
<th>f_margin</th>
<th>f_opponent_goals</th>
<th>f_opponent_behinds</th>
<th>f_opponent_points</th>
<th>f_AF</th>
<th>f_B</th>
<th>f_BO</th>
<th>f_CCL</th>
<th>f_CG</th>
<th>f_CL</th>
<th>f_CM</th>
<th>f_CP</th>
<th>f_D</th>
<th>f_ED</th>
<th>f_FA</th>
<th>f_FF</th>
<th>f_G</th>
<th>f_GA</th>
<th>f_HB</th>
<th>f_HO</th>
<th>f_I50</th>
<th>f_ITC</th>
<th>f_K</th>
<th>f_M</th>
<th>f_MG</th>
<th>f_MI5</th>
<th>f_One.Percenters</th>
<th>f_R50</th>
<th>f_SC</th>
<th>f_SCL</th>
<th>f_SI</th>
<th>f_T</th>
<th>f_T5</th>
<th>f_TO</th>
<th>f_UP</th>
</tr>
</thead>
<tbody>
<tr>
<td>3152</td>
<td>15396</td>
<td>West Coast</td>
<td>2.094236</td>
<td>12.809630</td>
<td>10.047145</td>
<td>86.904928</td>
<td>8.888770</td>
<td>11.435452</td>
<td>9.403444</td>
<td>78.016158</td>
<td>3193.612782</td>
<td>16.472115</td>
<td>11.958482</td>
<td>23.379562</td>
<td>100.095244</td>
<td>68.252001</td>
<td>27.688669</td>
<td>284.463270</td>
<td>719.884644</td>
<td>525.878017</td>
<td>36.762440</td>
<td>44.867118</td>
<td>25.618202</td>
<td>17.522871</td>
<td>270.478779</td>
<td>88.139376</td>
<td>105.698031</td>
<td>148.005305</td>
<td>449.405865</td>
<td>201.198907</td>
<td>11581.929999</td>
<td>20.048124</td>
<td>95.018480</td>
<td>74.180967</td>
<td>3314.157893</td>
<td>44.872398</td>
<td>177.894442</td>
<td>126.985101</td>
<td>20.565549</td>
<td>138.876613</td>
<td>438.848376</td>
</tr>
<tr>
<td>3153</td>
<td>15397</td>
<td>GWS</td>
<td>1.805565</td>
<td>13.100372</td>
<td>13.179329</td>
<td>91.781563</td>
<td>18.527618</td>
<td>10.371198</td>
<td>11.026754</td>
<td>73.253945</td>
<td>3165.127358</td>
<td>19.875913</td>
<td>12.947209</td>
<td>25.114002</td>
<td>105.856671</td>
<td>80.609640</td>
<td>23.374884</td>
<td>303.160047</td>
<td>741.439198</td>
<td>534.520295</td>
<td>42.597317</td>
<td>38.160889</td>
<td>26.208715</td>
<td>18.688880</td>
<td>300.188301</td>
<td>81.540693</td>
<td>106.989070</td>
<td>143.032506</td>
<td>441.250897</td>
<td>173.050118</td>
<td>12091.630837</td>
<td>21.106142</td>
<td>103.077097</td>
<td>80.201059</td>
<td>3419.245919</td>
<td>55.495610</td>
<td>219.879895</td>
<td>138.202470</td>
<td>25.313148</td>
<td>135.966798</td>
<td>438.466439</td>
</tr>
<tr>
<td>3154</td>
<td>15397</td>
<td>Melbourne</td>
<td>1.706488</td>
<td>15.157271</td>
<td>13.815113</td>
<td>104.758740</td>
<td>25.170429</td>
<td>11.814319</td>
<td>8.702396</td>
<td>79.588311</td>
<td>3312.408470</td>
<td>22.077317</td>
<td>7.724955</td>
<td>28.364418</td>
<td>114.399147</td>
<td>78.406069</td>
<td>26.934677</td>
<td>324.352577</td>
<td>775.176933</td>
<td>547.385948</td>
<td>39.353251</td>
<td>36.025646</td>
<td>30.308918</td>
<td>22.461080</td>
<td>348.613592</td>
<td>99.787800</td>
<td>120.339062</td>
<td>154.417642</td>
<td>426.563341</td>
<td>178.102118</td>
<td>12395.717925</td>
<td>32.168752</td>
<td>96.390688</td>
<td>63.786515</td>
<td>3427.596843</td>
<td>50.041649</td>
<td>232.287556</td>
<td>144.875098</td>
<td>23.789233</td>
<td>149.042149</td>
<td>456.988552</td>
</tr>
<tr>
<td>3155</td>
<td>15398</td>
<td>North Melbourne</td>
<td>2.272313</td>
<td>12.721783</td>
<td>10.733785</td>
<td>87.064486</td>
<td>-1.214246</td>
<td>12.915796</td>
<td>10.783958</td>
<td>88.278732</td>
<td>3066.272143</td>
<td>17.322710</td>
<td>9.815243</td>
<td>26.015421</td>
<td>106.465181</td>
<td>67.504286</td>
<td>26.064079</td>
<td>291.259574</td>
<td>736.279779</td>
<td>534.154748</td>
<td>34.301603</td>
<td>40.908551</td>
<td>25.386136</td>
<td>17.816570</td>
<td>341.210547</td>
<td>81.541130</td>
<td>102.589427</td>
<td>145.265493</td>
<td>395.069232</td>
<td>173.089408</td>
<td>10875.002463</td>
<td>21.802751</td>
<td>82.347511</td>
<td>70.416194</td>
<td>3171.120023</td>
<td>41.488865</td>
<td>197.620152</td>
<td>122.547684</td>
<td>22.286256</td>
<td>142.780474</td>
<td>450.374058</td>
</tr>
<tr>
<td>3156</td>
<td>15398</td>
<td>St Kilda</td>
<td>5.516150</td>
<td>10.464266</td>
<td>11.957047</td>
<td>74.742643</td>
<td>-21.138101</td>
<td>14.105551</td>
<td>11.247440</td>
<td>95.880745</td>
<td>3094.163405</td>
<td>20.523847</td>
<td>14.569589</td>
<td>24.134276</td>
<td>102.540441</td>
<td>66.976211</td>
<td>18.018350</td>
<td>270.674857</td>
<td>773.086015</td>
<td>573.769838</td>
<td>41.319843</td>
<td>36.198820</td>
<td>20.850476</td>
<td>14.443658</td>
<td>364.405251</td>
<td>63.498760</td>
<td>103.803779</td>
<td>130.494307</td>
<td>408.680763</td>
<td>184.780054</td>
<td>10765.717942</td>
<td>21.572806</td>
<td>94.731555</td>
<td>65.790561</td>
<td>3228.278599</td>
<td>42.841935</td>
<td>196.086493</td>
<td>115.901425</td>
<td>18.796764</td>
<td>127.364334</td>
<td>508.844514</td>
</tr>
</tbody>
</table>
<p>As you can see our function worked perfectly! Now we have a full DataFrame of exponentially weighted moving averages. Note that as these rolling averages have been shifted by 1 to ensure no data leakage, the first round of the data will have all NA values. We can drop these later.</p>
<p>Let's add these averages to our features DataFrame</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a><span class="n">features</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">features_rolling_averages</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;game&#39;</span><span class="p">,</span> <span class="s1">&#39;team&#39;</span><span class="p">])</span>
</code></pre></div>
<h3 id="creating-a-form-between-the-teams-feature">Creating a 'Form Between the Teams' Feature</h3>
<p>It is well known in Aussie Rules that often some teams perform better against certain teams than others. If we isolate our features to pure stats based on previous games not between the teams playing, or elo ratings, we won't account for any relationships between certain teams. An example is the <a href="https://en.wikipedia.org/wiki/Kennett_curse">Kennett Curse</a>, where Geelong won 11 consecutive games against Hawthorn, despite being similarly matched teams. Let's create a feature which calculates how many games a team has won against their opposition over a given window of games.</p>
<p>To do this, we will need to use historical data that dates back well before our current DataFrame starts at. Otherwise we will be using a lot of our games to calculate form, meaning we will have to drop these rows before feeding it into an algorithm. So let's use our prepare_match_results function which we defined in the afl_data_cleaning tutorial to grab a clean DataFrame of all match results since 1897. We can then calculate the form and join this to our current DataFrame.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a><span class="n">match_results</span> <span class="o">=</span> <span class="n">afl_data_cleaning_v2</span><span class="o">.</span><span class="n">get_cleaned_match_results</span><span class="p">()</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a><span class="n">match_results</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</code></pre></div>
<table>
<thead>
<tr>
<th></th>
<th>game</th>
<th>date</th>
<th>round</th>
<th>team</th>
<th>goals</th>
<th>behinds</th>
<th>points</th>
<th>margin</th>
<th>venue</th>
<th>opponent</th>
<th>opponent_goals</th>
<th>opponent_behinds</th>
<th>opponent_points</th>
<th>home_game</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>1</td>
<td>1897-05-08</td>
<td>1</td>
<td>Fitzroy</td>
<td>6</td>
<td>13</td>
<td>49</td>
<td>33</td>
<td>Brunswick St</td>
<td>Carlton</td>
<td>2</td>
<td>4</td>
<td>16</td>
<td>1</td>
</tr>
<tr>
<td>1</td>
<td>1</td>
<td>1897-05-08</td>
<td>1</td>
<td>Carlton</td>
<td>2</td>
<td>4</td>
<td>16</td>
<td>-33</td>
<td>Brunswick St</td>
<td>Fitzroy</td>
<td>6</td>
<td>13</td>
<td>49</td>
<td>0</td>
</tr>
<tr>
<td>2</td>
<td>2</td>
<td>1897-05-08</td>
<td>1</td>
<td>Collingwood</td>
<td>5</td>
<td>11</td>
<td>41</td>
<td>25</td>
<td>Victoria Park</td>
<td>St Kilda</td>
<td>2</td>
<td>4</td>
<td>16</td>
<td>1</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre><span></span><code><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a><span class="n">form_btwn_teams</span> <span class="o">=</span> <span class="n">match_results</span><span class="p">[[</span><span class="s1">&#39;game&#39;</span><span class="p">,</span> <span class="s1">&#39;team&#39;</span><span class="p">,</span> <span class="s1">&#39;opponent&#39;</span><span class="p">,</span> <span class="s1">&#39;margin&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-33-2" name="__codelineno-33-2" href="#__codelineno-33-2"></a>
<a id="__codelineno-33-3" name="__codelineno-33-3" href="#__codelineno-33-3"></a><span class="n">form_btwn_teams</span><span class="p">[</span><span class="s1">&#39;f_form_margin_btwn_teams&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">match_results</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;team&#39;</span><span class="p">,</span> <span class="s1">&#39;opponent&#39;</span><span class="p">])[</span><span class="s1">&#39;margin&#39;</span><span class="p">]</span>
<a id="__codelineno-33-4" name="__codelineno-33-4" href="#__codelineno-33-4"></a>                                                          <span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">row</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">shift</span><span class="p">())</span>
<a id="__codelineno-33-5" name="__codelineno-33-5" href="#__codelineno-33-5"></a>                                                          <span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
<a id="__codelineno-33-6" name="__codelineno-33-6" href="#__codelineno-33-6"></a>
<a id="__codelineno-33-7" name="__codelineno-33-7" href="#__codelineno-33-7"></a><span class="n">form_btwn_teams</span><span class="p">[</span><span class="s1">&#39;f_form_past_5_btwn_teams&#39;</span><span class="p">]</span> <span class="o">=</span> \
<a id="__codelineno-33-8" name="__codelineno-33-8" href="#__codelineno-33-8"></a><span class="p">(</span><span class="n">match_results</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">win</span><span class="o">=</span><span class="k">lambda</span> <span class="n">df</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">margin</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;columns&#39;</span><span class="p">))</span>
<a id="__codelineno-33-9" name="__codelineno-33-9" href="#__codelineno-33-9"></a>              <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;team&#39;</span><span class="p">,</span> <span class="s1">&#39;opponent&#39;</span><span class="p">])[</span><span class="s1">&#39;win&#39;</span><span class="p">]</span>
<a id="__codelineno-33-10" name="__codelineno-33-10" href="#__codelineno-33-10"></a>              <span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">row</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">shift</span><span class="p">()</span> <span class="o">*</span> <span class="mi">5</span><span class="p">)</span>
<a id="__codelineno-33-11" name="__codelineno-33-11" href="#__codelineno-33-11"></a>              <span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a><span class="n">form_btwn_teams</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</code></pre></div>
<table>
<thead>
<tr>
<th></th>
<th>game</th>
<th>team</th>
<th>opponent</th>
<th>margin</th>
<th>f_form_margin_btwn_teams</th>
<th>f_form_past_5_btwn_teams</th>
</tr>
</thead>
<tbody>
<tr>
<td>30793</td>
<td>15397</td>
<td>Melbourne</td>
<td>GWS</td>
<td>45</td>
<td>-23.2</td>
<td>2.0</td>
</tr>
<tr>
<td>30794</td>
<td>15398</td>
<td>St Kilda</td>
<td>North Melbourne</td>
<td>-23</td>
<td>-3.2</td>
<td>2.0</td>
</tr>
<tr>
<td>30795</td>
<td>15398</td>
<td>North Melbourne</td>
<td>St Kilda</td>
<td>23</td>
<td>3.2</td>
<td>3.0</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre><span></span><code><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a><span class="c1"># Merge to our features df</span>
<a id="__codelineno-35-2" name="__codelineno-35-2" href="#__codelineno-35-2"></a><span class="n">features</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">form_btwn_teams</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;margin&#39;</span><span class="p">]),</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;game&#39;</span><span class="p">,</span> <span class="s1">&#39;team&#39;</span><span class="p">,</span> <span class="s1">&#39;opponent&#39;</span><span class="p">])</span>
</code></pre></div>
<h3 id="creating-efficiency-features">Creating Efficiency Features</h3>
<h4 id="disposal-efficiency">Disposal Efficiency</h4>
<p>Disposal efficiency is pivotal in Aussie Rules football. If you are dispose of the ball effectively you are much more likely to score and much less likely to concede goals than if you dispose of it ineffectively.</p>
<p>Let's create a disposal efficiency feature by dividing Effective Disposals by Disposals.</p>
<h4 id="inside-50rebound-50-efficiency">Inside 50/Rebound 50 Efficiency</h4>
<p>Similarly, one could hypothesise that teams who keep the footy in their Inside 50 regularly will be more likely to score, whilst teams who are effective at getting the ball out of their Defensive 50 will be less likely to concede. Let's use this logic to create Inside 50 Efficiency and Rebound 50 Efficiency features.</p>
<p>The formula used will be:
<div class="highlight"><pre><span></span><code><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a>Inside 50 Efficiency = R50_Opponents / I50 (lower is better).
<a id="__codelineno-36-2" name="__codelineno-36-2" href="#__codelineno-36-2"></a>Rebound 50 Efficiency = R50 / I50_Opponents (higher is better).
</code></pre></div></p>
<p>Using these formulas, I50 Efficiency = R50 Efficiency_Opponent. So we will just need to create the formulas for I50 efficiency.
To create these features we will need the opposition's Inside 50s/Rebound 50s. So we will split out data into two DataFrames, create a new DataFrame by joining these two DataFrames on the Game, calculate our efficiency features, then join our features with our main features DataFrame.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a><span class="c1"># Get each match on single rows</span>
<a id="__codelineno-37-2" name="__codelineno-37-2" href="#__codelineno-37-2"></a><span class="n">single_row_df</span> <span class="o">=</span> <span class="p">(</span><span class="n">afl_data</span><span class="p">[[</span><span class="s1">&#39;game&#39;</span><span class="p">,</span> <span class="s1">&#39;team&#39;</span><span class="p">,</span> <span class="s1">&#39;f_I50&#39;</span><span class="p">,</span> <span class="s1">&#39;f_R50&#39;</span><span class="p">,</span> <span class="s1">&#39;f_D&#39;</span><span class="p">,</span> <span class="s1">&#39;f_ED&#39;</span><span class="p">,</span> <span class="s1">&#39;home_game&#39;</span><span class="p">,</span> <span class="p">]]</span>
<a id="__codelineno-37-3" name="__codelineno-37-3" href="#__codelineno-37-3"></a>                    <span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;home_game == 1&#39;</span><span class="p">)</span>
<a id="__codelineno-37-4" name="__codelineno-37-4" href="#__codelineno-37-4"></a>                    <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;team&#39;</span><span class="p">:</span> <span class="s1">&#39;home_team&#39;</span><span class="p">,</span> <span class="s1">&#39;f_I50&#39;</span><span class="p">:</span> <span class="s1">&#39;f_I50_home&#39;</span><span class="p">,</span> <span class="s1">&#39;f_R50&#39;</span><span class="p">:</span> <span class="s1">&#39;f_R50_home&#39;</span><span class="p">,</span> <span class="s1">&#39;f_D&#39;</span><span class="p">:</span> <span class="s1">&#39;f_D_home&#39;</span><span class="p">,</span> <span class="s1">&#39;f_ED&#39;</span><span class="p">:</span> <span class="s1">&#39;f_ED_home&#39;</span><span class="p">})</span>
<a id="__codelineno-37-5" name="__codelineno-37-5" href="#__codelineno-37-5"></a>                    <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;home_game&#39;</span><span class="p">)</span>
<a id="__codelineno-37-6" name="__codelineno-37-6" href="#__codelineno-37-6"></a>                    <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">,</span> <span class="n">afl_data</span><span class="p">[[</span><span class="s1">&#39;game&#39;</span><span class="p">,</span> <span class="s1">&#39;team&#39;</span><span class="p">,</span> <span class="s1">&#39;f_I50&#39;</span><span class="p">,</span> <span class="s1">&#39;f_R50&#39;</span><span class="p">,</span> <span class="s1">&#39;f_D&#39;</span><span class="p">,</span> <span class="s1">&#39;f_ED&#39;</span><span class="p">,</span> <span class="s1">&#39;home_game&#39;</span><span class="p">]]</span>
<a id="__codelineno-37-7" name="__codelineno-37-7" href="#__codelineno-37-7"></a>                                    <span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;home_game == 0&#39;</span><span class="p">)</span>
<a id="__codelineno-37-8" name="__codelineno-37-8" href="#__codelineno-37-8"></a>                                    <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;team&#39;</span><span class="p">:</span> <span class="s1">&#39;away_team&#39;</span><span class="p">,</span> <span class="s1">&#39;f_I50&#39;</span><span class="p">:</span> <span class="s1">&#39;f_I50_away&#39;</span><span class="p">,</span> <span class="s1">&#39;f_R50&#39;</span><span class="p">:</span> <span class="s1">&#39;f_R50_away&#39;</span><span class="p">,</span> <span class="s1">&#39;f_D&#39;</span><span class="p">:</span> <span class="s1">&#39;f_D_away&#39;</span><span class="p">,</span> <span class="s1">&#39;f_ED&#39;</span><span class="p">:</span> <span class="s1">&#39;f_ED_away&#39;</span><span class="p">})</span>
<a id="__codelineno-37-9" name="__codelineno-37-9" href="#__codelineno-37-9"></a>                                    <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;home_game&#39;</span><span class="p">),</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;game&#39;</span><span class="p">))</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a><span class="n">single_row_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</code></pre></div>
<table>
<thead>
<tr>
<th></th>
<th>game</th>
<th>home_team</th>
<th>f_I50_home</th>
<th>f_R50_home</th>
<th>f_D_home</th>
<th>f_ED_home</th>
<th>away_team</th>
<th>f_I50_away</th>
<th>f_R50_away</th>
<th>f_D_away</th>
<th>f_ED_away</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>13764</td>
<td>Carlton</td>
<td>69</td>
<td>21</td>
<td>373</td>
<td>268</td>
<td>Richmond</td>
<td>37</td>
<td>50</td>
<td>316</td>
<td>226</td>
</tr>
<tr>
<td>1</td>
<td>13765</td>
<td>Geelong</td>
<td>54</td>
<td>40</td>
<td>428</td>
<td>310</td>
<td>St Kilda</td>
<td>52</td>
<td>45</td>
<td>334</td>
<td>246</td>
</tr>
<tr>
<td>2</td>
<td>13766</td>
<td>Collingwood</td>
<td>70</td>
<td>38</td>
<td>398</td>
<td>289</td>
<td>Port Adelaide</td>
<td>50</td>
<td>44</td>
<td>331</td>
<td>232</td>
</tr>
<tr>
<td>3</td>
<td>13767</td>
<td>Adelaide</td>
<td>59</td>
<td>38</td>
<td>366</td>
<td>264</td>
<td>Hawthorn</td>
<td>54</td>
<td>38</td>
<td>372</td>
<td>264</td>
</tr>
<tr>
<td>4</td>
<td>13768</td>
<td>Brisbane</td>
<td>50</td>
<td>39</td>
<td>343</td>
<td>227</td>
<td>Fremantle</td>
<td>57</td>
<td>30</td>
<td>351</td>
<td>250</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre><span></span><code><a id="__codelineno-39-1" name="__codelineno-39-1" href="#__codelineno-39-1"></a><span class="n">single_row_df</span> <span class="o">=</span> <span class="n">single_row_df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">f_I50_efficiency_home</span><span class="o">=</span><span class="k">lambda</span> <span class="n">df</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">f_R50_away</span> <span class="o">/</span> <span class="n">df</span><span class="o">.</span><span class="n">f_I50_home</span><span class="p">,</span>
<a id="__codelineno-39-2" name="__codelineno-39-2" href="#__codelineno-39-2"></a>                                    <span class="n">f_I50_efficiency_away</span><span class="o">=</span><span class="k">lambda</span> <span class="n">df</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">f_R50_home</span> <span class="o">/</span> <span class="n">df</span><span class="o">.</span><span class="n">f_I50_away</span><span class="p">)</span>
<a id="__codelineno-39-3" name="__codelineno-39-3" href="#__codelineno-39-3"></a>
<a id="__codelineno-39-4" name="__codelineno-39-4" href="#__codelineno-39-4"></a><span class="n">feature_efficiency_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;f_I50_efficiency_home&#39;</span><span class="p">,</span> <span class="s1">&#39;f_I50_efficiency_away&#39;</span><span class="p">]</span>
<a id="__codelineno-39-5" name="__codelineno-39-5" href="#__codelineno-39-5"></a>
<a id="__codelineno-39-6" name="__codelineno-39-6" href="#__codelineno-39-6"></a><span class="c1"># Now let&#39;s create an Expontentially Weighted Moving Average for these features - we will need to reshape our DataFrame to do this</span>
<a id="__codelineno-39-7" name="__codelineno-39-7" href="#__codelineno-39-7"></a><span class="n">efficiency_features_multi_row</span> <span class="o">=</span> <span class="p">(</span><span class="n">single_row_df</span><span class="p">[[</span><span class="s1">&#39;game&#39;</span><span class="p">,</span> <span class="s1">&#39;home_team&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">feature_efficiency_cols</span><span class="p">]</span>
<a id="__codelineno-39-8" name="__codelineno-39-8" href="#__codelineno-39-8"></a>                                    <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-39-9" name="__codelineno-39-9" href="#__codelineno-39-9"></a>                                        <span class="s1">&#39;home_team&#39;</span><span class="p">:</span> <span class="s1">&#39;team&#39;</span><span class="p">,</span>
<a id="__codelineno-39-10" name="__codelineno-39-10" href="#__codelineno-39-10"></a>                                        <span class="s1">&#39;f_I50_efficiency_home&#39;</span><span class="p">:</span> <span class="s1">&#39;f_I50_efficiency&#39;</span><span class="p">,</span>
<a id="__codelineno-39-11" name="__codelineno-39-11" href="#__codelineno-39-11"></a>                                        <span class="s1">&#39;f_I50_efficiency_away&#39;</span><span class="p">:</span> <span class="s1">&#39;f_I50_efficiency_opponent&#39;</span><span class="p">,</span>
<a id="__codelineno-39-12" name="__codelineno-39-12" href="#__codelineno-39-12"></a>                                    <span class="p">})</span>
<a id="__codelineno-39-13" name="__codelineno-39-13" href="#__codelineno-39-13"></a>                                    <span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">single_row_df</span><span class="p">[[</span><span class="s1">&#39;game&#39;</span><span class="p">,</span> <span class="s1">&#39;away_team&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">feature_efficiency_cols</span><span class="p">]</span>
<a id="__codelineno-39-14" name="__codelineno-39-14" href="#__codelineno-39-14"></a>                                                 <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-39-15" name="__codelineno-39-15" href="#__codelineno-39-15"></a>                                                     <span class="s1">&#39;away_team&#39;</span><span class="p">:</span> <span class="s1">&#39;team&#39;</span><span class="p">,</span>
<a id="__codelineno-39-16" name="__codelineno-39-16" href="#__codelineno-39-16"></a>                                                     <span class="s1">&#39;f_I50_efficiency_home&#39;</span><span class="p">:</span> <span class="s1">&#39;f_I50_efficiency_opponent&#39;</span><span class="p">,</span>
<a id="__codelineno-39-17" name="__codelineno-39-17" href="#__codelineno-39-17"></a>                                                     <span class="s1">&#39;f_I50_efficiency_away&#39;</span><span class="p">:</span> <span class="s1">&#39;f_I50_efficiency&#39;</span><span class="p">,</span>
<a id="__codelineno-39-18" name="__codelineno-39-18" href="#__codelineno-39-18"></a>                                                 <span class="p">})),</span> <span class="n">sort</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-39-19" name="__codelineno-39-19" href="#__codelineno-39-19"></a>                                    <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;game&#39;</span><span class="p">)</span>
<a id="__codelineno-39-20" name="__codelineno-39-20" href="#__codelineno-39-20"></a>                                    <span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
<a id="__codelineno-39-21" name="__codelineno-39-21" href="#__codelineno-39-21"></a>
<a id="__codelineno-39-22" name="__codelineno-39-22" href="#__codelineno-39-22"></a><span class="n">efficiency_features</span> <span class="o">=</span> <span class="n">efficiency_features_multi_row</span><span class="p">[[</span><span class="s1">&#39;game&#39;</span><span class="p">,</span> <span class="s1">&#39;team&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-39-23" name="__codelineno-39-23" href="#__codelineno-39-23"></a><span class="n">feature_efficiency_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;f_I50_efficiency&#39;</span><span class="p">,</span> <span class="s1">&#39;f_I50_efficiency_opponent&#39;</span><span class="p">]</span>
<a id="__codelineno-39-24" name="__codelineno-39-24" href="#__codelineno-39-24"></a>
<a id="__codelineno-39-25" name="__codelineno-39-25" href="#__codelineno-39-25"></a><span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">feature_efficiency_cols</span><span class="p">:</span>
<a id="__codelineno-39-26" name="__codelineno-39-26" href="#__codelineno-39-26"></a>    <span class="n">efficiency_features</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">efficiency_features_multi_row</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;team&#39;</span><span class="p">)[</span><span class="n">feature</span><span class="p">]</span>
<a id="__codelineno-39-27" name="__codelineno-39-27" href="#__codelineno-39-27"></a>                                        <span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">row</span><span class="o">.</span><span class="n">ewm</span><span class="p">(</span><span class="n">span</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)))</span>
<a id="__codelineno-39-28" name="__codelineno-39-28" href="#__codelineno-39-28"></a>
<a id="__codelineno-39-29" name="__codelineno-39-29" href="#__codelineno-39-29"></a><span class="c1"># Get feature efficiency df back onto single rows</span>
<a id="__codelineno-39-30" name="__codelineno-39-30" href="#__codelineno-39-30"></a><span class="n">efficiency_features</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">efficiency_features</span><span class="p">,</span> <span class="n">afl_data</span><span class="p">[[</span><span class="s1">&#39;game&#39;</span><span class="p">,</span> <span class="s1">&#39;team&#39;</span><span class="p">,</span> <span class="s1">&#39;home_game&#39;</span><span class="p">]],</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;game&#39;</span><span class="p">,</span> <span class="s1">&#39;team&#39;</span><span class="p">])</span>
<a id="__codelineno-39-31" name="__codelineno-39-31" href="#__codelineno-39-31"></a><span class="n">efficiency_features_single_row</span> <span class="o">=</span> <span class="p">(</span><span class="n">efficiency_features</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;home_game == 1&#39;</span><span class="p">)</span>
<a id="__codelineno-39-32" name="__codelineno-39-32" href="#__codelineno-39-32"></a>                                    <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-39-33" name="__codelineno-39-33" href="#__codelineno-39-33"></a>                                        <span class="s1">&#39;team&#39;</span><span class="p">:</span> <span class="s1">&#39;home_team&#39;</span><span class="p">,</span> 
<a id="__codelineno-39-34" name="__codelineno-39-34" href="#__codelineno-39-34"></a>                                        <span class="s1">&#39;f_I50_efficiency&#39;</span><span class="p">:</span> <span class="s1">&#39;f_I50_efficiency_home&#39;</span><span class="p">,</span>
<a id="__codelineno-39-35" name="__codelineno-39-35" href="#__codelineno-39-35"></a>                                        <span class="s1">&#39;f_I50_efficiency_opponent&#39;</span><span class="p">:</span> <span class="s1">&#39;f_R50_efficiency_home&#39;</span><span class="p">})</span>
<a id="__codelineno-39-36" name="__codelineno-39-36" href="#__codelineno-39-36"></a>                                    <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;home_game&#39;</span><span class="p">)</span>
<a id="__codelineno-39-37" name="__codelineno-39-37" href="#__codelineno-39-37"></a>                                    <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">,</span> <span class="p">(</span><span class="n">efficiency_features</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;home_game == 0&#39;</span><span class="p">)</span>
<a id="__codelineno-39-38" name="__codelineno-39-38" href="#__codelineno-39-38"></a>                                                        <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-39-39" name="__codelineno-39-39" href="#__codelineno-39-39"></a>                                                            <span class="s1">&#39;team&#39;</span><span class="p">:</span> <span class="s1">&#39;away_team&#39;</span><span class="p">,</span>
<a id="__codelineno-39-40" name="__codelineno-39-40" href="#__codelineno-39-40"></a>                                                            <span class="s1">&#39;f_I50_efficiency&#39;</span><span class="p">:</span> <span class="s1">&#39;f_I50_efficiency_away&#39;</span><span class="p">,</span>
<a id="__codelineno-39-41" name="__codelineno-39-41" href="#__codelineno-39-41"></a>                                                            <span class="s1">&#39;f_I50_efficiency_opponent&#39;</span><span class="p">:</span> <span class="s1">&#39;f_R50_efficiency_away&#39;</span><span class="p">})</span>
<a id="__codelineno-39-42" name="__codelineno-39-42" href="#__codelineno-39-42"></a>                                                        <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;home_game&#39;</span><span class="p">)),</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;game&#39;</span><span class="p">))</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a><span class="n">efficiency_features_single_row</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</code></pre></div>
<table>
<thead>
<tr>
<th></th>
<th>game</th>
<th>home_team</th>
<th>f_I50_efficiency_home</th>
<th>f_R50_efficiency_home</th>
<th>away_team</th>
<th>f_I50_efficiency_away</th>
<th>f_R50_efficiency_away</th>
</tr>
</thead>
<tbody>
<tr>
<td>1580</td>
<td>15394</td>
<td>Carlton</td>
<td>0.730668</td>
<td>0.675002</td>
<td>Adelaide</td>
<td>0.691614</td>
<td>0.677128</td>
</tr>
<tr>
<td>1581</td>
<td>15395</td>
<td>Sydney</td>
<td>0.699994</td>
<td>0.778280</td>
<td>Hawthorn</td>
<td>0.699158</td>
<td>0.673409</td>
</tr>
<tr>
<td>1582</td>
<td>15396</td>
<td>Brisbane</td>
<td>0.683604</td>
<td>0.691730</td>
<td>West Coast</td>
<td>0.696822</td>
<td>0.709605</td>
</tr>
<tr>
<td>1583</td>
<td>15397</td>
<td>Melbourne</td>
<td>0.667240</td>
<td>0.692632</td>
<td>GWS</td>
<td>0.684525</td>
<td>0.753783</td>
</tr>
<tr>
<td>1584</td>
<td>15398</td>
<td>St Kilda</td>
<td>0.730843</td>
<td>0.635819</td>
<td>North Melbourne</td>
<td>0.697018</td>
<td>0.654991</td>
</tr>
</tbody>
</table>
<p>We will merge these features back to our features df later, when the features data frame is on a single row as well.</p>
<h3 id="creating-an-elo-feature">Creating an Elo Feature</h3>
<p>Another feature which we could create is an Elo feature. If you don't know what Elo is, go ahead and read an article on it <a href="https://en.wikipedia.org/wiki/Elo_rating_system">here</a>. We have also written a guide on using elo to model the 2021 Euro &amp; Copa America tournaments <a href="https://betfair-datascientists.github.io/modelling/soccerEloTutorialR/">here</a>.</p>
<p>Essentially, Elo ratings increase if you win. The amount the rating increases is based on how strong the opponent is relative to the team who won. Weak teams get more points for beating stronger teams than they do for beating weaker teams, and vice versa for losses (teams lose points for losses).</p>
<p>Mathematically, Elo ratings can also assign a probability for winning or losing based on the two Elo Ratings of the teams playing.</p>
<p>So let's get into it. We will first define a function which calculates the elo for each team and applies these elos to our DataFrame.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-41-1" name="__codelineno-41-1" href="#__codelineno-41-1"></a><span class="c1"># Define a function which finds the elo for each team in each game and returns a dictionary with the game ID as a key and the</span>
<a id="__codelineno-41-2" name="__codelineno-41-2" href="#__codelineno-41-2"></a><span class="c1"># elos as the key&#39;s value, in a list. It also outputs the probabilities and a dictionary of the final elos for each team</span>
<a id="__codelineno-41-3" name="__codelineno-41-3" href="#__codelineno-41-3"></a><span class="k">def</span><span class="w"> </span><span class="nf">elo_applier</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">k_factor</span><span class="p">):</span>
<a id="__codelineno-41-4" name="__codelineno-41-4" href="#__codelineno-41-4"></a>    <span class="c1"># Initialise a dictionary with default elos for each team</span>
<a id="__codelineno-41-5" name="__codelineno-41-5" href="#__codelineno-41-5"></a>    <span class="n">elo_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">team</span><span class="p">:</span> <span class="mi">1500</span> <span class="k">for</span> <span class="n">team</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;team&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()}</span>
<a id="__codelineno-41-6" name="__codelineno-41-6" href="#__codelineno-41-6"></a>    <span class="n">elos</span><span class="p">,</span> <span class="n">elo_probs</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{}</span>
<a id="__codelineno-41-7" name="__codelineno-41-7" href="#__codelineno-41-7"></a>
<a id="__codelineno-41-8" name="__codelineno-41-8" href="#__codelineno-41-8"></a>    <span class="c1"># Get a home and away dataframe so that we can get the teams on the same row</span>
<a id="__codelineno-41-9" name="__codelineno-41-9" href="#__codelineno-41-9"></a>    <span class="n">home_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">home_game</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;team&#39;</span><span class="p">,</span> <span class="s1">&#39;game&#39;</span><span class="p">,</span> <span class="s1">&#39;f_margin&#39;</span><span class="p">,</span> <span class="s1">&#39;home_game&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;team&#39;</span><span class="p">:</span> <span class="s1">&#39;home_team&#39;</span><span class="p">})</span>
<a id="__codelineno-41-10" name="__codelineno-41-10" href="#__codelineno-41-10"></a>    <span class="n">away_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">home_game</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;team&#39;</span><span class="p">,</span> <span class="s1">&#39;game&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;team&#39;</span><span class="p">:</span> <span class="s1">&#39;away_team&#39;</span><span class="p">})</span>
<a id="__codelineno-41-11" name="__codelineno-41-11" href="#__codelineno-41-11"></a>
<a id="__codelineno-41-12" name="__codelineno-41-12" href="#__codelineno-41-12"></a>    <span class="n">df</span> <span class="o">=</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">home_df</span><span class="p">,</span> <span class="n">away_df</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;game&#39;</span><span class="p">)</span>
<a id="__codelineno-41-13" name="__codelineno-41-13" href="#__codelineno-41-13"></a>            <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;game&#39;</span><span class="p">)</span>
<a id="__codelineno-41-14" name="__codelineno-41-14" href="#__codelineno-41-14"></a>            <span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="s1">&#39;game&#39;</span><span class="p">,</span> <span class="n">keep</span><span class="o">=</span><span class="s1">&#39;first&#39;</span><span class="p">)</span>
<a id="__codelineno-41-15" name="__codelineno-41-15" href="#__codelineno-41-15"></a>            <span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
<a id="__codelineno-41-16" name="__codelineno-41-16" href="#__codelineno-41-16"></a>
<a id="__codelineno-41-17" name="__codelineno-41-17" href="#__codelineno-41-17"></a>    <span class="c1"># Loop over the rows in the DataFrame</span>
<a id="__codelineno-41-18" name="__codelineno-41-18" href="#__codelineno-41-18"></a>    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
<a id="__codelineno-41-19" name="__codelineno-41-19" href="#__codelineno-41-19"></a>        <span class="c1"># Get the Game ID</span>
<a id="__codelineno-41-20" name="__codelineno-41-20" href="#__codelineno-41-20"></a>        <span class="n">game_id</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;game&#39;</span><span class="p">]</span>
<a id="__codelineno-41-21" name="__codelineno-41-21" href="#__codelineno-41-21"></a>
<a id="__codelineno-41-22" name="__codelineno-41-22" href="#__codelineno-41-22"></a>        <span class="c1"># Get the margin</span>
<a id="__codelineno-41-23" name="__codelineno-41-23" href="#__codelineno-41-23"></a>        <span class="n">margin</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;f_margin&#39;</span><span class="p">]</span>
<a id="__codelineno-41-24" name="__codelineno-41-24" href="#__codelineno-41-24"></a>
<a id="__codelineno-41-25" name="__codelineno-41-25" href="#__codelineno-41-25"></a>        <span class="c1"># If the game already has the elos for the home and away team in the elos dictionary, go to the next game</span>
<a id="__codelineno-41-26" name="__codelineno-41-26" href="#__codelineno-41-26"></a>        <span class="k">if</span> <span class="n">game_id</span> <span class="ow">in</span> <span class="n">elos</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
<a id="__codelineno-41-27" name="__codelineno-41-27" href="#__codelineno-41-27"></a>            <span class="k">continue</span>
<a id="__codelineno-41-28" name="__codelineno-41-28" href="#__codelineno-41-28"></a>
<a id="__codelineno-41-29" name="__codelineno-41-29" href="#__codelineno-41-29"></a>        <span class="c1"># Get the team and opposition</span>
<a id="__codelineno-41-30" name="__codelineno-41-30" href="#__codelineno-41-30"></a>        <span class="n">home_team</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;home_team&#39;</span><span class="p">]</span>
<a id="__codelineno-41-31" name="__codelineno-41-31" href="#__codelineno-41-31"></a>        <span class="n">away_team</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;away_team&#39;</span><span class="p">]</span>
<a id="__codelineno-41-32" name="__codelineno-41-32" href="#__codelineno-41-32"></a>
<a id="__codelineno-41-33" name="__codelineno-41-33" href="#__codelineno-41-33"></a>        <span class="c1"># Get the team and opposition elo score</span>
<a id="__codelineno-41-34" name="__codelineno-41-34" href="#__codelineno-41-34"></a>        <span class="n">home_team_elo</span> <span class="o">=</span> <span class="n">elo_dict</span><span class="p">[</span><span class="n">home_team</span><span class="p">]</span>
<a id="__codelineno-41-35" name="__codelineno-41-35" href="#__codelineno-41-35"></a>        <span class="n">away_team_elo</span> <span class="o">=</span> <span class="n">elo_dict</span><span class="p">[</span><span class="n">away_team</span><span class="p">]</span>
<a id="__codelineno-41-36" name="__codelineno-41-36" href="#__codelineno-41-36"></a>
<a id="__codelineno-41-37" name="__codelineno-41-37" href="#__codelineno-41-37"></a>        <span class="c1"># Calculated the probability of winning for the team and opposition</span>
<a id="__codelineno-41-38" name="__codelineno-41-38" href="#__codelineno-41-38"></a>        <span class="n">prob_win_home</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">10</span><span class="o">**</span><span class="p">((</span><span class="n">away_team_elo</span> <span class="o">-</span> <span class="n">home_team_elo</span><span class="p">)</span> <span class="o">/</span> <span class="mi">400</span><span class="p">))</span>
<a id="__codelineno-41-39" name="__codelineno-41-39" href="#__codelineno-41-39"></a>        <span class="n">prob_win_away</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">prob_win_home</span>
<a id="__codelineno-41-40" name="__codelineno-41-40" href="#__codelineno-41-40"></a>
<a id="__codelineno-41-41" name="__codelineno-41-41" href="#__codelineno-41-41"></a>        <span class="c1"># Add the elos and probabilities our elos dictionary and elo_probs dictionary based on the Game ID</span>
<a id="__codelineno-41-42" name="__codelineno-41-42" href="#__codelineno-41-42"></a>        <span class="n">elos</span><span class="p">[</span><span class="n">game_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">home_team_elo</span><span class="p">,</span> <span class="n">away_team_elo</span><span class="p">]</span>
<a id="__codelineno-41-43" name="__codelineno-41-43" href="#__codelineno-41-43"></a>        <span class="n">elo_probs</span><span class="p">[</span><span class="n">game_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">prob_win_home</span><span class="p">,</span> <span class="n">prob_win_away</span><span class="p">]</span>
<a id="__codelineno-41-44" name="__codelineno-41-44" href="#__codelineno-41-44"></a>
<a id="__codelineno-41-45" name="__codelineno-41-45" href="#__codelineno-41-45"></a>        <span class="c1"># Calculate the new elos of each team</span>
<a id="__codelineno-41-46" name="__codelineno-41-46" href="#__codelineno-41-46"></a>        <span class="k">if</span> <span class="n">margin</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># Home team wins; update both teams&#39; elo</span>
<a id="__codelineno-41-47" name="__codelineno-41-47" href="#__codelineno-41-47"></a>            <span class="n">new_home_team_elo</span> <span class="o">=</span> <span class="n">home_team_elo</span> <span class="o">+</span> <span class="n">k_factor</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">prob_win_home</span><span class="p">)</span>
<a id="__codelineno-41-48" name="__codelineno-41-48" href="#__codelineno-41-48"></a>            <span class="n">new_away_team_elo</span> <span class="o">=</span> <span class="n">away_team_elo</span> <span class="o">+</span> <span class="n">k_factor</span><span class="o">*</span><span class="p">(</span><span class="mi">0</span> <span class="o">-</span> <span class="n">prob_win_away</span><span class="p">)</span>
<a id="__codelineno-41-49" name="__codelineno-41-49" href="#__codelineno-41-49"></a>        <span class="k">elif</span> <span class="n">margin</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># Away team wins; update both teams&#39; elo</span>
<a id="__codelineno-41-50" name="__codelineno-41-50" href="#__codelineno-41-50"></a>            <span class="n">new_home_team_elo</span> <span class="o">=</span> <span class="n">home_team_elo</span> <span class="o">+</span> <span class="n">k_factor</span><span class="o">*</span><span class="p">(</span><span class="mi">0</span> <span class="o">-</span> <span class="n">prob_win_home</span><span class="p">)</span>
<a id="__codelineno-41-51" name="__codelineno-41-51" href="#__codelineno-41-51"></a>            <span class="n">new_away_team_elo</span> <span class="o">=</span> <span class="n">away_team_elo</span> <span class="o">+</span> <span class="n">k_factor</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">prob_win_away</span><span class="p">)</span>
<a id="__codelineno-41-52" name="__codelineno-41-52" href="#__codelineno-41-52"></a>        <span class="k">elif</span> <span class="n">margin</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># Drawn game&#39; update both teams&#39; elo</span>
<a id="__codelineno-41-53" name="__codelineno-41-53" href="#__codelineno-41-53"></a>            <span class="n">new_home_team_elo</span> <span class="o">=</span> <span class="n">home_team_elo</span> <span class="o">+</span> <span class="n">k_factor</span><span class="o">*</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">-</span> <span class="n">prob_win_home</span><span class="p">)</span>
<a id="__codelineno-41-54" name="__codelineno-41-54" href="#__codelineno-41-54"></a>            <span class="n">new_away_team_elo</span> <span class="o">=</span> <span class="n">away_team_elo</span> <span class="o">+</span> <span class="n">k_factor</span><span class="o">*</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">-</span> <span class="n">prob_win_away</span><span class="p">)</span>
<a id="__codelineno-41-55" name="__codelineno-41-55" href="#__codelineno-41-55"></a>
<a id="__codelineno-41-56" name="__codelineno-41-56" href="#__codelineno-41-56"></a>        <span class="c1"># Update elos in elo dictionary</span>
<a id="__codelineno-41-57" name="__codelineno-41-57" href="#__codelineno-41-57"></a>        <span class="n">elo_dict</span><span class="p">[</span><span class="n">home_team</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_home_team_elo</span>
<a id="__codelineno-41-58" name="__codelineno-41-58" href="#__codelineno-41-58"></a>        <span class="n">elo_dict</span><span class="p">[</span><span class="n">away_team</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_away_team_elo</span>
<a id="__codelineno-41-59" name="__codelineno-41-59" href="#__codelineno-41-59"></a>
<a id="__codelineno-41-60" name="__codelineno-41-60" href="#__codelineno-41-60"></a>    <span class="k">return</span> <span class="n">elos</span><span class="p">,</span> <span class="n">elo_probs</span><span class="p">,</span> <span class="n">elo_dict</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-42-1" name="__codelineno-42-1" href="#__codelineno-42-1"></a><span class="c1"># Use the elo applier function to get the elos and elo probabilities for each game - we will map these later</span>
<a id="__codelineno-42-2" name="__codelineno-42-2" href="#__codelineno-42-2"></a><span class="n">elos</span><span class="p">,</span> <span class="n">probs</span><span class="p">,</span> <span class="n">elo_dict</span> <span class="o">=</span> <span class="n">elo_applier</span><span class="p">(</span><span class="n">afl_data</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
</code></pre></div>
<p>Great! now we have both rolling averages for stats as a feature, and the elo of the teams! Let's have a quick look at the current elo standings with a k-factor of 30, out of curiosity.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-43-1" name="__codelineno-43-1" href="#__codelineno-43-1"></a><span class="k">for</span> <span class="n">team</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">elo_dict</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">elo_dict</span><span class="o">.</span><span class="n">get</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
<a id="__codelineno-43-2" name="__codelineno-43-2" href="#__codelineno-43-2"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">team</span><span class="p">,</span> <span class="n">elo_dict</span><span class="p">[</span><span class="n">team</span><span class="p">])</span>
<a id="__codelineno-43-3" name="__codelineno-43-3" href="#__codelineno-43-3"></a>
<a id="__codelineno-43-4" name="__codelineno-43-4" href="#__codelineno-43-4"></a>    <span class="n">Richmond</span> <span class="mf">1695.2241513840117</span>
<a id="__codelineno-43-5" name="__codelineno-43-5" href="#__codelineno-43-5"></a>    <span class="n">Sydney</span> <span class="mf">1645.548990879842</span>
<a id="__codelineno-43-6" name="__codelineno-43-6" href="#__codelineno-43-6"></a>    <span class="n">Hawthorn</span> <span class="mf">1632.5266709780622</span>
<a id="__codelineno-43-7" name="__codelineno-43-7" href="#__codelineno-43-7"></a>    <span class="n">West</span> <span class="n">Coast</span> <span class="mf">1625.871701773721</span>
<a id="__codelineno-43-8" name="__codelineno-43-8" href="#__codelineno-43-8"></a>    <span class="n">Geelong</span> <span class="mf">1625.423154644809</span>
<a id="__codelineno-43-9" name="__codelineno-43-9" href="#__codelineno-43-9"></a>    <span class="n">GWS</span> <span class="mf">1597.4158602131877</span>
<a id="__codelineno-43-10" name="__codelineno-43-10" href="#__codelineno-43-10"></a>    <span class="n">Adelaide</span> <span class="mf">1591.1704934545442</span>
<a id="__codelineno-43-11" name="__codelineno-43-11" href="#__codelineno-43-11"></a>    <span class="n">Collingwood</span> <span class="mf">1560.370309216614</span>
<a id="__codelineno-43-12" name="__codelineno-43-12" href="#__codelineno-43-12"></a>    <span class="n">Melbourne</span> <span class="mf">1558.5666572771509</span>
<a id="__codelineno-43-13" name="__codelineno-43-13" href="#__codelineno-43-13"></a>    <span class="n">Essendon</span> <span class="mf">1529.0198398117086</span>
<a id="__codelineno-43-14" name="__codelineno-43-14" href="#__codelineno-43-14"></a>    <span class="n">Port</span> <span class="n">Adelaide</span> <span class="mf">1524.8882517820093</span>
<a id="__codelineno-43-15" name="__codelineno-43-15" href="#__codelineno-43-15"></a>    <span class="n">North</span> <span class="n">Melbourne</span> <span class="mf">1465.5637511922569</span>
<a id="__codelineno-43-16" name="__codelineno-43-16" href="#__codelineno-43-16"></a>    <span class="n">Western</span> <span class="n">Bulldogs</span> <span class="mf">1452.2110697845148</span>
<a id="__codelineno-43-17" name="__codelineno-43-17" href="#__codelineno-43-17"></a>    <span class="n">Fremantle</span> <span class="mf">1393.142087030804</span>
<a id="__codelineno-43-18" name="__codelineno-43-18" href="#__codelineno-43-18"></a>    <span class="n">St</span> <span class="n">Kilda</span> <span class="mf">1360.9120149937303</span>
<a id="__codelineno-43-19" name="__codelineno-43-19" href="#__codelineno-43-19"></a>    <span class="n">Brisbane</span> <span class="mf">1276.2923772139352</span>
<a id="__codelineno-43-20" name="__codelineno-43-20" href="#__codelineno-43-20"></a>    <span class="n">Gold</span> <span class="n">Coast</span> <span class="mf">1239.174528704772</span>
<a id="__codelineno-43-21" name="__codelineno-43-21" href="#__codelineno-43-21"></a>    <span class="n">Carlton</span> <span class="mf">1226.6780896643265</span>
</code></pre></div>
<p>This looks extremely similar to the currently AFL ladder, so this is a good sign for elo being an effective predictor of winning.</p>
<h3 id="merging-our-features-into-one-features-dataframe">Merging Our Features Into One Features DataFrame</h3>
<p>Now we need to reshape our features df so that we have all of the statistics for both teams in a game on a single row. We can then merge our elo and efficiency features to this df.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-44-1" name="__codelineno-44-1" href="#__codelineno-44-1"></a><span class="c1"># Look at our current features df</span>
<a id="__codelineno-44-2" name="__codelineno-44-2" href="#__codelineno-44-2"></a><span class="n">features</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</code></pre></div>
<table>
<thead>
<tr>
<th></th>
<th>date</th>
<th>game</th>
<th>team</th>
<th>opponent</th>
<th>venue</th>
<th>home_game</th>
<th>f_odds</th>
<th>f_goals</th>
<th>f_behinds</th>
<th>f_points</th>
<th>f_margin</th>
<th>f_opponent_goals</th>
<th>f_opponent_behinds</th>
<th>f_opponent_points</th>
<th>f_AF</th>
<th>f_B</th>
<th>f_BO</th>
<th>f_CCL</th>
<th>f_CG</th>
<th>f_CL</th>
<th>f_CM</th>
<th>f_CP</th>
<th>f_D</th>
<th>f_ED</th>
<th>f_FA</th>
<th>f_FF</th>
<th>f_G</th>
<th>f_GA</th>
<th>f_HB</th>
<th>f_HO</th>
<th>f_I50</th>
<th>f_ITC</th>
<th>f_K</th>
<th>f_M</th>
<th>f_MG</th>
<th>f_MI5</th>
<th>f_One.Percenters</th>
<th>f_R50</th>
<th>f_SC</th>
<th>f_SCL</th>
<th>f_SI</th>
<th>f_T</th>
<th>f_T5</th>
<th>f_TO</th>
<th>f_UP</th>
<th>f_form_margin_btwn_teams</th>
<th>f_form_past_5_btwn_teams</th>
</tr>
</thead>
<tbody>
<tr>
<td>3156</td>
<td>2018-08-26</td>
<td>15397</td>
<td>Melbourne</td>
<td>GWS</td>
<td>M.C.G.</td>
<td>1</td>
<td>1.706488</td>
<td>15.157271</td>
<td>13.815113</td>
<td>104.758740</td>
<td>25.170429</td>
<td>11.814319</td>
<td>8.702396</td>
<td>79.588311</td>
<td>3312.408470</td>
<td>22.077317</td>
<td>7.724955</td>
<td>28.364418</td>
<td>114.399147</td>
<td>78.406069</td>
<td>26.934677</td>
<td>324.352577</td>
<td>775.176933</td>
<td>547.385948</td>
<td>39.353251</td>
<td>36.025646</td>
<td>30.308918</td>
<td>22.461080</td>
<td>348.613592</td>
<td>99.78780</td>
<td>120.339062</td>
<td>154.417642</td>
<td>426.563341</td>
<td>178.102118</td>
<td>12395.717925</td>
<td>32.168752</td>
<td>96.390688</td>
<td>63.786515</td>
<td>3427.596843</td>
<td>50.041649</td>
<td>232.287556</td>
<td>144.875098</td>
<td>23.789233</td>
<td>149.042149</td>
<td>456.988552</td>
<td>-23.2</td>
<td>2.0</td>
</tr>
<tr>
<td>3157</td>
<td>2018-08-26</td>
<td>15398</td>
<td>North Melbourne</td>
<td>St Kilda</td>
<td>Docklands</td>
<td>0</td>
<td>2.272313</td>
<td>12.721783</td>
<td>10.733785</td>
<td>87.064486</td>
<td>-1.214246</td>
<td>12.915796</td>
<td>10.783958</td>
<td>88.278732</td>
<td>3066.272143</td>
<td>17.322710</td>
<td>9.815243</td>
<td>26.015421</td>
<td>106.465181</td>
<td>67.504286</td>
<td>26.064079</td>
<td>291.259574</td>
<td>736.279779</td>
<td>534.154748</td>
<td>34.301603</td>
<td>40.908551</td>
<td>25.386136</td>
<td>17.816570</td>
<td>341.210547</td>
<td>81.54113</td>
<td>102.589427</td>
<td>145.265493</td>
<td>395.069232</td>
<td>173.089408</td>
<td>10875.002463</td>
<td>21.802751</td>
<td>82.347511</td>
<td>70.416194</td>
<td>3171.120023</td>
<td>41.488865</td>
<td>197.620152</td>
<td>122.547684</td>
<td>22.286256</td>
<td>142.780474</td>
<td>450.374058</td>
<td>3.2</td>
<td>3.0</td>
</tr>
<tr>
<td>3158</td>
<td>2018-08-26</td>
<td>15398</td>
<td>St Kilda</td>
<td>North Melbourne</td>
<td>Docklands</td>
<td>1</td>
<td>5.516150</td>
<td>10.464266</td>
<td>11.957047</td>
<td>74.742643</td>
<td>-21.138101</td>
<td>14.105551</td>
<td>11.247440</td>
<td>95.880745</td>
<td>3094.163405</td>
<td>20.523847</td>
<td>14.569589</td>
<td>24.134276</td>
<td>102.540441</td>
<td>66.976211</td>
<td>18.018350</td>
<td>270.674857</td>
<td>773.086015</td>
<td>573.769838</td>
<td>41.319843</td>
<td>36.198820</td>
<td>20.850476</td>
<td>14.443658</td>
<td>364.405251</td>
<td>63.49876</td>
<td>103.803779</td>
<td>130.494307</td>
<td>408.680763</td>
<td>184.780054</td>
<td>10765.717942</td>
<td>21.572806</td>
<td>94.731555</td>
<td>65.790561</td>
<td>3228.278599</td>
<td>42.841935</td>
<td>196.086493</td>
<td>115.901425</td>
<td>18.796764</td>
<td>127.364334</td>
<td>508.844514</td>
<td>-3.2</td>
<td>2.0</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre><span></span><code><a id="__codelineno-45-1" name="__codelineno-45-1" href="#__codelineno-45-1"></a><span class="n">one_line_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;game&#39;</span><span class="p">,</span> <span class="s1">&#39;team&#39;</span><span class="p">,</span> <span class="s1">&#39;home_game&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">features</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;f_&#39;</span><span class="p">)]</span>
<a id="__codelineno-45-2" name="__codelineno-45-2" href="#__codelineno-45-2"></a>
<a id="__codelineno-45-3" name="__codelineno-45-3" href="#__codelineno-45-3"></a><span class="c1"># Get all features onto individual rows for each match</span>
<a id="__codelineno-45-4" name="__codelineno-45-4" href="#__codelineno-45-4"></a><span class="n">features_one_line</span> <span class="o">=</span> <span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">features</span><span class="o">.</span><span class="n">home_game</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">one_line_cols</span><span class="p">]</span>
<a id="__codelineno-45-5" name="__codelineno-45-5" href="#__codelineno-45-5"></a>                     <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;team&#39;</span><span class="p">:</span> <span class="s1">&#39;home_team&#39;</span><span class="p">})</span>
<a id="__codelineno-45-6" name="__codelineno-45-6" href="#__codelineno-45-6"></a>                     <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;home_game&#39;</span><span class="p">)</span>
<a id="__codelineno-45-7" name="__codelineno-45-7" href="#__codelineno-45-7"></a>                     <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">,</span> <span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">features</span><span class="o">.</span><span class="n">home_game</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">one_line_cols</span><span class="p">]</span>
<a id="__codelineno-45-8" name="__codelineno-45-8" href="#__codelineno-45-8"></a>                                              <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;home_game&#39;</span><span class="p">)</span>
<a id="__codelineno-45-9" name="__codelineno-45-9" href="#__codelineno-45-9"></a>                                              <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;team&#39;</span><span class="p">:</span> <span class="s1">&#39;away_team&#39;</span><span class="p">})</span>
<a id="__codelineno-45-10" name="__codelineno-45-10" href="#__codelineno-45-10"></a>                                              <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">col</span><span class="p">:</span> <span class="n">col</span><span class="o">+</span><span class="s1">&#39;_away&#39;</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">features</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;f_&#39;</span><span class="p">)})),</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;game&#39;</span><span class="p">)</span>
<a id="__codelineno-45-11" name="__codelineno-45-11" href="#__codelineno-45-11"></a>                    <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;f_form_margin_btwn_teams_away&#39;</span><span class="p">,</span> <span class="s1">&#39;f_form_past_5_btwn_teams_away&#39;</span><span class="p">]))</span>
<a id="__codelineno-45-12" name="__codelineno-45-12" href="#__codelineno-45-12"></a>
<a id="__codelineno-45-13" name="__codelineno-45-13" href="#__codelineno-45-13"></a><span class="c1"># Add our created features - elo, efficiency etc.</span>
<a id="__codelineno-45-14" name="__codelineno-45-14" href="#__codelineno-45-14"></a><span class="n">features_one_line</span> <span class="o">=</span> <span class="p">(</span><span class="n">features_one_line</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">f_elo_home</span><span class="o">=</span><span class="k">lambda</span> <span class="n">df</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">game</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">elos</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
<a id="__codelineno-45-15" name="__codelineno-45-15" href="#__codelineno-45-15"></a>                                            <span class="n">f_elo_away</span><span class="o">=</span><span class="k">lambda</span> <span class="n">df</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">game</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">elos</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
<a id="__codelineno-45-16" name="__codelineno-45-16" href="#__codelineno-45-16"></a>                                      <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">,</span> <span class="n">efficiency_features_single_row</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;game&#39;</span><span class="p">,</span> <span class="s1">&#39;home_team&#39;</span><span class="p">,</span> <span class="s1">&#39;away_team&#39;</span><span class="p">])</span>
<a id="__codelineno-45-17" name="__codelineno-45-17" href="#__codelineno-45-17"></a>                                      <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">,</span> <span class="n">afl_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">afl_data</span><span class="o">.</span><span class="n">home_game</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;game&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;round&#39;</span><span class="p">,</span> <span class="s1">&#39;venue&#39;</span><span class="p">]],</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;game&#39;</span><span class="p">])</span>
<a id="__codelineno-45-18" name="__codelineno-45-18" href="#__codelineno-45-18"></a>                                      <span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<a id="__codelineno-45-19" name="__codelineno-45-19" href="#__codelineno-45-19"></a>                                      <span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-45-20" name="__codelineno-45-20" href="#__codelineno-45-20"></a>                                      <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">season</span><span class="o">=</span><span class="k">lambda</span> <span class="n">df</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">row</span><span class="o">.</span><span class="n">year</span><span class="p">)))</span>
<a id="__codelineno-45-21" name="__codelineno-45-21" href="#__codelineno-45-21"></a>
<a id="__codelineno-45-22" name="__codelineno-45-22" href="#__codelineno-45-22"></a><span class="n">ordered_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">features_one_line</span> <span class="k">if</span> <span class="n">col</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;f_&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">features_one_line</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;f_&#39;</span><span class="p">)]</span>
<a id="__codelineno-45-23" name="__codelineno-45-23" href="#__codelineno-45-23"></a>
<a id="__codelineno-45-24" name="__codelineno-45-24" href="#__codelineno-45-24"></a><span class="n">feature_df</span> <span class="o">=</span> <span class="n">features_one_line</span><span class="p">[</span><span class="n">ordered_cols</span><span class="p">]</span>
</code></pre></div>
<p>Finally, let's reduce the dimensionality of the features df by subtracting the home features from the away features. This will reduce the huge amount of columns we have and make our data more manageable. To do this, we will need a list of columns which we are subtracting from each other. We will then loop over each of these columns to create our new differential columns. </p>
<p>We will then add in the implied probability from the odds of the home and away team, as our current odds feature is simply an exponential moving average over the past n games.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-46-1" name="__codelineno-46-1" href="#__codelineno-46-1"></a><span class="c1"># Create differential df - this df is the home features - the away features</span>
<a id="__codelineno-46-2" name="__codelineno-46-2" href="#__codelineno-46-2"></a><span class="n">diff_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">feature_df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span> <span class="o">+</span> <span class="s1">&#39;_away&#39;</span> <span class="ow">in</span> <span class="n">feature_df</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="n">col</span> <span class="o">!=</span> <span class="s1">&#39;f_odds&#39;</span> <span class="ow">and</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;f_&#39;</span><span class="p">)]</span>
<a id="__codelineno-46-3" name="__codelineno-46-3" href="#__codelineno-46-3"></a><span class="n">non_diff_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">feature_df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">diff_cols</span> <span class="ow">and</span> <span class="n">col</span><span class="p">[:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">diff_cols</span><span class="p">]</span>
<a id="__codelineno-46-4" name="__codelineno-46-4" href="#__codelineno-46-4"></a>
<a id="__codelineno-46-5" name="__codelineno-46-5" href="#__codelineno-46-5"></a><span class="n">diff_df</span> <span class="o">=</span> <span class="n">feature_df</span><span class="p">[</span><span class="n">non_diff_cols</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-46-6" name="__codelineno-46-6" href="#__codelineno-46-6"></a>
<a id="__codelineno-46-7" name="__codelineno-46-7" href="#__codelineno-46-7"></a><span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">diff_cols</span><span class="p">:</span>
<a id="__codelineno-46-8" name="__codelineno-46-8" href="#__codelineno-46-8"></a>    <span class="n">diff_df</span><span class="p">[</span><span class="n">col</span><span class="o">+</span><span class="s1">&#39;_diff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">feature_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">-</span> <span class="n">feature_df</span><span class="p">[</span><span class="n">col</span><span class="o">+</span><span class="s1">&#39;_away&#39;</span><span class="p">]</span>
<a id="__codelineno-46-9" name="__codelineno-46-9" href="#__codelineno-46-9"></a>
<a id="__codelineno-46-10" name="__codelineno-46-10" href="#__codelineno-46-10"></a><span class="c1"># Add current odds in to diff_df</span>
<a id="__codelineno-46-11" name="__codelineno-46-11" href="#__codelineno-46-11"></a><span class="n">odds</span> <span class="o">=</span> <span class="n">get_cleaned_odds</span><span class="p">()</span>
<a id="__codelineno-46-12" name="__codelineno-46-12" href="#__codelineno-46-12"></a><span class="n">home_odds</span> <span class="o">=</span> <span class="p">(</span><span class="n">odds</span><span class="p">[</span><span class="n">odds</span><span class="o">.</span><span class="n">home_game</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-46-13" name="__codelineno-46-13" href="#__codelineno-46-13"></a>             <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">f_current_odds_prob</span><span class="o">=</span><span class="k">lambda</span> <span class="n">df</span><span class="p">:</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">df</span><span class="o">.</span><span class="n">odds</span><span class="p">)</span>
<a id="__codelineno-46-14" name="__codelineno-46-14" href="#__codelineno-46-14"></a>             <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;team&#39;</span><span class="p">:</span> <span class="s1">&#39;home_team&#39;</span><span class="p">})</span>
<a id="__codelineno-46-15" name="__codelineno-46-15" href="#__codelineno-46-15"></a>             <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;home_game&#39;</span><span class="p">,</span> <span class="s1">&#39;odds&#39;</span><span class="p">]))</span>
<a id="__codelineno-46-16" name="__codelineno-46-16" href="#__codelineno-46-16"></a>
<a id="__codelineno-46-17" name="__codelineno-46-17" href="#__codelineno-46-17"></a><span class="n">away_odds</span> <span class="o">=</span> <span class="p">(</span><span class="n">odds</span><span class="p">[</span><span class="n">odds</span><span class="o">.</span><span class="n">home_game</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-46-18" name="__codelineno-46-18" href="#__codelineno-46-18"></a>             <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">f_current_odds_prob_away</span><span class="o">=</span><span class="k">lambda</span> <span class="n">df</span><span class="p">:</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">df</span><span class="o">.</span><span class="n">odds</span><span class="p">)</span>
<a id="__codelineno-46-19" name="__codelineno-46-19" href="#__codelineno-46-19"></a>             <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;team&#39;</span><span class="p">:</span> <span class="s1">&#39;away_team&#39;</span><span class="p">})</span>
<a id="__codelineno-46-20" name="__codelineno-46-20" href="#__codelineno-46-20"></a>             <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;home_game&#39;</span><span class="p">,</span> <span class="s1">&#39;odds&#39;</span><span class="p">]))</span>
<a id="__codelineno-46-21" name="__codelineno-46-21" href="#__codelineno-46-21"></a>
<a id="__codelineno-46-22" name="__codelineno-46-22" href="#__codelineno-46-22"></a><span class="n">diff_df</span> <span class="o">=</span> <span class="p">(</span><span class="n">diff_df</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">,</span> <span class="n">home_odds</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;home_team&#39;</span><span class="p">])</span>
<a id="__codelineno-46-23" name="__codelineno-46-23" href="#__codelineno-46-23"></a>              <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">,</span> <span class="n">away_odds</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;away_team&#39;</span><span class="p">]))</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-47-1" name="__codelineno-47-1" href="#__codelineno-47-1"></a><span class="n">diff_df</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span>
</code></pre></div>
<table>
<thead>
<tr>
<th></th>
<th>game</th>
<th>home_team</th>
<th>away_team</th>
<th>date</th>
<th>round</th>
<th>venue</th>
<th>season</th>
<th>f_odds</th>
<th>f_form_margin_btwn_teams</th>
<th>f_form_past_5_btwn_teams</th>
<th>f_odds_away</th>
<th>f_elo_home</th>
<th>f_elo_away</th>
<th>f_I50_efficiency_home</th>
<th>f_R50_efficiency_home</th>
<th>f_I50_efficiency_away</th>
<th>f_R50_efficiency_away</th>
<th>f_goals_diff</th>
<th>f_behinds_diff</th>
<th>f_points_diff</th>
<th>f_margin_diff</th>
<th>f_opponent_goals_diff</th>
<th>f_opponent_behinds_diff</th>
<th>f_opponent_points_diff</th>
<th>f_AF_diff</th>
<th>f_B_diff</th>
<th>f_BO_diff</th>
<th>f_CCL_diff</th>
<th>f_CG_diff</th>
<th>f_CL_diff</th>
<th>f_CM_diff</th>
<th>f_CP_diff</th>
<th>f_D_diff</th>
<th>f_ED_diff</th>
<th>f_FA_diff</th>
<th>f_FF_diff</th>
<th>f_G_diff</th>
<th>f_GA_diff</th>
<th>f_HB_diff</th>
<th>f_HO_diff</th>
<th>f_I50_diff</th>
<th>f_ITC_diff</th>
<th>f_K_diff</th>
<th>f_M_diff</th>
<th>f_MG_diff</th>
<th>f_MI5_diff</th>
<th>f_One.Percenters_diff</th>
<th>f_R50_diff</th>
<th>f_SC_diff</th>
<th>f_SCL_diff</th>
<th>f_SI_diff</th>
<th>f_T_diff</th>
<th>f_T5_diff</th>
<th>f_TO_diff</th>
<th>f_UP_diff</th>
<th>f_current_odds_prob</th>
<th>f_current_odds_prob_away</th>
</tr>
</thead>
<tbody>
<tr>
<td>1626</td>
<td>15394</td>
<td>Carlton</td>
<td>Adelaide</td>
<td>2018-08-25</td>
<td>23</td>
<td>Docklands</td>
<td>2018</td>
<td>6.467328</td>
<td>-26.2</td>
<td>1.0</td>
<td>2.066016</td>
<td>1230.072138</td>
<td>1587.776445</td>
<td>0.730668</td>
<td>0.675002</td>
<td>0.691614</td>
<td>0.677128</td>
<td>-3.498547</td>
<td>-5.527193</td>
<td>-26.518474</td>
<td>-34.473769</td>
<td>1.289715</td>
<td>0.217006</td>
<td>7.955295</td>
<td>-341.342677</td>
<td>-9.317269</td>
<td>3.088569</td>
<td>-2.600593</td>
<td>15.192839</td>
<td>-12.518345</td>
<td>-4.136673</td>
<td>-41.855717</td>
<td>-72.258378</td>
<td>-51.998775</td>
<td>9.499447</td>
<td>8.670917</td>
<td>-6.973088</td>
<td>-4.740623</td>
<td>-26.964945</td>
<td>-13.147675</td>
<td>-23.928700</td>
<td>-28.940883</td>
<td>-45.293433</td>
<td>-15.183406</td>
<td>-1900.784014</td>
<td>-0.362402</td>
<td>-1.314627</td>
<td>4.116133</td>
<td>-294.813511</td>
<td>-9.917793</td>
<td>-34.724925</td>
<td>-5.462844</td>
<td>-9.367141</td>
<td>-19.623785</td>
<td>-38.188082</td>
<td>0.187709</td>
<td>0.816860</td>
</tr>
<tr>
<td>1627</td>
<td>15395</td>
<td>Sydney</td>
<td>Hawthorn</td>
<td>2018-08-25</td>
<td>23</td>
<td>S.C.G.</td>
<td>2018</td>
<td>2.128611</td>
<td>1.0</td>
<td>2.0</td>
<td>1.777290</td>
<td>1662.568452</td>
<td>1615.507209</td>
<td>0.699994</td>
<td>0.778280</td>
<td>0.699158</td>
<td>0.673409</td>
<td>-1.756730</td>
<td>-0.874690</td>
<td>-11.415069</td>
<td>-15.575319</td>
<td>0.014390</td>
<td>4.073909</td>
<td>4.160250</td>
<td>-174.005092</td>
<td>-0.942357</td>
<td>-4.078635</td>
<td>-4.192916</td>
<td>7.814496</td>
<td>-2.225780</td>
<td>6.215760</td>
<td>15.042979</td>
<td>-34.894261</td>
<td>-50.615255</td>
<td>4.214158</td>
<td>0.683548</td>
<td>-3.535594</td>
<td>-3.168608</td>
<td>-12.068691</td>
<td>-30.493980</td>
<td>-9.867332</td>
<td>2.588103</td>
<td>-22.825570</td>
<td>-5.604199</td>
<td>253.086090</td>
<td>-2.697132</td>
<td>-22.612327</td>
<td>25.340623</td>
<td>-90.812188</td>
<td>1.967104</td>
<td>-31.047879</td>
<td>0.007606</td>
<td>-6.880120</td>
<td>11.415593</td>
<td>-49.957313</td>
<td>0.440180</td>
<td>0.561924</td>
</tr>
<tr>
<td>1628</td>
<td>15396</td>
<td>Brisbane</td>
<td>West Coast</td>
<td>2018-08-26</td>
<td>23</td>
<td>Gabba</td>
<td>2018</td>
<td>3.442757</td>
<td>-49.2</td>
<td>0.0</td>
<td>2.094236</td>
<td>1279.963814</td>
<td>1622.200265</td>
<td>0.683604</td>
<td>0.691730</td>
<td>0.696822</td>
<td>0.709605</td>
<td>-0.190413</td>
<td>1.182699</td>
<td>0.040221</td>
<td>-13.621456</td>
<td>1.772577</td>
<td>3.026217</td>
<td>13.661677</td>
<td>-22.709485</td>
<td>2.424261</td>
<td>-4.848054</td>
<td>1.800473</td>
<td>5.051157</td>
<td>6.440524</td>
<td>-5.549630</td>
<td>-17.041838</td>
<td>27.543023</td>
<td>33.983159</td>
<td>4.459181</td>
<td>-3.213885</td>
<td>-0.428455</td>
<td>1.514474</td>
<td>42.646138</td>
<td>-7.141638</td>
<td>1.457375</td>
<td>-17.472537</td>
<td>-15.103115</td>
<td>8.001966</td>
<td>-383.083539</td>
<td>6.458915</td>
<td>7.275716</td>
<td>0.942863</td>
<td>44.461590</td>
<td>4.640136</td>
<td>13.180967</td>
<td>-15.704694</td>
<td>2.366444</td>
<td>-5.985843</td>
<td>38.195255</td>
<td>0.433501</td>
<td>0.569866</td>
</tr>
<tr>
<td>1629</td>
<td>15397</td>
<td>Melbourne</td>
<td>GWS</td>
<td>2018-08-26</td>
<td>23</td>
<td>M.C.G.</td>
<td>2018</td>
<td>1.706488</td>
<td>-23.2</td>
<td>2.0</td>
<td>1.805565</td>
<td>1540.367850</td>
<td>1615.614668</td>
<td>0.667240</td>
<td>0.692632</td>
<td>0.684525</td>
<td>0.753783</td>
<td>2.056899</td>
<td>0.635785</td>
<td>12.977177</td>
<td>6.642811</td>
<td>1.443121</td>
<td>-2.324358</td>
<td>6.334366</td>
<td>147.281112</td>
<td>2.201404</td>
<td>-5.222254</td>
<td>3.250416</td>
<td>8.542475</td>
<td>-2.203571</td>
<td>3.559792</td>
<td>21.192530</td>
<td>33.737734</td>
<td>12.865653</td>
<td>-3.244066</td>
<td>-2.135243</td>
<td>4.100203</td>
<td>3.772200</td>
<td>48.425291</td>
<td>18.247107</td>
<td>13.349992</td>
<td>11.385136</td>
<td>-14.687556</td>
<td>5.052000</td>
<td>304.087088</td>
<td>11.062610</td>
<td>-6.686409</td>
<td>-16.414544</td>
<td>8.350924</td>
<td>-5.453961</td>
<td>12.407662</td>
<td>6.672628</td>
<td>-1.523915</td>
<td>13.075351</td>
<td>18.522113</td>
<td>0.661551</td>
<td>0.340379</td>
</tr>
<tr>
<td>1630</td>
<td>15398</td>
<td>St Kilda</td>
<td>North Melbourne</td>
<td>2018-08-26</td>
<td>23</td>
<td>Docklands</td>
<td>2018</td>
<td>5.516150</td>
<td>-3.2</td>
<td>2.0</td>
<td>2.272313</td>
<td>1372.453734</td>
<td>1454.022032</td>
<td>0.730843</td>
<td>0.635819</td>
<td>0.697018</td>
<td>0.654991</td>
<td>-2.257517</td>
<td>1.223261</td>
<td>-12.321842</td>
<td>-19.923855</td>
<td>1.189755</td>
<td>0.463481</td>
<td>7.602012</td>
<td>27.891262</td>
<td>3.201137</td>
<td>4.754346</td>
<td>-1.881145</td>
<td>-3.924740</td>
<td>-0.528075</td>
<td>-8.045729</td>
<td>-20.584717</td>
<td>36.806235</td>
<td>39.615090</td>
<td>7.018240</td>
<td>-4.709732</td>
<td>-4.535660</td>
<td>-3.372912</td>
<td>23.194704</td>
<td>-18.042370</td>
<td>1.214353</td>
<td>-14.771187</td>
<td>13.611531</td>
<td>11.690647</td>
<td>-109.284521</td>
<td>-0.229945</td>
<td>12.384044</td>
<td>-4.625633</td>
<td>57.158576</td>
<td>1.353070</td>
<td>-1.533659</td>
<td>-6.646259</td>
<td>-3.489492</td>
<td>-15.416140</td>
<td>58.470456</td>
<td>0.284269</td>
<td>0.717566</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="wrapping-it-up">Wrapping it Up</h2>
<p>We now have a fairly decent amount of features. Some other features which could be added include whether the game is in a major Capital city outisde of Mebourne (i.e. Sydney, Adelaide or Peth), how many 'Elite' players are playing (which could be judged by average SuperCoach scores over 110, for example), as well as your own metrics for attacking and defending.</p>
<p>Note that all of our features have columns starting with 'f_' so in the section, we will grab this feature dataframe and use these features to sport predicting the matches.</p>
<hr />
<h1 id="03-modelling">03. Modelling</h1>
<p>These tutorials will walk you through how to construct your own basic AFL model, using publically available data. The output will be odds for each team to win, which will be shown on <a href="https://www.betfair.com.au/hub/sports/afl/how-to-build-an-afl-model/">The Hub</a>.</p>
<p>In this notebook we will walk you through modelling our AFL data to create predictions. We will train a variety of quick and easy models to get a feel of what works and what doesn't. We will then tune our hyperparameters so that we are ready to make week by week predictions.</p>
<hr />
<h2 id="grabbing-our-dataset_1">Grabbing Our Dataset</h2>
<p>First, we will import our required modules, as well as the prepare_afl_features function which we created in our afl_feature_creation script. This essentially creates some basic features for us so that we can get started on the modelling component.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-48-1" name="__codelineno-48-1" href="#__codelineno-48-1"></a><span class="c1"># Import libraries</span>
<a id="__codelineno-48-2" name="__codelineno-48-2" href="#__codelineno-48-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">afl_data_cleaning_v2</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<a id="__codelineno-48-3" name="__codelineno-48-3" href="#__codelineno-48-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span>
<a id="__codelineno-48-4" name="__codelineno-48-4" href="#__codelineno-48-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<a id="__codelineno-48-5" name="__codelineno-48-5" href="#__codelineno-48-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<a id="__codelineno-48-6" name="__codelineno-48-6" href="#__codelineno-48-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn</span><span class="w"> </span><span class="kn">import</span> <span class="n">svm</span><span class="p">,</span> <span class="n">tree</span><span class="p">,</span> <span class="n">linear_model</span><span class="p">,</span> <span class="n">neighbors</span><span class="p">,</span> <span class="n">naive_bayes</span><span class="p">,</span> <span class="n">ensemble</span><span class="p">,</span> <span class="n">discriminant_analysis</span><span class="p">,</span> <span class="n">gaussian_process</span>
<a id="__codelineno-48-7" name="__codelineno-48-7" href="#__codelineno-48-7"></a><span class="c1"># from xgboost import XGBClassifier</span>
<a id="__codelineno-48-8" name="__codelineno-48-8" href="#__codelineno-48-8"></a><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">StratifiedKFold</span><span class="p">,</span> <span class="n">cross_val_score</span><span class="p">,</span> <span class="n">GridSearchCV</span><span class="p">,</span> <span class="n">train_test_split</span>
<a id="__codelineno-48-9" name="__codelineno-48-9" href="#__codelineno-48-9"></a><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.linear_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">LogisticRegressionCV</span>
<a id="__codelineno-48-10" name="__codelineno-48-10" href="#__codelineno-48-10"></a><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.feature_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">RFECV</span>
<a id="__codelineno-48-11" name="__codelineno-48-11" href="#__codelineno-48-11"></a><span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>
<a id="__codelineno-48-12" name="__codelineno-48-12" href="#__codelineno-48-12"></a><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">OneHotEncoder</span><span class="p">,</span> <span class="n">LabelEncoder</span><span class="p">,</span> <span class="n">StandardScaler</span>
<a id="__codelineno-48-13" name="__codelineno-48-13" href="#__codelineno-48-13"></a><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn</span><span class="w"> </span><span class="kn">import</span> <span class="n">feature_selection</span>
<a id="__codelineno-48-14" name="__codelineno-48-14" href="#__codelineno-48-14"></a><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn</span><span class="w"> </span><span class="kn">import</span> <span class="n">metrics</span>
<a id="__codelineno-48-15" name="__codelineno-48-15" href="#__codelineno-48-15"></a><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.linear_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">LogisticRegression</span><span class="p">,</span> <span class="n">RidgeClassifier</span>
<a id="__codelineno-48-16" name="__codelineno-48-16" href="#__codelineno-48-16"></a><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.ensemble</span><span class="w"> </span><span class="kn">import</span> <span class="n">RandomForestClassifier</span>
<a id="__codelineno-48-17" name="__codelineno-48-17" href="#__codelineno-48-17"></a><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.discriminant_analysis</span><span class="w"> </span><span class="kn">import</span> <span class="n">LinearDiscriminantAnalysis</span>
<a id="__codelineno-48-18" name="__codelineno-48-18" href="#__codelineno-48-18"></a><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.naive_bayes</span><span class="w"> </span><span class="kn">import</span> <span class="n">GaussianNB</span>
<a id="__codelineno-48-19" name="__codelineno-48-19" href="#__codelineno-48-19"></a><span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<a id="__codelineno-48-20" name="__codelineno-48-20" href="#__codelineno-48-20"></a><span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
<a id="__codelineno-48-21" name="__codelineno-48-21" href="#__codelineno-48-21"></a><span class="kn">import</span><span class="w"> </span><span class="nn">afl_feature_creation_v2</span>
<a id="__codelineno-48-22" name="__codelineno-48-22" href="#__codelineno-48-22"></a><span class="kn">import</span><span class="w"> </span><span class="nn">afl_data_cleaning_v2</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-49-1" name="__codelineno-49-1" href="#__codelineno-49-1"></a><span class="c1"># Grab our feature DataFrame which we created in the previous tutorial</span>
<a id="__codelineno-49-2" name="__codelineno-49-2" href="#__codelineno-49-2"></a><span class="n">feature_df</span> <span class="o">=</span> <span class="n">afl_feature_creation_v2</span><span class="o">.</span><span class="n">prepare_afl_features</span><span class="p">()</span>
<a id="__codelineno-49-3" name="__codelineno-49-3" href="#__codelineno-49-3"></a><span class="n">afl_data</span> <span class="o">=</span> <span class="n">afl_data_cleaning_v2</span><span class="o">.</span><span class="n">prepare_afl_data</span><span class="p">()</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-50-1" name="__codelineno-50-1" href="#__codelineno-50-1"></a><span class="n">feature_df</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</code></pre></div>
<table>
<thead>
<tr>
<th></th>
<th>game</th>
<th>home_team</th>
<th>away_team</th>
<th>date</th>
<th>round</th>
<th>venue</th>
<th>season</th>
<th>f_odds</th>
<th>f_form_margin_btwn_teams</th>
<th>f_form_past_5_btwn_teams</th>
<th>f_odds_away</th>
<th>f_elo_home</th>
<th>f_elo_away</th>
<th>f_I50_efficiency_home</th>
<th>f_R50_efficiency_home</th>
<th>f_I50_efficiency_away</th>
<th>f_R50_efficiency_away</th>
<th>f_goals_diff</th>
<th>f_behinds_diff</th>
<th>f_points_diff</th>
<th>f_margin_diff</th>
<th>f_opponent_goals_diff</th>
<th>f_opponent_behinds_diff</th>
<th>f_opponent_points_diff</th>
<th>f_AF_diff</th>
<th>f_B_diff</th>
<th>f_BO_diff</th>
<th>f_CCL_diff</th>
<th>f_CG_diff</th>
<th>f_CL_diff</th>
<th>f_CM_diff</th>
<th>f_CP_diff</th>
<th>f_D_diff</th>
<th>f_ED_diff</th>
<th>f_FA_diff</th>
<th>f_FF_diff</th>
<th>f_G_diff</th>
<th>f_GA_diff</th>
<th>f_HB_diff</th>
<th>f_HO_diff</th>
<th>f_I50_diff</th>
<th>f_ITC_diff</th>
<th>f_K_diff</th>
<th>f_M_diff</th>
<th>f_MG_diff</th>
<th>f_MI5_diff</th>
<th>f_One.Percenters_diff</th>
<th>f_R50_diff</th>
<th>f_SC_diff</th>
<th>f_SCL_diff</th>
<th>f_SI_diff</th>
<th>f_T_diff</th>
<th>f_T5_diff</th>
<th>f_TO_diff</th>
<th>f_UP_diff</th>
<th>f_current_odds_prob</th>
<th>f_current_odds_prob_away</th>
</tr>
</thead>
<tbody>
<tr>
<td>1628</td>
<td>15396</td>
<td>Brisbane</td>
<td>West Coast</td>
<td>2018-08-26</td>
<td>23</td>
<td>Gabba</td>
<td>2018</td>
<td>3.442757</td>
<td>-49.2</td>
<td>0.0</td>
<td>2.094236</td>
<td>1279.963814</td>
<td>1622.200265</td>
<td>0.683604</td>
<td>0.691730</td>
<td>0.696822</td>
<td>0.709605</td>
<td>-0.190413</td>
<td>1.182699</td>
<td>0.040221</td>
<td>-13.621456</td>
<td>1.772577</td>
<td>3.026217</td>
<td>13.661677</td>
<td>-22.709485</td>
<td>2.424261</td>
<td>-4.848054</td>
<td>1.800473</td>
<td>5.051157</td>
<td>6.440524</td>
<td>-5.549630</td>
<td>-17.041838</td>
<td>27.543023</td>
<td>33.983159</td>
<td>4.459181</td>
<td>-3.213885</td>
<td>-0.428455</td>
<td>1.514474</td>
<td>42.646138</td>
<td>-7.141638</td>
<td>1.457375</td>
<td>-17.472537</td>
<td>-15.103115</td>
<td>8.001966</td>
<td>-383.083539</td>
<td>6.458915</td>
<td>7.275716</td>
<td>0.942863</td>
<td>44.461590</td>
<td>4.640136</td>
<td>13.180967</td>
<td>-15.704694</td>
<td>2.366444</td>
<td>-5.985843</td>
<td>38.195255</td>
<td>0.433501</td>
<td>0.569866</td>
</tr>
<tr>
<td>1629</td>
<td>15397</td>
<td>Melbourne</td>
<td>GWS</td>
<td>2018-08-26</td>
<td>23</td>
<td>M.C.G.</td>
<td>2018</td>
<td>1.706488</td>
<td>-23.2</td>
<td>2.0</td>
<td>1.805565</td>
<td>1540.367850</td>
<td>1615.614668</td>
<td>0.667240</td>
<td>0.692632</td>
<td>0.684525</td>
<td>0.753783</td>
<td>2.056899</td>
<td>0.635785</td>
<td>12.977177</td>
<td>6.642811</td>
<td>1.443121</td>
<td>-2.324358</td>
<td>6.334366</td>
<td>147.281112</td>
<td>2.201404</td>
<td>-5.222254</td>
<td>3.250416</td>
<td>8.542475</td>
<td>-2.203571</td>
<td>3.559792</td>
<td>21.192530</td>
<td>33.737734</td>
<td>12.865653</td>
<td>-3.244066</td>
<td>-2.135243</td>
<td>4.100203</td>
<td>3.772200</td>
<td>48.425291</td>
<td>18.247107</td>
<td>13.349992</td>
<td>11.385136</td>
<td>-14.687556</td>
<td>5.052000</td>
<td>304.087088</td>
<td>11.062610</td>
<td>-6.686409</td>
<td>-16.414544</td>
<td>8.350924</td>
<td>-5.453961</td>
<td>12.407662</td>
<td>6.672628</td>
<td>-1.523915</td>
<td>13.075351</td>
<td>18.522113</td>
<td>0.661551</td>
<td>0.340379</td>
</tr>
<tr>
<td>1630</td>
<td>15398</td>
<td>St Kilda</td>
<td>North Melbourne</td>
<td>2018-08-26</td>
<td>23</td>
<td>Docklands</td>
<td>2018</td>
<td>5.516150</td>
<td>-3.2</td>
<td>2.0</td>
<td>2.272313</td>
<td>1372.453734</td>
<td>1454.022032</td>
<td>0.730843</td>
<td>0.635819</td>
<td>0.697018</td>
<td>0.654991</td>
<td>-2.257517</td>
<td>1.223261</td>
<td>-12.321842</td>
<td>-19.923855</td>
<td>1.189755</td>
<td>0.463481</td>
<td>7.602012</td>
<td>27.891262</td>
<td>3.201137</td>
<td>4.754346</td>
<td>-1.881145</td>
<td>-3.924740</td>
<td>-0.528075</td>
<td>-8.045729</td>
<td>-20.584717</td>
<td>36.806235</td>
<td>39.615090</td>
<td>7.018240</td>
<td>-4.709732</td>
<td>-4.535660</td>
<td>-3.372912</td>
<td>23.194704</td>
<td>-18.042370</td>
<td>1.214353</td>
<td>-14.771187</td>
<td>13.611531</td>
<td>11.690647</td>
<td>-109.284521</td>
<td>-0.229945</td>
<td>12.384044</td>
<td>-4.625633</td>
<td>57.158576</td>
<td>1.353070</td>
<td>-1.533659</td>
<td>-6.646259</td>
<td>-3.489492</td>
<td>-15.416140</td>
<td>58.470456</td>
<td>0.284269</td>
<td>0.717566</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre><span></span><code><a id="__codelineno-51-1" name="__codelineno-51-1" href="#__codelineno-51-1"></a><span class="c1"># Get the result and merge to the feature_df</span>
<a id="__codelineno-51-2" name="__codelineno-51-2" href="#__codelineno-51-2"></a>
<a id="__codelineno-51-3" name="__codelineno-51-3" href="#__codelineno-51-3"></a><span class="n">match_results</span> <span class="o">=</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;data/afl_match_results.csv&quot;</span><span class="p">)</span>
<a id="__codelineno-51-4" name="__codelineno-51-4" href="#__codelineno-51-4"></a>                    <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Game&#39;</span><span class="p">:</span> <span class="s1">&#39;game&#39;</span><span class="p">})</span>
<a id="__codelineno-51-5" name="__codelineno-51-5" href="#__codelineno-51-5"></a>                    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">result</span><span class="o">=</span><span class="k">lambda</span> <span class="n">df</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Home.Points&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Away.Points&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)))</span>
<a id="__codelineno-51-6" name="__codelineno-51-6" href="#__codelineno-51-6"></a>
<a id="__codelineno-51-7" name="__codelineno-51-7" href="#__codelineno-51-7"></a><span class="c1"># Merge result column to feature_df</span>
<a id="__codelineno-51-8" name="__codelineno-51-8" href="#__codelineno-51-8"></a><span class="n">feature_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">feature_df</span><span class="p">,</span> <span class="n">match_results</span><span class="p">[[</span><span class="s1">&#39;game&#39;</span><span class="p">,</span> <span class="s1">&#39;result&#39;</span><span class="p">]],</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;game&#39;</span><span class="p">)</span>
</code></pre></div>
<hr />
<h2 id="creating-a-training-and-testing-set">Creating a Training and Testing Set</h2>
<p>So that we don't train our data on the data that we will later test our model on, we will create separate train and test sets. For this exercise we will use the 2018 season to test how our model performs, whilst the rest of the data can be used to train the model.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-52-1" name="__codelineno-52-1" href="#__codelineno-52-1"></a><span class="c1"># Create our test and train sets from our afl DataFrame; drop the columns which leak the result, duplicates, and the advanced</span>
<a id="__codelineno-52-2" name="__codelineno-52-2" href="#__codelineno-52-2"></a><span class="c1"># stats which don&#39;t have data until 2015</span>
<a id="__codelineno-52-3" name="__codelineno-52-3" href="#__codelineno-52-3"></a>
<a id="__codelineno-52-4" name="__codelineno-52-4" href="#__codelineno-52-4"></a><span class="n">feature_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">feature_df</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;f_&#39;</span><span class="p">)]</span>
<a id="__codelineno-52-5" name="__codelineno-52-5" href="#__codelineno-52-5"></a>
<a id="__codelineno-52-6" name="__codelineno-52-6" href="#__codelineno-52-6"></a><span class="c1"># Create our test set</span>
<a id="__codelineno-52-7" name="__codelineno-52-7" href="#__codelineno-52-7"></a><span class="n">test_x</span> <span class="o">=</span> <span class="n">feature_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">feature_df</span><span class="o">.</span><span class="n">season</span> <span class="o">==</span> <span class="mi">2018</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;game&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">feature_columns</span><span class="p">]</span>
<a id="__codelineno-52-8" name="__codelineno-52-8" href="#__codelineno-52-8"></a><span class="n">test_y</span> <span class="o">=</span> <span class="n">feature_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">feature_df</span><span class="o">.</span><span class="n">season</span> <span class="o">==</span> <span class="mi">2018</span><span class="p">,</span> <span class="s1">&#39;result&#39;</span><span class="p">]</span>
<a id="__codelineno-52-9" name="__codelineno-52-9" href="#__codelineno-52-9"></a>
<a id="__codelineno-52-10" name="__codelineno-52-10" href="#__codelineno-52-10"></a><span class="c1"># Create our train set</span>
<a id="__codelineno-52-11" name="__codelineno-52-11" href="#__codelineno-52-11"></a><span class="n">X</span> <span class="o">=</span> <span class="n">feature_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">feature_df</span><span class="o">.</span><span class="n">season</span> <span class="o">!=</span> <span class="mi">2018</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;game&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">feature_columns</span><span class="p">]</span>
<a id="__codelineno-52-12" name="__codelineno-52-12" href="#__codelineno-52-12"></a><span class="n">y</span> <span class="o">=</span> <span class="n">feature_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">feature_df</span><span class="o">.</span><span class="n">season</span> <span class="o">!=</span> <span class="mi">2018</span><span class="p">,</span> <span class="s1">&#39;result&#39;</span><span class="p">]</span>
<a id="__codelineno-52-13" name="__codelineno-52-13" href="#__codelineno-52-13"></a>
<a id="__codelineno-52-14" name="__codelineno-52-14" href="#__codelineno-52-14"></a><span class="c1"># Scale features</span>
<a id="__codelineno-52-15" name="__codelineno-52-15" href="#__codelineno-52-15"></a><span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
<a id="__codelineno-52-16" name="__codelineno-52-16" href="#__codelineno-52-16"></a><span class="n">X</span><span class="p">[</span><span class="n">feature_columns</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">feature_columns</span><span class="p">])</span>
<a id="__codelineno-52-17" name="__codelineno-52-17" href="#__codelineno-52-17"></a><span class="n">test_x</span><span class="p">[</span><span class="n">feature_columns</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">test_x</span><span class="p">[</span><span class="n">feature_columns</span><span class="p">])</span>
</code></pre></div>
<hr />
<h2 id="using-cross-validation-to-find-the-best-algorithms">Using Cross Validation to Find The Best Algorithms</h2>
<p>Now that we have our training set, we can run through a list of popular classifiers to determine which classifier is best for modelling our data. To do this we will create a function which uses Kfold cross-validation to find the 'best' algorithms, based on how accurate the algorithms' predictions are.</p>
<p>This function will take in a list of classifiers, which we will define below, as well as the training set and it's outcome, and output a DataFrame with the mean and std of the accuracy of each algorithm. Let's jump into it!</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-53-1" name="__codelineno-53-1" href="#__codelineno-53-1"></a><span class="c1"># Create a list of standard classifiers</span>
<a id="__codelineno-53-2" name="__codelineno-53-2" href="#__codelineno-53-2"></a><span class="n">classifiers</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-53-3" name="__codelineno-53-3" href="#__codelineno-53-3"></a>    <span class="c1">#Ensemble Methods</span>
<a id="__codelineno-53-4" name="__codelineno-53-4" href="#__codelineno-53-4"></a>    <span class="n">ensemble</span><span class="o">.</span><span class="n">AdaBoostClassifier</span><span class="p">(),</span>
<a id="__codelineno-53-5" name="__codelineno-53-5" href="#__codelineno-53-5"></a>    <span class="n">ensemble</span><span class="o">.</span><span class="n">BaggingClassifier</span><span class="p">(),</span>
<a id="__codelineno-53-6" name="__codelineno-53-6" href="#__codelineno-53-6"></a>    <span class="n">ensemble</span><span class="o">.</span><span class="n">ExtraTreesClassifier</span><span class="p">(),</span>
<a id="__codelineno-53-7" name="__codelineno-53-7" href="#__codelineno-53-7"></a>    <span class="n">ensemble</span><span class="o">.</span><span class="n">GradientBoostingClassifier</span><span class="p">(),</span>
<a id="__codelineno-53-8" name="__codelineno-53-8" href="#__codelineno-53-8"></a>    <span class="n">ensemble</span><span class="o">.</span><span class="n">RandomForestClassifier</span><span class="p">(),</span>
<a id="__codelineno-53-9" name="__codelineno-53-9" href="#__codelineno-53-9"></a>
<a id="__codelineno-53-10" name="__codelineno-53-10" href="#__codelineno-53-10"></a>    <span class="c1">#Gaussian Processes</span>
<a id="__codelineno-53-11" name="__codelineno-53-11" href="#__codelineno-53-11"></a>    <span class="n">gaussian_process</span><span class="o">.</span><span class="n">GaussianProcessClassifier</span><span class="p">(),</span>
<a id="__codelineno-53-12" name="__codelineno-53-12" href="#__codelineno-53-12"></a>
<a id="__codelineno-53-13" name="__codelineno-53-13" href="#__codelineno-53-13"></a>    <span class="c1">#GLM</span>
<a id="__codelineno-53-14" name="__codelineno-53-14" href="#__codelineno-53-14"></a>    <span class="n">linear_model</span><span class="o">.</span><span class="n">LogisticRegressionCV</span><span class="p">(),</span>
<a id="__codelineno-53-15" name="__codelineno-53-15" href="#__codelineno-53-15"></a>
<a id="__codelineno-53-16" name="__codelineno-53-16" href="#__codelineno-53-16"></a>    <span class="c1">#Navies Bayes</span>
<a id="__codelineno-53-17" name="__codelineno-53-17" href="#__codelineno-53-17"></a>    <span class="n">naive_bayes</span><span class="o">.</span><span class="n">BernoulliNB</span><span class="p">(),</span>
<a id="__codelineno-53-18" name="__codelineno-53-18" href="#__codelineno-53-18"></a>    <span class="n">naive_bayes</span><span class="o">.</span><span class="n">GaussianNB</span><span class="p">(),</span>
<a id="__codelineno-53-19" name="__codelineno-53-19" href="#__codelineno-53-19"></a>
<a id="__codelineno-53-20" name="__codelineno-53-20" href="#__codelineno-53-20"></a>    <span class="c1">#SVM</span>
<a id="__codelineno-53-21" name="__codelineno-53-21" href="#__codelineno-53-21"></a>    <span class="n">svm</span><span class="o">.</span><span class="n">SVC</span><span class="p">(</span><span class="n">probability</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-53-22" name="__codelineno-53-22" href="#__codelineno-53-22"></a>    <span class="n">svm</span><span class="o">.</span><span class="n">NuSVC</span><span class="p">(</span><span class="n">probability</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-53-23" name="__codelineno-53-23" href="#__codelineno-53-23"></a>
<a id="__codelineno-53-24" name="__codelineno-53-24" href="#__codelineno-53-24"></a>    <span class="c1">#Discriminant Analysis</span>
<a id="__codelineno-53-25" name="__codelineno-53-25" href="#__codelineno-53-25"></a>    <span class="n">discriminant_analysis</span><span class="o">.</span><span class="n">LinearDiscriminantAnalysis</span><span class="p">(),</span>
<a id="__codelineno-53-26" name="__codelineno-53-26" href="#__codelineno-53-26"></a>    <span class="n">discriminant_analysis</span><span class="o">.</span><span class="n">QuadraticDiscriminantAnalysis</span><span class="p">(),</span>
<a id="__codelineno-53-27" name="__codelineno-53-27" href="#__codelineno-53-27"></a>
<a id="__codelineno-53-28" name="__codelineno-53-28" href="#__codelineno-53-28"></a>    <span class="c1">#xgboost: http://xgboost.readthedocs.io/en/latest/model.html</span>
<a id="__codelineno-53-29" name="__codelineno-53-29" href="#__codelineno-53-29"></a><span class="c1">#     XGBClassifier()    </span>
<a id="__codelineno-53-30" name="__codelineno-53-30" href="#__codelineno-53-30"></a><span class="p">]</span>
<a id="__codelineno-53-31" name="__codelineno-53-31" href="#__codelineno-53-31"></a>
<a id="__codelineno-53-32" name="__codelineno-53-32" href="#__codelineno-53-32"></a><span class="c1"># Define a functiom which finds the best algorithms for our modelling task</span>
<a id="__codelineno-53-33" name="__codelineno-53-33" href="#__codelineno-53-33"></a><span class="k">def</span><span class="w"> </span><span class="nf">find_best_algorithms</span><span class="p">(</span><span class="n">classifier_list</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
<a id="__codelineno-53-34" name="__codelineno-53-34" href="#__codelineno-53-34"></a>    <span class="c1"># This function is adapted from https://www.kaggle.com/yassineghouzam/titanic-top-4-with-ensemble-modeling</span>
<a id="__codelineno-53-35" name="__codelineno-53-35" href="#__codelineno-53-35"></a>    <span class="c1"># Cross validate model with Kfold stratified cross validation</span>
<a id="__codelineno-53-36" name="__codelineno-53-36" href="#__codelineno-53-36"></a>    <span class="n">kfold</span> <span class="o">=</span> <span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<a id="__codelineno-53-37" name="__codelineno-53-37" href="#__codelineno-53-37"></a>
<a id="__codelineno-53-38" name="__codelineno-53-38" href="#__codelineno-53-38"></a>    <span class="c1"># Grab the cross validation scores for each algorithm</span>
<a id="__codelineno-53-39" name="__codelineno-53-39" href="#__codelineno-53-39"></a>    <span class="n">cv_results</span> <span class="o">=</span> <span class="p">[</span><span class="n">cross_val_score</span><span class="p">(</span><span class="n">classifier</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">scoring</span> <span class="o">=</span> <span class="s2">&quot;neg_log_loss&quot;</span><span class="p">,</span> <span class="n">cv</span> <span class="o">=</span> <span class="n">kfold</span><span class="p">)</span> <span class="k">for</span> <span class="n">classifier</span> <span class="ow">in</span> <span class="n">classifier_list</span><span class="p">]</span>
<a id="__codelineno-53-40" name="__codelineno-53-40" href="#__codelineno-53-40"></a>    <span class="n">cv_means</span> <span class="o">=</span> <span class="p">[</span><span class="n">cv_result</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span> <span class="k">for</span> <span class="n">cv_result</span> <span class="ow">in</span> <span class="n">cv_results</span><span class="p">]</span>
<a id="__codelineno-53-41" name="__codelineno-53-41" href="#__codelineno-53-41"></a>    <span class="n">cv_std</span> <span class="o">=</span> <span class="p">[</span><span class="n">cv_result</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="k">for</span> <span class="n">cv_result</span> <span class="ow">in</span> <span class="n">cv_results</span><span class="p">]</span>
<a id="__codelineno-53-42" name="__codelineno-53-42" href="#__codelineno-53-42"></a>    <span class="n">algorithm_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">alg</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="k">for</span> <span class="n">alg</span> <span class="ow">in</span> <span class="n">classifiers</span><span class="p">]</span>
<a id="__codelineno-53-43" name="__codelineno-53-43" href="#__codelineno-53-43"></a>
<a id="__codelineno-53-44" name="__codelineno-53-44" href="#__codelineno-53-44"></a>    <span class="c1"># Create a DataFrame of all the CV results</span>
<a id="__codelineno-53-45" name="__codelineno-53-45" href="#__codelineno-53-45"></a>    <span class="n">cv_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
<a id="__codelineno-53-46" name="__codelineno-53-46" href="#__codelineno-53-46"></a>        <span class="s2">&quot;Mean Log Loss&quot;</span><span class="p">:</span> <span class="n">cv_means</span><span class="p">,</span>
<a id="__codelineno-53-47" name="__codelineno-53-47" href="#__codelineno-53-47"></a>        <span class="s2">&quot;Log Loss Std&quot;</span><span class="p">:</span> <span class="n">cv_std</span><span class="p">,</span>
<a id="__codelineno-53-48" name="__codelineno-53-48" href="#__codelineno-53-48"></a>        <span class="s2">&quot;Algorithm&quot;</span><span class="p">:</span> <span class="n">algorithm_names</span>
<a id="__codelineno-53-49" name="__codelineno-53-49" href="#__codelineno-53-49"></a>    <span class="p">})</span>
<a id="__codelineno-53-50" name="__codelineno-53-50" href="#__codelineno-53-50"></a>
<a id="__codelineno-53-51" name="__codelineno-53-51" href="#__codelineno-53-51"></a>    <span class="k">return</span> <span class="n">cv_results</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;Mean Log Loss&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-54-1" name="__codelineno-54-1" href="#__codelineno-54-1"></a><span class="n">best_algos</span> <span class="o">=</span> <span class="n">find_best_algorithms</span><span class="p">(</span><span class="n">classifiers</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<a id="__codelineno-54-2" name="__codelineno-54-2" href="#__codelineno-54-2"></a><span class="n">best_algos</span>
</code></pre></div>
<table>
<thead>
<tr>
<th></th>
<th>Mean Log Loss</th>
<th>Log Loss Std</th>
<th>Algorithm</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>0.539131</td>
<td>3.640578e-02</td>
<td>LogisticRegressionCV</td>
</tr>
<tr>
<td>1</td>
<td>0.551241</td>
<td>5.775685e-02</td>
<td>LinearDiscriminantAnalysis</td>
</tr>
<tr>
<td>2</td>
<td>0.630994</td>
<td>8.257481e-02</td>
<td>GradientBoostingClassifier</td>
</tr>
<tr>
<td>3</td>
<td>0.670041</td>
<td>9.205780e-03</td>
<td>AdaBoostClassifier</td>
</tr>
<tr>
<td>4</td>
<td>0.693147</td>
<td>2.360121e-08</td>
<td>GaussianProcessClassifier</td>
</tr>
<tr>
<td>5</td>
<td>0.712537</td>
<td>2.770864e-02</td>
<td>SVC</td>
</tr>
<tr>
<td>6</td>
<td>0.712896</td>
<td>2.440755e-02</td>
<td>NuSVC</td>
</tr>
<tr>
<td>7</td>
<td>0.836191</td>
<td>2.094224e-01</td>
<td>ExtraTreesClassifier</td>
</tr>
<tr>
<td>8</td>
<td>0.874307</td>
<td>1.558144e-01</td>
<td>RandomForestClassifier</td>
</tr>
<tr>
<td>9</td>
<td>1.288174</td>
<td>3.953037e-01</td>
<td>BaggingClassifier</td>
</tr>
<tr>
<td>10</td>
<td>1.884019</td>
<td>4.769589e-01</td>
<td>QuadraticDiscriminantAnalysis</td>
</tr>
<tr>
<td>11</td>
<td>2.652161</td>
<td>6.886897e-01</td>
<td>BernoulliNB</td>
</tr>
<tr>
<td>12</td>
<td>3.299651</td>
<td>6.427551e-01</td>
<td>GaussianNB</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre><span></span><code><a id="__codelineno-55-1" name="__codelineno-55-1" href="#__codelineno-55-1"></a><span class="c1"># Try a logistic regression model and see how it performs in terms of accuracy</span>
<a id="__codelineno-55-2" name="__codelineno-55-2" href="#__codelineno-55-2"></a><span class="n">kfold</span> <span class="o">=</span> <span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<a id="__codelineno-55-3" name="__codelineno-55-3" href="#__codelineno-55-3"></a><span class="n">cv_scores</span> <span class="o">=</span> <span class="n">cross_val_score</span><span class="p">(</span><span class="n">linear_model</span><span class="o">.</span><span class="n">LogisticRegressionCV</span><span class="p">(),</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;accuracy&#39;</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="n">kfold</span><span class="p">)</span>
<a id="__codelineno-55-4" name="__codelineno-55-4" href="#__codelineno-55-4"></a><span class="n">cv_scores</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<a id="__codelineno-55-5" name="__codelineno-55-5" href="#__codelineno-55-5"></a>    <span class="mf">0.7452268937025035</span>
</code></pre></div>
<h3 id="choosing-our-algorithms">Choosing Our Algorithms</h3>
<p>As we can see from above, there are some pretty poor algorithms for predicting the winner. On the other hand, whilst attaining an accuracy of 74.5% (at the time of writing) may seem like a decent result; we must first establish a baseline to judge our performance on. In this case, we will have two baselines; the proportion of games won by the home team and what the odds predict. If we can beat the odds we have created a very powerful model.</p>
<p>Note that a baseline for the log loss can also be both the odds log loss and randomly guessing. Randomly guessing between two teams attains a log loss of log(2) = 0.69, so we have beaten this result.</p>
<p>Once we establish our baseline, we will choose the top algorithms from above and tune their hyperparameters, as well as automatically selecting the best features to be used in our model.</p>
<hr />
<h2 id="defining-our-baseline">Defining Our Baseline</h2>
<p>As stated above, we must define our baseline so that we have a measure to beat. We will use the proportion of games won by the home team, as well as the proportion of favourites who won, based off the odds. To establish this baseline we will use our feature_df, as this has no dropped rows.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-56-1" name="__codelineno-56-1" href="#__codelineno-56-1"></a><span class="c1"># Find the percentage chance of winning at home in each season.</span>
<a id="__codelineno-56-2" name="__codelineno-56-2" href="#__codelineno-56-2"></a><span class="n">afl_data</span> <span class="o">=</span> <span class="n">afl_data_cleaning_v2</span><span class="o">.</span><span class="n">prepare_afl_data</span><span class="p">()</span>
<a id="__codelineno-56-3" name="__codelineno-56-3" href="#__codelineno-56-3"></a><span class="n">afl_data</span><span class="p">[</span><span class="s1">&#39;home_win&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">afl_data</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;f_margin&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-56-4" name="__codelineno-56-4" href="#__codelineno-56-4"></a><span class="n">home_games</span> <span class="o">=</span> <span class="n">afl_data</span><span class="p">[</span><span class="n">afl_data</span><span class="p">[</span><span class="s1">&#39;home_game&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-56-5" name="__codelineno-56-5" href="#__codelineno-56-5"></a><span class="n">home_games</span><span class="p">[[</span><span class="s2">&quot;home_win&quot;</span><span class="p">,</span> <span class="s1">&#39;season&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;season&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</code></pre></div>
<table>
<thead>
<tr>
<th>season</th>
<th>home_win</th>
</tr>
</thead>
<tbody>
<tr>
<td>2011</td>
<td>0.561856</td>
</tr>
<tr>
<td>2012</td>
<td>0.563725</td>
</tr>
<tr>
<td>2013</td>
<td>0.561576</td>
</tr>
<tr>
<td>2014</td>
<td>0.574257</td>
</tr>
<tr>
<td>2015</td>
<td>0.539604</td>
</tr>
<tr>
<td>2016</td>
<td>0.606742</td>
</tr>
<tr>
<td>2017</td>
<td>0.604061</td>
</tr>
<tr>
<td>2018</td>
<td>0.540404</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre><span></span><code><a id="__codelineno-57-1" name="__codelineno-57-1" href="#__codelineno-57-1"></a><span class="c1"># Find the proportion of favourites who have won</span>
<a id="__codelineno-57-2" name="__codelineno-57-2" href="#__codelineno-57-2"></a>
<a id="__codelineno-57-3" name="__codelineno-57-3" href="#__codelineno-57-3"></a><span class="c1"># Define a function which finds if the odds correctly guessed the response</span>
<a id="__codelineno-57-4" name="__codelineno-57-4" href="#__codelineno-57-4"></a><span class="k">def</span><span class="w"> </span><span class="nf">find_odds_prediction</span><span class="p">(</span><span class="n">a_row</span><span class="p">):</span>
<a id="__codelineno-57-5" name="__codelineno-57-5" href="#__codelineno-57-5"></a>    <span class="k">if</span> <span class="n">a_row</span><span class="p">[</span><span class="s1">&#39;f_odds&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">a_row</span><span class="p">[</span><span class="s1">&#39;f_odds_away&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">a_row</span><span class="p">[</span><span class="s1">&#39;home_win&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-57-6" name="__codelineno-57-6" href="#__codelineno-57-6"></a>        <span class="k">return</span> <span class="mi">1</span>
<a id="__codelineno-57-7" name="__codelineno-57-7" href="#__codelineno-57-7"></a>    <span class="k">elif</span> <span class="n">a_row</span><span class="p">[</span><span class="s1">&#39;f_odds_away&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">a_row</span><span class="p">[</span><span class="s1">&#39;f_odds&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">a_row</span><span class="p">[</span><span class="s1">&#39;home_win&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-57-8" name="__codelineno-57-8" href="#__codelineno-57-8"></a>        <span class="k">return</span> <span class="mi">1</span>
<a id="__codelineno-57-9" name="__codelineno-57-9" href="#__codelineno-57-9"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-57-10" name="__codelineno-57-10" href="#__codelineno-57-10"></a>        <span class="k">return</span> <span class="mi">0</span>
<a id="__codelineno-57-11" name="__codelineno-57-11" href="#__codelineno-57-11"></a>
<a id="__codelineno-57-12" name="__codelineno-57-12" href="#__codelineno-57-12"></a><span class="c1"># Define a function which splits our DataFrame so each game is on one row instead of two</span>
<a id="__codelineno-57-13" name="__codelineno-57-13" href="#__codelineno-57-13"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_df_on_one_line</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
<a id="__codelineno-57-14" name="__codelineno-57-14" href="#__codelineno-57-14"></a>    <span class="n">cols_to_drop</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;home_game&#39;</span><span class="p">,</span> <span class="s1">&#39;opponent&#39;</span><span class="p">,</span> 
<a id="__codelineno-57-15" name="__codelineno-57-15" href="#__codelineno-57-15"></a>       <span class="s1">&#39;f_opponent_behinds&#39;</span><span class="p">,</span> <span class="s1">&#39;f_opponent_goals&#39;</span><span class="p">,</span> <span class="s1">&#39;f_opponent_points&#39;</span><span class="p">,</span> <span class="s1">&#39;f_points&#39;</span><span class="p">,</span>
<a id="__codelineno-57-16" name="__codelineno-57-16" href="#__codelineno-57-16"></a>       <span class="s1">&#39;round&#39;</span><span class="p">,</span> <span class="s1">&#39;venue&#39;</span><span class="p">,</span> <span class="s1">&#39;season&#39;</span><span class="p">]</span>
<a id="__codelineno-57-17" name="__codelineno-57-17" href="#__codelineno-57-17"></a>
<a id="__codelineno-57-18" name="__codelineno-57-18" href="#__codelineno-57-18"></a>    <span class="n">home_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;home_game&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;team&#39;</span><span class="p">:</span> <span class="s1">&#39;home_team&#39;</span><span class="p">})</span>
<a id="__codelineno-57-19" name="__codelineno-57-19" href="#__codelineno-57-19"></a>    <span class="n">away_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;home_game&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;team&#39;</span><span class="p">:</span> <span class="s1">&#39;away_team&#39;</span><span class="p">})</span>
<a id="__codelineno-57-20" name="__codelineno-57-20" href="#__codelineno-57-20"></a>    <span class="n">away_df</span> <span class="o">=</span> <span class="n">away_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">cols_to_drop</span><span class="p">)</span>
<a id="__codelineno-57-21" name="__codelineno-57-21" href="#__codelineno-57-21"></a>
<a id="__codelineno-57-22" name="__codelineno-57-22" href="#__codelineno-57-22"></a>    <span class="c1"># Rename away_df columns</span>
<a id="__codelineno-57-23" name="__codelineno-57-23" href="#__codelineno-57-23"></a>    <span class="n">away_df_renamed</span> <span class="o">=</span> <span class="n">away_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">col</span><span class="p">:</span> <span class="n">col</span> <span class="o">+</span> <span class="s1">&#39;_away&#39;</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">away_df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span> <span class="o">!=</span> <span class="s1">&#39;game&#39;</span><span class="p">})</span>
<a id="__codelineno-57-24" name="__codelineno-57-24" href="#__codelineno-57-24"></a>    <span class="n">merged_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">home_df</span><span class="p">,</span> <span class="n">away_df_renamed</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;game&#39;</span><span class="p">)</span>
<a id="__codelineno-57-25" name="__codelineno-57-25" href="#__codelineno-57-25"></a>
<a id="__codelineno-57-26" name="__codelineno-57-26" href="#__codelineno-57-26"></a>    <span class="n">merged_df</span><span class="p">[</span><span class="s1">&#39;home_win&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">merged_df</span><span class="o">.</span><span class="n">f_margin</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-57-27" name="__codelineno-57-27" href="#__codelineno-57-27"></a>    <span class="k">return</span> <span class="n">merged_df</span>
<a id="__codelineno-57-28" name="__codelineno-57-28" href="#__codelineno-57-28"></a>
<a id="__codelineno-57-29" name="__codelineno-57-29" href="#__codelineno-57-29"></a><span class="n">afl_data_one_line</span> <span class="o">=</span> <span class="n">get_df_on_one_line</span><span class="p">(</span><span class="n">afl_data</span><span class="p">)</span>
<a id="__codelineno-57-30" name="__codelineno-57-30" href="#__codelineno-57-30"></a><span class="n">afl_data_one_line</span><span class="p">[</span><span class="s1">&#39;odds_prediction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">afl_data_one_line</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">find_odds_prediction</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-57-31" name="__codelineno-57-31" href="#__codelineno-57-31"></a><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The overall mean accuracy of choosing the favourite based on the odds is </span><span class="si">{}</span><span class="s1">%&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
<a id="__codelineno-57-32" name="__codelineno-57-32" href="#__codelineno-57-32"></a>    <span class="nb">round</span><span class="p">(</span><span class="n">afl_data_one_line</span><span class="p">[</span><span class="s1">&#39;odds_prediction&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>
<a id="__codelineno-57-33" name="__codelineno-57-33" href="#__codelineno-57-33"></a><span class="n">afl_data_one_line</span><span class="p">[[</span><span class="s2">&quot;odds_prediction&quot;</span><span class="p">,</span> <span class="s1">&#39;season&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;season&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>The overall mean accuracy of choosing the favourite based on the odds is 73.15%
</code></pre></div>
<table>
<thead>
<tr>
<th>season</th>
<th>odds_prediction</th>
</tr>
</thead>
<tbody>
<tr>
<td>2011</td>
<td>0.784615</td>
</tr>
<tr>
<td>2012</td>
<td>0.774510</td>
</tr>
<tr>
<td>2013</td>
<td>0.748768</td>
</tr>
<tr>
<td>2014</td>
<td>0.727723</td>
</tr>
<tr>
<td>2015</td>
<td>0.727723</td>
</tr>
<tr>
<td>2016</td>
<td>0.713483</td>
</tr>
<tr>
<td>2017</td>
<td>0.659898</td>
</tr>
<tr>
<td>2018</td>
<td>0.712121</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre><span></span><code><a id="__codelineno-58-1" name="__codelineno-58-1" href="#__codelineno-58-1"></a><span class="c1">## Get a baseline log loss score from the odds</span>
<a id="__codelineno-58-2" name="__codelineno-58-2" href="#__codelineno-58-2"></a><span class="n">afl_data_one_line</span><span class="p">[</span><span class="s1">&#39;odds_home_prob&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">afl_data_one_line</span><span class="o">.</span><span class="n">f_odds</span>
<a id="__codelineno-58-3" name="__codelineno-58-3" href="#__codelineno-58-3"></a><span class="n">afl_data_one_line</span><span class="p">[</span><span class="s1">&#39;odds_away_prob&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">afl_data_one_line</span><span class="o">.</span><span class="n">f_odds_away</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-59-1" name="__codelineno-59-1" href="#__codelineno-59-1"></a><span class="n">metrics</span><span class="o">.</span><span class="n">log_loss</span><span class="p">(</span><span class="n">afl_data_one_line</span><span class="o">.</span><span class="n">home_win</span><span class="p">,</span> <span class="n">afl_data_one_line</span><span class="p">[[</span><span class="s1">&#39;odds_away_prob&#39;</span><span class="p">,</span> <span class="s1">&#39;odds_home_prob&#39;</span><span class="p">]])</span>
<a id="__codelineno-59-2" name="__codelineno-59-2" href="#__codelineno-59-2"></a>    <span class="mf">0.5375306549682837</span>
</code></pre></div>
<p>We can see that the odds are MUCH more accurate than just choosing the home team to win. We can also see that the mean accuracy of choosing the favourite is around 73%. That means that this is the score we need to beat. Similarly, the log loss of the odds is around 0.5385, whilst our model scores around 0.539 (at the time of writing), without hyperparamter optimisation. Let's choose only the algorithms with log losses below 0.67</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-60-1" name="__codelineno-60-1" href="#__codelineno-60-1"></a><span class="n">chosen_algorithms</span> <span class="o">=</span> <span class="n">best_algos</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">best_algos</span><span class="p">[</span><span class="s1">&#39;Mean Log Loss&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.67</span><span class="p">,</span> <span class="s1">&#39;Algorithm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<a id="__codelineno-60-2" name="__codelineno-60-2" href="#__codelineno-60-2"></a><span class="n">chosen_algorithms</span>
<a id="__codelineno-60-3" name="__codelineno-60-3" href="#__codelineno-60-3"></a>    <span class="p">[</span><span class="s1">&#39;LogisticRegressionCV&#39;</span><span class="p">,</span>
<a id="__codelineno-60-4" name="__codelineno-60-4" href="#__codelineno-60-4"></a>     <span class="s1">&#39;LinearDiscriminantAnalysis&#39;</span><span class="p">,</span>
<a id="__codelineno-60-5" name="__codelineno-60-5" href="#__codelineno-60-5"></a>     <span class="s1">&#39;GradientBoostingClassifier&#39;</span><span class="p">]</span>
</code></pre></div>
<hr />
<h2 id="using-grid-search-to-tune-hyperparameters">Using Grid Search To Tune Hyperparameters</h2>
<p>Now that we have our best models, we can use <a href="https://en.wikipedia.org/wiki/Hyperparameter_optimization#Grid_search">Grid Search</a> to optimise our hyperparameters. Grid search basically involves searching through a range of different algorithm hyperparameters, and choosing those which result in the best score from some metrics, which in our case is accuracy. Let's do this for the algorithms which have hyperparameters which can be tuned. Note that if you are running this on your own computer it may take up to 10 minutes.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-61-1" name="__codelineno-61-1" href="#__codelineno-61-1"></a><span class="c1"># Define a function which optimises the hyperparameters of our chosen algorithms</span>
<a id="__codelineno-61-2" name="__codelineno-61-2" href="#__codelineno-61-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">optimise_hyperparameters</span><span class="p">(</span><span class="n">train_x</span><span class="p">,</span> <span class="n">train_y</span><span class="p">,</span> <span class="n">algorithms</span><span class="p">,</span> <span class="n">parameters</span><span class="p">):</span>
<a id="__codelineno-61-3" name="__codelineno-61-3" href="#__codelineno-61-3"></a>    <span class="n">kfold</span> <span class="o">=</span> <span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<a id="__codelineno-61-4" name="__codelineno-61-4" href="#__codelineno-61-4"></a>    <span class="n">best_estimators</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-61-5" name="__codelineno-61-5" href="#__codelineno-61-5"></a>
<a id="__codelineno-61-6" name="__codelineno-61-6" href="#__codelineno-61-6"></a>    <span class="k">for</span> <span class="n">alg</span><span class="p">,</span> <span class="n">params</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">algorithms</span><span class="p">,</span> <span class="n">parameters</span><span class="p">):</span>
<a id="__codelineno-61-7" name="__codelineno-61-7" href="#__codelineno-61-7"></a>        <span class="n">gs</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span><span class="n">alg</span><span class="p">,</span> <span class="n">param_grid</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="n">kfold</span><span class="p">,</span> <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;neg_log_loss&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-61-8" name="__codelineno-61-8" href="#__codelineno-61-8"></a>        <span class="n">gs</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_x</span><span class="p">,</span> <span class="n">train_y</span><span class="p">)</span>
<a id="__codelineno-61-9" name="__codelineno-61-9" href="#__codelineno-61-9"></a>        <span class="n">best_estimators</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gs</span><span class="o">.</span><span class="n">best_estimator_</span><span class="p">)</span>
<a id="__codelineno-61-10" name="__codelineno-61-10" href="#__codelineno-61-10"></a>    <span class="k">return</span> <span class="n">best_estimators</span>
<a id="__codelineno-61-11" name="__codelineno-61-11" href="#__codelineno-61-11"></a>
<a id="__codelineno-61-12" name="__codelineno-61-12" href="#__codelineno-61-12"></a><span class="c1"># Define our parameters to run a grid search over</span>
<a id="__codelineno-61-13" name="__codelineno-61-13" href="#__codelineno-61-13"></a><span class="n">lr_grid</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-61-14" name="__codelineno-61-14" href="#__codelineno-61-14"></a>    <span class="s2">&quot;C&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.0001</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span>
<a id="__codelineno-61-15" name="__codelineno-61-15" href="#__codelineno-61-15"></a>    <span class="s2">&quot;solver&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;newton-cg&quot;</span><span class="p">,</span> <span class="s2">&quot;lbfgs&quot;</span><span class="p">,</span> <span class="s2">&quot;liblinear&quot;</span><span class="p">]</span>
<a id="__codelineno-61-16" name="__codelineno-61-16" href="#__codelineno-61-16"></a><span class="p">}</span>
<a id="__codelineno-61-17" name="__codelineno-61-17" href="#__codelineno-61-17"></a>
<a id="__codelineno-61-18" name="__codelineno-61-18" href="#__codelineno-61-18"></a><span class="c1"># Add our algorithms and parameters to lists to be used in our function</span>
<a id="__codelineno-61-19" name="__codelineno-61-19" href="#__codelineno-61-19"></a><span class="n">alg_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">LogisticRegression</span><span class="p">()]</span>
<a id="__codelineno-61-20" name="__codelineno-61-20" href="#__codelineno-61-20"></a><span class="n">param_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">lr_grid</span><span class="p">]</span>
</code></pre></div>
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-62-1" name="__codelineno-62-1" href="#__codelineno-62-1"></a><span class="c1"># Find the best estimators, then add our other estimators which don&#39;t need optimisation</span>
<a id="__codelineno-62-2" name="__codelineno-62-2" href="#__codelineno-62-2"></a><span class="n">best_estimators</span> <span class="o">=</span> <span class="n">optimise_hyperparameters</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">alg_list</span><span class="p">,</span> <span class="n">param_list</span><span class="p">)</span>
</code></pre></div>
    Fitting 5 folds for each of 18 candidates, totalling 90 fits</p>
<div class="highlight"><pre><span></span><code>[Parallel(n_jobs=1)]: Done  90 out of  90 | elapsed:    5.2s finished
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-63-1" name="__codelineno-63-1" href="#__codelineno-63-1"></a><span class="n">lr_best_params</span> <span class="o">=</span> <span class="n">best_estimators</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_params</span><span class="p">()</span>
<a id="__codelineno-63-2" name="__codelineno-63-2" href="#__codelineno-63-2"></a><span class="n">lr_best_params</span>
<a id="__codelineno-63-3" name="__codelineno-63-3" href="#__codelineno-63-3"></a>    <span class="p">{</span><span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">,</span>
<a id="__codelineno-63-4" name="__codelineno-63-4" href="#__codelineno-63-4"></a>     <span class="s1">&#39;class_weight&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-63-5" name="__codelineno-63-5" href="#__codelineno-63-5"></a>     <span class="s1">&#39;dual&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-63-6" name="__codelineno-63-6" href="#__codelineno-63-6"></a>     <span class="s1">&#39;fit_intercept&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-63-7" name="__codelineno-63-7" href="#__codelineno-63-7"></a>     <span class="s1">&#39;intercept_scaling&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-63-8" name="__codelineno-63-8" href="#__codelineno-63-8"></a>     <span class="s1">&#39;max_iter&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
<a id="__codelineno-63-9" name="__codelineno-63-9" href="#__codelineno-63-9"></a>     <span class="s1">&#39;multi_class&#39;</span><span class="p">:</span> <span class="s1">&#39;ovr&#39;</span><span class="p">,</span>
<a id="__codelineno-63-10" name="__codelineno-63-10" href="#__codelineno-63-10"></a>     <span class="s1">&#39;n_jobs&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-63-11" name="__codelineno-63-11" href="#__codelineno-63-11"></a>     <span class="s1">&#39;penalty&#39;</span><span class="p">:</span> <span class="s1">&#39;l2&#39;</span><span class="p">,</span>
<a id="__codelineno-63-12" name="__codelineno-63-12" href="#__codelineno-63-12"></a>     <span class="s1">&#39;random_state&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-63-13" name="__codelineno-63-13" href="#__codelineno-63-13"></a>     <span class="s1">&#39;solver&#39;</span><span class="p">:</span> <span class="s1">&#39;newton-cg&#39;</span><span class="p">,</span>
<a id="__codelineno-63-14" name="__codelineno-63-14" href="#__codelineno-63-14"></a>     <span class="s1">&#39;tol&#39;</span><span class="p">:</span> <span class="mf">0.0001</span><span class="p">,</span>
<a id="__codelineno-63-15" name="__codelineno-63-15" href="#__codelineno-63-15"></a>     <span class="s1">&#39;verbose&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-63-16" name="__codelineno-63-16" href="#__codelineno-63-16"></a>     <span class="s1">&#39;warm_start&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-64-1" name="__codelineno-64-1" href="#__codelineno-64-1"></a><span class="n">kfold</span> <span class="o">=</span> <span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<a id="__codelineno-64-2" name="__codelineno-64-2" href="#__codelineno-64-2"></a><span class="n">cv_scores</span> <span class="o">=</span> <span class="n">cross_val_score</span><span class="p">(</span><span class="n">linear_model</span><span class="o">.</span><span class="n">LogisticRegression</span><span class="p">(</span><span class="o">**</span><span class="n">lr_best_params</span><span class="p">),</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;neg_log_loss&#39;</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="n">kfold</span><span class="p">)</span>
<a id="__codelineno-64-3" name="__codelineno-64-3" href="#__codelineno-64-3"></a><span class="n">cv_scores</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<a id="__codelineno-64-4" name="__codelineno-64-4" href="#__codelineno-64-4"></a>    <span class="o">-</span><span class="mf">0.528741673153639</span>
</code></pre></div>
<p>In the next iteration of this tutorial we will also optimise an XGB model and hopefully outperform our logistic regression model.</p>
<hr />
<h2 id="creating-predictions-for-the-2018-season">Creating Predictions for the 2018 Season</h2>
<p>Now that we have an optimised logistic regression model, let's see how it performs on predicting the 2018 season.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-65-1" name="__codelineno-65-1" href="#__codelineno-65-1"></a><span class="n">lr</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="o">**</span><span class="n">lr_best_params</span><span class="p">)</span>
<a id="__codelineno-65-2" name="__codelineno-65-2" href="#__codelineno-65-2"></a><span class="n">lr</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<a id="__codelineno-65-3" name="__codelineno-65-3" href="#__codelineno-65-3"></a><span class="n">final_predictions</span> <span class="o">=</span> <span class="n">lr</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_x</span><span class="p">)</span>
<a id="__codelineno-65-4" name="__codelineno-65-4" href="#__codelineno-65-4"></a>
<a id="__codelineno-65-5" name="__codelineno-65-5" href="#__codelineno-65-5"></a><span class="n">accuracy</span> <span class="o">=</span> <span class="p">(</span><span class="n">final_predictions</span> <span class="o">==</span> <span class="n">test_y</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">100</span>
<a id="__codelineno-65-6" name="__codelineno-65-6" href="#__codelineno-65-6"></a>
<a id="__codelineno-65-7" name="__codelineno-65-7" href="#__codelineno-65-7"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Our accuracy in predicting the 2018 season is: </span><span class="si">{:.2f}</span><span class="s2">%&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">accuracy</span><span class="p">))</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>Our accuracy in predicting the 2018 season is: 67.68%
</code></pre></div>
<p>Now let's have a look at all the games which we incorrectly predicted.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-66-1" name="__codelineno-66-1" href="#__codelineno-66-1"></a><span class="n">game_ids</span> <span class="o">=</span> <span class="n">test_x</span><span class="p">[(</span><span class="n">final_predictions</span> <span class="o">!=</span> <span class="n">test_y</span><span class="p">)]</span><span class="o">.</span><span class="n">game</span>
<a id="__codelineno-66-2" name="__codelineno-66-2" href="#__codelineno-66-2"></a><span class="n">afl_data_one_line</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">afl_data_one_line</span><span class="o">.</span><span class="n">game</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">game_ids</span><span class="p">),</span> <span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;home_team&#39;</span><span class="p">,</span> <span class="s1">&#39;opponent&#39;</span><span class="p">,</span> <span class="s1">&#39;f_odds&#39;</span><span class="p">,</span> <span class="s1">&#39;f_odds_away&#39;</span><span class="p">,</span> <span class="s1">&#39;f_margin&#39;</span><span class="p">]]</span>
</code></pre></div>
<table>
<thead>
<tr>
<th></th>
<th>date</th>
<th>home_team</th>
<th>opponent</th>
<th>f_odds</th>
<th>f_odds_away</th>
<th>f_margin</th>
</tr>
</thead>
<tbody>
<tr>
<td>1386</td>
<td>2018-03-24</td>
<td>Gold Coast</td>
<td>North Melbourne</td>
<td>2.0161</td>
<td>1.9784</td>
<td>16</td>
</tr>
<tr>
<td>1388</td>
<td>2018-03-25</td>
<td>Melbourne</td>
<td>Geelong</td>
<td>1.7737</td>
<td>2.2755</td>
<td>-3</td>
</tr>
<tr>
<td>1391</td>
<td>2018-03-30</td>
<td>North Melbourne</td>
<td>St Kilda</td>
<td>3.5769</td>
<td>1.3867</td>
<td>52</td>
</tr>
<tr>
<td>1392</td>
<td>2018-03-31</td>
<td>Carlton</td>
<td>Gold Coast</td>
<td>1.5992</td>
<td>2.6620</td>
<td>-34</td>
</tr>
<tr>
<td>1396</td>
<td>2018-04-01</td>
<td>Western Bulldogs</td>
<td>West Coast</td>
<td>1.8044</td>
<td>2.2445</td>
<td>-51</td>
</tr>
<tr>
<td>1397</td>
<td>2018-04-01</td>
<td>Sydney</td>
<td>Port Adelaide</td>
<td>1.4949</td>
<td>3.0060</td>
<td>-23</td>
</tr>
<tr>
<td>1398</td>
<td>2018-04-02</td>
<td>Geelong</td>
<td>Hawthorn</td>
<td>1.7597</td>
<td>2.3024</td>
<td>-1</td>
</tr>
<tr>
<td>1406</td>
<td>2018-04-08</td>
<td>Western Bulldogs</td>
<td>Essendon</td>
<td>3.8560</td>
<td>1.3538</td>
<td>21</td>
</tr>
<tr>
<td>1408</td>
<td>2018-04-13</td>
<td>Adelaide</td>
<td>Collingwood</td>
<td>1.2048</td>
<td>5.9197</td>
<td>-48</td>
</tr>
<tr>
<td>1412</td>
<td>2018-04-14</td>
<td>North Melbourne</td>
<td>Carlton</td>
<td>1.5799</td>
<td>2.7228</td>
<td>86</td>
</tr>
<tr>
<td>1415</td>
<td>2018-04-15</td>
<td>Hawthorn</td>
<td>Melbourne</td>
<td>2.2855</td>
<td>1.7772</td>
<td>67</td>
</tr>
<tr>
<td>1417</td>
<td>2018-04-20</td>
<td>Sydney</td>
<td>Adelaide</td>
<td>1.2640</td>
<td>4.6929</td>
<td>-10</td>
</tr>
<tr>
<td>1420</td>
<td>2018-04-21</td>
<td>Port Adelaide</td>
<td>Geelong</td>
<td>1.5053</td>
<td>2.9515</td>
<td>-34</td>
</tr>
<tr>
<td>1422</td>
<td>2018-04-22</td>
<td>North Melbourne</td>
<td>Hawthorn</td>
<td>2.6170</td>
<td>1.6132</td>
<td>28</td>
</tr>
<tr>
<td>1423</td>
<td>2018-04-22</td>
<td>Brisbane</td>
<td>Gold Coast</td>
<td>1.7464</td>
<td>2.3277</td>
<td>-5</td>
</tr>
<tr>
<td>1425</td>
<td>2018-04-25</td>
<td>Collingwood</td>
<td>Essendon</td>
<td>1.8372</td>
<td>2.1754</td>
<td>49</td>
</tr>
<tr>
<td>1427</td>
<td>2018-04-28</td>
<td>Geelong</td>
<td>Sydney</td>
<td>1.5019</td>
<td>2.9833</td>
<td>-17</td>
</tr>
<tr>
<td>1434</td>
<td>2018-04-29</td>
<td>Fremantle</td>
<td>West Coast</td>
<td>2.4926</td>
<td>1.6531</td>
<td>-8</td>
</tr>
<tr>
<td>1437</td>
<td>2018-05-05</td>
<td>Essendon</td>
<td>Hawthorn</td>
<td>2.8430</td>
<td>1.5393</td>
<td>-23</td>
</tr>
<tr>
<td>1439</td>
<td>2018-05-05</td>
<td>Sydney</td>
<td>North Melbourne</td>
<td>1.2777</td>
<td>4.5690</td>
<td>-2</td>
</tr>
<tr>
<td>1444</td>
<td>2018-05-11</td>
<td>Hawthorn</td>
<td>Sydney</td>
<td>1.6283</td>
<td>2.5818</td>
<td>-8</td>
</tr>
<tr>
<td>1445</td>
<td>2018-05-12</td>
<td>GWS</td>
<td>West Coast</td>
<td>1.5425</td>
<td>2.8292</td>
<td>-25</td>
</tr>
<tr>
<td>1446</td>
<td>2018-05-12</td>
<td>Carlton</td>
<td>Essendon</td>
<td>3.1742</td>
<td>1.4570</td>
<td>13</td>
</tr>
<tr>
<td>1452</td>
<td>2018-05-13</td>
<td>Collingwood</td>
<td>Geelong</td>
<td>2.4127</td>
<td>1.7040</td>
<td>-21</td>
</tr>
<tr>
<td>1455</td>
<td>2018-05-19</td>
<td>North Melbourne</td>
<td>GWS</td>
<td>1.5049</td>
<td>2.9752</td>
<td>43</td>
</tr>
<tr>
<td>1456</td>
<td>2018-05-19</td>
<td>Essendon</td>
<td>Geelong</td>
<td>5.6530</td>
<td>1.2104</td>
<td>34</td>
</tr>
<tr>
<td>1460</td>
<td>2018-05-20</td>
<td>Brisbane</td>
<td>Hawthorn</td>
<td>3.2891</td>
<td>1.4318</td>
<td>56</td>
</tr>
<tr>
<td>1461</td>
<td>2018-05-20</td>
<td>West Coast</td>
<td>Richmond</td>
<td>1.9755</td>
<td>2.0154</td>
<td>47</td>
</tr>
<tr>
<td>1466</td>
<td>2018-05-26</td>
<td>GWS</td>
<td>Essendon</td>
<td>1.4364</td>
<td>3.2652</td>
<td>-35</td>
</tr>
<tr>
<td>1467</td>
<td>2018-05-27</td>
<td>Hawthorn</td>
<td>West Coast</td>
<td>2.2123</td>
<td>1.8133</td>
<td>-15</td>
</tr>
<tr>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr>
<td>1483</td>
<td>2018-06-10</td>
<td>Brisbane</td>
<td>Essendon</td>
<td>2.3018</td>
<td>1.7543</td>
<td>-22</td>
</tr>
<tr>
<td>1485</td>
<td>2018-06-11</td>
<td>Melbourne</td>
<td>Collingwood</td>
<td>1.6034</td>
<td>2.6450</td>
<td>-42</td>
</tr>
<tr>
<td>1492</td>
<td>2018-06-21</td>
<td>West Coast</td>
<td>Essendon</td>
<td>1.3694</td>
<td>3.6843</td>
<td>-28</td>
</tr>
<tr>
<td>1493</td>
<td>2018-06-22</td>
<td>Port Adelaide</td>
<td>Melbourne</td>
<td>1.7391</td>
<td>2.3426</td>
<td>10</td>
</tr>
<tr>
<td>1499</td>
<td>2018-06-29</td>
<td>Western Bulldogs</td>
<td>Geelong</td>
<td>6.2067</td>
<td>1.1889</td>
<td>2</td>
</tr>
<tr>
<td>1501</td>
<td>2018-06-30</td>
<td>Adelaide</td>
<td>West Coast</td>
<td>1.4989</td>
<td>2.9756</td>
<td>10</td>
</tr>
<tr>
<td>1504</td>
<td>2018-07-01</td>
<td>Melbourne</td>
<td>St Kilda</td>
<td>1.1405</td>
<td>7.7934</td>
<td>-2</td>
</tr>
<tr>
<td>1505</td>
<td>2018-07-01</td>
<td>Essendon</td>
<td>North Melbourne</td>
<td>2.0993</td>
<td>1.9022</td>
<td>17</td>
</tr>
<tr>
<td>1506</td>
<td>2018-07-01</td>
<td>Fremantle</td>
<td>Brisbane</td>
<td>1.2914</td>
<td>4.3743</td>
<td>-55</td>
</tr>
<tr>
<td>1507</td>
<td>2018-07-05</td>
<td>Sydney</td>
<td>Geelong</td>
<td>1.7807</td>
<td>2.2675</td>
<td>-12</td>
</tr>
<tr>
<td>1514</td>
<td>2018-07-08</td>
<td>Essendon</td>
<td>Collingwood</td>
<td>2.5442</td>
<td>1.6473</td>
<td>-16</td>
</tr>
<tr>
<td>1515</td>
<td>2018-07-08</td>
<td>West Coast</td>
<td>GWS</td>
<td>1.6790</td>
<td>2.4754</td>
<td>11</td>
</tr>
<tr>
<td>1516</td>
<td>2018-07-12</td>
<td>Adelaide</td>
<td>Geelong</td>
<td>2.0517</td>
<td>1.9444</td>
<td>15</td>
</tr>
<tr>
<td>1518</td>
<td>2018-07-14</td>
<td>Hawthorn</td>
<td>Brisbane</td>
<td>1.2281</td>
<td>5.4105</td>
<td>-33</td>
</tr>
<tr>
<td>1521</td>
<td>2018-07-14</td>
<td>GWS</td>
<td>Richmond</td>
<td>2.7257</td>
<td>1.5765</td>
<td>2</td>
</tr>
<tr>
<td>1522</td>
<td>2018-07-15</td>
<td>Collingwood</td>
<td>West Coast</td>
<td>1.5600</td>
<td>2.7815</td>
<td>-35</td>
</tr>
<tr>
<td>1523</td>
<td>2018-07-15</td>
<td>North Melbourne</td>
<td>Sydney</td>
<td>1.9263</td>
<td>2.0647</td>
<td>-6</td>
</tr>
<tr>
<td>1524</td>
<td>2018-07-15</td>
<td>Fremantle</td>
<td>Port Adelaide</td>
<td>5.9110</td>
<td>1.2047</td>
<td>9</td>
</tr>
<tr>
<td>1527</td>
<td>2018-07-21</td>
<td>Sydney</td>
<td>Gold Coast</td>
<td>1.0342</td>
<td>27.8520</td>
<td>-24</td>
</tr>
<tr>
<td>1529</td>
<td>2018-07-21</td>
<td>Brisbane</td>
<td>Adelaide</td>
<td>2.4614</td>
<td>1.6730</td>
<td>-5</td>
</tr>
<tr>
<td>1533</td>
<td>2018-07-22</td>
<td>Port Adelaide</td>
<td>GWS</td>
<td>1.6480</td>
<td>2.5452</td>
<td>-22</td>
</tr>
<tr>
<td>1538</td>
<td>2018-07-28</td>
<td>Gold Coast</td>
<td>Carlton</td>
<td>1.3933</td>
<td>3.5296</td>
<td>-35</td>
</tr>
<tr>
<td>1546</td>
<td>2018-08-04</td>
<td>Adelaide</td>
<td>Port Adelaide</td>
<td>2.0950</td>
<td>1.9135</td>
<td>3</td>
</tr>
<tr>
<td>1548</td>
<td>2018-08-04</td>
<td>St Kilda</td>
<td>Western Bulldogs</td>
<td>1.6120</td>
<td>2.6368</td>
<td>-35</td>
</tr>
<tr>
<td>1555</td>
<td>2018-08-11</td>
<td>Port Adelaide</td>
<td>West Coast</td>
<td>1.4187</td>
<td>3.3505</td>
<td>-4</td>
</tr>
<tr>
<td>1558</td>
<td>2018-08-12</td>
<td>North Melbourne</td>
<td>Western Bulldogs</td>
<td>1.3175</td>
<td>4.1239</td>
<td>-7</td>
</tr>
<tr>
<td>1559</td>
<td>2018-08-12</td>
<td>Melbourne</td>
<td>Sydney</td>
<td>1.3627</td>
<td>3.7445</td>
<td>-9</td>
</tr>
<tr>
<td>1564</td>
<td>2018-08-18</td>
<td>GWS</td>
<td>Sydney</td>
<td>1.8478</td>
<td>2.1672</td>
<td>-20</td>
</tr>
<tr>
<td>1576</td>
<td>2018-08-26</td>
<td>Brisbane</td>
<td>West Coast</td>
<td>2.3068</td>
<td>1.7548</td>
<td>-26</td>
</tr>
<tr>
<td>1578</td>
<td>2018-08-26</td>
<td>St Kilda</td>
<td>North Melbourne</td>
<td>3.5178</td>
<td>1.3936</td>
<td>-23</td>
</tr>
</tbody>
</table>
<p>Very interesting! Most of the games we got wrong were upsets. Let's have a look at the games we incorrectly predicted that weren't upsets.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-67-1" name="__codelineno-67-1" href="#__codelineno-67-1"></a><span class="p">(</span><span class="n">afl_data_one_line</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">afl_data_one_line</span><span class="o">.</span><span class="n">game</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">game_ids</span><span class="p">),</span> <span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;home_team&#39;</span><span class="p">,</span> <span class="s1">&#39;opponent&#39;</span><span class="p">,</span> <span class="s1">&#39;f_odds&#39;</span><span class="p">,</span> <span class="s1">&#39;f_odds_away&#39;</span><span class="p">,</span> <span class="s1">&#39;f_margin&#39;</span><span class="p">]]</span>
<a id="__codelineno-67-2" name="__codelineno-67-2" href="#__codelineno-67-2"></a>    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">home_favourite</span><span class="o">=</span><span class="k">lambda</span> <span class="n">df</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">f_odds</span> <span class="o">&lt;</span> <span class="n">row</span><span class="o">.</span><span class="n">f_odds_away</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<a id="__codelineno-67-3" name="__codelineno-67-3" href="#__codelineno-67-3"></a>    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">upset</span><span class="o">=</span><span class="k">lambda</span> <span class="n">df</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">home_favourite</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">row</span><span class="o">.</span><span class="n">f_margin</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">else</span> 
<a id="__codelineno-67-4" name="__codelineno-67-4" href="#__codelineno-67-4"></a>                                      <span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">home_favourite</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">row</span><span class="o">.</span><span class="n">f_margin</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<a id="__codelineno-67-5" name="__codelineno-67-5" href="#__codelineno-67-5"></a>    <span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;upset == 0&#39;</span><span class="p">))</span>
</code></pre></div>
<table>
<thead>
<tr>
<th></th>
<th>date</th>
<th>home_team</th>
<th>opponent</th>
<th>f_odds</th>
<th>f_odds_away</th>
<th>f_margin</th>
<th>home_favourite</th>
<th>upset</th>
</tr>
</thead>
<tbody>
<tr>
<td>1412</td>
<td>2018-04-14</td>
<td>North Melbourne</td>
<td>Carlton</td>
<td>1.5799</td>
<td>2.7228</td>
<td>86</td>
<td>1</td>
<td>0</td>
</tr>
<tr>
<td>1425</td>
<td>2018-04-25</td>
<td>Collingwood</td>
<td>Essendon</td>
<td>1.8372</td>
<td>2.1754</td>
<td>49</td>
<td>1</td>
<td>0</td>
</tr>
<tr>
<td>1434</td>
<td>2018-04-29</td>
<td>Fremantle</td>
<td>West Coast</td>
<td>2.4926</td>
<td>1.6531</td>
<td>-8</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>1437</td>
<td>2018-05-05</td>
<td>Essendon</td>
<td>Hawthorn</td>
<td>2.8430</td>
<td>1.5393</td>
<td>-23</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>1452</td>
<td>2018-05-13</td>
<td>Collingwood</td>
<td>Geelong</td>
<td>2.4127</td>
<td>1.7040</td>
<td>-21</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>1455</td>
<td>2018-05-19</td>
<td>North Melbourne</td>
<td>GWS</td>
<td>1.5049</td>
<td>2.9752</td>
<td>43</td>
<td>1</td>
<td>0</td>
</tr>
<tr>
<td>1461</td>
<td>2018-05-20</td>
<td>West Coast</td>
<td>Richmond</td>
<td>1.9755</td>
<td>2.0154</td>
<td>47</td>
<td>1</td>
<td>0</td>
</tr>
<tr>
<td>1467</td>
<td>2018-05-27</td>
<td>Hawthorn</td>
<td>West Coast</td>
<td>2.2123</td>
<td>1.8133</td>
<td>-15</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>1479</td>
<td>2018-06-08</td>
<td>Port Adelaide</td>
<td>Richmond</td>
<td>1.7422</td>
<td>2.3420</td>
<td>14</td>
<td>1</td>
<td>0</td>
</tr>
<tr>
<td>1483</td>
<td>2018-06-10</td>
<td>Brisbane</td>
<td>Essendon</td>
<td>2.3018</td>
<td>1.7543</td>
<td>-22</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>1493</td>
<td>2018-06-22</td>
<td>Port Adelaide</td>
<td>Melbourne</td>
<td>1.7391</td>
<td>2.3426</td>
<td>10</td>
<td>1</td>
<td>0</td>
</tr>
<tr>
<td>1501</td>
<td>2018-06-30</td>
<td>Adelaide</td>
<td>West Coast</td>
<td>1.4989</td>
<td>2.9756</td>
<td>10</td>
<td>1</td>
<td>0</td>
</tr>
<tr>
<td>1514</td>
<td>2018-07-08</td>
<td>Essendon</td>
<td>Collingwood</td>
<td>2.5442</td>
<td>1.6473</td>
<td>-16</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>1515</td>
<td>2018-07-08</td>
<td>West Coast</td>
<td>GWS</td>
<td>1.6790</td>
<td>2.4754</td>
<td>11</td>
<td>1</td>
<td>0</td>
</tr>
<tr>
<td>1529</td>
<td>2018-07-21</td>
<td>Brisbane</td>
<td>Adelaide</td>
<td>2.4614</td>
<td>1.6730</td>
<td>-5</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>1576</td>
<td>2018-08-26</td>
<td>Brisbane</td>
<td>West Coast</td>
<td>2.3068</td>
<td>1.7548</td>
<td>-26</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>1578</td>
<td>2018-08-26</td>
<td>St Kilda</td>
<td>North Melbourne</td>
<td>3.5178</td>
<td>1.3936</td>
<td>-23</td>
<td>0</td>
<td>0</td>
</tr>
</tbody>
</table>
<p>Let's now look at our model's log loss for the 2018 season compared to the odds.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-68-1" name="__codelineno-68-1" href="#__codelineno-68-1"></a><span class="n">predictions_probs</span> <span class="o">=</span> <span class="n">lr</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">test_x</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-69-1" name="__codelineno-69-1" href="#__codelineno-69-1"></a><span class="n">metrics</span><span class="o">.</span><span class="n">log_loss</span><span class="p">(</span><span class="n">test_y</span><span class="p">,</span> <span class="n">predictions_probs</span><span class="p">)</span>
<a id="__codelineno-69-2" name="__codelineno-69-2" href="#__codelineno-69-2"></a>    <span class="mf">0.584824211055384</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-70-1" name="__codelineno-70-1" href="#__codelineno-70-1"></a><span class="n">test_x_unscaled</span> <span class="o">=</span> <span class="n">feature_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">feature_df</span><span class="o">.</span><span class="n">season</span> <span class="o">==</span> <span class="mi">2018</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;game&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">feature_columns</span><span class="p">]</span>
<a id="__codelineno-70-2" name="__codelineno-70-2" href="#__codelineno-70-2"></a>
<a id="__codelineno-70-3" name="__codelineno-70-3" href="#__codelineno-70-3"></a><span class="n">metrics</span><span class="o">.</span><span class="n">log_loss</span><span class="p">(</span><span class="n">test_y</span><span class="p">,</span> <span class="n">test_x_unscaled</span><span class="p">[[</span><span class="s1">&#39;f_current_odds_prob_away&#39;</span><span class="p">,</span> <span class="s1">&#39;f_current_odds_prob&#39;</span><span class="p">]])</span>
<a id="__codelineno-70-4" name="__codelineno-70-4" href="#__codelineno-70-4"></a>    <span class="mf">0.5545776633924343</span>
</code></pre></div>
<p>So whilst our model performs decently, it doesn't beat the odds in terms of log loss. That's okay, it's still a decent start. In future iterations we can implement other algorithms and create new features which may improve performance.</p>
<hr />
<h2 id="next-steps">Next Steps</h2>
<p>Now that we have a model up and running, the next steps are to implement the model on a week to week basis.</p>
<hr />
<h1 id="04-weekly-predictions">04. Weekly Predictions</h1>
<p>Now that we have explored different algorithms for modelling, we can implement our chosen model and predict this week's AFL games! All you need to do is run the afl_modelling script each Thursday or Friday to predict the following week's games.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-71-1" name="__codelineno-71-1" href="#__codelineno-71-1"></a><span class="c1"># Import Modules</span>
<a id="__codelineno-71-2" name="__codelineno-71-2" href="#__codelineno-71-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">afl_feature_creation_v2</span><span class="w"> </span><span class="kn">import</span> <span class="n">prepare_afl_features</span>
<a id="__codelineno-71-3" name="__codelineno-71-3" href="#__codelineno-71-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">afl_data_cleaning_v2</span>
<a id="__codelineno-71-4" name="__codelineno-71-4" href="#__codelineno-71-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">afl_feature_creation_v2</span>
<a id="__codelineno-71-5" name="__codelineno-71-5" href="#__codelineno-71-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">afl_modelling_v2</span>
<a id="__codelineno-71-6" name="__codelineno-71-6" href="#__codelineno-71-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span>
<a id="__codelineno-71-7" name="__codelineno-71-7" href="#__codelineno-71-7"></a><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<a id="__codelineno-71-8" name="__codelineno-71-8" href="#__codelineno-71-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<a id="__codelineno-71-9" name="__codelineno-71-9" href="#__codelineno-71-9"></a><span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.max_columns&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-71-10" name="__codelineno-71-10" href="#__codelineno-71-10"></a><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.linear_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">LogisticRegression</span>
<a id="__codelineno-71-11" name="__codelineno-71-11" href="#__codelineno-71-11"></a><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">StandardScaler</span>
<a id="__codelineno-71-12" name="__codelineno-71-12" href="#__codelineno-71-12"></a><span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<a id="__codelineno-71-13" name="__codelineno-71-13" href="#__codelineno-71-13"></a><span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
</code></pre></div>
<hr />
<h2 id="creating-the-features-for-this-weekends-games">Creating The Features For This Weekend's Games</h2>
<p>To actually predict this weekend's games, we need to create the same features that we have created in the previous tutorials for the games that will be played this weekend. This includes all the rolling averages, efficiency features, elo features etc. So the majority of this tutorial will be using previously defined functions to create features for the following weekend's games.</p>
<h3 id="create-next-weeks-dataframe">Create Next Week's DataFrame</h3>
<p>Let's first get our cleaned afl_data dataset, as well as the odds for next weekend and the 2018 fixture.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-72-1" name="__codelineno-72-1" href="#__codelineno-72-1"></a><span class="c1"># Grab the cleaned AFL dataset and the column order</span>
<a id="__codelineno-72-2" name="__codelineno-72-2" href="#__codelineno-72-2"></a><span class="n">afl_data</span> <span class="o">=</span> <span class="n">afl_data_cleaning_v2</span><span class="o">.</span><span class="n">prepare_afl_data</span><span class="p">()</span>
<a id="__codelineno-72-3" name="__codelineno-72-3" href="#__codelineno-72-3"></a><span class="n">ordered_cols</span> <span class="o">=</span> <span class="n">afl_data</span><span class="o">.</span><span class="n">columns</span>
<a id="__codelineno-72-4" name="__codelineno-72-4" href="#__codelineno-72-4"></a>
<a id="__codelineno-72-5" name="__codelineno-72-5" href="#__codelineno-72-5"></a><span class="c1"># Define a function which grabs the odds for each game for the following weekend</span>
<a id="__codelineno-72-6" name="__codelineno-72-6" href="#__codelineno-72-6"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_next_week_odds</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
<a id="__codelineno-72-7" name="__codelineno-72-7" href="#__codelineno-72-7"></a>    <span class="c1"># Get next week&#39;s odds</span>
<a id="__codelineno-72-8" name="__codelineno-72-8" href="#__codelineno-72-8"></a>    <span class="n">next_week_odds</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
<a id="__codelineno-72-9" name="__codelineno-72-9" href="#__codelineno-72-9"></a>    <span class="n">next_week_odds</span> <span class="o">=</span> <span class="n">next_week_odds</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;team_1&quot;</span><span class="p">:</span> <span class="s2">&quot;home_team&quot;</span><span class="p">,</span> 
<a id="__codelineno-72-10" name="__codelineno-72-10" href="#__codelineno-72-10"></a>                                                <span class="s2">&quot;team_2&quot;</span><span class="p">:</span> <span class="s2">&quot;away_team&quot;</span><span class="p">,</span> 
<a id="__codelineno-72-11" name="__codelineno-72-11" href="#__codelineno-72-11"></a>                                                <span class="s2">&quot;team_1_odds&quot;</span><span class="p">:</span> <span class="s2">&quot;odds&quot;</span><span class="p">,</span> 
<a id="__codelineno-72-12" name="__codelineno-72-12" href="#__codelineno-72-12"></a>                                                <span class="s2">&quot;team_2_odds&quot;</span><span class="p">:</span> <span class="s2">&quot;odds_away&quot;</span>
<a id="__codelineno-72-13" name="__codelineno-72-13" href="#__codelineno-72-13"></a>                                               <span class="p">})</span>
<a id="__codelineno-72-14" name="__codelineno-72-14" href="#__codelineno-72-14"></a>    <span class="k">return</span> <span class="n">next_week_odds</span>
<a id="__codelineno-72-15" name="__codelineno-72-15" href="#__codelineno-72-15"></a>
<a id="__codelineno-72-16" name="__codelineno-72-16" href="#__codelineno-72-16"></a><span class="c1"># Import the fixture</span>
<a id="__codelineno-72-17" name="__codelineno-72-17" href="#__codelineno-72-17"></a><span class="c1"># Define a function which gets the fixture and cleans it up</span>
<a id="__codelineno-72-18" name="__codelineno-72-18" href="#__codelineno-72-18"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_fixture</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
<a id="__codelineno-72-19" name="__codelineno-72-19" href="#__codelineno-72-19"></a>    <span class="c1"># Get the afl fixture</span>
<a id="__codelineno-72-20" name="__codelineno-72-20" href="#__codelineno-72-20"></a>    <span class="n">fixture</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
<a id="__codelineno-72-21" name="__codelineno-72-21" href="#__codelineno-72-21"></a>
<a id="__codelineno-72-22" name="__codelineno-72-22" href="#__codelineno-72-22"></a>    <span class="c1"># Replace team names and reformat</span>
<a id="__codelineno-72-23" name="__codelineno-72-23" href="#__codelineno-72-23"></a>    <span class="n">fixture</span> <span class="o">=</span> <span class="n">fixture</span><span class="o">.</span><span class="n">replace</span><span class="p">({</span><span class="s1">&#39;Brisbane Lions&#39;</span><span class="p">:</span> <span class="s1">&#39;Brisbane&#39;</span><span class="p">,</span> <span class="s1">&#39;Footscray&#39;</span><span class="p">:</span> <span class="s1">&#39;Western Bulldogs&#39;</span><span class="p">})</span>
<a id="__codelineno-72-24" name="__codelineno-72-24" href="#__codelineno-72-24"></a>    <span class="n">fixture</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">fixture</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
<a id="__codelineno-72-25" name="__codelineno-72-25" href="#__codelineno-72-25"></a>    <span class="n">fixture</span> <span class="o">=</span> <span class="n">fixture</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Home.Team&quot;</span><span class="p">:</span> <span class="s2">&quot;home_team&quot;</span><span class="p">,</span> <span class="s2">&quot;Away.Team&quot;</span><span class="p">:</span> <span class="s2">&quot;away_team&quot;</span><span class="p">})</span>
<a id="__codelineno-72-26" name="__codelineno-72-26" href="#__codelineno-72-26"></a>    <span class="k">return</span> <span class="n">fixture</span>
<a id="__codelineno-72-27" name="__codelineno-72-27" href="#__codelineno-72-27"></a>
<a id="__codelineno-72-28" name="__codelineno-72-28" href="#__codelineno-72-28"></a><span class="n">next_week_odds</span> <span class="o">=</span> <span class="n">get_next_week_odds</span><span class="p">(</span><span class="s2">&quot;data/weekly_odds.csv&quot;</span><span class="p">)</span>
<a id="__codelineno-72-29" name="__codelineno-72-29" href="#__codelineno-72-29"></a><span class="n">fixture</span> <span class="o">=</span> <span class="n">get_fixture</span><span class="p">(</span><span class="s2">&quot;data/afl_fixture_2018.csv&quot;</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-73-1" name="__codelineno-73-1" href="#__codelineno-73-1"></a><span class="n">fixture</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span>
</code></pre></div>
<table>
<thead>
<tr>
<th></th>
<th>Date</th>
<th>Season</th>
<th>Season.Game</th>
<th>Round</th>
<th>home_team</th>
<th>away_team</th>
<th>Venue</th>
</tr>
</thead>
<tbody>
<tr>
<td>202</td>
<td>2018-09-14</td>
<td>2018</td>
<td>1</td>
<td>26</td>
<td>Hawthorn</td>
<td>Melbourne</td>
<td>MCG</td>
</tr>
<tr>
<td>203</td>
<td>2018-09-15</td>
<td>2018</td>
<td>1</td>
<td>26</td>
<td>Collingwood</td>
<td>GWS</td>
<td>MCG</td>
</tr>
<tr>
<td>204</td>
<td>2018-09-21</td>
<td>2018</td>
<td>1</td>
<td>27</td>
<td>Richmond</td>
<td>Collingwood</td>
<td>MCG</td>
</tr>
<tr>
<td>205</td>
<td>2018-09-22</td>
<td>2018</td>
<td>1</td>
<td>27</td>
<td>West Coast</td>
<td>Melbourne</td>
<td>Optus Stadium</td>
</tr>
<tr>
<td>206</td>
<td>2018-09-29</td>
<td>2018</td>
<td>1</td>
<td>28</td>
<td>West Coast</td>
<td>Collingwood</td>
<td>MCG</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre><span></span><code><a id="__codelineno-74-1" name="__codelineno-74-1" href="#__codelineno-74-1"></a><span class="n">next_week_odds</span>
</code></pre></div>
<table>
<thead>
<tr>
<th></th>
<th>home_team</th>
<th>away_team</th>
<th>odds</th>
<th>odds_away</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>West Coast</td>
<td>Collingwood</td>
<td>2.34</td>
<td>1.75</td>
</tr>
</tbody>
</table>
<p>Now that we have these DataFrames, we will define a function which combines the fixture and next week's odds to create a single DataFrame for the games over the next 7 days. To use this function we will need Game IDs for next week. So we will create another function which creates Game IDs by using the Game ID from the last game played and adding 1 to it.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-75-1" name="__codelineno-75-1" href="#__codelineno-75-1"></a><span class="c1"># Define a function which creates game IDs for this week&#39;s footy games</span>
<a id="__codelineno-75-2" name="__codelineno-75-2" href="#__codelineno-75-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">create_next_weeks_game_ids</span><span class="p">(</span><span class="n">afl_data</span><span class="p">):</span>
<a id="__codelineno-75-3" name="__codelineno-75-3" href="#__codelineno-75-3"></a>    <span class="n">odds</span> <span class="o">=</span> <span class="n">get_next_week_odds</span><span class="p">(</span><span class="s2">&quot;data/weekly_odds.csv&quot;</span><span class="p">)</span>
<a id="__codelineno-75-4" name="__codelineno-75-4" href="#__codelineno-75-4"></a>
<a id="__codelineno-75-5" name="__codelineno-75-5" href="#__codelineno-75-5"></a>    <span class="c1"># Get last week&#39;s Game ID</span>
<a id="__codelineno-75-6" name="__codelineno-75-6" href="#__codelineno-75-6"></a>    <span class="n">last_afl_data_game</span> <span class="o">=</span> <span class="n">afl_data</span><span class="p">[</span><span class="s1">&#39;game&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-75-7" name="__codelineno-75-7" href="#__codelineno-75-7"></a>
<a id="__codelineno-75-8" name="__codelineno-75-8" href="#__codelineno-75-8"></a>    <span class="c1"># Create Game IDs for next week</span>
<a id="__codelineno-75-9" name="__codelineno-75-9" href="#__codelineno-75-9"></a>    <span class="n">game_ids</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">last_afl_data_game</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">odds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
<a id="__codelineno-75-10" name="__codelineno-75-10" href="#__codelineno-75-10"></a>    <span class="k">return</span> <span class="n">game_ids</span>
<a id="__codelineno-75-11" name="__codelineno-75-11" href="#__codelineno-75-11"></a>
<a id="__codelineno-75-12" name="__codelineno-75-12" href="#__codelineno-75-12"></a><span class="c1"># Define a function which creates this week&#39;s footy game DataFrame</span>
<a id="__codelineno-75-13" name="__codelineno-75-13" href="#__codelineno-75-13"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_next_week_df</span><span class="p">(</span><span class="n">afl_data</span><span class="p">):</span>
<a id="__codelineno-75-14" name="__codelineno-75-14" href="#__codelineno-75-14"></a>    <span class="c1"># Get the fixture and the odds for next week&#39;s footy games</span>
<a id="__codelineno-75-15" name="__codelineno-75-15" href="#__codelineno-75-15"></a>    <span class="n">fixture</span> <span class="o">=</span> <span class="n">get_fixture</span><span class="p">(</span><span class="s2">&quot;data/afl_fixture_2018.csv&quot;</span><span class="p">)</span>
<a id="__codelineno-75-16" name="__codelineno-75-16" href="#__codelineno-75-16"></a>    <span class="n">next_week_odds</span> <span class="o">=</span> <span class="n">get_next_week_odds</span><span class="p">(</span><span class="s2">&quot;data/weekly_odds.csv&quot;</span><span class="p">)</span>
<a id="__codelineno-75-17" name="__codelineno-75-17" href="#__codelineno-75-17"></a>    <span class="n">next_week_odds</span><span class="p">[</span><span class="s1">&#39;game&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">create_next_weeks_game_ids</span><span class="p">(</span><span class="n">afl_data</span><span class="p">)</span>
<a id="__codelineno-75-18" name="__codelineno-75-18" href="#__codelineno-75-18"></a>
<a id="__codelineno-75-19" name="__codelineno-75-19" href="#__codelineno-75-19"></a>    <span class="c1"># Get today&#39;s date and next week&#39;s date and create a DataFrame for next week&#39;s games</span>
<a id="__codelineno-75-20" name="__codelineno-75-20" href="#__codelineno-75-20"></a><span class="c1">#     todays_date = datetime.datetime.today().strftime(&#39;%Y-%m-%d&#39;)</span>
<a id="__codelineno-75-21" name="__codelineno-75-21" href="#__codelineno-75-21"></a>
<a id="__codelineno-75-22" name="__codelineno-75-22" href="#__codelineno-75-22"></a><span class="c1">#     date_in_7_days = (datetime.datetime.today() + datetime.timedelta(days=7)).strftime(&#39;%Y-%m-%d&#39;)</span>
<a id="__codelineno-75-23" name="__codelineno-75-23" href="#__codelineno-75-23"></a>    <span class="n">todays_date</span> <span class="o">=</span> <span class="s1">&#39;2018-09-27&#39;</span>
<a id="__codelineno-75-24" name="__codelineno-75-24" href="#__codelineno-75-24"></a>    <span class="n">date_in_7_days</span> <span class="o">=</span> <span class="s1">&#39;2018-10-04&#39;</span>
<a id="__codelineno-75-25" name="__codelineno-75-25" href="#__codelineno-75-25"></a>    <span class="n">fixture</span> <span class="o">=</span> <span class="n">fixture</span><span class="p">[(</span><span class="n">fixture</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">todays_date</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">fixture</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">date_in_7_days</span><span class="p">)]</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Season.Game&#39;</span><span class="p">])</span>
<a id="__codelineno-75-26" name="__codelineno-75-26" href="#__codelineno-75-26"></a>    <span class="n">next_week_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">fixture</span><span class="p">,</span> <span class="n">next_week_odds</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;home_team&#39;</span><span class="p">,</span> <span class="s1">&#39;away_team&#39;</span><span class="p">])</span>
<a id="__codelineno-75-27" name="__codelineno-75-27" href="#__codelineno-75-27"></a>
<a id="__codelineno-75-28" name="__codelineno-75-28" href="#__codelineno-75-28"></a>    <span class="c1"># Split the DataFrame onto two rows for each game</span>
<a id="__codelineno-75-29" name="__codelineno-75-29" href="#__codelineno-75-29"></a>    <span class="n">h_df</span> <span class="o">=</span> <span class="p">(</span><span class="n">next_week_df</span><span class="p">[[</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span> <span class="s1">&#39;game&#39;</span><span class="p">,</span> <span class="s1">&#39;home_team&#39;</span><span class="p">,</span> <span class="s1">&#39;away_team&#39;</span><span class="p">,</span> <span class="s1">&#39;odds&#39;</span><span class="p">,</span> <span class="s1">&#39;Season&#39;</span><span class="p">,</span> <span class="s1">&#39;Round&#39;</span><span class="p">,</span> <span class="s1">&#39;Venue&#39;</span><span class="p">]]</span>
<a id="__codelineno-75-30" name="__codelineno-75-30" href="#__codelineno-75-30"></a>               <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;home_team&#39;</span><span class="p">:</span> <span class="s1">&#39;team&#39;</span><span class="p">,</span> <span class="s1">&#39;away_team&#39;</span><span class="p">:</span> <span class="s1">&#39;opponent&#39;</span><span class="p">})</span>
<a id="__codelineno-75-31" name="__codelineno-75-31" href="#__codelineno-75-31"></a>               <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">home_game</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<a id="__codelineno-75-32" name="__codelineno-75-32" href="#__codelineno-75-32"></a>
<a id="__codelineno-75-33" name="__codelineno-75-33" href="#__codelineno-75-33"></a>    <span class="n">a_df</span> <span class="o">=</span> <span class="p">(</span><span class="n">next_week_df</span><span class="p">[[</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span> <span class="s1">&#39;game&#39;</span><span class="p">,</span> <span class="s1">&#39;home_team&#39;</span><span class="p">,</span> <span class="s1">&#39;away_team&#39;</span><span class="p">,</span> <span class="s1">&#39;odds_away&#39;</span><span class="p">,</span> <span class="s1">&#39;Season&#39;</span><span class="p">,</span> <span class="s1">&#39;Round&#39;</span><span class="p">,</span> <span class="s1">&#39;Venue&#39;</span><span class="p">]]</span>
<a id="__codelineno-75-34" name="__codelineno-75-34" href="#__codelineno-75-34"></a>                <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;odds_away&#39;</span><span class="p">:</span> <span class="s1">&#39;odds&#39;</span><span class="p">,</span> <span class="s1">&#39;home_team&#39;</span><span class="p">:</span> <span class="s1">&#39;opponent&#39;</span><span class="p">,</span> <span class="s1">&#39;away_team&#39;</span><span class="p">:</span> <span class="s1">&#39;team&#39;</span><span class="p">})</span>
<a id="__codelineno-75-35" name="__codelineno-75-35" href="#__codelineno-75-35"></a>                <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">home_game</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
<a id="__codelineno-75-36" name="__codelineno-75-36" href="#__codelineno-75-36"></a>
<a id="__codelineno-75-37" name="__codelineno-75-37" href="#__codelineno-75-37"></a>    <span class="n">next_week</span> <span class="o">=</span> <span class="n">a_df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">h_df</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;game&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-75-38" name="__codelineno-75-38" href="#__codelineno-75-38"></a>        <span class="s1">&#39;Date&#39;</span><span class="p">:</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span>
<a id="__codelineno-75-39" name="__codelineno-75-39" href="#__codelineno-75-39"></a>        <span class="s1">&#39;Season&#39;</span><span class="p">:</span> <span class="s1">&#39;season&#39;</span><span class="p">,</span>
<a id="__codelineno-75-40" name="__codelineno-75-40" href="#__codelineno-75-40"></a>        <span class="s1">&#39;Round&#39;</span><span class="p">:</span> <span class="s1">&#39;round&#39;</span><span class="p">,</span>
<a id="__codelineno-75-41" name="__codelineno-75-41" href="#__codelineno-75-41"></a>        <span class="s1">&#39;Venue&#39;</span><span class="p">:</span> <span class="s1">&#39;venue&#39;</span>
<a id="__codelineno-75-42" name="__codelineno-75-42" href="#__codelineno-75-42"></a>    <span class="p">})</span>
<a id="__codelineno-75-43" name="__codelineno-75-43" href="#__codelineno-75-43"></a>    <span class="n">next_week</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">next_week</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>
<a id="__codelineno-75-44" name="__codelineno-75-44" href="#__codelineno-75-44"></a>    <span class="n">next_week</span><span class="p">[</span><span class="s1">&#39;round&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">afl_data</span><span class="p">[</span><span class="s1">&#39;round&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
<a id="__codelineno-75-45" name="__codelineno-75-45" href="#__codelineno-75-45"></a>    <span class="k">return</span> <span class="n">next_week</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-76-1" name="__codelineno-76-1" href="#__codelineno-76-1"></a><span class="n">next_week_df</span> <span class="o">=</span> <span class="n">get_next_week_df</span><span class="p">(</span><span class="n">afl_data</span><span class="p">)</span>
<a id="__codelineno-76-2" name="__codelineno-76-2" href="#__codelineno-76-2"></a><span class="n">game_ids_next_round</span> <span class="o">=</span> <span class="n">create_next_weeks_game_ids</span><span class="p">(</span><span class="n">afl_data</span><span class="p">)</span>
<a id="__codelineno-76-3" name="__codelineno-76-3" href="#__codelineno-76-3"></a><span class="n">next_week_df</span>
</code></pre></div>
<table>
<thead>
<tr>
<th></th>
<th>date</th>
<th>round</th>
<th>season</th>
<th>venue</th>
<th>game</th>
<th>home_game</th>
<th>odds</th>
<th>opponent</th>
<th>team</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>2018-09-29</td>
<td>27</td>
<td>2018</td>
<td>MCG</td>
<td>15407</td>
<td>0</td>
<td>1.75</td>
<td>West Coast</td>
<td>Collingwood</td>
</tr>
<tr>
<td>0</td>
<td>2018-09-29</td>
<td>27</td>
<td>2018</td>
<td>MCG</td>
<td>15407</td>
<td>1</td>
<td>2.34</td>
<td>Collingwood</td>
<td>West Coast</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre><span></span><code><a id="__codelineno-77-1" name="__codelineno-77-1" href="#__codelineno-77-1"></a><span class="n">fixture</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span>
</code></pre></div>
<table>
<thead>
<tr>
<th></th>
<th>Date</th>
<th>Season</th>
<th>Season.Game</th>
<th>Round</th>
<th>home_team</th>
<th>away_team</th>
<th>Venue</th>
</tr>
</thead>
<tbody>
<tr>
<td>202</td>
<td>2018-09-14</td>
<td>2018</td>
<td>1</td>
<td>26</td>
<td>Hawthorn</td>
<td>Melbourne</td>
<td>MCG</td>
</tr>
<tr>
<td>203</td>
<td>2018-09-15</td>
<td>2018</td>
<td>1</td>
<td>26</td>
<td>Collingwood</td>
<td>GWS</td>
<td>MCG</td>
</tr>
<tr>
<td>204</td>
<td>2018-09-21</td>
<td>2018</td>
<td>1</td>
<td>27</td>
<td>Richmond</td>
<td>Collingwood</td>
<td>MCG</td>
</tr>
<tr>
<td>205</td>
<td>2018-09-22</td>
<td>2018</td>
<td>1</td>
<td>27</td>
<td>West Coast</td>
<td>Melbourne</td>
<td>Optus Stadium</td>
</tr>
<tr>
<td>206</td>
<td>2018-09-29</td>
<td>2018</td>
<td>1</td>
<td>28</td>
<td>West Coast</td>
<td>Collingwood</td>
<td>MCG</td>
</tr>
</tbody>
</table>
<h3 id="create-each-feature">Create Each Feature</h3>
<p>Now let's append next week's DataFrame to our afl_data, match_results and odds DataFrames and then create all the features we used in the AFL Feature Creation Tutorial. We need to append the games and then feed them into our function so that we can create features for upcoming games.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-78-1" name="__codelineno-78-1" href="#__codelineno-78-1"></a><span class="c1"># Append next week&#39;s games to our afl_data DataFrame</span>
<a id="__codelineno-78-2" name="__codelineno-78-2" href="#__codelineno-78-2"></a><span class="n">afl_data</span> <span class="o">=</span> <span class="n">afl_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">next_week_df</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-78-3" name="__codelineno-78-3" href="#__codelineno-78-3"></a>
<a id="__codelineno-78-4" name="__codelineno-78-4" href="#__codelineno-78-4"></a><span class="c1"># Append next week&#39;s games to match results (we need to do this for our feature creation to run)</span>
<a id="__codelineno-78-5" name="__codelineno-78-5" href="#__codelineno-78-5"></a><span class="n">match_results</span> <span class="o">=</span> <span class="n">afl_data_cleaning_v2</span><span class="o">.</span><span class="n">get_cleaned_match_results</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">next_week_df</span><span class="p">)</span>
<a id="__codelineno-78-6" name="__codelineno-78-6" href="#__codelineno-78-6"></a>
<a id="__codelineno-78-7" name="__codelineno-78-7" href="#__codelineno-78-7"></a><span class="c1"># Append next week&#39;s games to odds</span>
<a id="__codelineno-78-8" name="__codelineno-78-8" href="#__codelineno-78-8"></a><span class="n">odds</span> <span class="o">=</span> <span class="p">(</span><span class="n">afl_data_cleaning_v2</span><span class="o">.</span><span class="n">get_cleaned_odds</span><span class="p">()</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="k">lambda</span> <span class="n">df</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">next_week_df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]))</span>
<a id="__codelineno-78-9" name="__codelineno-78-9" href="#__codelineno-78-9"></a>       <span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-79-1" name="__codelineno-79-1" href="#__codelineno-79-1"></a><span class="n">features_df</span> <span class="o">=</span> <span class="n">afl_feature_creation_v2</span><span class="o">.</span><span class="n">prepare_afl_features</span><span class="p">(</span><span class="n">afl_data</span><span class="o">=</span><span class="n">afl_data</span><span class="p">,</span> <span class="n">match_results</span><span class="o">=</span><span class="n">match_results</span><span class="p">,</span> <span class="n">odds</span><span class="o">=</span><span class="n">odds</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-80-1" name="__codelineno-80-1" href="#__codelineno-80-1"></a><span class="n">features_df</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span>
</code></pre></div>
<table>
<thead>
<tr>
<th></th>
<th>game</th>
<th>home_team</th>
<th>away_team</th>
<th>date</th>
<th>round</th>
<th>venue</th>
<th>season</th>
<th>f_odds</th>
<th>f_form_margin_btwn_teams</th>
<th>f_form_past_5_btwn_teams</th>
<th>f_odds_away</th>
<th>f_elo_home</th>
<th>f_elo_away</th>
<th>f_I50_efficiency_home</th>
<th>f_R50_efficiency_home</th>
<th>f_I50_efficiency_away</th>
<th>f_R50_efficiency_away</th>
<th>f_AF_diff</th>
<th>f_B_diff</th>
<th>f_BO_diff</th>
<th>f_CCL_diff</th>
<th>f_CG_diff</th>
<th>f_CL_diff</th>
<th>f_CM_diff</th>
<th>f_CP_diff</th>
<th>f_D_diff</th>
<th>f_ED_diff</th>
<th>f_FA_diff</th>
<th>f_FF_diff</th>
<th>f_G_diff</th>
<th>f_GA_diff</th>
<th>f_GA1_diff</th>
<th>f_HB_diff</th>
<th>f_HO_diff</th>
<th>f_I50_diff</th>
<th>f_ITC_diff</th>
<th>f_K_diff</th>
<th>f_M_diff</th>
<th>f_MG_diff</th>
<th>f_MI5_diff</th>
<th>f_One.Percenters_diff</th>
<th>f_R50_diff</th>
<th>f_SC_diff</th>
<th>f_SCL_diff</th>
<th>f_SI_diff</th>
<th>f_T_diff</th>
<th>f_T5_diff</th>
<th>f_TO_diff</th>
<th>f_UP_diff</th>
<th>f_Unnamed: 0_diff</th>
<th>f_behinds_diff</th>
<th>f_goals_diff</th>
<th>f_margin_diff</th>
<th>f_opponent_behinds_diff</th>
<th>f_opponent_goals_diff</th>
<th>f_opponent_points_diff</th>
<th>f_points_diff</th>
<th>f_current_odds_prob</th>
<th>f_current_odds_prob_away</th>
</tr>
</thead>
<tbody>
<tr>
<td>1065</td>
<td>15397</td>
<td>Melbourne</td>
<td>GWS</td>
<td>2018-08-26</td>
<td>23</td>
<td>M.C.G.</td>
<td>2018</td>
<td>1.966936</td>
<td>-23.2</td>
<td>2.0</td>
<td>1.813998</td>
<td>1523.456734</td>
<td>1609.444874</td>
<td>0.653525</td>
<td>0.680168</td>
<td>0.704767</td>
<td>0.749812</td>
<td>140.535514</td>
<td>0.605144</td>
<td>-9.771981</td>
<td>5.892176</td>
<td>7.172376</td>
<td>6.614609</td>
<td>-1.365211</td>
<td>30.766262</td>
<td>21.998618</td>
<td>0.067228</td>
<td>-1.404730</td>
<td>-3.166732</td>
<td>6.933998</td>
<td>6.675576</td>
<td>0.000000</td>
<td>38.708158</td>
<td>24.587333</td>
<td>12.008987</td>
<td>10.482382</td>
<td>-16.709540</td>
<td>-15.415060</td>
<td>289.188486</td>
<td>6.350287</td>
<td>-2.263536</td>
<td>-20.966818</td>
<td>50.388632</td>
<td>0.723637</td>
<td>15.537783</td>
<td>22.912269</td>
<td>2.065039</td>
<td>10.215523</td>
<td>-6.689429</td>
<td>3259.163465</td>
<td>-0.136383</td>
<td>3.553795</td>
<td>16.563721</td>
<td>-2.353514</td>
<td>1.162696</td>
<td>4.622664</td>
<td>21.186385</td>
<td>0.661551</td>
<td>0.340379</td>
</tr>
<tr>
<td>1066</td>
<td>15398</td>
<td>St Kilda</td>
<td>North Melbourne</td>
<td>2018-08-26</td>
<td>23</td>
<td>Docklands</td>
<td>2018</td>
<td>5.089084</td>
<td>-3.2</td>
<td>2.0</td>
<td>2.577161</td>
<td>1397.237139</td>
<td>1499.366007</td>
<td>0.725980</td>
<td>0.655749</td>
<td>0.723949</td>
<td>0.677174</td>
<td>51.799992</td>
<td>3.399035</td>
<td>6.067393</td>
<td>-2.189489</td>
<td>-10.475859</td>
<td>1.154766</td>
<td>-8.883840</td>
<td>-21.810962</td>
<td>33.058382</td>
<td>40.618410</td>
<td>2.286314</td>
<td>-0.345734</td>
<td>-3.778445</td>
<td>-2.182673</td>
<td>0.000000</td>
<td>19.816372</td>
<td>-21.562916</td>
<td>2.678384</td>
<td>-14.777698</td>
<td>13.242010</td>
<td>12.065594</td>
<td>-82.381996</td>
<td>-2.176564</td>
<td>2.335825</td>
<td>-4.952336</td>
<td>45.719406</td>
<td>3.344217</td>
<td>-2.095613</td>
<td>-3.929084</td>
<td>-3.182381</td>
<td>-12.832197</td>
<td>57.226776</td>
<td>-20221.371526</td>
<td>1.968709</td>
<td>-1.897958</td>
<td>-15.177001</td>
<td>1.067099</td>
<td>0.781811</td>
<td>5.757963</td>
<td>-9.419038</td>
<td>0.284269</td>
<td>0.717566</td>
</tr>
<tr>
<td>1067</td>
<td>15404</td>
<td>Collingwood</td>
<td>GWS</td>
<td>2018-09-15</td>
<td>25</td>
<td>M.C.G.</td>
<td>2018</td>
<td>1.882301</td>
<td>12.6</td>
<td>3.0</td>
<td>2.018344</td>
<td>1546.000498</td>
<td>1590.806454</td>
<td>0.693185</td>
<td>0.706222</td>
<td>0.718446</td>
<td>0.727961</td>
<td>205.916671</td>
<td>-1.642954</td>
<td>-2.980828</td>
<td>-0.266023</td>
<td>8.547225</td>
<td>-3.751909</td>
<td>-0.664977</td>
<td>10.563513</td>
<td>48.175985</td>
<td>43.531908</td>
<td>-5.836979</td>
<td>5.388668</td>
<td>4.395675</td>
<td>2.555152</td>
<td>0.000000</td>
<td>51.588962</td>
<td>11.558254</td>
<td>4.276481</td>
<td>11.284445</td>
<td>-3.412977</td>
<td>-2.206815</td>
<td>-234.577304</td>
<td>2.637758</td>
<td>-10.537765</td>
<td>-11.127876</td>
<td>125.607377</td>
<td>-3.485896</td>
<td>3.532031</td>
<td>15.102292</td>
<td>-2.500685</td>
<td>8.187543</td>
<td>38.053445</td>
<td>12500.525732</td>
<td>-1.006173</td>
<td>2.520135</td>
<td>18.634835</td>
<td>-2.159882</td>
<td>-0.393386</td>
<td>-4.520198</td>
<td>14.114637</td>
<td>0.608495</td>
<td>0.393856</td>
</tr>
<tr>
<td>1068</td>
<td>15406</td>
<td>West Coast</td>
<td>Melbourne</td>
<td>2018-09-22</td>
<td>26</td>
<td>Perth Stadium</td>
<td>2018</td>
<td>2.013572</td>
<td>21.2</td>
<td>3.0</td>
<td>1.884148</td>
<td>1577.888606</td>
<td>1542.095154</td>
<td>0.688877</td>
<td>0.708941</td>
<td>0.649180</td>
<td>0.698319</td>
<td>-118.135184</td>
<td>-3.005709</td>
<td>2.453190</td>
<td>-5.103869</td>
<td>-14.368949</td>
<td>-12.245458</td>
<td>2.771411</td>
<td>-45.364271</td>
<td>-60.210182</td>
<td>-24.049523</td>
<td>-2.791277</td>
<td>6.115918</td>
<td>-5.041030</td>
<td>-5.335746</td>
<td>0.000000</td>
<td>-78.816902</td>
<td>-18.784547</td>
<td>-13.957754</td>
<td>-5.527613</td>
<td>18.606721</td>
<td>25.366778</td>
<td>-910.988860</td>
<td>-5.515812</td>
<td>-9.483590</td>
<td>8.914093</td>
<td>-131.380758</td>
<td>-7.142529</td>
<td>-49.484957</td>
<td>-13.718798</td>
<td>-4.862994</td>
<td>-9.834616</td>
<td>-23.673638</td>
<td>-3178.282073</td>
<td>-1.785349</td>
<td>-2.569957</td>
<td>-20.008787</td>
<td>0.476202</td>
<td>0.387915</td>
<td>2.803694</td>
<td>-17.205093</td>
<td>0.543774</td>
<td>0.457875</td>
</tr>
<tr>
<td>1069</td>
<td>15407</td>
<td>West Coast</td>
<td>Collingwood</td>
<td>2018-09-29</td>
<td>27</td>
<td>MCG</td>
<td>2018</td>
<td>1.981832</td>
<td>17.2</td>
<td>3.0</td>
<td>1.838864</td>
<td>1591.348723</td>
<td>1562.924273</td>
<td>0.679011</td>
<td>0.724125</td>
<td>0.711352</td>
<td>0.709346</td>
<td>159.522670</td>
<td>0.893421</td>
<td>-0.475725</td>
<td>3.391070</td>
<td>-5.088751</td>
<td>5.875388</td>
<td>5.352234</td>
<td>7.729063</td>
<td>-7.358202</td>
<td>-4.719968</td>
<td>6.113565</td>
<td>4.822252</td>
<td>2.871241</td>
<td>2.690270</td>
<td>3.636364</td>
<td>-64.238180</td>
<td>-0.631102</td>
<td>2.078832</td>
<td>6.005613</td>
<td>56.879978</td>
<td>34.373271</td>
<td>1016.491933</td>
<td>1.199751</td>
<td>2.454685</td>
<td>12.197047</td>
<td>219.666562</td>
<td>2.484363</td>
<td>0.379162</td>
<td>2.566991</td>
<td>0.639666</td>
<td>2.258377</td>
<td>-23.841529</td>
<td>-368920.360240</td>
<td>-0.646160</td>
<td>0.892051</td>
<td>3.040850</td>
<td>1.589568</td>
<td>0.012622</td>
<td>1.665299</td>
<td>4.706148</td>
<td>0.427350</td>
<td>0.571429</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="create-predictions-for-the-upcoming-round">Create Predictions For the Upcoming Round</h2>
<p>Now that we have our features, we can use our model that we created in part 3 to predict the next round. First we need to filter our features_df into a training df and a df with next round's features/matches. Then we can use the model created in the last tutorial to create predictions. For simplicity, I have hardcoded the parameters we used in the last tutorial.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-81-1" name="__codelineno-81-1" href="#__codelineno-81-1"></a><span class="c1"># Get the train df by only taking the games IDs which aren&#39;t in the next week df</span>
<a id="__codelineno-81-2" name="__codelineno-81-2" href="#__codelineno-81-2"></a><span class="n">train_df</span> <span class="o">=</span> <span class="n">features_df</span><span class="p">[</span><span class="o">~</span><span class="n">features_df</span><span class="o">.</span><span class="n">game</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">next_week_df</span><span class="o">.</span><span class="n">game</span><span class="p">)]</span>
<a id="__codelineno-81-3" name="__codelineno-81-3" href="#__codelineno-81-3"></a>
<a id="__codelineno-81-4" name="__codelineno-81-4" href="#__codelineno-81-4"></a><span class="c1"># Get the result and merge to the feature_df</span>
<a id="__codelineno-81-5" name="__codelineno-81-5" href="#__codelineno-81-5"></a><span class="n">match_results</span> <span class="o">=</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;data/afl_match_results.csv&quot;</span><span class="p">)</span>
<a id="__codelineno-81-6" name="__codelineno-81-6" href="#__codelineno-81-6"></a>                    <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Game&#39;</span><span class="p">:</span> <span class="s1">&#39;game&#39;</span><span class="p">})</span>
<a id="__codelineno-81-7" name="__codelineno-81-7" href="#__codelineno-81-7"></a>                    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">result</span><span class="o">=</span><span class="k">lambda</span> <span class="n">df</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Home.Points&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Away.Points&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)))</span>
<a id="__codelineno-81-8" name="__codelineno-81-8" href="#__codelineno-81-8"></a>
<a id="__codelineno-81-9" name="__codelineno-81-9" href="#__codelineno-81-9"></a><span class="n">train_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">train_df</span><span class="p">,</span>  <span class="n">match_results</span><span class="p">[[</span><span class="s1">&#39;game&#39;</span><span class="p">,</span> <span class="s1">&#39;result&#39;</span><span class="p">]],</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;game&#39;</span><span class="p">)</span>
<a id="__codelineno-81-10" name="__codelineno-81-10" href="#__codelineno-81-10"></a>
<a id="__codelineno-81-11" name="__codelineno-81-11" href="#__codelineno-81-11"></a><span class="n">train_x</span> <span class="o">=</span> <span class="n">train_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">])</span>
<a id="__codelineno-81-12" name="__codelineno-81-12" href="#__codelineno-81-12"></a><span class="n">train_y</span> <span class="o">=</span> <span class="n">train_df</span><span class="o">.</span><span class="n">result</span>
<a id="__codelineno-81-13" name="__codelineno-81-13" href="#__codelineno-81-13"></a>
<a id="__codelineno-81-14" name="__codelineno-81-14" href="#__codelineno-81-14"></a><span class="n">next_round_x</span> <span class="o">=</span> <span class="n">features_df</span><span class="p">[</span><span class="n">features_df</span><span class="o">.</span><span class="n">game</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">next_week_df</span><span class="o">.</span><span class="n">game</span><span class="p">)]</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-82-1" name="__codelineno-82-1" href="#__codelineno-82-1"></a><span class="c1"># Fit out logistic regression model - note that our predictions come out in the order of [away_team_prob, home_team_prob]</span>
<a id="__codelineno-82-2" name="__codelineno-82-2" href="#__codelineno-82-2"></a>
<a id="__codelineno-82-3" name="__codelineno-82-3" href="#__codelineno-82-3"></a><span class="n">lr_best_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">,</span>
<a id="__codelineno-82-4" name="__codelineno-82-4" href="#__codelineno-82-4"></a> <span class="s1">&#39;class_weight&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-82-5" name="__codelineno-82-5" href="#__codelineno-82-5"></a> <span class="s1">&#39;dual&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-82-6" name="__codelineno-82-6" href="#__codelineno-82-6"></a> <span class="s1">&#39;fit_intercept&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-82-7" name="__codelineno-82-7" href="#__codelineno-82-7"></a> <span class="s1">&#39;intercept_scaling&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-82-8" name="__codelineno-82-8" href="#__codelineno-82-8"></a> <span class="s1">&#39;max_iter&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
<a id="__codelineno-82-9" name="__codelineno-82-9" href="#__codelineno-82-9"></a> <span class="s1">&#39;multi_class&#39;</span><span class="p">:</span> <span class="s1">&#39;ovr&#39;</span><span class="p">,</span>
<a id="__codelineno-82-10" name="__codelineno-82-10" href="#__codelineno-82-10"></a> <span class="s1">&#39;n_jobs&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-82-11" name="__codelineno-82-11" href="#__codelineno-82-11"></a> <span class="s1">&#39;penalty&#39;</span><span class="p">:</span> <span class="s1">&#39;l2&#39;</span><span class="p">,</span>
<a id="__codelineno-82-12" name="__codelineno-82-12" href="#__codelineno-82-12"></a> <span class="s1">&#39;random_state&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-82-13" name="__codelineno-82-13" href="#__codelineno-82-13"></a> <span class="s1">&#39;solver&#39;</span><span class="p">:</span> <span class="s1">&#39;newton-cg&#39;</span><span class="p">,</span>
<a id="__codelineno-82-14" name="__codelineno-82-14" href="#__codelineno-82-14"></a> <span class="s1">&#39;tol&#39;</span><span class="p">:</span> <span class="mf">0.0001</span><span class="p">,</span>
<a id="__codelineno-82-15" name="__codelineno-82-15" href="#__codelineno-82-15"></a> <span class="s1">&#39;verbose&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-82-16" name="__codelineno-82-16" href="#__codelineno-82-16"></a> <span class="s1">&#39;warm_start&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>
<a id="__codelineno-82-17" name="__codelineno-82-17" href="#__codelineno-82-17"></a>
<a id="__codelineno-82-18" name="__codelineno-82-18" href="#__codelineno-82-18"></a><span class="n">feature_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">train_df</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;f_&#39;</span><span class="p">)]</span>
<a id="__codelineno-82-19" name="__codelineno-82-19" href="#__codelineno-82-19"></a>
<a id="__codelineno-82-20" name="__codelineno-82-20" href="#__codelineno-82-20"></a><span class="c1"># Scale features</span>
<a id="__codelineno-82-21" name="__codelineno-82-21" href="#__codelineno-82-21"></a><span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
<a id="__codelineno-82-22" name="__codelineno-82-22" href="#__codelineno-82-22"></a><span class="n">train_x</span><span class="p">[</span><span class="n">feature_cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">train_x</span><span class="p">[</span><span class="n">feature_cols</span><span class="p">])</span>
<a id="__codelineno-82-23" name="__codelineno-82-23" href="#__codelineno-82-23"></a><span class="n">next_round_x</span><span class="p">[</span><span class="n">feature_cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">next_round_x</span><span class="p">[</span><span class="n">feature_cols</span><span class="p">])</span>
<a id="__codelineno-82-24" name="__codelineno-82-24" href="#__codelineno-82-24"></a>
<a id="__codelineno-82-25" name="__codelineno-82-25" href="#__codelineno-82-25"></a><span class="n">lr</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="o">**</span><span class="n">lr_best_params</span><span class="p">)</span>
<a id="__codelineno-82-26" name="__codelineno-82-26" href="#__codelineno-82-26"></a><span class="n">lr</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_x</span><span class="p">[</span><span class="n">feature_cols</span><span class="p">],</span> <span class="n">train_y</span><span class="p">)</span>
<a id="__codelineno-82-27" name="__codelineno-82-27" href="#__codelineno-82-27"></a><span class="n">prediction_probs</span> <span class="o">=</span> <span class="n">lr</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">next_round_x</span><span class="p">[</span><span class="n">feature_cols</span><span class="p">])</span>
<a id="__codelineno-82-28" name="__codelineno-82-28" href="#__codelineno-82-28"></a>
<a id="__codelineno-82-29" name="__codelineno-82-29" href="#__codelineno-82-29"></a><span class="n">modelled_home_odds</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="o">/</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">prediction_probs</span><span class="p">]</span>
<a id="__codelineno-82-30" name="__codelineno-82-30" href="#__codelineno-82-30"></a><span class="n">modelled_away_odds</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="o">/</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">prediction_probs</span><span class="p">]</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-83-1" name="__codelineno-83-1" href="#__codelineno-83-1"></a><span class="c1"># Create a predictions df</span>
<a id="__codelineno-83-2" name="__codelineno-83-2" href="#__codelineno-83-2"></a><span class="n">preds_df</span> <span class="o">=</span> <span class="p">(</span><span class="n">next_round_x</span><span class="p">[[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;home_team&#39;</span><span class="p">,</span> <span class="s1">&#39;away_team&#39;</span><span class="p">,</span> <span class="s1">&#39;venue&#39;</span><span class="p">,</span> <span class="s1">&#39;game&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-83-3" name="__codelineno-83-3" href="#__codelineno-83-3"></a>               <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">modelled_home_odds</span><span class="o">=</span><span class="n">modelled_home_odds</span><span class="p">,</span>
<a id="__codelineno-83-4" name="__codelineno-83-4" href="#__codelineno-83-4"></a>                      <span class="n">modelled_away_odds</span><span class="o">=</span><span class="n">modelled_away_odds</span><span class="p">)</span>
<a id="__codelineno-83-5" name="__codelineno-83-5" href="#__codelineno-83-5"></a>               <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">,</span> <span class="n">next_week_odds</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;home_team&#39;</span><span class="p">,</span> <span class="s1">&#39;away_team&#39;</span><span class="p">])</span>
<a id="__codelineno-83-6" name="__codelineno-83-6" href="#__codelineno-83-6"></a>               <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">,</span> <span class="n">features_df</span><span class="p">[[</span><span class="s1">&#39;game&#39;</span><span class="p">,</span> <span class="s1">&#39;f_elo_home&#39;</span><span class="p">,</span> <span class="s1">&#39;f_elo_away&#39;</span><span class="p">]],</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;game&#39;</span><span class="p">)</span>
<a id="__codelineno-83-7" name="__codelineno-83-7" href="#__codelineno-83-7"></a>               <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;game&#39;</span><span class="p">)</span>
<a id="__codelineno-83-8" name="__codelineno-83-8" href="#__codelineno-83-8"></a>           <span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-84-1" name="__codelineno-84-1" href="#__codelineno-84-1"></a><span class="n">preds_df</span>
</code></pre></div>
<table>
<thead>
<tr>
<th></th>
<th>date</th>
<th>home_team</th>
<th>away_team</th>
<th>venue</th>
<th>modelled_home_odds</th>
<th>modelled_away_odds</th>
<th>odds</th>
<th>odds_away</th>
<th>f_elo_home</th>
<th>f_elo_away</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>2018-09-29</td>
<td>West Coast</td>
<td>Collingwood</td>
<td>MCG</td>
<td>2.326826</td>
<td>1.753679</td>
<td>2.34</td>
<td>1.75</td>
<td>1591.348723</td>
<td>1562.924273</td>
</tr>
</tbody>
</table>
<p>Alternatively, if you want to generate predictions using a script which uses all the above code, just run the following:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-85-1" name="__codelineno-85-1" href="#__codelineno-85-1"></a><span class="nb">print</span><span class="p">(</span><span class="n">afl_modelling_v2</span><span class="o">.</span><span class="n">create_predictions</span><span class="p">())</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>        date   home_team    away_team venue  modelled_home_odds  \
0 2018-09-29  West Coast  Collingwood   MCG            2.326826

   modelled_away_odds  odds  odds_away   f_elo_home   f_elo_away  
0            1.753679  2.34       1.75  1591.348723  1562.924273
</code></pre></div>
<hr />
<h2 id="conclusion">Conclusion</h2>
<p>Congratulations! You have created AFL predictions for this week. If you are beginner to this, don't be overwhelmed. The process gets easier each time you do it. And it is super rewarding. In future iterations we will update this tutorial to predict actual odds, and then integrate this with <a href="../../api/apiappkey">Betfair's API</a> so that you can create an automated betting strategy using Machine Learning to create your predictions!</p>
<hr />
<h3 id="disclaimer">Disclaimer</h3>
<p>Note that whilst models and automated strategies are fun and rewarding to create, we can't promise that your model or betting strategy will be profitable, and we make no representations in relation to the code shared or information on this page. If you're using this code or implementing your own strategies, you do so entirely at your own risk and you are responsible for any winnings/losses incurred. Under no circumstances will Betfair be liable for any loss or damage you suffer.</p>









  




                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
    
      <nav class="md-footer__inner md-grid" aria-label="footer.title">
        
          
          <a href="../modellingTheBrownlowMedal/" class="md-footer__link md-footer__link--prev" aria-label="Previous: How does a Data Scientist model the Brownlow?" rel="prev">
            <div class="md-footer__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <div class="md-ellipsis">
                <span class="md-footer__direction">
                  Previous
                </span>
                How does a Data Scientist model the Brownlow?
              </div>
            </div>
          </a>
        
        
          
          <a href="../brownlowModelTutorial/" class="md-footer__link md-footer__link--next" aria-label="Next: Modelling the Brownlow Medal in Python" rel="next">
            <div class="md-footer__title">
              <div class="md-ellipsis">
                <span class="md-footer__direction">
                  Next
                </span>
                Modelling the Brownlow Medal in Python
              </div>
            </div>
            <div class="md-footer__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
    <div class="md-footer-meta md-typeset">
      <div class="md-footer-meta__inner md-grid">
        <div class="md-copyright">
  
  
</div>
        
          <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://twitter.com/Betfair_Aus" target="_blank" rel="noopener" title="twitter.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://linkedin.com/company/betfair-australia" target="_blank" rel="noopener" title="linkedin.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3M135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5m282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://facebook.com/betfairaustralia" target="_blank" rel="noopener" title="facebook.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M512 256C512 114.6 397.4 0 256 0S0 114.6 0 256c0 120 82.7 220.8 194.2 248.5V334.2h-52.8V256h52.8v-33.7c0-87.1 39.4-127.5 125-127.5 16.2 0 44.2 3.2 55.7 6.4V172c-6-.6-16.5-1-29.6-1-42 0-58.2 15.9-58.2 57.2V256h83.6l-14.4 78.2H287v175.9C413.8 494.8 512 386.9 512 256"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://youtube.com/user/betfairaus" target="_blank" rel="noopener" title="youtube.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M549.655 124.083c-6.281-23.65-24.787-42.276-48.284-48.597C458.781 64 288 64 288 64S117.22 64 74.629 75.486c-23.497 6.322-42.003 24.947-48.284 48.597-11.412 42.867-11.412 132.305-11.412 132.305s0 89.438 11.412 132.305c6.281 23.65 24.787 41.5 48.284 47.821C117.22 448 288 448 288 448s170.78 0 213.371-11.486c23.497-6.321 42.003-24.171 48.284-47.821 11.412-42.867 11.412-132.305 11.412-132.305s0-89.438-11.412-132.305m-317.51 213.508V175.185l142.739 81.205z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://github.com/betfair-datascientists" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
</div>
        
      </div>

      <div class="bf-footer">
          <div class="bf-footer-inner">
              <p class="bf-light">Betfair Pty Limited is licensed and regulated by the Northern Territory Government of Australia.</p>
              <p class="bf-dark">Betfair Pty Limited's gambling operations are governed by its <a class='inner-link' href="https://www.betfair.com.au/info/responsible-gambling/">Responsible Gambling Code of Conduct</a> and for South
              Australian residents by the <a class='inner-link' href="https://www.betfair.com.au/info/pdf/SA-GCoP.pdf">South Australian Responsible Gambling Code of Practice.</a></p>
              <!-- BetStop block in white box -->
              <div class="full-screen">
                  <p style="font-family: Arial, sans-serif; font-size: 1.2rem; font-weight: bold; text-align: center;">
                    BetStop is the Australian National Self-Exclusion Register. For more information, please visit 
                    <a href="https://betstop.gov.au" style="font-family: Arial, sans-serif; font-size: 1.2rem; font-weight: bold; color: black; text-decoration: none;">
                      https://betstop.gov.au
                    </a>
                  </p>
              </div>
              <br />
              <!-- RG footer block -->
              <div class="full-screen"> <p style="font-family: Arial, sans-serif; font-size: 1.2rem; font-weight: bold; text-align: center;">Imagine what you could be buying instead.</p> <p style="font-family: Arial, sans-serif; font-size: 0.8rem; font-weight: bold; text-align: center;">For free and confidential support call 1800 858 858 or visit <a href="http://www.gamblinghelponline.org.au" style="color: black; text-decoration: underline;">gamblinghelponline.org.au</a></p> </div>
              <ul class="bf-links">
                <li><a href="https://www.betfair.com.au/hub/help/account-help/responsible-gambling/">Responsible Gambling</a><span>|</span></li>
                <li><a href="http://www.betfair.com/AUS_NZL/aboutUs/Terms.and.Conditions/">Terms & Conditions</a><span>|</span></li>
                <li><a href="https://www.betfair.com.au/info/privacy-policy/">Privacy Policy</a><span>|</span></li>
                <li><a href="http://www.betfair.com/en/aboutUs/Rules.and.Regulations/">Rules & Regulations</a><span>|</span></li>
                <li><a href="https://www.betfair.com/AUS_NZL/aboutUs/Dispute.Resolution">Dispute Resolution</a></li>
              </ul>
          </div>
      </div>
    </div>

    <script src="https://js.adsrvr.org/up_loader.1.1.0.js" type="text/javascript"></script>
    <script type="text/javascript">
        ttd_dom_ready( function() {
            if (typeof TTDUniversalPixelApi === 'function') {
                var universalPixelApi = new TTDUniversalPixelApi();
                universalPixelApi.init("y12d1ir", ["8ml4f17"], "https://insight.adsrvr.org/track/up");
            }
        });
    </script>

</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["toc.integrate", "navigation.instant", "navigation.tabs", "navigation.top", "navigation.expand", "navigation.sections", "search.suggest", "search.highlight", "search.share"], "search": "../../assets/javascripts/workers/search.f8cc74c7.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.f1b6f286.min.js"></script>
      
        <script src="../../js/scripts.js"></script>
      
    
  </body>
</html>