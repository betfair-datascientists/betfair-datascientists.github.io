
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Documentation, guides and articles on creating, developing and implementing automated betting strategies, using data analysis to inform betting models and how to interact with the Betfair API.">
      
      
        <meta name="author" content="Betfair Data Scientists">
      
      
        <link rel="canonical" href="https://betfair-datascientists.github.io/modelling/topazTutorial/">
      
      
        <link rel="prev" href="../cloudOrLocalMachine/">
      
      
        <link rel="next" href="../fasttrackTutorial/">
      
      
      <link rel="icon" href="../../img/BetfairFavicon.ico">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.6">
    
    
      
        <title>Greyhound Topaz API Tutorial (New) - The Automation Hub</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.50c56a3b.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/betfair.css">
    
      <link rel="stylesheet" href="../../css/buttons_and_animations.css">
    
      <link rel="stylesheet" href="../../css/fonts.css">
    
      <link rel="stylesheet" href="../../css/ansi-colours.css">
    
      <link rel="stylesheet" href="../../css/jupyter-cells.css">
    
      <link rel="stylesheet" href="../../css/pandas-dataframe.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function n(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],n("js",new Date),n("config","UA-125973915-1"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&n("event","search",{search_term:this.value})}),document$.subscribe(function(){var a=document.forms.feedback;if(void 0!==a)for(var e of a.querySelectorAll("[type=submit]"))e.addEventListener("click",function(e){e.preventDefault();var t=document.location.pathname,e=this.getAttribute("data-md-value");n("event","feedback",{page:t,data:e}),a.firstElementChild.disabled=!0;e=a.querySelector(".md-feedback__note [data-md-value='"+e+"']");e&&(e.hidden=!1)}),a.hidden=!1}),location$.subscribe(function(e){n("config","UA-125973915-1",{page_path:e.pathname})})});var e=document.createElement("script");e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id=UA-125973915-1",document.getElementById("__analytics").insertAdjacentElement("afterEnd",e)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="betfair" data-md-color-primary="amber" data-md-color-accent="orange">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#greyhound-modelling-in-python-using-the-topaz-api" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      
  
  <header class="md-header" data-md-component="header">
    <nav class="md-header__inner md-grid" aria-label="header.title">
      <a href="../.." title="The Automation Hub" class="md-header__button md-logo" aria-label="The Automation Hub" data-md-component="logo">
        
  <img src="../../img/logo.svg" alt="logo">

      </a>
      <label class="md-header__button md-icon" for="__drawer">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
      </label>
      <div class="md-header__title" data-md-component="header-title">
        <div class="md-header__ellipsis">
          <div class="md-header__topic">
            <span class="md-ellipsis">
              The Automation Hub
            </span>
          </div>
          <div class="md-header__topic" data-md-component="header-topic">
            <span class="md-ellipsis">
              
                Greyhound Topaz API Tutorial (New)
              
            </span>
          </div>
        </div>
      </div>

      
        <form class="md-header__option" data-md-component="palette">
          
            
            
            <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="betfair" data-md-color-primary="amber" data-md-color-accent="orange"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
            
              <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3 3.19.09m3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95 2.06.05m-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31Z"/></svg>
              </label>
            
          
            
            
            <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="amber" data-md-color-accent="orange"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
            
              <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5c-.84 0-1.65.15-2.39.42L12 2M3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29L3.34 7m.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14L3.36 17M20.65 7l-1.77 3.79a7.023 7.023 0 0 0-2.38-4.15l4.15.36m-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29L20.64 17M12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44L12 22Z"/></svg>
              </label>
            
          
        </form>
      
      

      
     
      <div class="bf-nav">
        <a class="bf-hidable" href="https://www.betfair.com.au/exchange/plus/"><svg class="exchangeLogo" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:cc="http://creativecommons.org/ns#"
          xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 38.775 4.59" width="24" height="17">
          <path class="st1" d="m 160.3,-136.95 v 26" />
          <g transform="translate(18.8,-137.15)">
            <path d="m 2.2901089,126.53441 v 5.20093 H -3.3107216 L 7.4888397,144.33446 18.2884,131.73534 h -5.598633 v -5.20093 z m -8.6000974,8.10132 -10.8017585,12.59913 h 5.60083 v 5.2998 h 10.3996581 v -5.2998 h 5.6008306 z" />
          </g>
        </svg><span> Exchange</span></a>
        <a href="https://www.betfair.com.au/hub/">Hub</a>
      </div>

      

    </nav>
    
  </header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../data/dataListing/" class="md-tabs__link">
          
  
  Data

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../wagering/betfairHowTo/" class="md-tabs__link">
          
  
  Wagering

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../api/apiResources/" class="md-tabs__link">
          
  
  API

        </a>
      </li>
    
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../greyhoundDatathon/" class="md-tabs__link">
          
  
  Modelling

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../automation/GoldenRulesofAutomation/" class="md-tabs__link">
          
  
  Automation

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../tutorials/How_to_Automate_1/" class="md-tabs__link">
          
  
  Tutorials

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../mentalGame/intro/" class="md-tabs__link">
          
  
  Mental Game

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../contactUs/test/" class="md-tabs__link">
          
  
  Contact Us

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="The Automation Hub" class="md-nav__button md-logo" aria-label="The Automation Hub" data-md-component="logo">
      
  <img src="../../img/logo.svg" alt="logo">

    </a>
    The Automation Hub
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Data
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Data
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../data/dataListing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CSV Files
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Wagering
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Wagering
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../wagering/betfairHowTo/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Betfair How-To
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../wagering/bettingGlossary/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Betting Glossary
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../wagering/stakingMethods/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Staking Methods and Bankroll Management
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../wagering/valueAndOdds/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Value and Odds
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../wagering/commission/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Commission and other charges
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../wagering/hubPredictionsModel/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Hub Predictions Model
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../wagering/exactaQuinella/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Exactas & Quinella
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  <span class="md-ellipsis">
    API
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            API
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/apiResources/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    API resources
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/apiappkey/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to access the Betfair API
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/apiRtutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    API tutorial in R
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/apiPythontutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    API tutorial in Python
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" checked>
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Modelling
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Modelling
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../greyhoundDatathon/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Greyhound Racing Datathon
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../howToModel/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Intro to modelling
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../dataSources/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Pricing Data Sources
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cloudOrLocalMachine/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Cloud or Local
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_5" checked>
        
          
          <label class="md-nav__link" for="__nav_5_5" id="__nav_5_5_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Racing
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_5_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_5_5">
            <span class="md-nav__icon md-icon"></span>
            Racing
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Greyhound Topaz API Tutorial (New)
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Greyhound Topaz API Tutorial (New)
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    <span class="md-ellipsis">
      Overview
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#requirements" class="md-nav__link">
    <span class="md-ellipsis">
      Requirements
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#historic-data" class="md-nav__link">
    <span class="md-ellipsis">
      Historic Data
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cleaning-the-data" class="md-nav__link">
    <span class="md-ellipsis">
      Cleaning the data
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#create-the-features" class="md-nav__link">
    <span class="md-ellipsis">
      Create the features
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#training" class="md-nav__link">
    <span class="md-ellipsis">
      Training
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#grid-search" class="md-nav__link">
    <span class="md-ellipsis">
      Grid Search
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#analysing-profitability" class="md-nav__link">
    <span class="md-ellipsis">
      Analysing profitability
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creating-new-ratings" class="md-nav__link">
    <span class="md-ellipsis">
      Creating new ratings
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#to-be-continued" class="md-nav__link">
    <span class="md-ellipsis">
      To be continued
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#disclaimer" class="md-nav__link">
    <span class="md-ellipsis">
      Disclaimer
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../fasttrackTutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Greyhound form FastTrack API
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../greyhoundModellingPython/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Greyhound modelling in Python
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_6" >
        
          
          <label class="md-nav__link" for="__nav_5_6" id="__nav_5_6_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Soccer
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_6">
            <span class="md-nav__icon md-icon"></span>
            Soccer
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../soccerModellingELO2022WorldCup/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Soccer modelling tutorial in R for 2022 FIFA World Cup
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../soccerModellingTutorialPython/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Soccer modelling tutorial in Python
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../EPLmlPython/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    EPL ML walk through in Python
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_7" >
        
          
          <label class="md-nav__link" for="__nav_5_7" id="__nav_5_7_label" tabindex="">
            
  
  <span class="md-ellipsis">
    AFL
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_7">
            <span class="md-nav__icon md-icon"></span>
            AFL
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../AFLmodellingPython/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    AFL modelling walk through in Python
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../brownlowModelTutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Modelling the Brownlow Medal in Python
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_8" >
        
          
          <label class="md-nav__link" for="__nav_5_8" id="__nav_5_8_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Tennis
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_8">
            <span class="md-nav__icon md-icon"></span>
            Tennis
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../howToModelTheAusOpen/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to model the Australian Open
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../AusOpenRTutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Aus Open R Tutorial
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../AusOpenPythonTutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Aus Open Python Tutorial
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Automation
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Automation
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/GoldenRulesofAutomation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Golden rules of automation
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/overview/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Tools Overview
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6_3" >
        
          
          <label class="md-nav__link" for="__nav_6_3" id="__nav_6_3_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Bet Angel
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_3">
            <span class="md-nav__icon md-icon"></span>
            Bet Angel
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/betAngel/betAngel/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Overview
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/betAngelbeginners/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Beginner's guide
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/betAngelintermediate/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Intermediate guide
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/betAngeladvanced/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Advanced guide
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/betAngelRatingsAutomation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Ratings auto
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/betAngelMarketFavouriteAutomation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Market fav auto
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/betAngelTippingAutomation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Tipping auto
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/betAngelSimultaneousMarkets/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Simultaneous markets
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/betAngelKellyStake/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Kelly criterion staking
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6_4" >
        
          
          <label class="md-nav__link" for="__nav_6_4" id="__nav_6_4_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Gruss Betting Assistant
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_4">
            <span class="md-nav__icon md-icon"></span>
            Gruss Betting Assistant
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/Gruss/Gruss/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Overview
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/GrussSettingupbasicmarketview/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Setup basic market view and one click betting
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/grussRatingsAutomation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Ratings auto
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/grussMarketFavouriteAutomation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Market fav auto
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/grusslSimultaneousMarkets/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Simultaneous markets
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/grussKellyStake/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Kelly criterion staking
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6_5" >
        
          
          <label class="md-nav__link" for="__nav_6_5" id="__nav_6_5_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Cymatic Trader
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_5">
            <span class="md-nav__icon md-icon"></span>
            Cymatic Trader
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/CymaticTrader/CymaticTrader/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Overview
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/cymaticTraderRatingsAutomation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Ratings auto
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6_6" >
        
          
          <label class="md-nav__link" for="__nav_6_6" id="__nav_6_6_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Geeks Toy
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_6">
            <span class="md-nav__icon md-icon"></span>
            Geeks Toy
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/GeeksToyinstallationandsetup/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Installation and setup
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/GeeksToybasicmarketviewstakingandoneclickbetting/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Setup basic market view and one click betting
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/geeksToyRefreshSettings/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Optimising refresh settings
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6_7" >
        
          
          <label class="md-nav__link" for="__nav_6_7" id="__nav_6_7_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Bet Jet Pro
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_7">
            <span class="md-nav__icon md-icon"></span>
            Bet Jet Pro
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/betJetOverview/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Overview
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Tutorials
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            Tutorials
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/How_to_Automate_1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to Automate 1
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/How_to_Automate_2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to Automate 2
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/How_to_Automate_3/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to Automate 3
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/How_to_Automate_4/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to Automate 4
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/How_to_Automate_5/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to Automate 5
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/processingTarFiles101/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Take away the pain! Processing TAR Files 101
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/jsonToCsvRevisited/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    JSON to CSV | Revisited
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/backtestingRatingsTutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Back testing ratings in Python
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/automatedBettingAnglesTutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Automated betting angles in Python
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/analysingAndPredictingMarketMovements/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Do they know? Analysing Betfair market formation & market movements
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/analysingAndPredictingBSP/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Wisdom of the crowd? Analysing & understanding BSP
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_8" >
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Mental Game
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            Mental Game
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/intro/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Intro
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/roleOfEmotions/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Part 1
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/mapYourEmotions/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Part 2
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/handlingBadVariance/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Part 3
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/winbyBeingGreatatLosing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Part 4
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/correctingyouremotions/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Part 5
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/responsibleGambling/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Part 6
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/InchwormConcept/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Part 7
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/HighExpectations/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Part 8
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/TappingYourIntuition/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Part 9
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_9" >
        
          
          <label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Contact Us
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9">
            <span class="md-nav__icon md-icon"></span>
            Contact Us
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../contactUs/test/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Meet the Team
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="greyhound-modelling-in-python-using-the-topaz-api">Greyhound Modelling in Python using the Topaz API</h1>
<p>Building a greyhound racing model using Python and Machine Learning</p>
<p>This tutorial is a refreshed version of our previous tutorials utilising the new version of the FastTrack API (now called Topaz). 
Topaz is a product provided to Betfair Australia &amp; New Zealand customers by Greyhound Racing Victoria (GRV). </p>
<p>If you would like your own Topaz API key, please contact us <a href="mailto:data@betfair.com.au">here</a>. 
Access can only be provided to Betfair Australia or New Zealand customers with active accounts</p>
<hr />
<h2 id="overview">Overview</h2>
<p>This tutorial will walk you through the different steps required to generate Greyhound racing winning probabilities</p>
<ol>
<li>Download historic greyhound data from Topaz API</li>
<li>Cleanse and normalise the data</li>
<li>Generate features using raw data</li>
<li>Build and train classification models</li>
<li>Evaluate models' performances</li>
<li>Evaluate feature importance</li>
</ol>
<hr />
<h2 id="requirements">Requirements</h2>
<ul>
<li>Coding environment which supports Jupyter Notebooks (e.g. Visual Studio Code)</li>
<li>Betfair API Key. If you don't have one please follow the steps outlined on the <a href="https://betfair-datascientists.github.io/api/apiappkey/">The Automation Hub</a></li>
<li>Topaz API Key. If you would like to be considered for a Topaz key, please email <a href="mailto:data@betfair.com.au">data@betfair.com.au</a> (Australian/New Zealand customers only).</li>
<li>Python Topaz API wrapper. To install this package using pip, type 'pip install topaz_api' into your terminal</li>
</ul>
<hr />
<h2 id="historic-data">Historic Data</h2>
<p>To get started on building our own Topaz model, first we need to download the historic data from the Topaz API. The API has rate limits in place and so for the purposes of a bulk download of historic data, we will need to implement some way of handling these rate limits in order for us to download the data with a high degree of completeness. After all, the maxim 'Garbage In, Garbage Out' in regards to modelling holds true. If you don't feed your model good, complete data, then you won't have much success.</p>
<p>In the code block below, there are multiple instances of retries and programmed sleep functions to allow the rate limits to reset. We are also requesting the races for each state in blocks of 7 days.</p>
<p>NOTE: For state / date-range combinations where there are genuinely no races that occurred, the function will continuously error until it reaches the maximum specified retries before continuing to the next block. This may occur during the pandemic shutdown period in 2020 or the NSW Greyhound racing ban in 2017 or for time periods with the 'NT' jurisdiction where greyhound meetings may be up to 14 days apart.</p>
<div class="highlight"><span class="filename">Downloading Historic Data</span><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="kn">import</span> <span class="nn">time</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="kn">from</span> <span class="nn">topaz</span> <span class="kn">import</span> <span class="n">TopazAPI</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">MinMaxScaler</span> 
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="kn">import</span> <span class="nn">requests</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="kn">import</span> <span class="nn">os</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="kn">import</span> <span class="nn">itertools</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="c1"># Insert your TOPAZ API key </span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a><span class="n">TOPAZ_API_KEY</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a><span class="c1"># Define the states you require</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a><span class="n">JURISDICTION_CODES</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;NSW&#39;</span><span class="p">,</span><span class="s1">&#39;QLD&#39;</span><span class="p">,</span><span class="s1">&#39;WA&#39;</span><span class="p">,</span><span class="s1">&#39;TAS&#39;</span><span class="p">,</span><span class="s1">&#39;NT&#39;</span><span class="p">,</span><span class="s1">&#39;NZ&#39;</span><span class="p">,</span><span class="s1">&#39;WA&#39;</span><span class="p">,</span><span class="s1">&#39;SA&#39;</span><span class="p">]</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a><span class="c1"># Define the start and end date for the historic data download</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a><span class="n">start_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a><span class="n">end_date</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a><span class="sd">&#39;&#39;&#39;</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a><span class="sd">It is pythonic convention to define hard-coded variables (like credentials) in all caps. Variables whose value may change in use should be defined in lowercase with underscore spacing</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a><span class="sd">&#39;&#39;&#39;</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a><span class="k">def</span> <span class="nf">generate_date_range</span><span class="p">(</span><span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">):</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39; </span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a><span class="sd">    Here we generate our date range for passing into the Topaz API.</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a><span class="sd">    This is necessary due to the rate limits implemented in the Topaz API. </span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a><span class="sd">    Passing a start date and end date 12 months apart in the API call will cause significant amounts of data to be omitted, so we need to generate a range to pass much smaller date ranges in the Topaz API calls</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>    <span class="c1"># Initialise the date_range list</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>    <span class="n">date_range</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a>
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a>    <span class="n">current_date</span> <span class="o">=</span> <span class="n">start_date</span>
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a>
<a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a>    <span class="k">while</span> <span class="n">current_date</span> <span class="o">&lt;=</span> <span class="n">end_date</span><span class="p">:</span>
<a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a>        <span class="n">date_range</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">))</span>
<a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a>        <span class="n">current_date</span> <span class="o">+=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-39" name="__codelineno-0-39" href="#__codelineno-0-39"></a>
<a id="__codelineno-0-40" name="__codelineno-0-40" href="#__codelineno-0-40"></a>    <span class="k">return</span> <span class="n">date_range</span>
<a id="__codelineno-0-41" name="__codelineno-0-41" href="#__codelineno-0-41"></a>
<a id="__codelineno-0-42" name="__codelineno-0-42" href="#__codelineno-0-42"></a><span class="k">def</span> <span class="nf">define_topaz_api</span><span class="p">(</span><span class="n">api_key</span><span class="p">):</span>
<a id="__codelineno-0-43" name="__codelineno-0-43" href="#__codelineno-0-43"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<a id="__codelineno-0-44" name="__codelineno-0-44" href="#__codelineno-0-44"></a><span class="sd">    This is where we define the Topaz API and pass our credentials</span>
<a id="__codelineno-0-45" name="__codelineno-0-45" href="#__codelineno-0-45"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-0-46" name="__codelineno-0-46" href="#__codelineno-0-46"></a>    <span class="n">topaz_api</span> <span class="o">=</span> <span class="n">TopazAPI</span><span class="p">(</span><span class="n">api_key</span><span class="p">)</span>
<a id="__codelineno-0-47" name="__codelineno-0-47" href="#__codelineno-0-47"></a>
<a id="__codelineno-0-48" name="__codelineno-0-48" href="#__codelineno-0-48"></a>    <span class="k">return</span> <span class="n">topaz_api</span>
<a id="__codelineno-0-49" name="__codelineno-0-49" href="#__codelineno-0-49"></a>
<a id="__codelineno-0-50" name="__codelineno-0-50" href="#__codelineno-0-50"></a><span class="k">def</span> <span class="nf">download_topaz_data</span><span class="p">(</span><span class="n">topaz_api</span><span class="p">,</span><span class="n">date_range</span><span class="p">,</span><span class="n">codes</span><span class="p">,</span><span class="n">datatype</span><span class="p">):</span>
<a id="__codelineno-0-51" name="__codelineno-0-51" href="#__codelineno-0-51"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<a id="__codelineno-0-52" name="__codelineno-0-52" href="#__codelineno-0-52"></a><span class="sd">    The parameters passed here are:</span>
<a id="__codelineno-0-53" name="__codelineno-0-53" href="#__codelineno-0-53"></a><span class="sd">        1. The TopazAPI instance with our credentials</span>
<a id="__codelineno-0-54" name="__codelineno-0-54" href="#__codelineno-0-54"></a><span class="sd">        2. Our date range that we generated which is in the format of a list of strings</span>
<a id="__codelineno-0-55" name="__codelineno-0-55" href="#__codelineno-0-55"></a><span class="sd">        3. Our list of JURISDICTION_CODES</span>
<a id="__codelineno-0-56" name="__codelineno-0-56" href="#__codelineno-0-56"></a><span class="sd">        4. Our datatype (either &#39;HISTORICAL&#39; or &#39;UPCOMING&#39;). </span>
<a id="__codelineno-0-57" name="__codelineno-0-57" href="#__codelineno-0-57"></a><span class="sd">            It is important to separate these in our database to ensure that the upcoming races with lots of empty fields (like margin) do not contaminate our historical dataset.</span>
<a id="__codelineno-0-58" name="__codelineno-0-58" href="#__codelineno-0-58"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-0-59" name="__codelineno-0-59" href="#__codelineno-0-59"></a>
<a id="__codelineno-0-60" name="__codelineno-0-60" href="#__codelineno-0-60"></a>    <span class="c1"># Iterate over 10-day blocks</span>
<a id="__codelineno-0-61" name="__codelineno-0-61" href="#__codelineno-0-61"></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">date_range</span><span class="p">),</span> <span class="mi">10</span><span class="p">):</span>
<a id="__codelineno-0-62" name="__codelineno-0-62" href="#__codelineno-0-62"></a>        <span class="n">start_block_date</span> <span class="o">=</span> <span class="n">date_range</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
<a id="__codelineno-0-63" name="__codelineno-0-63" href="#__codelineno-0-63"></a>        <span class="nb">print</span><span class="p">(</span><span class="n">start_block_date</span><span class="p">)</span>
<a id="__codelineno-0-64" name="__codelineno-0-64" href="#__codelineno-0-64"></a>        <span class="n">end_block_date</span> <span class="o">=</span> <span class="n">date_range</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">9</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">date_range</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span>  <span class="c1"># Ensure the end date is within the range</span>
<a id="__codelineno-0-65" name="__codelineno-0-65" href="#__codelineno-0-65"></a>
<a id="__codelineno-0-66" name="__codelineno-0-66" href="#__codelineno-0-66"></a>
<a id="__codelineno-0-67" name="__codelineno-0-67" href="#__codelineno-0-67"></a>        <span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">codes</span><span class="p">:</span>
<a id="__codelineno-0-68" name="__codelineno-0-68" href="#__codelineno-0-68"></a>            <span class="c1"># initialise the race list</span>
<a id="__codelineno-0-69" name="__codelineno-0-69" href="#__codelineno-0-69"></a>            <span class="n">all_races</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-70" name="__codelineno-0-70" href="#__codelineno-0-70"></a>
<a id="__codelineno-0-71" name="__codelineno-0-71" href="#__codelineno-0-71"></a>            <span class="nb">print</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
<a id="__codelineno-0-72" name="__codelineno-0-72" href="#__codelineno-0-72"></a>
<a id="__codelineno-0-73" name="__codelineno-0-73" href="#__codelineno-0-73"></a>            <span class="n">retries</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c1"># Number of retries</span>
<a id="__codelineno-0-74" name="__codelineno-0-74" href="#__codelineno-0-74"></a><span class="w">            </span><span class="sd">&#39;&#39;&#39;</span>
<a id="__codelineno-0-75" name="__codelineno-0-75" href="#__codelineno-0-75"></a><span class="sd">            In this code block we are attempting to download a list of raceIds by passing our JURISDICTION_CODES and date range.</span>
<a id="__codelineno-0-76" name="__codelineno-0-76" href="#__codelineno-0-76"></a><span class="sd">            The sleep functions are included to allow time for the rate limits to reset and any other errors to clear.</span>
<a id="__codelineno-0-77" name="__codelineno-0-77" href="#__codelineno-0-77"></a><span class="sd">            The Topaz API does not return much detail in error messages and through extensive trial and error, we have found the best way to resolve errors is simply to pause for a short time and then try again.</span>
<a id="__codelineno-0-78" name="__codelineno-0-78" href="#__codelineno-0-78"></a><span class="sd">            After 10 retries, the function will move to the next block. This will usually only occur if there actually were zero races for that JURISDICTION_CODE and date_range or there is a total Topaz API outage.</span>
<a id="__codelineno-0-79" name="__codelineno-0-79" href="#__codelineno-0-79"></a><span class="sd">            &#39;&#39;&#39;</span>
<a id="__codelineno-0-80" name="__codelineno-0-80" href="#__codelineno-0-80"></a>            <span class="k">while</span> <span class="n">retries</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-81" name="__codelineno-0-81" href="#__codelineno-0-81"></a>                <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-82" name="__codelineno-0-82" href="#__codelineno-0-82"></a>                    <span class="n">races</span> <span class="o">=</span> <span class="n">topaz_api</span><span class="o">.</span><span class="n">get_races</span><span class="p">(</span><span class="n">from_date</span><span class="o">=</span><span class="n">start_block_date</span><span class="p">,</span> <span class="n">to_date</span><span class="o">=</span><span class="n">end_block_date</span><span class="p">,</span> <span class="n">owning_authority_code</span><span class="o">=</span><span class="n">code</span><span class="p">)</span>
<a id="__codelineno-0-83" name="__codelineno-0-83" href="#__codelineno-0-83"></a>                    <span class="n">all_races</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">races</span><span class="p">)</span>
<a id="__codelineno-0-84" name="__codelineno-0-84" href="#__codelineno-0-84"></a>                    <span class="k">break</span>  <span class="c1"># Break out of the loop if successful</span>
<a id="__codelineno-0-85" name="__codelineno-0-85" href="#__codelineno-0-85"></a>                <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">HTTPError</span> <span class="k">as</span> <span class="n">http_err</span><span class="p">:</span>
<a id="__codelineno-0-86" name="__codelineno-0-86" href="#__codelineno-0-86"></a>                    <span class="k">if</span> <span class="n">http_err</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">429</span><span class="p">:</span>
<a id="__codelineno-0-87" name="__codelineno-0-87" href="#__codelineno-0-87"></a>                        <span class="n">retries</span> <span class="o">-=</span> <span class="mi">1</span>
<a id="__codelineno-0-88" name="__codelineno-0-88" href="#__codelineno-0-88"></a>                        <span class="k">if</span> <span class="n">retries</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-89" name="__codelineno-0-89" href="#__codelineno-0-89"></a>                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Rate limited. Retrying in 2 minutes...&quot;</span><span class="p">)</span>
<a id="__codelineno-0-90" name="__codelineno-0-90" href="#__codelineno-0-90"></a>                            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">121</span><span class="p">)</span>
<a id="__codelineno-0-91" name="__codelineno-0-91" href="#__codelineno-0-91"></a>                        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-92" name="__codelineno-0-92" href="#__codelineno-0-92"></a>                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Max retries reached. Moving to the next block.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-93" name="__codelineno-0-93" href="#__codelineno-0-93"></a>                    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-94" name="__codelineno-0-94" href="#__codelineno-0-94"></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error fetching races for </span><span class="si">{</span><span class="n">code</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">http_err</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-95" name="__codelineno-0-95" href="#__codelineno-0-95"></a>                        <span class="n">retries</span> <span class="o">-=</span> <span class="mi">1</span>
<a id="__codelineno-0-96" name="__codelineno-0-96" href="#__codelineno-0-96"></a>                        <span class="k">if</span> <span class="n">retries</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-97" name="__codelineno-0-97" href="#__codelineno-0-97"></a>                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Retrying in 30 seconds...&quot;</span><span class="p">)</span>
<a id="__codelineno-0-98" name="__codelineno-0-98" href="#__codelineno-0-98"></a>                            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
<a id="__codelineno-0-99" name="__codelineno-0-99" href="#__codelineno-0-99"></a>                        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-100" name="__codelineno-0-100" href="#__codelineno-0-100"></a>                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Max retries reached. Moving to the next block.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-101" name="__codelineno-0-101" href="#__codelineno-0-101"></a>
<a id="__codelineno-0-102" name="__codelineno-0-102" href="#__codelineno-0-102"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-103" name="__codelineno-0-103" href="#__codelineno-0-103"></a>                <span class="n">all_races_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">all_races</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-104" name="__codelineno-0-104" href="#__codelineno-0-104"></a>            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
<a id="__codelineno-0-105" name="__codelineno-0-105" href="#__codelineno-0-105"></a>                <span class="k">continue</span>
<a id="__codelineno-0-106" name="__codelineno-0-106" href="#__codelineno-0-106"></a>
<a id="__codelineno-0-107" name="__codelineno-0-107" href="#__codelineno-0-107"></a>            <span class="c1"># Extract unique race IDs</span>
<a id="__codelineno-0-108" name="__codelineno-0-108" href="#__codelineno-0-108"></a>            <span class="n">race_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">all_races_df</span><span class="p">[</span><span class="s1">&#39;raceId&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
<a id="__codelineno-0-109" name="__codelineno-0-109" href="#__codelineno-0-109"></a>
<a id="__codelineno-0-110" name="__codelineno-0-110" href="#__codelineno-0-110"></a>            <span class="c1"># Define the file path</span>
<a id="__codelineno-0-111" name="__codelineno-0-111" href="#__codelineno-0-111"></a>            <span class="n">file_path</span> <span class="o">=</span> <span class="n">code</span> <span class="o">+</span> <span class="s1">&#39;_DATA_&#39;</span><span class="o">+</span><span class="n">datatype</span><span class="o">+</span><span class="s1">&#39;.csv&#39;</span>
<a id="__codelineno-0-112" name="__codelineno-0-112" href="#__codelineno-0-112"></a>
<a id="__codelineno-0-113" name="__codelineno-0-113" href="#__codelineno-0-113"></a>            <span class="c1"># Use tqdm to create a progress bar</span>
<a id="__codelineno-0-114" name="__codelineno-0-114" href="#__codelineno-0-114"></a>            <span class="k">for</span> <span class="n">race_id</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">race_ids</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Processing races&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;race&quot;</span><span class="p">):</span>
<a id="__codelineno-0-115" name="__codelineno-0-115" href="#__codelineno-0-115"></a>                <span class="n">result_retries</span> <span class="o">=</span> <span class="mi">10</span>
<a id="__codelineno-0-116" name="__codelineno-0-116" href="#__codelineno-0-116"></a><span class="w">                </span><span class="sd">&#39;&#39;&#39;</span>
<a id="__codelineno-0-117" name="__codelineno-0-117" href="#__codelineno-0-117"></a><span class="sd">                Here we utilise the retries function again to maximise the chances of our data being complete.</span>
<a id="__codelineno-0-118" name="__codelineno-0-118" href="#__codelineno-0-118"></a><span class="sd">                We spend some time here gathering the splitPosition and splitTime. While these fields are not utilised in the completed model, the process to extract this data has been included here for the sake of completeness only, as it is not straightforward.</span>
<a id="__codelineno-0-119" name="__codelineno-0-119" href="#__codelineno-0-119"></a>
<a id="__codelineno-0-120" name="__codelineno-0-120" href="#__codelineno-0-120"></a><span class="sd">                &#39;&#39;&#39;</span>
<a id="__codelineno-0-121" name="__codelineno-0-121" href="#__codelineno-0-121"></a>                <span class="k">while</span> <span class="n">result_retries</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-122" name="__codelineno-0-122" href="#__codelineno-0-122"></a>                    <span class="c1"># Get race run data</span>
<a id="__codelineno-0-123" name="__codelineno-0-123" href="#__codelineno-0-123"></a>                    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-124" name="__codelineno-0-124" href="#__codelineno-0-124"></a>                        <span class="n">race_run</span> <span class="o">=</span> <span class="n">topaz_api</span><span class="o">.</span><span class="n">get_race_runs</span><span class="p">(</span><span class="n">race_id</span><span class="o">=</span><span class="n">race_id</span><span class="p">)</span>
<a id="__codelineno-0-125" name="__codelineno-0-125" href="#__codelineno-0-125"></a>                        <span class="n">race_result_json</span> <span class="o">=</span> <span class="n">topaz_api</span><span class="o">.</span><span class="n">get_race_result</span><span class="p">(</span><span class="n">race_id</span><span class="o">=</span><span class="n">race_id</span><span class="p">)</span>
<a id="__codelineno-0-126" name="__codelineno-0-126" href="#__codelineno-0-126"></a>
<a id="__codelineno-0-127" name="__codelineno-0-127" href="#__codelineno-0-127"></a>                        <span class="n">file_exists</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
<a id="__codelineno-0-128" name="__codelineno-0-128" href="#__codelineno-0-128"></a>                        <span class="n">header_param</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">file_exists</span>
<a id="__codelineno-0-129" name="__codelineno-0-129" href="#__codelineno-0-129"></a>
<a id="__codelineno-0-130" name="__codelineno-0-130" href="#__codelineno-0-130"></a>                        <span class="n">race_result</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">([</span><span class="n">race_result_json</span><span class="p">])</span>
<a id="__codelineno-0-131" name="__codelineno-0-131" href="#__codelineno-0-131"></a>                        <span class="n">split_times_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">race_result</span><span class="p">[</span><span class="s1">&#39;splitTimes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span><span class="n">index</span><span class="o">=</span><span class="n">race_result</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<a id="__codelineno-0-132" name="__codelineno-0-132" href="#__codelineno-0-132"></a>
<a id="__codelineno-0-133" name="__codelineno-0-133" href="#__codelineno-0-133"></a>                        <span class="n">splits_dict</span> <span class="o">=</span> <span class="n">split_times_df</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">stack</span><span class="p">()</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span>
<a id="__codelineno-0-134" name="__codelineno-0-134" href="#__codelineno-0-134"></a>                        <span class="n">splits_dict</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-135" name="__codelineno-0-135" href="#__codelineno-0-135"></a>                        <span class="n">splits_normalised</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">json_normalize</span><span class="p">(</span><span class="n">splits_dict</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<a id="__codelineno-0-136" name="__codelineno-0-136" href="#__codelineno-0-136"></a>
<a id="__codelineno-0-137" name="__codelineno-0-137" href="#__codelineno-0-137"></a>                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">splits_normalised</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-138" name="__codelineno-0-138" href="#__codelineno-0-138"></a>                            <span class="n">race_run</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">header_param</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-139" name="__codelineno-0-139" href="#__codelineno-0-139"></a>                            <span class="k">break</span>
<a id="__codelineno-0-140" name="__codelineno-0-140" href="#__codelineno-0-140"></a>
<a id="__codelineno-0-141" name="__codelineno-0-141" href="#__codelineno-0-141"></a>                        <span class="n">first_split</span> <span class="o">=</span> <span class="n">splits_normalised</span><span class="p">[</span><span class="n">splits_normalised</span><span class="p">[</span><span class="s1">&#39;splitTimeMarker&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-0-142" name="__codelineno-0-142" href="#__codelineno-0-142"></a>                        <span class="n">first_split</span> <span class="o">=</span> <span class="n">first_split</span><span class="p">[[</span><span class="s1">&#39;runId&#39;</span><span class="p">,</span><span class="s1">&#39;position&#39;</span><span class="p">,</span><span class="s1">&#39;time&#39;</span><span class="p">]]</span>
<a id="__codelineno-0-143" name="__codelineno-0-143" href="#__codelineno-0-143"></a>                        <span class="n">first_split</span> <span class="o">=</span> <span class="n">first_split</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;position&#39;</span><span class="p">:</span><span class="s1">&#39;firstSplitPosition&#39;</span><span class="p">,</span><span class="s1">&#39;time&#39;</span><span class="p">:</span><span class="s1">&#39;firstSplitTime&#39;</span><span class="p">})</span>
<a id="__codelineno-0-144" name="__codelineno-0-144" href="#__codelineno-0-144"></a>                        <span class="n">second_split</span> <span class="o">=</span> <span class="n">splits_normalised</span><span class="p">[</span><span class="n">splits_normalised</span><span class="p">[</span><span class="s1">&#39;splitTimeMarker&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">]</span>
<a id="__codelineno-0-145" name="__codelineno-0-145" href="#__codelineno-0-145"></a>                        <span class="n">second_split</span> <span class="o">=</span> <span class="n">second_split</span><span class="p">[[</span><span class="s1">&#39;runId&#39;</span><span class="p">,</span><span class="s1">&#39;position&#39;</span><span class="p">,</span><span class="s1">&#39;time&#39;</span><span class="p">]]</span>
<a id="__codelineno-0-146" name="__codelineno-0-146" href="#__codelineno-0-146"></a>                        <span class="n">second_split</span> <span class="o">=</span> <span class="n">second_split</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;position&#39;</span><span class="p">:</span><span class="s1">&#39;secondSplitPosition&#39;</span><span class="p">,</span><span class="s1">&#39;time&#39;</span><span class="p">:</span><span class="s1">&#39;secondSplitTime&#39;</span><span class="p">})</span>
<a id="__codelineno-0-147" name="__codelineno-0-147" href="#__codelineno-0-147"></a>
<a id="__codelineno-0-148" name="__codelineno-0-148" href="#__codelineno-0-148"></a>                        <span class="n">split_times</span> <span class="o">=</span> <span class="n">splits_normalised</span><span class="p">[[</span><span class="s1">&#39;runId&#39;</span><span class="p">]]</span>
<a id="__codelineno-0-149" name="__codelineno-0-149" href="#__codelineno-0-149"></a>                        <span class="n">split_times</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">split_times</span><span class="p">,</span><span class="n">first_split</span><span class="p">,</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span><span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;runId&#39;</span><span class="p">])</span>
<a id="__codelineno-0-150" name="__codelineno-0-150" href="#__codelineno-0-150"></a>                        <span class="n">split_times</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">split_times</span><span class="p">,</span><span class="n">second_split</span><span class="p">,</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span><span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;runId&#39;</span><span class="p">])</span>
<a id="__codelineno-0-151" name="__codelineno-0-151" href="#__codelineno-0-151"></a>
<a id="__codelineno-0-152" name="__codelineno-0-152" href="#__codelineno-0-152"></a>                        <span class="n">race_run</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">race_run</span><span class="p">,</span><span class="n">split_times</span><span class="p">,</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span><span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;runId&#39;</span><span class="p">])</span>
<a id="__codelineno-0-153" name="__codelineno-0-153" href="#__codelineno-0-153"></a>                        <span class="n">race_run</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-154" name="__codelineno-0-154" href="#__codelineno-0-154"></a>                        <span class="n">race_run</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">header_param</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-155" name="__codelineno-0-155" href="#__codelineno-0-155"></a>                        <span class="k">break</span>
<a id="__codelineno-0-156" name="__codelineno-0-156" href="#__codelineno-0-156"></a>                    <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">HTTPError</span> <span class="k">as</span> <span class="n">http_err</span><span class="p">:</span>
<a id="__codelineno-0-157" name="__codelineno-0-157" href="#__codelineno-0-157"></a>                        <span class="k">if</span> <span class="n">http_err</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">404</span><span class="p">:</span>
<a id="__codelineno-0-158" name="__codelineno-0-158" href="#__codelineno-0-158"></a>                            <span class="n">file_exists</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
<a id="__codelineno-0-159" name="__codelineno-0-159" href="#__codelineno-0-159"></a>                            <span class="n">header_param</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">file_exists</span>
<a id="__codelineno-0-160" name="__codelineno-0-160" href="#__codelineno-0-160"></a>                            <span class="n">race_run</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">header_param</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-161" name="__codelineno-0-161" href="#__codelineno-0-161"></a>                            <span class="k">break</span>
<a id="__codelineno-0-162" name="__codelineno-0-162" href="#__codelineno-0-162"></a>                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-163" name="__codelineno-0-163" href="#__codelineno-0-163"></a>                        <span class="nb">print</span><span class="p">(</span><span class="n">race_id</span><span class="p">)</span>
<a id="__codelineno-0-164" name="__codelineno-0-164" href="#__codelineno-0-164"></a>                        <span class="n">result_retries</span> <span class="o">-=</span> <span class="mi">1</span>
<a id="__codelineno-0-165" name="__codelineno-0-165" href="#__codelineno-0-165"></a>                        <span class="k">if</span> <span class="n">result_retries</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-166" name="__codelineno-0-166" href="#__codelineno-0-166"></a>                            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
<a id="__codelineno-0-167" name="__codelineno-0-167" href="#__codelineno-0-167"></a>                        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-168" name="__codelineno-0-168" href="#__codelineno-0-168"></a>                            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">120</span><span class="p">)</span>
</code></pre></div>
<hr />
<p>The Topaz race results endpoint requires the passing of a jurisdiction ID as a parameter to pull the results. Simply passing a date range will return no data. This is why we have looped over all jurisdictions in 10 day blocks.</p>
<p>Bulk downloading the historical data in this way may take a while depending on how many years of data you are requesting. Bruno, the author of one of our previous greyhound modelling tutorials, uses 6 years worth of data for his backtesting. This however is computationally expensive to process in a machine learning model, so we suggest 2-3 years for those just starting out. </p>
<p>NOTE: In the above code we have exported each state separately to its own csv file. This will keep each file under a million rows ensuring that you can manually inspect the data by opening the file in Excel. This is not required (we will pull in each file to our model before we begin to process the data)</p>
<h2 id="cleaning-the-data">Cleaning the data</h2>
<p>Let's pull all of our state files and get cleaning on this data!</p>
<div class="highlight"><span class="filename">Cleaning The Data</span><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="k">def</span> <span class="nf">collect_topaz_data</span><span class="p">(</span><span class="n">api_key</span><span class="p">,</span><span class="n">codes</span><span class="p">,</span><span class="n">start_date</span><span class="p">,</span><span class="n">end_date</span><span class="p">,</span><span class="n">datatype</span><span class="p">):</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="sd">    This function here combines our three previously defined functions into one neat function in the correct order of execution.</span>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="sd">    As the data is written to csv files, we do not need to return anything at the end of the function. This also means that it is not necessary to define a variable as the output of a function</span>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a>    <span class="n">date_range</span> <span class="o">=</span> <span class="n">generate_date_range</span><span class="p">(</span><span class="n">start_date</span><span class="p">,</span><span class="n">end_date</span><span class="p">)</span>
<a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a>
<a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a>    <span class="n">topaz_api</span> <span class="o">=</span> <span class="n">define_topaz_api</span><span class="p">(</span><span class="n">api_key</span><span class="p">)</span>
<a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a>
<a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a>    <span class="n">download_topaz_data</span><span class="p">(</span><span class="n">topaz_api</span><span class="p">,</span><span class="n">date_range</span><span class="p">,</span><span class="n">codes</span><span class="p">,</span><span class="n">datatype</span><span class="p">)</span>
<a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a>
<a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a><span class="n">collect_topaz_data</span><span class="p">(</span><span class="n">TOPAZ_API_KEY</span><span class="p">,</span><span class="n">JURISDICTION_CODES</span><span class="p">,</span><span class="n">start_date</span><span class="p">,</span><span class="n">end_date</span><span class="p">,</span><span class="s1">&#39;HISTORICAL&#39;</span><span class="p">)</span>
<a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a>
<a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a><span class="k">def</span> <span class="nf">load_topaz_data</span><span class="p">(</span><span class="n">codes</span><span class="p">,</span><span class="n">datatype</span><span class="p">):</span>
<a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<a id="__codelineno-1-16" name="__codelineno-1-16" href="#__codelineno-1-16"></a><span class="sd">    This function here will loop over our previously written csv files and load them into one dataframe.</span>
<a id="__codelineno-1-17" name="__codelineno-1-17" href="#__codelineno-1-17"></a><span class="sd">    Due to the time taken to gather data from the Topaz API and the sheer size of the files, it makes sense to store the Topaz data locally as csv files locally rather than as a variable in the operating environment.</span>
<a id="__codelineno-1-18" name="__codelineno-1-18" href="#__codelineno-1-18"></a><span class="sd">    If the python kernel needs to be reset for whatever reason, all stored variables are lost - so storing the data in csv files means we can just load up the files directly rather than spending another 24 hours re-downloading all the data</span>
<a id="__codelineno-1-19" name="__codelineno-1-19" href="#__codelineno-1-19"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-1-20" name="__codelineno-1-20" href="#__codelineno-1-20"></a>    <span class="c1"># initialise the dataframe</span>
<a id="__codelineno-1-21" name="__codelineno-1-21" href="#__codelineno-1-21"></a>    <span class="n">TopazDataAll</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
<a id="__codelineno-1-22" name="__codelineno-1-22" href="#__codelineno-1-22"></a>
<a id="__codelineno-1-23" name="__codelineno-1-23" href="#__codelineno-1-23"></a>    <span class="c1"># loop over all csv files</span>
<a id="__codelineno-1-24" name="__codelineno-1-24" href="#__codelineno-1-24"></a>    <span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">codes</span><span class="p">:</span>
<a id="__codelineno-1-25" name="__codelineno-1-25" href="#__codelineno-1-25"></a>        <span class="c1"># Read the csv force two columns into datetime format</span>
<a id="__codelineno-1-26" name="__codelineno-1-26" href="#__codelineno-1-26"></a>        <span class="n">StateData</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">code</span><span class="o">+</span><span class="s1">&#39;_DATA_&#39;</span><span class="o">+</span><span class="n">datatype</span><span class="o">+</span><span class="s1">&#39;.csv&#39;</span><span class="p">,</span><span class="n">low_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">parse_dates</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;meetingDate&#39;</span><span class="p">,</span><span class="s1">&#39;dateWhelped&#39;</span><span class="p">])</span>
<a id="__codelineno-1-27" name="__codelineno-1-27" href="#__codelineno-1-27"></a>        <span class="c1"># Add the state as a column</span>
<a id="__codelineno-1-28" name="__codelineno-1-28" href="#__codelineno-1-28"></a>        <span class="n">StateData</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">code</span>
<a id="__codelineno-1-29" name="__codelineno-1-29" href="#__codelineno-1-29"></a>        <span class="c1"># Concatenate the dataframes</span>
<a id="__codelineno-1-30" name="__codelineno-1-30" href="#__codelineno-1-30"></a>        <span class="n">TopazDataAll</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">TopazDataAll</span><span class="p">,</span><span class="n">StateData</span><span class="p">])</span>
<a id="__codelineno-1-31" name="__codelineno-1-31" href="#__codelineno-1-31"></a>
<a id="__codelineno-1-32" name="__codelineno-1-32" href="#__codelineno-1-32"></a>    <span class="k">return</span> <span class="n">TopazDataAll</span>
<a id="__codelineno-1-33" name="__codelineno-1-33" href="#__codelineno-1-33"></a>
<a id="__codelineno-1-34" name="__codelineno-1-34" href="#__codelineno-1-34"></a><span class="sd">&#39;&#39;&#39;</span>
<a id="__codelineno-1-35" name="__codelineno-1-35" href="#__codelineno-1-35"></a><span class="sd">Because this new function returns a dataframe as the output, we need to define the output of the function as a named variable. This name can be different to the name of the variable named after the &#39;return&#39; operation.</span>
<a id="__codelineno-1-36" name="__codelineno-1-36" href="#__codelineno-1-36"></a><span class="sd">Simply calling the function without assigning the output as a variable will result in the function&#39;s output not being defined which will affect our downstream operations.</span>
<a id="__codelineno-1-37" name="__codelineno-1-37" href="#__codelineno-1-37"></a><span class="sd">&#39;&#39;&#39;</span>
<a id="__codelineno-1-38" name="__codelineno-1-38" href="#__codelineno-1-38"></a>
<a id="__codelineno-1-39" name="__codelineno-1-39" href="#__codelineno-1-39"></a><span class="n">TopazDataAll</span> <span class="o">=</span> <span class="n">load_topaz_data</span><span class="p">(</span><span class="n">JURISDICTION_CODES</span><span class="p">,</span><span class="s1">&#39;HISTORICAL&#39;</span><span class="p">)</span>
<a id="__codelineno-1-40" name="__codelineno-1-40" href="#__codelineno-1-40"></a>
<a id="__codelineno-1-41" name="__codelineno-1-41" href="#__codelineno-1-41"></a><span class="k">def</span> <span class="nf">discard_scratched_runners_data</span><span class="p">(</span><span class="n">TopazDataAll</span><span class="p">):</span>
<a id="__codelineno-1-42" name="__codelineno-1-42" href="#__codelineno-1-42"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<a id="__codelineno-1-43" name="__codelineno-1-43" href="#__codelineno-1-43"></a><span class="sd">    This function will discard all scratched runners and abandoned races by dropping all rows where place = None</span>
<a id="__codelineno-1-44" name="__codelineno-1-44" href="#__codelineno-1-44"></a><span class="sd">    Note that this should only be done for past races, as upcoming races will also have place = None, because they have not been run yet, and so dropping these would remove all upcoming races</span>
<a id="__codelineno-1-45" name="__codelineno-1-45" href="#__codelineno-1-45"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-1-46" name="__codelineno-1-46" href="#__codelineno-1-46"></a>    <span class="c1"># Discard scratched runners and abandoned races</span>
<a id="__codelineno-1-47" name="__codelineno-1-47" href="#__codelineno-1-47"></a>    <span class="n">TopazDataAll</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;place&#39;</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-1-48" name="__codelineno-1-48" href="#__codelineno-1-48"></a>
<a id="__codelineno-1-49" name="__codelineno-1-49" href="#__codelineno-1-49"></a>    <span class="k">return</span> <span class="n">TopazDataAll</span>
<a id="__codelineno-1-50" name="__codelineno-1-50" href="#__codelineno-1-50"></a>
<a id="__codelineno-1-51" name="__codelineno-1-51" href="#__codelineno-1-51"></a><span class="n">TOPAZ_COLUMNS_TO_KEEP</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">,</span>    
<a id="__codelineno-1-52" name="__codelineno-1-52" href="#__codelineno-1-52"></a>                        <span class="s1">&#39;track&#39;</span><span class="p">,</span>
<a id="__codelineno-1-53" name="__codelineno-1-53" href="#__codelineno-1-53"></a>                        <span class="s1">&#39;distance&#39;</span><span class="p">,</span>
<a id="__codelineno-1-54" name="__codelineno-1-54" href="#__codelineno-1-54"></a>                        <span class="s1">&#39;raceId&#39;</span><span class="p">,</span>
<a id="__codelineno-1-55" name="__codelineno-1-55" href="#__codelineno-1-55"></a>                        <span class="s1">&#39;meetingDate&#39;</span><span class="p">,</span>
<a id="__codelineno-1-56" name="__codelineno-1-56" href="#__codelineno-1-56"></a>                        <span class="s1">&#39;raceTypeCode&#39;</span><span class="p">,</span>
<a id="__codelineno-1-57" name="__codelineno-1-57" href="#__codelineno-1-57"></a>                        <span class="s1">&#39;runId&#39;</span><span class="p">,</span>
<a id="__codelineno-1-58" name="__codelineno-1-58" href="#__codelineno-1-58"></a>                        <span class="s1">&#39;dogId&#39;</span><span class="p">,</span>
<a id="__codelineno-1-59" name="__codelineno-1-59" href="#__codelineno-1-59"></a>                        <span class="s1">&#39;dogName&#39;</span><span class="p">,</span>
<a id="__codelineno-1-60" name="__codelineno-1-60" href="#__codelineno-1-60"></a>                        <span class="s1">&#39;weightInKg&#39;</span><span class="p">,</span>
<a id="__codelineno-1-61" name="__codelineno-1-61" href="#__codelineno-1-61"></a>                        <span class="s1">&#39;gradedTo&#39;</span><span class="p">,</span>
<a id="__codelineno-1-62" name="__codelineno-1-62" href="#__codelineno-1-62"></a>                        <span class="s1">&#39;rating&#39;</span><span class="p">,</span>
<a id="__codelineno-1-63" name="__codelineno-1-63" href="#__codelineno-1-63"></a>                        <span class="s1">&#39;raceNumber&#39;</span><span class="p">,</span>
<a id="__codelineno-1-64" name="__codelineno-1-64" href="#__codelineno-1-64"></a>                        <span class="s1">&#39;boxNumber&#39;</span><span class="p">,</span>
<a id="__codelineno-1-65" name="__codelineno-1-65" href="#__codelineno-1-65"></a>                        <span class="s1">&#39;rugNumber&#39;</span><span class="p">,</span>
<a id="__codelineno-1-66" name="__codelineno-1-66" href="#__codelineno-1-66"></a>                        <span class="s1">&#39;sex&#39;</span><span class="p">,</span>
<a id="__codelineno-1-67" name="__codelineno-1-67" href="#__codelineno-1-67"></a>                        <span class="s1">&#39;trainerId&#39;</span><span class="p">,</span>
<a id="__codelineno-1-68" name="__codelineno-1-68" href="#__codelineno-1-68"></a>                        <span class="s1">&#39;trainerState&#39;</span><span class="p">,</span>
<a id="__codelineno-1-69" name="__codelineno-1-69" href="#__codelineno-1-69"></a>                        <span class="s1">&#39;damId&#39;</span><span class="p">,</span>
<a id="__codelineno-1-70" name="__codelineno-1-70" href="#__codelineno-1-70"></a>                        <span class="s1">&#39;damName&#39;</span><span class="p">,</span>
<a id="__codelineno-1-71" name="__codelineno-1-71" href="#__codelineno-1-71"></a>                        <span class="s1">&#39;sireId&#39;</span><span class="p">,</span>
<a id="__codelineno-1-72" name="__codelineno-1-72" href="#__codelineno-1-72"></a>                        <span class="s1">&#39;sireName&#39;</span><span class="p">,</span>
<a id="__codelineno-1-73" name="__codelineno-1-73" href="#__codelineno-1-73"></a>                        <span class="s1">&#39;dateWhelped&#39;</span><span class="p">,</span>
<a id="__codelineno-1-74" name="__codelineno-1-74" href="#__codelineno-1-74"></a>                        <span class="s1">&#39;last5&#39;</span><span class="p">,</span>
<a id="__codelineno-1-75" name="__codelineno-1-75" href="#__codelineno-1-75"></a>                        <span class="s1">&#39;pir&#39;</span><span class="p">,</span>
<a id="__codelineno-1-76" name="__codelineno-1-76" href="#__codelineno-1-76"></a>                        <span class="s1">&#39;place&#39;</span><span class="p">,</span>
<a id="__codelineno-1-77" name="__codelineno-1-77" href="#__codelineno-1-77"></a>                        <span class="s1">&#39;prizeMoney&#39;</span><span class="p">,</span>
<a id="__codelineno-1-78" name="__codelineno-1-78" href="#__codelineno-1-78"></a>                        <span class="s1">&#39;resultTime&#39;</span><span class="p">,</span>
<a id="__codelineno-1-79" name="__codelineno-1-79" href="#__codelineno-1-79"></a>                        <span class="s1">&#39;resultMargin&#39;</span><span class="p">]</span>
<a id="__codelineno-1-80" name="__codelineno-1-80" href="#__codelineno-1-80"></a>
<a id="__codelineno-1-81" name="__codelineno-1-81" href="#__codelineno-1-81"></a><span class="k">def</span> <span class="nf">discard_unnecessary_columns</span><span class="p">(</span><span class="n">TopazDataAll</span><span class="p">,</span><span class="n">columns</span><span class="p">):</span>
<a id="__codelineno-1-82" name="__codelineno-1-82" href="#__codelineno-1-82"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<a id="__codelineno-1-83" name="__codelineno-1-83" href="#__codelineno-1-83"></a><span class="sd">    This function serves to keep only the subset of columns that we will use for our model.</span>
<a id="__codelineno-1-84" name="__codelineno-1-84" href="#__codelineno-1-84"></a><span class="sd">    Columns have been discarded because:</span>
<a id="__codelineno-1-85" name="__codelineno-1-85" href="#__codelineno-1-85"></a><span class="sd">     - All entries are identical or null</span>
<a id="__codelineno-1-86" name="__codelineno-1-86" href="#__codelineno-1-86"></a><span class="sd">     - Entries are duplicates of another column - simply being abbreviated in this column</span>
<a id="__codelineno-1-87" name="__codelineno-1-87" href="#__codelineno-1-87"></a><span class="sd">     - Entries contain data leakage which is data that has been added after the race has been run and would not be available for a live model</span>
<a id="__codelineno-1-88" name="__codelineno-1-88" href="#__codelineno-1-88"></a><span class="sd">     - Significant amounts of missing data</span>
<a id="__codelineno-1-89" name="__codelineno-1-89" href="#__codelineno-1-89"></a>
<a id="__codelineno-1-90" name="__codelineno-1-90" href="#__codelineno-1-90"></a><span class="sd">    Duplicate rows have also been discarded. These rows may exist if the collect_topaz_data function has been run for the same date more than once.</span>
<a id="__codelineno-1-91" name="__codelineno-1-91" href="#__codelineno-1-91"></a><span class="sd">    Each race a dog runs will have a unique runId which is why this column is ideal for identifying duplicates</span>
<a id="__codelineno-1-92" name="__codelineno-1-92" href="#__codelineno-1-92"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-1-93" name="__codelineno-1-93" href="#__codelineno-1-93"></a>    <span class="c1"># Keep the required columns</span>
<a id="__codelineno-1-94" name="__codelineno-1-94" href="#__codelineno-1-94"></a>    <span class="n">TopazData</span> <span class="o">=</span> <span class="n">TopazDataAll</span><span class="p">[</span><span class="n">columns</span><span class="p">]</span>
<a id="__codelineno-1-95" name="__codelineno-1-95" href="#__codelineno-1-95"></a>
<a id="__codelineno-1-96" name="__codelineno-1-96" href="#__codelineno-1-96"></a>    <span class="c1"># Drop duplicate runIds</span>
<a id="__codelineno-1-97" name="__codelineno-1-97" href="#__codelineno-1-97"></a>    <span class="n">TopazData</span> <span class="o">=</span> <span class="n">TopazData</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;runId&#39;</span><span class="p">])</span>
<a id="__codelineno-1-98" name="__codelineno-1-98" href="#__codelineno-1-98"></a>
<a id="__codelineno-1-99" name="__codelineno-1-99" href="#__codelineno-1-99"></a>    <span class="c1"># Reset the index</span>
<a id="__codelineno-1-100" name="__codelineno-1-100" href="#__codelineno-1-100"></a>    <span class="n">TopazData</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-1-101" name="__codelineno-1-101" href="#__codelineno-1-101"></a>
<a id="__codelineno-1-102" name="__codelineno-1-102" href="#__codelineno-1-102"></a>    <span class="k">return</span> <span class="n">TopazData</span>
<a id="__codelineno-1-103" name="__codelineno-1-103" href="#__codelineno-1-103"></a>
<a id="__codelineno-1-104" name="__codelineno-1-104" href="#__codelineno-1-104"></a><span class="n">TopazDataAll</span> <span class="o">=</span> <span class="n">discard_scratched_runners_data</span><span class="p">(</span><span class="n">TopazDataAll</span><span class="p">)</span>
<a id="__codelineno-1-105" name="__codelineno-1-105" href="#__codelineno-1-105"></a><span class="n">TopazData</span> <span class="o">=</span> <span class="n">discard_unnecessary_columns</span><span class="p">(</span><span class="n">TopazDataAll</span><span class="p">,</span><span class="n">TOPAZ_COLUMNS_TO_KEEP</span><span class="p">)</span>
<a id="__codelineno-1-106" name="__codelineno-1-106" href="#__codelineno-1-106"></a>
<a id="__codelineno-1-107" name="__codelineno-1-107" href="#__codelineno-1-107"></a><span class="c1"># Let&#39;s correct the track names to align with Betfair names (Not all tracks in Topaz are on the exchange due to being closed or not hosting TAB-meetings)</span>
<a id="__codelineno-1-108" name="__codelineno-1-108" href="#__codelineno-1-108"></a><span class="c1"># We&#39;re not using the NZ tracks in this tutorial, however they are included below for completeness</span>
<a id="__codelineno-1-109" name="__codelineno-1-109" href="#__codelineno-1-109"></a><span class="c1"># The &quot;Straight&quot; tracks at Murray Bridge and Richmond are not differentiated on Betfair but we can treat these later.</span>
<a id="__codelineno-1-110" name="__codelineno-1-110" href="#__codelineno-1-110"></a>
<a id="__codelineno-1-111" name="__codelineno-1-111" href="#__codelineno-1-111"></a><span class="n">TRACK_DICTIONARY</span><span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-1-112" name="__codelineno-1-112" href="#__codelineno-1-112"></a>                    <span class="s1">&#39;Auckland (NZ)&#39;</span><span class="p">:</span><span class="s1">&#39;Manukau&#39;</span><span class="p">,</span>
<a id="__codelineno-1-113" name="__codelineno-1-113" href="#__codelineno-1-113"></a>                    <span class="s1">&#39;Christchurch (NZ)&#39;</span><span class="p">:</span><span class="s1">&#39;Addington&#39;</span><span class="p">,</span>
<a id="__codelineno-1-114" name="__codelineno-1-114" href="#__codelineno-1-114"></a>                    <span class="s1">&#39;Dport @ HOB&#39;</span><span class="p">:</span><span class="s1">&#39;Hobart&#39;</span><span class="p">,</span>
<a id="__codelineno-1-115" name="__codelineno-1-115" href="#__codelineno-1-115"></a>                    <span class="s1">&#39;Dport @ LCN&#39;</span><span class="p">:</span><span class="s1">&#39;Launceston&#39;</span><span class="p">,</span>
<a id="__codelineno-1-116" name="__codelineno-1-116" href="#__codelineno-1-116"></a>                    <span class="s1">&#39;Meadows (MEP)&#39;</span><span class="p">:</span><span class="s1">&#39;The Meadows&#39;</span><span class="p">,</span>
<a id="__codelineno-1-117" name="__codelineno-1-117" href="#__codelineno-1-117"></a>                    <span class="s1">&#39;Otago (NZ)&#39;</span><span class="p">:</span><span class="s1">&#39;Forbury Park&#39;</span><span class="p">,</span>
<a id="__codelineno-1-118" name="__codelineno-1-118" href="#__codelineno-1-118"></a>                    <span class="s1">&#39;Palmerston Nth (NZ)&#39;</span><span class="p">:</span><span class="s1">&#39;Manawatu&#39;</span><span class="p">,</span>
<a id="__codelineno-1-119" name="__codelineno-1-119" href="#__codelineno-1-119"></a>                    <span class="s1">&#39;Sandown (SAP)&#39;</span><span class="p">:</span><span class="s1">&#39;Sandown Park&#39;</span><span class="p">,</span>
<a id="__codelineno-1-120" name="__codelineno-1-120" href="#__codelineno-1-120"></a>                    <span class="s1">&#39;Southland (NZ)&#39;</span><span class="p">:</span><span class="s1">&#39;Ascot Park&#39;</span><span class="p">,</span>
<a id="__codelineno-1-121" name="__codelineno-1-121" href="#__codelineno-1-121"></a>                    <span class="s1">&#39;Tokoroa (NZ)&#39;</span><span class="p">:</span><span class="s1">&#39;Tokoroa&#39;</span><span class="p">,</span>
<a id="__codelineno-1-122" name="__codelineno-1-122" href="#__codelineno-1-122"></a>                    <span class="s1">&#39;Waikato (NZ)&#39;</span><span class="p">:</span><span class="s1">&#39;Cambridge&#39;</span><span class="p">,</span>
<a id="__codelineno-1-123" name="__codelineno-1-123" href="#__codelineno-1-123"></a>                    <span class="s1">&#39;Wanganui (NZ)&#39;</span><span class="p">:</span><span class="s1">&#39;Hatrick&#39;</span><span class="p">,</span>
<a id="__codelineno-1-124" name="__codelineno-1-124" href="#__codelineno-1-124"></a>                    <span class="s1">&#39;Taranaki (NZ)&#39;</span><span class="p">:</span><span class="s1">&#39;Taranaki&#39;</span><span class="p">,</span>
<a id="__codelineno-1-125" name="__codelineno-1-125" href="#__codelineno-1-125"></a>                    <span class="s1">&#39;Ashburton (NZ)&#39;</span><span class="p">:</span><span class="s1">&#39;Ashburton&#39;</span><span class="p">,</span>
<a id="__codelineno-1-126" name="__codelineno-1-126" href="#__codelineno-1-126"></a>                    <span class="s1">&#39;Richmond (RIS)&#39;</span><span class="p">:</span><span class="s1">&#39;Richmond&#39;</span><span class="p">,</span>
<a id="__codelineno-1-127" name="__codelineno-1-127" href="#__codelineno-1-127"></a>                    <span class="s1">&#39;Murray Bridge (MBR)&#39;</span><span class="p">:</span><span class="s1">&#39;Murray Bridge&#39;</span><span class="p">,</span>
<a id="__codelineno-1-128" name="__codelineno-1-128" href="#__codelineno-1-128"></a>                    <span class="s1">&#39;Murray Bridge (MBS)&#39;</span><span class="p">:</span><span class="s1">&#39;Murray Bridge&#39;</span>
<a id="__codelineno-1-129" name="__codelineno-1-129" href="#__codelineno-1-129"></a>                    <span class="p">}</span>
<a id="__codelineno-1-130" name="__codelineno-1-130" href="#__codelineno-1-130"></a>
<a id="__codelineno-1-131" name="__codelineno-1-131" href="#__codelineno-1-131"></a><span class="k">def</span> <span class="nf">clean_track_data</span><span class="p">(</span><span class="n">TopazData</span><span class="p">,</span><span class="n">TrackDict</span><span class="p">):</span>
<a id="__codelineno-1-132" name="__codelineno-1-132" href="#__codelineno-1-132"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<a id="__codelineno-1-133" name="__codelineno-1-133" href="#__codelineno-1-133"></a><span class="sd">    This function replaces the track names in Topaz with the track names as they are displayed on the Betfair Exchange.</span>
<a id="__codelineno-1-134" name="__codelineno-1-134" href="#__codelineno-1-134"></a><span class="sd">    This is important for performing our historical backtesting later on</span>
<a id="__codelineno-1-135" name="__codelineno-1-135" href="#__codelineno-1-135"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-1-136" name="__codelineno-1-136" href="#__codelineno-1-136"></a>    <span class="n">TopazData</span><span class="p">[</span><span class="s1">&#39;track&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">TopazData</span><span class="p">[</span><span class="s1">&#39;track&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">TrackDict</span><span class="p">)</span>
<a id="__codelineno-1-137" name="__codelineno-1-137" href="#__codelineno-1-137"></a>
<a id="__codelineno-1-138" name="__codelineno-1-138" href="#__codelineno-1-138"></a>    <span class="k">return</span> <span class="n">TopazData</span>
<a id="__codelineno-1-139" name="__codelineno-1-139" href="#__codelineno-1-139"></a>
<a id="__codelineno-1-140" name="__codelineno-1-140" href="#__codelineno-1-140"></a><span class="n">TopazData</span> <span class="o">=</span> <span class="n">clean_track_data</span><span class="p">(</span><span class="n">TopazData</span><span class="p">,</span><span class="n">TRACK_DICTIONARY</span><span class="p">)</span>
<a id="__codelineno-1-141" name="__codelineno-1-141" href="#__codelineno-1-141"></a>
<a id="__codelineno-1-142" name="__codelineno-1-142" href="#__codelineno-1-142"></a><span class="k">def</span> <span class="nf">correct_result_margin</span><span class="p">(</span><span class="n">TopazData</span><span class="p">):</span>
<a id="__codelineno-1-143" name="__codelineno-1-143" href="#__codelineno-1-143"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<a id="__codelineno-1-144" name="__codelineno-1-144" href="#__codelineno-1-144"></a><span class="sd">    resultMargin has the same value for 1st and 2nd placed dogs, but should be 0 for the 1st placed dog.</span>
<a id="__codelineno-1-145" name="__codelineno-1-145" href="#__codelineno-1-145"></a><span class="sd">    This function simply replaces the entered value for resultMargin with 0 if the place value = 1</span>
<a id="__codelineno-1-146" name="__codelineno-1-146" href="#__codelineno-1-146"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-1-147" name="__codelineno-1-147" href="#__codelineno-1-147"></a>    <span class="c1"># Replace margin to make sense for our model</span>
<a id="__codelineno-1-148" name="__codelineno-1-148" href="#__codelineno-1-148"></a>    <span class="n">TopazData</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">TopazData</span><span class="p">[</span><span class="s1">&#39;place&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;resultMargin&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-1-149" name="__codelineno-1-149" href="#__codelineno-1-149"></a>
<a id="__codelineno-1-150" name="__codelineno-1-150" href="#__codelineno-1-150"></a>    <span class="k">return</span> <span class="n">TopazData</span>
<a id="__codelineno-1-151" name="__codelineno-1-151" href="#__codelineno-1-151"></a>
<a id="__codelineno-1-152" name="__codelineno-1-152" href="#__codelineno-1-152"></a><span class="n">TopazData</span> <span class="o">=</span> <span class="n">correct_result_margin</span><span class="p">(</span><span class="n">TopazData</span><span class="p">)</span>
</code></pre></div>
<p>Here we've cleaned our dataset as much as we can. Next it's on to the feature creation!</p>
<h2 id="create-the-features">Create the features</h2>
<p><div class="highlight"><span class="filename">Creating Basic Features</span><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="k">def</span> <span class="nf">generate_dogAge</span><span class="p">(</span><span class="n">TopazData</span><span class="p">):</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="sd">    This function creates a dogAge variable by subtracting the race date from the dateWhelped (i.e. date of birth).</span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a>    <span class="c1"># Subtract dateWhelped from meetingDate</span>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a>    <span class="n">TopazData</span><span class="p">[</span><span class="s1">&#39;dogAge&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">TopazData</span><span class="p">[</span><span class="s1">&#39;meetingDate&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">TopazData</span><span class="p">[</span><span class="s1">&#39;dateWhelped&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">days</span>
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a>
<a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a>    <span class="k">return</span> <span class="n">TopazData</span>
<a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a>
<a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a><span class="n">TopazData</span> <span class="o">=</span> <span class="n">generate_dogAge</span><span class="p">(</span><span class="n">TopazData</span><span class="p">)</span>
<a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a>
<a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a><span class="n">LAST_FIVE_RACE_COLUMNS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;posL1R&#39;</span><span class="p">,</span> <span class="s1">&#39;posL2R&#39;</span><span class="p">,</span> <span class="s1">&#39;posL3R&#39;</span><span class="p">,</span><span class="s1">&#39;posL4R&#39;</span><span class="p">,</span> <span class="s1">&#39;posL5R&#39;</span><span class="p">]</span>
<a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a>
<a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a><span class="k">def</span> <span class="nf">extract_form</span><span class="p">(</span><span class="n">TopazData</span><span class="p">):</span>
<a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a>
<a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39; </span>
<a id="__codelineno-2-17" name="__codelineno-2-17" href="#__codelineno-2-17"></a><span class="sd">    This function splits the last5 variable, which is a column of 5 characters or less that contain the dogs finishing position in the last 5 races. </span>
<a id="__codelineno-2-18" name="__codelineno-2-18" href="#__codelineno-2-18"></a><span class="sd">    First we define it as a string in order to extract all the characters, as some of them may be letters (e.g. F = Fell, D = Disqualified)</span>
<a id="__codelineno-2-19" name="__codelineno-2-19" href="#__codelineno-2-19"></a>
<a id="__codelineno-2-20" name="__codelineno-2-20" href="#__codelineno-2-20"></a><span class="sd">    We then create five seperate columns for each race, and fill any blank cells with 10. Cells may be blank because the dog could have run fewer than 5 previous races.</span>
<a id="__codelineno-2-21" name="__codelineno-2-21" href="#__codelineno-2-21"></a><span class="sd">    We have chosen 10 as the padding value because a greyhound can never finish in 10th place owing to the maximum field size of 8 in greyhound racing.</span>
<a id="__codelineno-2-22" name="__codelineno-2-22" href="#__codelineno-2-22"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-2-23" name="__codelineno-2-23" href="#__codelineno-2-23"></a>    <span class="c1"># Ensure variable is a string</span>
<a id="__codelineno-2-24" name="__codelineno-2-24" href="#__codelineno-2-24"></a>    <span class="n">TopazData</span><span class="p">[</span><span class="s1">&#39;last5&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">TopazData</span><span class="p">[</span><span class="s1">&#39;last5&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
<a id="__codelineno-2-25" name="__codelineno-2-25" href="#__codelineno-2-25"></a>    <span class="c1"># Function to extract numbers from the &#39;last5&#39; column</span>
<a id="__codelineno-2-26" name="__codelineno-2-26" href="#__codelineno-2-26"></a>    <span class="k">def</span> <span class="nf">extract_numbers</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
<a id="__codelineno-2-27" name="__codelineno-2-27" href="#__codelineno-2-27"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-2-28" name="__codelineno-2-28" href="#__codelineno-2-28"></a>            <span class="n">numbers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)))</span>
<a id="__codelineno-2-29" name="__codelineno-2-29" href="#__codelineno-2-29"></a>            <span class="c1"># If there are fewer than 5 numbers, pad with tens</span>
<a id="__codelineno-2-30" name="__codelineno-2-30" href="#__codelineno-2-30"></a>            <span class="n">numbers</span> <span class="o">+=</span> <span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">5</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">numbers</span><span class="p">))</span>
<a id="__codelineno-2-31" name="__codelineno-2-31" href="#__codelineno-2-31"></a>            <span class="k">return</span> <span class="n">numbers</span>
<a id="__codelineno-2-32" name="__codelineno-2-32" href="#__codelineno-2-32"></a>        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
<a id="__codelineno-2-33" name="__codelineno-2-33" href="#__codelineno-2-33"></a>            <span class="c1"># Handle the case where the string cannot be split into integers</span>
<a id="__codelineno-2-34" name="__codelineno-2-34" href="#__codelineno-2-34"></a>            <span class="k">return</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span>
<a id="__codelineno-2-35" name="__codelineno-2-35" href="#__codelineno-2-35"></a>
<a id="__codelineno-2-36" name="__codelineno-2-36" href="#__codelineno-2-36"></a>    <span class="c1"># Apply the function to create new columns for each position</span>
<a id="__codelineno-2-37" name="__codelineno-2-37" href="#__codelineno-2-37"></a>    <span class="n">TopazData</span><span class="p">[</span><span class="n">LAST_FIVE_RACE_COLUMNS</span><span class="p">]</span> <span class="o">=</span> <span class="n">TopazData</span><span class="p">[</span><span class="s1">&#39;last5&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">extract_numbers</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span>
<a id="__codelineno-2-38" name="__codelineno-2-38" href="#__codelineno-2-38"></a>
<a id="__codelineno-2-39" name="__codelineno-2-39" href="#__codelineno-2-39"></a>    <span class="k">return</span> <span class="n">TopazData</span>
<a id="__codelineno-2-40" name="__codelineno-2-40" href="#__codelineno-2-40"></a>
<a id="__codelineno-2-41" name="__codelineno-2-41" href="#__codelineno-2-41"></a><span class="n">TopazData</span> <span class="o">=</span> <span class="n">extract_form</span><span class="p">(</span><span class="n">TopazData</span><span class="p">)</span>
<a id="__codelineno-2-42" name="__codelineno-2-42" href="#__codelineno-2-42"></a>
<a id="__codelineno-2-43" name="__codelineno-2-43" href="#__codelineno-2-43"></a><span class="k">def</span> <span class="nf">generate_winPercentage</span><span class="p">(</span><span class="n">TopazData</span><span class="p">):</span>
<a id="__codelineno-2-44" name="__codelineno-2-44" href="#__codelineno-2-44"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<a id="__codelineno-2-45" name="__codelineno-2-45" href="#__codelineno-2-45"></a><span class="sd">    This function generates a percentage of the dog&#39;s previous 5 races in which it has either won or placed in the top 3. </span>
<a id="__codelineno-2-46" name="__codelineno-2-46" href="#__codelineno-2-46"></a><span class="sd">    For generating the win percentage we take the number of &#39;1&#39;s from the the position columns we generated previously and divides by the number of columns that are not equal to 10 which we previously defined as races that did not exist</span>
<a id="__codelineno-2-47" name="__codelineno-2-47" href="#__codelineno-2-47"></a><span class="sd">    For generating the top 3 place percentage by dividing the number of places which are less than or equal to 3.</span>
<a id="__codelineno-2-48" name="__codelineno-2-48" href="#__codelineno-2-48"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-2-49" name="__codelineno-2-49" href="#__codelineno-2-49"></a>    <span class="c1"># Generate win percentage from the last 5 races</span>
<a id="__codelineno-2-50" name="__codelineno-2-50" href="#__codelineno-2-50"></a>    <span class="n">TopazData</span><span class="p">[</span><span class="s1">&#39;lastFiveWinPercentage&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">TopazData</span><span class="p">[</span><span class="n">LAST_FIVE_RACE_COLUMNS</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="p">((</span><span class="n">TopazData</span><span class="p">[</span><span class="n">LAST_FIVE_RACE_COLUMNS</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<a id="__codelineno-2-51" name="__codelineno-2-51" href="#__codelineno-2-51"></a>
<a id="__codelineno-2-52" name="__codelineno-2-52" href="#__codelineno-2-52"></a>    <span class="c1"># Fill any empty values with 0</span>
<a id="__codelineno-2-53" name="__codelineno-2-53" href="#__codelineno-2-53"></a>    <span class="n">TopazData</span><span class="p">[</span><span class="s1">&#39;lastFiveWinPercentage&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-2-54" name="__codelineno-2-54" href="#__codelineno-2-54"></a>
<a id="__codelineno-2-55" name="__codelineno-2-55" href="#__codelineno-2-55"></a>    <span class="c1"># Generate top 3 place percentage from the last 5 races</span>
<a id="__codelineno-2-56" name="__codelineno-2-56" href="#__codelineno-2-56"></a>    <span class="n">TopazData</span><span class="p">[</span><span class="s1">&#39;lastFivePlacePercentage&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">TopazData</span><span class="p">[</span><span class="n">LAST_FIVE_RACE_COLUMNS</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="p">((</span><span class="n">TopazData</span><span class="p">[</span><span class="n">LAST_FIVE_RACE_COLUMNS</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<a id="__codelineno-2-57" name="__codelineno-2-57" href="#__codelineno-2-57"></a>
<a id="__codelineno-2-58" name="__codelineno-2-58" href="#__codelineno-2-58"></a>    <span class="c1"># Fill any empty values with 0</span>
<a id="__codelineno-2-59" name="__codelineno-2-59" href="#__codelineno-2-59"></a>    <span class="n">TopazData</span><span class="p">[</span><span class="s1">&#39;lastFivePlacePercentage&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-2-60" name="__codelineno-2-60" href="#__codelineno-2-60"></a>
<a id="__codelineno-2-61" name="__codelineno-2-61" href="#__codelineno-2-61"></a>    <span class="k">return</span> <span class="n">TopazData</span>
<a id="__codelineno-2-62" name="__codelineno-2-62" href="#__codelineno-2-62"></a>
<a id="__codelineno-2-63" name="__codelineno-2-63" href="#__codelineno-2-63"></a><span class="n">TopazData</span> <span class="o">=</span> <span class="n">generate_winPercentage</span><span class="p">(</span><span class="n">TopazData</span><span class="p">)</span>
<a id="__codelineno-2-64" name="__codelineno-2-64" href="#__codelineno-2-64"></a>
<a id="__codelineno-2-65" name="__codelineno-2-65" href="#__codelineno-2-65"></a><span class="k">def</span> <span class="nf">generate_finishingPlaceMovement</span><span class="p">(</span><span class="n">TopazData</span><span class="p">):</span>
<a id="__codelineno-2-66" name="__codelineno-2-66" href="#__codelineno-2-66"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<a id="__codelineno-2-67" name="__codelineno-2-67" href="#__codelineno-2-67"></a><span class="sd">    This function attempts to determine if the dog has a tendency to fall back in the field towards the end of the race or it finishes very strongly by finding the difference between its final place and its field position at the last split.</span>
<a id="__codelineno-2-68" name="__codelineno-2-68" href="#__codelineno-2-68"></a><span class="sd">    We first fill empty rows and convert to a string, before extracting the second last character from the string. </span>
<a id="__codelineno-2-69" name="__codelineno-2-69" href="#__codelineno-2-69"></a><span class="sd">    Some tracks have much more detailed position data but these make up a minority of races and so using the fourth or fifth last position in-running would omit most of the data and so is not overly useful for modelling purposes</span>
<a id="__codelineno-2-70" name="__codelineno-2-70" href="#__codelineno-2-70"></a>
<a id="__codelineno-2-71" name="__codelineno-2-71" href="#__codelineno-2-71"></a><span class="sd">    If the pir variable only has 1 character, then it corresponds to the final placing and so the fillna operation used on the 2ndLastPIR variable simply fills its final place, assigning a finishingPlaceMovement of 0</span>
<a id="__codelineno-2-72" name="__codelineno-2-72" href="#__codelineno-2-72"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-2-73" name="__codelineno-2-73" href="#__codelineno-2-73"></a>    <span class="c1"># Fill any empty values for pir with 0</span>
<a id="__codelineno-2-74" name="__codelineno-2-74" href="#__codelineno-2-74"></a>    <span class="n">TopazData</span><span class="p">[</span><span class="s1">&#39;pir&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">TopazData</span><span class="p">[</span><span class="s1">&#39;pir&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-2-75" name="__codelineno-2-75" href="#__codelineno-2-75"></a>
<a id="__codelineno-2-76" name="__codelineno-2-76" href="#__codelineno-2-76"></a>    <span class="c1"># Convert the &#39;pir&#39; column to string</span>
<a id="__codelineno-2-77" name="__codelineno-2-77" href="#__codelineno-2-77"></a>    <span class="n">TopazData</span><span class="p">[</span><span class="s1">&#39;pir&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">TopazData</span><span class="p">[</span><span class="s1">&#39;pir&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
<a id="__codelineno-2-78" name="__codelineno-2-78" href="#__codelineno-2-78"></a>
<a id="__codelineno-2-79" name="__codelineno-2-79" href="#__codelineno-2-79"></a>    <span class="c1"># Extract the second last letter and create a new column &#39;2ndLastPIR&#39;</span>
<a id="__codelineno-2-80" name="__codelineno-2-80" href="#__codelineno-2-80"></a>    <span class="n">TopazData</span><span class="p">[</span><span class="s1">&#39;2ndLastPIR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">TopazData</span><span class="p">[</span><span class="s1">&#39;pir&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-2-81" name="__codelineno-2-81" href="#__codelineno-2-81"></a>
<a id="__codelineno-2-82" name="__codelineno-2-82" href="#__codelineno-2-82"></a>    <span class="c1"># Fill any empty values for 2ndLastPIR with the dog&#39;s place</span>
<a id="__codelineno-2-83" name="__codelineno-2-83" href="#__codelineno-2-83"></a>    <span class="n">TopazData</span><span class="p">[</span><span class="s1">&#39;2ndLastPIR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">TopazData</span><span class="p">[</span><span class="s1">&#39;place&#39;</span><span class="p">],</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-2-84" name="__codelineno-2-84" href="#__codelineno-2-84"></a>
<a id="__codelineno-2-85" name="__codelineno-2-85" href="#__codelineno-2-85"></a>    <span class="c1"># Convert the column to integer format</span>
<a id="__codelineno-2-86" name="__codelineno-2-86" href="#__codelineno-2-86"></a>    <span class="n">TopazData</span><span class="p">[</span><span class="s1">&#39;2ndLastPIR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">TopazData</span><span class="p">[</span><span class="s1">&#39;2ndLastPIR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<a id="__codelineno-2-87" name="__codelineno-2-87" href="#__codelineno-2-87"></a>
<a id="__codelineno-2-88" name="__codelineno-2-88" href="#__codelineno-2-88"></a>    <span class="c1"># Create a feature that calculates places gained/conceded in the home straight</span>
<a id="__codelineno-2-89" name="__codelineno-2-89" href="#__codelineno-2-89"></a>    <span class="n">TopazData</span><span class="p">[</span><span class="s1">&#39;finishingPlaceMovement&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">TopazData</span><span class="p">[</span><span class="s1">&#39;2ndLastPIR&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">TopazData</span><span class="p">[</span><span class="s1">&#39;place&#39;</span><span class="p">]</span>
<a id="__codelineno-2-90" name="__codelineno-2-90" href="#__codelineno-2-90"></a>
<a id="__codelineno-2-91" name="__codelineno-2-91" href="#__codelineno-2-91"></a>    <span class="k">return</span> <span class="n">TopazData</span>
<a id="__codelineno-2-92" name="__codelineno-2-92" href="#__codelineno-2-92"></a>
<a id="__codelineno-2-93" name="__codelineno-2-93" href="#__codelineno-2-93"></a><span class="n">TopazData</span> <span class="o">=</span> <span class="n">generate_finishingPlaceMovement</span><span class="p">(</span><span class="n">TopazData</span><span class="p">)</span>
<a id="__codelineno-2-94" name="__codelineno-2-94" href="#__codelineno-2-94"></a>
<a id="__codelineno-2-95" name="__codelineno-2-95" href="#__codelineno-2-95"></a><span class="k">def</span> <span class="nf">scale_values</span><span class="p">(</span><span class="n">TopazData</span><span class="p">):</span>
<a id="__codelineno-2-96" name="__codelineno-2-96" href="#__codelineno-2-96"></a>
<a id="__codelineno-2-97" name="__codelineno-2-97" href="#__codelineno-2-97"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<a id="__codelineno-2-98" name="__codelineno-2-98" href="#__codelineno-2-98"></a><span class="sd">    This function scales the &#39;dogAge&#39; and &#39;weightInKg&#39; columns based on the &#39;raceId&#39; groups using Min-Max scaling. </span>
<a id="__codelineno-2-99" name="__codelineno-2-99" href="#__codelineno-2-99"></a><span class="sd">    Additionally, it applies logarithmic transformations to &#39;prizeMoney&#39;,&#39;place&#39;, and &#39;resultMargin&#39; columns. </span>
<a id="__codelineno-2-100" name="__codelineno-2-100" href="#__codelineno-2-100"></a><span class="sd">    These transformations are performed to ensure that the data follows a more Gaussian distribution and meets the assumptions of certain statistical analyses. </span>
<a id="__codelineno-2-101" name="__codelineno-2-101" href="#__codelineno-2-101"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-2-102" name="__codelineno-2-102" href="#__codelineno-2-102"></a>    <span class="c1"># Scale existing values using MinMaxScaler</span>
<a id="__codelineno-2-103" name="__codelineno-2-103" href="#__codelineno-2-103"></a>    <span class="n">TopazData</span><span class="p">[</span><span class="s1">&#39;dogAgeScaled&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">TopazData</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;raceId&#39;</span><span class="p">)[</span><span class="s1">&#39;dogAge&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">MinMaxScaler</span><span class="p">()</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
<a id="__codelineno-2-104" name="__codelineno-2-104" href="#__codelineno-2-104"></a>    <span class="n">TopazData</span><span class="p">[</span><span class="s1">&#39;weightInKgScaled&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">TopazData</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;raceId&#39;</span><span class="p">)[</span><span class="s1">&#39;weightInKg&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">MinMaxScaler</span><span class="p">()</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
<a id="__codelineno-2-105" name="__codelineno-2-105" href="#__codelineno-2-105"></a>
<a id="__codelineno-2-106" name="__codelineno-2-106" href="#__codelineno-2-106"></a>    <span class="c1"># Transform existing values using log functions</span>
<a id="__codelineno-2-107" name="__codelineno-2-107" href="#__codelineno-2-107"></a>    <span class="n">TopazData</span><span class="p">[</span><span class="s1">&#39;prizemoneyLog&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">TopazData</span><span class="p">[</span><span class="s1">&#39;prizeMoney&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-2-108" name="__codelineno-2-108" href="#__codelineno-2-108"></a>    <span class="n">TopazData</span><span class="p">[</span><span class="s1">&#39;placeLog&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">TopazData</span><span class="p">[</span><span class="s1">&#39;place&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-2-109" name="__codelineno-2-109" href="#__codelineno-2-109"></a>    <span class="n">TopazData</span><span class="p">[</span><span class="s1">&#39;marginLog&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">TopazData</span><span class="p">[</span><span class="s1">&#39;resultMargin&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-2-110" name="__codelineno-2-110" href="#__codelineno-2-110"></a>
<a id="__codelineno-2-111" name="__codelineno-2-111" href="#__codelineno-2-111"></a>    <span class="k">return</span> <span class="n">TopazData</span>
<a id="__codelineno-2-112" name="__codelineno-2-112" href="#__codelineno-2-112"></a>
<a id="__codelineno-2-113" name="__codelineno-2-113" href="#__codelineno-2-113"></a><span class="n">TopazData</span> <span class="o">=</span> <span class="n">scale_values</span><span class="p">(</span><span class="n">TopazData</span><span class="p">)</span>
<a id="__codelineno-2-114" name="__codelineno-2-114" href="#__codelineno-2-114"></a>
<a id="__codelineno-2-115" name="__codelineno-2-115" href="#__codelineno-2-115"></a><span class="k">def</span> <span class="nf">generate_runTimeNorm</span><span class="p">(</span><span class="n">TopazData</span><span class="p">):</span>
<a id="__codelineno-2-116" name="__codelineno-2-116" href="#__codelineno-2-116"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<a id="__codelineno-2-117" name="__codelineno-2-117" href="#__codelineno-2-117"></a><span class="sd">    This function finds the rolling 365 day median win time for each track/distance combination by creating a dataframe that contains only winning runs</span>
<a id="__codelineno-2-118" name="__codelineno-2-118" href="#__codelineno-2-118"></a><span class="sd">    The median time is then compared to the dog&#39;s actual result time and then a normalised value is attained.</span>
<a id="__codelineno-2-119" name="__codelineno-2-119" href="#__codelineno-2-119"></a><span class="sd">    The purpose of the clip(0.9,1.1) is to ensure that very high or very low values (which may be the result of dirty data) do not create erroneous measurements and are therefore clipped to be between 0.9 and 1.1</span>
<a id="__codelineno-2-120" name="__codelineno-2-120" href="#__codelineno-2-120"></a>
<a id="__codelineno-2-121" name="__codelineno-2-121" href="#__codelineno-2-121"></a><span class="sd">    The speed index is used to account for differences in the speed of each track, and will assign different values based on whether a track is fast or slow using the MinMaxScaler</span>
<a id="__codelineno-2-122" name="__codelineno-2-122" href="#__codelineno-2-122"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-2-123" name="__codelineno-2-123" href="#__codelineno-2-123"></a>
<a id="__codelineno-2-124" name="__codelineno-2-124" href="#__codelineno-2-124"></a>    <span class="c1"># Calculate median winner time per track/distance</span>
<a id="__codelineno-2-125" name="__codelineno-2-125" href="#__codelineno-2-125"></a>    <span class="n">win_results</span> <span class="o">=</span> <span class="n">TopazData</span><span class="p">[</span><span class="n">TopazData</span><span class="p">[</span><span class="s1">&#39;place&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-2-126" name="__codelineno-2-126" href="#__codelineno-2-126"></a>
<a id="__codelineno-2-127" name="__codelineno-2-127" href="#__codelineno-2-127"></a>    <span class="c1"># Find the median for each unique combination of track, distance and meetingDate</span>
<a id="__codelineno-2-128" name="__codelineno-2-128" href="#__codelineno-2-128"></a>    <span class="n">grouped_data</span> <span class="o">=</span> <span class="n">win_results</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;track&#39;</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">,</span> <span class="s1">&#39;meetingDate&#39;</span><span class="p">])[</span><span class="s1">&#39;resultTime&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<a id="__codelineno-2-129" name="__codelineno-2-129" href="#__codelineno-2-129"></a>
<a id="__codelineno-2-130" name="__codelineno-2-130" href="#__codelineno-2-130"></a>    <span class="c1"># Find the rolling 365 median of the median values</span>
<a id="__codelineno-2-131" name="__codelineno-2-131" href="#__codelineno-2-131"></a>    <span class="n">median_win_time</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">grouped_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;track&#39;</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;meetingDate&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;meetingDate&#39;</span><span class="p">)[</span><span class="s1">&#39;resultTime&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="s1">&#39;365D&#39;</span><span class="p">,</span> <span class="n">min_periods</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">median</span><span class="p">()))</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<a id="__codelineno-2-132" name="__codelineno-2-132" href="#__codelineno-2-132"></a>
<a id="__codelineno-2-133" name="__codelineno-2-133" href="#__codelineno-2-133"></a>    <span class="c1"># Rename the column</span>
<a id="__codelineno-2-134" name="__codelineno-2-134" href="#__codelineno-2-134"></a>    <span class="n">median_win_time</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;resultTime&quot;</span><span class="p">:</span> <span class="s2">&quot;runTimeMedian&quot;</span><span class="p">},</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-2-135" name="__codelineno-2-135" href="#__codelineno-2-135"></a>
<a id="__codelineno-2-136" name="__codelineno-2-136" href="#__codelineno-2-136"></a>    <span class="c1"># Calculate the speedIndex for the track</span>
<a id="__codelineno-2-137" name="__codelineno-2-137" href="#__codelineno-2-137"></a>    <span class="n">median_win_time</span><span class="p">[</span><span class="s1">&#39;speedIndex&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">median_win_time</span><span class="p">[</span><span class="s1">&#39;runTimeMedian&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">median_win_time</span><span class="p">[</span><span class="s1">&#39;distance&#39;</span><span class="p">])</span>
<a id="__codelineno-2-138" name="__codelineno-2-138" href="#__codelineno-2-138"></a>
<a id="__codelineno-2-139" name="__codelineno-2-139" href="#__codelineno-2-139"></a>    <span class="c1"># Apply the MinMaxScaler</span>
<a id="__codelineno-2-140" name="__codelineno-2-140" href="#__codelineno-2-140"></a>    <span class="n">median_win_time</span><span class="p">[</span><span class="s1">&#39;speedIndex&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">MinMaxScaler</span><span class="p">()</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">median_win_time</span><span class="p">[[</span><span class="s1">&#39;speedIndex&#39;</span><span class="p">]])</span>
<a id="__codelineno-2-141" name="__codelineno-2-141" href="#__codelineno-2-141"></a>
<a id="__codelineno-2-142" name="__codelineno-2-142" href="#__codelineno-2-142"></a>    <span class="c1"># Merge with median winner time</span>
<a id="__codelineno-2-143" name="__codelineno-2-143" href="#__codelineno-2-143"></a>    <span class="n">TopazData</span> <span class="o">=</span> <span class="n">TopazData</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">median_win_time</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;track&#39;</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">,</span><span class="s1">&#39;meetingDate&#39;</span><span class="p">])</span>
<a id="__codelineno-2-144" name="__codelineno-2-144" href="#__codelineno-2-144"></a>
<a id="__codelineno-2-145" name="__codelineno-2-145" href="#__codelineno-2-145"></a>    <span class="c1"># Normalise time comparison</span>
<a id="__codelineno-2-146" name="__codelineno-2-146" href="#__codelineno-2-146"></a>    <span class="n">TopazData</span><span class="p">[</span><span class="s1">&#39;runTimeNorm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">TopazData</span><span class="p">[</span><span class="s1">&#39;runTimeMedian&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">TopazData</span><span class="p">[</span><span class="s1">&#39;resultTime&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">)</span>
<a id="__codelineno-2-147" name="__codelineno-2-147" href="#__codelineno-2-147"></a>
<a id="__codelineno-2-148" name="__codelineno-2-148" href="#__codelineno-2-148"></a>    <span class="c1"># Fill the empty values with 0</span>
<a id="__codelineno-2-149" name="__codelineno-2-149" href="#__codelineno-2-149"></a>    <span class="n">TopazData</span><span class="p">[</span><span class="s1">&#39;runTimeNorm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-2-150" name="__codelineno-2-150" href="#__codelineno-2-150"></a>
<a id="__codelineno-2-151" name="__codelineno-2-151" href="#__codelineno-2-151"></a>    <span class="c1"># Apply the MinMaxScaler</span>
<a id="__codelineno-2-152" name="__codelineno-2-152" href="#__codelineno-2-152"></a>    <span class="n">TopazData</span><span class="p">[</span><span class="s1">&#39;runTimeNorm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">TopazData</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;raceId&#39;</span><span class="p">)[</span><span class="s1">&#39;runTimeNorm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">MinMaxScaler</span><span class="p">()</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
<a id="__codelineno-2-153" name="__codelineno-2-153" href="#__codelineno-2-153"></a>
<a id="__codelineno-2-154" name="__codelineno-2-154" href="#__codelineno-2-154"></a>    <span class="k">return</span> <span class="n">TopazData</span>
<a id="__codelineno-2-155" name="__codelineno-2-155" href="#__codelineno-2-155"></a>
<a id="__codelineno-2-156" name="__codelineno-2-156" href="#__codelineno-2-156"></a><span class="n">TopazData</span> <span class="o">=</span> <span class="n">generate_runTimeNorm</span><span class="p">(</span><span class="n">TopazData</span><span class="p">)</span>
<a id="__codelineno-2-157" name="__codelineno-2-157" href="#__codelineno-2-157"></a>
<a id="__codelineno-2-158" name="__codelineno-2-158" href="#__codelineno-2-158"></a><span class="k">def</span> <span class="nf">generate_adjacentVacantBox_state</span><span class="p">(</span><span class="n">TopazData</span><span class="p">):</span>
<a id="__codelineno-2-159" name="__codelineno-2-159" href="#__codelineno-2-159"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<a id="__codelineno-2-160" name="__codelineno-2-160" href="#__codelineno-2-160"></a><span class="sd">    This function determines whether the dog has at least one vacant box directly next to them at the beginning of the race. </span>
<a id="__codelineno-2-161" name="__codelineno-2-161" href="#__codelineno-2-161"></a><span class="sd">    In greyhound racing, especially for very short races, a dog with more room to move at the beginning of the race is less likely to be bumped (or &#39;checked&#39;) if it has a vacant box next to it. </span>
<a id="__codelineno-2-162" name="__codelineno-2-162" href="#__codelineno-2-162"></a><span class="sd">    This is also true for dogs in box 1 as there is a lot of room adjacent to box 1. </span>
<a id="__codelineno-2-163" name="__codelineno-2-163" href="#__codelineno-2-163"></a>
<a id="__codelineno-2-164" name="__codelineno-2-164" href="#__codelineno-2-164"></a><span class="sd">    We find this by ordering by raceId and boxNumber and determining if the box number above or below is filled. </span>
<a id="__codelineno-2-165" name="__codelineno-2-165" href="#__codelineno-2-165"></a><span class="sd">    Box 8 is counted as always having the box above filled as Box 8 is hard-up on the fence and so the dog does not have room to move here.</span>
<a id="__codelineno-2-166" name="__codelineno-2-166" href="#__codelineno-2-166"></a><span class="sd">    We then determine if the dog has adjacent space by generating the variable &#39;hasAtLeast1VacantBox&#39;</span>
<a id="__codelineno-2-167" name="__codelineno-2-167" href="#__codelineno-2-167"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-2-168" name="__codelineno-2-168" href="#__codelineno-2-168"></a>
<a id="__codelineno-2-169" name="__codelineno-2-169" href="#__codelineno-2-169"></a>    <span class="c1"># Sort the DataFrame by &#39;RaceId&#39; and &#39;Box&#39;</span>
<a id="__codelineno-2-170" name="__codelineno-2-170" href="#__codelineno-2-170"></a>    <span class="n">TopazData</span> <span class="o">=</span> <span class="n">TopazData</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;raceId&#39;</span><span class="p">,</span> <span class="s1">&#39;boxNumber&#39;</span><span class="p">])</span>
<a id="__codelineno-2-171" name="__codelineno-2-171" href="#__codelineno-2-171"></a>
<a id="__codelineno-2-172" name="__codelineno-2-172" href="#__codelineno-2-172"></a>    <span class="c1"># Check if there is an entry equal to boxNumber plus or minues one</span>
<a id="__codelineno-2-173" name="__codelineno-2-173" href="#__codelineno-2-173"></a>    <span class="n">TopazData</span><span class="p">[</span><span class="s1">&#39;hasEntryBoxNumberPlus1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">TopazData</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;raceId&#39;</span><span class="p">)[</span><span class="s1">&#39;boxNumber&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">TopazData</span><span class="p">[</span><span class="s1">&#39;boxNumber&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">TopazData</span><span class="p">[</span><span class="s1">&#39;boxNumber&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span>
<a id="__codelineno-2-174" name="__codelineno-2-174" href="#__codelineno-2-174"></a>    <span class="n">TopazData</span><span class="p">[</span><span class="s1">&#39;hasEntryBoxNumberMinus1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">TopazData</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;raceId&#39;</span><span class="p">)[</span><span class="s1">&#39;boxNumber&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">TopazData</span><span class="p">[</span><span class="s1">&#39;boxNumber&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-2-175" name="__codelineno-2-175" href="#__codelineno-2-175"></a>
<a id="__codelineno-2-176" name="__codelineno-2-176" href="#__codelineno-2-176"></a>    <span class="c1"># Convert boolean values to 1</span>
<a id="__codelineno-2-177" name="__codelineno-2-177" href="#__codelineno-2-177"></a>    <span class="n">TopazData</span><span class="p">[</span><span class="s1">&#39;hasEntryBoxNumberPlus1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">TopazData</span><span class="p">[</span><span class="s1">&#39;hasEntryBoxNumberPlus1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<a id="__codelineno-2-178" name="__codelineno-2-178" href="#__codelineno-2-178"></a>    <span class="n">TopazData</span><span class="p">[</span><span class="s1">&#39;hasEntryBoxNumberMinus1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">TopazData</span><span class="p">[</span><span class="s1">&#39;hasEntryBoxNumberMinus1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<a id="__codelineno-2-179" name="__codelineno-2-179" href="#__codelineno-2-179"></a>
<a id="__codelineno-2-180" name="__codelineno-2-180" href="#__codelineno-2-180"></a>    <span class="c1"># Calculate &#39;hasAtLeast1VacantBox&#39;</span>
<a id="__codelineno-2-181" name="__codelineno-2-181" href="#__codelineno-2-181"></a>    <span class="n">TopazData</span><span class="p">[</span><span class="s1">&#39;hasAtLeast1VacantBox&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">TopazData</span><span class="p">[</span><span class="s1">&#39;hasEntryBoxNumberPlus1&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">TopazData</span><span class="p">[</span><span class="s1">&#39;hasEntryBoxNumberMinus1&#39;</span><span class="p">]</span><span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<a id="__codelineno-2-182" name="__codelineno-2-182" href="#__codelineno-2-182"></a>
<a id="__codelineno-2-183" name="__codelineno-2-183" href="#__codelineno-2-183"></a>    <span class="k">return</span> <span class="n">TopazData</span>
<a id="__codelineno-2-184" name="__codelineno-2-184" href="#__codelineno-2-184"></a>
<a id="__codelineno-2-185" name="__codelineno-2-185" href="#__codelineno-2-185"></a><span class="n">TopazData</span> <span class="o">=</span> <span class="n">generate_adjacentVacantBox_state</span><span class="p">(</span><span class="n">TopazData</span><span class="p">)</span>
<a id="__codelineno-2-186" name="__codelineno-2-186" href="#__codelineno-2-186"></a>
<a id="__codelineno-2-187" name="__codelineno-2-187" href="#__codelineno-2-187"></a><span class="k">def</span> <span class="nf">generate_boxWinPercentage</span><span class="p">(</span><span class="n">TopazData</span><span class="p">):</span>
<a id="__codelineno-2-188" name="__codelineno-2-188" href="#__codelineno-2-188"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39; </span>
<a id="__codelineno-2-189" name="__codelineno-2-189" href="#__codelineno-2-189"></a><span class="sd">    This function creates a rolling win percentage for each combination of &#39;track&#39;, &#39;distance&#39;, &#39;boxNumber&#39;, &#39;hasAtLeast1VacantBox&#39;, &#39;meetingDate&#39;</span>
<a id="__codelineno-2-190" name="__codelineno-2-190" href="#__codelineno-2-190"></a><span class="sd">    The purpose of this is to help the model determine if the box placement and presence of vacant adjacent boxes can give the dog an improved chance of winning the race</span>
<a id="__codelineno-2-191" name="__codelineno-2-191" href="#__codelineno-2-191"></a><span class="sd">    The shift(1) is used to ensure that the results of that meetingDate are excluded from the calculation to prevent data leakage</span>
<a id="__codelineno-2-192" name="__codelineno-2-192" href="#__codelineno-2-192"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-2-193" name="__codelineno-2-193" href="#__codelineno-2-193"></a>    <span class="c1"># Create a win column</span>
<a id="__codelineno-2-194" name="__codelineno-2-194" href="#__codelineno-2-194"></a>    <span class="n">TopazData</span><span class="p">[</span><span class="s1">&#39;win&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">TopazData</span><span class="p">[</span><span class="s1">&#39;place&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-2-195" name="__codelineno-2-195" href="#__codelineno-2-195"></a>
<a id="__codelineno-2-196" name="__codelineno-2-196" href="#__codelineno-2-196"></a>    <span class="c1"># Find the mean (win percentage) for each &#39;track&#39;, &#39;distance&#39;, &#39;boxNumber&#39;, &#39;hasAtLeast1VacantBox&#39;, &#39;meetingDate&#39; combination</span>
<a id="__codelineno-2-197" name="__codelineno-2-197" href="#__codelineno-2-197"></a>    <span class="n">grouped_data</span> <span class="o">=</span> <span class="n">TopazData</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;track&#39;</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">,</span> <span class="s1">&#39;boxNumber&#39;</span><span class="p">,</span> <span class="s1">&#39;hasAtLeast1VacantBox&#39;</span><span class="p">,</span> <span class="s1">&#39;meetingDate&#39;</span><span class="p">])[</span><span class="s1">&#39;win&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<a id="__codelineno-2-198" name="__codelineno-2-198" href="#__codelineno-2-198"></a>
<a id="__codelineno-2-199" name="__codelineno-2-199" href="#__codelineno-2-199"></a>    <span class="c1"># set the index to be the meeting date for the rolling window calculation</span>
<a id="__codelineno-2-200" name="__codelineno-2-200" href="#__codelineno-2-200"></a>    <span class="n">grouped_data</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;meetingDate&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-2-201" name="__codelineno-2-201" href="#__codelineno-2-201"></a>
<a id="__codelineno-2-202" name="__codelineno-2-202" href="#__codelineno-2-202"></a>    <span class="c1"># Apply rolling mean calculation to the aggregated data</span>
<a id="__codelineno-2-203" name="__codelineno-2-203" href="#__codelineno-2-203"></a>    <span class="n">box_win_percent</span> <span class="o">=</span> <span class="n">grouped_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;track&#39;</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">,</span> <span class="s1">&#39;boxNumber&#39;</span><span class="p">,</span> <span class="s1">&#39;hasAtLeast1VacantBox&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;meetingDate&#39;</span><span class="p">)[</span><span class="s1">&#39;win&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="s1">&#39;365D&#39;</span><span class="p">,</span> <span class="n">min_periods</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<a id="__codelineno-2-204" name="__codelineno-2-204" href="#__codelineno-2-204"></a>
<a id="__codelineno-2-205" name="__codelineno-2-205" href="#__codelineno-2-205"></a>    <span class="c1"># Reset index and rename columns</span>
<a id="__codelineno-2-206" name="__codelineno-2-206" href="#__codelineno-2-206"></a>    <span class="n">box_win_percent</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;track&#39;</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">,</span> <span class="s1">&#39;boxNumber&#39;</span><span class="p">,</span> <span class="s1">&#39;hasAtLeast1VacantBox&#39;</span><span class="p">,</span> <span class="s1">&#39;meetingDate&#39;</span><span class="p">,</span> <span class="s1">&#39;rolling_box_win_percentage&#39;</span><span class="p">]</span>
<a id="__codelineno-2-207" name="__codelineno-2-207" href="#__codelineno-2-207"></a>
<a id="__codelineno-2-208" name="__codelineno-2-208" href="#__codelineno-2-208"></a>    <span class="c1"># Add to dog results dataframe</span>
<a id="__codelineno-2-209" name="__codelineno-2-209" href="#__codelineno-2-209"></a>    <span class="n">TopazData</span> <span class="o">=</span> <span class="n">TopazData</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">box_win_percent</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;track&#39;</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">,</span> <span class="s1">&#39;meetingDate&#39;</span><span class="p">,</span><span class="s1">&#39;boxNumber&#39;</span><span class="p">,</span><span class="s1">&#39;hasAtLeast1VacantBox&#39;</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
<a id="__codelineno-2-210" name="__codelineno-2-210" href="#__codelineno-2-210"></a>
<a id="__codelineno-2-211" name="__codelineno-2-211" href="#__codelineno-2-211"></a>    <span class="k">return</span> <span class="n">TopazData</span>
<a id="__codelineno-2-212" name="__codelineno-2-212" href="#__codelineno-2-212"></a>
<a id="__codelineno-2-213" name="__codelineno-2-213" href="#__codelineno-2-213"></a><span class="n">TopazData</span> <span class="o">=</span> <span class="n">generate_boxWinPercentage</span><span class="p">(</span><span class="n">TopazData</span><span class="p">)</span>
</code></pre></div>
Now we've created some basic features, it's time to create our big group of features where we iterate over different subsets, variables and time points to generate a large number of different features</p>
<div class="highlight"><span class="filename">Creating Bulk Features</span><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="c1"># Calculate values for dog, trainer, dam and sire</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="n">SUBSETS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;dog&#39;</span><span class="p">,</span> <span class="s1">&#39;trainer&#39;</span><span class="p">,</span> <span class="s1">&#39;dam&#39;</span><span class="p">,</span> <span class="s1">&#39;sire&#39;</span><span class="p">]</span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="c1"># Use rolling window of 28, 91 and 365 days</span>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="n">ROLLING_WINDOWS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;28D&#39;</span><span class="p">,</span><span class="s1">&#39;91D&#39;</span><span class="p">,</span> <span class="s1">&#39;365D&#39;</span><span class="p">]</span>
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a>
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a><span class="c1"># Features to use for rolling windows calculation</span>
<a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a><span class="n">FEATURES</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;runTimeNorm&#39;</span><span class="p">,</span> <span class="s1">&#39;placeLog&#39;</span><span class="p">,</span> <span class="s1">&#39;prizemoneyLog&#39;</span><span class="p">,</span> <span class="s1">&#39;marginLog&#39;</span><span class="p">,</span><span class="s1">&#39;finishingPlaceMovement&#39;</span><span class="p">]</span>
<a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a>
<a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a><span class="c1"># Aggregation functions to apply</span>
<a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a><span class="n">AGGREGATES</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;median&#39;</span><span class="p">,</span> <span class="s1">&#39;std&#39;</span><span class="p">]</span>
<a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a>
<a id="__codelineno-3-13" name="__codelineno-3-13" href="#__codelineno-3-13"></a><span class="k">def</span> <span class="nf">generate_rollingFeatures</span><span class="p">(</span><span class="n">TopazData</span><span class="p">):</span>
<a id="__codelineno-3-14" name="__codelineno-3-14" href="#__codelineno-3-14"></a>
<a id="__codelineno-3-15" name="__codelineno-3-15" href="#__codelineno-3-15"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<a id="__codelineno-3-16" name="__codelineno-3-16" href="#__codelineno-3-16"></a><span class="sd">    This function generates rolling window features for subsets including dog, trainer, dam, and sire.</span>
<a id="__codelineno-3-17" name="__codelineno-3-17" href="#__codelineno-3-17"></a><span class="sd">    The rolling windows used are defined as 28 days, 91 days, and 365 days. </span>
<a id="__codelineno-3-18" name="__codelineno-3-18" href="#__codelineno-3-18"></a><span class="sd">    Features such as &#39;runTimeNorm&#39;,&#39;placeLog&#39;, &#39;prizemoneyLog&#39;, &#39;marginLog&#39;, and &#39;finishingPlaceMovement&#39; are considered for rolling window calculation.</span>
<a id="__codelineno-3-19" name="__codelineno-3-19" href="#__codelineno-3-19"></a><span class="sd">    The aggregation functions applied include &#39;min&#39;, &#39;max&#39;, &#39;mean&#39;, &#39;median&#39;, and &#39;std&#39;.</span>
<a id="__codelineno-3-20" name="__codelineno-3-20" href="#__codelineno-3-20"></a>
<a id="__codelineno-3-21" name="__codelineno-3-21" href="#__codelineno-3-21"></a><span class="sd">    The function iterates through each subset, calculates rolling window features for each specified rolling window, and adds them to the dataset. </span>
<a id="__codelineno-3-22" name="__codelineno-3-22" href="#__codelineno-3-22"></a><span class="sd">    The generated feature names indicate the subset, feature, aggregation function, and rolling window used for calculation.</span>
<a id="__codelineno-3-23" name="__codelineno-3-23" href="#__codelineno-3-23"></a>
<a id="__codelineno-3-24" name="__codelineno-3-24" href="#__codelineno-3-24"></a><span class="sd">    Finally, the function returns the dataset with generated features added and a list of column names representing the generated rolling window features.</span>
<a id="__codelineno-3-25" name="__codelineno-3-25" href="#__codelineno-3-25"></a><span class="sd">    The function enables the creation of a bulk set of features to be created using statistical aggregates, which will be entrusted to the algorithm to sort through which ones have significance</span>
<a id="__codelineno-3-26" name="__codelineno-3-26" href="#__codelineno-3-26"></a>
<a id="__codelineno-3-27" name="__codelineno-3-27" href="#__codelineno-3-27"></a><span class="sd">    We create a copy of the TopazData dataframe rather than modifying it directly in case of issues with this function. It means that this cell can simply be rerun instead of having to reload and reprocess the entire database</span>
<a id="__codelineno-3-28" name="__codelineno-3-28" href="#__codelineno-3-28"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-3-29" name="__codelineno-3-29" href="#__codelineno-3-29"></a>    <span class="c1"># Create a copy of the dataframe and ensure meetingDate is in datetime format</span>
<a id="__codelineno-3-30" name="__codelineno-3-30" href="#__codelineno-3-30"></a>    <span class="n">dataset</span> <span class="o">=</span> <span class="n">TopazData</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-3-31" name="__codelineno-3-31" href="#__codelineno-3-31"></a>    <span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;meetingDate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;meetingDate&#39;</span><span class="p">])</span>
<a id="__codelineno-3-32" name="__codelineno-3-32" href="#__codelineno-3-32"></a>
<a id="__codelineno-3-33" name="__codelineno-3-33" href="#__codelineno-3-33"></a>    <span class="c1"># Keep track of generated feature names</span>
<a id="__codelineno-3-34" name="__codelineno-3-34" href="#__codelineno-3-34"></a>    <span class="n">feature_cols</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-3-35" name="__codelineno-3-35" href="#__codelineno-3-35"></a>
<a id="__codelineno-3-36" name="__codelineno-3-36" href="#__codelineno-3-36"></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">SUBSETS</span><span class="p">:</span>
<a id="__codelineno-3-37" name="__codelineno-3-37" href="#__codelineno-3-37"></a>
<a id="__codelineno-3-38" name="__codelineno-3-38" href="#__codelineno-3-38"></a>        <span class="c1"># Add the Id string</span>
<a id="__codelineno-3-39" name="__codelineno-3-39" href="#__codelineno-3-39"></a>        <span class="n">idnumber</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="s1">&#39;Id&#39;</span>
<a id="__codelineno-3-40" name="__codelineno-3-40" href="#__codelineno-3-40"></a>
<a id="__codelineno-3-41" name="__codelineno-3-41" href="#__codelineno-3-41"></a>        <span class="c1"># Create a subset dataframe</span>
<a id="__codelineno-3-42" name="__codelineno-3-42" href="#__codelineno-3-42"></a>        <span class="n">subset_dataframe</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[[</span><span class="s1">&#39;meetingDate&#39;</span><span class="p">,</span><span class="n">idnumber</span><span class="p">]</span> <span class="o">+</span> <span class="n">FEATURES</span><span class="p">]</span>
<a id="__codelineno-3-43" name="__codelineno-3-43" href="#__codelineno-3-43"></a>
<a id="__codelineno-3-44" name="__codelineno-3-44" href="#__codelineno-3-44"></a>        <span class="c1"># intitialise the dataframe</span>
<a id="__codelineno-3-45" name="__codelineno-3-45" href="#__codelineno-3-45"></a>        <span class="n">average_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
<a id="__codelineno-3-46" name="__codelineno-3-46" href="#__codelineno-3-46"></a>
<a id="__codelineno-3-47" name="__codelineno-3-47" href="#__codelineno-3-47"></a>        <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">FEATURES</span><span class="p">:</span>
<a id="__codelineno-3-48" name="__codelineno-3-48" href="#__codelineno-3-48"></a>
<a id="__codelineno-3-49" name="__codelineno-3-49" href="#__codelineno-3-49"></a>            <span class="c1"># Find the mean value for the meetingDate</span>
<a id="__codelineno-3-50" name="__codelineno-3-50" href="#__codelineno-3-50"></a>            <span class="n">feature_average_df</span> <span class="o">=</span> <span class="n">subset_dataframe</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">idnumber</span><span class="p">,</span> <span class="s1">&#39;meetingDate&#39;</span><span class="p">])[</span><span class="n">feature</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<a id="__codelineno-3-51" name="__codelineno-3-51" href="#__codelineno-3-51"></a>
<a id="__codelineno-3-52" name="__codelineno-3-52" href="#__codelineno-3-52"></a>            <span class="c1"># Rename the feature column to indicate it&#39;s the average of that feature</span>
<a id="__codelineno-3-53" name="__codelineno-3-53" href="#__codelineno-3-53"></a>            <span class="n">feature_average_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">feature</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">feature</span><span class="si">}{</span><span class="n">i</span><span class="si">}</span><span class="s1">DayAverage&#39;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-3-54" name="__codelineno-3-54" href="#__codelineno-3-54"></a>
<a id="__codelineno-3-55" name="__codelineno-3-55" href="#__codelineno-3-55"></a>            <span class="c1"># If average_df is empty, assign the feature_average_df to it</span>
<a id="__codelineno-3-56" name="__codelineno-3-56" href="#__codelineno-3-56"></a>            <span class="k">if</span> <span class="n">average_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
<a id="__codelineno-3-57" name="__codelineno-3-57" href="#__codelineno-3-57"></a>                <span class="n">average_df</span> <span class="o">=</span> <span class="n">feature_average_df</span>
<a id="__codelineno-3-58" name="__codelineno-3-58" href="#__codelineno-3-58"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-3-59" name="__codelineno-3-59" href="#__codelineno-3-59"></a>                <span class="c1"># Otherwise, merge feature_average_df with average_df</span>
<a id="__codelineno-3-60" name="__codelineno-3-60" href="#__codelineno-3-60"></a>                <span class="n">average_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">average_df</span><span class="p">,</span> <span class="n">feature_average_df</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="n">idnumber</span><span class="p">,</span> <span class="s1">&#39;meetingDate&#39;</span><span class="p">])</span>
<a id="__codelineno-3-61" name="__codelineno-3-61" href="#__codelineno-3-61"></a>
<a id="__codelineno-3-62" name="__codelineno-3-62" href="#__codelineno-3-62"></a>        <span class="c1"># Create a list from the column names</span>
<a id="__codelineno-3-63" name="__codelineno-3-63" href="#__codelineno-3-63"></a>        <span class="n">column_names</span> <span class="o">=</span> <span class="n">average_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<a id="__codelineno-3-64" name="__codelineno-3-64" href="#__codelineno-3-64"></a>
<a id="__codelineno-3-65" name="__codelineno-3-65" href="#__codelineno-3-65"></a>        <span class="c1"># Columns to exclude</span>
<a id="__codelineno-3-66" name="__codelineno-3-66" href="#__codelineno-3-66"></a>        <span class="n">columns_to_exclude</span> <span class="o">=</span> <span class="p">[</span><span class="n">idnumber</span><span class="p">,</span><span class="s1">&#39;meetingDate&#39;</span><span class="p">]</span>
<a id="__codelineno-3-67" name="__codelineno-3-67" href="#__codelineno-3-67"></a>
<a id="__codelineno-3-68" name="__codelineno-3-68" href="#__codelineno-3-68"></a>        <span class="c1"># Exclude specified columns from the list</span>
<a id="__codelineno-3-69" name="__codelineno-3-69" href="#__codelineno-3-69"></a>        <span class="n">column_names_filtered</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">column_names</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">columns_to_exclude</span><span class="p">]</span>
<a id="__codelineno-3-70" name="__codelineno-3-70" href="#__codelineno-3-70"></a>
<a id="__codelineno-3-71" name="__codelineno-3-71" href="#__codelineno-3-71"></a>        <span class="c1"># Drop any duplicate rows (for when any dam/sire has more than one progeny race in one day or an owner/trainer has more than one dog race in one day)</span>
<a id="__codelineno-3-72" name="__codelineno-3-72" href="#__codelineno-3-72"></a>        <span class="n">average_df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-3-73" name="__codelineno-3-73" href="#__codelineno-3-73"></a>
<a id="__codelineno-3-74" name="__codelineno-3-74" href="#__codelineno-3-74"></a>        <span class="c1"># convert meetingDate to datetime format</span>
<a id="__codelineno-3-75" name="__codelineno-3-75" href="#__codelineno-3-75"></a>        <span class="n">average_df</span><span class="p">[</span><span class="s1">&#39;meetingDate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">average_df</span><span class="p">[</span><span class="s1">&#39;meetingDate&#39;</span><span class="p">])</span>
<a id="__codelineno-3-76" name="__codelineno-3-76" href="#__codelineno-3-76"></a>
<a id="__codelineno-3-77" name="__codelineno-3-77" href="#__codelineno-3-77"></a>        <span class="c1"># set the index before applying the rolling windows</span>
<a id="__codelineno-3-78" name="__codelineno-3-78" href="#__codelineno-3-78"></a>        <span class="n">average_df</span> <span class="o">=</span> <span class="n">average_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="n">idnumber</span><span class="p">,</span> <span class="s1">&#39;meetingDate&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span> 
<a id="__codelineno-3-79" name="__codelineno-3-79" href="#__codelineno-3-79"></a>
<a id="__codelineno-3-80" name="__codelineno-3-80" href="#__codelineno-3-80"></a>        <span class="k">for</span> <span class="n">rolling_window</span> <span class="ow">in</span> <span class="n">ROLLING_WINDOWS</span><span class="p">:</span>
<a id="__codelineno-3-81" name="__codelineno-3-81" href="#__codelineno-3-81"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Processing </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1"> rolling window </span><span class="si">{</span><span class="n">rolling_window</span><span class="si">}</span><span class="s1"> days&#39;</span><span class="p">)</span>
<a id="__codelineno-3-82" name="__codelineno-3-82" href="#__codelineno-3-82"></a>
<a id="__codelineno-3-83" name="__codelineno-3-83" href="#__codelineno-3-83"></a>            <span class="n">rolling_result</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-3-84" name="__codelineno-3-84" href="#__codelineno-3-84"></a>                <span class="n">average_df</span>
<a id="__codelineno-3-85" name="__codelineno-3-85" href="#__codelineno-3-85"></a>                <span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-3-86" name="__codelineno-3-86" href="#__codelineno-3-86"></a>                <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">idnumber</span><span class="p">)[</span><span class="n">column_names_filtered</span><span class="p">]</span>
<a id="__codelineno-3-87" name="__codelineno-3-87" href="#__codelineno-3-87"></a>                <span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">rolling_window</span><span class="p">)</span>
<a id="__codelineno-3-88" name="__codelineno-3-88" href="#__codelineno-3-88"></a>                <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">AGGREGATES</span><span class="p">)</span>
<a id="__codelineno-3-89" name="__codelineno-3-89" href="#__codelineno-3-89"></a>                <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-3-90" name="__codelineno-3-90" href="#__codelineno-3-90"></a>                <span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-3-91" name="__codelineno-3-91" href="#__codelineno-3-91"></a>            <span class="p">)</span>
<a id="__codelineno-3-92" name="__codelineno-3-92" href="#__codelineno-3-92"></a>
<a id="__codelineno-3-93" name="__codelineno-3-93" href="#__codelineno-3-93"></a>            <span class="c1"># Generate list of rolling window feature names (eg: RunTime_norm_min_365D)</span>
<a id="__codelineno-3-94" name="__codelineno-3-94" href="#__codelineno-3-94"></a>            <span class="n">agg_features_cols</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">a</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">rolling_window</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">f</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">FEATURES</span><span class="p">,</span> <span class="n">AGGREGATES</span><span class="p">)]</span>
<a id="__codelineno-3-95" name="__codelineno-3-95" href="#__codelineno-3-95"></a>
<a id="__codelineno-3-96" name="__codelineno-3-96" href="#__codelineno-3-96"></a>            <span class="c1"># Add features to dataset</span>
<a id="__codelineno-3-97" name="__codelineno-3-97" href="#__codelineno-3-97"></a>            <span class="n">average_df</span><span class="p">[</span><span class="n">agg_features_cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">rolling_result</span>
<a id="__codelineno-3-98" name="__codelineno-3-98" href="#__codelineno-3-98"></a>
<a id="__codelineno-3-99" name="__codelineno-3-99" href="#__codelineno-3-99"></a>            <span class="c1"># Keep track of generated feature names</span>
<a id="__codelineno-3-100" name="__codelineno-3-100" href="#__codelineno-3-100"></a>            <span class="n">feature_cols</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">agg_features_cols</span><span class="p">)</span>
<a id="__codelineno-3-101" name="__codelineno-3-101" href="#__codelineno-3-101"></a>
<a id="__codelineno-3-102" name="__codelineno-3-102" href="#__codelineno-3-102"></a>            <span class="c1"># fill empty values with 0</span>
<a id="__codelineno-3-103" name="__codelineno-3-103" href="#__codelineno-3-103"></a>            <span class="n">average_df</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-3-104" name="__codelineno-3-104" href="#__codelineno-3-104"></a>
<a id="__codelineno-3-105" name="__codelineno-3-105" href="#__codelineno-3-105"></a>        <span class="n">average_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-3-106" name="__codelineno-3-106" href="#__codelineno-3-106"></a>        <span class="n">dataset</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span><span class="n">average_df</span><span class="p">,</span><span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="n">idnumber</span><span class="p">,</span> <span class="s1">&#39;meetingDate&#39;</span><span class="p">])</span>
<a id="__codelineno-3-107" name="__codelineno-3-107" href="#__codelineno-3-107"></a>
<a id="__codelineno-3-108" name="__codelineno-3-108" href="#__codelineno-3-108"></a>    <span class="k">return</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">feature_cols</span>
<a id="__codelineno-3-109" name="__codelineno-3-109" href="#__codelineno-3-109"></a>
<a id="__codelineno-3-110" name="__codelineno-3-110" href="#__codelineno-3-110"></a><span class="n">dataset</span><span class="p">,</span> <span class="n">feature_cols</span> <span class="o">=</span> <span class="n">generate_rollingFeatures</span><span class="p">(</span><span class="n">TopazData</span><span class="p">)</span>
<a id="__codelineno-3-111" name="__codelineno-3-111" href="#__codelineno-3-111"></a>
<a id="__codelineno-3-112" name="__codelineno-3-112" href="#__codelineno-3-112"></a><span class="k">def</span> <span class="nf">generate_feature_list</span><span class="p">(</span><span class="n">feature_cols</span><span class="p">):</span>
<a id="__codelineno-3-113" name="__codelineno-3-113" href="#__codelineno-3-113"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<a id="__codelineno-3-114" name="__codelineno-3-114" href="#__codelineno-3-114"></a><span class="sd">    This function converts the numpy series to a list for later use</span>
<a id="__codelineno-3-115" name="__codelineno-3-115" href="#__codelineno-3-115"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-3-116" name="__codelineno-3-116" href="#__codelineno-3-116"></a>    <span class="n">feature_cols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">feature_cols</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<a id="__codelineno-3-117" name="__codelineno-3-117" href="#__codelineno-3-117"></a>
<a id="__codelineno-3-118" name="__codelineno-3-118" href="#__codelineno-3-118"></a>    <span class="k">return</span> <span class="n">feature_cols</span>
<a id="__codelineno-3-119" name="__codelineno-3-119" href="#__codelineno-3-119"></a>
<a id="__codelineno-3-120" name="__codelineno-3-120" href="#__codelineno-3-120"></a><span class="n">feature_cols</span> <span class="o">=</span> <span class="n">generate_feature_list</span><span class="p">(</span><span class="n">feature_cols</span><span class="p">)</span>
<a id="__codelineno-3-121" name="__codelineno-3-121" href="#__codelineno-3-121"></a>
<a id="__codelineno-3-122" name="__codelineno-3-122" href="#__codelineno-3-122"></a><span class="k">def</span> <span class="nf">discard_first_year</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span><span class="n">start_date</span><span class="p">):</span>
<a id="__codelineno-3-123" name="__codelineno-3-123" href="#__codelineno-3-123"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<a id="__codelineno-3-124" name="__codelineno-3-124" href="#__codelineno-3-124"></a><span class="sd">    This function discards the first 12 months of the dataset. </span>
<a id="__codelineno-3-125" name="__codelineno-3-125" href="#__codelineno-3-125"></a><span class="sd">    This is done because the generate_rollingFeatures function utilises 365 days as one of the windows, and so to maintain data integrity, any data between the beginning of the dataset and 12 months afterwards is now &#39;unclean&#39; and should be discarded</span>
<a id="__codelineno-3-126" name="__codelineno-3-126" href="#__codelineno-3-126"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-3-127" name="__codelineno-3-127" href="#__codelineno-3-127"></a>    <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;meetingDate&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">start_date</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">years</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span>
<a id="__codelineno-3-128" name="__codelineno-3-128" href="#__codelineno-3-128"></a>
<a id="__codelineno-3-129" name="__codelineno-3-129" href="#__codelineno-3-129"></a>    <span class="k">return</span> <span class="n">dataset</span>
<a id="__codelineno-3-130" name="__codelineno-3-130" href="#__codelineno-3-130"></a>
<a id="__codelineno-3-131" name="__codelineno-3-131" href="#__codelineno-3-131"></a><span class="n">DATASET_COLUMNS_TO_KEEP</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-3-132" name="__codelineno-3-132" href="#__codelineno-3-132"></a>                    <span class="s1">&#39;meetingDate&#39;</span><span class="p">,</span>
<a id="__codelineno-3-133" name="__codelineno-3-133" href="#__codelineno-3-133"></a>                    <span class="s1">&#39;state&#39;</span><span class="p">,</span>
<a id="__codelineno-3-134" name="__codelineno-3-134" href="#__codelineno-3-134"></a>                    <span class="s1">&#39;track&#39;</span><span class="p">,</span>
<a id="__codelineno-3-135" name="__codelineno-3-135" href="#__codelineno-3-135"></a>                    <span class="s1">&#39;distance&#39;</span><span class="p">,</span>
<a id="__codelineno-3-136" name="__codelineno-3-136" href="#__codelineno-3-136"></a>                    <span class="s1">&#39;raceId&#39;</span><span class="p">,</span>
<a id="__codelineno-3-137" name="__codelineno-3-137" href="#__codelineno-3-137"></a>                    <span class="s1">&#39;raceTypeCode&#39;</span><span class="p">,</span>
<a id="__codelineno-3-138" name="__codelineno-3-138" href="#__codelineno-3-138"></a>                    <span class="s1">&#39;raceNumber&#39;</span><span class="p">,</span>
<a id="__codelineno-3-139" name="__codelineno-3-139" href="#__codelineno-3-139"></a>                    <span class="s1">&#39;boxNumber&#39;</span><span class="p">,</span>
<a id="__codelineno-3-140" name="__codelineno-3-140" href="#__codelineno-3-140"></a>                    <span class="s1">&#39;rugNumber&#39;</span><span class="p">,</span>
<a id="__codelineno-3-141" name="__codelineno-3-141" href="#__codelineno-3-141"></a>                    <span class="s1">&#39;runId&#39;</span><span class="p">,</span>
<a id="__codelineno-3-142" name="__codelineno-3-142" href="#__codelineno-3-142"></a>                    <span class="s1">&#39;dogId&#39;</span><span class="p">,</span>
<a id="__codelineno-3-143" name="__codelineno-3-143" href="#__codelineno-3-143"></a>                    <span class="s1">&#39;dogName&#39;</span><span class="p">,</span>
<a id="__codelineno-3-144" name="__codelineno-3-144" href="#__codelineno-3-144"></a>                    <span class="s1">&#39;weightInKg&#39;</span><span class="p">,</span>
<a id="__codelineno-3-145" name="__codelineno-3-145" href="#__codelineno-3-145"></a>                    <span class="s1">&#39;sex&#39;</span><span class="p">,</span>
<a id="__codelineno-3-146" name="__codelineno-3-146" href="#__codelineno-3-146"></a>                    <span class="s1">&#39;trainerId&#39;</span><span class="p">,</span>
<a id="__codelineno-3-147" name="__codelineno-3-147" href="#__codelineno-3-147"></a>                    <span class="s1">&#39;trainerState&#39;</span><span class="p">,</span>
<a id="__codelineno-3-148" name="__codelineno-3-148" href="#__codelineno-3-148"></a>                    <span class="s1">&#39;damId&#39;</span><span class="p">,</span>
<a id="__codelineno-3-149" name="__codelineno-3-149" href="#__codelineno-3-149"></a>                    <span class="s1">&#39;damName&#39;</span><span class="p">,</span>
<a id="__codelineno-3-150" name="__codelineno-3-150" href="#__codelineno-3-150"></a>                    <span class="s1">&#39;sireId&#39;</span><span class="p">,</span>
<a id="__codelineno-3-151" name="__codelineno-3-151" href="#__codelineno-3-151"></a>                    <span class="s1">&#39;sireName&#39;</span><span class="p">,</span>
<a id="__codelineno-3-152" name="__codelineno-3-152" href="#__codelineno-3-152"></a>                    <span class="s1">&#39;win&#39;</span><span class="p">,</span>
<a id="__codelineno-3-153" name="__codelineno-3-153" href="#__codelineno-3-153"></a>                    <span class="s1">&#39;speed_index&#39;</span><span class="p">,</span>
<a id="__codelineno-3-154" name="__codelineno-3-154" href="#__codelineno-3-154"></a>                    <span class="s1">&#39;dogAgeScaled&#39;</span><span class="p">,</span>
<a id="__codelineno-3-155" name="__codelineno-3-155" href="#__codelineno-3-155"></a>                    <span class="s1">&#39;lastFiveWinPercentage&#39;</span><span class="p">,</span>
<a id="__codelineno-3-156" name="__codelineno-3-156" href="#__codelineno-3-156"></a>                    <span class="s1">&#39;lastFivePlacePercentage&#39;</span><span class="p">,</span>
<a id="__codelineno-3-157" name="__codelineno-3-157" href="#__codelineno-3-157"></a>                    <span class="s1">&#39;weightInKgScaled&#39;</span><span class="p">,</span>
<a id="__codelineno-3-158" name="__codelineno-3-158" href="#__codelineno-3-158"></a>                    <span class="s1">&#39;rolling_box_win_percentage&#39;</span><span class="p">,</span>
<a id="__codelineno-3-159" name="__codelineno-3-159" href="#__codelineno-3-159"></a>                    <span class="s1">&#39;hasAtLeast1VacantBox&#39;</span><span class="p">]</span>
<a id="__codelineno-3-160" name="__codelineno-3-160" href="#__codelineno-3-160"></a>
<a id="__codelineno-3-161" name="__codelineno-3-161" href="#__codelineno-3-161"></a><span class="k">def</span> <span class="nf">generate_modelling_dataset</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">feature_cols</span><span class="p">):</span>
<a id="__codelineno-3-162" name="__codelineno-3-162" href="#__codelineno-3-162"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<a id="__codelineno-3-163" name="__codelineno-3-163" href="#__codelineno-3-163"></a><span class="sd">    This function extends the list of feature columns from the generate_rollingFeatures function by adding the features we previously created, and then keeps only the columns specified to prepare the dataset for training by the algorithm</span>
<a id="__codelineno-3-164" name="__codelineno-3-164" href="#__codelineno-3-164"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-3-165" name="__codelineno-3-165" href="#__codelineno-3-165"></a>    <span class="c1"># Extend the feature_cols list</span>
<a id="__codelineno-3-166" name="__codelineno-3-166" href="#__codelineno-3-166"></a>    <span class="n">feature_cols</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">&#39;dogAgeScaled&#39;</span><span class="p">,</span>
<a id="__codelineno-3-167" name="__codelineno-3-167" href="#__codelineno-3-167"></a>                <span class="s1">&#39;lastFiveWinPercentage&#39;</span><span class="p">,</span>
<a id="__codelineno-3-168" name="__codelineno-3-168" href="#__codelineno-3-168"></a>                <span class="s1">&#39;lastFivePlacePercentage&#39;</span><span class="p">,</span>
<a id="__codelineno-3-169" name="__codelineno-3-169" href="#__codelineno-3-169"></a>                <span class="s1">&#39;weightInKgScaled&#39;</span><span class="p">,</span>
<a id="__codelineno-3-170" name="__codelineno-3-170" href="#__codelineno-3-170"></a>                <span class="s1">&#39;rolling_box_win_percentage&#39;</span><span class="p">,</span>
<a id="__codelineno-3-171" name="__codelineno-3-171" href="#__codelineno-3-171"></a>                <span class="s1">&#39;hasAtLeast1VacantBox&#39;</span><span class="p">])</span>
<a id="__codelineno-3-172" name="__codelineno-3-172" href="#__codelineno-3-172"></a>
<a id="__codelineno-3-173" name="__codelineno-3-173" href="#__codelineno-3-173"></a>    <span class="c1"># Trim the dataset</span>
<a id="__codelineno-3-174" name="__codelineno-3-174" href="#__codelineno-3-174"></a>    <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="n">DATASET_COLUMNS_TO_KEEP</span> <span class="o">+</span> <span class="n">feature_cols</span><span class="p">]</span>
<a id="__codelineno-3-175" name="__codelineno-3-175" href="#__codelineno-3-175"></a>
<a id="__codelineno-3-176" name="__codelineno-3-176" href="#__codelineno-3-176"></a>    <span class="c1"># Fill any missing values with 0 as a final step before training</span>
<a id="__codelineno-3-177" name="__codelineno-3-177" href="#__codelineno-3-177"></a>    <span class="n">dataset</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-3-178" name="__codelineno-3-178" href="#__codelineno-3-178"></a>
<a id="__codelineno-3-179" name="__codelineno-3-179" href="#__codelineno-3-179"></a>    <span class="c1"># Drop any duplicate runIds</span>
<a id="__codelineno-3-180" name="__codelineno-3-180" href="#__codelineno-3-180"></a>    <span class="n">dataset</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;runId&#39;</span><span class="p">],</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-3-181" name="__codelineno-3-181" href="#__codelineno-3-181"></a>
<a id="__codelineno-3-182" name="__codelineno-3-182" href="#__codelineno-3-182"></a>    <span class="k">return</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">feature_cols</span>
<a id="__codelineno-3-183" name="__codelineno-3-183" href="#__codelineno-3-183"></a>
<a id="__codelineno-3-184" name="__codelineno-3-184" href="#__codelineno-3-184"></a><span class="n">dataset</span> <span class="o">=</span> <span class="n">discard_first_year</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span><span class="n">start_date</span><span class="p">)</span>
<a id="__codelineno-3-185" name="__codelineno-3-185" href="#__codelineno-3-185"></a>
<a id="__codelineno-3-186" name="__codelineno-3-186" href="#__codelineno-3-186"></a><span class="n">dataset</span><span class="p">,</span> <span class="n">feature_cols</span> <span class="o">=</span> <span class="n">generate_modelling_dataset</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">feature_cols</span><span class="p">)</span>
</code></pre></div>
<p>Now that we've created our features, lets feed them into our Machine Learning Algorithm to generate some probabilities!</p>
<h2 id="training">Training</h2>
<div class="highlight"><span class="filename">Training the model</span><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">GradientBoostingClassifier</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="kn">from</span> <span class="nn">sklearn.neural_network</span> <span class="kn">import</span> <span class="n">MLPClassifier</span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="kn">from</span> <span class="nn">sklearn.neighbors</span> <span class="kn">import</span> <span class="n">KNeighborsClassifier</span>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="kn">from</span> <span class="nn">sklearn.tree</span> <span class="kn">import</span> <span class="n">DecisionTreeClassifier</span>
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestClassifier</span><span class="p">,</span> <span class="n">AdaBoostClassifier</span>
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="kn">from</span> <span class="nn">sklearn.naive_bayes</span> <span class="kn">import</span> <span class="n">GaussianNB</span>
<a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a><span class="kn">from</span> <span class="nn">sklearn.discriminant_analysis</span> <span class="kn">import</span> <span class="n">QuadraticDiscriminantAnalysis</span>
<a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a><span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LogisticRegression</span>
<a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a>
<a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a><span class="kn">import</span> <span class="nn">pickle</span>
<a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a><span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">log_loss</span>
<a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a><span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">brier_score_loss</span>
<a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a><span class="kn">import</span> <span class="nn">time</span>
<a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a>
<a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a><span class="c1"># Gradient Boosting Machines libraries</span>
<a id="__codelineno-4-16" name="__codelineno-4-16" href="#__codelineno-4-16"></a><span class="kn">from</span> <span class="nn">lightgbm</span> <span class="kn">import</span> <span class="n">LGBMClassifier</span>
<a id="__codelineno-4-17" name="__codelineno-4-17" href="#__codelineno-4-17"></a><span class="kn">from</span> <span class="nn">xgboost</span> <span class="kn">import</span> <span class="n">XGBClassifier</span>
<a id="__codelineno-4-18" name="__codelineno-4-18" href="#__codelineno-4-18"></a><span class="kn">from</span> <span class="nn">catboost</span> <span class="kn">import</span> <span class="n">CatBoostClassifier</span>
<a id="__codelineno-4-19" name="__codelineno-4-19" href="#__codelineno-4-19"></a>
<a id="__codelineno-4-20" name="__codelineno-4-20" href="#__codelineno-4-20"></a><span class="c1"># Common models parameters</span>
<a id="__codelineno-4-21" name="__codelineno-4-21" href="#__codelineno-4-21"></a><span class="n">verbose</span>       <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-4-22" name="__codelineno-4-22" href="#__codelineno-4-22"></a><span class="n">learning_rate</span> <span class="o">=</span> <span class="mf">0.1</span>
<a id="__codelineno-4-23" name="__codelineno-4-23" href="#__codelineno-4-23"></a><span class="n">n_estimators</span>  <span class="o">=</span> <span class="mi">500</span>
<a id="__codelineno-4-24" name="__codelineno-4-24" href="#__codelineno-4-24"></a>
<a id="__codelineno-4-25" name="__codelineno-4-25" href="#__codelineno-4-25"></a><span class="k">def</span> <span class="nf">define_models</span><span class="p">():</span>
<a id="__codelineno-4-26" name="__codelineno-4-26" href="#__codelineno-4-26"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<a id="__codelineno-4-27" name="__codelineno-4-27" href="#__codelineno-4-27"></a><span class="sd">    This function defines a number of machine learning algorithms with some suggested hyperparameters.</span>
<a id="__codelineno-4-28" name="__codelineno-4-28" href="#__codelineno-4-28"></a><span class="sd">    The purpose of this is to demonstrate the differences in accuracy as well as training times for each different algorithm specifically in relation to this dataset</span>
<a id="__codelineno-4-29" name="__codelineno-4-29" href="#__codelineno-4-29"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-4-30" name="__codelineno-4-30" href="#__codelineno-4-30"></a>    <span class="c1"># Train different types of models</span>
<a id="__codelineno-4-31" name="__codelineno-4-31" href="#__codelineno-4-31"></a>    <span class="n">models</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-4-32" name="__codelineno-4-32" href="#__codelineno-4-32"></a>        <span class="s1">&#39;GradientBoostingClassifier&#39;</span><span class="p">:</span> <span class="n">GradientBoostingClassifier</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="n">learning_rate</span><span class="o">=</span><span class="n">learning_rate</span><span class="p">,</span> <span class="n">n_estimators</span><span class="o">=</span><span class="n">n_estimators</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">max_features</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span>
<a id="__codelineno-4-33" name="__codelineno-4-33" href="#__codelineno-4-33"></a>        <span class="s1">&#39;RandomForestClassifier&#39;</span><span class="p">:</span>     <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="n">n_estimators</span><span class="o">=</span><span class="n">n_estimators</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">max_features</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">min_samples_leaf</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">min_samples_split</span><span class="o">=</span><span class="mi">10</span><span class="p">),</span>
<a id="__codelineno-4-34" name="__codelineno-4-34" href="#__codelineno-4-34"></a>        <span class="s1">&#39;LGBMClassifier&#39;</span><span class="p">:</span>             <span class="n">LGBMClassifier</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="n">learning_rate</span><span class="p">,</span> <span class="n">n_estimators</span><span class="o">=</span><span class="n">n_estimators</span><span class="p">,</span> <span class="n">force_col_wise</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">num_leaves</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span><span class="n">verbose</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span>
<a id="__codelineno-4-35" name="__codelineno-4-35" href="#__codelineno-4-35"></a>        <span class="s1">&#39;XGBClassifier&#39;</span><span class="p">:</span>              <span class="n">XGBClassifier</span><span class="p">(</span><span class="n">verbosity</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="n">learning_rate</span><span class="o">=</span><span class="n">learning_rate</span><span class="p">,</span> <span class="n">n_estimators</span><span class="o">=</span><span class="n">n_estimators</span><span class="p">,</span> <span class="n">max_depth</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span> <span class="n">subsample</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">objective</span><span class="o">=</span><span class="s1">&#39;binary:logistic&#39;</span><span class="p">),</span>
<a id="__codelineno-4-36" name="__codelineno-4-36" href="#__codelineno-4-36"></a>        <span class="s1">&#39;CatBoostClassifier&#39;</span><span class="p">:</span>         <span class="n">CatBoostClassifier</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="n">learning_rate</span><span class="o">=</span><span class="n">learning_rate</span><span class="p">,</span> <span class="n">n_estimators</span><span class="o">=</span><span class="n">n_estimators</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">l2_leaf_reg</span><span class="o">=</span><span class="mi">10</span><span class="p">),</span>
<a id="__codelineno-4-37" name="__codelineno-4-37" href="#__codelineno-4-37"></a>        <span class="s1">&#39;KNeighborsClassifier&#39;</span><span class="p">:</span>       <span class="n">KNeighborsClassifier</span><span class="p">(</span><span class="n">n_neighbors</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span><span class="n">weights</span><span class="o">=</span><span class="s1">&#39;distance&#39;</span><span class="p">,</span><span class="n">p</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
<a id="__codelineno-4-38" name="__codelineno-4-38" href="#__codelineno-4-38"></a>        <span class="s1">&#39;DecisionTreeClassifier&#39;</span><span class="p">:</span>     <span class="n">DecisionTreeClassifier</span><span class="p">(</span><span class="n">max_depth</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">min_samples_split</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">min_samples_leaf</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">max_features</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span>
<a id="__codelineno-4-39" name="__codelineno-4-39" href="#__codelineno-4-39"></a>        <span class="s1">&#39;MLPClassifier&#39;</span><span class="p">:</span>              <span class="n">MLPClassifier</span><span class="p">(</span><span class="n">hidden_layer_sizes</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span><span class="n">solver</span><span class="o">=</span><span class="s1">&#39;adam&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">),</span>
<a id="__codelineno-4-40" name="__codelineno-4-40" href="#__codelineno-4-40"></a>        <span class="s1">&#39;AdaBoostClassifier&#39;</span><span class="p">:</span>         <span class="n">AdaBoostClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="n">n_estimators</span><span class="p">,</span><span class="n">learning_rate</span><span class="o">=</span><span class="n">learning_rate</span><span class="p">,</span><span class="n">algorithm</span><span class="o">=</span><span class="s1">&#39;SAMME&#39;</span><span class="p">),</span>
<a id="__codelineno-4-41" name="__codelineno-4-41" href="#__codelineno-4-41"></a>        <span class="s1">&#39;GuassianNB&#39;</span><span class="p">:</span>                 <span class="n">GaussianNB</span><span class="p">(),</span>
<a id="__codelineno-4-42" name="__codelineno-4-42" href="#__codelineno-4-42"></a>        <span class="s1">&#39;QuadDiscriminantAnalysis&#39;</span><span class="p">:</span>   <span class="n">QuadraticDiscriminantAnalysis</span><span class="p">(),</span>
<a id="__codelineno-4-43" name="__codelineno-4-43" href="#__codelineno-4-43"></a>        <span class="s1">&#39;LogisticsRegression&#39;</span><span class="p">:</span>        <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="s1">&#39;liblinear&#39;</span><span class="p">,</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">5000000</span><span class="p">,</span> <span class="n">C</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">penalty</span><span class="o">=</span><span class="s1">&#39;l2&#39;</span><span class="p">)</span>
<a id="__codelineno-4-44" name="__codelineno-4-44" href="#__codelineno-4-44"></a>    <span class="p">}</span>
<a id="__codelineno-4-45" name="__codelineno-4-45" href="#__codelineno-4-45"></a>
<a id="__codelineno-4-46" name="__codelineno-4-46" href="#__codelineno-4-46"></a>    <span class="k">return</span> <span class="n">models</span>
<a id="__codelineno-4-47" name="__codelineno-4-47" href="#__codelineno-4-47"></a>
<a id="__codelineno-4-48" name="__codelineno-4-48" href="#__codelineno-4-48"></a><span class="n">models</span> <span class="o">=</span> <span class="n">define_models</span><span class="p">()</span>
<a id="__codelineno-4-49" name="__codelineno-4-49" href="#__codelineno-4-49"></a>
<a id="__codelineno-4-50" name="__codelineno-4-50" href="#__codelineno-4-50"></a><span class="k">def</span> <span class="nf">remove_races</span><span class="p">(</span><span class="n">dataset</span><span class="p">):</span>
<a id="__codelineno-4-51" name="__codelineno-4-51" href="#__codelineno-4-51"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<a id="__codelineno-4-52" name="__codelineno-4-52" href="#__codelineno-4-52"></a><span class="sd">    This function discards Qualifying Trials and any races which may only have 1 runner like Match Races which are outside the scope of this model</span>
<a id="__codelineno-4-53" name="__codelineno-4-53" href="#__codelineno-4-53"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-4-54" name="__codelineno-4-54" href="#__codelineno-4-54"></a>    <span class="c1">#remove trial races</span>
<a id="__codelineno-4-55" name="__codelineno-4-55" href="#__codelineno-4-55"></a>    <span class="n">final_dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;raceTypeCode&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;QT&#39;</span><span class="p">]</span>
<a id="__codelineno-4-56" name="__codelineno-4-56" href="#__codelineno-4-56"></a>
<a id="__codelineno-4-57" name="__codelineno-4-57" href="#__codelineno-4-57"></a>    <span class="c1"># Remove rows where raceId appears only once</span>
<a id="__codelineno-4-58" name="__codelineno-4-58" href="#__codelineno-4-58"></a>    <span class="n">counts</span> <span class="o">=</span> <span class="n">final_dataset</span><span class="p">[</span><span class="s1">&#39;raceId&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
<a id="__codelineno-4-59" name="__codelineno-4-59" href="#__codelineno-4-59"></a>    <span class="n">repeated_raceIds</span> <span class="o">=</span> <span class="n">counts</span><span class="p">[</span><span class="n">counts</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>
<a id="__codelineno-4-60" name="__codelineno-4-60" href="#__codelineno-4-60"></a>    <span class="n">final_dataset</span> <span class="o">=</span> <span class="n">final_dataset</span><span class="p">[</span><span class="n">final_dataset</span><span class="p">[</span><span class="s1">&#39;raceId&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">repeated_raceIds</span><span class="p">)]</span>
<a id="__codelineno-4-61" name="__codelineno-4-61" href="#__codelineno-4-61"></a>
<a id="__codelineno-4-62" name="__codelineno-4-62" href="#__codelineno-4-62"></a>    <span class="k">return</span> <span class="n">final_dataset</span>
<a id="__codelineno-4-63" name="__codelineno-4-63" href="#__codelineno-4-63"></a>
<a id="__codelineno-4-64" name="__codelineno-4-64" href="#__codelineno-4-64"></a><span class="n">final_dataset</span> <span class="o">=</span> <span class="n">remove_races</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
<a id="__codelineno-4-65" name="__codelineno-4-65" href="#__codelineno-4-65"></a>
<a id="__codelineno-4-66" name="__codelineno-4-66" href="#__codelineno-4-66"></a><span class="k">def</span> <span class="nf">downcast_data</span><span class="p">(</span><span class="n">final_dataset</span><span class="p">):</span>
<a id="__codelineno-4-67" name="__codelineno-4-67" href="#__codelineno-4-67"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<a id="__codelineno-4-68" name="__codelineno-4-68" href="#__codelineno-4-68"></a><span class="sd">    This function downcasts int64 and float64 to int32 and float32 respectively in order to reduce the memory usage of the model during the training process</span>
<a id="__codelineno-4-69" name="__codelineno-4-69" href="#__codelineno-4-69"></a><span class="sd">    For systems with high RAM capacity this may not be required. Feel free to comment out this function, however it may result in memory allocation failures</span>
<a id="__codelineno-4-70" name="__codelineno-4-70" href="#__codelineno-4-70"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-4-71" name="__codelineno-4-71" href="#__codelineno-4-71"></a>    <span class="c1"># Loop through each column and convert int64 to int32 and float64 to float32</span>
<a id="__codelineno-4-72" name="__codelineno-4-72" href="#__codelineno-4-72"></a>    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">final_dataset</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
<a id="__codelineno-4-73" name="__codelineno-4-73" href="#__codelineno-4-73"></a>        <span class="k">if</span> <span class="n">final_dataset</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;int64&#39;</span><span class="p">:</span>
<a id="__codelineno-4-74" name="__codelineno-4-74" href="#__codelineno-4-74"></a>            <span class="n">final_dataset</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_dataset</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int32&#39;</span><span class="p">)</span>
<a id="__codelineno-4-75" name="__codelineno-4-75" href="#__codelineno-4-75"></a>        <span class="k">elif</span> <span class="n">final_dataset</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;float64&#39;</span><span class="p">:</span>
<a id="__codelineno-4-76" name="__codelineno-4-76" href="#__codelineno-4-76"></a>            <span class="n">final_dataset</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_dataset</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
<a id="__codelineno-4-77" name="__codelineno-4-77" href="#__codelineno-4-77"></a>
<a id="__codelineno-4-78" name="__codelineno-4-78" href="#__codelineno-4-78"></a>    <span class="k">return</span> <span class="n">final_dataset</span>
<a id="__codelineno-4-79" name="__codelineno-4-79" href="#__codelineno-4-79"></a>
<a id="__codelineno-4-80" name="__codelineno-4-80" href="#__codelineno-4-80"></a><span class="n">final_dataset</span> <span class="o">=</span> <span class="n">downcast_data</span><span class="p">(</span><span class="n">final_dataset</span><span class="p">)</span>
<a id="__codelineno-4-81" name="__codelineno-4-81" href="#__codelineno-4-81"></a>
<a id="__codelineno-4-82" name="__codelineno-4-82" href="#__codelineno-4-82"></a><span class="k">def</span> <span class="nf">train_test_split</span><span class="p">(</span><span class="n">final_dataset</span><span class="p">,</span><span class="n">end_date</span><span class="p">):</span>
<a id="__codelineno-4-83" name="__codelineno-4-83" href="#__codelineno-4-83"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<a id="__codelineno-4-84" name="__codelineno-4-84" href="#__codelineno-4-84"></a><span class="sd">    This function splits the dataset into a training set and a test set for the purposes of model training.</span>
<a id="__codelineno-4-85" name="__codelineno-4-85" href="#__codelineno-4-85"></a><span class="sd">    This is to enable testing of the trained model on an unseen test set to establish statistical metrics regarding its accuracy</span>
<a id="__codelineno-4-86" name="__codelineno-4-86" href="#__codelineno-4-86"></a><span class="sd">    There are other ways to split a dataset into test and training sets, however this method is useful for the purposes of backtesting profitability</span>
<a id="__codelineno-4-87" name="__codelineno-4-87" href="#__codelineno-4-87"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-4-88" name="__codelineno-4-88" href="#__codelineno-4-88"></a>    <span class="c1"># Split the data into train and test data</span>
<a id="__codelineno-4-89" name="__codelineno-4-89" href="#__codelineno-4-89"></a>    <span class="n">train_data</span> <span class="o">=</span> <span class="n">final_dataset</span><span class="p">[</span><span class="n">final_dataset</span><span class="p">[</span><span class="s1">&#39;meetingDate&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">end_date</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">years</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-4-90" name="__codelineno-4-90" href="#__codelineno-4-90"></a>    <span class="n">test_data</span> <span class="o">=</span> <span class="n">final_dataset</span><span class="p">[</span><span class="n">final_dataset</span><span class="p">[</span><span class="s1">&#39;meetingDate&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">end_date</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">years</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-4-91" name="__codelineno-4-91" href="#__codelineno-4-91"></a>
<a id="__codelineno-4-92" name="__codelineno-4-92" href="#__codelineno-4-92"></a>    <span class="k">return</span> <span class="n">test_data</span><span class="p">,</span> <span class="n">train_data</span>
<a id="__codelineno-4-93" name="__codelineno-4-93" href="#__codelineno-4-93"></a>
<a id="__codelineno-4-94" name="__codelineno-4-94" href="#__codelineno-4-94"></a><span class="n">test_data</span><span class="p">,</span> <span class="n">train_data</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">final_dataset</span><span class="p">,</span><span class="n">end_date</span><span class="p">)</span>
<a id="__codelineno-4-95" name="__codelineno-4-95" href="#__codelineno-4-95"></a>
<a id="__codelineno-4-96" name="__codelineno-4-96" href="#__codelineno-4-96"></a><span class="k">def</span> <span class="nf">generate_xy</span><span class="p">(</span><span class="n">test_data</span><span class="p">,</span> <span class="n">train_data</span><span class="p">):</span>
<a id="__codelineno-4-97" name="__codelineno-4-97" href="#__codelineno-4-97"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<a id="__codelineno-4-98" name="__codelineno-4-98" href="#__codelineno-4-98"></a><span class="sd">    This function separates the target column &#39;win&#39; from the actual features of the dataset and also seperates the training features from the race metadata which is not being used for the training (e.g. raceId)</span>
<a id="__codelineno-4-99" name="__codelineno-4-99" href="#__codelineno-4-99"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-4-100" name="__codelineno-4-100" href="#__codelineno-4-100"></a>    <span class="n">train_x</span><span class="p">,</span> <span class="n">train_y</span> <span class="o">=</span> <span class="n">train_data</span><span class="p">[</span><span class="n">feature_cols</span><span class="p">],</span> <span class="n">train_data</span><span class="p">[</span><span class="s1">&#39;win&#39;</span><span class="p">]</span>
<a id="__codelineno-4-101" name="__codelineno-4-101" href="#__codelineno-4-101"></a>    <span class="n">test_x</span><span class="p">,</span> <span class="n">test_y</span> <span class="o">=</span> <span class="n">test_data</span><span class="p">[</span><span class="n">feature_cols</span><span class="p">],</span> <span class="n">test_data</span><span class="p">[</span><span class="s1">&#39;win&#39;</span><span class="p">]</span>
<a id="__codelineno-4-102" name="__codelineno-4-102" href="#__codelineno-4-102"></a>
<a id="__codelineno-4-103" name="__codelineno-4-103" href="#__codelineno-4-103"></a>    <span class="k">return</span> <span class="n">train_x</span><span class="p">,</span> <span class="n">train_y</span><span class="p">,</span> <span class="n">test_x</span><span class="p">,</span> <span class="n">test_y</span>
<a id="__codelineno-4-104" name="__codelineno-4-104" href="#__codelineno-4-104"></a>
<a id="__codelineno-4-105" name="__codelineno-4-105" href="#__codelineno-4-105"></a><span class="n">train_x</span><span class="p">,</span> <span class="n">train_y</span><span class="p">,</span> <span class="n">test_x</span><span class="p">,</span> <span class="n">test_y</span> <span class="o">=</span> <span class="n">generate_xy</span><span class="p">(</span><span class="n">test_data</span><span class="p">,</span> <span class="n">train_data</span><span class="p">)</span>
<a id="__codelineno-4-106" name="__codelineno-4-106" href="#__codelineno-4-106"></a>
<a id="__codelineno-4-107" name="__codelineno-4-107" href="#__codelineno-4-107"></a><span class="k">def</span> <span class="nf">train_models</span><span class="p">(</span><span class="n">models</span><span class="p">,</span><span class="n">train_x</span><span class="p">,</span> <span class="n">train_y</span><span class="p">,</span> <span class="n">test_x</span><span class="p">,</span> <span class="n">test_y</span><span class="p">,</span> <span class="n">test_data</span><span class="p">):</span>
<a id="__codelineno-4-108" name="__codelineno-4-108" href="#__codelineno-4-108"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<a id="__codelineno-4-109" name="__codelineno-4-109" href="#__codelineno-4-109"></a><span class="sd">    This function loads each individual machine learning algorithm and trains each model on the training dataset.</span>
<a id="__codelineno-4-110" name="__codelineno-4-110" href="#__codelineno-4-110"></a><span class="sd">    It begins by initialising an empty list and passing over each model by training it and then normalising the probabilities to 1 for each race field.</span>
<a id="__codelineno-4-111" name="__codelineno-4-111" href="#__codelineno-4-111"></a><span class="sd">    This normalisation could not be performed if a different method was used to generate the train/test split that resulted in incomplete race fields being included</span>
<a id="__codelineno-4-112" name="__codelineno-4-112" href="#__codelineno-4-112"></a>
<a id="__codelineno-4-113" name="__codelineno-4-113" href="#__codelineno-4-113"></a><span class="sd">    Once normalised, then the log loss and brier score for each model is calculated and printed. These scores are not stored, merely displayed as indicators (along with the training time for each algorithm)</span>
<a id="__codelineno-4-114" name="__codelineno-4-114" href="#__codelineno-4-114"></a><span class="sd">    Finally the trained model (also called a pickle) is &#39;dumped&#39; (i.e. saved) as a _pickle.dat file</span>
<a id="__codelineno-4-115" name="__codelineno-4-115" href="#__codelineno-4-115"></a>
<a id="__codelineno-4-116" name="__codelineno-4-116" href="#__codelineno-4-116"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-4-117" name="__codelineno-4-117" href="#__codelineno-4-117"></a>    <span class="n">probs_columns</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-4-118" name="__codelineno-4-118" href="#__codelineno-4-118"></a>
<a id="__codelineno-4-119" name="__codelineno-4-119" href="#__codelineno-4-119"></a>    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">models</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-4-120" name="__codelineno-4-120" href="#__codelineno-4-120"></a>
<a id="__codelineno-4-121" name="__codelineno-4-121" href="#__codelineno-4-121"></a>        <span class="n">prob_col_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;prob_</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">&#39;</span>
<a id="__codelineno-4-122" name="__codelineno-4-122" href="#__codelineno-4-122"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Fitting model </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1"> for </span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-4-123" name="__codelineno-4-123" href="#__codelineno-4-123"></a>
<a id="__codelineno-4-124" name="__codelineno-4-124" href="#__codelineno-4-124"></a>        <span class="c1"># time and train the model</span>
<a id="__codelineno-4-125" name="__codelineno-4-125" href="#__codelineno-4-125"></a>        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>  <span class="c1"># Record start time</span>
<a id="__codelineno-4-126" name="__codelineno-4-126" href="#__codelineno-4-126"></a>        <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_x</span><span class="p">,</span> <span class="n">train_y</span><span class="p">)</span>
<a id="__codelineno-4-127" name="__codelineno-4-127" href="#__codelineno-4-127"></a>        <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>  <span class="c1"># Record end time</span>
<a id="__codelineno-4-128" name="__codelineno-4-128" href="#__codelineno-4-128"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Training time for </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">end_time</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_time</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>
<a id="__codelineno-4-129" name="__codelineno-4-129" href="#__codelineno-4-129"></a>
<a id="__codelineno-4-130" name="__codelineno-4-130" href="#__codelineno-4-130"></a>        <span class="c1"># Calculate runner win probability</span>
<a id="__codelineno-4-131" name="__codelineno-4-131" href="#__codelineno-4-131"></a>        <span class="n">dog_win_probs</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">test_x</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-4-132" name="__codelineno-4-132" href="#__codelineno-4-132"></a>        <span class="n">test_data</span><span class="p">[</span><span class="n">prob_col_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">dog_win_probs</span>
<a id="__codelineno-4-133" name="__codelineno-4-133" href="#__codelineno-4-133"></a>
<a id="__codelineno-4-134" name="__codelineno-4-134" href="#__codelineno-4-134"></a>        <span class="c1"># Normalise probabilities</span>
<a id="__codelineno-4-135" name="__codelineno-4-135" href="#__codelineno-4-135"></a>        <span class="n">test_data</span><span class="p">[</span><span class="n">prob_col_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">test_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;raceId&#39;</span><span class="p">,</span> <span class="n">group_keys</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="sa">f</span><span class="s1">&#39;prob_</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
<a id="__codelineno-4-136" name="__codelineno-4-136" href="#__codelineno-4-136"></a>
<a id="__codelineno-4-137" name="__codelineno-4-137" href="#__codelineno-4-137"></a>        <span class="c1"># Assign the dog with the highest probability a value of 1 as the predicted race winner</span>
<a id="__codelineno-4-138" name="__codelineno-4-138" href="#__codelineno-4-138"></a>        <span class="n">test_data</span><span class="p">[</span><span class="s1">&#39;predicted_winner&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">test_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;raceId&#39;</span><span class="p">,</span> <span class="n">group_keys</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="sa">f</span><span class="s1">&#39;prob_</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">==</span> <span class="nb">max</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
<a id="__codelineno-4-139" name="__codelineno-4-139" href="#__codelineno-4-139"></a>
<a id="__codelineno-4-140" name="__codelineno-4-140" href="#__codelineno-4-140"></a>        <span class="c1"># Calculate log loss</span>
<a id="__codelineno-4-141" name="__codelineno-4-141" href="#__codelineno-4-141"></a>        <span class="n">test_loss</span> <span class="o">=</span> <span class="n">log_loss</span><span class="p">(</span><span class="n">train_y</span><span class="p">,</span> <span class="n">test_data</span><span class="p">[</span><span class="n">prob_col_key</span><span class="p">])</span>
<a id="__codelineno-4-142" name="__codelineno-4-142" href="#__codelineno-4-142"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Log loss for </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> on test data: </span><span class="si">{</span><span class="n">test_loss</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-4-143" name="__codelineno-4-143" href="#__codelineno-4-143"></a>
<a id="__codelineno-4-144" name="__codelineno-4-144" href="#__codelineno-4-144"></a>        <span class="c1"># Calculate Brier Score</span>
<a id="__codelineno-4-145" name="__codelineno-4-145" href="#__codelineno-4-145"></a>        <span class="n">brier_score</span> <span class="o">=</span> <span class="n">brier_score_loss</span><span class="p">(</span><span class="n">test_y</span><span class="p">,</span> <span class="n">test_data</span><span class="p">[</span><span class="n">prob_col_key</span><span class="p">])</span>
<a id="__codelineno-4-146" name="__codelineno-4-146" href="#__codelineno-4-146"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Brier score for </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> on test data: </span><span class="si">{</span><span class="n">brier_score</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-4-147" name="__codelineno-4-147" href="#__codelineno-4-147"></a>
<a id="__codelineno-4-148" name="__codelineno-4-148" href="#__codelineno-4-148"></a>        <span class="c1"># Add the probability column key to the list probs_columns</span>
<a id="__codelineno-4-149" name="__codelineno-4-149" href="#__codelineno-4-149"></a>        <span class="n">probs_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prob_col_key</span><span class="p">)</span>
<a id="__codelineno-4-150" name="__codelineno-4-150" href="#__codelineno-4-150"></a>
<a id="__codelineno-4-151" name="__codelineno-4-151" href="#__codelineno-4-151"></a>        <span class="c1"># Dump the pickle file</span>
<a id="__codelineno-4-152" name="__codelineno-4-152" href="#__codelineno-4-152"></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">key</span> <span class="o">+</span> <span class="s1">&#39;_.pickle.dat&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-4-153" name="__codelineno-4-153" href="#__codelineno-4-153"></a>            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
<a id="__codelineno-4-154" name="__codelineno-4-154" href="#__codelineno-4-154"></a>
<a id="__codelineno-4-155" name="__codelineno-4-155" href="#__codelineno-4-155"></a>    <span class="k">return</span> <span class="n">test_data</span><span class="p">,</span> <span class="n">probs_columns</span>
<a id="__codelineno-4-156" name="__codelineno-4-156" href="#__codelineno-4-156"></a>
<a id="__codelineno-4-157" name="__codelineno-4-157" href="#__codelineno-4-157"></a><span class="n">all_models_test_data</span><span class="p">,</span> <span class="n">probs_columns</span> <span class="o">=</span> <span class="n">train_models</span><span class="p">(</span><span class="n">models</span><span class="p">,</span><span class="n">train_x</span><span class="p">,</span> <span class="n">train_y</span><span class="p">,</span> <span class="n">test_x</span><span class="p">,</span> <span class="n">test_y</span><span class="p">,</span> <span class="n">test_data</span><span class="p">)</span>
<a id="__codelineno-4-158" name="__codelineno-4-158" href="#__codelineno-4-158"></a>
<a id="__codelineno-4-159" name="__codelineno-4-159" href="#__codelineno-4-159"></a><span class="n">BACKTESTING_COLUMNS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;meetingDate&#39;</span><span class="p">,</span><span class="s1">&#39;state&#39;</span><span class="p">,</span><span class="s1">&#39;track&#39;</span><span class="p">,</span><span class="s1">&#39;race_number&#39;</span><span class="p">,</span><span class="s1">&#39;boxNumber&#39;</span><span class="p">,</span><span class="s1">&#39;rugNumber&#39;</span><span class="p">]</span>
<a id="__codelineno-4-160" name="__codelineno-4-160" href="#__codelineno-4-160"></a>
<a id="__codelineno-4-161" name="__codelineno-4-161" href="#__codelineno-4-161"></a><span class="k">def</span> <span class="nf">trim_and_export_test_data</span><span class="p">(</span><span class="n">all_models_test_data</span><span class="p">):</span>
<a id="__codelineno-4-162" name="__codelineno-4-162" href="#__codelineno-4-162"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<a id="__codelineno-4-163" name="__codelineno-4-163" href="#__codelineno-4-163"></a><span class="sd">    This functions trims all the model features from the test dataset and outputs only the required the race information in addition to the win probability for each machine learning model to a csv file for the purposes of backtesting</span>
<a id="__codelineno-4-164" name="__codelineno-4-164" href="#__codelineno-4-164"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-4-165" name="__codelineno-4-165" href="#__codelineno-4-165"></a>    <span class="n">trimmed_test_data</span><span class="o">=</span><span class="n">all_models_test_data</span><span class="p">[</span><span class="n">BACKTESTING_COLUMNS</span> <span class="o">+</span> <span class="n">probs_columns</span><span class="p">]</span>
<a id="__codelineno-4-166" name="__codelineno-4-166" href="#__codelineno-4-166"></a>
<a id="__codelineno-4-167" name="__codelineno-4-167" href="#__codelineno-4-167"></a>    <span class="n">trimmed_test_data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;multiple_algorithms_predictions.csv&#39;</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-4-168" name="__codelineno-4-168" href="#__codelineno-4-168"></a>
<a id="__codelineno-4-169" name="__codelineno-4-169" href="#__codelineno-4-169"></a><span class="n">trim_and_export_test_data</span><span class="p">(</span><span class="n">all_models_test_data</span><span class="p">)</span>
</code></pre></div>
<p>Alright, now that we've trained the models, let's have a look at the log loss calculations for each model and the time taken to train each model</p>
<table>
<thead>
<tr>
<th>Model</th>
<th>Training Time</th>
<th>Log Loss</th>
</tr>
</thead>
<tbody>
<tr>
<td>AdaBoostClassifier</td>
<td>6248</td>
<td>0.532</td>
</tr>
<tr>
<td>XGBClassifier</td>
<td>2599</td>
<td>0.278</td>
</tr>
<tr>
<td>RandomForestClassifier</td>
<td>1930</td>
<td>0.269</td>
</tr>
<tr>
<td>MLPClassifier</td>
<td>1513</td>
<td>0.376</td>
</tr>
<tr>
<td>GradientBoostingClassifier</td>
<td>1278</td>
<td>0.308</td>
</tr>
<tr>
<td>LogisticsRegression</td>
<td>492</td>
<td>0.378</td>
</tr>
<tr>
<td>CatBoostClassifier</td>
<td>200</td>
<td>0.355</td>
</tr>
<tr>
<td>LGBMClassifier</td>
<td>92</td>
<td>0.305</td>
</tr>
<tr>
<td>QuadDiscriminantAnalysis</td>
<td>29</td>
<td>3.641</td>
</tr>
<tr>
<td>DecisionTreeClassifier</td>
<td>6</td>
<td>0.278</td>
</tr>
<tr>
<td>GuassianNB</td>
<td>3</td>
<td>7.015</td>
</tr>
<tr>
<td>KNeighborsClassifier</td>
<td>1</td>
<td>0.00000935</td>
</tr>
</tbody>
</table>
<p>As we can see some models took a lot longer than others to train, with the longest being the AdaBoostClassifier taking close to 2 hours and KNeighbours Classifier at 1 second. 
We've only used one set of parameters for training each model. You could try using a GridSearch to find the best parameters for each model.</p>
<p>Here's a great explanation of the differences between log loss and Brier score for machine learning models - <a href="https://www.dratings.com/log-loss-vs-brier-score/">more info</a></p>
<div class="highlight"><span class="filename">Plotting feature importance</span><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="k">def</span> <span class="nf">plot_feature_importance</span><span class="p">(</span><span class="n">models</span><span class="p">):</span>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="sd">    This function iterates through each model in the provided dictionary and plots the feature importance if available.</span>
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a><span class="sd">    If the model has a &#39;feature_importances_&#39; attribute, it plots the feature importance either using &#39;plot_importance&#39; method (if available) or a horizontal bar chart. Each plot is saved as a JPG file with a filename indicating the model name.</span>
<a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a><span class="sd">    If a model does not have feature importance information, a message is printed indicating that.</span>
<a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a>    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">models</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a>
<a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;feature_importances_&#39;</span><span class="p">):</span>
<a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a>            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">70</span><span class="p">))</span>
<a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a>            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;plot_importance&#39;</span><span class="p">):</span>
<a id="__codelineno-5-15" name="__codelineno-5-15" href="#__codelineno-5-15"></a>                <span class="n">model</span><span class="o">.</span><span class="n">plot_importance</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">(),</span> <span class="n">importance_type</span><span class="o">=</span><span class="s1">&#39;gain&#39;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Feature Importance - </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-5-16" name="__codelineno-5-16" href="#__codelineno-5-16"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-5-17" name="__codelineno-5-17" href="#__codelineno-5-17"></a>                <span class="n">feature_importance</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">feature_importances_</span>
<a id="__codelineno-5-18" name="__codelineno-5-18" href="#__codelineno-5-18"></a>                <span class="n">sorted_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">feature_importance</span><span class="p">)</span>
<a id="__codelineno-5-19" name="__codelineno-5-19" href="#__codelineno-5-19"></a>                <span class="n">plt</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">train_x</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">sorted_idx</span><span class="p">],</span> <span class="n">feature_importance</span><span class="p">[</span><span class="n">sorted_idx</span><span class="p">])</span>
<a id="__codelineno-5-20" name="__codelineno-5-20" href="#__codelineno-5-20"></a>                <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Feature Importance&quot;</span><span class="p">)</span>
<a id="__codelineno-5-21" name="__codelineno-5-21" href="#__codelineno-5-21"></a>                <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Features&quot;</span><span class="p">)</span>
<a id="__codelineno-5-22" name="__codelineno-5-22" href="#__codelineno-5-22"></a>                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Feature Importance - </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-5-23" name="__codelineno-5-23" href="#__codelineno-5-23"></a>
<a id="__codelineno-5-24" name="__codelineno-5-24" href="#__codelineno-5-24"></a>            <span class="c1"># Save plot to JPG file</span>
<a id="__codelineno-5-25" name="__codelineno-5-25" href="#__codelineno-5-25"></a>            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;feature_importance_</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">.jpg&#39;</span><span class="p">)</span>
<a id="__codelineno-5-26" name="__codelineno-5-26" href="#__codelineno-5-26"></a>
<a id="__codelineno-5-27" name="__codelineno-5-27" href="#__codelineno-5-27"></a>            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c1"># Close the plot to release memory</span>
<a id="__codelineno-5-28" name="__codelineno-5-28" href="#__codelineno-5-28"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-5-29" name="__codelineno-5-29" href="#__codelineno-5-29"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No feature importance available for </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-5-30" name="__codelineno-5-30" href="#__codelineno-5-30"></a>
<a id="__codelineno-5-31" name="__codelineno-5-31" href="#__codelineno-5-31"></a><span class="n">plot_feature_importance</span><span class="p">(</span><span class="n">models</span><span class="p">)</span>
</code></pre></div>
<p><img alt="png" src="../img/featureImportanceLGBM.png" /></p>
<h2 id="grid-search">Grid Search</h2>
<p>For our first round of training our model, we have used some suggested parameters for each diifferent type of machine learning model. However, perhaps these parameters aren't suited to our use case. In this case we should use a technique called 'Grid Search' to find the best hyperparameters for one of the machine learning models (in this case we'll use LGBM). A grid search methodically tests different hyperparameter combinations, checking each one's performance through cross-validation. This helps pinpoint the best setup that maximises the model's performance metric, like accuracy or area under the curve (AUC).</p>
<p>With LightGBM, which relies heavily on hyperparameters like learning rate, maximum tree depth, and regularization parameters, a grid search is essential. By trying out various combinations of these hyperparameters, we can fine-tune the model for superior predictive performance. LightGBM's speed advantage makes grid search even more appealing. Since it's built for efficiency, the computational burden of grid searching is reduced compared to other algorithms. This means we can explore a wide range of hyperparameters without waiting forever. As above, the AdaBoost Classifier took 1.75 hours to train just once, so for this model would not be appropriate for a Grid Search. LGBM took only 90 seconds, so a grid search of 3 folds for 27 different hyperparameter combinations (81 fits) would take around 120 minutes - much more acceptable.</p>
<p><div class="highlight"><span class="filename">Grid Search for LGBM</span><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">GridSearchCV</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="c1"># Define parameter grid for LGBMClassifier. (More parameters and parameters can be added if desired)</span>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="n">param_grid</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a>    <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">],</span>
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a>    <span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">500</span><span class="p">],</span>
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a>    <span class="s1">&#39;num_leaves&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">120</span><span class="p">]</span>
<a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a><span class="p">}</span>
<a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a>
<a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a><span class="k">def</span> <span class="nf">LGBM_GridSearch</span><span class="p">(</span><span class="n">train_x</span><span class="p">,</span> <span class="n">train_y</span><span class="p">):</span>
<a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a>
<a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a><span class="sd">    This function demonstrates how to perform a gridSearch of different combinations of hyperparameter functions to find an optimal combination for a particular machine learning model</span>
<a id="__codelineno-6-14" name="__codelineno-6-14" href="#__codelineno-6-14"></a><span class="sd">    We have performed the wider model training first in order to find which model has a short enough training time to be a candidate for gridSearch. </span>
<a id="__codelineno-6-15" name="__codelineno-6-15" href="#__codelineno-6-15"></a><span class="sd">    Models with training times of 2 hours per fit won&#39;t be suitable for gridSearch unless the user has a lot of patience.</span>
<a id="__codelineno-6-16" name="__codelineno-6-16" href="#__codelineno-6-16"></a>
<a id="__codelineno-6-17" name="__codelineno-6-17" href="#__codelineno-6-17"></a><span class="sd">    It will perform the grid search and return the parameters associated with the fit with the most favourable neg_log_loss score</span>
<a id="__codelineno-6-18" name="__codelineno-6-18" href="#__codelineno-6-18"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-6-19" name="__codelineno-6-19" href="#__codelineno-6-19"></a>
<a id="__codelineno-6-20" name="__codelineno-6-20" href="#__codelineno-6-20"></a>    <span class="c1"># Initialize LGBMClassifier</span>
<a id="__codelineno-6-21" name="__codelineno-6-21" href="#__codelineno-6-21"></a>    <span class="n">lgbm</span> <span class="o">=</span> <span class="n">LGBMClassifier</span><span class="p">(</span><span class="n">force_col_wise</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-6-22" name="__codelineno-6-22" href="#__codelineno-6-22"></a>
<a id="__codelineno-6-23" name="__codelineno-6-23" href="#__codelineno-6-23"></a>    <span class="c1"># Initialize GridSearchCV</span>
<a id="__codelineno-6-24" name="__codelineno-6-24" href="#__codelineno-6-24"></a>    <span class="n">grid_search</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span><span class="n">estimator</span><span class="o">=</span><span class="n">lgbm</span><span class="p">,</span> <span class="n">param_grid</span><span class="o">=</span><span class="n">param_grid</span><span class="p">,</span> <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;neg_log_loss&#39;</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<a id="__codelineno-6-25" name="__codelineno-6-25" href="#__codelineno-6-25"></a>
<a id="__codelineno-6-26" name="__codelineno-6-26" href="#__codelineno-6-26"></a>    <span class="c1"># Fit GridSearchCV</span>
<a id="__codelineno-6-27" name="__codelineno-6-27" href="#__codelineno-6-27"></a>    <span class="n">grid_search</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_x</span><span class="p">,</span> <span class="n">train_y</span><span class="p">)</span>
<a id="__codelineno-6-28" name="__codelineno-6-28" href="#__codelineno-6-28"></a>
<a id="__codelineno-6-29" name="__codelineno-6-29" href="#__codelineno-6-29"></a>    <span class="c1"># Print results</span>
<a id="__codelineno-6-30" name="__codelineno-6-30" href="#__codelineno-6-30"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;GridSearchCV Results:&quot;</span><span class="p">)</span>
<a id="__codelineno-6-31" name="__codelineno-6-31" href="#__codelineno-6-31"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Best parameters found:&quot;</span><span class="p">,</span> <span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">)</span>
<a id="__codelineno-6-32" name="__codelineno-6-32" href="#__codelineno-6-32"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Best negative log loss found:&quot;</span><span class="p">,</span> <span class="n">grid_search</span><span class="o">.</span><span class="n">best_score_</span><span class="p">)</span>
<a id="__codelineno-6-33" name="__codelineno-6-33" href="#__codelineno-6-33"></a>
<a id="__codelineno-6-34" name="__codelineno-6-34" href="#__codelineno-6-34"></a>    <span class="n">lgbm_best_params</span> <span class="o">=</span> <span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span>
<a id="__codelineno-6-35" name="__codelineno-6-35" href="#__codelineno-6-35"></a>
<a id="__codelineno-6-36" name="__codelineno-6-36" href="#__codelineno-6-36"></a>    <span class="k">return</span> <span class="n">lgbm_best_params</span>
<a id="__codelineno-6-37" name="__codelineno-6-37" href="#__codelineno-6-37"></a>
<a id="__codelineno-6-38" name="__codelineno-6-38" href="#__codelineno-6-38"></a><span class="n">lgbm_best_params</span> <span class="o">=</span> <span class="n">LGBM_GridSearch</span><span class="p">(</span><span class="n">train_x</span><span class="p">,</span> <span class="n">train_y</span><span class="p">)</span>
<a id="__codelineno-6-39" name="__codelineno-6-39" href="#__codelineno-6-39"></a>
<a id="__codelineno-6-40" name="__codelineno-6-40" href="#__codelineno-6-40"></a><span class="k">def</span> <span class="nf">apply_best_GridSearch_params</span><span class="p">(</span><span class="n">lgbm_best_params</span><span class="p">,</span><span class="n">train_x</span><span class="p">,</span> <span class="n">train_y</span><span class="p">):</span>
<a id="__codelineno-6-41" name="__codelineno-6-41" href="#__codelineno-6-41"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<a id="__codelineno-6-42" name="__codelineno-6-42" href="#__codelineno-6-42"></a><span class="sd">    This function takes the previously defined best parameters, trains the model using those parameters and then outputs the pickle file.</span>
<a id="__codelineno-6-43" name="__codelineno-6-43" href="#__codelineno-6-43"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-6-44" name="__codelineno-6-44" href="#__codelineno-6-44"></a>    <span class="c1"># Define the model with best parameters</span>
<a id="__codelineno-6-45" name="__codelineno-6-45" href="#__codelineno-6-45"></a>    <span class="n">best_model</span> <span class="o">=</span> <span class="n">LGBMClassifier</span><span class="p">(</span><span class="n">force_col_wise</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">n_estimators</span><span class="o">=</span><span class="n">lgbm_best_params</span><span class="p">[</span><span class="s1">&#39;n_estimators&#39;</span><span class="p">],</span><span class="n">learning_rate</span><span class="o">=</span><span class="n">lgbm_best_params</span><span class="p">[</span><span class="s1">&#39;learning_rate&#39;</span><span class="p">],</span><span class="n">num_leaves</span><span class="o">=</span><span class="n">lgbm_best_params</span><span class="p">[</span><span class="s1">&#39;num_leaves&#39;</span><span class="p">])</span>
<a id="__codelineno-6-46" name="__codelineno-6-46" href="#__codelineno-6-46"></a>
<a id="__codelineno-6-47" name="__codelineno-6-47" href="#__codelineno-6-47"></a>    <span class="c1"># Train the model on best parameters</span>
<a id="__codelineno-6-48" name="__codelineno-6-48" href="#__codelineno-6-48"></a>    <span class="n">best_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_x</span><span class="p">,</span> <span class="n">train_y</span><span class="p">)</span>
<a id="__codelineno-6-49" name="__codelineno-6-49" href="#__codelineno-6-49"></a>
<a id="__codelineno-6-50" name="__codelineno-6-50" href="#__codelineno-6-50"></a>    <span class="c1"># Dump the pickle for the best model</span>
<a id="__codelineno-6-51" name="__codelineno-6-51" href="#__codelineno-6-51"></a>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;best_lgbm_model.pickle&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-6-52" name="__codelineno-6-52" href="#__codelineno-6-52"></a>        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">best_model</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
<a id="__codelineno-6-53" name="__codelineno-6-53" href="#__codelineno-6-53"></a>
<a id="__codelineno-6-54" name="__codelineno-6-54" href="#__codelineno-6-54"></a>    <span class="k">return</span> <span class="n">best_model</span>
<a id="__codelineno-6-55" name="__codelineno-6-55" href="#__codelineno-6-55"></a>
<a id="__codelineno-6-56" name="__codelineno-6-56" href="#__codelineno-6-56"></a><span class="n">best_model</span> <span class="o">=</span> <span class="n">apply_best_GridSearch_params</span><span class="p">(</span><span class="n">lgbm_best_params</span><span class="p">,</span><span class="n">train_x</span><span class="p">,</span> <span class="n">train_y</span><span class="p">)</span>
<a id="__codelineno-6-57" name="__codelineno-6-57" href="#__codelineno-6-57"></a>
<a id="__codelineno-6-58" name="__codelineno-6-58" href="#__codelineno-6-58"></a><span class="k">def</span> <span class="nf">best_model_predictions</span><span class="p">(</span><span class="n">best_model</span><span class="p">,</span><span class="n">test_data</span><span class="p">):</span>
<a id="__codelineno-6-59" name="__codelineno-6-59" href="#__codelineno-6-59"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<a id="__codelineno-6-60" name="__codelineno-6-60" href="#__codelineno-6-60"></a><span class="sd">    This function generates a column of probabilities for each runner, before normalising the probabilities across each race.</span>
<a id="__codelineno-6-61" name="__codelineno-6-61" href="#__codelineno-6-61"></a><span class="sd">    Normalising the probabilities is essential for use in a betting model as the sum of the probabilities should be equal to 1 given that each race has 1 winner.</span>
<a id="__codelineno-6-62" name="__codelineno-6-62" href="#__codelineno-6-62"></a>
<a id="__codelineno-6-63" name="__codelineno-6-63" href="#__codelineno-6-63"></a><span class="sd">    Unnecessary columns are dropped and then the dataframe is exported to a csv file</span>
<a id="__codelineno-6-64" name="__codelineno-6-64" href="#__codelineno-6-64"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-6-65" name="__codelineno-6-65" href="#__codelineno-6-65"></a>
<a id="__codelineno-6-66" name="__codelineno-6-66" href="#__codelineno-6-66"></a>    <span class="c1"># Predict probabilities using the best model</span>
<a id="__codelineno-6-67" name="__codelineno-6-67" href="#__codelineno-6-67"></a>    <span class="n">test_data</span><span class="p">[</span><span class="s1">&#39;win_probability&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">best_model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">test_x</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-6-68" name="__codelineno-6-68" href="#__codelineno-6-68"></a>
<a id="__codelineno-6-69" name="__codelineno-6-69" href="#__codelineno-6-69"></a>    <span class="c1"># Normalise probabilities across each race</span>
<a id="__codelineno-6-70" name="__codelineno-6-70" href="#__codelineno-6-70"></a>    <span class="n">test_data</span><span class="p">[</span><span class="s1">&#39;win_probability&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">test_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;raceId&#39;</span><span class="p">,</span> <span class="n">group_keys</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="s1">&#39;win_probability&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
<a id="__codelineno-6-71" name="__codelineno-6-71" href="#__codelineno-6-71"></a>
<a id="__codelineno-6-72" name="__codelineno-6-72" href="#__codelineno-6-72"></a>    <span class="c1"># Keep only required columns</span>
<a id="__codelineno-6-73" name="__codelineno-6-73" href="#__codelineno-6-73"></a>    <span class="n">test_data</span> <span class="o">=</span> <span class="n">test_data</span><span class="p">[</span><span class="n">BACKTESTING_COLUMNS</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;win_probability&#39;</span><span class="p">]]</span>
<a id="__codelineno-6-74" name="__codelineno-6-74" href="#__codelineno-6-74"></a>
<a id="__codelineno-6-75" name="__codelineno-6-75" href="#__codelineno-6-75"></a>    <span class="c1"># Export DataFrame to CSV</span>
<a id="__codelineno-6-76" name="__codelineno-6-76" href="#__codelineno-6-76"></a>    <span class="n">test_data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;lgbm_gridSearch_predictions.csv&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-6-77" name="__codelineno-6-77" href="#__codelineno-6-77"></a>
<a id="__codelineno-6-78" name="__codelineno-6-78" href="#__codelineno-6-78"></a>    <span class="k">return</span> <span class="n">test_data</span>
<a id="__codelineno-6-79" name="__codelineno-6-79" href="#__codelineno-6-79"></a>
<a id="__codelineno-6-80" name="__codelineno-6-80" href="#__codelineno-6-80"></a><span class="n">test_data</span> <span class="o">=</span> <span class="n">best_model_predictions</span><span class="p">(</span><span class="n">best_model</span><span class="p">,</span><span class="n">test_data</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a>Fitting 3 folds for each of 27 candidates, totalling 81 fits
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>[CV 1/3] END learning_rate=0.01, n_estimators=100, num_leaves=50;, score=-0.387 total time=  36.8s
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>[CV 2/3] END learning_rate=0.01, n_estimators=100, num_leaves=50;, score=-0.387 total time=  39.6s
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a>[CV 3/3] END learning_rate=0.01, n_estimators=100, num_leaves=50;, score=-0.386 total time=  47.6s
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a>[CV 1/3] END learning_rate=0.01, n_estimators=100, num_leaves=80;, score=-0.387 total time= 1.0min
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a>[CV 2/3] END learning_rate=0.01, n_estimators=100, num_leaves=80;, score=-0.386 total time=  53.8s
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a>[CV 3/3] END learning_rate=0.01, n_estimators=100, num_leaves=80;, score=-0.385 total time= 1.0min
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a>
<a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a>#
<a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a># Output trimmed
<a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a>#
<a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a>
<a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a>GridSearchCV Results:
<a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a>Best parameters found: {&#39;learning_rate&#39;: 0.01, &#39;n_estimators&#39;: 500, &#39;num_leaves&#39;: 120}
<a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a>Best negative log loss found: -0.3791625785797655
</code></pre></div></p>
<h2 id="analysing-profitability">Analysing profitability</h2>
<p>Let's explore now how we can take our model's probability predictions and compare them to actual market data. We'll join them onto the Betfair BSP datasets and then apply some segmentation to see if we can choose a segment for a staking strategy.
For this profitability analysis, we have used proportional staking where the model's probability is multipled by 100 to calculate a stake (e.g. 0.07 x 100 = $7) and then bets placed at BSP. </p>
<p>It's important to be cautious when segmenting the data, especially if more than one segment is applied, that the set of datapoints is not too small to expose the strategy to overfitting. E.g. Picking races in QLD between 320m and 330m on a Monday night would most likely result in overfitting and unreproducable results. This page <a href="https://valuebettingblog.com/advanced-betting-calculator/">here</a> has a great tool to help assess if the strategy is overfitted.</p>
<div class="highlight"><span class="filename">Joining model predictions with Betfair data</span><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="n">BETFAIR_RESULTS_COLUMNS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;LOCAL_MEETING_DATE&#39;</span><span class="p">,</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>                        <span class="s1">&#39;SCHEDULED_RACE_TIME&#39;</span><span class="p">,</span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>                        <span class="s1">&#39;ACTUAL_OFF_TIME&#39;</span><span class="p">,</span>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a>                        <span class="s1">&#39;TRACK&#39;</span><span class="p">,</span>
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a>                        <span class="s1">&#39;STATE_CODE&#39;</span><span class="p">,</span>
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a>                        <span class="s1">&#39;RACE_NO&#39;</span><span class="p">,</span>
<a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a>                        <span class="s1">&#39;WIN_MARKET_ID&#39;</span><span class="p">,</span>
<a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a>                        <span class="s1">&#39;DISTANCE&#39;</span><span class="p">,</span>
<a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a>                        <span class="s1">&#39;RACE_TYPE&#39;</span><span class="p">,</span>
<a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a>                        <span class="s1">&#39;SELECTION_ID&#39;</span><span class="p">,</span>
<a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a>                        <span class="s1">&#39;TAB_NUMBER&#39;</span><span class="p">,</span>
<a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a>                        <span class="s1">&#39;SELECTION_NAME&#39;</span><span class="p">,</span>
<a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a>                        <span class="s1">&#39;WIN_RESULT&#39;</span><span class="p">,</span>
<a id="__codelineno-8-14" name="__codelineno-8-14" href="#__codelineno-8-14"></a>                        <span class="s1">&#39;WIN_BSP&#39;</span><span class="p">,</span>
<a id="__codelineno-8-15" name="__codelineno-8-15" href="#__codelineno-8-15"></a>                        <span class="s1">&#39;BEST_AVAIL_BACK_AT_SCHEDULED_OFF&#39;</span><span class="p">]</span>
<a id="__codelineno-8-16" name="__codelineno-8-16" href="#__codelineno-8-16"></a>
<a id="__codelineno-8-17" name="__codelineno-8-17" href="#__codelineno-8-17"></a><span class="k">def</span> <span class="nf">retrieve_betfair_results</span><span class="p">(</span><span class="n">end_date</span><span class="p">):</span>
<a id="__codelineno-8-18" name="__codelineno-8-18" href="#__codelineno-8-18"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<a id="__codelineno-8-19" name="__codelineno-8-19" href="#__codelineno-8-19"></a><span class="sd">    This function retrieves the Betfair Historical results csv files using a series of urls in a consistent format.</span>
<a id="__codelineno-8-20" name="__codelineno-8-20" href="#__codelineno-8-20"></a><span class="sd">    Each csv file is retrieved and then concatenated into a single dataframe before being trimming by dropping unnecessary columns and dropping rows with None in particular columns as well as duplicates</span>
<a id="__codelineno-8-21" name="__codelineno-8-21" href="#__codelineno-8-21"></a>
<a id="__codelineno-8-22" name="__codelineno-8-22" href="#__codelineno-8-22"></a><span class="sd">    A runner may have None for BSP if it was a very late scratching and was not able to be removed before commencement of the race.</span>
<a id="__codelineno-8-23" name="__codelineno-8-23" href="#__codelineno-8-23"></a><span class="sd">    Additionally, some NZ results are known as not having had BSP offered due to lack of vision</span>
<a id="__codelineno-8-24" name="__codelineno-8-24" href="#__codelineno-8-24"></a>
<a id="__codelineno-8-25" name="__codelineno-8-25" href="#__codelineno-8-25"></a><span class="sd">    A runner may have None for for &#39;BEST_AVAIL_BACK_AT_SCHEDULED_OFF&#39; and a value for BSP if another runner was a very late scratching and all bets in the market at the time had to be voided and manual BSP reconciliation required.</span>
<a id="__codelineno-8-26" name="__codelineno-8-26" href="#__codelineno-8-26"></a>
<a id="__codelineno-8-27" name="__codelineno-8-27" href="#__codelineno-8-27"></a><span class="sd">    These datasets are also known to have duplicate values, so as an additional cleaning step, duplicate values were dropped</span>
<a id="__codelineno-8-28" name="__codelineno-8-28" href="#__codelineno-8-28"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-8-29" name="__codelineno-8-29" href="#__codelineno-8-29"></a>
<a id="__codelineno-8-30" name="__codelineno-8-30" href="#__codelineno-8-30"></a>    <span class="c1"># Define the start and end date for iteration</span>
<a id="__codelineno-8-31" name="__codelineno-8-31" href="#__codelineno-8-31"></a>    <span class="n">start_results_date</span> <span class="o">=</span> <span class="n">end_date</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">years</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-8-32" name="__codelineno-8-32" href="#__codelineno-8-32"></a>    <span class="n">end_results_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-8-33" name="__codelineno-8-33" href="#__codelineno-8-33"></a>
<a id="__codelineno-8-34" name="__codelineno-8-34" href="#__codelineno-8-34"></a>    <span class="c1"># List to store DataFrames</span>
<a id="__codelineno-8-35" name="__codelineno-8-35" href="#__codelineno-8-35"></a>    <span class="n">result_dataframes</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-8-36" name="__codelineno-8-36" href="#__codelineno-8-36"></a>
<a id="__codelineno-8-37" name="__codelineno-8-37" href="#__codelineno-8-37"></a>    <span class="c1"># Define our date variable that will be changed</span>
<a id="__codelineno-8-38" name="__codelineno-8-38" href="#__codelineno-8-38"></a>    <span class="n">current_date</span> <span class="o">=</span> <span class="n">start_results_date</span>
<a id="__codelineno-8-39" name="__codelineno-8-39" href="#__codelineno-8-39"></a>
<a id="__codelineno-8-40" name="__codelineno-8-40" href="#__codelineno-8-40"></a>    <span class="c1"># Initialise the while loop to ensure we cover our whole date range</span>
<a id="__codelineno-8-41" name="__codelineno-8-41" href="#__codelineno-8-41"></a>    <span class="k">while</span> <span class="n">current_date</span> <span class="o">&lt;=</span> <span class="n">end_results_date</span><span class="p">:</span>
<a id="__codelineno-8-42" name="__codelineno-8-42" href="#__codelineno-8-42"></a>        <span class="c1"># Generate the URL</span>
<a id="__codelineno-8-43" name="__codelineno-8-43" href="#__codelineno-8-43"></a>        <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;https://betfair-datascientists.github.io/data/assets/ANZ_Greyhounds_</span><span class="si">{</span><span class="n">current_date</span><span class="o">.</span><span class="n">year</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">current_date</span><span class="o">.</span><span class="n">month</span><span class="si">:</span><span class="s1">02d</span><span class="si">}</span><span class="s1">.csv&#39;</span>
<a id="__codelineno-8-44" name="__codelineno-8-44" href="#__codelineno-8-44"></a>
<a id="__codelineno-8-45" name="__codelineno-8-45" href="#__codelineno-8-45"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-8-46" name="__codelineno-8-46" href="#__codelineno-8-46"></a>            <span class="c1"># Read CSV data into a DataFrame directly from the URL</span>
<a id="__codelineno-8-47" name="__codelineno-8-47" href="#__codelineno-8-47"></a>            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
<a id="__codelineno-8-48" name="__codelineno-8-48" href="#__codelineno-8-48"></a>            <span class="n">result_dataframes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<a id="__codelineno-8-49" name="__codelineno-8-49" href="#__codelineno-8-49"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processed: </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-8-50" name="__codelineno-8-50" href="#__codelineno-8-50"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-8-51" name="__codelineno-8-51" href="#__codelineno-8-51"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to fetch data from: </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">, Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-8-52" name="__codelineno-8-52" href="#__codelineno-8-52"></a>
<a id="__codelineno-8-53" name="__codelineno-8-53" href="#__codelineno-8-53"></a>        <span class="c1"># Move to the next month</span>
<a id="__codelineno-8-54" name="__codelineno-8-54" href="#__codelineno-8-54"></a>        <span class="n">current_date</span> <span class="o">=</span> <span class="n">current_date</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">day</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-8-55" name="__codelineno-8-55" href="#__codelineno-8-55"></a>
<a id="__codelineno-8-56" name="__codelineno-8-56" href="#__codelineno-8-56"></a>    <span class="c1"># Concatenate all DataFrames into one</span>
<a id="__codelineno-8-57" name="__codelineno-8-57" href="#__codelineno-8-57"></a>    <span class="n">betfair_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">result_dataframes</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-8-58" name="__codelineno-8-58" href="#__codelineno-8-58"></a>
<a id="__codelineno-8-59" name="__codelineno-8-59" href="#__codelineno-8-59"></a>    <span class="c1"># Keep only required columns</span>
<a id="__codelineno-8-60" name="__codelineno-8-60" href="#__codelineno-8-60"></a>    <span class="n">betfair_results</span><span class="o">=</span> <span class="n">betfair_results</span><span class="p">[</span><span class="n">BETFAIR_RESULTS_COLUMNS</span><span class="p">]</span>
<a id="__codelineno-8-61" name="__codelineno-8-61" href="#__codelineno-8-61"></a>
<a id="__codelineno-8-62" name="__codelineno-8-62" href="#__codelineno-8-62"></a>    <span class="c1"># Drop rows with None in WIN_BSP or BEST_AVAIL_BACK_AT_SCHEDULED_OFF</span>
<a id="__codelineno-8-63" name="__codelineno-8-63" href="#__codelineno-8-63"></a>    <span class="n">betfair_results</span> <span class="o">=</span> <span class="n">betfair_results</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;WIN_BSP&#39;</span><span class="p">])</span>
<a id="__codelineno-8-64" name="__codelineno-8-64" href="#__codelineno-8-64"></a>    <span class="n">betfair_results</span> <span class="o">=</span> <span class="n">betfair_results</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;BEST_AVAIL_BACK_AT_SCHEDULED_OFF&#39;</span><span class="p">])</span>
<a id="__codelineno-8-65" name="__codelineno-8-65" href="#__codelineno-8-65"></a>
<a id="__codelineno-8-66" name="__codelineno-8-66" href="#__codelineno-8-66"></a>    <span class="c1"># Drop any duplicate rows</span>
<a id="__codelineno-8-67" name="__codelineno-8-67" href="#__codelineno-8-67"></a>    <span class="n">betfair_results</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-8-68" name="__codelineno-8-68" href="#__codelineno-8-68"></a>
<a id="__codelineno-8-69" name="__codelineno-8-69" href="#__codelineno-8-69"></a>    <span class="c1"># Ensure LOCAL_MEETING_DATE is in datetime format</span>
<a id="__codelineno-8-70" name="__codelineno-8-70" href="#__codelineno-8-70"></a>    <span class="n">betfair_results</span><span class="p">[</span><span class="s1">&#39;LOCAL_MEETING_DATE&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">betfair_results</span><span class="p">[</span><span class="s1">&#39;LOCAL_MEETING_DATE&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span>
<a id="__codelineno-8-71" name="__codelineno-8-71" href="#__codelineno-8-71"></a>
<a id="__codelineno-8-72" name="__codelineno-8-72" href="#__codelineno-8-72"></a>    <span class="k">return</span> <span class="n">betfair_results</span>
<a id="__codelineno-8-73" name="__codelineno-8-73" href="#__codelineno-8-73"></a>
<a id="__codelineno-8-74" name="__codelineno-8-74" href="#__codelineno-8-74"></a><span class="n">betfair_results</span> <span class="o">=</span> <span class="n">retrieve_betfair_results</span><span class="p">(</span><span class="n">end_date</span><span class="p">)</span>
<a id="__codelineno-8-75" name="__codelineno-8-75" href="#__codelineno-8-75"></a>
<a id="__codelineno-8-76" name="__codelineno-8-76" href="#__codelineno-8-76"></a><span class="k">def</span> <span class="nf">create_backtesting_dataset</span><span class="p">(</span><span class="n">betfair_results</span><span class="p">,</span><span class="n">best_model_test_data</span><span class="p">):</span>
<a id="__codelineno-8-77" name="__codelineno-8-77" href="#__codelineno-8-77"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<a id="__codelineno-8-78" name="__codelineno-8-78" href="#__codelineno-8-78"></a><span class="sd">    This function merges together our model predictions with the retrieved Betfair data</span>
<a id="__codelineno-8-79" name="__codelineno-8-79" href="#__codelineno-8-79"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-8-80" name="__codelineno-8-80" href="#__codelineno-8-80"></a>
<a id="__codelineno-8-81" name="__codelineno-8-81" href="#__codelineno-8-81"></a>    <span class="c1"># merge dataframes</span>
<a id="__codelineno-8-82" name="__codelineno-8-82" href="#__codelineno-8-82"></a>    <span class="n">backtesting</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">betfair_results</span><span class="p">,</span>
<a id="__codelineno-8-83" name="__codelineno-8-83" href="#__codelineno-8-83"></a>                        <span class="n">best_model_test_data</span><span class="p">,</span>
<a id="__codelineno-8-84" name="__codelineno-8-84" href="#__codelineno-8-84"></a>                        <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span>
<a id="__codelineno-8-85" name="__codelineno-8-85" href="#__codelineno-8-85"></a>                        <span class="n">left_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;LOCAL_MEETING_DATE&#39;</span><span class="p">,</span><span class="s1">&#39;TRACK&#39;</span><span class="p">,</span><span class="s1">&#39;RACE_NO&#39;</span><span class="p">,</span><span class="s1">&#39;TAB_NUMBER&#39;</span><span class="p">],</span>
<a id="__codelineno-8-86" name="__codelineno-8-86" href="#__codelineno-8-86"></a>                        <span class="n">right_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;meetingDate&#39;</span><span class="p">,</span><span class="s1">&#39;track&#39;</span><span class="p">,</span><span class="s1">&#39;raceNumber&#39;</span><span class="p">,</span><span class="s1">&#39;rugNumber&#39;</span><span class="p">])</span>
<a id="__codelineno-8-87" name="__codelineno-8-87" href="#__codelineno-8-87"></a>
<a id="__codelineno-8-88" name="__codelineno-8-88" href="#__codelineno-8-88"></a>    <span class="c1"># Drop Betfair races where our model didn&#39;t have a prediction</span>
<a id="__codelineno-8-89" name="__codelineno-8-89" href="#__codelineno-8-89"></a>    <span class="n">backtesting</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;win_probability&#39;</span><span class="p">],</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-8-90" name="__codelineno-8-90" href="#__codelineno-8-90"></a>
<a id="__codelineno-8-91" name="__codelineno-8-91" href="#__codelineno-8-91"></a>    <span class="k">return</span> <span class="n">backtesting</span>
<a id="__codelineno-8-92" name="__codelineno-8-92" href="#__codelineno-8-92"></a>
<a id="__codelineno-8-93" name="__codelineno-8-93" href="#__codelineno-8-93"></a><span class="n">backtesting</span> <span class="o">=</span> <span class="n">create_backtesting_dataset</span><span class="p">(</span><span class="n">betfair_results</span><span class="p">,</span><span class="n">test_data</span><span class="p">)</span>
<a id="__codelineno-8-94" name="__codelineno-8-94" href="#__codelineno-8-94"></a>
<a id="__codelineno-8-95" name="__codelineno-8-95" href="#__codelineno-8-95"></a><span class="k">def</span> <span class="nf">generate_backtesting_columns</span><span class="p">(</span><span class="n">backtesting</span><span class="p">):</span>
<a id="__codelineno-8-96" name="__codelineno-8-96" href="#__codelineno-8-96"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<a id="__codelineno-8-97" name="__codelineno-8-97" href="#__codelineno-8-97"></a><span class="sd">    This function generates additional columns for the purposes of profitability testing.</span>
<a id="__codelineno-8-98" name="__codelineno-8-98" href="#__codelineno-8-98"></a>
<a id="__codelineno-8-99" name="__codelineno-8-99" href="#__codelineno-8-99"></a><span class="sd">    Model Rank: This function ranks each runner within the race in descending order by win_probability</span>
<a id="__codelineno-8-100" name="__codelineno-8-100" href="#__codelineno-8-100"></a><span class="sd">    Model Value: Implied value of the model&#39;s probability against the best available odds at the scheduled off - These odds are used as a signal only</span>
<a id="__codelineno-8-101" name="__codelineno-8-101" href="#__codelineno-8-101"></a><span class="sd">    Proportional Back Stake: A Profit/Loss column for each runner before commission</span>
<a id="__codelineno-8-102" name="__codelineno-8-102" href="#__codelineno-8-102"></a>
<a id="__codelineno-8-103" name="__codelineno-8-103" href="#__codelineno-8-103"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-8-104" name="__codelineno-8-104" href="#__codelineno-8-104"></a>    <span class="c1"># Rank each runner by the model&#39;s probability</span>
<a id="__codelineno-8-105" name="__codelineno-8-105" href="#__codelineno-8-105"></a>    <span class="n">backtesting</span><span class="p">[</span><span class="s1">&#39;MODEL_RANK&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">backtesting</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;WIN_MARKET_ID&#39;</span><span class="p">)[</span><span class="s1">&#39;win_probability&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rank</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-8-106" name="__codelineno-8-106" href="#__codelineno-8-106"></a>
<a id="__codelineno-8-107" name="__codelineno-8-107" href="#__codelineno-8-107"></a>    <span class="c1"># Generate our model&#39;s implied value against the best market price at the scheduled jump time</span>
<a id="__codelineno-8-108" name="__codelineno-8-108" href="#__codelineno-8-108"></a>    <span class="n">backtesting</span><span class="p">[</span><span class="s1">&#39;MODEL_VALUE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">backtesting</span><span class="p">[</span><span class="s1">&#39;win_probability&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="o">/</span><span class="n">backtesting</span><span class="p">[</span><span class="s1">&#39;BEST_AVAIL_BACK_AT_SCHEDULED_OFF&#39;</span><span class="p">]</span>
<a id="__codelineno-8-109" name="__codelineno-8-109" href="#__codelineno-8-109"></a>
<a id="__codelineno-8-110" name="__codelineno-8-110" href="#__codelineno-8-110"></a>    <span class="c1"># Generate a profit / loss column on a per runner basis without commission</span>
<a id="__codelineno-8-111" name="__codelineno-8-111" href="#__codelineno-8-111"></a>    <span class="n">backtesting</span><span class="p">[</span><span class="s1">&#39;PROPORTIONAL_BACK_STAKE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">backtesting</span><span class="p">[</span><span class="s1">&#39;WIN_RESULT&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;WINNER&#39;</span><span class="p">,</span>
<a id="__codelineno-8-112" name="__codelineno-8-112" href="#__codelineno-8-112"></a>                            <span class="n">backtesting</span><span class="p">[</span><span class="s1">&#39;win_probability&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">*</span> <span class="p">(</span><span class="n">backtesting</span><span class="p">[</span><span class="s1">&#39;WIN_BSP&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
<a id="__codelineno-8-113" name="__codelineno-8-113" href="#__codelineno-8-113"></a>                            <span class="n">backtesting</span><span class="p">[</span><span class="s1">&#39;win_probability&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="o">-</span><span class="mi">100</span><span class="p">)</span>
<a id="__codelineno-8-114" name="__codelineno-8-114" href="#__codelineno-8-114"></a>
<a id="__codelineno-8-115" name="__codelineno-8-115" href="#__codelineno-8-115"></a>    <span class="k">return</span> <span class="n">backtesting</span>
<a id="__codelineno-8-116" name="__codelineno-8-116" href="#__codelineno-8-116"></a>
<a id="__codelineno-8-117" name="__codelineno-8-117" href="#__codelineno-8-117"></a><span class="n">backtesting</span> <span class="o">=</span> <span class="n">generate_backtesting_columns</span><span class="p">(</span><span class="n">backtesting</span><span class="p">)</span>
<a id="__codelineno-8-118" name="__codelineno-8-118" href="#__codelineno-8-118"></a>
<a id="__codelineno-8-119" name="__codelineno-8-119" href="#__codelineno-8-119"></a><span class="c1"># This is a non-exhaustive list of race types from the Betfair Pricing Data which groups together different race types. </span>
<a id="__codelineno-8-120" name="__codelineno-8-120" href="#__codelineno-8-120"></a><span class="c1"># The greyhound race grading system is convoluted and varies by state</span>
<a id="__codelineno-8-121" name="__codelineno-8-121" href="#__codelineno-8-121"></a><span class="n">RACE_TYPE_DICTIONARY</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-8-122" name="__codelineno-8-122" href="#__codelineno-8-122"></a>            <span class="s1">&#39;B8&#39;</span><span class="p">:</span><span class="s1">&#39;Other&#39;</span><span class="p">,</span>
<a id="__codelineno-8-123" name="__codelineno-8-123" href="#__codelineno-8-123"></a>            <span class="s1">&#39;FFA&#39;</span><span class="p">:</span><span class="s1">&#39;Ungraded&#39;</span><span class="p">,</span>
<a id="__codelineno-8-124" name="__codelineno-8-124" href="#__codelineno-8-124"></a>            <span class="s1">&#39;Final&#39;</span><span class="p">:</span><span class="s1">&#39;Prestige&#39;</span><span class="p">,</span>
<a id="__codelineno-8-125" name="__codelineno-8-125" href="#__codelineno-8-125"></a>            <span class="s1">&#39;G3/4/5&#39;</span><span class="p">:</span><span class="s1">&#39;Graded&#39;</span><span class="p">,</span>
<a id="__codelineno-8-126" name="__codelineno-8-126" href="#__codelineno-8-126"></a>            <span class="s1">&#39;Gr&#39;</span><span class="p">:</span><span class="s1">&#39;Graded&#39;</span><span class="p">,</span>
<a id="__codelineno-8-127" name="__codelineno-8-127" href="#__codelineno-8-127"></a>            <span class="s1">&#39;Gr1&#39;</span><span class="p">:</span><span class="s1">&#39;Graded&#39;</span><span class="p">,</span>
<a id="__codelineno-8-128" name="__codelineno-8-128" href="#__codelineno-8-128"></a>            <span class="s1">&#39;Gr1/2&#39;</span><span class="p">:</span><span class="s1">&#39;Graded&#39;</span><span class="p">,</span>
<a id="__codelineno-8-129" name="__codelineno-8-129" href="#__codelineno-8-129"></a>            <span class="s1">&#39;Gr1/2/3&#39;</span><span class="p">:</span><span class="s1">&#39;Graded&#39;</span><span class="p">,</span>
<a id="__codelineno-8-130" name="__codelineno-8-130" href="#__codelineno-8-130"></a>            <span class="s1">&#39;Gr2/3&#39;</span><span class="p">:</span><span class="s1">&#39;Graded&#39;</span><span class="p">,</span>
<a id="__codelineno-8-131" name="__codelineno-8-131" href="#__codelineno-8-131"></a>            <span class="s1">&#39;Gr2/3/4&#39;</span><span class="p">:</span><span class="s1">&#39;Graded&#39;</span><span class="p">,</span>
<a id="__codelineno-8-132" name="__codelineno-8-132" href="#__codelineno-8-132"></a>            <span class="s1">&#39;Gr3&#39;</span><span class="p">:</span><span class="s1">&#39;Graded&#39;</span><span class="p">,</span>
<a id="__codelineno-8-133" name="__codelineno-8-133" href="#__codelineno-8-133"></a>            <span class="s1">&#39;Gr3/4&#39;</span><span class="p">:</span><span class="s1">&#39;Graded&#39;</span><span class="p">,</span>
<a id="__codelineno-8-134" name="__codelineno-8-134" href="#__codelineno-8-134"></a>            <span class="s1">&#39;Gr3/4/5&#39;</span><span class="p">:</span><span class="s1">&#39;Graded&#39;</span><span class="p">,</span>
<a id="__codelineno-8-135" name="__codelineno-8-135" href="#__codelineno-8-135"></a>            <span class="s1">&#39;Gr4&#39;</span><span class="p">:</span><span class="s1">&#39;Graded&#39;</span><span class="p">,</span>
<a id="__codelineno-8-136" name="__codelineno-8-136" href="#__codelineno-8-136"></a>            <span class="s1">&#39;Gr4/5&#39;</span><span class="p">:</span><span class="s1">&#39;Graded&#39;</span><span class="p">,</span>
<a id="__codelineno-8-137" name="__codelineno-8-137" href="#__codelineno-8-137"></a>            <span class="s1">&#39;Gr4/5/6&#39;</span><span class="p">:</span><span class="s1">&#39;Graded&#39;</span><span class="p">,</span>
<a id="__codelineno-8-138" name="__codelineno-8-138" href="#__codelineno-8-138"></a>            <span class="s1">&#39;Gr5&#39;</span><span class="p">:</span><span class="s1">&#39;Graded&#39;</span><span class="p">,</span>
<a id="__codelineno-8-139" name="__codelineno-8-139" href="#__codelineno-8-139"></a>            <span class="s1">&#39;Gr5/6&#39;</span><span class="p">:</span><span class="s1">&#39;Graded&#39;</span><span class="p">,</span>
<a id="__codelineno-8-140" name="__codelineno-8-140" href="#__codelineno-8-140"></a>            <span class="s1">&#39;Gr5/Mdn&#39;</span><span class="p">:</span><span class="s1">&#39;Graded&#39;</span><span class="p">,</span>
<a id="__codelineno-8-141" name="__codelineno-8-141" href="#__codelineno-8-141"></a>            <span class="s1">&#39;Gr6&#39;</span><span class="p">:</span><span class="s1">&#39;Graded&#39;</span><span class="p">,</span>
<a id="__codelineno-8-142" name="__codelineno-8-142" href="#__codelineno-8-142"></a>            <span class="s1">&#39;Gr6/7&#39;</span><span class="p">:</span><span class="s1">&#39;Graded&#39;</span><span class="p">,</span>
<a id="__codelineno-8-143" name="__codelineno-8-143" href="#__codelineno-8-143"></a>            <span class="s1">&#39;Gr7&#39;</span><span class="p">:</span><span class="s1">&#39;Graded&#39;</span><span class="p">,</span>
<a id="__codelineno-8-144" name="__codelineno-8-144" href="#__codelineno-8-144"></a>            <span class="s1">&#39;Grp1&#39;</span><span class="p">:</span><span class="s1">&#39;Prestige&#39;</span><span class="p">,</span>
<a id="__codelineno-8-145" name="__codelineno-8-145" href="#__codelineno-8-145"></a>            <span class="s1">&#39;Grp2&#39;</span><span class="p">:</span><span class="s1">&#39;Prestige&#39;</span><span class="p">,</span>
<a id="__codelineno-8-146" name="__codelineno-8-146" href="#__codelineno-8-146"></a>            <span class="s1">&#39;Grp3&#39;</span><span class="p">:</span><span class="s1">&#39;Prestige&#39;</span><span class="p">,</span>
<a id="__codelineno-8-147" name="__codelineno-8-147" href="#__codelineno-8-147"></a>            <span class="s1">&#39;Heat&#39;</span><span class="p">:</span><span class="s1">&#39;Heat&#39;</span><span class="p">,</span>
<a id="__codelineno-8-148" name="__codelineno-8-148" href="#__codelineno-8-148"></a>            <span class="s1">&#39;Inv&#39;</span><span class="p">:</span><span class="s1">&#39;Other&#39;</span><span class="p">,</span>
<a id="__codelineno-8-149" name="__codelineno-8-149" href="#__codelineno-8-149"></a>            <span class="s1">&#39;Juv&#39;</span><span class="p">:</span><span class="s1">&#39;Novice&#39;</span><span class="p">,</span>
<a id="__codelineno-8-150" name="__codelineno-8-150" href="#__codelineno-8-150"></a>            <span class="s1">&#39;Juv/Grad&#39;</span><span class="p">:</span><span class="s1">&#39;Novice&#39;</span><span class="p">,</span>
<a id="__codelineno-8-151" name="__codelineno-8-151" href="#__codelineno-8-151"></a>            <span class="s1">&#39;Juv/Mdn&#39;</span><span class="p">:</span><span class="s1">&#39;Novice&#39;</span><span class="p">,</span>
<a id="__codelineno-8-152" name="__codelineno-8-152" href="#__codelineno-8-152"></a>            <span class="s1">&#39;Listed&#39;</span><span class="p">:</span><span class="s1">&#39;Prestige&#39;</span><span class="p">,</span>
<a id="__codelineno-8-153" name="__codelineno-8-153" href="#__codelineno-8-153"></a>            <span class="s1">&#39;M1&#39;</span><span class="p">:</span><span class="s1">&#39;Masters&#39;</span><span class="p">,</span>
<a id="__codelineno-8-154" name="__codelineno-8-154" href="#__codelineno-8-154"></a>            <span class="s1">&#39;M1/2&#39;</span><span class="p">:</span><span class="s1">&#39;Masters&#39;</span><span class="p">,</span>
<a id="__codelineno-8-155" name="__codelineno-8-155" href="#__codelineno-8-155"></a>            <span class="s1">&#39;M1/2/3&#39;</span><span class="p">:</span><span class="s1">&#39;Masters&#39;</span><span class="p">,</span>
<a id="__codelineno-8-156" name="__codelineno-8-156" href="#__codelineno-8-156"></a>            <span class="s1">&#39;M1/M2&#39;</span><span class="p">:</span><span class="s1">&#39;Masters&#39;</span><span class="p">,</span>
<a id="__codelineno-8-157" name="__codelineno-8-157" href="#__codelineno-8-157"></a>            <span class="s1">&#39;M1/M2/M3&#39;</span><span class="p">:</span><span class="s1">&#39;Masters&#39;</span><span class="p">,</span>
<a id="__codelineno-8-158" name="__codelineno-8-158" href="#__codelineno-8-158"></a>            <span class="s1">&#39;M12&#39;</span><span class="p">:</span><span class="s1">&#39;Masters&#39;</span><span class="p">,</span>
<a id="__codelineno-8-159" name="__codelineno-8-159" href="#__codelineno-8-159"></a>            <span class="s1">&#39;M2&#39;</span><span class="p">:</span><span class="s1">&#39;Masters&#39;</span><span class="p">,</span>
<a id="__codelineno-8-160" name="__codelineno-8-160" href="#__codelineno-8-160"></a>            <span class="s1">&#39;M2/3&#39;</span><span class="p">:</span><span class="s1">&#39;Masters&#39;</span><span class="p">,</span>
<a id="__codelineno-8-161" name="__codelineno-8-161" href="#__codelineno-8-161"></a>            <span class="s1">&#39;M2/M3&#39;</span><span class="p">:</span><span class="s1">&#39;Masters&#39;</span><span class="p">,</span>
<a id="__codelineno-8-162" name="__codelineno-8-162" href="#__codelineno-8-162"></a>            <span class="s1">&#39;M3&#39;</span><span class="p">:</span><span class="s1">&#39;Masters&#39;</span><span class="p">,</span>
<a id="__codelineno-8-163" name="__codelineno-8-163" href="#__codelineno-8-163"></a>            <span class="s1">&#39;M3/4&#39;</span><span class="p">:</span><span class="s1">&#39;Masters&#39;</span><span class="p">,</span>
<a id="__codelineno-8-164" name="__codelineno-8-164" href="#__codelineno-8-164"></a>            <span class="s1">&#39;M4/5&#39;</span><span class="p">:</span><span class="s1">&#39;Masters&#39;</span><span class="p">,</span>
<a id="__codelineno-8-165" name="__codelineno-8-165" href="#__codelineno-8-165"></a>            <span class="s1">&#39;M4/6&#39;</span><span class="p">:</span><span class="s1">&#39;Masters&#39;</span><span class="p">,</span>
<a id="__codelineno-8-166" name="__codelineno-8-166" href="#__codelineno-8-166"></a>            <span class="s1">&#39;M4/M5&#39;</span><span class="p">:</span><span class="s1">&#39;Masters&#39;</span><span class="p">,</span>
<a id="__codelineno-8-167" name="__codelineno-8-167" href="#__codelineno-8-167"></a>            <span class="s1">&#39;M5&#39;</span><span class="p">:</span><span class="s1">&#39;Masters&#39;</span><span class="p">,</span>
<a id="__codelineno-8-168" name="__codelineno-8-168" href="#__codelineno-8-168"></a>            <span class="s1">&#39;M6&#39;</span><span class="p">:</span><span class="s1">&#39;Masters&#39;</span><span class="p">,</span>
<a id="__codelineno-8-169" name="__codelineno-8-169" href="#__codelineno-8-169"></a>            <span class="s1">&#39;Mdn&#39;</span><span class="p">:</span><span class="s1">&#39;Maiden&#39;</span><span class="p">,</span>
<a id="__codelineno-8-170" name="__codelineno-8-170" href="#__codelineno-8-170"></a>            <span class="s1">&#39;Mdn/Gr4/5&#39;</span><span class="p">:</span><span class="s1">&#39;Maiden&#39;</span><span class="p">,</span>
<a id="__codelineno-8-171" name="__codelineno-8-171" href="#__codelineno-8-171"></a>            <span class="s1">&#39;Mdn/Gr5&#39;</span><span class="p">:</span><span class="s1">&#39;Maiden&#39;</span><span class="p">,</span>
<a id="__codelineno-8-172" name="__codelineno-8-172" href="#__codelineno-8-172"></a>            <span class="s1">&#39;Mdn/Gr6&#39;</span><span class="p">:</span><span class="s1">&#39;Maiden&#39;</span><span class="p">,</span>
<a id="__codelineno-8-173" name="__codelineno-8-173" href="#__codelineno-8-173"></a>            <span class="s1">&#39;Mdn/Juv&#39;</span><span class="p">:</span><span class="s1">&#39;Maiden&#39;</span><span class="p">,</span>
<a id="__codelineno-8-174" name="__codelineno-8-174" href="#__codelineno-8-174"></a>            <span class="s1">&#39;N/G&#39;</span><span class="p">:</span><span class="s1">&#39;Ungraded&#39;</span><span class="p">,</span>
<a id="__codelineno-8-175" name="__codelineno-8-175" href="#__codelineno-8-175"></a>            <span class="s1">&#39;Nov&#39;</span><span class="p">:</span><span class="s1">&#39;Novice&#39;</span><span class="p">,</span>
<a id="__codelineno-8-176" name="__codelineno-8-176" href="#__codelineno-8-176"></a>            <span class="s1">&#39;Nov/Mdn&#39;</span><span class="p">:</span><span class="s1">&#39;Novice&#39;</span><span class="p">,</span>
<a id="__codelineno-8-177" name="__codelineno-8-177" href="#__codelineno-8-177"></a>            <span class="s1">&#39;Nvce&#39;</span><span class="p">:</span><span class="s1">&#39;Novice&#39;</span><span class="p">,</span>
<a id="__codelineno-8-178" name="__codelineno-8-178" href="#__codelineno-8-178"></a>            <span class="s1">&#39;Prov&#39;</span><span class="p">:</span><span class="s1">&#39;Other&#39;</span><span class="p">,</span>
<a id="__codelineno-8-179" name="__codelineno-8-179" href="#__codelineno-8-179"></a>            <span class="s1">&#39;Rest&#39;</span><span class="p">:</span><span class="s1">&#39;Win Restricted&#39;</span><span class="p">,</span>
<a id="__codelineno-8-180" name="__codelineno-8-180" href="#__codelineno-8-180"></a>            <span class="s1">&#39;S/E&#39;</span><span class="p">:</span><span class="s1">&#39;Other&#39;</span><span class="p">,</span>
<a id="__codelineno-8-181" name="__codelineno-8-181" href="#__codelineno-8-181"></a>            <span class="s1">&#39;SE&#39;</span><span class="p">:</span><span class="s1">&#39;Other&#39;</span><span class="p">,</span>
<a id="__codelineno-8-182" name="__codelineno-8-182" href="#__codelineno-8-182"></a>            <span class="s1">&#39;Semi&#39;</span><span class="p">:</span><span class="s1">&#39;Other&#39;</span><span class="p">,</span>
<a id="__codelineno-8-183" name="__codelineno-8-183" href="#__codelineno-8-183"></a>            <span class="s1">&#39;Vets&#39;</span><span class="p">:</span><span class="s1">&#39;Other&#39;</span><span class="p">,</span>
<a id="__codelineno-8-184" name="__codelineno-8-184" href="#__codelineno-8-184"></a>            <span class="p">}</span>
<a id="__codelineno-8-185" name="__codelineno-8-185" href="#__codelineno-8-185"></a>
<a id="__codelineno-8-186" name="__codelineno-8-186" href="#__codelineno-8-186"></a>
<a id="__codelineno-8-187" name="__codelineno-8-187" href="#__codelineno-8-187"></a><span class="k">def</span> <span class="nf">group_racetypes</span><span class="p">(</span><span class="n">backtesting</span><span class="p">):</span>
<a id="__codelineno-8-188" name="__codelineno-8-188" href="#__codelineno-8-188"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<a id="__codelineno-8-189" name="__codelineno-8-189" href="#__codelineno-8-189"></a><span class="sd">    This function generates a race_type_group column using a dictionary of loose race categories</span>
<a id="__codelineno-8-190" name="__codelineno-8-190" href="#__codelineno-8-190"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-8-191" name="__codelineno-8-191" href="#__codelineno-8-191"></a>    <span class="c1"># Create &#39;RACE_TYPE_GROUP&#39; column by mapping values from &#39;race_type&#39; column</span>
<a id="__codelineno-8-192" name="__codelineno-8-192" href="#__codelineno-8-192"></a>    <span class="n">backtesting</span><span class="p">[</span><span class="s1">&#39;RACE_TYPE_GROUP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">backtesting</span><span class="p">[</span><span class="s1">&#39;RACE_TYPE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">RACE_TYPE_DICTIONARY</span><span class="p">)</span>
<a id="__codelineno-8-193" name="__codelineno-8-193" href="#__codelineno-8-193"></a>
<a id="__codelineno-8-194" name="__codelineno-8-194" href="#__codelineno-8-194"></a>    <span class="c1"># Export to csv</span>
<a id="__codelineno-8-195" name="__codelineno-8-195" href="#__codelineno-8-195"></a>    <span class="n">backtesting</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;backtesting_results.csv&#39;</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-8-196" name="__codelineno-8-196" href="#__codelineno-8-196"></a>
<a id="__codelineno-8-197" name="__codelineno-8-197" href="#__codelineno-8-197"></a>    <span class="k">return</span> <span class="n">backtesting</span>
<a id="__codelineno-8-198" name="__codelineno-8-198" href="#__codelineno-8-198"></a>
<a id="__codelineno-8-199" name="__codelineno-8-199" href="#__codelineno-8-199"></a><span class="n">backtesting</span> <span class="o">=</span> <span class="n">group_racetypes</span><span class="p">(</span><span class="n">backtesting</span><span class="p">)</span>
<a id="__codelineno-8-200" name="__codelineno-8-200" href="#__codelineno-8-200"></a>
<a id="__codelineno-8-201" name="__codelineno-8-201" href="#__codelineno-8-201"></a><span class="sd">&#39;&#39;&#39;</span>
<a id="__codelineno-8-202" name="__codelineno-8-202" href="#__codelineno-8-202"></a><span class="sd">This concludes the model generation tutorial.</span>
<a id="__codelineno-8-203" name="__codelineno-8-203" href="#__codelineno-8-203"></a><span class="sd">The following code is intended for use in a live model</span>
<a id="__codelineno-8-204" name="__codelineno-8-204" href="#__codelineno-8-204"></a><span class="sd">&#39;&#39;&#39;</span>
</code></pre></div>
<p>Once we've exported this to a csv file, we've conducted some basic excel analysis to segment the predictions. All figures quoted below are before commission and may not be reflective of actual profitability. These segments are intended as ideas only.</p>
<p><img alt="png" src="../img/profitabilityAnalysis.png" /></p>
<h2 id="creating-new-ratings">Creating new ratings</h2>
<p>The next step will be to load up our database, and update with recent results</p>
<div class="highlight"><span class="filename">Load up the database and begin the preprocessing</span><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="k">def</span> <span class="nf">generate_historic_data_enddate</span><span class="p">(</span><span class="n">TopazDataAll</span><span class="p">):</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="sd">    This function finds the date to which the Topaz Historical Data has been downloaded, and then generates a datetime variable which equals the following date</span>
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a>
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a>    <span class="c1"># Find the maximum value in the &#39;meetingDate&#39; column</span>
<a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a>    <span class="n">max_meeting_date</span> <span class="o">=</span> <span class="n">TopazDataAll</span><span class="p">[</span><span class="s1">&#39;meetingDate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
<a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a>
<a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a>    <span class="c1"># Remove time information from the max_meeting_date and format it to &#39;%Y-%m-%d&#39;</span>
<a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a>    <span class="n">max_meeting_date</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">max_meeting_date</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">T%H:%M:%S.</span><span class="si">%f</span><span class="s1">Z&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a>
<a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a>    <span class="c1"># Convert max_meeting_date to datetime object</span>
<a id="__codelineno-9-13" name="__codelineno-9-13" href="#__codelineno-9-13"></a>    <span class="n">max_meeting_date</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">max_meeting_date</span><span class="p">)</span>
<a id="__codelineno-9-14" name="__codelineno-9-14" href="#__codelineno-9-14"></a>
<a id="__codelineno-9-15" name="__codelineno-9-15" href="#__codelineno-9-15"></a>    <span class="c1"># Add one day to max_meeting_date</span>
<a id="__codelineno-9-16" name="__codelineno-9-16" href="#__codelineno-9-16"></a>    <span class="n">max_meeting_date_plus_one_day</span> <span class="o">=</span> <span class="n">max_meeting_date</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-9-17" name="__codelineno-9-17" href="#__codelineno-9-17"></a>
<a id="__codelineno-9-18" name="__codelineno-9-18" href="#__codelineno-9-18"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Max meeting date plus one day:&quot;</span><span class="p">,</span> <span class="n">max_meeting_date_plus_one_day</span><span class="p">)</span>
<a id="__codelineno-9-19" name="__codelineno-9-19" href="#__codelineno-9-19"></a>
<a id="__codelineno-9-20" name="__codelineno-9-20" href="#__codelineno-9-20"></a>    <span class="c1"># Define yesterday&#39;s date</span>
<a id="__codelineno-9-21" name="__codelineno-9-21" href="#__codelineno-9-21"></a>    <span class="n">yesterday</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-9-22" name="__codelineno-9-22" href="#__codelineno-9-22"></a>
<a id="__codelineno-9-23" name="__codelineno-9-23" href="#__codelineno-9-23"></a>    <span class="k">return</span> <span class="n">max_meeting_date_plus_one_day</span><span class="p">,</span> <span class="n">yesterday</span>
<a id="__codelineno-9-24" name="__codelineno-9-24" href="#__codelineno-9-24"></a>
<a id="__codelineno-9-25" name="__codelineno-9-25" href="#__codelineno-9-25"></a><span class="n">TopazDataAll</span> <span class="o">=</span> <span class="n">load_topaz_data</span><span class="p">(</span><span class="n">JURISDICTION_CODES</span><span class="p">,</span><span class="s1">&#39;HISTORICAL&#39;</span><span class="p">)</span>
<a id="__codelineno-9-26" name="__codelineno-9-26" href="#__codelineno-9-26"></a>
<a id="__codelineno-9-27" name="__codelineno-9-27" href="#__codelineno-9-27"></a><span class="n">max_meeting_date_plus_one_day</span><span class="p">,</span> <span class="n">yesterday</span> <span class="o">=</span> <span class="n">generate_historic_data_enddate</span><span class="p">(</span><span class="n">TopazDataAll</span><span class="p">)</span>
<a id="__codelineno-9-28" name="__codelineno-9-28" href="#__codelineno-9-28"></a>
<a id="__codelineno-9-29" name="__codelineno-9-29" href="#__codelineno-9-29"></a><span class="c1"># Collect upcoming race data - note the use of &#39;UPCOMING&#39; here.</span>
<a id="__codelineno-9-30" name="__codelineno-9-30" href="#__codelineno-9-30"></a><span class="n">collect_topaz_data</span><span class="p">(</span><span class="n">TOPAZ_API_KEY</span><span class="p">,</span><span class="n">JURISDICTION_CODES</span><span class="p">,</span><span class="n">max_meeting_date_plus_one_day</span><span class="p">,</span><span class="n">yesterday</span><span class="p">,</span><span class="s1">&#39;UPCOMING&#39;</span><span class="p">)</span>
<a id="__codelineno-9-31" name="__codelineno-9-31" href="#__codelineno-9-31"></a>
<a id="__codelineno-9-32" name="__codelineno-9-32" href="#__codelineno-9-32"></a><span class="k">def</span> <span class="nf">topaz_last_12_months</span><span class="p">(</span><span class="n">TopazDataHistorical</span><span class="p">):</span>
<a id="__codelineno-9-33" name="__codelineno-9-33" href="#__codelineno-9-33"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<a id="__codelineno-9-34" name="__codelineno-9-34" href="#__codelineno-9-34"></a><span class="sd">    This function generates a timezone naive column and then discards all data except the previous 12 months.</span>
<a id="__codelineno-9-35" name="__codelineno-9-35" href="#__codelineno-9-35"></a><span class="sd">    The Topaz API meetingDate is timezone aware and filtering using datetime.today() - timedelta(years=1) isn&#39;t possible. </span>
<a id="__codelineno-9-36" name="__codelineno-9-36" href="#__codelineno-9-36"></a><span class="sd">    Removing the timezone will create errors with the dogAge function so creating a timezone naive copy is the best way to accomplish this before discarding it</span>
<a id="__codelineno-9-37" name="__codelineno-9-37" href="#__codelineno-9-37"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-9-38" name="__codelineno-9-38" href="#__codelineno-9-38"></a>    <span class="c1"># Create the naive meetingDate</span>
<a id="__codelineno-9-39" name="__codelineno-9-39" href="#__codelineno-9-39"></a>    <span class="n">TopazDataHistorical</span><span class="p">[</span><span class="s1">&#39;meetingDateNaive&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">TopazData</span><span class="p">[</span><span class="s1">&#39;meetingDate&#39;</span><span class="p">],</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">T%H:%M:%S.</span><span class="si">%f</span><span class="s1">Z&#39;</span><span class="p">,</span> <span class="n">utc</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-9-40" name="__codelineno-9-40" href="#__codelineno-9-40"></a>
<a id="__codelineno-9-41" name="__codelineno-9-41" href="#__codelineno-9-41"></a>    <span class="c1"># Discard all but the last 12 months</span>
<a id="__codelineno-9-42" name="__codelineno-9-42" href="#__codelineno-9-42"></a>    <span class="n">TopazDataHistorical</span> <span class="o">=</span> <span class="n">TopazDataHistorical</span><span class="p">[</span><span class="n">TopazDataHistorical</span><span class="p">[</span><span class="s1">&#39;meetingDateNaive&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">years</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span>
<a id="__codelineno-9-43" name="__codelineno-9-43" href="#__codelineno-9-43"></a>
<a id="__codelineno-9-44" name="__codelineno-9-44" href="#__codelineno-9-44"></a>    <span class="k">return</span> <span class="n">TopazDataHistorical</span>
<a id="__codelineno-9-45" name="__codelineno-9-45" href="#__codelineno-9-45"></a>
<a id="__codelineno-9-46" name="__codelineno-9-46" href="#__codelineno-9-46"></a><span class="k">def</span> <span class="nf">load_topaz_preprocessing_data</span><span class="p">(</span><span class="n">codes</span><span class="p">,</span><span class="n">datatype</span><span class="p">):</span>
<a id="__codelineno-9-47" name="__codelineno-9-47" href="#__codelineno-9-47"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<a id="__codelineno-9-48" name="__codelineno-9-48" href="#__codelineno-9-48"></a><span class="sd">    This function combines 4 of our previous functions to load our existing topaz historical data into a dataframe from our database and perform some basic cleaning and then keep only the last 12 months for preprocessing</span>
<a id="__codelineno-9-49" name="__codelineno-9-49" href="#__codelineno-9-49"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-9-50" name="__codelineno-9-50" href="#__codelineno-9-50"></a>    <span class="n">TopazDataHistorical</span> <span class="o">=</span> <span class="n">load_topaz_data</span><span class="p">(</span><span class="n">codes</span><span class="p">,</span><span class="n">datatype</span><span class="p">)</span>
<a id="__codelineno-9-51" name="__codelineno-9-51" href="#__codelineno-9-51"></a>
<a id="__codelineno-9-52" name="__codelineno-9-52" href="#__codelineno-9-52"></a>    <span class="n">TopazDataHistorical</span> <span class="o">=</span> <span class="n">discard_scratched_runners_data</span><span class="p">(</span><span class="n">TopazDataHistorical</span><span class="p">)</span>
<a id="__codelineno-9-53" name="__codelineno-9-53" href="#__codelineno-9-53"></a>
<a id="__codelineno-9-54" name="__codelineno-9-54" href="#__codelineno-9-54"></a>    <span class="n">TopazDataHistorical</span> <span class="o">=</span> <span class="n">topaz_last_12_months</span><span class="p">(</span><span class="n">TopazDataHistorical</span><span class="p">)</span>
<a id="__codelineno-9-55" name="__codelineno-9-55" href="#__codelineno-9-55"></a>
<a id="__codelineno-9-56" name="__codelineno-9-56" href="#__codelineno-9-56"></a>    <span class="n">TopazDataHistorical</span> <span class="o">=</span> <span class="n">discard_unnecessary_columns</span><span class="p">(</span><span class="n">TopazDataHistorical</span><span class="p">,</span><span class="n">TOPAZ_COLUMNS_TO_KEEP</span><span class="p">)</span>
<a id="__codelineno-9-57" name="__codelineno-9-57" href="#__codelineno-9-57"></a>
<a id="__codelineno-9-58" name="__codelineno-9-58" href="#__codelineno-9-58"></a>    <span class="k">return</span> <span class="n">TopazDataHistorical</span>
<a id="__codelineno-9-59" name="__codelineno-9-59" href="#__codelineno-9-59"></a>
<a id="__codelineno-9-60" name="__codelineno-9-60" href="#__codelineno-9-60"></a><span class="n">TopazDataHistorical</span> <span class="o">=</span> <span class="n">load_topaz_preprocessing_data</span><span class="p">(</span><span class="n">JURISDICTION_CODES</span><span class="p">,</span><span class="s1">&#39;HISTORICAL&#39;</span><span class="p">)</span>
</code></pre></div>
<p>Following this step, we'll need to download today's upcoming races from the Topaz API and also gather market information from the Betfair API to generate today's ratings. </p>
<p>An important thing to note here is that the update frequency of box information on Topaz is not known and for upcoming races, may not be reliable. We do, however, know that the Betfair Fields only appear once fields are final and so box information will be accurate. There we need to query the market clarifications field and extract the box information using a rather ugly regex script. Once we've done this, we can replace the box information from Topaz with the box information taken from the Betfair API before we process the raw Topaz data ready for application of our lovingly trained GridSearch'ed LGBM model</p>
<div class="highlight"><span class="filename">Gathering today's upcoming races from Topaz and the Betfair API</span><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="kn">import</span> <span class="nn">betfairlightweight</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="kn">from</span> <span class="nn">betfairlightweight</span> <span class="kn">import</span> <span class="n">filters</span>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">timedelta</span>
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a><span class="kn">from</span> <span class="nn">nltk.tokenize</span> <span class="kn">import</span> <span class="n">regexp_tokenize</span>
<a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a><span class="kn">import</span> <span class="nn">warnings</span>
<a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a><span class="kn">import</span> <span class="nn">json</span>
<a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a>
<a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a><span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s1">&#39;The behavior of DataFrame concatenation with empty or all-NA entries is deprecated.*&#39;</span><span class="p">)</span>
<a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a>
<a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a><span class="k">def</span> <span class="nf">bflw_trading</span><span class="p">():</span>
<a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<a id="__codelineno-10-13" name="__codelineno-10-13" href="#__codelineno-10-13"></a><span class="sd">    This function loads the credentials file, and passes the credentials into the betfairlightweight instance</span>
<a id="__codelineno-10-14" name="__codelineno-10-14" href="#__codelineno-10-14"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-10-15" name="__codelineno-10-15" href="#__codelineno-10-15"></a>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;credentials.json&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-10-16" name="__codelineno-10-16" href="#__codelineno-10-16"></a>        <span class="n">cred</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<a id="__codelineno-10-17" name="__codelineno-10-17" href="#__codelineno-10-17"></a>        <span class="n">username</span> <span class="o">=</span> <span class="n">cred</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]</span>
<a id="__codelineno-10-18" name="__codelineno-10-18" href="#__codelineno-10-18"></a>        <span class="n">password</span> <span class="o">=</span> <span class="n">cred</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">]</span>
<a id="__codelineno-10-19" name="__codelineno-10-19" href="#__codelineno-10-19"></a>        <span class="n">app_key</span> <span class="o">=</span> <span class="n">cred</span><span class="p">[</span><span class="s1">&#39;app_key&#39;</span><span class="p">]</span>
<a id="__codelineno-10-20" name="__codelineno-10-20" href="#__codelineno-10-20"></a>
<a id="__codelineno-10-21" name="__codelineno-10-21" href="#__codelineno-10-21"></a>    <span class="c1"># Define the betfairlightweight client</span>
<a id="__codelineno-10-22" name="__codelineno-10-22" href="#__codelineno-10-22"></a>    <span class="n">trading</span> <span class="o">=</span> <span class="n">betfairlightweight</span><span class="o">.</span><span class="n">APIClient</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">app_key</span><span class="o">=</span><span class="n">app_key</span><span class="p">)</span>
<a id="__codelineno-10-23" name="__codelineno-10-23" href="#__codelineno-10-23"></a>
<a id="__codelineno-10-24" name="__codelineno-10-24" href="#__codelineno-10-24"></a>    <span class="k">return</span> <span class="n">trading</span>
<a id="__codelineno-10-25" name="__codelineno-10-25" href="#__codelineno-10-25"></a>
<a id="__codelineno-10-26" name="__codelineno-10-26" href="#__codelineno-10-26"></a><span class="k">def</span> <span class="nf">login</span><span class="p">(</span><span class="n">trading</span><span class="p">):</span>
<a id="__codelineno-10-27" name="__codelineno-10-27" href="#__codelineno-10-27"></a>    <span class="c1"># login to the API</span>
<a id="__codelineno-10-28" name="__codelineno-10-28" href="#__codelineno-10-28"></a>    <span class="n">trading</span><span class="o">.</span><span class="n">login_interactive</span><span class="p">()</span>
<a id="__codelineno-10-29" name="__codelineno-10-29" href="#__codelineno-10-29"></a>
<a id="__codelineno-10-30" name="__codelineno-10-30" href="#__codelineno-10-30"></a><span class="k">def</span> <span class="nf">greyhound_market_filter</span><span class="p">():</span>
<a id="__codelineno-10-31" name="__codelineno-10-31" href="#__codelineno-10-31"></a>    <span class="c1"># Define the greyhound market filter</span>
<a id="__codelineno-10-32" name="__codelineno-10-32" href="#__codelineno-10-32"></a>    <span class="n">market_filter</span> <span class="o">=</span> <span class="n">filters</span><span class="o">.</span><span class="n">market_filter</span><span class="p">(</span>
<a id="__codelineno-10-33" name="__codelineno-10-33" href="#__codelineno-10-33"></a>        <span class="n">event_type_ids</span><span class="o">=</span><span class="p">[</span><span class="mi">4339</span><span class="p">],</span>  <span class="c1"># For horse racing</span>
<a id="__codelineno-10-34" name="__codelineno-10-34" href="#__codelineno-10-34"></a>        <span class="n">market_countries</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;AU&#39;</span><span class="p">],</span>  <span class="c1"># For Australia</span>
<a id="__codelineno-10-35" name="__codelineno-10-35" href="#__codelineno-10-35"></a>        <span class="n">market_type_codes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;WIN&#39;</span><span class="p">]</span>  <span class="c1"># For win markets</span>
<a id="__codelineno-10-36" name="__codelineno-10-36" href="#__codelineno-10-36"></a>    <span class="p">)</span>
<a id="__codelineno-10-37" name="__codelineno-10-37" href="#__codelineno-10-37"></a>
<a id="__codelineno-10-38" name="__codelineno-10-38" href="#__codelineno-10-38"></a>    <span class="k">return</span> <span class="n">market_filter</span>
<a id="__codelineno-10-39" name="__codelineno-10-39" href="#__codelineno-10-39"></a>
<a id="__codelineno-10-40" name="__codelineno-10-40" href="#__codelineno-10-40"></a><span class="k">def</span> <span class="nf">process_runner_books</span><span class="p">(</span><span class="n">runner_books</span><span class="p">):</span>
<a id="__codelineno-10-41" name="__codelineno-10-41" href="#__codelineno-10-41"></a>    <span class="c1"># Define the fields required from the runner book</span>
<a id="__codelineno-10-42" name="__codelineno-10-42" href="#__codelineno-10-42"></a>    <span class="n">selection_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">runner_book</span><span class="o">.</span><span class="n">selection_id</span> <span class="k">for</span> <span class="n">runner_book</span> <span class="ow">in</span> <span class="n">runner_books</span><span class="p">]</span>
<a id="__codelineno-10-43" name="__codelineno-10-43" href="#__codelineno-10-43"></a>
<a id="__codelineno-10-44" name="__codelineno-10-44" href="#__codelineno-10-44"></a>    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
<a id="__codelineno-10-45" name="__codelineno-10-45" href="#__codelineno-10-45"></a>        <span class="s1">&#39;selectionId&#39;</span><span class="p">:</span> <span class="n">selection_ids</span><span class="p">,</span>
<a id="__codelineno-10-46" name="__codelineno-10-46" href="#__codelineno-10-46"></a>    <span class="p">})</span>
<a id="__codelineno-10-47" name="__codelineno-10-47" href="#__codelineno-10-47"></a>    <span class="k">return</span> <span class="n">df</span>
<a id="__codelineno-10-48" name="__codelineno-10-48" href="#__codelineno-10-48"></a>
<a id="__codelineno-10-49" name="__codelineno-10-49" href="#__codelineno-10-49"></a><span class="k">def</span> <span class="nf">generate_greyhound_catalogue</span><span class="p">(</span><span class="n">trading</span><span class="p">,</span><span class="n">market_filter</span><span class="p">):</span>
<a id="__codelineno-10-50" name="__codelineno-10-50" href="#__codelineno-10-50"></a>    <span class="c1"># Load the greyhound market catalogues from the Betfair API</span>
<a id="__codelineno-10-51" name="__codelineno-10-51" href="#__codelineno-10-51"></a>    <span class="n">greyhound_market_catalogues</span> <span class="o">=</span> <span class="n">trading</span><span class="o">.</span><span class="n">betting</span><span class="o">.</span><span class="n">list_market_catalogue</span><span class="p">(</span>
<a id="__codelineno-10-52" name="__codelineno-10-52" href="#__codelineno-10-52"></a>    <span class="nb">filter</span><span class="o">=</span><span class="n">market_filter</span><span class="p">,</span>
<a id="__codelineno-10-53" name="__codelineno-10-53" href="#__codelineno-10-53"></a>    <span class="n">market_projection</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;RUNNER_DESCRIPTION&#39;</span><span class="p">,</span> <span class="s1">&#39;EVENT&#39;</span><span class="p">,</span> <span class="s1">&#39;MARKET_DESCRIPTION&#39;</span><span class="p">],</span>
<a id="__codelineno-10-54" name="__codelineno-10-54" href="#__codelineno-10-54"></a>    <span class="n">max_results</span><span class="o">=</span><span class="s1">&#39;200&#39;</span><span class="p">)</span>
<a id="__codelineno-10-55" name="__codelineno-10-55" href="#__codelineno-10-55"></a>
<a id="__codelineno-10-56" name="__codelineno-10-56" href="#__codelineno-10-56"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">greyhound_market_catalogues</span><span class="p">)</span><span class="si">}</span><span class="s2"> markets.&quot;</span><span class="p">)</span>
<a id="__codelineno-10-57" name="__codelineno-10-57" href="#__codelineno-10-57"></a>
<a id="__codelineno-10-58" name="__codelineno-10-58" href="#__codelineno-10-58"></a>    <span class="k">return</span> <span class="n">greyhound_market_catalogues</span>
<a id="__codelineno-10-59" name="__codelineno-10-59" href="#__codelineno-10-59"></a>
<a id="__codelineno-10-60" name="__codelineno-10-60" href="#__codelineno-10-60"></a><span class="n">RUNNER_DATA_COLUMNS</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-10-61" name="__codelineno-10-61" href="#__codelineno-10-61"></a>            <span class="s1">&#39;marketStart&#39;</span><span class="p">,</span>
<a id="__codelineno-10-62" name="__codelineno-10-62" href="#__codelineno-10-62"></a>            <span class="s1">&#39;track&#39;</span><span class="p">,</span>
<a id="__codelineno-10-63" name="__codelineno-10-63" href="#__codelineno-10-63"></a>            <span class="s1">&#39;raceNumber&#39;</span><span class="p">,</span>
<a id="__codelineno-10-64" name="__codelineno-10-64" href="#__codelineno-10-64"></a>            <span class="s1">&#39;raceType&#39;</span><span class="p">,</span>
<a id="__codelineno-10-65" name="__codelineno-10-65" href="#__codelineno-10-65"></a>            <span class="s1">&#39;winMarketId&#39;</span><span class="p">,</span>
<a id="__codelineno-10-66" name="__codelineno-10-66" href="#__codelineno-10-66"></a>            <span class="s1">&#39;selectionId&#39;</span><span class="p">,</span>
<a id="__codelineno-10-67" name="__codelineno-10-67" href="#__codelineno-10-67"></a>            <span class="s1">&#39;rugNumber&#39;</span><span class="p">,</span>
<a id="__codelineno-10-68" name="__codelineno-10-68" href="#__codelineno-10-68"></a>            <span class="s1">&#39;boxNumber&#39;</span><span class="p">,</span>
<a id="__codelineno-10-69" name="__codelineno-10-69" href="#__codelineno-10-69"></a>            <span class="s1">&#39;dogName&#39;</span>
<a id="__codelineno-10-70" name="__codelineno-10-70" href="#__codelineno-10-70"></a>            <span class="p">]</span>
<a id="__codelineno-10-71" name="__codelineno-10-71" href="#__codelineno-10-71"></a>
<a id="__codelineno-10-72" name="__codelineno-10-72" href="#__codelineno-10-72"></a><span class="k">def</span> <span class="nf">initilise_dataframe</span><span class="p">():</span>
<a id="__codelineno-10-73" name="__codelineno-10-73" href="#__codelineno-10-73"></a>    <span class="c1"># Create the empty dataframe</span>
<a id="__codelineno-10-74" name="__codelineno-10-74" href="#__codelineno-10-74"></a>    <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">RUNNER_DATA_COLUMNS</span><span class="p">)</span>
<a id="__codelineno-10-75" name="__codelineno-10-75" href="#__codelineno-10-75"></a>
<a id="__codelineno-10-76" name="__codelineno-10-76" href="#__codelineno-10-76"></a>    <span class="k">return</span> <span class="n">data</span>
<a id="__codelineno-10-77" name="__codelineno-10-77" href="#__codelineno-10-77"></a>
<a id="__codelineno-10-78" name="__codelineno-10-78" href="#__codelineno-10-78"></a><span class="n">PATTERN1</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;(?&lt;=&lt;br&gt;Dog ).+?(?= starts)&#39;</span>
<a id="__codelineno-10-79" name="__codelineno-10-79" href="#__codelineno-10-79"></a>
<a id="__codelineno-10-80" name="__codelineno-10-80" href="#__codelineno-10-80"></a><span class="n">PATTERN2</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;(?&lt;=\bbox no. )(\w+)&quot;</span>
<a id="__codelineno-10-81" name="__codelineno-10-81" href="#__codelineno-10-81"></a>
<a id="__codelineno-10-82" name="__codelineno-10-82" href="#__codelineno-10-82"></a><span class="k">def</span> <span class="nf">process_market_clarifications</span><span class="p">(</span><span class="n">runners_df</span><span class="p">,</span><span class="n">clarifications</span><span class="p">):</span>
<a id="__codelineno-10-83" name="__codelineno-10-83" href="#__codelineno-10-83"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<a id="__codelineno-10-84" name="__codelineno-10-84" href="#__codelineno-10-84"></a><span class="sd">    This function accesses the market clarifications field which explains which box the reserve runner will be starting from (if any) and parses the information using regex</span>
<a id="__codelineno-10-85" name="__codelineno-10-85" href="#__codelineno-10-85"></a><span class="sd">    We utilise this information rather than the Topaz API data because Betfair markets only use final field information</span>
<a id="__codelineno-10-86" name="__codelineno-10-86" href="#__codelineno-10-86"></a>
<a id="__codelineno-10-87" name="__codelineno-10-87" href="#__codelineno-10-87"></a><span class="sd">    A clarification will look like: &quot;&lt;br&gt;Box changes:&lt;br&gt;Dog 9. Tralee Blaze starts from box no. 8&lt;br&gt;&lt;br&gt;Dog 6. That Other One starts from box no. 2&lt;br&gt;&lt;br&gt;&quot;</span>
<a id="__codelineno-10-88" name="__codelineno-10-88" href="#__codelineno-10-88"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-10-89" name="__codelineno-10-89" href="#__codelineno-10-89"></a>    <span class="c1"># Define the clarifications dataframe</span>
<a id="__codelineno-10-90" name="__codelineno-10-90" href="#__codelineno-10-90"></a>    <span class="n">market_clarifications</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">regexp_tokenize</span><span class="p">(</span><span class="n">clarifications</span><span class="p">,</span> <span class="n">PATTERN1</span><span class="p">),</span> <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;dogName&#39;</span><span class="p">])</span>
<a id="__codelineno-10-91" name="__codelineno-10-91" href="#__codelineno-10-91"></a>
<a id="__codelineno-10-92" name="__codelineno-10-92" href="#__codelineno-10-92"></a>    <span class="c1"># Remove dog name from runner_number</span>
<a id="__codelineno-10-93" name="__codelineno-10-93" href="#__codelineno-10-93"></a>    <span class="n">market_clarifications</span><span class="p">[</span><span class="s1">&#39;rugNumber&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">market_clarifications</span><span class="p">[</span><span class="s1">&#39;dogName&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;. &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-10-94" name="__codelineno-10-94" href="#__codelineno-10-94"></a>
<a id="__codelineno-10-95" name="__codelineno-10-95" href="#__codelineno-10-95"></a>    <span class="c1"># Extract box number from clarifications</span>
<a id="__codelineno-10-96" name="__codelineno-10-96" href="#__codelineno-10-96"></a>    <span class="n">market_clarifications</span><span class="p">[</span><span class="s1">&#39;boxNumber&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">regexp_tokenize</span><span class="p">(</span><span class="n">clarifications</span><span class="p">,</span> <span class="n">PATTERN2</span><span class="p">)</span>
<a id="__codelineno-10-97" name="__codelineno-10-97" href="#__codelineno-10-97"></a>
<a id="__codelineno-10-98" name="__codelineno-10-98" href="#__codelineno-10-98"></a>    <span class="c1"># Keep only boxNumber and rugNumber</span>
<a id="__codelineno-10-99" name="__codelineno-10-99" href="#__codelineno-10-99"></a>    <span class="n">market_clarifications</span><span class="o">=</span><span class="n">market_clarifications</span><span class="p">[[</span><span class="s1">&#39;rugNumber&#39;</span><span class="p">,</span><span class="s1">&#39;boxNumber&#39;</span><span class="p">]]</span>
<a id="__codelineno-10-100" name="__codelineno-10-100" href="#__codelineno-10-100"></a>
<a id="__codelineno-10-101" name="__codelineno-10-101" href="#__codelineno-10-101"></a>    <span class="c1"># Merge the clarifications with the original dataframe</span>
<a id="__codelineno-10-102" name="__codelineno-10-102" href="#__codelineno-10-102"></a>    <span class="n">runners_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">runners_df</span><span class="p">,</span><span class="n">market_clarifications</span><span class="p">,</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span><span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;rugNumber&#39;</span><span class="p">])</span>
<a id="__codelineno-10-103" name="__codelineno-10-103" href="#__codelineno-10-103"></a>
<a id="__codelineno-10-104" name="__codelineno-10-104" href="#__codelineno-10-104"></a>    <span class="c1"># Any runners with no clarifications will start in the box that matches the rugNumber</span>
<a id="__codelineno-10-105" name="__codelineno-10-105" href="#__codelineno-10-105"></a>    <span class="n">runners_df</span><span class="p">[</span><span class="s1">&#39;boxNumber&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">runners_df</span><span class="p">[</span><span class="s1">&#39;rugNumber&#39;</span><span class="p">],</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-10-106" name="__codelineno-10-106" href="#__codelineno-10-106"></a>
<a id="__codelineno-10-107" name="__codelineno-10-107" href="#__codelineno-10-107"></a>    <span class="k">return</span> <span class="n">runners_df</span>
<a id="__codelineno-10-108" name="__codelineno-10-108" href="#__codelineno-10-108"></a>
<a id="__codelineno-10-109" name="__codelineno-10-109" href="#__codelineno-10-109"></a>
<a id="__codelineno-10-110" name="__codelineno-10-110" href="#__codelineno-10-110"></a><span class="k">def</span> <span class="nf">collect_greyhound_market_data</span><span class="p">(</span><span class="n">trading</span><span class="p">,</span><span class="n">greyhound_market_catalogues</span><span class="p">,</span><span class="n">data</span><span class="p">):</span>
<a id="__codelineno-10-111" name="__codelineno-10-111" href="#__codelineno-10-111"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<a id="__codelineno-10-112" name="__codelineno-10-112" href="#__codelineno-10-112"></a><span class="sd">    This function will process the greyhound market catalogue to access information about the market including:</span>
<a id="__codelineno-10-113" name="__codelineno-10-113" href="#__codelineno-10-113"></a><span class="sd">     - Market ID</span>
<a id="__codelineno-10-114" name="__codelineno-10-114" href="#__codelineno-10-114"></a><span class="sd">     - Market Name</span>
<a id="__codelineno-10-115" name="__codelineno-10-115" href="#__codelineno-10-115"></a><span class="sd">     - Event Name</span>
<a id="__codelineno-10-116" name="__codelineno-10-116" href="#__codelineno-10-116"></a><span class="sd">     - Start Time</span>
<a id="__codelineno-10-117" name="__codelineno-10-117" href="#__codelineno-10-117"></a><span class="sd">     - Clarifications</span>
<a id="__codelineno-10-118" name="__codelineno-10-118" href="#__codelineno-10-118"></a>
<a id="__codelineno-10-119" name="__codelineno-10-119" href="#__codelineno-10-119"></a><span class="sd">    It will then process each individual market book to gather the runner information, following by some operations to put market information into the dataframe columns including adjusting the timezone from UTC to AEST</span>
<a id="__codelineno-10-120" name="__codelineno-10-120" href="#__codelineno-10-120"></a><span class="sd">    Finally it will then perform some string splitting operations to generate more useful market/runner information:</span>
<a id="__codelineno-10-121" name="__codelineno-10-121" href="#__codelineno-10-121"></a><span class="sd">     - Track</span>
<a id="__codelineno-10-122" name="__codelineno-10-122" href="#__codelineno-10-122"></a><span class="sd">     - Race Number</span>
<a id="__codelineno-10-123" name="__codelineno-10-123" href="#__codelineno-10-123"></a><span class="sd">     - Race Type</span>
<a id="__codelineno-10-124" name="__codelineno-10-124" href="#__codelineno-10-124"></a><span class="sd">     - Rug Number</span>
<a id="__codelineno-10-125" name="__codelineno-10-125" href="#__codelineno-10-125"></a><span class="sd">     - Dog Name</span>
<a id="__codelineno-10-126" name="__codelineno-10-126" href="#__codelineno-10-126"></a>
<a id="__codelineno-10-127" name="__codelineno-10-127" href="#__codelineno-10-127"></a><span class="sd">    These operations may be useful depending on whether the betting intention is for a specific subset of races. It is also possible to split out race distance from the market name</span>
<a id="__codelineno-10-128" name="__codelineno-10-128" href="#__codelineno-10-128"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-10-129" name="__codelineno-10-129" href="#__codelineno-10-129"></a>    <span class="c1"># Initiate the for loop</span>
<a id="__codelineno-10-130" name="__codelineno-10-130" href="#__codelineno-10-130"></a>    <span class="k">for</span> <span class="n">market_catalogue</span> <span class="ow">in</span> <span class="n">greyhound_market_catalogues</span><span class="p">:</span>
<a id="__codelineno-10-131" name="__codelineno-10-131" href="#__codelineno-10-131"></a>
<a id="__codelineno-10-132" name="__codelineno-10-132" href="#__codelineno-10-132"></a>        <span class="c1"># Name variables for market parameters</span>
<a id="__codelineno-10-133" name="__codelineno-10-133" href="#__codelineno-10-133"></a>        <span class="n">market_id</span> <span class="o">=</span> <span class="n">market_catalogue</span><span class="o">.</span><span class="n">market_id</span>
<a id="__codelineno-10-134" name="__codelineno-10-134" href="#__codelineno-10-134"></a>        <span class="n">market_name</span> <span class="o">=</span> <span class="n">market_catalogue</span><span class="o">.</span><span class="n">market_name</span>
<a id="__codelineno-10-135" name="__codelineno-10-135" href="#__codelineno-10-135"></a>        <span class="n">event_name</span> <span class="o">=</span> <span class="n">market_catalogue</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">name</span>
<a id="__codelineno-10-136" name="__codelineno-10-136" href="#__codelineno-10-136"></a>        <span class="n">market_start_time</span> <span class="o">=</span> <span class="n">market_catalogue</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">market_time</span>
<a id="__codelineno-10-137" name="__codelineno-10-137" href="#__codelineno-10-137"></a>
<a id="__codelineno-10-138" name="__codelineno-10-138" href="#__codelineno-10-138"></a>        <span class="c1"># Try to access clarifications and replace a known string replacement to prepare it for our regex functuon</span>
<a id="__codelineno-10-139" name="__codelineno-10-139" href="#__codelineno-10-139"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-10-140" name="__codelineno-10-140" href="#__codelineno-10-140"></a>            <span class="n">clarifications</span> <span class="o">=</span> <span class="n">market_catalogue</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">clarifications</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;br&gt; Dog&quot;</span><span class="p">,</span><span class="s2">&quot;&lt;br&gt;Dog&quot;</span><span class="p">)</span>
<a id="__codelineno-10-141" name="__codelineno-10-141" href="#__codelineno-10-141"></a>        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
<a id="__codelineno-10-142" name="__codelineno-10-142" href="#__codelineno-10-142"></a>            <span class="n">clarifications</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-10-143" name="__codelineno-10-143" href="#__codelineno-10-143"></a>
<a id="__codelineno-10-144" name="__codelineno-10-144" href="#__codelineno-10-144"></a>        <span class="c1"># Generate our market_books list</span>
<a id="__codelineno-10-145" name="__codelineno-10-145" href="#__codelineno-10-145"></a>        <span class="n">market_books</span> <span class="o">=</span> <span class="n">trading</span><span class="o">.</span><span class="n">betting</span><span class="o">.</span><span class="n">list_market_book</span><span class="p">(</span><span class="n">market_ids</span><span class="o">=</span><span class="p">[</span><span class="n">market_id</span><span class="p">])</span>
<a id="__codelineno-10-146" name="__codelineno-10-146" href="#__codelineno-10-146"></a>
<a id="__codelineno-10-147" name="__codelineno-10-147" href="#__codelineno-10-147"></a>        <span class="c1"># Generate our runner_catalogues list</span>
<a id="__codelineno-10-148" name="__codelineno-10-148" href="#__codelineno-10-148"></a>        <span class="n">runner_catalogues</span> <span class="o">=</span> <span class="n">market_catalogue</span><span class="o">.</span><span class="n">runners</span>
<a id="__codelineno-10-149" name="__codelineno-10-149" href="#__codelineno-10-149"></a>
<a id="__codelineno-10-150" name="__codelineno-10-150" href="#__codelineno-10-150"></a>        <span class="c1"># Initiate the market_books for loop</span>
<a id="__codelineno-10-151" name="__codelineno-10-151" href="#__codelineno-10-151"></a>        <span class="k">for</span> <span class="n">market_book</span> <span class="ow">in</span> <span class="n">market_books</span><span class="p">:</span>
<a id="__codelineno-10-152" name="__codelineno-10-152" href="#__codelineno-10-152"></a>
<a id="__codelineno-10-153" name="__codelineno-10-153" href="#__codelineno-10-153"></a>            <span class="c1"># Call the process_runner_books function</span>
<a id="__codelineno-10-154" name="__codelineno-10-154" href="#__codelineno-10-154"></a>            <span class="n">runners_df</span> <span class="o">=</span> <span class="n">process_runner_books</span><span class="p">(</span><span class="n">market_book</span><span class="o">.</span><span class="n">runners</span><span class="p">)</span>
<a id="__codelineno-10-155" name="__codelineno-10-155" href="#__codelineno-10-155"></a>
<a id="__codelineno-10-156" name="__codelineno-10-156" href="#__codelineno-10-156"></a>            <span class="c1"># Get the runner catalogue</span>
<a id="__codelineno-10-157" name="__codelineno-10-157" href="#__codelineno-10-157"></a>            <span class="k">for</span> <span class="n">runner</span> <span class="ow">in</span> <span class="n">market_book</span><span class="o">.</span><span class="n">runners</span><span class="p">:</span>
<a id="__codelineno-10-158" name="__codelineno-10-158" href="#__codelineno-10-158"></a>
<a id="__codelineno-10-159" name="__codelineno-10-159" href="#__codelineno-10-159"></a>                <span class="c1"># define the runner catalogue</span>
<a id="__codelineno-10-160" name="__codelineno-10-160" href="#__codelineno-10-160"></a>                <span class="n">runner_catalogue</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">rd</span> <span class="k">for</span> <span class="n">rd</span> <span class="ow">in</span> <span class="n">runner_catalogues</span> <span class="k">if</span> <span class="n">rd</span><span class="o">.</span><span class="n">selection_id</span> <span class="o">==</span> <span class="n">runner</span><span class="o">.</span><span class="n">selection_id</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-10-161" name="__codelineno-10-161" href="#__codelineno-10-161"></a>
<a id="__codelineno-10-162" name="__codelineno-10-162" href="#__codelineno-10-162"></a>                <span class="c1"># define the runner name for non-empty runner_catalogues</span>
<a id="__codelineno-10-163" name="__codelineno-10-163" href="#__codelineno-10-163"></a>                <span class="k">if</span> <span class="n">runner_catalogue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-10-164" name="__codelineno-10-164" href="#__codelineno-10-164"></a>                    <span class="n">runner_name</span> <span class="o">=</span> <span class="n">runner_catalogue</span><span class="o">.</span><span class="n">runner_name</span>
<a id="__codelineno-10-165" name="__codelineno-10-165" href="#__codelineno-10-165"></a>                    <span class="n">runners_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">runners_df</span><span class="p">[</span><span class="s1">&#39;selectionId&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">runner</span><span class="o">.</span><span class="n">selection_id</span><span class="p">,</span> <span class="s1">&#39;dogName&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">runner_name</span>
<a id="__codelineno-10-166" name="__codelineno-10-166" href="#__codelineno-10-166"></a>
<a id="__codelineno-10-167" name="__codelineno-10-167" href="#__codelineno-10-167"></a>            <span class="c1"># Assign market variables to the dataframe</span>
<a id="__codelineno-10-168" name="__codelineno-10-168" href="#__codelineno-10-168"></a>            <span class="n">runners_df</span><span class="p">[</span><span class="s1">&#39;winMarketId&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">market_id</span>
<a id="__codelineno-10-169" name="__codelineno-10-169" href="#__codelineno-10-169"></a>            <span class="n">runners_df</span><span class="p">[</span><span class="s1">&#39;marketName&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">market_name</span>
<a id="__codelineno-10-170" name="__codelineno-10-170" href="#__codelineno-10-170"></a>            <span class="n">runners_df</span><span class="p">[</span><span class="s1">&#39;eventName&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">event_name</span>
<a id="__codelineno-10-171" name="__codelineno-10-171" href="#__codelineno-10-171"></a>            <span class="n">runners_df</span><span class="p">[</span><span class="s1">&#39;marketStart&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">market_start_time</span>
<a id="__codelineno-10-172" name="__codelineno-10-172" href="#__codelineno-10-172"></a>
<a id="__codelineno-10-173" name="__codelineno-10-173" href="#__codelineno-10-173"></a>            <span class="c1"># Adjust the timezone from UTC to AEST</span>
<a id="__codelineno-10-174" name="__codelineno-10-174" href="#__codelineno-10-174"></a>            <span class="n">runners_df</span><span class="p">[</span><span class="s1">&#39;marketStart&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">runners_df</span><span class="p">[</span><span class="s1">&#39;marketStart&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<a id="__codelineno-10-175" name="__codelineno-10-175" href="#__codelineno-10-175"></a>
<a id="__codelineno-10-176" name="__codelineno-10-176" href="#__codelineno-10-176"></a>            <span class="c1"># Perform string split operations </span>
<a id="__codelineno-10-177" name="__codelineno-10-177" href="#__codelineno-10-177"></a>            <span class="n">runners_df</span><span class="p">[</span><span class="s1">&#39;track&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">runners_df</span><span class="p">[</span><span class="s1">&#39;eventName&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; \(&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-10-178" name="__codelineno-10-178" href="#__codelineno-10-178"></a>            <span class="n">runners_df</span><span class="p">[</span><span class="s1">&#39;raceNumber&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">runners_df</span><span class="p">[</span><span class="s1">&#39;marketName&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-10-179" name="__codelineno-10-179" href="#__codelineno-10-179"></a>            <span class="n">runners_df</span><span class="p">[</span><span class="s1">&#39;raceNumber&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">runners_df</span><span class="p">[</span><span class="s1">&#39;raceNumber&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;R&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-10-180" name="__codelineno-10-180" href="#__codelineno-10-180"></a>            <span class="n">runners_df</span><span class="p">[</span><span class="s1">&#39;raceType&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">runners_df</span><span class="p">[</span><span class="s1">&#39;marketName&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;m &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-10-181" name="__codelineno-10-181" href="#__codelineno-10-181"></a>            <span class="n">runners_df</span><span class="p">[</span><span class="s1">&#39;rugNumber&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">runners_df</span><span class="p">[</span><span class="s1">&#39;dogName&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;. &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-10-182" name="__codelineno-10-182" href="#__codelineno-10-182"></a>            <span class="n">runners_df</span><span class="p">[</span><span class="s1">&#39;dogName&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">runners_df</span><span class="p">[</span><span class="s1">&#39;dogName&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;\. &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-10-183" name="__codelineno-10-183" href="#__codelineno-10-183"></a>
<a id="__codelineno-10-184" name="__codelineno-10-184" href="#__codelineno-10-184"></a>            <span class="c1"># Call the process_market_clarifications function. If there no reserve runners running then the boxNumber = rugNumber</span>
<a id="__codelineno-10-185" name="__codelineno-10-185" href="#__codelineno-10-185"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-10-186" name="__codelineno-10-186" href="#__codelineno-10-186"></a>                <span class="n">runners_df</span> <span class="o">=</span> <span class="n">process_market_clarifications</span><span class="p">(</span><span class="n">runners_df</span><span class="p">,</span><span class="n">clarifications</span><span class="p">)</span>
<a id="__codelineno-10-187" name="__codelineno-10-187" href="#__codelineno-10-187"></a>            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
<a id="__codelineno-10-188" name="__codelineno-10-188" href="#__codelineno-10-188"></a>                <span class="n">runners_df</span><span class="p">[</span><span class="s1">&#39;boxNumber&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">runners_df</span><span class="p">[</span><span class="s1">&#39;rugNumber&#39;</span><span class="p">]</span>
<a id="__codelineno-10-189" name="__codelineno-10-189" href="#__codelineno-10-189"></a>
<a id="__codelineno-10-190" name="__codelineno-10-190" href="#__codelineno-10-190"></a>            <span class="c1"># concatenate the dataframes together</span>
<a id="__codelineno-10-191" name="__codelineno-10-191" href="#__codelineno-10-191"></a>            <span class="n">data</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">data</span><span class="p">,</span><span class="n">runners_df</span><span class="p">],</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-10-192" name="__codelineno-10-192" href="#__codelineno-10-192"></a>
<a id="__codelineno-10-193" name="__codelineno-10-193" href="#__codelineno-10-193"></a>    <span class="c1"># Keep only required columns</span>
<a id="__codelineno-10-194" name="__codelineno-10-194" href="#__codelineno-10-194"></a>    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">RUNNER_DATA_COLUMNS</span><span class="p">]</span>
<a id="__codelineno-10-195" name="__codelineno-10-195" href="#__codelineno-10-195"></a>    <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<a id="__codelineno-10-196" name="__codelineno-10-196" href="#__codelineno-10-196"></a>
<a id="__codelineno-10-197" name="__codelineno-10-197" href="#__codelineno-10-197"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">head</span><span class="p">)</span>
<a id="__codelineno-10-198" name="__codelineno-10-198" href="#__codelineno-10-198"></a>
<a id="__codelineno-10-199" name="__codelineno-10-199" href="#__codelineno-10-199"></a>    <span class="k">return</span> <span class="n">data</span>
<a id="__codelineno-10-200" name="__codelineno-10-200" href="#__codelineno-10-200"></a>
<a id="__codelineno-10-201" name="__codelineno-10-201" href="#__codelineno-10-201"></a><span class="k">def</span> <span class="nf">download_betfair_market_data</span><span class="p">():</span>
<a id="__codelineno-10-202" name="__codelineno-10-202" href="#__codelineno-10-202"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<a id="__codelineno-10-203" name="__codelineno-10-203" href="#__codelineno-10-203"></a><span class="sd">    This function combines all our previously defined functions to generate our market csv from the Betfair API</span>
<a id="__codelineno-10-204" name="__codelineno-10-204" href="#__codelineno-10-204"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-10-205" name="__codelineno-10-205" href="#__codelineno-10-205"></a>    <span class="n">trading</span> <span class="o">=</span> <span class="n">bflw_trading</span><span class="p">()</span>
<a id="__codelineno-10-206" name="__codelineno-10-206" href="#__codelineno-10-206"></a>
<a id="__codelineno-10-207" name="__codelineno-10-207" href="#__codelineno-10-207"></a>    <span class="n">login</span><span class="p">(</span><span class="n">trading</span><span class="p">)</span>
<a id="__codelineno-10-208" name="__codelineno-10-208" href="#__codelineno-10-208"></a>
<a id="__codelineno-10-209" name="__codelineno-10-209" href="#__codelineno-10-209"></a>    <span class="n">market_filter</span> <span class="o">=</span> <span class="n">greyhound_market_filter</span><span class="p">()</span>
<a id="__codelineno-10-210" name="__codelineno-10-210" href="#__codelineno-10-210"></a>
<a id="__codelineno-10-211" name="__codelineno-10-211" href="#__codelineno-10-211"></a>    <span class="n">greyhound_market_catalogues</span> <span class="o">=</span> <span class="n">generate_greyhound_catalogue</span><span class="p">(</span><span class="n">trading</span><span class="p">,</span><span class="n">market_filter</span><span class="p">)</span>
<a id="__codelineno-10-212" name="__codelineno-10-212" href="#__codelineno-10-212"></a>
<a id="__codelineno-10-213" name="__codelineno-10-213" href="#__codelineno-10-213"></a>    <span class="n">data</span> <span class="o">=</span> <span class="n">initilise_dataframe</span><span class="p">()</span>
<a id="__codelineno-10-214" name="__codelineno-10-214" href="#__codelineno-10-214"></a>
<a id="__codelineno-10-215" name="__codelineno-10-215" href="#__codelineno-10-215"></a>    <span class="n">data</span> <span class="o">=</span> <span class="n">collect_greyhound_market_data</span><span class="p">(</span><span class="n">trading</span><span class="p">,</span><span class="n">greyhound_market_catalogues</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>
<a id="__codelineno-10-216" name="__codelineno-10-216" href="#__codelineno-10-216"></a>
<a id="__codelineno-10-217" name="__codelineno-10-217" href="#__codelineno-10-217"></a>    <span class="k">return</span> <span class="n">data</span>
<a id="__codelineno-10-218" name="__codelineno-10-218" href="#__codelineno-10-218"></a>
<a id="__codelineno-10-219" name="__codelineno-10-219" href="#__codelineno-10-219"></a><span class="n">betfair_data</span> <span class="o">=</span> <span class="n">download_betfair_market_data</span><span class="p">()</span>
<a id="__codelineno-10-220" name="__codelineno-10-220" href="#__codelineno-10-220"></a>
<a id="__codelineno-10-221" name="__codelineno-10-221" href="#__codelineno-10-221"></a><span class="k">def</span> <span class="nf">upcoming_topaz_data</span><span class="p">(</span><span class="n">codes</span><span class="p">,</span><span class="n">datatype</span><span class="p">,</span><span class="n">betfair_data</span><span class="p">):</span>
<a id="__codelineno-10-222" name="__codelineno-10-222" href="#__codelineno-10-222"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<a id="__codelineno-10-223" name="__codelineno-10-223" href="#__codelineno-10-223"></a><span class="sd">    This function loads our upcoming races, discards the Topaz API boxNumber and adds the boxNumber information retrieved from the Betfair API</span>
<a id="__codelineno-10-224" name="__codelineno-10-224" href="#__codelineno-10-224"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-10-225" name="__codelineno-10-225" href="#__codelineno-10-225"></a>    <span class="c1"># Load today&#39;s race information</span>
<a id="__codelineno-10-226" name="__codelineno-10-226" href="#__codelineno-10-226"></a>    <span class="n">TodaysTopazData</span> <span class="o">=</span> <span class="n">load_topaz_data</span><span class="p">(</span><span class="n">codes</span><span class="p">,</span><span class="n">datatype</span><span class="p">)</span>
<a id="__codelineno-10-227" name="__codelineno-10-227" href="#__codelineno-10-227"></a>
<a id="__codelineno-10-228" name="__codelineno-10-228" href="#__codelineno-10-228"></a>    <span class="c1"># Keep only required Betfair information</span>
<a id="__codelineno-10-229" name="__codelineno-10-229" href="#__codelineno-10-229"></a>    <span class="n">betfair_fields</span> <span class="o">=</span> <span class="n">betfair_data</span><span class="p">[[</span><span class="s1">&#39;track&#39;</span><span class="p">,</span><span class="s1">&#39;raceNumber&#39;</span><span class="p">,</span><span class="s1">&#39;rugNumber&#39;</span><span class="p">,</span><span class="s1">&#39;boxNumber&#39;</span><span class="p">]]</span>
<a id="__codelineno-10-230" name="__codelineno-10-230" href="#__codelineno-10-230"></a>
<a id="__codelineno-10-231" name="__codelineno-10-231" href="#__codelineno-10-231"></a>    <span class="c1"># Discard the Topaz API boxNumber information</span>
<a id="__codelineno-10-232" name="__codelineno-10-232" href="#__codelineno-10-232"></a>    <span class="n">TodaysTopazData</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;boxNumber&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-10-233" name="__codelineno-10-233" href="#__codelineno-10-233"></a>
<a id="__codelineno-10-234" name="__codelineno-10-234" href="#__codelineno-10-234"></a>    <span class="c1"># Merge the Betfair boxNumber information</span>
<a id="__codelineno-10-235" name="__codelineno-10-235" href="#__codelineno-10-235"></a>    <span class="n">TodaysTopazData</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">TodaysTopazData</span><span class="p">,</span><span class="n">betfair_fields</span><span class="p">,</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span><span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;track&#39;</span><span class="p">,</span><span class="s1">&#39;raceNumber&#39;</span><span class="p">,</span><span class="s1">&#39;rugNumber&#39;</span><span class="p">])</span>
<a id="__codelineno-10-236" name="__codelineno-10-236" href="#__codelineno-10-236"></a>
<a id="__codelineno-10-237" name="__codelineno-10-237" href="#__codelineno-10-237"></a>    <span class="k">return</span> <span class="n">TodaysTopazData</span>
<a id="__codelineno-10-238" name="__codelineno-10-238" href="#__codelineno-10-238"></a>
<a id="__codelineno-10-239" name="__codelineno-10-239" href="#__codelineno-10-239"></a><span class="n">TodaysTopazData</span> <span class="o">=</span> <span class="p">(</span><span class="n">JURISDICTION_CODES</span><span class="p">,</span><span class="s1">&#39;UPCOMING&#39;</span><span class="p">,</span><span class="n">betfair_data</span><span class="p">)</span>
<a id="__codelineno-10-240" name="__codelineno-10-240" href="#__codelineno-10-240"></a>
<a id="__codelineno-10-241" name="__codelineno-10-241" href="#__codelineno-10-241"></a><span class="k">def</span> <span class="nf">concatenate_data</span><span class="p">(</span><span class="n">TopazDataHistorical</span><span class="p">,</span><span class="n">TodaysTopazData</span><span class="p">):</span>
<a id="__codelineno-10-242" name="__codelineno-10-242" href="#__codelineno-10-242"></a>
<a id="__codelineno-10-243" name="__codelineno-10-243" href="#__codelineno-10-243"></a>    <span class="c1"># Concatenate the last 12 months of Topaz Data with today&#39;s races</span>
<a id="__codelineno-10-244" name="__codelineno-10-244" href="#__codelineno-10-244"></a>    <span class="n">TopazDataPreProcessing</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">TopazDataHistorical</span><span class="p">,</span><span class="n">TodaysTopazData</span><span class="p">])</span>
<a id="__codelineno-10-245" name="__codelineno-10-245" href="#__codelineno-10-245"></a>
<a id="__codelineno-10-246" name="__codelineno-10-246" href="#__codelineno-10-246"></a>    <span class="k">return</span> <span class="n">TopazDataPreProcessing</span>
<a id="__codelineno-10-247" name="__codelineno-10-247" href="#__codelineno-10-247"></a>
<a id="__codelineno-10-248" name="__codelineno-10-248" href="#__codelineno-10-248"></a><span class="n">TopazDataPreProcessing</span> <span class="o">=</span> <span class="n">concatenate_data</span><span class="p">(</span><span class="n">TopazDataHistorical</span><span class="p">,</span><span class="n">TodaysTopazData</span><span class="p">)</span>
</code></pre></div>
<p>The final step now will be to apply all of our previously defined functions to the last 12 months of Topaz data to create our rolling window features before, finally, we can apply our trained model (in the form of a pickle file) to today's field and output our ratings ready to put in the market</p>
<div class="highlight"><span class="filename">Generate today's ratings</span><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="k">def</span> <span class="nf">preprocess_data_for_today</span><span class="p">(</span><span class="n">TopazDataPreProcessing</span><span class="p">):</span>
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="sd">    This function will apply all of our previously defined functions to our dataset in order to generate all the features required for today&#39;s races</span>
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a>
<a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a>    <span class="n">TopazDataPreProcessing</span> <span class="o">=</span> <span class="n">clean_track_data</span><span class="p">(</span><span class="n">TopazDataPreProcessing</span><span class="p">)</span>
<a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a>
<a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a>    <span class="n">TopazDataPreProcessing</span> <span class="o">=</span> <span class="n">extract_form</span><span class="p">(</span><span class="n">TopazDataPreProcessing</span><span class="p">)</span>
<a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a>
<a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a>    <span class="n">TopazDataPreProcessing</span> <span class="o">=</span> <span class="n">correct_result_margin</span><span class="p">(</span><span class="n">TopazDataPreProcessing</span><span class="p">)</span>
<a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a>
<a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a>    <span class="n">TopazDataPreProcessing</span> <span class="o">=</span> <span class="n">generate_dogAge</span><span class="p">(</span><span class="n">TopazDataPreProcessing</span><span class="p">)</span>
<a id="__codelineno-11-13" name="__codelineno-11-13" href="#__codelineno-11-13"></a>
<a id="__codelineno-11-14" name="__codelineno-11-14" href="#__codelineno-11-14"></a>    <span class="n">TopazDataPreProcessing</span> <span class="o">=</span> <span class="n">generate_winPercentage</span><span class="p">(</span><span class="n">TopazDataPreProcessing</span><span class="p">)</span>
<a id="__codelineno-11-15" name="__codelineno-11-15" href="#__codelineno-11-15"></a>
<a id="__codelineno-11-16" name="__codelineno-11-16" href="#__codelineno-11-16"></a>    <span class="n">TopazDataPreProcessing</span> <span class="o">=</span> <span class="n">generate_finishingPlaceMovement</span><span class="p">(</span><span class="n">TopazDataPreProcessing</span><span class="p">)</span>
<a id="__codelineno-11-17" name="__codelineno-11-17" href="#__codelineno-11-17"></a>
<a id="__codelineno-11-18" name="__codelineno-11-18" href="#__codelineno-11-18"></a>    <span class="n">TopazDataPreProcessing</span> <span class="o">=</span> <span class="n">scale_values</span><span class="p">(</span><span class="n">TopazDataPreProcessing</span><span class="p">)</span>
<a id="__codelineno-11-19" name="__codelineno-11-19" href="#__codelineno-11-19"></a>
<a id="__codelineno-11-20" name="__codelineno-11-20" href="#__codelineno-11-20"></a>    <span class="n">TopazDataPreProcessing</span> <span class="o">=</span> <span class="n">generate_runTimeNorm</span><span class="p">(</span><span class="n">TopazDataPreProcessing</span><span class="p">)</span>
<a id="__codelineno-11-21" name="__codelineno-11-21" href="#__codelineno-11-21"></a>
<a id="__codelineno-11-22" name="__codelineno-11-22" href="#__codelineno-11-22"></a>    <span class="n">TopazDataPreProcessing</span> <span class="o">=</span> <span class="n">generate_adjacentVacantBox_state</span><span class="p">(</span><span class="n">TopazDataPreProcessing</span><span class="p">)</span>
<a id="__codelineno-11-23" name="__codelineno-11-23" href="#__codelineno-11-23"></a>
<a id="__codelineno-11-24" name="__codelineno-11-24" href="#__codelineno-11-24"></a>    <span class="n">TopazDataPreProcessing</span> <span class="o">=</span> <span class="n">generate_boxWinPercentage</span><span class="p">(</span><span class="n">TopazDataPreProcessing</span><span class="p">)</span>
<a id="__codelineno-11-25" name="__codelineno-11-25" href="#__codelineno-11-25"></a>
<a id="__codelineno-11-26" name="__codelineno-11-26" href="#__codelineno-11-26"></a>    <span class="n">TopazDataPreProcessing</span><span class="p">,</span> <span class="n">feature_cols</span> <span class="o">=</span> <span class="n">generate_rollingFeatures</span><span class="p">(</span><span class="n">TopazDataPreProcessing</span><span class="p">)</span>
<a id="__codelineno-11-27" name="__codelineno-11-27" href="#__codelineno-11-27"></a>
<a id="__codelineno-11-28" name="__codelineno-11-28" href="#__codelineno-11-28"></a>    <span class="n">feature_cols</span> <span class="o">=</span> <span class="n">generate_feature_list</span><span class="p">(</span><span class="n">feature_cols</span><span class="p">)</span>
<a id="__codelineno-11-29" name="__codelineno-11-29" href="#__codelineno-11-29"></a>
<a id="__codelineno-11-30" name="__codelineno-11-30" href="#__codelineno-11-30"></a>    <span class="n">TopazDataPreProcessing</span><span class="p">,</span> <span class="n">feature_cols</span> <span class="o">=</span> <span class="n">generate_modelling_dataset</span><span class="p">(</span><span class="n">TopazDataPreProcessing</span><span class="p">,</span> <span class="n">feature_cols</span><span class="p">)</span>
<a id="__codelineno-11-31" name="__codelineno-11-31" href="#__codelineno-11-31"></a>
<a id="__codelineno-11-32" name="__codelineno-11-32" href="#__codelineno-11-32"></a>    <span class="n">TopazDataPreProcessing</span> <span class="o">=</span> <span class="n">remove_races</span><span class="p">(</span><span class="n">TopazDataPreProcessing</span><span class="p">)</span>
<a id="__codelineno-11-33" name="__codelineno-11-33" href="#__codelineno-11-33"></a>
<a id="__codelineno-11-34" name="__codelineno-11-34" href="#__codelineno-11-34"></a>    <span class="n">TopazDataPreProcessing</span> <span class="o">=</span> <span class="n">downcast_data</span><span class="p">(</span><span class="n">TopazDataPreProcessing</span><span class="p">)</span>
<a id="__codelineno-11-35" name="__codelineno-11-35" href="#__codelineno-11-35"></a>
<a id="__codelineno-11-36" name="__codelineno-11-36" href="#__codelineno-11-36"></a>    <span class="k">return</span> <span class="n">TopazDataPreProcessing</span>
<a id="__codelineno-11-37" name="__codelineno-11-37" href="#__codelineno-11-37"></a>
<a id="__codelineno-11-38" name="__codelineno-11-38" href="#__codelineno-11-38"></a><span class="n">TopazDataPreProcessing</span> <span class="o">=</span> <span class="n">preprocess_data_for_today</span><span class="p">(</span><span class="n">TopazDataPreProcessing</span><span class="p">)</span>
<a id="__codelineno-11-39" name="__codelineno-11-39" href="#__codelineno-11-39"></a>
<a id="__codelineno-11-40" name="__codelineno-11-40" href="#__codelineno-11-40"></a><span class="k">def</span> <span class="nf">todays_fields</span><span class="p">(</span><span class="n">TopazDataPreProcessing</span><span class="p">):</span>
<a id="__codelineno-11-41" name="__codelineno-11-41" href="#__codelineno-11-41"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<a id="__codelineno-11-42" name="__codelineno-11-42" href="#__codelineno-11-42"></a><span class="sd">    This function removes all race data except for today&#39;s races before we load our trained model</span>
<a id="__codelineno-11-43" name="__codelineno-11-43" href="#__codelineno-11-43"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-11-44" name="__codelineno-11-44" href="#__codelineno-11-44"></a>    <span class="c1"># Create our naive meetingDate</span>
<a id="__codelineno-11-45" name="__codelineno-11-45" href="#__codelineno-11-45"></a>    <span class="n">TopazDataPreProcessing</span><span class="p">[</span><span class="s1">&#39;meetingDateNaive&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">TopazDataPreProcessing</span><span class="p">[</span><span class="s1">&#39;meetingDate&#39;</span><span class="p">],</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">T%H:%M:%S.</span><span class="si">%f</span><span class="s1">Z&#39;</span><span class="p">,</span> <span class="n">utc</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-11-46" name="__codelineno-11-46" href="#__codelineno-11-46"></a>
<a id="__codelineno-11-47" name="__codelineno-11-47" href="#__codelineno-11-47"></a>    <span class="c1"># Keep only today&#39;s races</span>
<a id="__codelineno-11-48" name="__codelineno-11-48" href="#__codelineno-11-48"></a>    <span class="n">todays_runners</span> <span class="o">=</span> <span class="n">TopazDataPreProcessing</span><span class="p">[</span><span class="n">TopazDataPreProcessing</span><span class="p">[</span><span class="s1">&#39;meetingDateNaive&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-11-49" name="__codelineno-11-49" href="#__codelineno-11-49"></a>
<a id="__codelineno-11-50" name="__codelineno-11-50" href="#__codelineno-11-50"></a>    <span class="c1"># Discard the naive meetingDate</span>
<a id="__codelineno-11-51" name="__codelineno-11-51" href="#__codelineno-11-51"></a>    <span class="n">todays_runners</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;meetingDateNaive&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-11-52" name="__codelineno-11-52" href="#__codelineno-11-52"></a>
<a id="__codelineno-11-53" name="__codelineno-11-53" href="#__codelineno-11-53"></a>    <span class="k">return</span> <span class="n">todays_runners</span>
<a id="__codelineno-11-54" name="__codelineno-11-54" href="#__codelineno-11-54"></a>
<a id="__codelineno-11-55" name="__codelineno-11-55" href="#__codelineno-11-55"></a><span class="n">todays_runners</span> <span class="o">=</span> <span class="n">todays_fields</span><span class="p">(</span><span class="n">TopazDataPreProcessing</span><span class="p">)</span>
<a id="__codelineno-11-56" name="__codelineno-11-56" href="#__codelineno-11-56"></a>
<a id="__codelineno-11-57" name="__codelineno-11-57" href="#__codelineno-11-57"></a><span class="kn">import</span> <span class="nn">joblib</span>
<a id="__codelineno-11-58" name="__codelineno-11-58" href="#__codelineno-11-58"></a>
<a id="__codelineno-11-59" name="__codelineno-11-59" href="#__codelineno-11-59"></a><span class="k">def</span> <span class="nf">load_trained_lgbm_model</span><span class="p">():</span>
<a id="__codelineno-11-60" name="__codelineno-11-60" href="#__codelineno-11-60"></a>
<a id="__codelineno-11-61" name="__codelineno-11-61" href="#__codelineno-11-61"></a>    <span class="c1"># Load the trained model</span>
<a id="__codelineno-11-62" name="__codelineno-11-62" href="#__codelineno-11-62"></a>    <span class="n">model</span> <span class="o">=</span> <span class="n">joblib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;best_lgbm_model.pickle&#39;</span><span class="p">)</span>
<a id="__codelineno-11-63" name="__codelineno-11-63" href="#__codelineno-11-63"></a>
<a id="__codelineno-11-64" name="__codelineno-11-64" href="#__codelineno-11-64"></a>    <span class="k">return</span> <span class="n">model</span>
<a id="__codelineno-11-65" name="__codelineno-11-65" href="#__codelineno-11-65"></a>
<a id="__codelineno-11-66" name="__codelineno-11-66" href="#__codelineno-11-66"></a><span class="n">model</span> <span class="o">=</span> <span class="n">load_trained_lgbm_model</span><span class="p">()</span>
<a id="__codelineno-11-67" name="__codelineno-11-67" href="#__codelineno-11-67"></a>
<a id="__codelineno-11-68" name="__codelineno-11-68" href="#__codelineno-11-68"></a><span class="n">MODEL_RATINGS_COLUMNS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">,</span>
<a id="__codelineno-11-69" name="__codelineno-11-69" href="#__codelineno-11-69"></a>                        <span class="s1">&#39;track&#39;</span><span class="p">,</span>
<a id="__codelineno-11-70" name="__codelineno-11-70" href="#__codelineno-11-70"></a>                        <span class="s1">&#39;raceNumber&#39;</span><span class="p">,</span> 
<a id="__codelineno-11-71" name="__codelineno-11-71" href="#__codelineno-11-71"></a>                        <span class="s1">&#39;boxNumber&#39;</span><span class="p">,</span>
<a id="__codelineno-11-72" name="__codelineno-11-72" href="#__codelineno-11-72"></a>                        <span class="s1">&#39;rugNumber&#39;</span><span class="p">,</span>
<a id="__codelineno-11-73" name="__codelineno-11-73" href="#__codelineno-11-73"></a>                        <span class="s1">&#39;win_probability&#39;</span><span class="p">]</span>
<a id="__codelineno-11-74" name="__codelineno-11-74" href="#__codelineno-11-74"></a>
<a id="__codelineno-11-75" name="__codelineno-11-75" href="#__codelineno-11-75"></a><span class="k">def</span> <span class="nf">apply_trained_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">todays_runners</span><span class="p">,</span><span class="n">feature_cols</span><span class="p">):</span>
<a id="__codelineno-11-76" name="__codelineno-11-76" href="#__codelineno-11-76"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<a id="__codelineno-11-77" name="__codelineno-11-77" href="#__codelineno-11-77"></a><span class="sd">    This function will apply our previously trained lgbm model to our dataset to generate today&#39;s rated prices</span>
<a id="__codelineno-11-78" name="__codelineno-11-78" href="#__codelineno-11-78"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-11-79" name="__codelineno-11-79" href="#__codelineno-11-79"></a>
<a id="__codelineno-11-80" name="__codelineno-11-80" href="#__codelineno-11-80"></a>    <span class="c1"># Generate the feature set</span>
<a id="__codelineno-11-81" name="__codelineno-11-81" href="#__codelineno-11-81"></a>    <span class="n">todays_runners_features</span> <span class="o">=</span> <span class="n">todays_runners</span><span class="p">[</span><span class="n">feature_cols</span><span class="p">]</span>
<a id="__codelineno-11-82" name="__codelineno-11-82" href="#__codelineno-11-82"></a>
<a id="__codelineno-11-83" name="__codelineno-11-83" href="#__codelineno-11-83"></a>    <span class="c1"># Apply the trained model</span>
<a id="__codelineno-11-84" name="__codelineno-11-84" href="#__codelineno-11-84"></a>    <span class="n">todays_runners</span><span class="p">[</span><span class="s1">&#39;win_probability&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">todays_runners_features</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-11-85" name="__codelineno-11-85" href="#__codelineno-11-85"></a>
<a id="__codelineno-11-86" name="__codelineno-11-86" href="#__codelineno-11-86"></a>    <span class="c1"># Normalise all probabilities</span>
<a id="__codelineno-11-87" name="__codelineno-11-87" href="#__codelineno-11-87"></a>    <span class="n">todays_runners</span><span class="p">[</span><span class="s1">&#39;win_probability&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">todays_runners</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;raceId&#39;</span><span class="p">,</span> <span class="n">group_keys</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="s1">&#39;win_probability&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
<a id="__codelineno-11-88" name="__codelineno-11-88" href="#__codelineno-11-88"></a>
<a id="__codelineno-11-89" name="__codelineno-11-89" href="#__codelineno-11-89"></a>    <span class="c1"># Select desired columns</span>
<a id="__codelineno-11-90" name="__codelineno-11-90" href="#__codelineno-11-90"></a>    <span class="n">todays_runners</span> <span class="o">=</span> <span class="n">todays_runners</span><span class="p">[</span><span class="n">MODEL_RATINGS_COLUMNS</span><span class="p">]</span>
<a id="__codelineno-11-91" name="__codelineno-11-91" href="#__codelineno-11-91"></a>
<a id="__codelineno-11-92" name="__codelineno-11-92" href="#__codelineno-11-92"></a>    <span class="k">return</span> <span class="n">todays_runners</span>
<a id="__codelineno-11-93" name="__codelineno-11-93" href="#__codelineno-11-93"></a>
<a id="__codelineno-11-94" name="__codelineno-11-94" href="#__codelineno-11-94"></a><span class="n">todays_greyhound_ratings</span> <span class="o">=</span> <span class="n">apply_trained_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">todays_runners</span><span class="p">,</span><span class="n">feature_cols</span><span class="p">)</span>
<a id="__codelineno-11-95" name="__codelineno-11-95" href="#__codelineno-11-95"></a>
<a id="__codelineno-11-96" name="__codelineno-11-96" href="#__codelineno-11-96"></a><span class="k">def</span> <span class="nf">join_betfair_data</span><span class="p">(</span><span class="n">todays_greyhound_ratings</span><span class="p">,</span><span class="n">betfair_data</span><span class="p">):</span>
<a id="__codelineno-11-97" name="__codelineno-11-97" href="#__codelineno-11-97"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<a id="__codelineno-11-98" name="__codelineno-11-98" href="#__codelineno-11-98"></a><span class="sd">    This function will join our Betfair market and runner information with today&#39;s model ratings</span>
<a id="__codelineno-11-99" name="__codelineno-11-99" href="#__codelineno-11-99"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-11-100" name="__codelineno-11-100" href="#__codelineno-11-100"></a>    <span class="c1"># Merge the dataframes</span>
<a id="__codelineno-11-101" name="__codelineno-11-101" href="#__codelineno-11-101"></a>    <span class="n">betfair_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">betfair_data</span><span class="p">,</span><span class="n">todays_greyhound_ratings</span><span class="p">,</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span><span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;track&#39;</span><span class="p">,</span><span class="s1">&#39;raceNumber&#39;</span><span class="p">,</span><span class="s1">&#39;rugNumber&#39;</span><span class="p">])</span>
<a id="__codelineno-11-102" name="__codelineno-11-102" href="#__codelineno-11-102"></a>
<a id="__codelineno-11-103" name="__codelineno-11-103" href="#__codelineno-11-103"></a>    <span class="c1"># Export the data to csv</span>
<a id="__codelineno-11-104" name="__codelineno-11-104" href="#__codelineno-11-104"></a>    <span class="n">betfair_data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;todays_ratings.csv&#39;</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-11-105" name="__codelineno-11-105" href="#__codelineno-11-105"></a>
<a id="__codelineno-11-106" name="__codelineno-11-106" href="#__codelineno-11-106"></a>    <span class="k">return</span> <span class="n">betfair_data</span>
<a id="__codelineno-11-107" name="__codelineno-11-107" href="#__codelineno-11-107"></a>
<a id="__codelineno-11-108" name="__codelineno-11-108" href="#__codelineno-11-108"></a><span class="n">betfair_data</span> <span class="o">=</span> <span class="n">join_betfair_data</span><span class="p">(</span><span class="n">todays_greyhound_ratings</span><span class="p">,</span><span class="n">betfair_data</span><span class="p">)</span>
</code></pre></div>
<h2 id="to-be-continued">To be continued</h2>
<p>The final step here is to fire up flumine to place bets on our rated prices... Stay tuned!</p>
<h2 id="disclaimer">Disclaimer</h2>
<p>Note that whilst models and automated strategies are fun and rewarding to create, we can't promise that your model or betting strategy will be profitable, and we make no representations in relation to the code shared or information on this page. If you're using this code or implementing your own strategies, you do so entirely at your own risk and you are responsible for any winnings/losses incurred. Under no circumstances will Betfair be liable for any loss or damage you suffer.</p>









  




                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
    
      <nav class="md-footer__inner md-grid" aria-label="footer.title">
        
          
          <a href="../cloudOrLocalMachine/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Cloud or Local" rel="prev">
            <div class="md-footer__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
            </div>
            <div class="md-footer__title">
              <div class="md-ellipsis">
                <span class="md-footer__direction">
                  Previous
                </span>
                Cloud or Local
              </div>
            </div>
          </a>
        
        
          
          <a href="../fasttrackTutorial/" class="md-footer__link md-footer__link--next" aria-label="Next: Greyhound form FastTrack API" rel="next">
            <div class="md-footer__title">
              <div class="md-ellipsis">
                <span class="md-footer__direction">
                  Next
                </span>
                Greyhound form FastTrack API
              </div>
            </div>
            <div class="md-footer__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
            </div>
          </a>
        
      </nav>
    
    <div class="md-footer-meta md-typeset">
      <div class="md-footer-meta__inner md-grid">
        <div class="md-copyright">
  
  
</div>
        
          <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://twitter.com/Betfair_Aus" target="_blank" rel="noopener" title="twitter.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://linkedin.com/company/betfair-australia" target="_blank" rel="noopener" title="linkedin.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://facebook.com/betfairaustralia" target="_blank" rel="noopener" title="facebook.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M512 256C512 114.6 397.4 0 256 0S0 114.6 0 256c0 120 82.7 220.8 194.2 248.5V334.2h-52.8V256h52.8v-33.7c0-87.1 39.4-127.5 125-127.5 16.2 0 44.2 3.2 55.7 6.4V172c-6-.6-16.5-1-29.6-1-42 0-58.2 15.9-58.2 57.2V256h83.6l-14.4 78.2H287v175.9C413.8 494.8 512 386.9 512 256z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://youtube.com/user/betfairaus" target="_blank" rel="noopener" title="youtube.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M549.655 124.083c-6.281-23.65-24.787-42.276-48.284-48.597C458.781 64 288 64 288 64S117.22 64 74.629 75.486c-23.497 6.322-42.003 24.947-48.284 48.597-11.412 42.867-11.412 132.305-11.412 132.305s0 89.438 11.412 132.305c6.281 23.65 24.787 41.5 48.284 47.821C117.22 448 288 448 288 448s170.78 0 213.371-11.486c23.497-6.321 42.003-24.171 48.284-47.821 11.412-42.867 11.412-132.305 11.412-132.305s0-89.438-11.412-132.305zm-317.51 213.508V175.185l142.739 81.205-142.739 81.201z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://github.com/betfair-datascientists" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
</div>
        
      </div>

      <div class="bf-footer">
          <div class="bf-footer-inner">
              <p class="bf-light">Betfair Pty Limited is licensed and regulated by the Northern Territory Government of Australia.</p>
              <p class="bf-dark">Betfair Pty Limited's gambling operations are governed by its <a class='inner-link' href="https://www.betfair.com.au/info/responsible-gambling/">Responsible Gambling Code of Conduct</a> and for South
              Australian residents by the <a class='inner-link' href="https://www.betfair.com.au/info/pdf/SA-GCoP.pdf">South Australian Responsible Gambling Code of Practice.</a></p>
              <p class="bf-dark">BetStop is the Australian National Self-Exclusion Register. For more information, please visit <a class="inner-link" href="https://betstop.gov.au">https://betstop.gov.au</a><br /> <div class="full-screen"> <p style="font-family: Arial, sans-serif; font-size: 1.2rem; font-weight: bold;text-align: center;">Chances are you&#39re about to lose</p> <p style="font-family: Arial, sans-serif; font-size: 0.8rem; font-weight: bold;text-align: center;">For free and confidential support call 1800 858 858 or visit <a href="http://www.gamblinghelponline.org.au" style="color: black; text-decoration: underline;">www.gamblinghelponline.org.au</a></p> </div> </p>
              <ul class="bf-links">
                <li><a href="https://www.betfair.com.au/hub/help/account-help/responsible-gambling/">Responsible Gambling</a><span>|</span></li>
                <li><a href="http://www.betfair.com/AUS_NZL/aboutUs/Terms.and.Conditions/">Terms & Conditions</a><span>|</span></li>
                <li><a href="https://www.betfair.com.au/info/privacy-policy/">Privacy Policy</a><span>|</span></li>
                <li><a href="http://www.betfair.com/en/aboutUs/Rules.and.Regulations/">Rules & Regulations</a><span>|</span></li>
                <li><a href="https://www.betfair.com/AUS_NZL/aboutUs/Dispute.Resolution">Dispute Resolution</a></li>
              </ul>
          </div>
      </div>
    </div>

    <script src="https://js.adsrvr.org/up_loader.1.1.0.js" type="text/javascript"></script>
    <script type="text/javascript">
        ttd_dom_ready( function() {
            if (typeof TTDUniversalPixelApi === 'function') {
                var universalPixelApi = new TTDUniversalPixelApi();
                universalPixelApi.init("y12d1ir", ["8ml4f17"], "https://insight.adsrvr.org/track/up");
            }
        });
    </script>

</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["toc.integrate", "navigation.instant", "navigation.tabs", "navigation.top", "navigation.expand", "navigation.sections", "search.suggest", "search.highlight", "search.share"], "search": "../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.e1c3ead8.min.js"></script>
      
        <script src="../../js/scripts.js"></script>
      
    
  </body>
</html>