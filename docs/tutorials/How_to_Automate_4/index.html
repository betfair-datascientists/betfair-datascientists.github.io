
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Documentation, guides and articles on creating, developing and implementing automated betting strategies, using data analysis to inform betting models and how to interact with the Betfair API.">
      
      
        <meta name="author" content="Betfair Data Scientists">
      
      
        <link rel="canonical" href="https://betfair-datascientists.github.io/tutorials/How_to_Automate_4/">
      
      
        <link rel="prev" href="../How_to_Automate_3/">
      
      
        <link rel="next" href="../How_to_Automate_5/">
      
      
      <link rel="icon" href="../../img/BetfairFavicon.ico">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.49">
    
    
      
        <title>How to Automate 4 - The Automation Hub</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.6f8fc17f.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/betfair.css">
    
      <link rel="stylesheet" href="../../css/buttons_and_animations.css">
    
      <link rel="stylesheet" href="../../css/fonts.css">
    
      <link rel="stylesheet" href="../../css/ansi-colours.css">
    
      <link rel="stylesheet" href="../../css/jupyter-cells.css">
    
      <link rel="stylesheet" href="../../css/pandas-dataframe.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","UA-125973915-1"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","UA-125973915-1",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=UA-125973915-1",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="betfair" data-md-color-primary="amber" data-md-color-accent="orange">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#how-to-automate-iv-automate-your-own-model" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      
  
  <header class="md-header" data-md-component="header">
    <nav class="md-header__inner md-grid" aria-label="header.title">
      <a href="../.." title="The Automation Hub" class="md-header__button md-logo" aria-label="The Automation Hub" data-md-component="logo">
        
  <img src="../../img/logo.svg" alt="logo">

      </a>
      <label class="md-header__button md-icon" for="__drawer">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
      </label>
      <div class="md-header__title" data-md-component="header-title">
        <div class="md-header__ellipsis">
          <div class="md-header__topic">
            <span class="md-ellipsis">
              The Automation Hub
            </span>
          </div>
          <div class="md-header__topic" data-md-component="header-topic">
            <span class="md-ellipsis">
              
                How to Automate 4
              
            </span>
          </div>
        </div>
      </div>

      
        <form class="md-header__option" data-md-component="palette">
          
            
            
            <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="betfair" data-md-color-primary="amber" data-md-color-accent="orange"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
            
              <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg>
              </label>
            
          
            
            
            <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="amber" data-md-color-accent="orange"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
            
              <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"/></svg>
              </label>
            
          
        </form>
      
      

      
     
      <div class="bf-nav">
        <a class="bf-hidable" href="https://www.betfair.com.au/exchange/plus/"><svg class="exchangeLogo" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:cc="http://creativecommons.org/ns#"
          xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 38.775 4.59" width="24" height="17">
          <path class="st1" d="m 160.3,-136.95 v 26" />
          <g transform="translate(18.8,-137.15)">
            <path d="m 2.2901089,126.53441 v 5.20093 H -3.3107216 L 7.4888397,144.33446 18.2884,131.73534 h -5.598633 v -5.20093 z m -8.6000974,8.10132 -10.8017585,12.59913 h 5.60083 v 5.2998 h 10.3996581 v -5.2998 h 5.6008306 z" />
          </g>
        </svg><span> Exchange</span></a>
        <a href="https://www.betfair.com.au/hub/">Hub</a>
      </div>

      

    </nav>
    
  </header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../data/dataListing/" class="md-tabs__link">
          
  
  Data

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../wagering/betfairHowTo/" class="md-tabs__link">
          
  
  Wagering

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../api/apiResources/" class="md-tabs__link">
          
  
  API

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../modelling/NBAdatathon/" class="md-tabs__link">
          
  
  Modelling

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../automation/GoldenRulesofAutomation/" class="md-tabs__link">
          
  
  Automation

        </a>
      </li>
    
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../How_to_Automate_1/" class="md-tabs__link">
          
  
  Tutorials

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../mentalGame/intro/" class="md-tabs__link">
          
  
  Mental Game

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../contactUs/test/" class="md-tabs__link">
          
  
  Contact Us

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="The Automation Hub" class="md-nav__button md-logo" aria-label="The Automation Hub" data-md-component="logo">
      
  <img src="../../img/logo.svg" alt="logo">

    </a>
    The Automation Hub
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Data
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Data
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../data/dataListing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CSV Files
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../data/usingHistoricDataSite/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Historic Data Site
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Wagering
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Wagering
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../wagering/betfairHowTo/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Betfair How-To
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../wagering/bettingGlossary/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Betting Glossary
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../wagering/stakingMethods/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Staking Methods and Bankroll Management
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../wagering/valueAndOdds/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Value and Odds
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../wagering/commission/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Commission and other charges
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../wagering/hubPredictionsModel/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Hub Predictions Model
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../wagering/2ndPlaceVoid/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Cashback 2nd Markets
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../wagering/exactaQuinella/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Exactas & Quinella
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    API
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            API
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/apiResources/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    API resources
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/apiappkey/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to access the Betfair API
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/apiRtutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    API tutorial in R
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/apiPythontutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    API tutorial in Python
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Modelling
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Modelling
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/NBAdatathon/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    NBA Datathon
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/howToModel/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Intro to modelling
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/dataSources/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Pricing Data Sources
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/cloudOrLocalMachine/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Cloud or Local
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/monteCarloSimulations/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Monte Carlo Simulations
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_6" >
        
          
          <label class="md-nav__link" for="__nav_5_6" id="__nav_5_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    AFL
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_6">
            <span class="md-nav__icon md-icon"></span>
            AFL
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/AFLPlayerDisposalsTutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Player Disposal Lines
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/AFLPlayerDisposalsFlumine/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Betting Player Disposal Markets
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/AFLmodellingPython/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    AFL modelling walk through in Python
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/modellingTheBrownlowMedal/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How does a Data Scientist model the Brownlow?
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/brownlowModelTutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Modelling the Brownlow Medal in Python
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_7" >
        
          
          <label class="md-nav__link" for="__nav_5_7" id="__nav_5_7_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Racing
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_7">
            <span class="md-nav__icon md-icon"></span>
            Racing
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/topazTutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Greyhound Topaz API (Python)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/fasttrackTutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Greyhound FastTrack API (Python)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/greyhoundModellingPython/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Greyhound modelling (Python)
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_8" >
        
          
          <label class="md-nav__link" for="__nav_5_8" id="__nav_5_8_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Soccer
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_8">
            <span class="md-nav__icon md-icon"></span>
            Soccer
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/howToBuildASoccerBotPartI/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How To Build A Soccer Bot P1
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/howToBuildASoccerBotPartII/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How To Build A Soccer Bot P2
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_9" >
        
          
          <label class="md-nav__link" for="__nav_5_9" id="__nav_5_9_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Soccer (Archive)
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_9">
            <span class="md-nav__icon md-icon"></span>
            Soccer (Archive)
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/soccerModellingTutorialPython/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Soccer modelling (Python)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/EPLmlPython/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    EPL Machine Learning (Python)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/soccerModellingELO2022WorldCup/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Soccer modelling (R) - 2022 FIFA World Cup
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/soccerEloTutorialR/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Elo soccer tutorial (R)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/soccerModellingTutorialR/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Soccer modelling (R)
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_10" >
        
          
          <label class="md-nav__link" for="__nav_5_10" id="__nav_5_10_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Tennis
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_10">
            <span class="md-nav__icon md-icon"></span>
            Tennis
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/howToModelTheAusOpen/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to model the Australian Open
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/AusOpenRTutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Aus Open R Tutorial
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/AusOpenPythonTutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Aus Open Python Tutorial
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Automation
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Automation
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/GoldenRulesofAutomation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Golden rules of automation
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/overview/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Tools Overview
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6_3" >
        
          
          <label class="md-nav__link" for="__nav_6_3" id="__nav_6_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Bet Angel
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_3">
            <span class="md-nav__icon md-icon"></span>
            Bet Angel
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/betAngel/betAngel/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Overview
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/betAngelbeginners/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Beginner's guide
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/betAngelintermediate/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Intermediate guide
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/betAngeladvanced/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Advanced guide
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/betAngelRatingsAutomation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Ratings auto
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/betAngelMarketFavouriteAutomation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Market fav auto
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/betAngelTippingAutomation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Tipping auto
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/betAngelSimultaneousMarkets/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Simultaneous markets
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/betAngelKellyStake/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Kelly criterion staking
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6_4" >
        
          
          <label class="md-nav__link" for="__nav_6_4" id="__nav_6_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Gruss Betting Assistant
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_4">
            <span class="md-nav__icon md-icon"></span>
            Gruss Betting Assistant
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/Gruss/Gruss/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Overview
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/GrussSettingupbasicmarketview/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Setup basic market view and one click betting
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/grussRatingsAutomation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Ratings auto
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/grussMarketFavouriteAutomation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Market fav auto
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/grusslSimultaneousMarkets/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Simultaneous markets
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/grussKellyStake/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Kelly criterion staking
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6_5" >
        
          
          <label class="md-nav__link" for="__nav_6_5" id="__nav_6_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Cymatic Trader
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_5">
            <span class="md-nav__icon md-icon"></span>
            Cymatic Trader
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/CymaticTrader/CymaticTrader/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Overview
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/cymaticTraderRatingsAutomation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Ratings auto
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6_6" >
        
          
          <label class="md-nav__link" for="__nav_6_6" id="__nav_6_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Geeks Toy
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_6">
            <span class="md-nav__icon md-icon"></span>
            Geeks Toy
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/GeeksToyinstallationandsetup/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Installation and setup
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/GeeksToybasicmarketviewstakingandoneclickbetting/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Setup basic market view and one click betting
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/geeksToyRefreshSettings/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Optimising refresh settings
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6_7" >
        
          
          <label class="md-nav__link" for="__nav_6_7" id="__nav_6_7_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Bet Jet Pro
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_7">
            <span class="md-nav__icon md-icon"></span>
            Bet Jet Pro
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/betJetOverview/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Overview
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" checked>
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Tutorials
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            Tutorials
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../How_to_Automate_1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to Automate 1
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../How_to_Automate_2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to Automate 2
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../How_to_Automate_3/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to Automate 3
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    How to Automate 4
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    How to Automate 4
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#prerequisites" class="md-nav__link">
    <span class="md-ellipsis">
      Prerequisites
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#downloading-live-data" class="md-nav__link">
    <span class="md-ellipsis">
      Downloading live data
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#data-cleaning-and-feature-creation" class="md-nav__link">
    <span class="md-ellipsis">
      Data cleaning and feature creation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#automating-our-predictions" class="md-nav__link">
    <span class="md-ellipsis">
      Automating our predictions
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#generating-historical-predictions" class="md-nav__link">
    <span class="md-ellipsis">
      Generating historical predictions
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conclusions-and-next-steps" class="md-nav__link">
    <span class="md-ellipsis">
      Conclusions and next steps
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Conclusions and next steps">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#complete-code" class="md-nav__link">
    <span class="md-ellipsis">
      Complete code
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#disclaimer" class="md-nav__link">
    <span class="md-ellipsis">
      Disclaimer
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../How_to_Automate_5/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to Automate 5
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../flumineSimulations/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Flumine Simulations
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../processingTarFiles101/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Take away the pain! Processing TAR Files 101
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../jsonToCsvRevisited/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    JSON to CSV | Revisited
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../backtestingRatingsTutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Back testing ratings in Python
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../automatedBettingAnglesTutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Automated betting angles in Python
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../analysingAndPredictingMarketMovements/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Do they know? Analysing Betfair market formation & market movements
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../analysingAndPredictingBSP/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Wisdom of the crowd? Analysing & understanding BSP
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_8" >
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Mental Game
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            Mental Game
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/intro/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Intro
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/roleOfEmotions/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Part 1
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/mapYourEmotions/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Part 2
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/handlingBadVariance/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Part 3
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/winbyBeingGreatatLosing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Part 4
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/correctingyouremotions/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Part 5
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/responsibleGambling/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Part 6
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/InchwormConcept/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Part 7
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/HighExpectations/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Part 8
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/TappingYourIntuition/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Part 9
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_9" >
        
          
          <label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Contact Us
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9">
            <span class="md-nav__icon md-icon"></span>
            Contact Us
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../contactUs/test/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Meet the Team
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="how-to-automate-iv-automate-your-own-model">How to Automate IV: Automate your own Model</h1>
<hr />
<p>For this tutorial we will be automating the model that Bruno taught us how to make in the Greyhound Modelling Tutorial. This tutorial follows on logically from <a href="../How_to_Automate_3">How to Automate III</a>. If you haven't already, make sure you take a look at the rest of the series first those before continuing here as they cover some key concepts!</p>
<p>I've actually rewritten this post multiple times and refactored/changed the code many times, if you have any suggestions for improvements, do let me know. If you have followed this tutorial before, there is an archived  versions of this tutorial are available <a href="../How_to_Automate_4_archived">here</a></p>
<hr />
<p>Before we start let's think about what we are trying to achieve and build out a road map, our goal is to automate the model we built earlier. I've split it up into three main steps and a prerequisite step:</p>
<ol start="0">
  <li>Before automating anything we need to save the model that we built in Bruno's tutorial </li>
  <li>Download live data </li>
  <li>Clean our data and create our features</li>
  <li>Generate predictions and automate our model</li>
</ol>

<p>We will create three separate python scripts, one for each step. This will drastically reduce the complexity of our code and make things way easier to understand. We will be generating our model predictions about 1min before the scheduled start of the race, as this will allow us to account for things like scratchings, reserve dogs and we can confirm the box number. As always, the complete code will be available at the bottom of this post!</p>
<p>(You might think that because we split it up into three scripts you will need to click run on the first script, wait for it to finish executing before going on the next one, but we will use a way to link all the scripts together later on, so you can just hit go once!)</p>
<p>We will also create a separate fourth script that generates historical predictions which we can feed into our simulator for <a href="../How_to_Automate_5">How to Automate V</a></p>
<hr />
<h2 id="prerequisites">Prerequisites</h2>
<p>Before we even do anything here we need to save the model we learnt to build in the <a href="../../modelling/greyhoundModellingPython/">Greyhound modelling in Python tutorial</a>, this is super simple as we can just need to run this extra line code (which I have copied from the <a href="https://scikit-learn.org/stable/model_persistence.html">documentation page</a>) at the end of the notebook to save the model:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>from joblib import dump
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>dump(models[&#39;LogisticRegression&#39;], &#39;logistic_regression.joblib&#39;)
</code></pre></div>
<p>If you are following the tutorial and have cloned the github repo you won't actually need to do this, as I have saved the model in the repo and you can read it in directly. (You may have to fiddle with your working directory)</p>
<hr />
<h2 id="downloading-live-data">Downloading live data</h2>
<p>First off the bat is downloading live data i.e. data for today's races. My plan for this part is to reuse the original code that downloads/reads-in the historic data then also download the live data and add that on. Then we can save that as a csv (two: one for dog results and once for race details).</p>
<p>Downloading/reading-in the historic data is super simple as most of the code is copied from Bruno's greyhound modelling tutorial (which I've heard is copied from the original FastTrack tutorial). However, the data is stored in a monthly format which if you're not careful can lead to missing data. I've changed the code to a daily format which fixes this issue. However, this means if you followed the old tutorial you will need to need to redownload the data (from my experience the change to daily format is so worth it!).</p>
<p>I also have a pretty old and slow laptop and the pandas append method is being deprecated, so let's change it to the faster and more efficient concat method:</p>
<div class="highlight"><span class="filename">Downloading/reading-in historic data (code changes highlighted)</span><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>    <span class="kn">import</span> <span class="nn">os</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>    <span class="kn">import</span> <span class="nn">sys</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>    <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>    <span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>    <span class="kn">from</span> <span class="nn">dateutil.relativedelta</span> <span class="kn">import</span> <span class="n">relativedelta</span>
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a>
<a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a>    <span class="c1"># Allow imports from src folder</span>
<a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a>    <span class="n">module_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;src&#39;</span><span class="p">))</span>
<a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a>    <span class="k">if</span> <span class="n">module_path</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
<a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a>        <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">module_path</span><span class="p">)</span>
<a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a>
<a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a>    <span class="kn">import</span> <span class="nn">fasttrack</span> <span class="k">as</span> <span class="nn">ft</span>
<a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a>    <span class="kn">from</span> <span class="nn">dotenv</span> <span class="kn">import</span> <span class="n">load_dotenv</span>
<a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a>    <span class="n">load_dotenv</span><span class="p">()</span>
<a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a>
<a id="__codelineno-1-16" name="__codelineno-1-16" href="#__codelineno-1-16"></a>    <span class="c1"># Validate FastTrack API connection</span>
<a id="__codelineno-1-17" name="__codelineno-1-17" href="#__codelineno-1-17"></a>    <span class="n">api_key</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;FAST_TRACK_API_KEY&#39;</span><span class="p">,)</span>
<a id="__codelineno-1-18" name="__codelineno-1-18" href="#__codelineno-1-18"></a>    <span class="n">client</span> <span class="o">=</span> <span class="n">ft</span><span class="o">.</span><span class="n">Fasttrack</span><span class="p">(</span><span class="n">api_key</span><span class="p">)</span>
<a id="__codelineno-1-19" name="__codelineno-1-19" href="#__codelineno-1-19"></a>    <span class="n">track_codes</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">listTracks</span><span class="p">()</span>
<a id="__codelineno-1-20" name="__codelineno-1-20" href="#__codelineno-1-20"></a>
<a id="__codelineno-1-21" name="__codelineno-1-21" href="#__codelineno-1-21"></a>    <span class="c1"># Import race data excluding NZ races</span>
<a id="__codelineno-1-22" name="__codelineno-1-22" href="#__codelineno-1-22"></a>    <span class="n">au_tracks_filter</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">track_codes</span><span class="p">[</span><span class="n">track_codes</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;NZ&#39;</span><span class="p">][</span><span class="s1">&#39;track_code&#39;</span><span class="p">])</span>
<a id="__codelineno-1-23" name="__codelineno-1-23" href="#__codelineno-1-23"></a>
<a id="__codelineno-1-24" name="__codelineno-1-24" href="#__codelineno-1-24"></a>    <span class="c1"># Time window to import data</span>
<a id="__codelineno-1-25" name="__codelineno-1-25" href="#__codelineno-1-25"></a>    <span class="c1"># First day of the month 46 months back from now</span>
<a id="__codelineno-1-26" name="__codelineno-1-26" href="#__codelineno-1-26"></a>    <span class="n">date_from</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span> <span class="o">-</span> <span class="n">relativedelta</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="mi">46</span><span class="p">))</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">day</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-1-27" name="__codelineno-1-27" href="#__codelineno-1-27"></a>    <span class="c1"># Download historic data up untill yesterday</span>
<a id="__codelineno-1-28" name="__codelineno-1-28" href="#__codelineno-1-28"></a>    <span class="n">date_to</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span> <span class="o">-</span> <span class="n">relativedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-1-29" name="__codelineno-1-29" href="#__codelineno-1-29"></a>
<a id="__codelineno-1-30" name="__codelineno-1-30" href="#__codelineno-1-30"></a><span class="hll">    <span class="c1"># List to populate data with, convert to dataframe after fully populated</span>
</span><a id="__codelineno-1-31" name="__codelineno-1-31" href="#__codelineno-1-31"></a><span class="hll">    <span class="n">race_details</span> <span class="o">=</span> <span class="p">[]</span>
</span><a id="__codelineno-1-32" name="__codelineno-1-32" href="#__codelineno-1-32"></a><span class="hll">    <span class="n">dog_results</span> <span class="o">=</span> <span class="p">[]</span>
</span><a id="__codelineno-1-33" name="__codelineno-1-33" href="#__codelineno-1-33"></a>
<a id="__codelineno-1-34" name="__codelineno-1-34" href="#__codelineno-1-34"></a>    <span class="c1"># Download/load historic (up until yesterday) data</span>
<a id="__codelineno-1-35" name="__codelineno-1-35" href="#__codelineno-1-35"></a>    <span class="c1"># For each day, either fetch data from API or use local CSV file if we already have downloaded it</span>
<a id="__codelineno-1-36" name="__codelineno-1-36" href="#__codelineno-1-36"></a><span class="hll">    <span class="k">for</span> <span class="n">start</span> <span class="ow">in</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">date_from</span><span class="p">,</span> <span class="n">date_to</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">):</span>
</span><a id="__codelineno-1-37" name="__codelineno-1-37" href="#__codelineno-1-37"></a><span class="hll">        <span class="n">start_date</span> <span class="o">=</span> <span class="n">start</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
</span><a id="__codelineno-1-38" name="__codelineno-1-38" href="#__codelineno-1-38"></a><span class="hll">        <span class="n">end_date</span> <span class="o">=</span> <span class="n">start_date</span>
</span><a id="__codelineno-1-39" name="__codelineno-1-39" href="#__codelineno-1-39"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-1-40" name="__codelineno-1-40" href="#__codelineno-1-40"></a>            <span class="n">filename_races</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;FT_AU_RACES_</span><span class="si">{</span><span class="n">start_date</span><span class="si">}</span><span class="s1">.csv&#39;</span>
<a id="__codelineno-1-41" name="__codelineno-1-41" href="#__codelineno-1-41"></a>            <span class="n">filename_dogs</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;FT_AU_DOGS_</span><span class="si">{</span><span class="n">start_date</span><span class="si">}</span><span class="s1">.csv&#39;</span>
<a id="__codelineno-1-42" name="__codelineno-1-42" href="#__codelineno-1-42"></a>
<a id="__codelineno-1-43" name="__codelineno-1-43" href="#__codelineno-1-43"></a>            <span class="n">filepath_races</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;../data/</span><span class="si">{</span><span class="n">filename_races</span><span class="si">}</span><span class="s1">&#39;</span>
<a id="__codelineno-1-44" name="__codelineno-1-44" href="#__codelineno-1-44"></a>            <span class="n">filepath_dogs</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;../data/</span><span class="si">{</span><span class="n">filename_dogs</span><span class="si">}</span><span class="s1">&#39;</span>
<a id="__codelineno-1-45" name="__codelineno-1-45" href="#__codelineno-1-45"></a>
<a id="__codelineno-1-46" name="__codelineno-1-46" href="#__codelineno-1-46"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Loading data from </span><span class="si">{</span><span class="n">start_date</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">end_date</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-1-47" name="__codelineno-1-47" href="#__codelineno-1-47"></a>            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filepath_races</span><span class="p">):</span>
<a id="__codelineno-1-48" name="__codelineno-1-48" href="#__codelineno-1-48"></a>                <span class="c1"># Load local CSV file</span>
<a id="__codelineno-1-49" name="__codelineno-1-49" href="#__codelineno-1-49"></a>                <span class="n">day_race_details</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">filepath_races</span><span class="p">)</span> 
<a id="__codelineno-1-50" name="__codelineno-1-50" href="#__codelineno-1-50"></a>                <span class="n">day_dog_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">filepath_dogs</span><span class="p">)</span> 
<a id="__codelineno-1-51" name="__codelineno-1-51" href="#__codelineno-1-51"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-1-52" name="__codelineno-1-52" href="#__codelineno-1-52"></a>                <span class="c1"># Fetch data from API</span>
<a id="__codelineno-1-53" name="__codelineno-1-53" href="#__codelineno-1-53"></a>                <span class="n">day_race_details</span><span class="p">,</span> <span class="n">day_dog_results</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">getRaceResults</span><span class="p">(</span><span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">,</span> <span class="n">au_tracks_filter</span><span class="p">)</span>
<a id="__codelineno-1-54" name="__codelineno-1-54" href="#__codelineno-1-54"></a>                <span class="n">day_race_details</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">filepath_races</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-1-55" name="__codelineno-1-55" href="#__codelineno-1-55"></a>                <span class="n">day_dog_results</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">filepath_dogs</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-1-56" name="__codelineno-1-56" href="#__codelineno-1-56"></a>
<a id="__codelineno-1-57" name="__codelineno-1-57" href="#__codelineno-1-57"></a>            <span class="c1"># Combine daily data</span>
<a id="__codelineno-1-58" name="__codelineno-1-58" href="#__codelineno-1-58"></a>            <span class="n">race_details</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">day_race_details</span><span class="p">)</span>
<a id="__codelineno-1-59" name="__codelineno-1-59" href="#__codelineno-1-59"></a>            <span class="n">dog_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">day_dog_results</span><span class="p">)</span>
<a id="__codelineno-1-60" name="__codelineno-1-60" href="#__codelineno-1-60"></a>        <span class="k">except</span><span class="p">:</span>
<a id="__codelineno-1-61" name="__codelineno-1-61" href="#__codelineno-1-61"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Could not load data from </span><span class="si">{</span><span class="n">start_date</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">end_date</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</code></pre></div>
<p>Now let's download the live data from the FastTrack API:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>    <span class="c1"># Download todays data from the api</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>    <span class="n">todays_date</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>    <span class="n">todays_race_details</span><span class="p">,</span> <span class="n">todays_dog_results</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">getFullFormat</span><span class="p">(</span><span class="n">todays_date</span><span class="p">)</span>
</code></pre></div>
<p>The live data from the API has a few extra columns that we don't need and a few columns with different names, lets fixed that and combine the live data with historic and save it to a csv. </p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>    <span class="c1"># Make live API data in the same form as historic data</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>    <span class="n">todays_race_details</span> <span class="o">=</span> <span class="n">todays_race_details</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Date&quot;</span><span class="p">:</span><span class="s2">&quot;date&quot;</span><span class="p">})</span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>    <span class="n">todays_dog_results</span> <span class="o">=</span> <span class="n">todays_dog_results</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;RaceBox&quot;</span><span class="p">:</span><span class="s2">&quot;Box&quot;</span><span class="p">})</span>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a>    <span class="c1"># Only keep the columns we have in the historic data</span>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a>    <span class="n">usecols_race_details</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;@id&#39;</span><span class="p">,</span><span class="s1">&#39;RaceNum&#39;</span><span class="p">,</span><span class="s1">&#39;RaceName&#39;</span><span class="p">,</span><span class="s1">&#39;RaceTime&#39;</span><span class="p">,</span><span class="s1">&#39;Distance&#39;</span><span class="p">,</span><span class="s1">&#39;RaceGrade&#39;</span><span class="p">,</span><span class="s1">&#39;Track&#39;</span><span class="p">,</span><span class="s1">&#39;date&#39;</span><span class="p">]</span>
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a>    <span class="n">usecols_dog_results</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;@id&#39;</span><span class="p">,</span><span class="s1">&#39;DogName&#39;</span><span class="p">,</span><span class="s1">&#39;Box&#39;</span><span class="p">,</span><span class="s1">&#39;RaceId&#39;</span><span class="p">,</span><span class="s1">&#39;TrainerId&#39;</span><span class="p">,</span><span class="s1">&#39;TrainerName&#39;</span><span class="p">]</span>
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a>    <span class="c1"># dog_results columns not in live data [&#39;Place&#39;,&#39;Rug&#39;,&#39;Weight&#39;,&#39;StartPrice&#39;,&#39;Handicap&#39;,&#39;Margin1&#39;, &#39;Margin2&#39;,&#39;PIR&#39;,&#39;Checks&#39;,&#39;Comments&#39;,&#39;SplitMargin&#39;, &#39;RunTime&#39;, &#39;Prizemoney&#39;,]</span>
<a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a>    <span class="n">todays_race_details</span> <span class="o">=</span> <span class="n">todays_race_details</span><span class="p">[</span><span class="n">usecols_race_details</span><span class="p">]</span>
<a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a>    <span class="n">todays_dog_results</span> <span class="o">=</span> <span class="n">todays_dog_results</span><span class="p">[</span><span class="n">usecols_dog_results</span><span class="p">]</span>
<a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a>
<a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a>    <span class="c1"># Now that todays data looks similar to our historic data lets add todays data to the rest of our historic data</span>
<a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a>    <span class="n">race_details</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">todays_race_details</span><span class="p">)</span>
<a id="__codelineno-3-13" name="__codelineno-3-13" href="#__codelineno-3-13"></a>    <span class="n">dog_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">todays_dog_results</span><span class="p">)</span>
<a id="__codelineno-3-14" name="__codelineno-3-14" href="#__codelineno-3-14"></a>    <span class="c1"># Convert our data into a nice DataFrame</span>
<a id="__codelineno-3-15" name="__codelineno-3-15" href="#__codelineno-3-15"></a>    <span class="n">race_details</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">race_details</span><span class="p">)</span>
<a id="__codelineno-3-16" name="__codelineno-3-16" href="#__codelineno-3-16"></a>    <span class="n">dog_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">dog_results</span><span class="p">)</span>
<a id="__codelineno-3-17" name="__codelineno-3-17" href="#__codelineno-3-17"></a>
<a id="__codelineno-3-18" name="__codelineno-3-18" href="#__codelineno-3-18"></a>    <span class="c1"># Save our data to csv files</span>
<a id="__codelineno-3-19" name="__codelineno-3-19" href="#__codelineno-3-19"></a>    <span class="n">race_details</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;../data/race_details.csv&#39;</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-3-20" name="__codelineno-3-20" href="#__codelineno-3-20"></a>    <span class="n">dog_results</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;../data/dog_results.csv&#39;</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-3-21" name="__codelineno-3-21" href="#__codelineno-3-21"></a>    <span class="c1"># Ready for data cleaning and feature creation</span>
</code></pre></div>
<p>That's all the code for part 1 (how easy was that!), we are ready to create our features now.</p>
<hr />
<h2 id="data-cleaning-and-feature-creation">Data cleaning and feature creation</h2>
<p>The second script gets everything ready to be fed into Flumine. So we will read in the data we downloaded in the first script, clean the data, create our features and set our DataFrame to be easily referenced like in <a href="../How_to_Automate_3">How to Automate III</a>.</p>
<p>We need to clean our data in the same way that we did when training our model. The great thing is it means we can copy and paste most of our code from Bruno's tutorial. Initially, all the code is the same, except we are going to add one extra line of code, highlighted at the bottom to save our box win percentages to a csv file. </p>
<p>The reason is we can't reliably determine the Box number from FastTrack data when there are  reserve dogs. E.g. some reserve dogs will have RaceBox/Box 9 or 10 and if there is a scratching they may start from Box 1/2/3..8 etc. Therefore we can't merge box win percentages to our DataFrame until we start hitting the API in the third script.</p>
<div class="highlight"><span class="filename">Data cleaning</span><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>    <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>    <span class="c1"># settings to display all columns</span>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a>    <span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s2">&quot;display.max_columns&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a>    <span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">MinMaxScaler</span>
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a>    <span class="kn">import</span> <span class="nn">itertools</span>
<a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a>
<a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a>    <span class="n">race_details</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;../data/race_details.csv&#39;</span><span class="p">)</span>
<a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a>    <span class="n">dog_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;../data/dog_results.csv&#39;</span><span class="p">)</span>
<a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a>
<a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a>    <span class="c1">## Cleanse and normalise the data</span>
<a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a>    <span class="c1"># Clean up the race dataset</span>
<a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a>    <span class="n">race_details</span> <span class="o">=</span> <span class="n">race_details</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;@id&#39;</span><span class="p">:</span> <span class="s1">&#39;FastTrack_RaceId&#39;</span><span class="p">})</span>
<a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a>    <span class="n">race_details</span><span class="p">[</span><span class="s1">&#39;Distance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">race_details</span><span class="p">[</span><span class="s1">&#39;Distance&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;m&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)))</span>
<a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a>    <span class="n">race_details</span><span class="p">[</span><span class="s1">&#39;date_dt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">race_details</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">],</span> <span class="nb">format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> %b %y&#39;</span><span class="p">)</span>
<a id="__codelineno-4-16" name="__codelineno-4-16" href="#__codelineno-4-16"></a>    <span class="c1"># Clean up the dogs results dataset</span>
<a id="__codelineno-4-17" name="__codelineno-4-17" href="#__codelineno-4-17"></a>    <span class="n">dog_results</span> <span class="o">=</span> <span class="n">dog_results</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;@id&#39;</span><span class="p">:</span> <span class="s1">&#39;FastTrack_DogId&#39;</span><span class="p">,</span> <span class="s1">&#39;RaceId&#39;</span><span class="p">:</span> <span class="s1">&#39;FastTrack_RaceId&#39;</span><span class="p">})</span>
<a id="__codelineno-4-18" name="__codelineno-4-18" href="#__codelineno-4-18"></a>
<a id="__codelineno-4-19" name="__codelineno-4-19" href="#__codelineno-4-19"></a>    <span class="c1"># Combine dogs results with race attributes</span>
<a id="__codelineno-4-20" name="__codelineno-4-20" href="#__codelineno-4-20"></a>    <span class="n">dog_results</span> <span class="o">=</span> <span class="n">dog_results</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
<a id="__codelineno-4-21" name="__codelineno-4-21" href="#__codelineno-4-21"></a>        <span class="n">race_details</span><span class="p">,</span> 
<a id="__codelineno-4-22" name="__codelineno-4-22" href="#__codelineno-4-22"></a>        <span class="n">how</span> <span class="o">=</span> <span class="s1">&#39;left&#39;</span><span class="p">,</span>
<a id="__codelineno-4-23" name="__codelineno-4-23" href="#__codelineno-4-23"></a>        <span class="n">on</span> <span class="o">=</span> <span class="s1">&#39;FastTrack_RaceId&#39;</span>
<a id="__codelineno-4-24" name="__codelineno-4-24" href="#__codelineno-4-24"></a>    <span class="p">)</span>
<a id="__codelineno-4-25" name="__codelineno-4-25" href="#__codelineno-4-25"></a>
<a id="__codelineno-4-26" name="__codelineno-4-26" href="#__codelineno-4-26"></a>    <span class="c1"># Convert StartPrice to probability</span>
<a id="__codelineno-4-27" name="__codelineno-4-27" href="#__codelineno-4-27"></a>    <span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;StartPrice&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;StartPrice&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;$&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;F&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">x</span><span class="p">)</span>
<a id="__codelineno-4-28" name="__codelineno-4-28" href="#__codelineno-4-28"></a>    <span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;StartPrice_probability&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;StartPrice&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-4-29" name="__codelineno-4-29" href="#__codelineno-4-29"></a>    <span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;StartPrice_probability&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dog_results</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;FastTrack_RaceId&#39;</span><span class="p">)[</span><span class="s1">&#39;StartPrice_probability&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
<a id="__codelineno-4-30" name="__codelineno-4-30" href="#__codelineno-4-30"></a>
<a id="__codelineno-4-31" name="__codelineno-4-31" href="#__codelineno-4-31"></a>    <span class="c1"># Discard entries without results (scratched or did not finish)</span>
<a id="__codelineno-4-32" name="__codelineno-4-32" href="#__codelineno-4-32"></a>    <span class="n">dog_results</span> <span class="o">=</span> <span class="n">dog_results</span><span class="p">[</span><span class="o">~</span><span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;Box&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span>
<a id="__codelineno-4-33" name="__codelineno-4-33" href="#__codelineno-4-33"></a>    <span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;Box&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;Box&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<a id="__codelineno-4-34" name="__codelineno-4-34" href="#__codelineno-4-34"></a>
<a id="__codelineno-4-35" name="__codelineno-4-35" href="#__codelineno-4-35"></a>    <span class="c1"># Clean up other attributes</span>
<a id="__codelineno-4-36" name="__codelineno-4-36" href="#__codelineno-4-36"></a>    <span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;RunTime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;RunTime&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
<a id="__codelineno-4-37" name="__codelineno-4-37" href="#__codelineno-4-37"></a>    <span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;SplitMargin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;SplitMargin&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
<a id="__codelineno-4-38" name="__codelineno-4-38" href="#__codelineno-4-38"></a>    <span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;Prizemoney&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;Prizemoney&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-4-39" name="__codelineno-4-39" href="#__codelineno-4-39"></a>    <span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;Place&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;Place&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span><span class="p">),</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;coerce&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-4-40" name="__codelineno-4-40" href="#__codelineno-4-40"></a>    <span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;win&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;Place&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-4-41" name="__codelineno-4-41" href="#__codelineno-4-41"></a>
<a id="__codelineno-4-42" name="__codelineno-4-42" href="#__codelineno-4-42"></a>    <span class="c1"># Normalise some of the raw values</span>
<a id="__codelineno-4-43" name="__codelineno-4-43" href="#__codelineno-4-43"></a>    <span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;Prizemoney_norm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;Prizemoney&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">12</span>
<a id="__codelineno-4-44" name="__codelineno-4-44" href="#__codelineno-4-44"></a>    <span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;Place_inv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;Place&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-4-45" name="__codelineno-4-45" href="#__codelineno-4-45"></a>    <span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;Place_log&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;Place&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-4-46" name="__codelineno-4-46" href="#__codelineno-4-46"></a>    <span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;RunSpeed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;RunTime&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;Distance&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-4-47" name="__codelineno-4-47" href="#__codelineno-4-47"></a>
<a id="__codelineno-4-48" name="__codelineno-4-48" href="#__codelineno-4-48"></a>    <span class="c1">## Generate features using raw data</span>
<a id="__codelineno-4-49" name="__codelineno-4-49" href="#__codelineno-4-49"></a>    <span class="c1"># Calculate median winner time per track/distance</span>
<a id="__codelineno-4-50" name="__codelineno-4-50" href="#__codelineno-4-50"></a>    <span class="n">win_results</span> <span class="o">=</span> <span class="n">dog_results</span><span class="p">[</span><span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;win&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-4-51" name="__codelineno-4-51" href="#__codelineno-4-51"></a>    <span class="n">median_win_time</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">win_results</span><span class="p">[</span><span class="n">win_results</span><span class="p">[</span><span class="s1">&#39;RunTime&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;Track&#39;</span><span class="p">,</span> <span class="s1">&#39;Distance&#39;</span><span class="p">])[</span><span class="s1">&#39;RunTime&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">())</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;RunTime&quot;</span><span class="p">:</span> <span class="s2">&quot;RunTime_median&quot;</span><span class="p">})</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<a id="__codelineno-4-52" name="__codelineno-4-52" href="#__codelineno-4-52"></a>    <span class="n">median_win_split_time</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">win_results</span><span class="p">[</span><span class="n">win_results</span><span class="p">[</span><span class="s1">&#39;SplitMargin&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;Track&#39;</span><span class="p">,</span> <span class="s1">&#39;Distance&#39;</span><span class="p">])[</span><span class="s1">&#39;SplitMargin&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">())</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;SplitMargin&quot;</span><span class="p">:</span> <span class="s2">&quot;SplitMargin_median&quot;</span><span class="p">})</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<a id="__codelineno-4-53" name="__codelineno-4-53" href="#__codelineno-4-53"></a>    <span class="n">median_win_time</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
<a id="__codelineno-4-54" name="__codelineno-4-54" href="#__codelineno-4-54"></a>
<a id="__codelineno-4-55" name="__codelineno-4-55" href="#__codelineno-4-55"></a>    <span class="c1"># Calculate track speed index</span>
<a id="__codelineno-4-56" name="__codelineno-4-56" href="#__codelineno-4-56"></a>    <span class="n">median_win_time</span><span class="p">[</span><span class="s1">&#39;speed_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">median_win_time</span><span class="p">[</span><span class="s1">&#39;RunTime_median&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">median_win_time</span><span class="p">[</span><span class="s1">&#39;Distance&#39;</span><span class="p">])</span>
<a id="__codelineno-4-57" name="__codelineno-4-57" href="#__codelineno-4-57"></a>    <span class="n">median_win_time</span><span class="p">[</span><span class="s1">&#39;speed_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">MinMaxScaler</span><span class="p">()</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">median_win_time</span><span class="p">[[</span><span class="s1">&#39;speed_index&#39;</span><span class="p">]])</span>
<a id="__codelineno-4-58" name="__codelineno-4-58" href="#__codelineno-4-58"></a>    <span class="n">median_win_time</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
<a id="__codelineno-4-59" name="__codelineno-4-59" href="#__codelineno-4-59"></a>
<a id="__codelineno-4-60" name="__codelineno-4-60" href="#__codelineno-4-60"></a>    <span class="c1"># Compare dogs finish time with median winner time</span>
<a id="__codelineno-4-61" name="__codelineno-4-61" href="#__codelineno-4-61"></a>    <span class="n">dog_results</span> <span class="o">=</span> <span class="n">dog_results</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">median_win_time</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Track&#39;</span><span class="p">,</span> <span class="s1">&#39;Distance&#39;</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
<a id="__codelineno-4-62" name="__codelineno-4-62" href="#__codelineno-4-62"></a>    <span class="n">dog_results</span> <span class="o">=</span> <span class="n">dog_results</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">median_win_split_time</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Track&#39;</span><span class="p">,</span> <span class="s1">&#39;Distance&#39;</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
<a id="__codelineno-4-63" name="__codelineno-4-63" href="#__codelineno-4-63"></a>
<a id="__codelineno-4-64" name="__codelineno-4-64" href="#__codelineno-4-64"></a>    <span class="c1"># Normalise time comparison</span>
<a id="__codelineno-4-65" name="__codelineno-4-65" href="#__codelineno-4-65"></a>    <span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;RunTime_norm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;RunTime_median&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;RunTime&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">)</span>
<a id="__codelineno-4-66" name="__codelineno-4-66" href="#__codelineno-4-66"></a>    <span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;RunTime_norm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">MinMaxScaler</span><span class="p">()</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">dog_results</span><span class="p">[[</span><span class="s1">&#39;RunTime_norm&#39;</span><span class="p">]])</span>
<a id="__codelineno-4-67" name="__codelineno-4-67" href="#__codelineno-4-67"></a>    <span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;SplitMargin_norm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;SplitMargin_median&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;SplitMargin&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">)</span>
<a id="__codelineno-4-68" name="__codelineno-4-68" href="#__codelineno-4-68"></a>    <span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;SplitMargin_norm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">MinMaxScaler</span><span class="p">()</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">dog_results</span><span class="p">[[</span><span class="s1">&#39;SplitMargin_norm&#39;</span><span class="p">]])</span>
<a id="__codelineno-4-69" name="__codelineno-4-69" href="#__codelineno-4-69"></a>    <span class="n">dog_results</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
<a id="__codelineno-4-70" name="__codelineno-4-70" href="#__codelineno-4-70"></a>
<a id="__codelineno-4-71" name="__codelineno-4-71" href="#__codelineno-4-71"></a>    <span class="c1"># Calculate box winning percentage for each track/distance</span>
<a id="__codelineno-4-72" name="__codelineno-4-72" href="#__codelineno-4-72"></a>    <span class="n">box_win_percent</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">dog_results</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;Track&#39;</span><span class="p">,</span> <span class="s1">&#39;Distance&#39;</span><span class="p">,</span> <span class="s1">&#39;Box&#39;</span><span class="p">])[</span><span class="s1">&#39;win&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;win&quot;</span><span class="p">:</span> <span class="s2">&quot;box_win_percent&quot;</span><span class="p">})</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<a id="__codelineno-4-73" name="__codelineno-4-73" href="#__codelineno-4-73"></a>    <span class="c1"># Add to dog results dataframe</span>
<a id="__codelineno-4-74" name="__codelineno-4-74" href="#__codelineno-4-74"></a>    <span class="n">dog_results</span> <span class="o">=</span> <span class="n">dog_results</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">box_win_percent</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Track&#39;</span><span class="p">,</span> <span class="s1">&#39;Distance&#39;</span><span class="p">,</span> <span class="s1">&#39;Box&#39;</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
<a id="__codelineno-4-75" name="__codelineno-4-75" href="#__codelineno-4-75"></a>    <span class="c1"># Display example of barrier winning probabilities</span>
<a id="__codelineno-4-76" name="__codelineno-4-76" href="#__codelineno-4-76"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">box_win_percent</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>
<a id="__codelineno-4-77" name="__codelineno-4-77" href="#__codelineno-4-77"></a><span class="hll">    <span class="n">box_win_percent</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;../data/box_win_percentage.csv&#39;</span><span class="p">)</span>
</span></code></pre></div>
<p>As a single greyhound can be a reserve dog for multiple races on the same day this creates a second issue for us. FastTrack will list each race a greyhound is a reserve in as a new row. For example, 'MACI REID' is a reserve dog for three different races on the 2022-09-02:</p>
<p><img alt="reserve_dogs_example" src="../hta_img/reserve_dogs_example.png" /></p>
<p>When we try lag our data by using <code>.shift(1)</code> like in Bruno's original code it will produce the wrong values for our features. In the above example only the first race The Gardens Race 4 (the third row) will have correct data but all the rows under it will have incorrectly calculated features. We need each of the following rows to be the same as the third row. The solution that I have come up with is a little bit complicated, but it gets the job done:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="1:3"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio" /><input id="__tabbed_1_2" name="__tabbed_1" type="radio" /><input id="__tabbed_1_3" name="__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="__tabbed_1_1">Solution to reserve dogs</label><label for="__tabbed_1_2">Optimised code</label><label for="__tabbed_1_3">Complete code chunk</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a>    <span class="c1"># Please submit a pull request if you have a better solution</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>    <span class="n">temp</span> <span class="o">=</span> <span class="n">rolling_result</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>    <span class="n">temp</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="n">temp</span><span class="p">[</span><span class="s1">&#39;date_dt&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">normalize</span><span class="p">()]</span>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a>    <span class="n">temp</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;FastTrack_DogId&#39;</span><span class="p">,</span><span class="s1">&#39;date_dt&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a>    <span class="n">rolling_result</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">IndexSlice</span><span class="p">[:,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">normalize</span><span class="p">()],</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;FastTrack_DogId&#39;</span><span class="p">,</span><span class="s1">&#39;date_dt&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>Because my laptop is old and slow lets also make the code a little bit more efficient</p>
<div class="highlight"><span class="filename">Old inefficient code</span><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a>    <span class="c1"># Add features to dataset</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>    <span class="n">dataset</span><span class="p">[</span><span class="n">agg_features_cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">rolling_result</span>
</code></pre></div>
<div class="highlight"><span class="filename">Optimised code</span><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a>    <span class="c1"># More efficient method to add features to dataset</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>    <span class="n">rolling_result</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">agg_features_cols</span>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>    <span class="n">dataset</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">dataset</span><span class="p">,</span><span class="n">rolling_result</span><span class="p">],</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>So now our feature creation code looks like this:</p>
<div class="highlight"><span class="filename">Code changes highlighted</span><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a>    <span class="c1"># Generate rolling window features</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>    <span class="n">dataset</span> <span class="o">=</span> <span class="n">dog_results</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>    <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;FastTrack_DogId&#39;</span><span class="p">,</span> <span class="s1">&#39;date_dt&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a>
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a>    <span class="c1"># Use rolling window of 28, 91 and 365 days</span>
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a>    <span class="n">rolling_windows</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;28D&#39;</span><span class="p">,</span> <span class="s1">&#39;91D&#39;</span><span class="p">,</span> <span class="s1">&#39;365D&#39;</span><span class="p">]</span>
<a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a>    <span class="c1"># Features to use for rolling windows calculation</span>
<a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a>    <span class="n">features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;RunTime_norm&#39;</span><span class="p">,</span> <span class="s1">&#39;SplitMargin_norm&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_inv&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_log&#39;</span><span class="p">,</span> <span class="s1">&#39;Prizemoney_norm&#39;</span><span class="p">]</span>
<a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a>    <span class="c1"># Aggregation functions to apply</span>
<a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a>    <span class="n">aggregates</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;median&#39;</span><span class="p">,</span> <span class="s1">&#39;std&#39;</span><span class="p">]</span>
<a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a>    <span class="c1"># Keep track of generated feature names</span>
<a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a>    <span class="n">feature_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;speed_index&#39;</span><span class="p">,</span> <span class="s1">&#39;box_win_percent&#39;</span><span class="p">]</span>
<a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a>
<a id="__codelineno-8-14" name="__codelineno-8-14" href="#__codelineno-8-14"></a>    <span class="k">for</span> <span class="n">rolling_window</span> <span class="ow">in</span> <span class="n">rolling_windows</span><span class="p">:</span>
<a id="__codelineno-8-15" name="__codelineno-8-15" href="#__codelineno-8-15"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Processing rolling window </span><span class="si">{</span><span class="n">rolling_window</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-8-16" name="__codelineno-8-16" href="#__codelineno-8-16"></a>
<a id="__codelineno-8-17" name="__codelineno-8-17" href="#__codelineno-8-17"></a>            <span class="n">rolling_result</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-8-18" name="__codelineno-8-18" href="#__codelineno-8-18"></a>                <span class="n">dataset</span>
<a id="__codelineno-8-19" name="__codelineno-8-19" href="#__codelineno-8-19"></a>                <span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
<a id="__codelineno-8-20" name="__codelineno-8-20" href="#__codelineno-8-20"></a>                <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;FastTrack_DogId&#39;</span><span class="p">)[</span><span class="n">features</span><span class="p">]</span>
<a id="__codelineno-8-21" name="__codelineno-8-21" href="#__codelineno-8-21"></a>                <span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">rolling_window</span><span class="p">)</span>
<a id="__codelineno-8-22" name="__codelineno-8-22" href="#__codelineno-8-22"></a>                <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">aggregates</span><span class="p">)</span>
<a id="__codelineno-8-23" name="__codelineno-8-23" href="#__codelineno-8-23"></a>                <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># Thanks to Brett for finding this!</span>
<a id="__codelineno-8-24" name="__codelineno-8-24" href="#__codelineno-8-24"></a>                <span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-8-25" name="__codelineno-8-25" href="#__codelineno-8-25"></a>            <span class="p">)</span>
<a id="__codelineno-8-26" name="__codelineno-8-26" href="#__codelineno-8-26"></a>
<a id="__codelineno-8-27" name="__codelineno-8-27" href="#__codelineno-8-27"></a><span class="hll">            <span class="c1"># My own dodgey code to work with reserve dogs</span>
</span><a id="__codelineno-8-28" name="__codelineno-8-28" href="#__codelineno-8-28"></a><span class="hll">            <span class="n">temp</span> <span class="o">=</span> <span class="n">rolling_result</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
</span><a id="__codelineno-8-29" name="__codelineno-8-29" href="#__codelineno-8-29"></a><span class="hll">            <span class="n">temp</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="n">temp</span><span class="p">[</span><span class="s1">&#39;date_dt&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">normalize</span><span class="p">()]</span>
</span><a id="__codelineno-8-30" name="__codelineno-8-30" href="#__codelineno-8-30"></a><span class="hll">            <span class="n">temp</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><a id="__codelineno-8-31" name="__codelineno-8-31" href="#__codelineno-8-31"></a><span class="hll">            <span class="n">rolling_result</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">IndexSlice</span><span class="p">[:,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">normalize</span><span class="p">()],</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;FastTrack_DogId&#39;</span><span class="p">,</span><span class="s1">&#39;date_dt&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span><a id="__codelineno-8-32" name="__codelineno-8-32" href="#__codelineno-8-32"></a>
<a id="__codelineno-8-33" name="__codelineno-8-33" href="#__codelineno-8-33"></a>            <span class="c1"># Generate list of rolling window feature names (eg: RunTime_norm_min_365D)</span>
<a id="__codelineno-8-34" name="__codelineno-8-34" href="#__codelineno-8-34"></a>            <span class="n">agg_features_cols</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">a</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">rolling_window</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">f</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">aggregates</span><span class="p">)]</span>
<a id="__codelineno-8-35" name="__codelineno-8-35" href="#__codelineno-8-35"></a>
<a id="__codelineno-8-36" name="__codelineno-8-36" href="#__codelineno-8-36"></a><span class="hll">            <span class="c1"># More efficient method to add features to dataset</span>
</span><a id="__codelineno-8-37" name="__codelineno-8-37" href="#__codelineno-8-37"></a><span class="hll">            <span class="n">rolling_result</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">agg_features_cols</span>
</span><a id="__codelineno-8-38" name="__codelineno-8-38" href="#__codelineno-8-38"></a><span class="hll">            <span class="n">dataset</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">dataset</span><span class="p">,</span><span class="n">rolling_result</span><span class="p">],</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
</span><a id="__codelineno-8-39" name="__codelineno-8-39" href="#__codelineno-8-39"></a>
<a id="__codelineno-8-40" name="__codelineno-8-40" href="#__codelineno-8-40"></a>            <span class="c1"># Keep track of generated feature names</span>
<a id="__codelineno-8-41" name="__codelineno-8-41" href="#__codelineno-8-41"></a>            <span class="n">feature_cols</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">agg_features_cols</span><span class="p">)</span>
<a id="__codelineno-8-42" name="__codelineno-8-42" href="#__codelineno-8-42"></a>
<a id="__codelineno-8-43" name="__codelineno-8-43" href="#__codelineno-8-43"></a>    <span class="c1"># print(feature_cols) </span>
<a id="__codelineno-8-44" name="__codelineno-8-44" href="#__codelineno-8-44"></a>    <span class="c1"># feature_cols = [&#39;speed_index&#39;, &#39;box_win_percent&#39;, &#39;RunTime_norm_min_28D&#39;, &#39;RunTime_norm_max_28D&#39;, &#39;RunTime_norm_mean_28D&#39;, &#39;RunTime_norm_median_28D&#39;, &#39;RunTime_norm_std_28D&#39;, &#39;SplitMargin_norm_min_28D&#39;, &#39;SplitMargin_norm_max_28D&#39;, &#39;SplitMargin_norm_mean_28D&#39;, &#39;SplitMargin_norm_median_28D&#39;, &#39;SplitMargin_norm_std_28D&#39;, &#39;Place_inv_min_28D&#39;, &#39;Place_inv_max_28D&#39;, &#39;Place_inv_mean_28D&#39;, &#39;Place_inv_median_28D&#39;, &#39;Place_inv_std_28D&#39;, &#39;Place_log_min_28D&#39;, &#39;Place_log_max_28D&#39;, &#39;Place_log_mean_28D&#39;, &#39;Place_log_median_28D&#39;, &#39;Place_log_std_28D&#39;, &#39;Prizemoney_norm_min_28D&#39;, &#39;Prizemoney_norm_max_28D&#39;, &#39;Prizemoney_norm_mean_28D&#39;, &#39;Prizemoney_norm_median_28D&#39;, &#39;Prizemoney_norm_std_28D&#39;, &#39;RunTime_norm_min_91D&#39;, &#39;RunTime_norm_max_91D&#39;, &#39;RunTime_norm_mean_91D&#39;, &#39;RunTime_norm_median_91D&#39;, &#39;RunTime_norm_std_91D&#39;, &#39;SplitMargin_norm_min_91D&#39;, &#39;SplitMargin_norm_max_91D&#39;, &#39;SplitMargin_norm_mean_91D&#39;, &#39;SplitMargin_norm_median_91D&#39;, &#39;SplitMargin_norm_std_91D&#39;, &#39;Place_inv_min_91D&#39;, &#39;Place_inv_max_91D&#39;, &#39;Place_inv_mean_91D&#39;, &#39;Place_inv_median_91D&#39;, &#39;Place_inv_std_91D&#39;, &#39;Place_log_min_91D&#39;, &#39;Place_log_max_91D&#39;, &#39;Place_log_mean_91D&#39;, &#39;Place_log_median_91D&#39;, &#39;Place_log_std_91D&#39;, &#39;Prizemoney_norm_min_91D&#39;, &#39;Prizemoney_norm_max_91D&#39;, &#39;Prizemoney_norm_mean_91D&#39;, &#39;Prizemoney_norm_median_91D&#39;, &#39;Prizemoney_norm_std_91D&#39;, &#39;RunTime_norm_min_365D&#39;, &#39;RunTime_norm_max_365D&#39;, &#39;RunTime_norm_mean_365D&#39;, &#39;RunTime_norm_median_365D&#39;, &#39;RunTime_norm_std_365D&#39;, &#39;SplitMargin_norm_min_365D&#39;, &#39;SplitMargin_norm_max_365D&#39;, &#39;SplitMargin_norm_mean_365D&#39;, &#39;SplitMargin_norm_median_365D&#39;, &#39;SplitMargin_norm_std_365D&#39;, &#39;Place_inv_min_365D&#39;, &#39;Place_inv_max_365D&#39;, &#39;Place_inv_mean_365D&#39;, &#39;Place_inv_median_365D&#39;, &#39;Place_inv_std_365D&#39;, &#39;Place_log_min_365D&#39;, &#39;Place_log_max_365D&#39;, &#39;Place_log_mean_365D&#39;, &#39;Place_log_median_365D&#39;, &#39;Place_log_std_365D&#39;, &#39;Prizemoney_norm_min_365D&#39;, &#39;Prizemoney_norm_max_365D&#39;, &#39;Prizemoney_norm_mean_365D&#39;, &#39;Prizemoney_norm_median_365D&#39;, &#39;Prizemoney_norm_std_365D&#39;]</span>
</code></pre></div>
</div>
</div>
</div>
<p>Following Bruno's code, we have a few lines of cleaning left that we can just copy and paste over. But afterwards we also need to do some minor formatting changes to the FastTrack names so we can match them onto the Betfair names. Betfair excludes all apostrophes and full stops in their naming convention, so we'll create a Betfair equivalent dog name on the dataset removing these characters. We also need to do this for the tracks, sometimes FastTrack will name tracks differently to Betfair e.g., Sandown Park from Betfair is known as Sandown (SAP) in the FastTrack database. I've also included a line in there to save the dataframe <code>model_df</code>, so we can use it to generate historical predictions in our fourth script.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a>    <span class="c1"># Replace missing values with 0</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>    <span class="n">dataset</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a>
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a>    <span class="c1"># Only keep data after 2018-12-01</span>
<a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a>    <span class="n">model_df</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a>    <span class="n">feature_cols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">feature_cols</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a>    <span class="n">model_df</span> <span class="o">=</span> <span class="n">model_df</span><span class="p">[</span><span class="n">model_df</span><span class="p">[</span><span class="s1">&#39;date_dt&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s1">&#39;2018-12-01&#39;</span><span class="p">]</span>
<a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a>
<a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a>    <span class="c1"># This line was originally part of Bruno&#39;s tutorial, but we don&#39;t run it in this script</span>
<a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a>    <span class="c1"># model_df = model_df[[&#39;date_dt&#39;, &#39;FastTrack_RaceId&#39;, &#39;DogName&#39;, &#39;win&#39;, &#39;StartPrice_probability&#39;] + feature_cols]</span>
<a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a>
<a id="__codelineno-9-13" name="__codelineno-9-13" href="#__codelineno-9-13"></a>    <span class="c1"># Only train model off of races where each dog has a value for each feature</span>
<a id="__codelineno-9-14" name="__codelineno-9-14" href="#__codelineno-9-14"></a>    <span class="n">races_exclude</span> <span class="o">=</span> <span class="n">model_df</span><span class="p">[</span><span class="n">model_df</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)][</span><span class="s1">&#39;FastTrack_RaceId&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
<a id="__codelineno-9-15" name="__codelineno-9-15" href="#__codelineno-9-15"></a>    <span class="n">model_df</span> <span class="o">=</span> <span class="n">model_df</span><span class="p">[</span><span class="o">~</span><span class="n">model_df</span><span class="p">[</span><span class="s1">&#39;FastTrack_RaceId&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">races_exclude</span><span class="p">)]</span>
<a id="__codelineno-9-16" name="__codelineno-9-16" href="#__codelineno-9-16"></a>    <span class="n">model_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;../data/model_df.csv&#39;</span><span class="p">)</span>  <span class="c1"># Save data for part_4</span>
<a id="__codelineno-9-17" name="__codelineno-9-17" href="#__codelineno-9-17"></a>
<a id="__codelineno-9-18" name="__codelineno-9-18" href="#__codelineno-9-18"></a>    <span class="c1"># Select todays data and prepare data for easy reference in flumine</span>
<a id="__codelineno-9-19" name="__codelineno-9-19" href="#__codelineno-9-19"></a>    <span class="n">todays_data</span> <span class="o">=</span> <span class="n">model_df</span><span class="p">[</span><span class="n">model_df</span><span class="p">[</span><span class="s1">&#39;date_dt&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)]</span>
<a id="__codelineno-9-20" name="__codelineno-9-20" href="#__codelineno-9-20"></a>    <span class="n">todays_data</span><span class="p">[</span><span class="s1">&#39;DogName_bf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">todays_data</span><span class="p">[</span><span class="s1">&#39;DogName&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Res&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
<a id="__codelineno-9-21" name="__codelineno-9-21" href="#__codelineno-9-21"></a>    <span class="n">final_data</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;Sandown (SAP)&#39;</span><span class="p">,</span><span class="s1">&#39;Sandown Park&#39;</span><span class="p">,</span><span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-9-22" name="__codelineno-9-22" href="#__codelineno-9-22"></a>    <span class="n">final_data</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;Murray Bridge (MBR)&#39;</span><span class="p">,</span><span class="s1">&#39;Murray Bridge&#39;</span><span class="p">,</span><span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-9-23" name="__codelineno-9-23" href="#__codelineno-9-23"></a>    <span class="n">todays_data</span> <span class="o">=</span> <span class="n">todays_data</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;DogName_bf&#39;</span><span class="p">,</span><span class="s1">&#39;Track&#39;</span><span class="p">,</span><span class="s1">&#39;RaceNum&#39;</span><span class="p">])</span>
<a id="__codelineno-9-24" name="__codelineno-9-24" href="#__codelineno-9-24"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">todays_data</span><span class="p">)</span>
<a id="__codelineno-9-25" name="__codelineno-9-25" href="#__codelineno-9-25"></a>
<a id="__codelineno-9-26" name="__codelineno-9-26" href="#__codelineno-9-26"></a>    <span class="n">todays_data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;../data/todays_data.csv&#39;</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</code></pre></div>
<p>Now we are done with our second script too! We have cleaned all our data and generated all but one of our features (Box) and our data is saved and ready to be fed into Flumine. We are now ready to move onto the third script and start making live predictions and betting. We have even saved some historic data for our fourth script so we can generate historic predictions.</p>
<hr />
<h2 id="automating-our-predictions">Automating our predictions</h2>
<p>Before we can do our model predictions, we have one feature left to collect which is the box number a greyhound is racing from. Then we can do our final prediction, renormalise our probabilities so they sum to unity (100%) and start placing bets. We will also add on our Auto-terminate and bet logging code we learnt from previous tutorials.</p>
<p>If you look closely at the below screenshot, you will notice Rhinestone Ash is number 9. For non-reserve dogs (number one to eight), the number corresponds to the Box number, however reserve dogs will have a number such as 9 or 10 and there are only ever eight boxes. So, if any of the original line up is scratched the reserve dogs will be placed into one of the remaining boxes. FastTrack data won't give us which Box the reserve dog will go into, in fact it will give us Box 9 (which doesn't exist). So, we need some way to find the Box number it is actually racing from. I didn't notice this issue for quite a while, but the good thing is the website gives us the info we need to adjust:</p>
<p><img alt="reserve_dog" src="../hta_img/reserve_dog.png" /></p>
<p>If you click on rules, you can see what Box it is starting from:</p>
<p><img alt="reserve_dog_2" src="../hta_img/reserve_dog_2.png" /></p>
<p>After going through the <a href="https://docs.developer.betfair.com/display/1smk3cen4v3lu3yomq5qye0ni/Betting+Type+Definitions#BettingTypeDefinitions-MarketDescription">documentation</a> again, changes to boxes are available through the API under the <code>clarifications</code> attribute of <code>marketDescription</code>. You will be able to access this within Flumine as <code>market.market_catalogue.description.clarifications</code>, but it's a bit weird. It returns box changes as a string that looks like this:</p>
<p><img alt="box_changes" src="../hta_img/box_changes.png" /></p>
<p>Originally, I had planned to leave this post as it is since, I've never worked with anything like this before and its already getting pretty long, however huge shoutout to <a href="https://github.com/Landrin-br">Brett</a> from the Betfair Quants community who provided his solution to working with box changes.</p>
<div class="highlight"><span class="filename">Brett's Solution</span><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a>    <span class="kn">from</span> <span class="nn">nltk.tokenize</span> <span class="kn">import</span> <span class="n">regexp_tokenize</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>    <span class="c1"># my_string is an example string, that you will need to get live from the api via: market.market_catalogue.description.clarifications.replace(&quot;&lt;br&gt; Dog&quot;,&quot;&lt;br&gt;Dog&quot;)</span>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a>    <span class="n">my_string</span> <span class="o">=</span> <span class="s2">&quot;&lt;br&gt;Box changes:&lt;br&gt;Dog 9. Tralee Blaze starts from box no. 8&lt;br&gt;&lt;br&gt;Dog 6. That Other One starts from box no. 2&lt;br&gt;&lt;br&gt;&quot;</span>
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;HTML Comment: </span><span class="si">{</span><span class="n">my_string</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a>    <span class="n">pattern1</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;(?&lt;=&lt;br&gt;Dog ).+?(?= starts)&#39;</span>
<a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a>    <span class="n">pattern2</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;(?&lt;=\bbox no. )(\w+)&quot;</span>
<a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a>    <span class="n">runners_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="p">(</span><span class="n">regexp_tokenize</span><span class="p">(</span><span class="n">my_string</span><span class="p">,</span> <span class="n">pattern1</span><span class="p">),</span> <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;runner_name&#39;</span><span class="p">])</span>
<a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a>    <span class="n">runners_df</span><span class="p">[</span><span class="s1">&#39;runner_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">runners_df</span><span class="p">[</span><span class="s1">&#39;runner_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
<a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a>    <span class="c1"># Remove dog name from runner_number</span>
<a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a>    <span class="n">runners_df</span><span class="p">[</span><span class="s1">&#39;runner_number&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">runners_df</span><span class="p">[</span><span class="s1">&#39;runner_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[:(</span><span class="n">x</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
<a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a>    <span class="c1"># Remove dog number from runner_name</span>
<a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a>    <span class="n">runners_df</span><span class="p">[</span><span class="s1">&#39;runner_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">runners_df</span><span class="p">[</span><span class="s1">&#39;runner_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[(</span><span class="n">x</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):]</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
<a id="__codelineno-10-13" name="__codelineno-10-13" href="#__codelineno-10-13"></a>    <span class="n">runners_df</span><span class="p">[</span><span class="s1">&#39;Box&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">regexp_tokenize</span><span class="p">(</span><span class="n">my_string</span><span class="p">,</span> <span class="n">pattern2</span><span class="p">)</span>
<a id="__codelineno-10-14" name="__codelineno-10-14" href="#__codelineno-10-14"></a>    <span class="n">runners_df</span>
</code></pre></div>
<p>Running Brett's code will give us a DataFrame like this:</p>
<p><img alt="runners_df" src="../hta_img/runners_df.png" /></p>
<p>So now, if there are no changes in Boxes we can default to the FastTrack data, and if there are changes, we can replace Box in our original DataFrame (<code>todays_data</code>) with the info from <code>runners_df</code> and then we can merge our <code>box_win_percentage</code> feature across.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a>    <span class="c1"># Replace any old Box info in our original dataframe with data available in runners_df</span>
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>    <span class="n">runners_df</span> <span class="o">=</span> <span class="n">runners_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;runner_name&#39;</span><span class="p">)</span>
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a>    <span class="n">todays_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">runners_df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">runners_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">dog_names</span><span class="p">)],</span><span class="n">track</span><span class="p">,</span><span class="n">race_number</span><span class="p">),</span><span class="s1">&#39;Box&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">runners_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">runners_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">dog_names</span><span class="p">),</span><span class="s1">&#39;Box&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a>    <span class="c1"># Merge box_win_percentage back on:</span>
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a>    <span class="n">todays_data</span> <span class="o">=</span> <span class="n">todays_data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="s1">&#39;box_win_percentage&#39;</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a>    <span class="n">todays_data</span> <span class="o">=</span> <span class="n">todays_data</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">box_win_percent</span><span class="p">,</span> <span class="n">on</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Track&#39;</span><span class="p">,</span> <span class="s1">&#39;Distance&#39;</span><span class="p">,</span><span class="s1">&#39;Box&#39;</span><span class="p">],</span> <span class="n">how</span> <span class="o">=</span> <span class="s1">&#39;left&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;DogName_bf&#39;</span><span class="p">,</span><span class="s1">&#39;Track&#39;</span><span class="p">,</span><span class="s1">&#39;RaceNum&#39;</span><span class="p">])</span>
</code></pre></div>
<p>Since we are now editing our todays_data dataframe inside our Flumine strategy we will also need to convert todays_data to a global variable which is a simple one liner:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a>   <span class="k">global</span> <span class="n">todays_data</span>
</code></pre></div>
<p>Now that we have all our features collected, we can predict our probabilities, renormalise and convert them to ratings</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a>    <span class="c1"># Generate probabilities using Bruno&#39;s model</span>
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a>    <span class="n">todays_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">dog_names</span><span class="p">,</span><span class="n">track</span><span class="p">,</span><span class="n">race_number</span><span class="p">),</span><span class="s1">&#39;prob_LogisticRegression&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">brunos_model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">todays_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">dog_names</span><span class="p">,</span><span class="n">track</span><span class="p">,</span><span class="n">race_number</span><span class="p">)][</span><span class="n">feature_cols</span><span class="p">])[:,</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a>    <span class="c1"># renomalise probabilities</span>
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a>    <span class="n">probabilities</span> <span class="o">=</span> <span class="n">todays_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dog_names</span><span class="p">,</span><span class="n">track</span><span class="p">,</span><span class="n">race_number</span><span class="p">][</span><span class="s1">&#39;prob_LogisticRegression&#39;</span><span class="p">]</span>
<a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a>    <span class="n">todays_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">dog_names</span><span class="p">,</span><span class="n">track</span><span class="p">,</span><span class="n">race_number</span><span class="p">),</span><span class="s1">&#39;renormalised_prob&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">probabilities</span><span class="o">/</span><span class="n">probabilities</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a>    <span class="c1"># convert probabilities to ratings</span>
<a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a>    <span class="n">todays_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">dog_names</span><span class="p">,</span><span class="n">track</span><span class="p">,</span><span class="n">race_number</span><span class="p">),</span><span class="s1">&#39;rating&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">todays_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dog_names</span><span class="p">,</span><span class="n">track</span><span class="p">,</span><span class="n">race_number</span><span class="p">][</span><span class="s1">&#39;renormalised_prob&#39;</span><span class="p">]</span>
</code></pre></div>
<p>Now that we have our data nicely set up. We can reference our probabilities by getting the DogName, Track and RaceNum from the Betfair polling API and after that the rest is the same as <a href="https://betfair-datascientists.github.io/tutorials/How_to_Automate_3/">How to Automate III</a>.</p>
<p>I also wanted to call out one gotcha that, Brett found that is almost impossible to find unless you are keeping a close eye on your logs. Sometimes the polling API and streaming API doesn't match up when there are scratchings, so we need to check if it does:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a>    <span class="c1"># Check the polling API and streaming API matches up (sometimes it doesn&#39;t)</span>
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a>    <span class="k">if</span> <span class="n">runner_cata</span><span class="o">.</span><span class="n">selection_id</span> <span class="o">==</span> <span class="n">runner</span><span class="o">.</span><span class="n">selection_id</span><span class="p">:</span>
</code></pre></div>
<p>Okay, so I've just walked through different parts of code that I am introducing, lets bring it all together now.</p>
<p>Import our libraries, logging in and reading in our model and data:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="kn">from</span> <span class="nn">flumine</span> <span class="kn">import</span> <span class="n">Flumine</span><span class="p">,</span> <span class="n">clients</span>
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="kn">from</span> <span class="nn">flumine</span> <span class="kn">import</span> <span class="n">BaseStrategy</span> 
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a><span class="kn">from</span> <span class="nn">flumine.order.trade</span> <span class="kn">import</span> <span class="n">Trade</span>
<a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a><span class="kn">from</span> <span class="nn">flumine.order.order</span> <span class="kn">import</span> <span class="n">LimitOrder</span>
<a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a><span class="kn">from</span> <span class="nn">flumine.markets.market</span> <span class="kn">import</span> <span class="n">Market</span>
<a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a><span class="kn">import</span> <span class="nn">betfairlightweight</span>
<a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a><span class="kn">from</span> <span class="nn">betfairlightweight.filters</span> <span class="kn">import</span> <span class="n">streaming_market_filter</span>
<a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a><span class="kn">from</span> <span class="nn">betfairlightweight.resources</span> <span class="kn">import</span> <span class="n">MarketBook</span>
<a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a><span class="kn">import</span> <span class="nn">re</span>
<a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<a id="__codelineno-15-11" name="__codelineno-15-11" href="#__codelineno-15-11"></a><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<a id="__codelineno-15-12" name="__codelineno-15-12" href="#__codelineno-15-12"></a><span class="kn">import</span> <span class="nn">datetime</span>
<a id="__codelineno-15-13" name="__codelineno-15-13" href="#__codelineno-15-13"></a><span class="kn">import</span> <span class="nn">logging</span>
<a id="__codelineno-15-14" name="__codelineno-15-14" href="#__codelineno-15-14"></a><span class="kn">from</span> <span class="nn">nltk.tokenize</span> <span class="kn">import</span> <span class="n">regexp_tokenize</span>
<a id="__codelineno-15-15" name="__codelineno-15-15" href="#__codelineno-15-15"></a><span class="kn">from</span> <span class="nn">joblib</span> <span class="kn">import</span> <span class="n">load</span>
<a id="__codelineno-15-16" name="__codelineno-15-16" href="#__codelineno-15-16"></a>
<a id="__codelineno-15-17" name="__codelineno-15-17" href="#__codelineno-15-17"></a><span class="c1"># Credentials to login and logging in </span>
<a id="__codelineno-15-18" name="__codelineno-15-18" href="#__codelineno-15-18"></a><span class="n">trading</span> <span class="o">=</span> <span class="n">betfairlightweight</span><span class="o">.</span><span class="n">APIClient</span><span class="p">(</span><span class="s1">&#39;Username&#39;</span><span class="p">,</span><span class="s1">&#39;Password&#39;</span><span class="p">,</span><span class="n">app_key</span><span class="o">=</span><span class="s1">&#39;Appkey&#39;</span><span class="p">)</span>
<a id="__codelineno-15-19" name="__codelineno-15-19" href="#__codelineno-15-19"></a><span class="n">client</span> <span class="o">=</span> <span class="n">clients</span><span class="o">.</span><span class="n">BetfairClient</span><span class="p">(</span><span class="n">trading</span><span class="p">,</span> <span class="n">interactive_login</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-15-20" name="__codelineno-15-20" href="#__codelineno-15-20"></a>
<a id="__codelineno-15-21" name="__codelineno-15-21" href="#__codelineno-15-21"></a><span class="c1"># Login</span>
<a id="__codelineno-15-22" name="__codelineno-15-22" href="#__codelineno-15-22"></a><span class="n">framework</span> <span class="o">=</span> <span class="n">Flumine</span><span class="p">(</span><span class="n">client</span><span class="o">=</span><span class="n">client</span><span class="p">)</span>
<a id="__codelineno-15-23" name="__codelineno-15-23" href="#__codelineno-15-23"></a>
<a id="__codelineno-15-24" name="__codelineno-15-24" href="#__codelineno-15-24"></a><span class="c1"># Code to login when using security certificates</span>
<a id="__codelineno-15-25" name="__codelineno-15-25" href="#__codelineno-15-25"></a><span class="c1"># trading = betfairlightweight.APIClient(&#39;username&#39;,&#39;password&#39;,app_key=&#39;appkey&#39;, certs=r&#39;C:\Users\zhoui\openssl_certs&#39;)</span>
<a id="__codelineno-15-26" name="__codelineno-15-26" href="#__codelineno-15-26"></a><span class="c1"># client = clients.BetfairClient(trading)</span>
<a id="__codelineno-15-27" name="__codelineno-15-27" href="#__codelineno-15-27"></a><span class="c1"># framework = Flumine(client=client)</span>
<a id="__codelineno-15-28" name="__codelineno-15-28" href="#__codelineno-15-28"></a>
<a id="__codelineno-15-29" name="__codelineno-15-29" href="#__codelineno-15-29"></a><span class="c1"># read in model and DataFrames</span>
<a id="__codelineno-15-30" name="__codelineno-15-30" href="#__codelineno-15-30"></a><span class="n">todays_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;D:\FastTrack_data\todays_data.csv&#39;</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;DogName_bf&#39;</span><span class="p">,</span><span class="s1">&#39;Track&#39;</span><span class="p">,</span><span class="s1">&#39;RaceNum&#39;</span><span class="p">])</span>
<a id="__codelineno-15-31" name="__codelineno-15-31" href="#__codelineno-15-31"></a><span class="n">box_win_percentages</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;D:\FastTrack_data\box_win_percentage.csv&#39;</span><span class="p">)</span>
<a id="__codelineno-15-32" name="__codelineno-15-32" href="#__codelineno-15-32"></a><span class="n">brunos_model</span> <span class="o">=</span> <span class="n">load</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;C:\Users\Ivan\Documents\GitHub\How-to-Automate-Public-Version\how_to_automate_IV\logistic_regression.joblib&#39;</span><span class="p">)</span>
<a id="__codelineno-15-33" name="__codelineno-15-33" href="#__codelineno-15-33"></a><span class="n">feature_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;speed_index&#39;</span><span class="p">,</span> <span class="s1">&#39;box_win_percent&#39;</span><span class="p">,</span> <span class="s1">&#39;RunTime_norm_min_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;RunTime_norm_max_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;RunTime_norm_mean_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;RunTime_norm_median_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;RunTime_norm_std_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;SplitMargin_norm_min_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;SplitMargin_norm_max_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;SplitMargin_norm_mean_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;SplitMargin_norm_median_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;SplitMargin_norm_std_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_inv_min_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_inv_max_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_inv_mean_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_inv_median_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_inv_std_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_log_min_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_log_max_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_log_mean_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_log_median_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_log_std_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;Prizemoney_norm_min_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;Prizemoney_norm_max_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;Prizemoney_norm_mean_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;Prizemoney_norm_median_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;Prizemoney_norm_std_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;RunTime_norm_min_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;RunTime_norm_max_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;RunTime_norm_mean_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;RunTime_norm_median_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;RunTime_norm_std_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;SplitMargin_norm_min_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;SplitMargin_norm_max_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;SplitMargin_norm_mean_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;SplitMargin_norm_median_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;SplitMargin_norm_std_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_inv_min_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_inv_max_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_inv_mean_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_inv_median_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_inv_std_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_log_min_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_log_max_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_log_mean_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_log_median_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_log_std_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;Prizemoney_norm_min_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;Prizemoney_norm_max_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;Prizemoney_norm_mean_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;Prizemoney_norm_median_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;Prizemoney_norm_std_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;RunTime_norm_min_365D&#39;</span><span class="p">,</span> <span class="s1">&#39;RunTime_norm_max_365D&#39;</span><span class="p">,</span> <span class="s1">&#39;RunTime_norm_mean_365D&#39;</span><span class="p">,</span> <span class="s1">&#39;RunTime_norm_median_365D&#39;</span><span class="p">,</span> <span class="s1">&#39;RunTime_norm_std_365D&#39;</span><span class="p">,</span> <span class="s1">&#39;SplitMargin_norm_min_365D&#39;</span><span class="p">,</span> <span class="s1">&#39;SplitMargin_norm_max_365D&#39;</span><span class="p">,</span> <span class="s1">&#39;SplitMargin_norm_mean_365D&#39;</span><span class="p">,</span> <span class="s1">&#39;SplitMargin_norm_median_365D&#39;</span><span class="p">,</span> <span class="s1">&#39;SplitMargin_norm_std_365D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_inv_min_365D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_inv_max_365D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_inv_mean_365D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_inv_median_365D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_inv_std_365D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_log_min_365D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_log_max_365D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_log_mean_365D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_log_median_365D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_log_std_365D&#39;</span><span class="p">,</span> <span class="s1">&#39;Prizemoney_norm_min_365D&#39;</span><span class="p">,</span> <span class="s1">&#39;Prizemoney_norm_max_365D&#39;</span><span class="p">,</span> <span class="s1">&#39;Prizemoney_norm_mean_365D&#39;</span><span class="p">,</span> <span class="s1">&#39;Prizemoney_norm_median_365D&#39;</span><span class="p">,</span> <span class="s1">&#39;Prizemoney_norm_std_365D&#39;</span><span class="p">]</span>
<a id="__codelineno-15-34" name="__codelineno-15-34" href="#__codelineno-15-34"></a><span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;how_to_automate_4.log&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1">:</span><span class="si">%(levelname)s</span><span class="s1">:</span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">)</span>
</code></pre></div>
<p>Creating our Flumine Strategy:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a>    <span class="k">class</span> <span class="nc">FlatBetting</span><span class="p">(</span><span class="n">BaseStrategy</span><span class="p">):</span>
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a>        <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;starting strategy &#39;FlatBetting&#39; using the model we created the Greyhound modelling in Python Tutorial&quot;</span><span class="p">)</span>
<a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a>
<a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a>        <span class="k">def</span> <span class="nf">check_market_book</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">market</span><span class="p">:</span> <span class="n">Market</span><span class="p">,</span> <span class="n">market_book</span><span class="p">:</span> <span class="n">MarketBook</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a>            <span class="k">if</span> <span class="n">market_book</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="s2">&quot;CLOSED&quot;</span><span class="p">:</span>
<a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a>                <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a>
<a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a>        <span class="k">def</span> <span class="nf">process_market_book</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">market</span><span class="p">:</span> <span class="n">Market</span><span class="p">,</span> <span class="n">market_book</span><span class="p">:</span> <span class="n">MarketBook</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a>            <span class="c1"># Convert dataframe to a global variable</span>
<a id="__codelineno-16-11" name="__codelineno-16-11" href="#__codelineno-16-11"></a>            <span class="k">global</span> <span class="n">todays_data</span>
<a id="__codelineno-16-12" name="__codelineno-16-12" href="#__codelineno-16-12"></a>
<a id="__codelineno-16-13" name="__codelineno-16-13" href="#__codelineno-16-13"></a>            <span class="c1"># At the 60 second mark:</span>
<a id="__codelineno-16-14" name="__codelineno-16-14" href="#__codelineno-16-14"></a>            <span class="k">if</span> <span class="n">market</span><span class="o">.</span><span class="n">seconds_to_start</span> <span class="o">&lt;</span> <span class="mi">60</span> <span class="ow">and</span> <span class="n">market_book</span><span class="o">.</span><span class="n">inplay</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
<a id="__codelineno-16-15" name="__codelineno-16-15" href="#__codelineno-16-15"></a>                <span class="c1"># get the list of dog_names, name of the track/venue and race_number/RaceNum from Betfair Polling API</span>
<a id="__codelineno-16-16" name="__codelineno-16-16" href="#__codelineno-16-16"></a>                <span class="n">dog_names</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-16-17" name="__codelineno-16-17" href="#__codelineno-16-17"></a>                <span class="n">track</span> <span class="o">=</span> <span class="n">market</span><span class="o">.</span><span class="n">market_catalogue</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">venue</span>
<a id="__codelineno-16-18" name="__codelineno-16-18" href="#__codelineno-16-18"></a>                <span class="n">race_number</span> <span class="o">=</span> <span class="n">market</span><span class="o">.</span><span class="n">market_catalogue</span><span class="o">.</span><span class="n">market_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># comes out as R1/R2/R3 .. etc</span>
<a id="__codelineno-16-19" name="__codelineno-16-19" href="#__codelineno-16-19"></a>                <span class="n">race_number</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;[^0-9]&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">race_number</span><span class="p">)</span>  <span class="c1"># only keep the numbers </span>
<a id="__codelineno-16-20" name="__codelineno-16-20" href="#__codelineno-16-20"></a>                <span class="n">race_number</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">race_number</span><span class="p">)</span>
<a id="__codelineno-16-21" name="__codelineno-16-21" href="#__codelineno-16-21"></a>                <span class="k">for</span> <span class="n">runner_cata</span> <span class="ow">in</span> <span class="n">market</span><span class="o">.</span><span class="n">market_catalogue</span><span class="o">.</span><span class="n">runners</span><span class="p">:</span>
<a id="__codelineno-16-22" name="__codelineno-16-22" href="#__codelineno-16-22"></a>                    <span class="n">dog_name</span> <span class="o">=</span> <span class="n">runner_cata</span><span class="o">.</span><span class="n">runner_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
<a id="__codelineno-16-23" name="__codelineno-16-23" href="#__codelineno-16-23"></a>                    <span class="n">dog_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dog_name</span><span class="p">)</span>
<a id="__codelineno-16-24" name="__codelineno-16-24" href="#__codelineno-16-24"></a>
<a id="__codelineno-16-25" name="__codelineno-16-25" href="#__codelineno-16-25"></a>                <span class="c1"># Check if there are box changes, if there are then use Brett&#39;s code</span>
<a id="__codelineno-16-26" name="__codelineno-16-26" href="#__codelineno-16-26"></a>                <span class="k">if</span> <span class="n">market</span><span class="o">.</span><span class="n">market_catalogue</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">clarifications</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-16-27" name="__codelineno-16-27" href="#__codelineno-16-27"></a>                    <span class="c1"># Brett&#39;s code to get Box changes:</span>
<a id="__codelineno-16-28" name="__codelineno-16-28" href="#__codelineno-16-28"></a>                    <span class="n">my_string</span> <span class="o">=</span> <span class="n">market</span><span class="o">.</span><span class="n">market_catalogue</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">clarifications</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;br&gt; Dog&quot;</span><span class="p">,</span><span class="s2">&quot;&lt;br&gt;Dog&quot;</span><span class="p">)</span>
<a id="__codelineno-16-29" name="__codelineno-16-29" href="#__codelineno-16-29"></a>                    <span class="n">pattern1</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;(?&lt;=&lt;br&gt;Dog ).+?(?= starts)&#39;</span>
<a id="__codelineno-16-30" name="__codelineno-16-30" href="#__codelineno-16-30"></a>                    <span class="n">pattern2</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;(?&lt;=\bbox no. )(\w+)&quot;</span>
<a id="__codelineno-16-31" name="__codelineno-16-31" href="#__codelineno-16-31"></a>                    <span class="n">runners_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="p">(</span><span class="n">regexp_tokenize</span><span class="p">(</span><span class="n">my_string</span><span class="p">,</span> <span class="n">pattern1</span><span class="p">),</span> <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;runner_name&#39;</span><span class="p">])</span>
<a id="__codelineno-16-32" name="__codelineno-16-32" href="#__codelineno-16-32"></a>                    <span class="n">runners_df</span><span class="p">[</span><span class="s1">&#39;runner_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">runners_df</span><span class="p">[</span><span class="s1">&#39;runner_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
<a id="__codelineno-16-33" name="__codelineno-16-33" href="#__codelineno-16-33"></a>                    <span class="c1"># Remove dog name from runner_number</span>
<a id="__codelineno-16-34" name="__codelineno-16-34" href="#__codelineno-16-34"></a>                    <span class="n">runners_df</span><span class="p">[</span><span class="s1">&#39;runner_number&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">runners_df</span><span class="p">[</span><span class="s1">&#39;runner_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[:(</span><span class="n">x</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
<a id="__codelineno-16-35" name="__codelineno-16-35" href="#__codelineno-16-35"></a>                    <span class="c1"># Remove dog number from runner_name</span>
<a id="__codelineno-16-36" name="__codelineno-16-36" href="#__codelineno-16-36"></a>                    <span class="n">runners_df</span><span class="p">[</span><span class="s1">&#39;runner_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">runners_df</span><span class="p">[</span><span class="s1">&#39;runner_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[(</span><span class="n">x</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):]</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
<a id="__codelineno-16-37" name="__codelineno-16-37" href="#__codelineno-16-37"></a>                    <span class="n">runners_df</span><span class="p">[</span><span class="s1">&#39;Box&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">regexp_tokenize</span><span class="p">(</span><span class="n">my_string</span><span class="p">,</span> <span class="n">pattern2</span><span class="p">)</span>
<a id="__codelineno-16-38" name="__codelineno-16-38" href="#__codelineno-16-38"></a>
<a id="__codelineno-16-39" name="__codelineno-16-39" href="#__codelineno-16-39"></a>                    <span class="c1"># Replace any old Box info in our original dataframe with data available in runners_df</span>
<a id="__codelineno-16-40" name="__codelineno-16-40" href="#__codelineno-16-40"></a>                    <span class="n">runners_df</span> <span class="o">=</span> <span class="n">runners_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;runner_name&#39;</span><span class="p">)</span>
<a id="__codelineno-16-41" name="__codelineno-16-41" href="#__codelineno-16-41"></a>                    <span class="n">todays_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">runners_df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">runners_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">dog_names</span><span class="p">)],</span><span class="n">track</span><span class="p">,</span><span class="n">race_number</span><span class="p">),</span><span class="s1">&#39;Box&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">runners_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">runners_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">dog_names</span><span class="p">),</span><span class="s1">&#39;Box&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
<a id="__codelineno-16-42" name="__codelineno-16-42" href="#__codelineno-16-42"></a>                    <span class="c1"># Merge box_win_percentage back on:</span>
<a id="__codelineno-16-43" name="__codelineno-16-43" href="#__codelineno-16-43"></a>                    <span class="n">todays_data</span> <span class="o">=</span> <span class="n">todays_data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="s1">&#39;box_win_percentage&#39;</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-16-44" name="__codelineno-16-44" href="#__codelineno-16-44"></a>                    <span class="n">todays_data</span> <span class="o">=</span> <span class="n">todays_data</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">box_win_percent</span><span class="p">,</span> <span class="n">on</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Track&#39;</span><span class="p">,</span> <span class="s1">&#39;Distance&#39;</span><span class="p">,</span><span class="s1">&#39;Box&#39;</span><span class="p">],</span> <span class="n">how</span> <span class="o">=</span> <span class="s1">&#39;left&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;DogName_bf&#39;</span><span class="p">,</span><span class="s1">&#39;Track&#39;</span><span class="p">,</span><span class="s1">&#39;RaceNum&#39;</span><span class="p">])</span>
<a id="__codelineno-16-45" name="__codelineno-16-45" href="#__codelineno-16-45"></a>
<a id="__codelineno-16-46" name="__codelineno-16-46" href="#__codelineno-16-46"></a>                <span class="c1"># Generate probabilities using Bruno&#39;s model</span>
<a id="__codelineno-16-47" name="__codelineno-16-47" href="#__codelineno-16-47"></a>                <span class="n">todays_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">dog_names</span><span class="p">,</span><span class="n">track</span><span class="p">,</span><span class="n">race_number</span><span class="p">),</span><span class="s1">&#39;prob_LogisticRegression&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">brunos_model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">todays_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">dog_names</span><span class="p">,</span><span class="n">track</span><span class="p">,</span><span class="n">race_number</span><span class="p">)][</span><span class="n">feature_cols</span><span class="p">])[:,</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-16-48" name="__codelineno-16-48" href="#__codelineno-16-48"></a>                <span class="c1"># renomalise probabilities</span>
<a id="__codelineno-16-49" name="__codelineno-16-49" href="#__codelineno-16-49"></a>                <span class="n">probabilities</span> <span class="o">=</span> <span class="n">todays_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dog_names</span><span class="p">,</span><span class="n">track</span><span class="p">,</span><span class="n">race_number</span><span class="p">][</span><span class="s1">&#39;prob_LogisticRegression&#39;</span><span class="p">]</span>
<a id="__codelineno-16-50" name="__codelineno-16-50" href="#__codelineno-16-50"></a>                <span class="n">todays_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">dog_names</span><span class="p">,</span><span class="n">track</span><span class="p">,</span><span class="n">race_number</span><span class="p">),</span><span class="s1">&#39;renormalised_prob&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">probabilities</span><span class="o">/</span><span class="n">probabilities</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<a id="__codelineno-16-51" name="__codelineno-16-51" href="#__codelineno-16-51"></a>                <span class="c1"># convert probaiblities to ratings</span>
<a id="__codelineno-16-52" name="__codelineno-16-52" href="#__codelineno-16-52"></a>                <span class="n">todays_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">dog_names</span><span class="p">,</span><span class="n">track</span><span class="p">,</span><span class="n">race_number</span><span class="p">),</span><span class="s1">&#39;rating&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">todays_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dog_names</span><span class="p">,</span><span class="n">track</span><span class="p">,</span><span class="n">race_number</span><span class="p">][</span><span class="s1">&#39;renormalised_prob&#39;</span><span class="p">]</span>
<a id="__codelineno-16-53" name="__codelineno-16-53" href="#__codelineno-16-53"></a>
<a id="__codelineno-16-54" name="__codelineno-16-54" href="#__codelineno-16-54"></a>                <span class="c1"># Use both the polling api (market.catalogue) and the streaming api at once:</span>
<a id="__codelineno-16-55" name="__codelineno-16-55" href="#__codelineno-16-55"></a>                <span class="k">for</span> <span class="n">runner_cata</span><span class="p">,</span> <span class="n">runner</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">market</span><span class="o">.</span><span class="n">market_catalogue</span><span class="o">.</span><span class="n">runners</span><span class="p">,</span> <span class="n">market_book</span><span class="o">.</span><span class="n">runners</span><span class="p">):</span>
<a id="__codelineno-16-56" name="__codelineno-16-56" href="#__codelineno-16-56"></a>                    <span class="c1"># Check the polling api and streaming api matches up (sometimes it doesn&#39;t)</span>
<a id="__codelineno-16-57" name="__codelineno-16-57" href="#__codelineno-16-57"></a>                    <span class="k">if</span> <span class="n">runner_cata</span><span class="o">.</span><span class="n">selection_id</span> <span class="o">==</span> <span class="n">runner</span><span class="o">.</span><span class="n">selection_id</span><span class="p">:</span>
<a id="__codelineno-16-58" name="__codelineno-16-58" href="#__codelineno-16-58"></a>                        <span class="c1"># Get the dog_name from polling api then reference our data for our model rating</span>
<a id="__codelineno-16-59" name="__codelineno-16-59" href="#__codelineno-16-59"></a>                        <span class="n">dog_name</span> <span class="o">=</span> <span class="n">runner_cata</span><span class="o">.</span><span class="n">runner_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
<a id="__codelineno-16-60" name="__codelineno-16-60" href="#__codelineno-16-60"></a>
<a id="__codelineno-16-61" name="__codelineno-16-61" href="#__codelineno-16-61"></a>                        <span class="c1"># Rest is the same as How to Automate III</span>
<a id="__codelineno-16-62" name="__codelineno-16-62" href="#__codelineno-16-62"></a>                        <span class="n">model_price</span> <span class="o">=</span> <span class="n">todays_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dog_name</span><span class="p">,</span><span class="n">track</span><span class="p">,</span><span class="n">race_number</span><span class="p">][</span><span class="s1">&#39;rating&#39;</span><span class="p">]</span>
<a id="__codelineno-16-63" name="__codelineno-16-63" href="#__codelineno-16-63"></a>                        <span class="c1">### If you have an issue such as:</span>
<a id="__codelineno-16-64" name="__codelineno-16-64" href="#__codelineno-16-64"></a>                            <span class="c1"># Unknown error The truth value of a Series is ambiguous. Use a.empty, a.bool(), a.item(), a.any() or a.all().</span>
<a id="__codelineno-16-65" name="__codelineno-16-65" href="#__codelineno-16-65"></a>                            <span class="c1"># Then do model_price = todays_data.loc[dog_name,track,race_number][&#39;rating&#39;].item()</span>
<a id="__codelineno-16-66" name="__codelineno-16-66" href="#__codelineno-16-66"></a>
<a id="__codelineno-16-67" name="__codelineno-16-67" href="#__codelineno-16-67"></a>                        <span class="c1"># Log info before placing bets</span>
<a id="__codelineno-16-68" name="__codelineno-16-68" href="#__codelineno-16-68"></a>                        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;dog_name: </span><span class="si">{</span><span class="n">dog_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-16-69" name="__codelineno-16-69" href="#__codelineno-16-69"></a>                        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;model_price: </span><span class="si">{</span><span class="n">model_price</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-16-70" name="__codelineno-16-70" href="#__codelineno-16-70"></a>                        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;market_id: </span><span class="si">{</span><span class="n">market_book</span><span class="o">.</span><span class="n">market_id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-16-71" name="__codelineno-16-71" href="#__codelineno-16-71"></a>                        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;selection_id: </span><span class="si">{</span><span class="n">runner</span><span class="o">.</span><span class="n">selection_id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-16-72" name="__codelineno-16-72" href="#__codelineno-16-72"></a>
<a id="__codelineno-16-73" name="__codelineno-16-73" href="#__codelineno-16-73"></a>                        <span class="c1"># If best available to back price is &gt; rated price then flat $5 back</span>
<a id="__codelineno-16-74" name="__codelineno-16-74" href="#__codelineno-16-74"></a>                        <span class="k">if</span> <span class="n">runner</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;ACTIVE&quot;</span> <span class="ow">and</span> <span class="n">runner</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">available_to_back</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;price&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">model_price</span><span class="p">:</span>
<a id="__codelineno-16-75" name="__codelineno-16-75" href="#__codelineno-16-75"></a>                            <span class="n">trade</span> <span class="o">=</span> <span class="n">Trade</span><span class="p">(</span>
<a id="__codelineno-16-76" name="__codelineno-16-76" href="#__codelineno-16-76"></a>                            <span class="n">market_id</span><span class="o">=</span><span class="n">market_book</span><span class="o">.</span><span class="n">market_id</span><span class="p">,</span>
<a id="__codelineno-16-77" name="__codelineno-16-77" href="#__codelineno-16-77"></a>                            <span class="n">selection_id</span><span class="o">=</span><span class="n">runner</span><span class="o">.</span><span class="n">selection_id</span><span class="p">,</span>
<a id="__codelineno-16-78" name="__codelineno-16-78" href="#__codelineno-16-78"></a>                            <span class="n">handicap</span><span class="o">=</span><span class="n">runner</span><span class="o">.</span><span class="n">handicap</span><span class="p">,</span>
<a id="__codelineno-16-79" name="__codelineno-16-79" href="#__codelineno-16-79"></a>                            <span class="n">strategy</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-16-80" name="__codelineno-16-80" href="#__codelineno-16-80"></a>                            <span class="p">)</span>
<a id="__codelineno-16-81" name="__codelineno-16-81" href="#__codelineno-16-81"></a>                            <span class="n">order</span> <span class="o">=</span> <span class="n">trade</span><span class="o">.</span><span class="n">create_order</span><span class="p">(</span>
<a id="__codelineno-16-82" name="__codelineno-16-82" href="#__codelineno-16-82"></a>                                <span class="n">side</span><span class="o">=</span><span class="s2">&quot;BACK&quot;</span><span class="p">,</span> <span class="n">order_type</span><span class="o">=</span><span class="n">LimitOrder</span><span class="p">(</span><span class="n">price</span><span class="o">=</span><span class="n">runner</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">available_to_back</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;price&#39;</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="mf">5.00</span><span class="p">)</span>
<a id="__codelineno-16-83" name="__codelineno-16-83" href="#__codelineno-16-83"></a>                            <span class="p">)</span>
<a id="__codelineno-16-84" name="__codelineno-16-84" href="#__codelineno-16-84"></a>                            <span class="n">market</span><span class="o">.</span><span class="n">place_order</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
<a id="__codelineno-16-85" name="__codelineno-16-85" href="#__codelineno-16-85"></a>                        <span class="c1"># If best available to lay price is &lt; rated price then flat $5 lay</span>
<a id="__codelineno-16-86" name="__codelineno-16-86" href="#__codelineno-16-86"></a>                        <span class="k">if</span> <span class="n">runner</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;ACTIVE&quot;</span> <span class="ow">and</span> <span class="n">runner</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">available_to_lay</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;price&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">model_price</span><span class="p">:</span>
<a id="__codelineno-16-87" name="__codelineno-16-87" href="#__codelineno-16-87"></a>                            <span class="n">trade</span> <span class="o">=</span> <span class="n">Trade</span><span class="p">(</span>
<a id="__codelineno-16-88" name="__codelineno-16-88" href="#__codelineno-16-88"></a>                            <span class="n">market_id</span><span class="o">=</span><span class="n">market_book</span><span class="o">.</span><span class="n">market_id</span><span class="p">,</span>
<a id="__codelineno-16-89" name="__codelineno-16-89" href="#__codelineno-16-89"></a>                            <span class="n">selection_id</span><span class="o">=</span><span class="n">runner</span><span class="o">.</span><span class="n">selection_id</span><span class="p">,</span>
<a id="__codelineno-16-90" name="__codelineno-16-90" href="#__codelineno-16-90"></a>                            <span class="n">handicap</span><span class="o">=</span><span class="n">runner</span><span class="o">.</span><span class="n">handicap</span><span class="p">,</span>
<a id="__codelineno-16-91" name="__codelineno-16-91" href="#__codelineno-16-91"></a>                            <span class="n">strategy</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-16-92" name="__codelineno-16-92" href="#__codelineno-16-92"></a>                            <span class="p">)</span>
<a id="__codelineno-16-93" name="__codelineno-16-93" href="#__codelineno-16-93"></a>                            <span class="n">order</span> <span class="o">=</span> <span class="n">trade</span><span class="o">.</span><span class="n">create_order</span><span class="p">(</span>
<a id="__codelineno-16-94" name="__codelineno-16-94" href="#__codelineno-16-94"></a>                                <span class="n">side</span><span class="o">=</span><span class="s2">&quot;LAY&quot;</span><span class="p">,</span> <span class="n">order_type</span><span class="o">=</span><span class="n">LimitOrder</span><span class="p">(</span><span class="n">price</span><span class="o">=</span><span class="n">runner</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">available_to_lay</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;price&#39;</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="mf">5.00</span><span class="p">)</span>
<a id="__codelineno-16-95" name="__codelineno-16-95" href="#__codelineno-16-95"></a>                            <span class="p">)</span>
<a id="__codelineno-16-96" name="__codelineno-16-96" href="#__codelineno-16-96"></a>                            <span class="n">market</span><span class="o">.</span><span class="n">place_order</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
</code></pre></div>
<p>As the model we have built is a greyhound model for Australian racing let's point our strategy to Australian greyhound win markets</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a>    <span class="n">greyhounds_strategy</span> <span class="o">=</span> <span class="n">FlatBetting</span><span class="p">(</span>
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a>        <span class="n">market_filter</span><span class="o">=</span><span class="n">streaming_market_filter</span><span class="p">(</span>
<a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a>            <span class="n">event_type_ids</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;4339&quot;</span><span class="p">],</span> <span class="c1"># Greyhounds markets</span>
<a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a>            <span class="n">country_codes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;AU&quot;</span><span class="p">],</span> <span class="c1"># Australian markets</span>
<a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a>            <span class="n">market_types</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;WIN&quot;</span><span class="p">],</span> <span class="c1"># Win markets</span>
<a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a>        <span class="p">),</span>
<a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a>        <span class="n">max_order_exposure</span><span class="o">=</span> <span class="mi">50</span><span class="p">,</span> <span class="c1"># Max exposure per order = 50</span>
<a id="__codelineno-17-8" name="__codelineno-17-8" href="#__codelineno-17-8"></a>        <span class="n">max_trade_count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="c1"># Max 1 trade per selection</span>
<a id="__codelineno-17-9" name="__codelineno-17-9" href="#__codelineno-17-9"></a>        <span class="n">max_live_trade_count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="c1"># Max 1 unmatched trade per selection</span>
<a id="__codelineno-17-10" name="__codelineno-17-10" href="#__codelineno-17-10"></a>    <span class="p">)</span>
<a id="__codelineno-17-11" name="__codelineno-17-11" href="#__codelineno-17-11"></a>
<a id="__codelineno-17-12" name="__codelineno-17-12" href="#__codelineno-17-12"></a>    <span class="n">framework</span><span class="o">.</span><span class="n">add_strategy</span><span class="p">(</span><span class="n">greyhounds_strategy</span><span class="p">)</span>
</code></pre></div>
<p>And add our auto-terminate and bet logging from the previous tutorials:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a>    <span class="c1"># import logging</span>
<a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a>    <span class="kn">import</span> <span class="nn">datetime</span>
<a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a>    <span class="kn">from</span> <span class="nn">flumine.worker</span> <span class="kn">import</span> <span class="n">BackgroundWorker</span>
<a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a>    <span class="kn">from</span> <span class="nn">flumine.events.events</span> <span class="kn">import</span> <span class="n">TerminationEvent</span>
<a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a>
<a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a>    <span class="c1"># logger = logging.getLogger(__name__)</span>
<a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a>
<a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-18-9" name="__codelineno-18-9" href="#__codelineno-18-9"></a><span class="sd">    Worker can be used as followed:</span>
<a id="__codelineno-18-10" name="__codelineno-18-10" href="#__codelineno-18-10"></a><span class="sd">        framework.add_worker(</span>
<a id="__codelineno-18-11" name="__codelineno-18-11" href="#__codelineno-18-11"></a><span class="sd">            BackgroundWorker(</span>
<a id="__codelineno-18-12" name="__codelineno-18-12" href="#__codelineno-18-12"></a><span class="sd">                framework,</span>
<a id="__codelineno-18-13" name="__codelineno-18-13" href="#__codelineno-18-13"></a><span class="sd">                terminate,</span>
<a id="__codelineno-18-14" name="__codelineno-18-14" href="#__codelineno-18-14"></a><span class="sd">                func_kwargs={&quot;today_only&quot;: True, &quot;seconds_closed&quot;: 1200},</span>
<a id="__codelineno-18-15" name="__codelineno-18-15" href="#__codelineno-18-15"></a><span class="sd">                interval=60,</span>
<a id="__codelineno-18-16" name="__codelineno-18-16" href="#__codelineno-18-16"></a><span class="sd">                start_delay=60,</span>
<a id="__codelineno-18-17" name="__codelineno-18-17" href="#__codelineno-18-17"></a><span class="sd">            )</span>
<a id="__codelineno-18-18" name="__codelineno-18-18" href="#__codelineno-18-18"></a><span class="sd">        )</span>
<a id="__codelineno-18-19" name="__codelineno-18-19" href="#__codelineno-18-19"></a><span class="sd">    This will run every 60s and will terminate </span>
<a id="__codelineno-18-20" name="__codelineno-18-20" href="#__codelineno-18-20"></a><span class="sd">    the framework if all markets starting &#39;today&#39; </span>
<a id="__codelineno-18-21" name="__codelineno-18-21" href="#__codelineno-18-21"></a><span class="sd">    have been closed for at least 1200s</span>
<a id="__codelineno-18-22" name="__codelineno-18-22" href="#__codelineno-18-22"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-18-23" name="__codelineno-18-23" href="#__codelineno-18-23"></a>
<a id="__codelineno-18-24" name="__codelineno-18-24" href="#__codelineno-18-24"></a>
<a id="__codelineno-18-25" name="__codelineno-18-25" href="#__codelineno-18-25"></a>    <span class="c1"># Function that stops automation running at the end of the day</span>
<a id="__codelineno-18-26" name="__codelineno-18-26" href="#__codelineno-18-26"></a>    <span class="k">def</span> <span class="nf">terminate</span><span class="p">(</span>
<a id="__codelineno-18-27" name="__codelineno-18-27" href="#__codelineno-18-27"></a>        <span class="n">context</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">flumine</span><span class="p">,</span> <span class="n">today_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">seconds_closed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">600</span>
<a id="__codelineno-18-28" name="__codelineno-18-28" href="#__codelineno-18-28"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-18-29" name="__codelineno-18-29" href="#__codelineno-18-29"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;terminate framework if no markets</span>
<a id="__codelineno-18-30" name="__codelineno-18-30" href="#__codelineno-18-30"></a><span class="sd">        live today.</span>
<a id="__codelineno-18-31" name="__codelineno-18-31" href="#__codelineno-18-31"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-18-32" name="__codelineno-18-32" href="#__codelineno-18-32"></a>        <span class="n">markets</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">flumine</span><span class="o">.</span><span class="n">markets</span><span class="o">.</span><span class="n">markets</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
<a id="__codelineno-18-33" name="__codelineno-18-33" href="#__codelineno-18-33"></a>        <span class="n">markets_today</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-18-34" name="__codelineno-18-34" href="#__codelineno-18-34"></a>            <span class="n">m</span>
<a id="__codelineno-18-35" name="__codelineno-18-35" href="#__codelineno-18-35"></a>            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">markets</span>
<a id="__codelineno-18-36" name="__codelineno-18-36" href="#__codelineno-18-36"></a>            <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">market_start_datetime</span><span class="o">.</span><span class="n">date</span><span class="p">()</span> <span class="o">==</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
<a id="__codelineno-18-37" name="__codelineno-18-37" href="#__codelineno-18-37"></a>            <span class="ow">and</span> <span class="p">(</span>
<a id="__codelineno-18-38" name="__codelineno-18-38" href="#__codelineno-18-38"></a>                <span class="n">m</span><span class="o">.</span><span class="n">elapsed_seconds_closed</span> <span class="ow">is</span> <span class="kc">None</span>
<a id="__codelineno-18-39" name="__codelineno-18-39" href="#__codelineno-18-39"></a>                <span class="ow">or</span> <span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">elapsed_seconds_closed</span> <span class="ow">and</span> <span class="n">m</span><span class="o">.</span><span class="n">elapsed_seconds_closed</span> <span class="o">&lt;</span> <span class="n">seconds_closed</span><span class="p">)</span>
<a id="__codelineno-18-40" name="__codelineno-18-40" href="#__codelineno-18-40"></a>            <span class="p">)</span>
<a id="__codelineno-18-41" name="__codelineno-18-41" href="#__codelineno-18-41"></a>        <span class="p">]</span>
<a id="__codelineno-18-42" name="__codelineno-18-42" href="#__codelineno-18-42"></a>        <span class="k">if</span> <span class="n">today_only</span><span class="p">:</span>
<a id="__codelineno-18-43" name="__codelineno-18-43" href="#__codelineno-18-43"></a>            <span class="n">market_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">markets_today</span><span class="p">)</span>
<a id="__codelineno-18-44" name="__codelineno-18-44" href="#__codelineno-18-44"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-18-45" name="__codelineno-18-45" href="#__codelineno-18-45"></a>            <span class="n">market_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">markets</span><span class="p">)</span>
<a id="__codelineno-18-46" name="__codelineno-18-46" href="#__codelineno-18-46"></a>        <span class="k">if</span> <span class="n">market_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-18-47" name="__codelineno-18-47" href="#__codelineno-18-47"></a>            <span class="c1"># logger.info(&quot;No more markets available, terminating framework&quot;)</span>
<a id="__codelineno-18-48" name="__codelineno-18-48" href="#__codelineno-18-48"></a>            <span class="n">flumine</span><span class="o">.</span><span class="n">handler_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">TerminationEvent</span><span class="p">(</span><span class="n">flumine</span><span class="p">))</span>
<a id="__codelineno-18-49" name="__codelineno-18-49" href="#__codelineno-18-49"></a>
<a id="__codelineno-18-50" name="__codelineno-18-50" href="#__codelineno-18-50"></a>    <span class="c1"># Add the stopped to our framework</span>
<a id="__codelineno-18-51" name="__codelineno-18-51" href="#__codelineno-18-51"></a>    <span class="n">framework</span><span class="o">.</span><span class="n">add_worker</span><span class="p">(</span>
<a id="__codelineno-18-52" name="__codelineno-18-52" href="#__codelineno-18-52"></a>        <span class="n">BackgroundWorker</span><span class="p">(</span>
<a id="__codelineno-18-53" name="__codelineno-18-53" href="#__codelineno-18-53"></a>            <span class="n">framework</span><span class="p">,</span>
<a id="__codelineno-18-54" name="__codelineno-18-54" href="#__codelineno-18-54"></a>            <span class="n">terminate</span><span class="p">,</span>
<a id="__codelineno-18-55" name="__codelineno-18-55" href="#__codelineno-18-55"></a>            <span class="n">func_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;today_only&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;seconds_closed&quot;</span><span class="p">:</span> <span class="mi">1200</span><span class="p">},</span>
<a id="__codelineno-18-56" name="__codelineno-18-56" href="#__codelineno-18-56"></a>            <span class="n">interval</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
<a id="__codelineno-18-57" name="__codelineno-18-57" href="#__codelineno-18-57"></a>            <span class="n">start_delay</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
<a id="__codelineno-18-58" name="__codelineno-18-58" href="#__codelineno-18-58"></a>        <span class="p">)</span>
<a id="__codelineno-18-59" name="__codelineno-18-59" href="#__codelineno-18-59"></a>    <span class="p">)</span>
<a id="__codelineno-18-60" name="__codelineno-18-60" href="#__codelineno-18-60"></a>
<a id="__codelineno-18-61" name="__codelineno-18-61" href="#__codelineno-18-61"></a><span class="kn">import</span> <span class="nn">os</span>
<a id="__codelineno-18-62" name="__codelineno-18-62" href="#__codelineno-18-62"></a><span class="kn">import</span> <span class="nn">csv</span>
<a id="__codelineno-18-63" name="__codelineno-18-63" href="#__codelineno-18-63"></a><span class="kn">import</span> <span class="nn">logging</span>
<a id="__codelineno-18-64" name="__codelineno-18-64" href="#__codelineno-18-64"></a><span class="kn">from</span> <span class="nn">flumine.controls.loggingcontrols</span> <span class="kn">import</span> <span class="n">LoggingControl</span>
<a id="__codelineno-18-65" name="__codelineno-18-65" href="#__codelineno-18-65"></a><span class="kn">from</span> <span class="nn">flumine.order.ordertype</span> <span class="kn">import</span> <span class="n">OrderTypes</span>
<a id="__codelineno-18-66" name="__codelineno-18-66" href="#__codelineno-18-66"></a>
<a id="__codelineno-18-67" name="__codelineno-18-67" href="#__codelineno-18-67"></a><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<a id="__codelineno-18-68" name="__codelineno-18-68" href="#__codelineno-18-68"></a>
<a id="__codelineno-18-69" name="__codelineno-18-69" href="#__codelineno-18-69"></a><span class="n">FIELDNAMES</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-18-70" name="__codelineno-18-70" href="#__codelineno-18-70"></a>    <span class="s2">&quot;bet_id&quot;</span><span class="p">,</span>
<a id="__codelineno-18-71" name="__codelineno-18-71" href="#__codelineno-18-71"></a>    <span class="s2">&quot;strategy_name&quot;</span><span class="p">,</span>
<a id="__codelineno-18-72" name="__codelineno-18-72" href="#__codelineno-18-72"></a>    <span class="s2">&quot;market_id&quot;</span><span class="p">,</span>
<a id="__codelineno-18-73" name="__codelineno-18-73" href="#__codelineno-18-73"></a>    <span class="s2">&quot;selection_id&quot;</span><span class="p">,</span>
<a id="__codelineno-18-74" name="__codelineno-18-74" href="#__codelineno-18-74"></a>    <span class="s2">&quot;trade_id&quot;</span><span class="p">,</span>
<a id="__codelineno-18-75" name="__codelineno-18-75" href="#__codelineno-18-75"></a>    <span class="s2">&quot;date_time_placed&quot;</span><span class="p">,</span>
<a id="__codelineno-18-76" name="__codelineno-18-76" href="#__codelineno-18-76"></a>    <span class="s2">&quot;price&quot;</span><span class="p">,</span>
<a id="__codelineno-18-77" name="__codelineno-18-77" href="#__codelineno-18-77"></a>    <span class="s2">&quot;price_matched&quot;</span><span class="p">,</span>
<a id="__codelineno-18-78" name="__codelineno-18-78" href="#__codelineno-18-78"></a>    <span class="s2">&quot;size&quot;</span><span class="p">,</span>
<a id="__codelineno-18-79" name="__codelineno-18-79" href="#__codelineno-18-79"></a>    <span class="s2">&quot;size_matched&quot;</span><span class="p">,</span>
<a id="__codelineno-18-80" name="__codelineno-18-80" href="#__codelineno-18-80"></a>    <span class="s2">&quot;profit&quot;</span><span class="p">,</span>
<a id="__codelineno-18-81" name="__codelineno-18-81" href="#__codelineno-18-81"></a>    <span class="s2">&quot;side&quot;</span><span class="p">,</span>
<a id="__codelineno-18-82" name="__codelineno-18-82" href="#__codelineno-18-82"></a>    <span class="s2">&quot;elapsed_seconds_executable&quot;</span><span class="p">,</span>
<a id="__codelineno-18-83" name="__codelineno-18-83" href="#__codelineno-18-83"></a>    <span class="s2">&quot;order_status&quot;</span><span class="p">,</span>
<a id="__codelineno-18-84" name="__codelineno-18-84" href="#__codelineno-18-84"></a>    <span class="s2">&quot;market_note&quot;</span><span class="p">,</span>
<a id="__codelineno-18-85" name="__codelineno-18-85" href="#__codelineno-18-85"></a>    <span class="s2">&quot;trade_notes&quot;</span><span class="p">,</span>
<a id="__codelineno-18-86" name="__codelineno-18-86" href="#__codelineno-18-86"></a>    <span class="s2">&quot;order_notes&quot;</span><span class="p">,</span>
<a id="__codelineno-18-87" name="__codelineno-18-87" href="#__codelineno-18-87"></a><span class="p">]</span>
<a id="__codelineno-18-88" name="__codelineno-18-88" href="#__codelineno-18-88"></a>
<a id="__codelineno-18-89" name="__codelineno-18-89" href="#__codelineno-18-89"></a>
<a id="__codelineno-18-90" name="__codelineno-18-90" href="#__codelineno-18-90"></a><span class="k">class</span> <span class="nc">LiveLoggingControl</span><span class="p">(</span><span class="n">LoggingControl</span><span class="p">):</span>
<a id="__codelineno-18-91" name="__codelineno-18-91" href="#__codelineno-18-91"></a>    <span class="n">NAME</span> <span class="o">=</span> <span class="s2">&quot;BACKTEST_LOGGING_CONTROL&quot;</span>
<a id="__codelineno-18-92" name="__codelineno-18-92" href="#__codelineno-18-92"></a>
<a id="__codelineno-18-93" name="__codelineno-18-93" href="#__codelineno-18-93"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-18-94" name="__codelineno-18-94" href="#__codelineno-18-94"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">LiveLoggingControl</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-18-95" name="__codelineno-18-95" href="#__codelineno-18-95"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_setup</span><span class="p">()</span>
<a id="__codelineno-18-96" name="__codelineno-18-96" href="#__codelineno-18-96"></a>
<a id="__codelineno-18-97" name="__codelineno-18-97" href="#__codelineno-18-97"></a>    <span class="c1"># Changed file path and checks if the file orders_hta_4.csv already exists, if it doens&#39;t then create it</span>
<a id="__codelineno-18-98" name="__codelineno-18-98" href="#__codelineno-18-98"></a>    <span class="k">def</span> <span class="nf">_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-18-99" name="__codelineno-18-99" href="#__codelineno-18-99"></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;orders_hta_4.csv&quot;</span><span class="p">):</span>
<a id="__codelineno-18-100" name="__codelineno-18-100" href="#__codelineno-18-100"></a>            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Results file exists&quot;</span><span class="p">)</span>
<a id="__codelineno-18-101" name="__codelineno-18-101" href="#__codelineno-18-101"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-18-102" name="__codelineno-18-102" href="#__codelineno-18-102"></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;orders_hta_4.csv&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">m</span><span class="p">:</span>
<a id="__codelineno-18-103" name="__codelineno-18-103" href="#__codelineno-18-103"></a>                <span class="n">csv_writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictWriter</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">fieldnames</span><span class="o">=</span><span class="n">FIELDNAMES</span><span class="p">)</span>
<a id="__codelineno-18-104" name="__codelineno-18-104" href="#__codelineno-18-104"></a>                <span class="n">csv_writer</span><span class="o">.</span><span class="n">writeheader</span><span class="p">()</span>
<a id="__codelineno-18-105" name="__codelineno-18-105" href="#__codelineno-18-105"></a>
<a id="__codelineno-18-106" name="__codelineno-18-106" href="#__codelineno-18-106"></a>    <span class="k">def</span> <span class="nf">_process_cleared_orders_meta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
<a id="__codelineno-18-107" name="__codelineno-18-107" href="#__codelineno-18-107"></a>        <span class="n">orders</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">event</span>
<a id="__codelineno-18-108" name="__codelineno-18-108" href="#__codelineno-18-108"></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;orders_hta_4.csv&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">m</span><span class="p">:</span>
<a id="__codelineno-18-109" name="__codelineno-18-109" href="#__codelineno-18-109"></a>            <span class="k">for</span> <span class="n">order</span> <span class="ow">in</span> <span class="n">orders</span><span class="p">:</span>
<a id="__codelineno-18-110" name="__codelineno-18-110" href="#__codelineno-18-110"></a>                <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">order_type</span><span class="o">.</span><span class="n">ORDER_TYPE</span> <span class="o">==</span> <span class="n">OrderTypes</span><span class="o">.</span><span class="n">LIMIT</span><span class="p">:</span>
<a id="__codelineno-18-111" name="__codelineno-18-111" href="#__codelineno-18-111"></a>                    <span class="n">size</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">order_type</span><span class="o">.</span><span class="n">size</span>
<a id="__codelineno-18-112" name="__codelineno-18-112" href="#__codelineno-18-112"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-18-113" name="__codelineno-18-113" href="#__codelineno-18-113"></a>                    <span class="n">size</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">order_type</span><span class="o">.</span><span class="n">liability</span>
<a id="__codelineno-18-114" name="__codelineno-18-114" href="#__codelineno-18-114"></a>                <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">order_type</span><span class="o">.</span><span class="n">ORDER_TYPE</span> <span class="o">==</span> <span class="n">OrderTypes</span><span class="o">.</span><span class="n">MARKET_ON_CLOSE</span><span class="p">:</span>
<a id="__codelineno-18-115" name="__codelineno-18-115" href="#__codelineno-18-115"></a>                    <span class="n">price</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-18-116" name="__codelineno-18-116" href="#__codelineno-18-116"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-18-117" name="__codelineno-18-117" href="#__codelineno-18-117"></a>                    <span class="n">price</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">order_type</span><span class="o">.</span><span class="n">price</span>
<a id="__codelineno-18-118" name="__codelineno-18-118" href="#__codelineno-18-118"></a>                <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-18-119" name="__codelineno-18-119" href="#__codelineno-18-119"></a>                    <span class="n">order_data</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-18-120" name="__codelineno-18-120" href="#__codelineno-18-120"></a>                        <span class="s2">&quot;bet_id&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">bet_id</span><span class="p">,</span>
<a id="__codelineno-18-121" name="__codelineno-18-121" href="#__codelineno-18-121"></a>                        <span class="s2">&quot;strategy_name&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">trade</span><span class="o">.</span><span class="n">strategy</span><span class="p">,</span>
<a id="__codelineno-18-122" name="__codelineno-18-122" href="#__codelineno-18-122"></a>                        <span class="s2">&quot;market_id&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">market_id</span><span class="p">,</span>
<a id="__codelineno-18-123" name="__codelineno-18-123" href="#__codelineno-18-123"></a>                        <span class="s2">&quot;selection_id&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">selection_id</span><span class="p">,</span>
<a id="__codelineno-18-124" name="__codelineno-18-124" href="#__codelineno-18-124"></a>                        <span class="s2">&quot;trade_id&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">trade</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
<a id="__codelineno-18-125" name="__codelineno-18-125" href="#__codelineno-18-125"></a>                        <span class="s2">&quot;date_time_placed&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">responses</span><span class="o">.</span><span class="n">date_time_placed</span><span class="p">,</span>
<a id="__codelineno-18-126" name="__codelineno-18-126" href="#__codelineno-18-126"></a>                        <span class="s2">&quot;price&quot;</span><span class="p">:</span> <span class="n">price</span><span class="p">,</span>
<a id="__codelineno-18-127" name="__codelineno-18-127" href="#__codelineno-18-127"></a>                        <span class="s2">&quot;price_matched&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">average_price_matched</span><span class="p">,</span>
<a id="__codelineno-18-128" name="__codelineno-18-128" href="#__codelineno-18-128"></a>                        <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="n">size</span><span class="p">,</span>
<a id="__codelineno-18-129" name="__codelineno-18-129" href="#__codelineno-18-129"></a>                        <span class="s2">&quot;size_matched&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">size_matched</span><span class="p">,</span>
<a id="__codelineno-18-130" name="__codelineno-18-130" href="#__codelineno-18-130"></a>                        <span class="s2">&quot;profit&quot;</span><span class="p">:</span> <span class="mi">0</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">order</span><span class="o">.</span><span class="n">cleared_order</span> <span class="k">else</span> <span class="n">order</span><span class="o">.</span><span class="n">cleared_order</span><span class="o">.</span><span class="n">profit</span><span class="p">,</span>
<a id="__codelineno-18-131" name="__codelineno-18-131" href="#__codelineno-18-131"></a>                        <span class="s2">&quot;side&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">side</span><span class="p">,</span>
<a id="__codelineno-18-132" name="__codelineno-18-132" href="#__codelineno-18-132"></a>                        <span class="s2">&quot;elapsed_seconds_executable&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">elapsed_seconds_executable</span><span class="p">,</span>
<a id="__codelineno-18-133" name="__codelineno-18-133" href="#__codelineno-18-133"></a>                        <span class="s2">&quot;order_status&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
<a id="__codelineno-18-134" name="__codelineno-18-134" href="#__codelineno-18-134"></a>                        <span class="s2">&quot;market_note&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">trade</span><span class="o">.</span><span class="n">market_notes</span><span class="p">,</span>
<a id="__codelineno-18-135" name="__codelineno-18-135" href="#__codelineno-18-135"></a>                        <span class="s2">&quot;trade_notes&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">trade</span><span class="o">.</span><span class="n">notes_str</span><span class="p">,</span>
<a id="__codelineno-18-136" name="__codelineno-18-136" href="#__codelineno-18-136"></a>                        <span class="s2">&quot;order_notes&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">notes_str</span><span class="p">,</span>
<a id="__codelineno-18-137" name="__codelineno-18-137" href="#__codelineno-18-137"></a>                    <span class="p">}</span>
<a id="__codelineno-18-138" name="__codelineno-18-138" href="#__codelineno-18-138"></a>                    <span class="n">csv_writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictWriter</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">fieldnames</span><span class="o">=</span><span class="n">FIELDNAMES</span><span class="p">)</span>
<a id="__codelineno-18-139" name="__codelineno-18-139" href="#__codelineno-18-139"></a>                    <span class="n">csv_writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">order_data</span><span class="p">)</span>
<a id="__codelineno-18-140" name="__codelineno-18-140" href="#__codelineno-18-140"></a>                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-18-141" name="__codelineno-18-141" href="#__codelineno-18-141"></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-18-142" name="__codelineno-18-142" href="#__codelineno-18-142"></a>                        <span class="s2">&quot;_process_cleared_orders_meta: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">,</span>
<a id="__codelineno-18-143" name="__codelineno-18-143" href="#__codelineno-18-143"></a>                        <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;order&quot;</span><span class="p">:</span> <span class="n">order</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">e</span><span class="p">},</span>
<a id="__codelineno-18-144" name="__codelineno-18-144" href="#__codelineno-18-144"></a>                    <span class="p">)</span>
<a id="__codelineno-18-145" name="__codelineno-18-145" href="#__codelineno-18-145"></a>
<a id="__codelineno-18-146" name="__codelineno-18-146" href="#__codelineno-18-146"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Orders updated&quot;</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;order_count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">orders</span><span class="p">)})</span>
<a id="__codelineno-18-147" name="__codelineno-18-147" href="#__codelineno-18-147"></a>
<a id="__codelineno-18-148" name="__codelineno-18-148" href="#__codelineno-18-148"></a>    <span class="k">def</span> <span class="nf">_process_cleared_markets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
<a id="__codelineno-18-149" name="__codelineno-18-149" href="#__codelineno-18-149"></a>        <span class="n">cleared_markets</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">event</span>
<a id="__codelineno-18-150" name="__codelineno-18-150" href="#__codelineno-18-150"></a>        <span class="k">for</span> <span class="n">cleared_market</span> <span class="ow">in</span> <span class="n">cleared_markets</span><span class="o">.</span><span class="n">orders</span><span class="p">:</span>
<a id="__codelineno-18-151" name="__codelineno-18-151" href="#__codelineno-18-151"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-18-152" name="__codelineno-18-152" href="#__codelineno-18-152"></a>                <span class="s2">&quot;Cleared market&quot;</span><span class="p">,</span>
<a id="__codelineno-18-153" name="__codelineno-18-153" href="#__codelineno-18-153"></a>                <span class="n">extra</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-18-154" name="__codelineno-18-154" href="#__codelineno-18-154"></a>                    <span class="s2">&quot;market_id&quot;</span><span class="p">:</span> <span class="n">cleared_market</span><span class="o">.</span><span class="n">market_id</span><span class="p">,</span>
<a id="__codelineno-18-155" name="__codelineno-18-155" href="#__codelineno-18-155"></a>                    <span class="s2">&quot;bet_count&quot;</span><span class="p">:</span> <span class="n">cleared_market</span><span class="o">.</span><span class="n">bet_count</span><span class="p">,</span>
<a id="__codelineno-18-156" name="__codelineno-18-156" href="#__codelineno-18-156"></a>                    <span class="s2">&quot;profit&quot;</span><span class="p">:</span> <span class="n">cleared_market</span><span class="o">.</span><span class="n">profit</span><span class="p">,</span>
<a id="__codelineno-18-157" name="__codelineno-18-157" href="#__codelineno-18-157"></a>                    <span class="s2">&quot;commission&quot;</span><span class="p">:</span> <span class="n">cleared_market</span><span class="o">.</span><span class="n">commission</span><span class="p">,</span>
<a id="__codelineno-18-158" name="__codelineno-18-158" href="#__codelineno-18-158"></a>                <span class="p">},</span>
<a id="__codelineno-18-159" name="__codelineno-18-159" href="#__codelineno-18-159"></a>            <span class="p">)</span>
<a id="__codelineno-18-160" name="__codelineno-18-160" href="#__codelineno-18-160"></a>
<a id="__codelineno-18-161" name="__codelineno-18-161" href="#__codelineno-18-161"></a><span class="n">framework</span><span class="o">.</span><span class="n">add_logging_control</span><span class="p">(</span>
<a id="__codelineno-18-162" name="__codelineno-18-162" href="#__codelineno-18-162"></a>    <span class="n">LiveLoggingControl</span><span class="p">()</span>
<a id="__codelineno-18-163" name="__codelineno-18-163" href="#__codelineno-18-163"></a><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="n">framework</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</code></pre></div>
<p>And we are all done. Lets GOOOO!!!
Once you run this script, 1 minute from the scheduled start of the race it will creating our predictions and start placing $5 bets. </p>
<p>--</p>
<h2 id="generating-historical-predictions">Generating historical predictions</h2>
<p>Feeding our predictions through the simulator is entirely optional, but, in my opinion it is where the real sauce is made. The idea is that if we are testing our model live, we can also use the simulator to test what would happen if we tested different staking methodologies, market timings and bet placement to optimise our model. This way you can have a model but test out different strategies to optimise model performance. The thing is, I have had a play with the simulator already and we can't simulate market_catalogue unless you have recorded it yourself (which is what I'll be using to get market_id and selection_id to place live bets). The simulator we will use later on will only take your ratings, market_id and selection_id, so we need our data in a similar format to what we had in How to automate III. In other words, since we don't have market_catalogue in the simulator, we need another way to get the market_id and selection_id.</p>
<p>My hacky work around is to generate the probabilities like normal, using basically the same code as above, and since the data is historical its actually even easier as we don't need to deal with reserve dogs and scratching's. Once we have our model predictions, we cheat and get the market_id and selection_id from the Betfair datascience greyhound model by merging on DogName and date. We can take the code we wrote in <a href="../How_to_Automate_3">How to automate III</a> that downloads the greyhound ratings and convert that into a function that downloads the ratings for a date range. This is what the complete code looks like:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a>    <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a>    <span class="kn">from</span> <span class="nn">joblib</span> <span class="kn">import</span> <span class="n">load</span>
<a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a>
<a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a>    <span class="n">model_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;../data/model_df.csv&#39;</span><span class="p">)</span>
<a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a>    <span class="n">feature_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;speed_index&#39;</span><span class="p">,</span> <span class="s1">&#39;box_win_percent&#39;</span><span class="p">,</span> <span class="s1">&#39;RunTime_norm_min_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;RunTime_norm_max_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;RunTime_norm_mean_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;RunTime_norm_median_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;RunTime_norm_std_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;SplitMargin_norm_min_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;SplitMargin_norm_max_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;SplitMargin_norm_mean_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;SplitMargin_norm_median_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;SplitMargin_norm_std_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_inv_min_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_inv_max_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_inv_mean_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_inv_median_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_inv_std_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_log_min_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_log_max_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_log_mean_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_log_median_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_log_std_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;Prizemoney_norm_min_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;Prizemoney_norm_max_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;Prizemoney_norm_mean_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;Prizemoney_norm_median_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;Prizemoney_norm_std_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;RunTime_norm_min_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;RunTime_norm_max_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;RunTime_norm_mean_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;RunTime_norm_median_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;RunTime_norm_std_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;SplitMargin_norm_min_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;SplitMargin_norm_max_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;SplitMargin_norm_mean_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;SplitMargin_norm_median_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;SplitMargin_norm_std_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_inv_min_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_inv_max_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_inv_mean_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_inv_median_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_inv_std_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_log_min_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_log_max_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_log_mean_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_log_median_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_log_std_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;Prizemoney_norm_min_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;Prizemoney_norm_max_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;Prizemoney_norm_mean_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;Prizemoney_norm_median_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;Prizemoney_norm_std_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;RunTime_norm_min_365D&#39;</span><span class="p">,</span> <span class="s1">&#39;RunTime_norm_max_365D&#39;</span><span class="p">,</span> <span class="s1">&#39;RunTime_norm_mean_365D&#39;</span><span class="p">,</span> <span class="s1">&#39;RunTime_norm_median_365D&#39;</span><span class="p">,</span> <span class="s1">&#39;RunTime_norm_std_365D&#39;</span><span class="p">,</span> <span class="s1">&#39;SplitMargin_norm_min_365D&#39;</span><span class="p">,</span> <span class="s1">&#39;SplitMargin_norm_max_365D&#39;</span><span class="p">,</span> <span class="s1">&#39;SplitMargin_norm_mean_365D&#39;</span><span class="p">,</span> <span class="s1">&#39;SplitMargin_norm_median_365D&#39;</span><span class="p">,</span> <span class="s1">&#39;SplitMargin_norm_std_365D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_inv_min_365D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_inv_max_365D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_inv_mean_365D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_inv_median_365D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_inv_std_365D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_log_min_365D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_log_max_365D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_log_mean_365D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_log_median_365D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_log_std_365D&#39;</span><span class="p">,</span> <span class="s1">&#39;Prizemoney_norm_min_365D&#39;</span><span class="p">,</span> <span class="s1">&#39;Prizemoney_norm_max_365D&#39;</span><span class="p">,</span> <span class="s1">&#39;Prizemoney_norm_mean_365D&#39;</span><span class="p">,</span> <span class="s1">&#39;Prizemoney_norm_median_365D&#39;</span><span class="p">,</span> <span class="s1">&#39;Prizemoney_norm_std_365D&#39;</span><span class="p">]</span>
<a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a>    <span class="n">brunos_model</span> <span class="o">=</span> <span class="n">load</span><span class="p">(</span><span class="s1">&#39;../data/logistic_regression.joblib&#39;</span><span class="p">)</span>
<a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a>
<a id="__codelineno-20-8" name="__codelineno-20-8" href="#__codelineno-20-8"></a>    <span class="c1"># Generate predictions like normal</span>
<a id="__codelineno-20-9" name="__codelineno-20-9" href="#__codelineno-20-9"></a>    <span class="c1"># Range of dates that we want to simulate later &#39;2022-03-01&#39; to &#39;2022-04-01&#39;</span>
<a id="__codelineno-20-10" name="__codelineno-20-10" href="#__codelineno-20-10"></a>    <span class="n">model_df</span><span class="p">[</span><span class="s1">&#39;date_dt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">model_df</span><span class="p">[</span><span class="s1">&#39;date_dt&#39;</span><span class="p">])</span>
<a id="__codelineno-20-11" name="__codelineno-20-11" href="#__codelineno-20-11"></a>    <span class="n">todays_data</span> <span class="o">=</span> <span class="n">model_df</span><span class="p">[(</span><span class="n">model_df</span><span class="p">[</span><span class="s1">&#39;date_dt&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2022-03-01&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">model_df</span><span class="p">[</span><span class="s1">&#39;date_dt&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2022-04-01&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">))]</span>
<a id="__codelineno-20-12" name="__codelineno-20-12" href="#__codelineno-20-12"></a>    <span class="n">dog_win_probabilities</span> <span class="o">=</span> <span class="n">brunos_model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">todays_data</span><span class="p">[</span><span class="n">feature_cols</span><span class="p">])[:,</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-20-13" name="__codelineno-20-13" href="#__codelineno-20-13"></a>    <span class="n">todays_data</span><span class="p">[</span><span class="s1">&#39;prob_LogisticRegression&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dog_win_probabilities</span>
<a id="__codelineno-20-14" name="__codelineno-20-14" href="#__codelineno-20-14"></a>    <span class="n">todays_data</span><span class="p">[</span><span class="s1">&#39;renormalise_prob&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">todays_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;FastTrack_RaceId&#39;</span><span class="p">)[</span><span class="s1">&#39;prob_LogisticRegression&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
<a id="__codelineno-20-15" name="__codelineno-20-15" href="#__codelineno-20-15"></a>    <span class="n">todays_data</span><span class="p">[</span><span class="s1">&#39;rating&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">todays_data</span><span class="p">[</span><span class="s1">&#39;renormalise_prob&#39;</span><span class="p">]</span>
<a id="__codelineno-20-16" name="__codelineno-20-16" href="#__codelineno-20-16"></a>    <span class="n">todays_data</span> <span class="o">=</span> <span class="n">todays_data</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span> <span class="o">=</span> <span class="s1">&#39;date_dt&#39;</span><span class="p">)</span>
<a id="__codelineno-20-17" name="__codelineno-20-17" href="#__codelineno-20-17"></a>    <span class="n">todays_data</span>
<a id="__codelineno-20-18" name="__codelineno-20-18" href="#__codelineno-20-18"></a>
<a id="__codelineno-20-19" name="__codelineno-20-19" href="#__codelineno-20-19"></a>    <span class="k">def</span> <span class="nf">download_iggy_ratings</span><span class="p">(</span><span class="n">date</span><span class="p">):</span>
<a id="__codelineno-20-20" name="__codelineno-20-20" href="#__codelineno-20-20"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Downloads the Betfair Iggy model ratings for a given date and formats it into a nice DataFrame.</span>
<a id="__codelineno-20-21" name="__codelineno-20-21" href="#__codelineno-20-21"></a>
<a id="__codelineno-20-22" name="__codelineno-20-22" href="#__codelineno-20-22"></a><span class="sd">        Args:</span>
<a id="__codelineno-20-23" name="__codelineno-20-23" href="#__codelineno-20-23"></a><span class="sd">            date (datetime): the date we want to download the ratings for</span>
<a id="__codelineno-20-24" name="__codelineno-20-24" href="#__codelineno-20-24"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-20-25" name="__codelineno-20-25" href="#__codelineno-20-25"></a>        <span class="n">iggy_url_1</span> <span class="o">=</span> <span class="s1">&#39;https://betfair-data-supplier-prod.herokuapp.com/api/widgets/iggy-joey/datasets?date=&#39;</span>
<a id="__codelineno-20-26" name="__codelineno-20-26" href="#__codelineno-20-26"></a>        <span class="n">iggy_url_2</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-20-27" name="__codelineno-20-27" href="#__codelineno-20-27"></a>        <span class="n">iggy_url_3</span> <span class="o">=</span> <span class="s1">&#39;&amp;presenter=RatingsPresenter&amp;csv=true&#39;</span>
<a id="__codelineno-20-28" name="__codelineno-20-28" href="#__codelineno-20-28"></a>        <span class="n">iggy_url</span> <span class="o">=</span> <span class="n">iggy_url_1</span> <span class="o">+</span> <span class="n">iggy_url_2</span> <span class="o">+</span> <span class="n">iggy_url_3</span>
<a id="__codelineno-20-29" name="__codelineno-20-29" href="#__codelineno-20-29"></a>
<a id="__codelineno-20-30" name="__codelineno-20-30" href="#__codelineno-20-30"></a>        <span class="c1"># Download todays greyhounds ratings</span>
<a id="__codelineno-20-31" name="__codelineno-20-31" href="#__codelineno-20-31"></a>        <span class="n">iggy_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">iggy_url</span><span class="p">)</span>
<a id="__codelineno-20-32" name="__codelineno-20-32" href="#__codelineno-20-32"></a>
<a id="__codelineno-20-33" name="__codelineno-20-33" href="#__codelineno-20-33"></a>        <span class="c1"># Data clearning</span>
<a id="__codelineno-20-34" name="__codelineno-20-34" href="#__codelineno-20-34"></a>        <span class="n">iggy_df</span> <span class="o">=</span> <span class="n">iggy_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
<a id="__codelineno-20-35" name="__codelineno-20-35" href="#__codelineno-20-35"></a>        <span class="n">columns</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-20-36" name="__codelineno-20-36" href="#__codelineno-20-36"></a>            <span class="s2">&quot;meetings.races.bfExchangeMarketId&quot;</span><span class="p">:</span><span class="s2">&quot;market_id&quot;</span><span class="p">,</span>
<a id="__codelineno-20-37" name="__codelineno-20-37" href="#__codelineno-20-37"></a>            <span class="s2">&quot;meetings.races.runners.bfExchangeSelectionId&quot;</span><span class="p">:</span><span class="s2">&quot;selection_id&quot;</span><span class="p">,</span>
<a id="__codelineno-20-38" name="__codelineno-20-38" href="#__codelineno-20-38"></a>            <span class="s2">&quot;meetings.races.runners.ratedPrice&quot;</span><span class="p">:</span><span class="s2">&quot;rating&quot;</span><span class="p">,</span>
<a id="__codelineno-20-39" name="__codelineno-20-39" href="#__codelineno-20-39"></a>            <span class="s2">&quot;meetings.races.number&quot;</span><span class="p">:</span><span class="s2">&quot;RaceNum&quot;</span><span class="p">,</span>
<a id="__codelineno-20-40" name="__codelineno-20-40" href="#__codelineno-20-40"></a>            <span class="s2">&quot;meetings.name&quot;</span><span class="p">:</span><span class="s2">&quot;Track&quot;</span><span class="p">,</span>
<a id="__codelineno-20-41" name="__codelineno-20-41" href="#__codelineno-20-41"></a>            <span class="s2">&quot;meetings.races.runners.name&quot;</span><span class="p">:</span><span class="s2">&quot;DogName&quot;</span>
<a id="__codelineno-20-42" name="__codelineno-20-42" href="#__codelineno-20-42"></a>            <span class="p">}</span>
<a id="__codelineno-20-43" name="__codelineno-20-43" href="#__codelineno-20-43"></a>        <span class="p">)</span>
<a id="__codelineno-20-44" name="__codelineno-20-44" href="#__codelineno-20-44"></a>        <span class="c1"># iggy_df = iggy_df[[&#39;market_id&#39;,&#39;selection_id&#39;,&#39;rating&#39;]]</span>
<a id="__codelineno-20-45" name="__codelineno-20-45" href="#__codelineno-20-45"></a>        <span class="n">iggy_df</span><span class="p">[</span><span class="s1">&#39;market_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">iggy_df</span><span class="p">[</span><span class="s1">&#39;market_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
<a id="__codelineno-20-46" name="__codelineno-20-46" href="#__codelineno-20-46"></a>        <span class="n">iggy_df</span><span class="p">[</span><span class="s1">&#39;date_dt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">date</span>
<a id="__codelineno-20-47" name="__codelineno-20-47" href="#__codelineno-20-47"></a>
<a id="__codelineno-20-48" name="__codelineno-20-48" href="#__codelineno-20-48"></a>        <span class="c1"># Set market_id and selection_id as index for easy referencing</span>
<a id="__codelineno-20-49" name="__codelineno-20-49" href="#__codelineno-20-49"></a>        <span class="c1"># iggy_df = iggy_df.set_index([&#39;market_id&#39;,&#39;selection_id&#39;])</span>
<a id="__codelineno-20-50" name="__codelineno-20-50" href="#__codelineno-20-50"></a>        <span class="k">return</span><span class="p">(</span><span class="n">iggy_df</span><span class="p">)</span>
<a id="__codelineno-20-51" name="__codelineno-20-51" href="#__codelineno-20-51"></a>
<a id="__codelineno-20-52" name="__codelineno-20-52" href="#__codelineno-20-52"></a>    <span class="c1"># Download historical ratings over a time period and convert into a big DataFrame.</span>
<a id="__codelineno-20-53" name="__codelineno-20-53" href="#__codelineno-20-53"></a>    <span class="n">back_test_period</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="s1">&#39;2022-03-01&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;2022-04-01&#39;</span><span class="p">)</span>
<a id="__codelineno-20-54" name="__codelineno-20-54" href="#__codelineno-20-54"></a>    <span class="n">frames</span> <span class="o">=</span> <span class="p">[</span><span class="n">download_iggy_ratings</span><span class="p">(</span><span class="n">day</span><span class="p">)</span> <span class="k">for</span> <span class="n">day</span> <span class="ow">in</span> <span class="n">back_test_period</span><span class="p">]</span>
<a id="__codelineno-20-55" name="__codelineno-20-55" href="#__codelineno-20-55"></a>    <span class="n">iggy_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">frames</span><span class="p">)</span>
<a id="__codelineno-20-56" name="__codelineno-20-56" href="#__codelineno-20-56"></a>    <span class="n">iggy_df</span>
<a id="__codelineno-20-57" name="__codelineno-20-57" href="#__codelineno-20-57"></a>
<a id="__codelineno-20-58" name="__codelineno-20-58" href="#__codelineno-20-58"></a>    <span class="c1"># format DogNames to merge</span>
<a id="__codelineno-20-59" name="__codelineno-20-59" href="#__codelineno-20-59"></a>    <span class="n">todays_data</span><span class="p">[</span><span class="s1">&#39;DogName&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">todays_data</span><span class="p">[</span><span class="s1">&#39;DogName&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Res&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
<a id="__codelineno-20-60" name="__codelineno-20-60" href="#__codelineno-20-60"></a>    <span class="n">iggy_df</span><span class="p">[</span><span class="s1">&#39;DogName&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">iggy_df</span><span class="p">[</span><span class="s1">&#39;DogName&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
<a id="__codelineno-20-61" name="__codelineno-20-61" href="#__codelineno-20-61"></a>    <span class="c1"># Merge</span>
<a id="__codelineno-20-62" name="__codelineno-20-62" href="#__codelineno-20-62"></a>    <span class="n">backtest</span> <span class="o">=</span> <span class="n">iggy_df</span><span class="p">[[</span><span class="s1">&#39;market_id&#39;</span><span class="p">,</span><span class="s1">&#39;selection_id&#39;</span><span class="p">,</span><span class="s1">&#39;DogName&#39;</span><span class="p">,</span><span class="s1">&#39;date_dt&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">todays_data</span><span class="p">[[</span><span class="s1">&#39;rating&#39;</span><span class="p">,</span><span class="s1">&#39;DogName&#39;</span><span class="p">,</span><span class="s1">&#39;date_dt&#39;</span><span class="p">]],</span> <span class="n">how</span> <span class="o">=</span> <span class="s1">&#39;inner&#39;</span><span class="p">,</span> <span class="n">on</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;DogName&#39;</span><span class="p">,</span><span class="s1">&#39;date_dt&#39;</span><span class="p">])</span>
<a id="__codelineno-20-63" name="__codelineno-20-63" href="#__codelineno-20-63"></a>    <span class="n">backtest</span>
<a id="__codelineno-20-64" name="__codelineno-20-64" href="#__codelineno-20-64"></a>
<a id="__codelineno-20-65" name="__codelineno-20-65" href="#__codelineno-20-65"></a>    <span class="c1"># Save predictions for if we want to backtest/simulate it later</span>
<a id="__codelineno-20-66" name="__codelineno-20-66" href="#__codelineno-20-66"></a>    <span class="n">backtest</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;../data/backtest.csv&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="c1"># Csv format</span>
</code></pre></div>
<hr />
<h2 id="conclusions-and-next-steps">Conclusions and next steps</h2>
<p>Boom! We now have a set of automated script that will download all the data we need in the morning, generates a set of predictions, place flat stakes bets, logs all bets and switches itself off at the end of the day. (If you look in the github repo you will find a script that links all three scripts together so all we need to do is hit play once in the morning!)</p>
<p>We have now written code automation code for three different strategies, however we haven't actually backtested any of our strategies or models yet. So for the final part of the How to Automate series we will be writing code to How to simulate the Exchange to backtest and optimise our strategies. Make sure not to miss it as this is where I believe the sauce is made (not that I have made significant sauce).</p>
<h3 id="complete-code">Complete code</h3>
<p>Run the code from your ide by using py <code>&lt;filename&gt;</code>.py, making sure you amend the path to point to your input data.</p>
<div class="tabbed-set tabbed-alternate" data-tabs="2:4"><input checked="checked" id="__tabbed_2_1" name="__tabbed_2" type="radio" /><input id="__tabbed_2_2" name="__tabbed_2" type="radio" /><input id="__tabbed_2_3" name="__tabbed_2" type="radio" /><input id="__tabbed_2_4" name="__tabbed_2" type="radio" /><div class="tabbed-labels"><label for="__tabbed_2_1">Part 1</label><label for="__tabbed_2_2">Part 2</label><label for="__tabbed_2_3">Part 3</label><label for="__tabbed_2_4">Part 4</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p><a href="https://github.com/betfair-down-under/autoHubTutorials/tree/master/howToAutomate/how_to_automate_IV">Download from Github</a></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a>    <span class="kn">import</span> <span class="nn">os</span>
<a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a>    <span class="kn">import</span> <span class="nn">sys</span>
<a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a>    <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a>    <span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a>    <span class="kn">from</span> <span class="nn">dateutil.relativedelta</span> <span class="kn">import</span> <span class="n">relativedelta</span>
<a id="__codelineno-21-6" name="__codelineno-21-6" href="#__codelineno-21-6"></a>
<a id="__codelineno-21-7" name="__codelineno-21-7" href="#__codelineno-21-7"></a>    <span class="c1"># Allow imports from src folder</span>
<a id="__codelineno-21-8" name="__codelineno-21-8" href="#__codelineno-21-8"></a>    <span class="n">module_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;src&#39;</span><span class="p">))</span>
<a id="__codelineno-21-9" name="__codelineno-21-9" href="#__codelineno-21-9"></a>    <span class="k">if</span> <span class="n">module_path</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
<a id="__codelineno-21-10" name="__codelineno-21-10" href="#__codelineno-21-10"></a>        <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">module_path</span><span class="p">)</span>
<a id="__codelineno-21-11" name="__codelineno-21-11" href="#__codelineno-21-11"></a>
<a id="__codelineno-21-12" name="__codelineno-21-12" href="#__codelineno-21-12"></a>    <span class="kn">import</span> <span class="nn">fasttrack</span> <span class="k">as</span> <span class="nn">ft</span>
<a id="__codelineno-21-13" name="__codelineno-21-13" href="#__codelineno-21-13"></a>    <span class="kn">from</span> <span class="nn">dotenv</span> <span class="kn">import</span> <span class="n">load_dotenv</span>
<a id="__codelineno-21-14" name="__codelineno-21-14" href="#__codelineno-21-14"></a>    <span class="n">load_dotenv</span><span class="p">()</span>
<a id="__codelineno-21-15" name="__codelineno-21-15" href="#__codelineno-21-15"></a>
<a id="__codelineno-21-16" name="__codelineno-21-16" href="#__codelineno-21-16"></a>    <span class="c1"># Validate FastTrack API connection</span>
<a id="__codelineno-21-17" name="__codelineno-21-17" href="#__codelineno-21-17"></a>    <span class="n">api_key</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;FAST_TRACK_API_KEY&#39;</span><span class="p">,)</span>
<a id="__codelineno-21-18" name="__codelineno-21-18" href="#__codelineno-21-18"></a>    <span class="n">client</span> <span class="o">=</span> <span class="n">ft</span><span class="o">.</span><span class="n">Fasttrack</span><span class="p">(</span><span class="n">api_key</span><span class="p">)</span>
<a id="__codelineno-21-19" name="__codelineno-21-19" href="#__codelineno-21-19"></a>    <span class="n">track_codes</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">listTracks</span><span class="p">()</span>
<a id="__codelineno-21-20" name="__codelineno-21-20" href="#__codelineno-21-20"></a>
<a id="__codelineno-21-21" name="__codelineno-21-21" href="#__codelineno-21-21"></a>    <span class="c1"># Import race data excluding NZ races</span>
<a id="__codelineno-21-22" name="__codelineno-21-22" href="#__codelineno-21-22"></a>    <span class="n">au_tracks_filter</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">track_codes</span><span class="p">[</span><span class="n">track_codes</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;NZ&#39;</span><span class="p">][</span><span class="s1">&#39;track_code&#39;</span><span class="p">])</span>
<a id="__codelineno-21-23" name="__codelineno-21-23" href="#__codelineno-21-23"></a>
<a id="__codelineno-21-24" name="__codelineno-21-24" href="#__codelineno-21-24"></a>    <span class="c1"># Time window to import data</span>
<a id="__codelineno-21-25" name="__codelineno-21-25" href="#__codelineno-21-25"></a>    <span class="c1"># First day of the month 46 months back from now</span>
<a id="__codelineno-21-26" name="__codelineno-21-26" href="#__codelineno-21-26"></a>    <span class="n">date_from</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span> <span class="o">-</span> <span class="n">relativedelta</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="mi">46</span><span class="p">))</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">day</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-21-27" name="__codelineno-21-27" href="#__codelineno-21-27"></a>    <span class="c1"># Download historic data up untill yesterday</span>
<a id="__codelineno-21-28" name="__codelineno-21-28" href="#__codelineno-21-28"></a>    <span class="n">date_to</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span> <span class="o">-</span> <span class="n">relativedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-21-29" name="__codelineno-21-29" href="#__codelineno-21-29"></a>
<a id="__codelineno-21-30" name="__codelineno-21-30" href="#__codelineno-21-30"></a>    <span class="c1"># List to populate data with, convert to dataframe after fully populated</span>
<a id="__codelineno-21-31" name="__codelineno-21-31" href="#__codelineno-21-31"></a>    <span class="n">race_details</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-21-32" name="__codelineno-21-32" href="#__codelineno-21-32"></a>    <span class="n">dog_results</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-21-33" name="__codelineno-21-33" href="#__codelineno-21-33"></a>
<a id="__codelineno-21-34" name="__codelineno-21-34" href="#__codelineno-21-34"></a>    <span class="c1"># Download/load historic (up until yesterday) data</span>
<a id="__codelineno-21-35" name="__codelineno-21-35" href="#__codelineno-21-35"></a>    <span class="c1"># For each day, either fetch data from API or use local CSV file if we already have downloaded it</span>
<a id="__codelineno-21-36" name="__codelineno-21-36" href="#__codelineno-21-36"></a>    <span class="k">for</span> <span class="n">start</span> <span class="ow">in</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">date_from</span><span class="p">,</span> <span class="n">date_to</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">):</span>
<a id="__codelineno-21-37" name="__codelineno-21-37" href="#__codelineno-21-37"></a>        <span class="n">start_date</span> <span class="o">=</span> <span class="n">start</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-21-38" name="__codelineno-21-38" href="#__codelineno-21-38"></a>        <span class="n">end_date</span> <span class="o">=</span> <span class="n">start_date</span>
<a id="__codelineno-21-39" name="__codelineno-21-39" href="#__codelineno-21-39"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-21-40" name="__codelineno-21-40" href="#__codelineno-21-40"></a>            <span class="n">filename_races</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;FT_AU_RACES_</span><span class="si">{</span><span class="n">start_date</span><span class="si">}</span><span class="s1">.csv&#39;</span>
<a id="__codelineno-21-41" name="__codelineno-21-41" href="#__codelineno-21-41"></a>            <span class="n">filename_dogs</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;FT_AU_DOGS_</span><span class="si">{</span><span class="n">start_date</span><span class="si">}</span><span class="s1">.csv&#39;</span>
<a id="__codelineno-21-42" name="__codelineno-21-42" href="#__codelineno-21-42"></a>
<a id="__codelineno-21-43" name="__codelineno-21-43" href="#__codelineno-21-43"></a>            <span class="n">filepath_races</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;../data/</span><span class="si">{</span><span class="n">filename_races</span><span class="si">}</span><span class="s1">&#39;</span>
<a id="__codelineno-21-44" name="__codelineno-21-44" href="#__codelineno-21-44"></a>            <span class="n">filepath_dogs</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;../data/</span><span class="si">{</span><span class="n">filename_dogs</span><span class="si">}</span><span class="s1">&#39;</span>
<a id="__codelineno-21-45" name="__codelineno-21-45" href="#__codelineno-21-45"></a>
<a id="__codelineno-21-46" name="__codelineno-21-46" href="#__codelineno-21-46"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Loading data from </span><span class="si">{</span><span class="n">start_date</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">end_date</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-21-47" name="__codelineno-21-47" href="#__codelineno-21-47"></a>            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filepath_races</span><span class="p">):</span>
<a id="__codelineno-21-48" name="__codelineno-21-48" href="#__codelineno-21-48"></a>                <span class="c1"># Load local CSV file</span>
<a id="__codelineno-21-49" name="__codelineno-21-49" href="#__codelineno-21-49"></a>                <span class="n">day_race_details</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">filepath_races</span><span class="p">)</span> 
<a id="__codelineno-21-50" name="__codelineno-21-50" href="#__codelineno-21-50"></a>                <span class="n">day_dog_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">filepath_dogs</span><span class="p">)</span> 
<a id="__codelineno-21-51" name="__codelineno-21-51" href="#__codelineno-21-51"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-21-52" name="__codelineno-21-52" href="#__codelineno-21-52"></a>                <span class="c1"># Fetch data from API</span>
<a id="__codelineno-21-53" name="__codelineno-21-53" href="#__codelineno-21-53"></a>                <span class="n">day_race_details</span><span class="p">,</span> <span class="n">day_dog_results</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">getRaceResults</span><span class="p">(</span><span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">,</span> <span class="n">au_tracks_filter</span><span class="p">)</span>
<a id="__codelineno-21-54" name="__codelineno-21-54" href="#__codelineno-21-54"></a>                <span class="n">day_race_details</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">filepath_races</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-21-55" name="__codelineno-21-55" href="#__codelineno-21-55"></a>                <span class="n">day_dog_results</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">filepath_dogs</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-21-56" name="__codelineno-21-56" href="#__codelineno-21-56"></a>
<a id="__codelineno-21-57" name="__codelineno-21-57" href="#__codelineno-21-57"></a>            <span class="c1"># Combine daily data</span>
<a id="__codelineno-21-58" name="__codelineno-21-58" href="#__codelineno-21-58"></a>            <span class="n">race_details</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">day_race_details</span><span class="p">)</span>
<a id="__codelineno-21-59" name="__codelineno-21-59" href="#__codelineno-21-59"></a>            <span class="n">dog_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">day_dog_results</span><span class="p">)</span>
<a id="__codelineno-21-60" name="__codelineno-21-60" href="#__codelineno-21-60"></a>        <span class="k">except</span><span class="p">:</span>
<a id="__codelineno-21-61" name="__codelineno-21-61" href="#__codelineno-21-61"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Could not load data from </span><span class="si">{</span><span class="n">start_date</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">end_date</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-21-62" name="__codelineno-21-62" href="#__codelineno-21-62"></a>
<a id="__codelineno-21-63" name="__codelineno-21-63" href="#__codelineno-21-63"></a>    <span class="c1"># Download todays data from the api</span>
<a id="__codelineno-21-64" name="__codelineno-21-64" href="#__codelineno-21-64"></a>    <span class="n">todays_date</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-21-65" name="__codelineno-21-65" href="#__codelineno-21-65"></a>    <span class="n">todays_race_details</span><span class="p">,</span> <span class="n">todays_dog_results</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">getFullFormat</span><span class="p">(</span><span class="n">todays_date</span><span class="p">)</span>
<a id="__codelineno-21-66" name="__codelineno-21-66" href="#__codelineno-21-66"></a>
<a id="__codelineno-21-67" name="__codelineno-21-67" href="#__codelineno-21-67"></a>    <span class="c1"># Make live API data in the same form as historic data</span>
<a id="__codelineno-21-68" name="__codelineno-21-68" href="#__codelineno-21-68"></a>    <span class="n">todays_race_details</span> <span class="o">=</span> <span class="n">todays_race_details</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Date&quot;</span><span class="p">:</span><span class="s2">&quot;date&quot;</span><span class="p">})</span>
<a id="__codelineno-21-69" name="__codelineno-21-69" href="#__codelineno-21-69"></a>    <span class="n">todays_dog_results</span> <span class="o">=</span> <span class="n">todays_dog_results</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;RaceBox&quot;</span><span class="p">:</span><span class="s2">&quot;Box&quot;</span><span class="p">})</span>
<a id="__codelineno-21-70" name="__codelineno-21-70" href="#__codelineno-21-70"></a>    <span class="c1"># Only keep the columns we have in the historic data</span>
<a id="__codelineno-21-71" name="__codelineno-21-71" href="#__codelineno-21-71"></a>    <span class="n">usecols_race_details</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;@id&#39;</span><span class="p">,</span><span class="s1">&#39;RaceNum&#39;</span><span class="p">,</span><span class="s1">&#39;RaceName&#39;</span><span class="p">,</span><span class="s1">&#39;RaceTime&#39;</span><span class="p">,</span><span class="s1">&#39;Distance&#39;</span><span class="p">,</span><span class="s1">&#39;RaceGrade&#39;</span><span class="p">,</span><span class="s1">&#39;Track&#39;</span><span class="p">,</span><span class="s1">&#39;date&#39;</span><span class="p">]</span>
<a id="__codelineno-21-72" name="__codelineno-21-72" href="#__codelineno-21-72"></a>    <span class="n">usecols_dog_results</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;@id&#39;</span><span class="p">,</span><span class="s1">&#39;DogName&#39;</span><span class="p">,</span><span class="s1">&#39;Box&#39;</span><span class="p">,</span><span class="s1">&#39;RaceId&#39;</span><span class="p">,</span><span class="s1">&#39;TrainerId&#39;</span><span class="p">,</span><span class="s1">&#39;TrainerName&#39;</span><span class="p">]</span>
<a id="__codelineno-21-73" name="__codelineno-21-73" href="#__codelineno-21-73"></a>    <span class="c1"># dog_results columns not in live data [&#39;Place&#39;,&#39;Rug&#39;,&#39;Weight&#39;,&#39;StartPrice&#39;,&#39;Handicap&#39;,&#39;Margin1&#39;, &#39;Margin2&#39;,&#39;PIR&#39;,&#39;Checks&#39;,&#39;Comments&#39;,&#39;SplitMargin&#39;, &#39;RunTime&#39;, &#39;Prizemoney&#39;,]</span>
<a id="__codelineno-21-74" name="__codelineno-21-74" href="#__codelineno-21-74"></a>    <span class="n">todays_race_details</span> <span class="o">=</span> <span class="n">todays_race_details</span><span class="p">[</span><span class="n">usecols_race_details</span><span class="p">]</span>
<a id="__codelineno-21-75" name="__codelineno-21-75" href="#__codelineno-21-75"></a>    <span class="n">todays_dog_results</span> <span class="o">=</span> <span class="n">todays_dog_results</span><span class="p">[</span><span class="n">usecols_dog_results</span><span class="p">]</span>
<a id="__codelineno-21-76" name="__codelineno-21-76" href="#__codelineno-21-76"></a>
<a id="__codelineno-21-77" name="__codelineno-21-77" href="#__codelineno-21-77"></a>    <span class="c1"># Now that todays data looks similar to our historic data lets add todays data to the rest of our historic data</span>
<a id="__codelineno-21-78" name="__codelineno-21-78" href="#__codelineno-21-78"></a>    <span class="n">race_details</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">todays_race_details</span><span class="p">)</span>
<a id="__codelineno-21-79" name="__codelineno-21-79" href="#__codelineno-21-79"></a>    <span class="n">dog_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">todays_dog_results</span><span class="p">)</span>
<a id="__codelineno-21-80" name="__codelineno-21-80" href="#__codelineno-21-80"></a>    <span class="c1"># Convert our data into a nice DataFrame</span>
<a id="__codelineno-21-81" name="__codelineno-21-81" href="#__codelineno-21-81"></a>    <span class="n">race_details</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">race_details</span><span class="p">)</span>
<a id="__codelineno-21-82" name="__codelineno-21-82" href="#__codelineno-21-82"></a>    <span class="n">dog_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">dog_results</span><span class="p">)</span>
<a id="__codelineno-21-83" name="__codelineno-21-83" href="#__codelineno-21-83"></a>
<a id="__codelineno-21-84" name="__codelineno-21-84" href="#__codelineno-21-84"></a>    <span class="c1"># Save our data to csv files</span>
<a id="__codelineno-21-85" name="__codelineno-21-85" href="#__codelineno-21-85"></a>    <span class="n">race_details</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;../data/race_details.csv&#39;</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-21-86" name="__codelineno-21-86" href="#__codelineno-21-86"></a>    <span class="n">dog_results</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;../data/dog_results.csv&#39;</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-21-87" name="__codelineno-21-87" href="#__codelineno-21-87"></a>    <span class="c1"># Ready for data cleaning and feature creation</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p><a href="https://github.com/betfair-down-under/autoHubTutorials/tree/master/howToAutomate/how_to_automate_IV">Download from Github</a></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a>    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a>    <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a>    <span class="c1"># settings to display all columns</span>
<a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a>    <span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s2">&quot;display.max_columns&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a>    <span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">MinMaxScaler</span>
<a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a>    <span class="kn">import</span> <span class="nn">itertools</span>
<a id="__codelineno-22-7" name="__codelineno-22-7" href="#__codelineno-22-7"></a>
<a id="__codelineno-22-8" name="__codelineno-22-8" href="#__codelineno-22-8"></a>    <span class="n">race_details</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;../data/race_details.csv&#39;</span><span class="p">)</span>
<a id="__codelineno-22-9" name="__codelineno-22-9" href="#__codelineno-22-9"></a>    <span class="n">dog_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;../data/dog_results.csv&#39;</span><span class="p">)</span>
<a id="__codelineno-22-10" name="__codelineno-22-10" href="#__codelineno-22-10"></a>
<a id="__codelineno-22-11" name="__codelineno-22-11" href="#__codelineno-22-11"></a>    <span class="c1">## Cleanse and normalise the data</span>
<a id="__codelineno-22-12" name="__codelineno-22-12" href="#__codelineno-22-12"></a>    <span class="c1"># Clean up the race dataset</span>
<a id="__codelineno-22-13" name="__codelineno-22-13" href="#__codelineno-22-13"></a>    <span class="n">race_details</span> <span class="o">=</span> <span class="n">race_details</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;@id&#39;</span><span class="p">:</span> <span class="s1">&#39;FastTrack_RaceId&#39;</span><span class="p">})</span>
<a id="__codelineno-22-14" name="__codelineno-22-14" href="#__codelineno-22-14"></a>    <span class="n">race_details</span><span class="p">[</span><span class="s1">&#39;Distance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">race_details</span><span class="p">[</span><span class="s1">&#39;Distance&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;m&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)))</span>
<a id="__codelineno-22-15" name="__codelineno-22-15" href="#__codelineno-22-15"></a>    <span class="n">race_details</span><span class="p">[</span><span class="s1">&#39;date_dt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">race_details</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">],</span> <span class="nb">format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> %b %y&#39;</span><span class="p">)</span>
<a id="__codelineno-22-16" name="__codelineno-22-16" href="#__codelineno-22-16"></a>    <span class="c1"># Clean up the dogs results dataset</span>
<a id="__codelineno-22-17" name="__codelineno-22-17" href="#__codelineno-22-17"></a>    <span class="n">dog_results</span> <span class="o">=</span> <span class="n">dog_results</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;@id&#39;</span><span class="p">:</span> <span class="s1">&#39;FastTrack_DogId&#39;</span><span class="p">,</span> <span class="s1">&#39;RaceId&#39;</span><span class="p">:</span> <span class="s1">&#39;FastTrack_RaceId&#39;</span><span class="p">})</span>
<a id="__codelineno-22-18" name="__codelineno-22-18" href="#__codelineno-22-18"></a>
<a id="__codelineno-22-19" name="__codelineno-22-19" href="#__codelineno-22-19"></a>    <span class="c1"># Combine dogs results with race attributes</span>
<a id="__codelineno-22-20" name="__codelineno-22-20" href="#__codelineno-22-20"></a>    <span class="n">dog_results</span> <span class="o">=</span> <span class="n">dog_results</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
<a id="__codelineno-22-21" name="__codelineno-22-21" href="#__codelineno-22-21"></a>        <span class="n">race_details</span><span class="p">,</span> 
<a id="__codelineno-22-22" name="__codelineno-22-22" href="#__codelineno-22-22"></a>        <span class="n">how</span> <span class="o">=</span> <span class="s1">&#39;left&#39;</span><span class="p">,</span>
<a id="__codelineno-22-23" name="__codelineno-22-23" href="#__codelineno-22-23"></a>        <span class="n">on</span> <span class="o">=</span> <span class="s1">&#39;FastTrack_RaceId&#39;</span>
<a id="__codelineno-22-24" name="__codelineno-22-24" href="#__codelineno-22-24"></a>    <span class="p">)</span>
<a id="__codelineno-22-25" name="__codelineno-22-25" href="#__codelineno-22-25"></a>
<a id="__codelineno-22-26" name="__codelineno-22-26" href="#__codelineno-22-26"></a>    <span class="c1"># Convert StartPrice to probability</span>
<a id="__codelineno-22-27" name="__codelineno-22-27" href="#__codelineno-22-27"></a>    <span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;StartPrice&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;StartPrice&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;$&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;F&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">x</span><span class="p">)</span>
<a id="__codelineno-22-28" name="__codelineno-22-28" href="#__codelineno-22-28"></a>    <span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;StartPrice_probability&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;StartPrice&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-22-29" name="__codelineno-22-29" href="#__codelineno-22-29"></a>    <span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;StartPrice_probability&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dog_results</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;FastTrack_RaceId&#39;</span><span class="p">)[</span><span class="s1">&#39;StartPrice_probability&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
<a id="__codelineno-22-30" name="__codelineno-22-30" href="#__codelineno-22-30"></a>
<a id="__codelineno-22-31" name="__codelineno-22-31" href="#__codelineno-22-31"></a>    <span class="c1"># Discard entries without results (scratched or did not finish)</span>
<a id="__codelineno-22-32" name="__codelineno-22-32" href="#__codelineno-22-32"></a>    <span class="n">dog_results</span> <span class="o">=</span> <span class="n">dog_results</span><span class="p">[</span><span class="o">~</span><span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;Box&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span>
<a id="__codelineno-22-33" name="__codelineno-22-33" href="#__codelineno-22-33"></a>    <span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;Box&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;Box&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<a id="__codelineno-22-34" name="__codelineno-22-34" href="#__codelineno-22-34"></a>
<a id="__codelineno-22-35" name="__codelineno-22-35" href="#__codelineno-22-35"></a>    <span class="c1"># Clean up other attributes</span>
<a id="__codelineno-22-36" name="__codelineno-22-36" href="#__codelineno-22-36"></a>    <span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;RunTime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;RunTime&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
<a id="__codelineno-22-37" name="__codelineno-22-37" href="#__codelineno-22-37"></a>    <span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;SplitMargin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;SplitMargin&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
<a id="__codelineno-22-38" name="__codelineno-22-38" href="#__codelineno-22-38"></a>    <span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;Prizemoney&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;Prizemoney&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-22-39" name="__codelineno-22-39" href="#__codelineno-22-39"></a>    <span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;Place&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;Place&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span><span class="p">),</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;coerce&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-22-40" name="__codelineno-22-40" href="#__codelineno-22-40"></a>    <span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;win&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;Place&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-22-41" name="__codelineno-22-41" href="#__codelineno-22-41"></a>
<a id="__codelineno-22-42" name="__codelineno-22-42" href="#__codelineno-22-42"></a>    <span class="c1"># Normalise some of the raw values</span>
<a id="__codelineno-22-43" name="__codelineno-22-43" href="#__codelineno-22-43"></a>    <span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;Prizemoney_norm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;Prizemoney&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">12</span>
<a id="__codelineno-22-44" name="__codelineno-22-44" href="#__codelineno-22-44"></a>    <span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;Place_inv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;Place&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-22-45" name="__codelineno-22-45" href="#__codelineno-22-45"></a>    <span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;Place_log&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;Place&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-22-46" name="__codelineno-22-46" href="#__codelineno-22-46"></a>    <span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;RunSpeed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;RunTime&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;Distance&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-22-47" name="__codelineno-22-47" href="#__codelineno-22-47"></a>
<a id="__codelineno-22-48" name="__codelineno-22-48" href="#__codelineno-22-48"></a>    <span class="c1">## Generate features using raw data</span>
<a id="__codelineno-22-49" name="__codelineno-22-49" href="#__codelineno-22-49"></a>    <span class="c1"># Calculate median winner time per track/distance</span>
<a id="__codelineno-22-50" name="__codelineno-22-50" href="#__codelineno-22-50"></a>    <span class="n">win_results</span> <span class="o">=</span> <span class="n">dog_results</span><span class="p">[</span><span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;win&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-22-51" name="__codelineno-22-51" href="#__codelineno-22-51"></a>    <span class="n">median_win_time</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">win_results</span><span class="p">[</span><span class="n">win_results</span><span class="p">[</span><span class="s1">&#39;RunTime&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;Track&#39;</span><span class="p">,</span> <span class="s1">&#39;Distance&#39;</span><span class="p">])[</span><span class="s1">&#39;RunTime&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">())</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;RunTime&quot;</span><span class="p">:</span> <span class="s2">&quot;RunTime_median&quot;</span><span class="p">})</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<a id="__codelineno-22-52" name="__codelineno-22-52" href="#__codelineno-22-52"></a>    <span class="n">median_win_split_time</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">win_results</span><span class="p">[</span><span class="n">win_results</span><span class="p">[</span><span class="s1">&#39;SplitMargin&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;Track&#39;</span><span class="p">,</span> <span class="s1">&#39;Distance&#39;</span><span class="p">])[</span><span class="s1">&#39;SplitMargin&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">())</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;SplitMargin&quot;</span><span class="p">:</span> <span class="s2">&quot;SplitMargin_median&quot;</span><span class="p">})</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<a id="__codelineno-22-53" name="__codelineno-22-53" href="#__codelineno-22-53"></a>    <span class="n">median_win_time</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
<a id="__codelineno-22-54" name="__codelineno-22-54" href="#__codelineno-22-54"></a>
<a id="__codelineno-22-55" name="__codelineno-22-55" href="#__codelineno-22-55"></a>    <span class="c1"># Calculate track speed index</span>
<a id="__codelineno-22-56" name="__codelineno-22-56" href="#__codelineno-22-56"></a>    <span class="n">median_win_time</span><span class="p">[</span><span class="s1">&#39;speed_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">median_win_time</span><span class="p">[</span><span class="s1">&#39;RunTime_median&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">median_win_time</span><span class="p">[</span><span class="s1">&#39;Distance&#39;</span><span class="p">])</span>
<a id="__codelineno-22-57" name="__codelineno-22-57" href="#__codelineno-22-57"></a>    <span class="n">median_win_time</span><span class="p">[</span><span class="s1">&#39;speed_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">MinMaxScaler</span><span class="p">()</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">median_win_time</span><span class="p">[[</span><span class="s1">&#39;speed_index&#39;</span><span class="p">]])</span>
<a id="__codelineno-22-58" name="__codelineno-22-58" href="#__codelineno-22-58"></a>    <span class="n">median_win_time</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
<a id="__codelineno-22-59" name="__codelineno-22-59" href="#__codelineno-22-59"></a>
<a id="__codelineno-22-60" name="__codelineno-22-60" href="#__codelineno-22-60"></a>    <span class="c1"># Compare dogs finish time with median winner time</span>
<a id="__codelineno-22-61" name="__codelineno-22-61" href="#__codelineno-22-61"></a>    <span class="n">dog_results</span> <span class="o">=</span> <span class="n">dog_results</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">median_win_time</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Track&#39;</span><span class="p">,</span> <span class="s1">&#39;Distance&#39;</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
<a id="__codelineno-22-62" name="__codelineno-22-62" href="#__codelineno-22-62"></a>    <span class="n">dog_results</span> <span class="o">=</span> <span class="n">dog_results</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">median_win_split_time</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Track&#39;</span><span class="p">,</span> <span class="s1">&#39;Distance&#39;</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
<a id="__codelineno-22-63" name="__codelineno-22-63" href="#__codelineno-22-63"></a>
<a id="__codelineno-22-64" name="__codelineno-22-64" href="#__codelineno-22-64"></a>    <span class="c1"># Normalise time comparison</span>
<a id="__codelineno-22-65" name="__codelineno-22-65" href="#__codelineno-22-65"></a>    <span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;RunTime_norm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;RunTime_median&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;RunTime&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">)</span>
<a id="__codelineno-22-66" name="__codelineno-22-66" href="#__codelineno-22-66"></a>    <span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;RunTime_norm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">MinMaxScaler</span><span class="p">()</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">dog_results</span><span class="p">[[</span><span class="s1">&#39;RunTime_norm&#39;</span><span class="p">]])</span>
<a id="__codelineno-22-67" name="__codelineno-22-67" href="#__codelineno-22-67"></a>    <span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;SplitMargin_norm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;SplitMargin_median&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;SplitMargin&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">)</span>
<a id="__codelineno-22-68" name="__codelineno-22-68" href="#__codelineno-22-68"></a>    <span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;SplitMargin_norm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">MinMaxScaler</span><span class="p">()</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">dog_results</span><span class="p">[[</span><span class="s1">&#39;SplitMargin_norm&#39;</span><span class="p">]])</span>
<a id="__codelineno-22-69" name="__codelineno-22-69" href="#__codelineno-22-69"></a>    <span class="n">dog_results</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
<a id="__codelineno-22-70" name="__codelineno-22-70" href="#__codelineno-22-70"></a>
<a id="__codelineno-22-71" name="__codelineno-22-71" href="#__codelineno-22-71"></a>    <span class="c1"># Calculate box winning percentage for each track/distance</span>
<a id="__codelineno-22-72" name="__codelineno-22-72" href="#__codelineno-22-72"></a>    <span class="n">box_win_percent</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">dog_results</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;Track&#39;</span><span class="p">,</span> <span class="s1">&#39;Distance&#39;</span><span class="p">,</span> <span class="s1">&#39;Box&#39;</span><span class="p">])[</span><span class="s1">&#39;win&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;win&quot;</span><span class="p">:</span> <span class="s2">&quot;box_win_percent&quot;</span><span class="p">})</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<a id="__codelineno-22-73" name="__codelineno-22-73" href="#__codelineno-22-73"></a>    <span class="c1"># Add to dog results dataframe</span>
<a id="__codelineno-22-74" name="__codelineno-22-74" href="#__codelineno-22-74"></a>    <span class="n">dog_results</span> <span class="o">=</span> <span class="n">dog_results</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">box_win_percent</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Track&#39;</span><span class="p">,</span> <span class="s1">&#39;Distance&#39;</span><span class="p">,</span> <span class="s1">&#39;Box&#39;</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
<a id="__codelineno-22-75" name="__codelineno-22-75" href="#__codelineno-22-75"></a>    <span class="c1"># Display example of barrier winning probabilities</span>
<a id="__codelineno-22-76" name="__codelineno-22-76" href="#__codelineno-22-76"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">box_win_percent</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>
<a id="__codelineno-22-77" name="__codelineno-22-77" href="#__codelineno-22-77"></a>    <span class="n">box_win_percent</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;../data/box_win_percentage.csv&#39;</span><span class="p">)</span>
<a id="__codelineno-22-78" name="__codelineno-22-78" href="#__codelineno-22-78"></a>
<a id="__codelineno-22-79" name="__codelineno-22-79" href="#__codelineno-22-79"></a>    <span class="c1"># Generate rolling window features</span>
<a id="__codelineno-22-80" name="__codelineno-22-80" href="#__codelineno-22-80"></a>    <span class="n">dataset</span> <span class="o">=</span> <span class="n">dog_results</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-22-81" name="__codelineno-22-81" href="#__codelineno-22-81"></a>    <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;FastTrack_DogId&#39;</span><span class="p">,</span> <span class="s1">&#39;date_dt&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
<a id="__codelineno-22-82" name="__codelineno-22-82" href="#__codelineno-22-82"></a>
<a id="__codelineno-22-83" name="__codelineno-22-83" href="#__codelineno-22-83"></a>    <span class="c1"># Use rolling window of 28, 91 and 365 days</span>
<a id="__codelineno-22-84" name="__codelineno-22-84" href="#__codelineno-22-84"></a>    <span class="n">rolling_windows</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;28D&#39;</span><span class="p">,</span> <span class="s1">&#39;91D&#39;</span><span class="p">,</span> <span class="s1">&#39;365D&#39;</span><span class="p">]</span>
<a id="__codelineno-22-85" name="__codelineno-22-85" href="#__codelineno-22-85"></a>    <span class="c1"># Features to use for rolling windows calculation</span>
<a id="__codelineno-22-86" name="__codelineno-22-86" href="#__codelineno-22-86"></a>    <span class="n">features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;RunTime_norm&#39;</span><span class="p">,</span> <span class="s1">&#39;SplitMargin_norm&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_inv&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_log&#39;</span><span class="p">,</span> <span class="s1">&#39;Prizemoney_norm&#39;</span><span class="p">]</span>
<a id="__codelineno-22-87" name="__codelineno-22-87" href="#__codelineno-22-87"></a>    <span class="c1"># Aggregation functions to apply</span>
<a id="__codelineno-22-88" name="__codelineno-22-88" href="#__codelineno-22-88"></a>    <span class="n">aggregates</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;median&#39;</span><span class="p">,</span> <span class="s1">&#39;std&#39;</span><span class="p">]</span>
<a id="__codelineno-22-89" name="__codelineno-22-89" href="#__codelineno-22-89"></a>    <span class="c1"># Keep track of generated feature names</span>
<a id="__codelineno-22-90" name="__codelineno-22-90" href="#__codelineno-22-90"></a>    <span class="n">feature_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;speed_index&#39;</span><span class="p">,</span> <span class="s1">&#39;box_win_percent&#39;</span><span class="p">]</span>
<a id="__codelineno-22-91" name="__codelineno-22-91" href="#__codelineno-22-91"></a>
<a id="__codelineno-22-92" name="__codelineno-22-92" href="#__codelineno-22-92"></a>    <span class="k">for</span> <span class="n">rolling_window</span> <span class="ow">in</span> <span class="n">rolling_windows</span><span class="p">:</span>
<a id="__codelineno-22-93" name="__codelineno-22-93" href="#__codelineno-22-93"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Processing rolling window </span><span class="si">{</span><span class="n">rolling_window</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-22-94" name="__codelineno-22-94" href="#__codelineno-22-94"></a>
<a id="__codelineno-22-95" name="__codelineno-22-95" href="#__codelineno-22-95"></a>            <span class="n">rolling_result</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-22-96" name="__codelineno-22-96" href="#__codelineno-22-96"></a>                <span class="n">dataset</span>
<a id="__codelineno-22-97" name="__codelineno-22-97" href="#__codelineno-22-97"></a>                <span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
<a id="__codelineno-22-98" name="__codelineno-22-98" href="#__codelineno-22-98"></a>                <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;FastTrack_DogId&#39;</span><span class="p">)[</span><span class="n">features</span><span class="p">]</span>
<a id="__codelineno-22-99" name="__codelineno-22-99" href="#__codelineno-22-99"></a>                <span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">rolling_window</span><span class="p">)</span>
<a id="__codelineno-22-100" name="__codelineno-22-100" href="#__codelineno-22-100"></a>                <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">aggregates</span><span class="p">)</span>
<a id="__codelineno-22-101" name="__codelineno-22-101" href="#__codelineno-22-101"></a>                <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># Thanks to Brett for finding this!</span>
<a id="__codelineno-22-102" name="__codelineno-22-102" href="#__codelineno-22-102"></a>                <span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-22-103" name="__codelineno-22-103" href="#__codelineno-22-103"></a>            <span class="p">)</span>
<a id="__codelineno-22-104" name="__codelineno-22-104" href="#__codelineno-22-104"></a>
<a id="__codelineno-22-105" name="__codelineno-22-105" href="#__codelineno-22-105"></a>            <span class="c1"># My own dodgey code to work with reserve dogs</span>
<a id="__codelineno-22-106" name="__codelineno-22-106" href="#__codelineno-22-106"></a>            <span class="n">temp</span> <span class="o">=</span> <span class="n">rolling_result</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<a id="__codelineno-22-107" name="__codelineno-22-107" href="#__codelineno-22-107"></a>            <span class="n">temp</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="n">temp</span><span class="p">[</span><span class="s1">&#39;date_dt&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">normalize</span><span class="p">()]</span>
<a id="__codelineno-22-108" name="__codelineno-22-108" href="#__codelineno-22-108"></a>            <span class="n">temp</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-22-109" name="__codelineno-22-109" href="#__codelineno-22-109"></a>            <span class="n">rolling_result</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">IndexSlice</span><span class="p">[:,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">normalize</span><span class="p">()],</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;FastTrack_DogId&#39;</span><span class="p">,</span><span class="s1">&#39;date_dt&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
<a id="__codelineno-22-110" name="__codelineno-22-110" href="#__codelineno-22-110"></a>
<a id="__codelineno-22-111" name="__codelineno-22-111" href="#__codelineno-22-111"></a>            <span class="c1"># Generate list of rolling window feature names (eg: RunTime_norm_min_365D)</span>
<a id="__codelineno-22-112" name="__codelineno-22-112" href="#__codelineno-22-112"></a>            <span class="n">agg_features_cols</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">a</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">rolling_window</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">f</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">aggregates</span><span class="p">)]</span>
<a id="__codelineno-22-113" name="__codelineno-22-113" href="#__codelineno-22-113"></a>
<a id="__codelineno-22-114" name="__codelineno-22-114" href="#__codelineno-22-114"></a>            <span class="c1"># More efficient method to add features to dataset</span>
<a id="__codelineno-22-115" name="__codelineno-22-115" href="#__codelineno-22-115"></a>            <span class="n">rolling_result</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">agg_features_cols</span>
<a id="__codelineno-22-116" name="__codelineno-22-116" href="#__codelineno-22-116"></a>            <span class="n">dataset</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">dataset</span><span class="p">,</span><span class="n">rolling_result</span><span class="p">],</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-22-117" name="__codelineno-22-117" href="#__codelineno-22-117"></a>
<a id="__codelineno-22-118" name="__codelineno-22-118" href="#__codelineno-22-118"></a>            <span class="c1"># Keep track of generated feature names</span>
<a id="__codelineno-22-119" name="__codelineno-22-119" href="#__codelineno-22-119"></a>            <span class="n">feature_cols</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">agg_features_cols</span><span class="p">)</span>
<a id="__codelineno-22-120" name="__codelineno-22-120" href="#__codelineno-22-120"></a>
<a id="__codelineno-22-121" name="__codelineno-22-121" href="#__codelineno-22-121"></a>    <span class="c1"># print(feature_cols) </span>
<a id="__codelineno-22-122" name="__codelineno-22-122" href="#__codelineno-22-122"></a>    <span class="c1"># feature_cols = [&#39;speed_index&#39;, &#39;box_win_percent&#39;, &#39;RunTime_norm_min_28D&#39;, &#39;RunTime_norm_max_28D&#39;, &#39;RunTime_norm_mean_28D&#39;, &#39;RunTime_norm_median_28D&#39;, &#39;RunTime_norm_std_28D&#39;, &#39;SplitMargin_norm_min_28D&#39;, &#39;SplitMargin_norm_max_28D&#39;, &#39;SplitMargin_norm_mean_28D&#39;, &#39;SplitMargin_norm_median_28D&#39;, &#39;SplitMargin_norm_std_28D&#39;, &#39;Place_inv_min_28D&#39;, &#39;Place_inv_max_28D&#39;, &#39;Place_inv_mean_28D&#39;, &#39;Place_inv_median_28D&#39;, &#39;Place_inv_std_28D&#39;, &#39;Place_log_min_28D&#39;, &#39;Place_log_max_28D&#39;, &#39;Place_log_mean_28D&#39;, &#39;Place_log_median_28D&#39;, &#39;Place_log_std_28D&#39;, &#39;Prizemoney_norm_min_28D&#39;, &#39;Prizemoney_norm_max_28D&#39;, &#39;Prizemoney_norm_mean_28D&#39;, &#39;Prizemoney_norm_median_28D&#39;, &#39;Prizemoney_norm_std_28D&#39;, &#39;RunTime_norm_min_91D&#39;, &#39;RunTime_norm_max_91D&#39;, &#39;RunTime_norm_mean_91D&#39;, &#39;RunTime_norm_median_91D&#39;, &#39;RunTime_norm_std_91D&#39;, &#39;SplitMargin_norm_min_91D&#39;, &#39;SplitMargin_norm_max_91D&#39;, &#39;SplitMargin_norm_mean_91D&#39;, &#39;SplitMargin_norm_median_91D&#39;, &#39;SplitMargin_norm_std_91D&#39;, &#39;Place_inv_min_91D&#39;, &#39;Place_inv_max_91D&#39;, &#39;Place_inv_mean_91D&#39;, &#39;Place_inv_median_91D&#39;, &#39;Place_inv_std_91D&#39;, &#39;Place_log_min_91D&#39;, &#39;Place_log_max_91D&#39;, &#39;Place_log_mean_91D&#39;, &#39;Place_log_median_91D&#39;, &#39;Place_log_std_91D&#39;, &#39;Prizemoney_norm_min_91D&#39;, &#39;Prizemoney_norm_max_91D&#39;, &#39;Prizemoney_norm_mean_91D&#39;, &#39;Prizemoney_norm_median_91D&#39;, &#39;Prizemoney_norm_std_91D&#39;, &#39;RunTime_norm_min_365D&#39;, &#39;RunTime_norm_max_365D&#39;, &#39;RunTime_norm_mean_365D&#39;, &#39;RunTime_norm_median_365D&#39;, &#39;RunTime_norm_std_365D&#39;, &#39;SplitMargin_norm_min_365D&#39;, &#39;SplitMargin_norm_max_365D&#39;, &#39;SplitMargin_norm_mean_365D&#39;, &#39;SplitMargin_norm_median_365D&#39;, &#39;SplitMargin_norm_std_365D&#39;, &#39;Place_inv_min_365D&#39;, &#39;Place_inv_max_365D&#39;, &#39;Place_inv_mean_365D&#39;, &#39;Place_inv_median_365D&#39;, &#39;Place_inv_std_365D&#39;, &#39;Place_log_min_365D&#39;, &#39;Place_log_max_365D&#39;, &#39;Place_log_mean_365D&#39;, &#39;Place_log_median_365D&#39;, &#39;Place_log_std_365D&#39;, &#39;Prizemoney_norm_min_365D&#39;, &#39;Prizemoney_norm_max_365D&#39;, &#39;Prizemoney_norm_mean_365D&#39;, &#39;Prizemoney_norm_median_365D&#39;, &#39;Prizemoney_norm_std_365D&#39;]</span>
<a id="__codelineno-22-123" name="__codelineno-22-123" href="#__codelineno-22-123"></a>
<a id="__codelineno-22-124" name="__codelineno-22-124" href="#__codelineno-22-124"></a>    <span class="c1"># Replace missing values with 0</span>
<a id="__codelineno-22-125" name="__codelineno-22-125" href="#__codelineno-22-125"></a>    <span class="n">dataset</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-22-126" name="__codelineno-22-126" href="#__codelineno-22-126"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>
<a id="__codelineno-22-127" name="__codelineno-22-127" href="#__codelineno-22-127"></a>
<a id="__codelineno-22-128" name="__codelineno-22-128" href="#__codelineno-22-128"></a>    <span class="c1"># Only keep data after 2018-12-01</span>
<a id="__codelineno-22-129" name="__codelineno-22-129" href="#__codelineno-22-129"></a>    <span class="n">model_df</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<a id="__codelineno-22-130" name="__codelineno-22-130" href="#__codelineno-22-130"></a>    <span class="n">feature_cols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">feature_cols</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<a id="__codelineno-22-131" name="__codelineno-22-131" href="#__codelineno-22-131"></a>    <span class="n">model_df</span> <span class="o">=</span> <span class="n">model_df</span><span class="p">[</span><span class="n">model_df</span><span class="p">[</span><span class="s1">&#39;date_dt&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="s1">&#39;2018-12-01&#39;</span><span class="p">]</span>
<a id="__codelineno-22-132" name="__codelineno-22-132" href="#__codelineno-22-132"></a>
<a id="__codelineno-22-133" name="__codelineno-22-133" href="#__codelineno-22-133"></a>    <span class="c1"># This line was originally part of Bruno&#39;s tutorial, but we don&#39;t run it in this script</span>
<a id="__codelineno-22-134" name="__codelineno-22-134" href="#__codelineno-22-134"></a>    <span class="c1"># model_df = model_df[[&#39;date_dt&#39;, &#39;FastTrack_RaceId&#39;, &#39;DogName&#39;, &#39;win&#39;, &#39;StartPrice_probability&#39;] + feature_cols]</span>
<a id="__codelineno-22-135" name="__codelineno-22-135" href="#__codelineno-22-135"></a>
<a id="__codelineno-22-136" name="__codelineno-22-136" href="#__codelineno-22-136"></a>    <span class="c1"># Only train model off of races where each dog has a value for each feature</span>
<a id="__codelineno-22-137" name="__codelineno-22-137" href="#__codelineno-22-137"></a>    <span class="n">races_exclude</span> <span class="o">=</span> <span class="n">model_df</span><span class="p">[</span><span class="n">model_df</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)][</span><span class="s1">&#39;FastTrack_RaceId&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
<a id="__codelineno-22-138" name="__codelineno-22-138" href="#__codelineno-22-138"></a>    <span class="n">model_df</span> <span class="o">=</span> <span class="n">model_df</span><span class="p">[</span><span class="o">~</span><span class="n">model_df</span><span class="p">[</span><span class="s1">&#39;FastTrack_RaceId&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">races_exclude</span><span class="p">)]</span>
<a id="__codelineno-22-139" name="__codelineno-22-139" href="#__codelineno-22-139"></a>    <span class="n">model_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;../data/model_df.csv&#39;</span><span class="p">)</span>  <span class="c1"># Save data for part_4</span>
<a id="__codelineno-22-140" name="__codelineno-22-140" href="#__codelineno-22-140"></a>
<a id="__codelineno-22-141" name="__codelineno-22-141" href="#__codelineno-22-141"></a>    <span class="c1"># Select todays data and prepare data for easy reference in flumine</span>
<a id="__codelineno-22-142" name="__codelineno-22-142" href="#__codelineno-22-142"></a>    <span class="n">todays_data</span> <span class="o">=</span> <span class="n">model_df</span><span class="p">[</span><span class="n">model_df</span><span class="p">[</span><span class="s1">&#39;date_dt&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)]</span>
<a id="__codelineno-22-143" name="__codelineno-22-143" href="#__codelineno-22-143"></a>    <span class="n">todays_data</span><span class="p">[</span><span class="s1">&#39;DogName_bf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">todays_data</span><span class="p">[</span><span class="s1">&#39;DogName&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Res&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
<a id="__codelineno-22-144" name="__codelineno-22-144" href="#__codelineno-22-144"></a>    <span class="n">final_data</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;Sandown (SAP)&#39;</span><span class="p">,</span><span class="s1">&#39;Sandown Park&#39;</span><span class="p">,</span><span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-22-145" name="__codelineno-22-145" href="#__codelineno-22-145"></a>    <span class="n">final_data</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;Murray Bridge (MBR)&#39;</span><span class="p">,</span><span class="s1">&#39;Murray Bridge&#39;</span><span class="p">,</span><span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-22-146" name="__codelineno-22-146" href="#__codelineno-22-146"></a>    <span class="n">todays_data</span> <span class="o">=</span> <span class="n">todays_data</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;DogName_bf&#39;</span><span class="p">,</span><span class="s1">&#39;Track&#39;</span><span class="p">,</span><span class="s1">&#39;RaceNum&#39;</span><span class="p">])</span>
<a id="__codelineno-22-147" name="__codelineno-22-147" href="#__codelineno-22-147"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">todays_data</span><span class="p">)</span>
<a id="__codelineno-22-148" name="__codelineno-22-148" href="#__codelineno-22-148"></a>
<a id="__codelineno-22-149" name="__codelineno-22-149" href="#__codelineno-22-149"></a>    <span class="n">todays_data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;../data/todays_data.csv&#39;</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p><a href="https://github.com/betfair-down-under/autoHubTutorials/tree/master/howToAutomate/how_to_automate_IV">Download from Github</a></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a>    <span class="c1"># Import libraries for logging in</span>
<a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a>    <span class="kn">import</span> <span class="nn">betfairlightweight</span>
<a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a>    <span class="kn">from</span> <span class="nn">flumine</span> <span class="kn">import</span> <span class="n">Flumine</span><span class="p">,</span> <span class="n">clients</span>
<a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a>
<a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a>    <span class="c1"># Credentials to login and logging in </span>
<a id="__codelineno-23-6" name="__codelineno-23-6" href="#__codelineno-23-6"></a>    <span class="n">trading</span> <span class="o">=</span> <span class="n">betfairlightweight</span><span class="o">.</span><span class="n">APIClient</span><span class="p">(</span><span class="s1">&#39;Username&#39;</span><span class="p">,</span><span class="s1">&#39;Password&#39;</span><span class="p">,</span><span class="n">app_key</span><span class="o">=</span><span class="s1">&#39;Appkey&#39;</span><span class="p">)</span>
<a id="__codelineno-23-7" name="__codelineno-23-7" href="#__codelineno-23-7"></a>    <span class="n">client</span> <span class="o">=</span> <span class="n">clients</span><span class="o">.</span><span class="n">BetfairClient</span><span class="p">(</span><span class="n">trading</span><span class="p">,</span> <span class="n">interactive_login</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-23-8" name="__codelineno-23-8" href="#__codelineno-23-8"></a>
<a id="__codelineno-23-9" name="__codelineno-23-9" href="#__codelineno-23-9"></a>    <span class="c1"># Login</span>
<a id="__codelineno-23-10" name="__codelineno-23-10" href="#__codelineno-23-10"></a>    <span class="n">framework</span> <span class="o">=</span> <span class="n">Flumine</span><span class="p">(</span><span class="n">client</span><span class="o">=</span><span class="n">client</span><span class="p">)</span>
<a id="__codelineno-23-11" name="__codelineno-23-11" href="#__codelineno-23-11"></a>
<a id="__codelineno-23-12" name="__codelineno-23-12" href="#__codelineno-23-12"></a>    <span class="c1"># Code to login when using security certificates</span>
<a id="__codelineno-23-13" name="__codelineno-23-13" href="#__codelineno-23-13"></a>    <span class="c1"># trading = betfairlightweight.APIClient(&#39;username&#39;,&#39;password&#39;,app_key=&#39;appkey&#39;, certs=r&#39;C:\Users\zhoui\openssl_certs&#39;)</span>
<a id="__codelineno-23-14" name="__codelineno-23-14" href="#__codelineno-23-14"></a>    <span class="c1"># client = clients.BetfairClient(trading)</span>
<a id="__codelineno-23-15" name="__codelineno-23-15" href="#__codelineno-23-15"></a>
<a id="__codelineno-23-16" name="__codelineno-23-16" href="#__codelineno-23-16"></a>    <span class="c1"># framework = Flumine(client=client)</span>
<a id="__codelineno-23-17" name="__codelineno-23-17" href="#__codelineno-23-17"></a>
<a id="__codelineno-23-18" name="__codelineno-23-18" href="#__codelineno-23-18"></a>    <span class="c1"># Import libraries and logging</span>
<a id="__codelineno-23-19" name="__codelineno-23-19" href="#__codelineno-23-19"></a>    <span class="kn">from</span> <span class="nn">flumine</span> <span class="kn">import</span> <span class="n">BaseStrategy</span> 
<a id="__codelineno-23-20" name="__codelineno-23-20" href="#__codelineno-23-20"></a>    <span class="kn">from</span> <span class="nn">flumine.order.trade</span> <span class="kn">import</span> <span class="n">Trade</span>
<a id="__codelineno-23-21" name="__codelineno-23-21" href="#__codelineno-23-21"></a>    <span class="kn">from</span> <span class="nn">flumine.order.order</span> <span class="kn">import</span> <span class="n">LimitOrder</span>
<a id="__codelineno-23-22" name="__codelineno-23-22" href="#__codelineno-23-22"></a>    <span class="kn">from</span> <span class="nn">flumine.markets.market</span> <span class="kn">import</span> <span class="n">Market</span>
<a id="__codelineno-23-23" name="__codelineno-23-23" href="#__codelineno-23-23"></a>    <span class="kn">from</span> <span class="nn">betfairlightweight.filters</span> <span class="kn">import</span> <span class="n">streaming_market_filter</span>
<a id="__codelineno-23-24" name="__codelineno-23-24" href="#__codelineno-23-24"></a>    <span class="kn">from</span> <span class="nn">betfairlightweight.resources</span> <span class="kn">import</span> <span class="n">MarketBook</span>
<a id="__codelineno-23-25" name="__codelineno-23-25" href="#__codelineno-23-25"></a>    <span class="kn">import</span> <span class="nn">re</span>
<a id="__codelineno-23-26" name="__codelineno-23-26" href="#__codelineno-23-26"></a>    <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<a id="__codelineno-23-27" name="__codelineno-23-27" href="#__codelineno-23-27"></a>    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<a id="__codelineno-23-28" name="__codelineno-23-28" href="#__codelineno-23-28"></a>    <span class="kn">import</span> <span class="nn">datetime</span>
<a id="__codelineno-23-29" name="__codelineno-23-29" href="#__codelineno-23-29"></a>    <span class="kn">import</span> <span class="nn">logging</span>
<a id="__codelineno-23-30" name="__codelineno-23-30" href="#__codelineno-23-30"></a>    <span class="kn">from</span> <span class="nn">nltk.tokenize</span> <span class="kn">import</span> <span class="n">regexp_tokenize</span>
<a id="__codelineno-23-31" name="__codelineno-23-31" href="#__codelineno-23-31"></a>    <span class="kn">from</span> <span class="nn">joblib</span> <span class="kn">import</span> <span class="n">load</span>
<a id="__codelineno-23-32" name="__codelineno-23-32" href="#__codelineno-23-32"></a>
<a id="__codelineno-23-33" name="__codelineno-23-33" href="#__codelineno-23-33"></a>    <span class="c1"># read in model and DataFrames</span>
<a id="__codelineno-23-34" name="__codelineno-23-34" href="#__codelineno-23-34"></a>    <span class="n">todays_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;D:\FastTrack_data\todays_data.csv&#39;</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;DogName_bf&#39;</span><span class="p">,</span><span class="s1">&#39;Track&#39;</span><span class="p">,</span><span class="s1">&#39;RaceNum&#39;</span><span class="p">])</span>
<a id="__codelineno-23-35" name="__codelineno-23-35" href="#__codelineno-23-35"></a>    <span class="n">box_win_percentages</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;D:\FastTrack_data\box_win_percentage.csv&#39;</span><span class="p">)</span>
<a id="__codelineno-23-36" name="__codelineno-23-36" href="#__codelineno-23-36"></a>    <span class="n">brunos_model</span> <span class="o">=</span> <span class="n">load</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;C:\Users\Ivan\Documents\GitHub\How-to-Automate-Public-Version\how_to_automate_IV\logistic_regression.joblib&#39;</span><span class="p">)</span>
<a id="__codelineno-23-37" name="__codelineno-23-37" href="#__codelineno-23-37"></a>    <span class="n">feature_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;speed_index&#39;</span><span class="p">,</span> <span class="s1">&#39;box_win_percent&#39;</span><span class="p">,</span> <span class="s1">&#39;RunTime_norm_min_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;RunTime_norm_max_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;RunTime_norm_mean_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;RunTime_norm_median_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;RunTime_norm_std_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;SplitMargin_norm_min_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;SplitMargin_norm_max_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;SplitMargin_norm_mean_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;SplitMargin_norm_median_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;SplitMargin_norm_std_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_inv_min_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_inv_max_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_inv_mean_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_inv_median_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_inv_std_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_log_min_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_log_max_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_log_mean_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_log_median_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_log_std_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;Prizemoney_norm_min_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;Prizemoney_norm_max_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;Prizemoney_norm_mean_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;Prizemoney_norm_median_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;Prizemoney_norm_std_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;RunTime_norm_min_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;RunTime_norm_max_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;RunTime_norm_mean_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;RunTime_norm_median_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;RunTime_norm_std_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;SplitMargin_norm_min_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;SplitMargin_norm_max_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;SplitMargin_norm_mean_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;SplitMargin_norm_median_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;SplitMargin_norm_std_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_inv_min_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_inv_max_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_inv_mean_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_inv_median_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_inv_std_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_log_min_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_log_max_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_log_mean_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_log_median_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_log_std_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;Prizemoney_norm_min_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;Prizemoney_norm_max_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;Prizemoney_norm_mean_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;Prizemoney_norm_median_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;Prizemoney_norm_std_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;RunTime_norm_min_365D&#39;</span><span class="p">,</span> <span class="s1">&#39;RunTime_norm_max_365D&#39;</span><span class="p">,</span> <span class="s1">&#39;RunTime_norm_mean_365D&#39;</span><span class="p">,</span> <span class="s1">&#39;RunTime_norm_median_365D&#39;</span><span class="p">,</span> <span class="s1">&#39;RunTime_norm_std_365D&#39;</span><span class="p">,</span> <span class="s1">&#39;SplitMargin_norm_min_365D&#39;</span><span class="p">,</span> <span class="s1">&#39;SplitMargin_norm_max_365D&#39;</span><span class="p">,</span> <span class="s1">&#39;SplitMargin_norm_mean_365D&#39;</span><span class="p">,</span> <span class="s1">&#39;SplitMargin_norm_median_365D&#39;</span><span class="p">,</span> <span class="s1">&#39;SplitMargin_norm_std_365D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_inv_min_365D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_inv_max_365D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_inv_mean_365D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_inv_median_365D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_inv_std_365D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_log_min_365D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_log_max_365D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_log_mean_365D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_log_median_365D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_log_std_365D&#39;</span><span class="p">,</span> <span class="s1">&#39;Prizemoney_norm_min_365D&#39;</span><span class="p">,</span> <span class="s1">&#39;Prizemoney_norm_max_365D&#39;</span><span class="p">,</span> <span class="s1">&#39;Prizemoney_norm_mean_365D&#39;</span><span class="p">,</span> <span class="s1">&#39;Prizemoney_norm_median_365D&#39;</span><span class="p">,</span> <span class="s1">&#39;Prizemoney_norm_std_365D&#39;</span><span class="p">]</span>
<a id="__codelineno-23-38" name="__codelineno-23-38" href="#__codelineno-23-38"></a>    <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;how_to_automate_4.log&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1">:</span><span class="si">%(levelname)s</span><span class="s1">:</span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-23-39" name="__codelineno-23-39" href="#__codelineno-23-39"></a>
<a id="__codelineno-23-40" name="__codelineno-23-40" href="#__codelineno-23-40"></a>    <span class="k">class</span> <span class="nc">FlatBetting</span><span class="p">(</span><span class="n">BaseStrategy</span><span class="p">):</span>
<a id="__codelineno-23-41" name="__codelineno-23-41" href="#__codelineno-23-41"></a>        <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-23-42" name="__codelineno-23-42" href="#__codelineno-23-42"></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;starting strategy &#39;FlatBetting&#39; using the model we created the Greyhound modelling in Python Tutorial&quot;</span><span class="p">)</span>
<a id="__codelineno-23-43" name="__codelineno-23-43" href="#__codelineno-23-43"></a>
<a id="__codelineno-23-44" name="__codelineno-23-44" href="#__codelineno-23-44"></a>        <span class="k">def</span> <span class="nf">check_market_book</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">market</span><span class="p">:</span> <span class="n">Market</span><span class="p">,</span> <span class="n">market_book</span><span class="p">:</span> <span class="n">MarketBook</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-23-45" name="__codelineno-23-45" href="#__codelineno-23-45"></a>            <span class="k">if</span> <span class="n">market_book</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="s2">&quot;CLOSED&quot;</span><span class="p">:</span>
<a id="__codelineno-23-46" name="__codelineno-23-46" href="#__codelineno-23-46"></a>                <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-23-47" name="__codelineno-23-47" href="#__codelineno-23-47"></a>
<a id="__codelineno-23-48" name="__codelineno-23-48" href="#__codelineno-23-48"></a>        <span class="k">def</span> <span class="nf">process_market_book</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">market</span><span class="p">:</span> <span class="n">Market</span><span class="p">,</span> <span class="n">market_book</span><span class="p">:</span> <span class="n">MarketBook</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-23-49" name="__codelineno-23-49" href="#__codelineno-23-49"></a>            <span class="c1"># Convert dataframe to a global variable</span>
<a id="__codelineno-23-50" name="__codelineno-23-50" href="#__codelineno-23-50"></a>            <span class="k">global</span> <span class="n">todays_data</span>
<a id="__codelineno-23-51" name="__codelineno-23-51" href="#__codelineno-23-51"></a>
<a id="__codelineno-23-52" name="__codelineno-23-52" href="#__codelineno-23-52"></a>            <span class="c1"># At the 60 second mark:</span>
<a id="__codelineno-23-53" name="__codelineno-23-53" href="#__codelineno-23-53"></a>            <span class="k">if</span> <span class="n">market</span><span class="o">.</span><span class="n">seconds_to_start</span> <span class="o">&lt;</span> <span class="mi">60</span> <span class="ow">and</span> <span class="n">market_book</span><span class="o">.</span><span class="n">inplay</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
<a id="__codelineno-23-54" name="__codelineno-23-54" href="#__codelineno-23-54"></a>                <span class="c1"># get the list of dog_names, name of the track/venue and race_number/RaceNum from Betfair Polling API</span>
<a id="__codelineno-23-55" name="__codelineno-23-55" href="#__codelineno-23-55"></a>                <span class="n">dog_names</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-23-56" name="__codelineno-23-56" href="#__codelineno-23-56"></a>                <span class="n">track</span> <span class="o">=</span> <span class="n">market</span><span class="o">.</span><span class="n">market_catalogue</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">venue</span>
<a id="__codelineno-23-57" name="__codelineno-23-57" href="#__codelineno-23-57"></a>                <span class="n">race_number</span> <span class="o">=</span> <span class="n">market</span><span class="o">.</span><span class="n">market_catalogue</span><span class="o">.</span><span class="n">market_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># comes out as R1/R2/R3 .. etc</span>
<a id="__codelineno-23-58" name="__codelineno-23-58" href="#__codelineno-23-58"></a>                <span class="n">race_number</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;[^0-9]&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">race_number</span><span class="p">)</span>  <span class="c1"># only keep the numbers </span>
<a id="__codelineno-23-59" name="__codelineno-23-59" href="#__codelineno-23-59"></a>                <span class="n">race_number</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">race_number</span><span class="p">)</span>
<a id="__codelineno-23-60" name="__codelineno-23-60" href="#__codelineno-23-60"></a>                <span class="k">for</span> <span class="n">runner_cata</span> <span class="ow">in</span> <span class="n">market</span><span class="o">.</span><span class="n">market_catalogue</span><span class="o">.</span><span class="n">runners</span><span class="p">:</span>
<a id="__codelineno-23-61" name="__codelineno-23-61" href="#__codelineno-23-61"></a>                    <span class="n">dog_name</span> <span class="o">=</span> <span class="n">runner_cata</span><span class="o">.</span><span class="n">runner_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
<a id="__codelineno-23-62" name="__codelineno-23-62" href="#__codelineno-23-62"></a>                    <span class="n">dog_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dog_name</span><span class="p">)</span>
<a id="__codelineno-23-63" name="__codelineno-23-63" href="#__codelineno-23-63"></a>
<a id="__codelineno-23-64" name="__codelineno-23-64" href="#__codelineno-23-64"></a>                <span class="c1"># Check if there are box changes, if there are then use Brett&#39;s code</span>
<a id="__codelineno-23-65" name="__codelineno-23-65" href="#__codelineno-23-65"></a>                <span class="k">if</span> <span class="n">market</span><span class="o">.</span><span class="n">market_catalogue</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">clarifications</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-23-66" name="__codelineno-23-66" href="#__codelineno-23-66"></a>                    <span class="c1"># Brett&#39;s code to get Box changes:</span>
<a id="__codelineno-23-67" name="__codelineno-23-67" href="#__codelineno-23-67"></a>                    <span class="n">my_string</span> <span class="o">=</span> <span class="n">market</span><span class="o">.</span><span class="n">market_catalogue</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">clarifications</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;br&gt; Dog&quot;</span><span class="p">,</span><span class="s2">&quot;&lt;br&gt;Dog&quot;</span><span class="p">)</span>
<a id="__codelineno-23-68" name="__codelineno-23-68" href="#__codelineno-23-68"></a>                    <span class="n">pattern1</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;(?&lt;=&lt;br&gt;Dog ).+?(?= starts)&#39;</span>
<a id="__codelineno-23-69" name="__codelineno-23-69" href="#__codelineno-23-69"></a>                    <span class="n">pattern2</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;(?&lt;=\bbox no. )(\w+)&quot;</span>
<a id="__codelineno-23-70" name="__codelineno-23-70" href="#__codelineno-23-70"></a>                    <span class="n">runners_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="p">(</span><span class="n">regexp_tokenize</span><span class="p">(</span><span class="n">my_string</span><span class="p">,</span> <span class="n">pattern1</span><span class="p">),</span> <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;runner_name&#39;</span><span class="p">])</span>
<a id="__codelineno-23-71" name="__codelineno-23-71" href="#__codelineno-23-71"></a>                    <span class="n">runners_df</span><span class="p">[</span><span class="s1">&#39;runner_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">runners_df</span><span class="p">[</span><span class="s1">&#39;runner_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
<a id="__codelineno-23-72" name="__codelineno-23-72" href="#__codelineno-23-72"></a>                    <span class="c1"># Remove dog name from runner_number</span>
<a id="__codelineno-23-73" name="__codelineno-23-73" href="#__codelineno-23-73"></a>                    <span class="n">runners_df</span><span class="p">[</span><span class="s1">&#39;runner_number&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">runners_df</span><span class="p">[</span><span class="s1">&#39;runner_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[:(</span><span class="n">x</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
<a id="__codelineno-23-74" name="__codelineno-23-74" href="#__codelineno-23-74"></a>                    <span class="c1"># Remove dog number from runner_name</span>
<a id="__codelineno-23-75" name="__codelineno-23-75" href="#__codelineno-23-75"></a>                    <span class="n">runners_df</span><span class="p">[</span><span class="s1">&#39;runner_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">runners_df</span><span class="p">[</span><span class="s1">&#39;runner_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[(</span><span class="n">x</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):]</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
<a id="__codelineno-23-76" name="__codelineno-23-76" href="#__codelineno-23-76"></a>                    <span class="n">runners_df</span><span class="p">[</span><span class="s1">&#39;Box&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">regexp_tokenize</span><span class="p">(</span><span class="n">my_string</span><span class="p">,</span> <span class="n">pattern2</span><span class="p">)</span>
<a id="__codelineno-23-77" name="__codelineno-23-77" href="#__codelineno-23-77"></a>
<a id="__codelineno-23-78" name="__codelineno-23-78" href="#__codelineno-23-78"></a>                    <span class="c1"># Replace any old Box info in our original dataframe with data available in runners_df</span>
<a id="__codelineno-23-79" name="__codelineno-23-79" href="#__codelineno-23-79"></a>                    <span class="n">runners_df</span> <span class="o">=</span> <span class="n">runners_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;runner_name&#39;</span><span class="p">)</span>
<a id="__codelineno-23-80" name="__codelineno-23-80" href="#__codelineno-23-80"></a>                    <span class="n">todays_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">runners_df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">runners_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">dog_names</span><span class="p">)],</span><span class="n">track</span><span class="p">,</span><span class="n">race_number</span><span class="p">),</span><span class="s1">&#39;Box&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">runners_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">runners_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">dog_names</span><span class="p">),</span><span class="s1">&#39;Box&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
<a id="__codelineno-23-81" name="__codelineno-23-81" href="#__codelineno-23-81"></a>                    <span class="c1"># Merge box_win_percentage back on:</span>
<a id="__codelineno-23-82" name="__codelineno-23-82" href="#__codelineno-23-82"></a>                    <span class="n">todays_data</span> <span class="o">=</span> <span class="n">todays_data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="s1">&#39;box_win_percentage&#39;</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-23-83" name="__codelineno-23-83" href="#__codelineno-23-83"></a>                    <span class="n">todays_data</span> <span class="o">=</span> <span class="n">todays_data</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">box_win_percent</span><span class="p">,</span> <span class="n">on</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Track&#39;</span><span class="p">,</span> <span class="s1">&#39;Distance&#39;</span><span class="p">,</span><span class="s1">&#39;Box&#39;</span><span class="p">],</span> <span class="n">how</span> <span class="o">=</span> <span class="s1">&#39;left&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;DogName_bf&#39;</span><span class="p">,</span><span class="s1">&#39;Track&#39;</span><span class="p">,</span><span class="s1">&#39;RaceNum&#39;</span><span class="p">])</span>
<a id="__codelineno-23-84" name="__codelineno-23-84" href="#__codelineno-23-84"></a>
<a id="__codelineno-23-85" name="__codelineno-23-85" href="#__codelineno-23-85"></a>                <span class="c1"># Generate probabilities using Bruno&#39;s model</span>
<a id="__codelineno-23-86" name="__codelineno-23-86" href="#__codelineno-23-86"></a>                <span class="n">todays_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">dog_names</span><span class="p">,</span><span class="n">track</span><span class="p">,</span><span class="n">race_number</span><span class="p">),</span><span class="s1">&#39;prob_LogisticRegression&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">brunos_model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">todays_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">dog_names</span><span class="p">,</span><span class="n">track</span><span class="p">,</span><span class="n">race_number</span><span class="p">)][</span><span class="n">feature_cols</span><span class="p">])[:,</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-23-87" name="__codelineno-23-87" href="#__codelineno-23-87"></a>                <span class="c1"># renomalise probabilities</span>
<a id="__codelineno-23-88" name="__codelineno-23-88" href="#__codelineno-23-88"></a>                <span class="n">probabilities</span> <span class="o">=</span> <span class="n">todays_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dog_names</span><span class="p">,</span><span class="n">track</span><span class="p">,</span><span class="n">race_number</span><span class="p">][</span><span class="s1">&#39;prob_LogisticRegression&#39;</span><span class="p">]</span>
<a id="__codelineno-23-89" name="__codelineno-23-89" href="#__codelineno-23-89"></a>                <span class="n">todays_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">dog_names</span><span class="p">,</span><span class="n">track</span><span class="p">,</span><span class="n">race_number</span><span class="p">),</span><span class="s1">&#39;renormalised_prob&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">probabilities</span><span class="o">/</span><span class="n">probabilities</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<a id="__codelineno-23-90" name="__codelineno-23-90" href="#__codelineno-23-90"></a>                <span class="c1"># convert probaiblities to ratings</span>
<a id="__codelineno-23-91" name="__codelineno-23-91" href="#__codelineno-23-91"></a>                <span class="n">todays_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">dog_names</span><span class="p">,</span><span class="n">track</span><span class="p">,</span><span class="n">race_number</span><span class="p">),</span><span class="s1">&#39;rating&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">todays_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dog_names</span><span class="p">,</span><span class="n">track</span><span class="p">,</span><span class="n">race_number</span><span class="p">][</span><span class="s1">&#39;renormalised_prob&#39;</span><span class="p">]</span>
<a id="__codelineno-23-92" name="__codelineno-23-92" href="#__codelineno-23-92"></a>
<a id="__codelineno-23-93" name="__codelineno-23-93" href="#__codelineno-23-93"></a>                <span class="c1"># Use both the polling api (market.catalogue) and the streaming api at once:</span>
<a id="__codelineno-23-94" name="__codelineno-23-94" href="#__codelineno-23-94"></a>                <span class="k">for</span> <span class="n">runner_cata</span><span class="p">,</span> <span class="n">runner</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">market</span><span class="o">.</span><span class="n">market_catalogue</span><span class="o">.</span><span class="n">runners</span><span class="p">,</span> <span class="n">market_book</span><span class="o">.</span><span class="n">runners</span><span class="p">):</span>
<a id="__codelineno-23-95" name="__codelineno-23-95" href="#__codelineno-23-95"></a>                    <span class="c1"># Check the polling api and streaming api matches up (sometimes it doesn&#39;t)</span>
<a id="__codelineno-23-96" name="__codelineno-23-96" href="#__codelineno-23-96"></a>                    <span class="k">if</span> <span class="n">runner_cata</span><span class="o">.</span><span class="n">selection_id</span> <span class="o">==</span> <span class="n">runner</span><span class="o">.</span><span class="n">selection_id</span><span class="p">:</span>
<a id="__codelineno-23-97" name="__codelineno-23-97" href="#__codelineno-23-97"></a>                        <span class="c1"># Get the dog_name from polling api then reference our data for our model rating</span>
<a id="__codelineno-23-98" name="__codelineno-23-98" href="#__codelineno-23-98"></a>                        <span class="n">dog_name</span> <span class="o">=</span> <span class="n">runner_cata</span><span class="o">.</span><span class="n">runner_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
<a id="__codelineno-23-99" name="__codelineno-23-99" href="#__codelineno-23-99"></a>
<a id="__codelineno-23-100" name="__codelineno-23-100" href="#__codelineno-23-100"></a>                        <span class="c1"># Rest is the same as How to Automate III</span>
<a id="__codelineno-23-101" name="__codelineno-23-101" href="#__codelineno-23-101"></a>                        <span class="n">model_price</span> <span class="o">=</span> <span class="n">todays_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dog_name</span><span class="p">,</span><span class="n">track</span><span class="p">,</span><span class="n">race_number</span><span class="p">][</span><span class="s1">&#39;rating&#39;</span><span class="p">]</span>
<a id="__codelineno-23-102" name="__codelineno-23-102" href="#__codelineno-23-102"></a>                        <span class="c1">### If you have an issue such as:</span>
<a id="__codelineno-23-103" name="__codelineno-23-103" href="#__codelineno-23-103"></a>                            <span class="c1"># Unknown error The truth value of a Series is ambiguous. Use a.empty, a.bool(), a.item(), a.any() or a.all().</span>
<a id="__codelineno-23-104" name="__codelineno-23-104" href="#__codelineno-23-104"></a>                            <span class="c1"># Then do model_price = todays_data.loc[dog_name,track,race_number][&#39;rating&#39;].item()</span>
<a id="__codelineno-23-105" name="__codelineno-23-105" href="#__codelineno-23-105"></a>
<a id="__codelineno-23-106" name="__codelineno-23-106" href="#__codelineno-23-106"></a>                        <span class="c1"># Log info before placing bets</span>
<a id="__codelineno-23-107" name="__codelineno-23-107" href="#__codelineno-23-107"></a>                        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;dog_name: </span><span class="si">{</span><span class="n">dog_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-23-108" name="__codelineno-23-108" href="#__codelineno-23-108"></a>                        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;model_price: </span><span class="si">{</span><span class="n">model_price</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-23-109" name="__codelineno-23-109" href="#__codelineno-23-109"></a>                        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;market_id: </span><span class="si">{</span><span class="n">market_book</span><span class="o">.</span><span class="n">market_id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-23-110" name="__codelineno-23-110" href="#__codelineno-23-110"></a>                        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;selection_id: </span><span class="si">{</span><span class="n">runner</span><span class="o">.</span><span class="n">selection_id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-23-111" name="__codelineno-23-111" href="#__codelineno-23-111"></a>
<a id="__codelineno-23-112" name="__codelineno-23-112" href="#__codelineno-23-112"></a>                        <span class="c1"># If best available to back price is &gt; rated price then flat $5 back</span>
<a id="__codelineno-23-113" name="__codelineno-23-113" href="#__codelineno-23-113"></a>                        <span class="k">if</span> <span class="n">runner</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;ACTIVE&quot;</span> <span class="ow">and</span> <span class="n">runner</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">available_to_back</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;price&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">model_price</span><span class="p">:</span>
<a id="__codelineno-23-114" name="__codelineno-23-114" href="#__codelineno-23-114"></a>                            <span class="n">trade</span> <span class="o">=</span> <span class="n">Trade</span><span class="p">(</span>
<a id="__codelineno-23-115" name="__codelineno-23-115" href="#__codelineno-23-115"></a>                            <span class="n">market_id</span><span class="o">=</span><span class="n">market_book</span><span class="o">.</span><span class="n">market_id</span><span class="p">,</span>
<a id="__codelineno-23-116" name="__codelineno-23-116" href="#__codelineno-23-116"></a>                            <span class="n">selection_id</span><span class="o">=</span><span class="n">runner</span><span class="o">.</span><span class="n">selection_id</span><span class="p">,</span>
<a id="__codelineno-23-117" name="__codelineno-23-117" href="#__codelineno-23-117"></a>                            <span class="n">handicap</span><span class="o">=</span><span class="n">runner</span><span class="o">.</span><span class="n">handicap</span><span class="p">,</span>
<a id="__codelineno-23-118" name="__codelineno-23-118" href="#__codelineno-23-118"></a>                            <span class="n">strategy</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-23-119" name="__codelineno-23-119" href="#__codelineno-23-119"></a>                            <span class="p">)</span>
<a id="__codelineno-23-120" name="__codelineno-23-120" href="#__codelineno-23-120"></a>                            <span class="n">order</span> <span class="o">=</span> <span class="n">trade</span><span class="o">.</span><span class="n">create_order</span><span class="p">(</span>
<a id="__codelineno-23-121" name="__codelineno-23-121" href="#__codelineno-23-121"></a>                                <span class="n">side</span><span class="o">=</span><span class="s2">&quot;BACK&quot;</span><span class="p">,</span> <span class="n">order_type</span><span class="o">=</span><span class="n">LimitOrder</span><span class="p">(</span><span class="n">price</span><span class="o">=</span><span class="n">runner</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">available_to_back</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;price&#39;</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="mf">5.00</span><span class="p">)</span>
<a id="__codelineno-23-122" name="__codelineno-23-122" href="#__codelineno-23-122"></a>                            <span class="p">)</span>
<a id="__codelineno-23-123" name="__codelineno-23-123" href="#__codelineno-23-123"></a>                            <span class="n">market</span><span class="o">.</span><span class="n">place_order</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
<a id="__codelineno-23-124" name="__codelineno-23-124" href="#__codelineno-23-124"></a>                        <span class="c1"># If best available to lay price is &lt; rated price then flat $5 lay</span>
<a id="__codelineno-23-125" name="__codelineno-23-125" href="#__codelineno-23-125"></a>                        <span class="k">if</span> <span class="n">runner</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;ACTIVE&quot;</span> <span class="ow">and</span> <span class="n">runner</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">available_to_lay</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;price&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">model_price</span><span class="p">:</span>
<a id="__codelineno-23-126" name="__codelineno-23-126" href="#__codelineno-23-126"></a>                            <span class="n">trade</span> <span class="o">=</span> <span class="n">Trade</span><span class="p">(</span>
<a id="__codelineno-23-127" name="__codelineno-23-127" href="#__codelineno-23-127"></a>                            <span class="n">market_id</span><span class="o">=</span><span class="n">market_book</span><span class="o">.</span><span class="n">market_id</span><span class="p">,</span>
<a id="__codelineno-23-128" name="__codelineno-23-128" href="#__codelineno-23-128"></a>                            <span class="n">selection_id</span><span class="o">=</span><span class="n">runner</span><span class="o">.</span><span class="n">selection_id</span><span class="p">,</span>
<a id="__codelineno-23-129" name="__codelineno-23-129" href="#__codelineno-23-129"></a>                            <span class="n">handicap</span><span class="o">=</span><span class="n">runner</span><span class="o">.</span><span class="n">handicap</span><span class="p">,</span>
<a id="__codelineno-23-130" name="__codelineno-23-130" href="#__codelineno-23-130"></a>                            <span class="n">strategy</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-23-131" name="__codelineno-23-131" href="#__codelineno-23-131"></a>                            <span class="p">)</span>
<a id="__codelineno-23-132" name="__codelineno-23-132" href="#__codelineno-23-132"></a>                            <span class="n">order</span> <span class="o">=</span> <span class="n">trade</span><span class="o">.</span><span class="n">create_order</span><span class="p">(</span>
<a id="__codelineno-23-133" name="__codelineno-23-133" href="#__codelineno-23-133"></a>                                <span class="n">side</span><span class="o">=</span><span class="s2">&quot;LAY&quot;</span><span class="p">,</span> <span class="n">order_type</span><span class="o">=</span><span class="n">LimitOrder</span><span class="p">(</span><span class="n">price</span><span class="o">=</span><span class="n">runner</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">available_to_lay</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;price&#39;</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="mf">5.00</span><span class="p">)</span>
<a id="__codelineno-23-134" name="__codelineno-23-134" href="#__codelineno-23-134"></a>                            <span class="p">)</span>
<a id="__codelineno-23-135" name="__codelineno-23-135" href="#__codelineno-23-135"></a>                            <span class="n">market</span><span class="o">.</span><span class="n">place_order</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
<a id="__codelineno-23-136" name="__codelineno-23-136" href="#__codelineno-23-136"></a>
<a id="__codelineno-23-137" name="__codelineno-23-137" href="#__codelineno-23-137"></a>    <span class="n">greyhounds_strategy</span> <span class="o">=</span> <span class="n">FlatBetting</span><span class="p">(</span>
<a id="__codelineno-23-138" name="__codelineno-23-138" href="#__codelineno-23-138"></a>        <span class="n">market_filter</span><span class="o">=</span><span class="n">streaming_market_filter</span><span class="p">(</span>
<a id="__codelineno-23-139" name="__codelineno-23-139" href="#__codelineno-23-139"></a>            <span class="n">event_type_ids</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;4339&quot;</span><span class="p">],</span> <span class="c1"># Greyhounds markets</span>
<a id="__codelineno-23-140" name="__codelineno-23-140" href="#__codelineno-23-140"></a>            <span class="n">country_codes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;AU&quot;</span><span class="p">],</span> <span class="c1"># Australian markets</span>
<a id="__codelineno-23-141" name="__codelineno-23-141" href="#__codelineno-23-141"></a>            <span class="n">market_types</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;WIN&quot;</span><span class="p">],</span> <span class="c1"># Win markets</span>
<a id="__codelineno-23-142" name="__codelineno-23-142" href="#__codelineno-23-142"></a>        <span class="p">),</span>
<a id="__codelineno-23-143" name="__codelineno-23-143" href="#__codelineno-23-143"></a>        <span class="n">max_order_exposure</span><span class="o">=</span> <span class="mi">50</span><span class="p">,</span> <span class="c1"># Max exposure per order = 50</span>
<a id="__codelineno-23-144" name="__codelineno-23-144" href="#__codelineno-23-144"></a>        <span class="n">max_trade_count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="c1"># Max 1 trade per selection</span>
<a id="__codelineno-23-145" name="__codelineno-23-145" href="#__codelineno-23-145"></a>        <span class="n">max_live_trade_count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="c1"># Max 1 unmatched trade per selection</span>
<a id="__codelineno-23-146" name="__codelineno-23-146" href="#__codelineno-23-146"></a>    <span class="p">)</span>
<a id="__codelineno-23-147" name="__codelineno-23-147" href="#__codelineno-23-147"></a>
<a id="__codelineno-23-148" name="__codelineno-23-148" href="#__codelineno-23-148"></a>    <span class="n">framework</span><span class="o">.</span><span class="n">add_strategy</span><span class="p">(</span><span class="n">greyhounds_strategy</span><span class="p">)</span>
<a id="__codelineno-23-149" name="__codelineno-23-149" href="#__codelineno-23-149"></a>
<a id="__codelineno-23-150" name="__codelineno-23-150" href="#__codelineno-23-150"></a>    <span class="c1"># import logging</span>
<a id="__codelineno-23-151" name="__codelineno-23-151" href="#__codelineno-23-151"></a>    <span class="kn">import</span> <span class="nn">datetime</span>
<a id="__codelineno-23-152" name="__codelineno-23-152" href="#__codelineno-23-152"></a>    <span class="kn">from</span> <span class="nn">flumine.worker</span> <span class="kn">import</span> <span class="n">BackgroundWorker</span>
<a id="__codelineno-23-153" name="__codelineno-23-153" href="#__codelineno-23-153"></a>    <span class="kn">from</span> <span class="nn">flumine.events.events</span> <span class="kn">import</span> <span class="n">TerminationEvent</span>
<a id="__codelineno-23-154" name="__codelineno-23-154" href="#__codelineno-23-154"></a>
<a id="__codelineno-23-155" name="__codelineno-23-155" href="#__codelineno-23-155"></a>    <span class="c1"># logger = logging.getLogger(__name__)</span>
<a id="__codelineno-23-156" name="__codelineno-23-156" href="#__codelineno-23-156"></a>
<a id="__codelineno-23-157" name="__codelineno-23-157" href="#__codelineno-23-157"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-23-158" name="__codelineno-23-158" href="#__codelineno-23-158"></a><span class="sd">    Worker can be used as followed:</span>
<a id="__codelineno-23-159" name="__codelineno-23-159" href="#__codelineno-23-159"></a><span class="sd">        framework.add_worker(</span>
<a id="__codelineno-23-160" name="__codelineno-23-160" href="#__codelineno-23-160"></a><span class="sd">            BackgroundWorker(</span>
<a id="__codelineno-23-161" name="__codelineno-23-161" href="#__codelineno-23-161"></a><span class="sd">                framework,</span>
<a id="__codelineno-23-162" name="__codelineno-23-162" href="#__codelineno-23-162"></a><span class="sd">                terminate,</span>
<a id="__codelineno-23-163" name="__codelineno-23-163" href="#__codelineno-23-163"></a><span class="sd">                func_kwargs={&quot;today_only&quot;: True, &quot;seconds_closed&quot;: 1200},</span>
<a id="__codelineno-23-164" name="__codelineno-23-164" href="#__codelineno-23-164"></a><span class="sd">                interval=60,</span>
<a id="__codelineno-23-165" name="__codelineno-23-165" href="#__codelineno-23-165"></a><span class="sd">                start_delay=60,</span>
<a id="__codelineno-23-166" name="__codelineno-23-166" href="#__codelineno-23-166"></a><span class="sd">            )</span>
<a id="__codelineno-23-167" name="__codelineno-23-167" href="#__codelineno-23-167"></a><span class="sd">        )</span>
<a id="__codelineno-23-168" name="__codelineno-23-168" href="#__codelineno-23-168"></a><span class="sd">    This will run every 60s and will terminate </span>
<a id="__codelineno-23-169" name="__codelineno-23-169" href="#__codelineno-23-169"></a><span class="sd">    the framework if all markets starting &#39;today&#39; </span>
<a id="__codelineno-23-170" name="__codelineno-23-170" href="#__codelineno-23-170"></a><span class="sd">    have been closed for at least 1200s</span>
<a id="__codelineno-23-171" name="__codelineno-23-171" href="#__codelineno-23-171"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-23-172" name="__codelineno-23-172" href="#__codelineno-23-172"></a>
<a id="__codelineno-23-173" name="__codelineno-23-173" href="#__codelineno-23-173"></a>
<a id="__codelineno-23-174" name="__codelineno-23-174" href="#__codelineno-23-174"></a>    <span class="c1"># Function that stops automation running at the end of the day</span>
<a id="__codelineno-23-175" name="__codelineno-23-175" href="#__codelineno-23-175"></a>    <span class="k">def</span> <span class="nf">terminate</span><span class="p">(</span>
<a id="__codelineno-23-176" name="__codelineno-23-176" href="#__codelineno-23-176"></a>        <span class="n">context</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">flumine</span><span class="p">,</span> <span class="n">today_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">seconds_closed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">600</span>
<a id="__codelineno-23-177" name="__codelineno-23-177" href="#__codelineno-23-177"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-23-178" name="__codelineno-23-178" href="#__codelineno-23-178"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;terminate framework if no markets</span>
<a id="__codelineno-23-179" name="__codelineno-23-179" href="#__codelineno-23-179"></a><span class="sd">        live today.</span>
<a id="__codelineno-23-180" name="__codelineno-23-180" href="#__codelineno-23-180"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-23-181" name="__codelineno-23-181" href="#__codelineno-23-181"></a>        <span class="n">markets</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">flumine</span><span class="o">.</span><span class="n">markets</span><span class="o">.</span><span class="n">markets</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
<a id="__codelineno-23-182" name="__codelineno-23-182" href="#__codelineno-23-182"></a>        <span class="n">markets_today</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-23-183" name="__codelineno-23-183" href="#__codelineno-23-183"></a>            <span class="n">m</span>
<a id="__codelineno-23-184" name="__codelineno-23-184" href="#__codelineno-23-184"></a>            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">markets</span>
<a id="__codelineno-23-185" name="__codelineno-23-185" href="#__codelineno-23-185"></a>            <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">market_start_datetime</span><span class="o">.</span><span class="n">date</span><span class="p">()</span> <span class="o">==</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
<a id="__codelineno-23-186" name="__codelineno-23-186" href="#__codelineno-23-186"></a>            <span class="ow">and</span> <span class="p">(</span>
<a id="__codelineno-23-187" name="__codelineno-23-187" href="#__codelineno-23-187"></a>                <span class="n">m</span><span class="o">.</span><span class="n">elapsed_seconds_closed</span> <span class="ow">is</span> <span class="kc">None</span>
<a id="__codelineno-23-188" name="__codelineno-23-188" href="#__codelineno-23-188"></a>                <span class="ow">or</span> <span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">elapsed_seconds_closed</span> <span class="ow">and</span> <span class="n">m</span><span class="o">.</span><span class="n">elapsed_seconds_closed</span> <span class="o">&lt;</span> <span class="n">seconds_closed</span><span class="p">)</span>
<a id="__codelineno-23-189" name="__codelineno-23-189" href="#__codelineno-23-189"></a>            <span class="p">)</span>
<a id="__codelineno-23-190" name="__codelineno-23-190" href="#__codelineno-23-190"></a>        <span class="p">]</span>
<a id="__codelineno-23-191" name="__codelineno-23-191" href="#__codelineno-23-191"></a>        <span class="k">if</span> <span class="n">today_only</span><span class="p">:</span>
<a id="__codelineno-23-192" name="__codelineno-23-192" href="#__codelineno-23-192"></a>            <span class="n">market_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">markets_today</span><span class="p">)</span>
<a id="__codelineno-23-193" name="__codelineno-23-193" href="#__codelineno-23-193"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-23-194" name="__codelineno-23-194" href="#__codelineno-23-194"></a>            <span class="n">market_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">markets</span><span class="p">)</span>
<a id="__codelineno-23-195" name="__codelineno-23-195" href="#__codelineno-23-195"></a>        <span class="k">if</span> <span class="n">market_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-23-196" name="__codelineno-23-196" href="#__codelineno-23-196"></a>            <span class="c1"># logger.info(&quot;No more markets available, terminating framework&quot;)</span>
<a id="__codelineno-23-197" name="__codelineno-23-197" href="#__codelineno-23-197"></a>            <span class="n">flumine</span><span class="o">.</span><span class="n">handler_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">TerminationEvent</span><span class="p">(</span><span class="n">flumine</span><span class="p">))</span>
<a id="__codelineno-23-198" name="__codelineno-23-198" href="#__codelineno-23-198"></a>
<a id="__codelineno-23-199" name="__codelineno-23-199" href="#__codelineno-23-199"></a>    <span class="c1"># Add the stopped to our framework</span>
<a id="__codelineno-23-200" name="__codelineno-23-200" href="#__codelineno-23-200"></a>    <span class="n">framework</span><span class="o">.</span><span class="n">add_worker</span><span class="p">(</span>
<a id="__codelineno-23-201" name="__codelineno-23-201" href="#__codelineno-23-201"></a>        <span class="n">BackgroundWorker</span><span class="p">(</span>
<a id="__codelineno-23-202" name="__codelineno-23-202" href="#__codelineno-23-202"></a>            <span class="n">framework</span><span class="p">,</span>
<a id="__codelineno-23-203" name="__codelineno-23-203" href="#__codelineno-23-203"></a>            <span class="n">terminate</span><span class="p">,</span>
<a id="__codelineno-23-204" name="__codelineno-23-204" href="#__codelineno-23-204"></a>            <span class="n">func_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;today_only&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;seconds_closed&quot;</span><span class="p">:</span> <span class="mi">1200</span><span class="p">},</span>
<a id="__codelineno-23-205" name="__codelineno-23-205" href="#__codelineno-23-205"></a>            <span class="n">interval</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
<a id="__codelineno-23-206" name="__codelineno-23-206" href="#__codelineno-23-206"></a>            <span class="n">start_delay</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
<a id="__codelineno-23-207" name="__codelineno-23-207" href="#__codelineno-23-207"></a>        <span class="p">)</span>
<a id="__codelineno-23-208" name="__codelineno-23-208" href="#__codelineno-23-208"></a>    <span class="p">)</span>
<a id="__codelineno-23-209" name="__codelineno-23-209" href="#__codelineno-23-209"></a>
<a id="__codelineno-23-210" name="__codelineno-23-210" href="#__codelineno-23-210"></a>    <span class="kn">import</span> <span class="nn">os</span>
<a id="__codelineno-23-211" name="__codelineno-23-211" href="#__codelineno-23-211"></a>    <span class="kn">import</span> <span class="nn">csv</span>
<a id="__codelineno-23-212" name="__codelineno-23-212" href="#__codelineno-23-212"></a>    <span class="kn">import</span> <span class="nn">logging</span>
<a id="__codelineno-23-213" name="__codelineno-23-213" href="#__codelineno-23-213"></a>    <span class="kn">from</span> <span class="nn">flumine.controls.loggingcontrols</span> <span class="kn">import</span> <span class="n">LoggingControl</span>
<a id="__codelineno-23-214" name="__codelineno-23-214" href="#__codelineno-23-214"></a>    <span class="kn">from</span> <span class="nn">flumine.order.ordertype</span> <span class="kn">import</span> <span class="n">OrderTypes</span>
<a id="__codelineno-23-215" name="__codelineno-23-215" href="#__codelineno-23-215"></a>
<a id="__codelineno-23-216" name="__codelineno-23-216" href="#__codelineno-23-216"></a>    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<a id="__codelineno-23-217" name="__codelineno-23-217" href="#__codelineno-23-217"></a>
<a id="__codelineno-23-218" name="__codelineno-23-218" href="#__codelineno-23-218"></a>    <span class="n">FIELDNAMES</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-23-219" name="__codelineno-23-219" href="#__codelineno-23-219"></a>        <span class="s2">&quot;bet_id&quot;</span><span class="p">,</span>
<a id="__codelineno-23-220" name="__codelineno-23-220" href="#__codelineno-23-220"></a>        <span class="s2">&quot;strategy_name&quot;</span><span class="p">,</span>
<a id="__codelineno-23-221" name="__codelineno-23-221" href="#__codelineno-23-221"></a>        <span class="s2">&quot;market_id&quot;</span><span class="p">,</span>
<a id="__codelineno-23-222" name="__codelineno-23-222" href="#__codelineno-23-222"></a>        <span class="s2">&quot;selection_id&quot;</span><span class="p">,</span>
<a id="__codelineno-23-223" name="__codelineno-23-223" href="#__codelineno-23-223"></a>        <span class="s2">&quot;trade_id&quot;</span><span class="p">,</span>
<a id="__codelineno-23-224" name="__codelineno-23-224" href="#__codelineno-23-224"></a>        <span class="s2">&quot;date_time_placed&quot;</span><span class="p">,</span>
<a id="__codelineno-23-225" name="__codelineno-23-225" href="#__codelineno-23-225"></a>        <span class="s2">&quot;price&quot;</span><span class="p">,</span>
<a id="__codelineno-23-226" name="__codelineno-23-226" href="#__codelineno-23-226"></a>        <span class="s2">&quot;price_matched&quot;</span><span class="p">,</span>
<a id="__codelineno-23-227" name="__codelineno-23-227" href="#__codelineno-23-227"></a>        <span class="s2">&quot;size&quot;</span><span class="p">,</span>
<a id="__codelineno-23-228" name="__codelineno-23-228" href="#__codelineno-23-228"></a>        <span class="s2">&quot;size_matched&quot;</span><span class="p">,</span>
<a id="__codelineno-23-229" name="__codelineno-23-229" href="#__codelineno-23-229"></a>        <span class="s2">&quot;profit&quot;</span><span class="p">,</span>
<a id="__codelineno-23-230" name="__codelineno-23-230" href="#__codelineno-23-230"></a>        <span class="s2">&quot;side&quot;</span><span class="p">,</span>
<a id="__codelineno-23-231" name="__codelineno-23-231" href="#__codelineno-23-231"></a>        <span class="s2">&quot;elapsed_seconds_executable&quot;</span><span class="p">,</span>
<a id="__codelineno-23-232" name="__codelineno-23-232" href="#__codelineno-23-232"></a>        <span class="s2">&quot;order_status&quot;</span><span class="p">,</span>
<a id="__codelineno-23-233" name="__codelineno-23-233" href="#__codelineno-23-233"></a>        <span class="s2">&quot;market_note&quot;</span><span class="p">,</span>
<a id="__codelineno-23-234" name="__codelineno-23-234" href="#__codelineno-23-234"></a>        <span class="s2">&quot;trade_notes&quot;</span><span class="p">,</span>
<a id="__codelineno-23-235" name="__codelineno-23-235" href="#__codelineno-23-235"></a>        <span class="s2">&quot;order_notes&quot;</span><span class="p">,</span>
<a id="__codelineno-23-236" name="__codelineno-23-236" href="#__codelineno-23-236"></a>    <span class="p">]</span>
<a id="__codelineno-23-237" name="__codelineno-23-237" href="#__codelineno-23-237"></a>
<a id="__codelineno-23-238" name="__codelineno-23-238" href="#__codelineno-23-238"></a>    <span class="k">class</span> <span class="nc">LiveLoggingControl</span><span class="p">(</span><span class="n">LoggingControl</span><span class="p">):</span>
<a id="__codelineno-23-239" name="__codelineno-23-239" href="#__codelineno-23-239"></a>        <span class="n">NAME</span> <span class="o">=</span> <span class="s2">&quot;BACKTEST_LOGGING_CONTROL&quot;</span>
<a id="__codelineno-23-240" name="__codelineno-23-240" href="#__codelineno-23-240"></a>
<a id="__codelineno-23-241" name="__codelineno-23-241" href="#__codelineno-23-241"></a>        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-23-242" name="__codelineno-23-242" href="#__codelineno-23-242"></a>            <span class="nb">super</span><span class="p">(</span><span class="n">LiveLoggingControl</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-23-243" name="__codelineno-23-243" href="#__codelineno-23-243"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_setup</span><span class="p">()</span>
<a id="__codelineno-23-244" name="__codelineno-23-244" href="#__codelineno-23-244"></a>
<a id="__codelineno-23-245" name="__codelineno-23-245" href="#__codelineno-23-245"></a>        <span class="c1"># Changed file path and checks if the file orders_hta_4.csv already exists, if it doens&#39;t then create it</span>
<a id="__codelineno-23-246" name="__codelineno-23-246" href="#__codelineno-23-246"></a>        <span class="k">def</span> <span class="nf">_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-23-247" name="__codelineno-23-247" href="#__codelineno-23-247"></a>            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;orders_hta_4.csv&quot;</span><span class="p">):</span>
<a id="__codelineno-23-248" name="__codelineno-23-248" href="#__codelineno-23-248"></a>                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Results file exists&quot;</span><span class="p">)</span>
<a id="__codelineno-23-249" name="__codelineno-23-249" href="#__codelineno-23-249"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-23-250" name="__codelineno-23-250" href="#__codelineno-23-250"></a>                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;orders_hta_4.csv&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">m</span><span class="p">:</span>
<a id="__codelineno-23-251" name="__codelineno-23-251" href="#__codelineno-23-251"></a>                    <span class="n">csv_writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictWriter</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">fieldnames</span><span class="o">=</span><span class="n">FIELDNAMES</span><span class="p">)</span>
<a id="__codelineno-23-252" name="__codelineno-23-252" href="#__codelineno-23-252"></a>                    <span class="n">csv_writer</span><span class="o">.</span><span class="n">writeheader</span><span class="p">()</span>
<a id="__codelineno-23-253" name="__codelineno-23-253" href="#__codelineno-23-253"></a>
<a id="__codelineno-23-254" name="__codelineno-23-254" href="#__codelineno-23-254"></a>        <span class="k">def</span> <span class="nf">_process_cleared_orders_meta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
<a id="__codelineno-23-255" name="__codelineno-23-255" href="#__codelineno-23-255"></a>            <span class="n">orders</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">event</span>
<a id="__codelineno-23-256" name="__codelineno-23-256" href="#__codelineno-23-256"></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;orders_hta_4.csv&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">m</span><span class="p">:</span>
<a id="__codelineno-23-257" name="__codelineno-23-257" href="#__codelineno-23-257"></a>                <span class="k">for</span> <span class="n">order</span> <span class="ow">in</span> <span class="n">orders</span><span class="p">:</span>
<a id="__codelineno-23-258" name="__codelineno-23-258" href="#__codelineno-23-258"></a>                    <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">order_type</span><span class="o">.</span><span class="n">ORDER_TYPE</span> <span class="o">==</span> <span class="n">OrderTypes</span><span class="o">.</span><span class="n">LIMIT</span><span class="p">:</span>
<a id="__codelineno-23-259" name="__codelineno-23-259" href="#__codelineno-23-259"></a>                        <span class="n">size</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">order_type</span><span class="o">.</span><span class="n">size</span>
<a id="__codelineno-23-260" name="__codelineno-23-260" href="#__codelineno-23-260"></a>                    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-23-261" name="__codelineno-23-261" href="#__codelineno-23-261"></a>                        <span class="n">size</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">order_type</span><span class="o">.</span><span class="n">liability</span>
<a id="__codelineno-23-262" name="__codelineno-23-262" href="#__codelineno-23-262"></a>                    <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">order_type</span><span class="o">.</span><span class="n">ORDER_TYPE</span> <span class="o">==</span> <span class="n">OrderTypes</span><span class="o">.</span><span class="n">MARKET_ON_CLOSE</span><span class="p">:</span>
<a id="__codelineno-23-263" name="__codelineno-23-263" href="#__codelineno-23-263"></a>                        <span class="n">price</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-23-264" name="__codelineno-23-264" href="#__codelineno-23-264"></a>                    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-23-265" name="__codelineno-23-265" href="#__codelineno-23-265"></a>                        <span class="n">price</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">order_type</span><span class="o">.</span><span class="n">price</span>
<a id="__codelineno-23-266" name="__codelineno-23-266" href="#__codelineno-23-266"></a>                    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-23-267" name="__codelineno-23-267" href="#__codelineno-23-267"></a>                        <span class="n">order_data</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-23-268" name="__codelineno-23-268" href="#__codelineno-23-268"></a>                            <span class="s2">&quot;bet_id&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">bet_id</span><span class="p">,</span>
<a id="__codelineno-23-269" name="__codelineno-23-269" href="#__codelineno-23-269"></a>                            <span class="s2">&quot;strategy_name&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">trade</span><span class="o">.</span><span class="n">strategy</span><span class="p">,</span>
<a id="__codelineno-23-270" name="__codelineno-23-270" href="#__codelineno-23-270"></a>                            <span class="s2">&quot;market_id&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">market_id</span><span class="p">,</span>
<a id="__codelineno-23-271" name="__codelineno-23-271" href="#__codelineno-23-271"></a>                            <span class="s2">&quot;selection_id&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">selection_id</span><span class="p">,</span>
<a id="__codelineno-23-272" name="__codelineno-23-272" href="#__codelineno-23-272"></a>                            <span class="s2">&quot;trade_id&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">trade</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
<a id="__codelineno-23-273" name="__codelineno-23-273" href="#__codelineno-23-273"></a>                            <span class="s2">&quot;date_time_placed&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">responses</span><span class="o">.</span><span class="n">date_time_placed</span><span class="p">,</span>
<a id="__codelineno-23-274" name="__codelineno-23-274" href="#__codelineno-23-274"></a>                            <span class="s2">&quot;price&quot;</span><span class="p">:</span> <span class="n">price</span><span class="p">,</span>
<a id="__codelineno-23-275" name="__codelineno-23-275" href="#__codelineno-23-275"></a>                            <span class="s2">&quot;price_matched&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">average_price_matched</span><span class="p">,</span>
<a id="__codelineno-23-276" name="__codelineno-23-276" href="#__codelineno-23-276"></a>                            <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="n">size</span><span class="p">,</span>
<a id="__codelineno-23-277" name="__codelineno-23-277" href="#__codelineno-23-277"></a>                            <span class="s2">&quot;size_matched&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">size_matched</span><span class="p">,</span>
<a id="__codelineno-23-278" name="__codelineno-23-278" href="#__codelineno-23-278"></a>                            <span class="s2">&quot;profit&quot;</span><span class="p">:</span> <span class="mi">0</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">order</span><span class="o">.</span><span class="n">cleared_order</span> <span class="k">else</span> <span class="n">order</span><span class="o">.</span><span class="n">cleared_order</span><span class="o">.</span><span class="n">profit</span><span class="p">,</span>
<a id="__codelineno-23-279" name="__codelineno-23-279" href="#__codelineno-23-279"></a>                            <span class="s2">&quot;side&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">side</span><span class="p">,</span>
<a id="__codelineno-23-280" name="__codelineno-23-280" href="#__codelineno-23-280"></a>                            <span class="s2">&quot;elapsed_seconds_executable&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">elapsed_seconds_executable</span><span class="p">,</span>
<a id="__codelineno-23-281" name="__codelineno-23-281" href="#__codelineno-23-281"></a>                            <span class="s2">&quot;order_status&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
<a id="__codelineno-23-282" name="__codelineno-23-282" href="#__codelineno-23-282"></a>                            <span class="s2">&quot;market_note&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">trade</span><span class="o">.</span><span class="n">market_notes</span><span class="p">,</span>
<a id="__codelineno-23-283" name="__codelineno-23-283" href="#__codelineno-23-283"></a>                            <span class="s2">&quot;trade_notes&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">trade</span><span class="o">.</span><span class="n">notes_str</span><span class="p">,</span>
<a id="__codelineno-23-284" name="__codelineno-23-284" href="#__codelineno-23-284"></a>                            <span class="s2">&quot;order_notes&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">notes_str</span><span class="p">,</span>
<a id="__codelineno-23-285" name="__codelineno-23-285" href="#__codelineno-23-285"></a>                        <span class="p">}</span>
<a id="__codelineno-23-286" name="__codelineno-23-286" href="#__codelineno-23-286"></a>                        <span class="n">csv_writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictWriter</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">fieldnames</span><span class="o">=</span><span class="n">FIELDNAMES</span><span class="p">)</span>
<a id="__codelineno-23-287" name="__codelineno-23-287" href="#__codelineno-23-287"></a>                        <span class="n">csv_writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">order_data</span><span class="p">)</span>
<a id="__codelineno-23-288" name="__codelineno-23-288" href="#__codelineno-23-288"></a>                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-23-289" name="__codelineno-23-289" href="#__codelineno-23-289"></a>                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-23-290" name="__codelineno-23-290" href="#__codelineno-23-290"></a>                            <span class="s2">&quot;_process_cleared_orders_meta: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">,</span>
<a id="__codelineno-23-291" name="__codelineno-23-291" href="#__codelineno-23-291"></a>                            <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;order&quot;</span><span class="p">:</span> <span class="n">order</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">e</span><span class="p">},</span>
<a id="__codelineno-23-292" name="__codelineno-23-292" href="#__codelineno-23-292"></a>                        <span class="p">)</span>
<a id="__codelineno-23-293" name="__codelineno-23-293" href="#__codelineno-23-293"></a>
<a id="__codelineno-23-294" name="__codelineno-23-294" href="#__codelineno-23-294"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Orders updated&quot;</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;order_count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">orders</span><span class="p">)})</span>
<a id="__codelineno-23-295" name="__codelineno-23-295" href="#__codelineno-23-295"></a>
<a id="__codelineno-23-296" name="__codelineno-23-296" href="#__codelineno-23-296"></a>        <span class="k">def</span> <span class="nf">_process_cleared_markets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
<a id="__codelineno-23-297" name="__codelineno-23-297" href="#__codelineno-23-297"></a>            <span class="n">cleared_markets</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">event</span>
<a id="__codelineno-23-298" name="__codelineno-23-298" href="#__codelineno-23-298"></a>            <span class="k">for</span> <span class="n">cleared_market</span> <span class="ow">in</span> <span class="n">cleared_markets</span><span class="o">.</span><span class="n">orders</span><span class="p">:</span>
<a id="__codelineno-23-299" name="__codelineno-23-299" href="#__codelineno-23-299"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-23-300" name="__codelineno-23-300" href="#__codelineno-23-300"></a>                    <span class="s2">&quot;Cleared market&quot;</span><span class="p">,</span>
<a id="__codelineno-23-301" name="__codelineno-23-301" href="#__codelineno-23-301"></a>                    <span class="n">extra</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-23-302" name="__codelineno-23-302" href="#__codelineno-23-302"></a>                        <span class="s2">&quot;market_id&quot;</span><span class="p">:</span> <span class="n">cleared_market</span><span class="o">.</span><span class="n">market_id</span><span class="p">,</span>
<a id="__codelineno-23-303" name="__codelineno-23-303" href="#__codelineno-23-303"></a>                        <span class="s2">&quot;bet_count&quot;</span><span class="p">:</span> <span class="n">cleared_market</span><span class="o">.</span><span class="n">bet_count</span><span class="p">,</span>
<a id="__codelineno-23-304" name="__codelineno-23-304" href="#__codelineno-23-304"></a>                        <span class="s2">&quot;profit&quot;</span><span class="p">:</span> <span class="n">cleared_market</span><span class="o">.</span><span class="n">profit</span><span class="p">,</span>
<a id="__codelineno-23-305" name="__codelineno-23-305" href="#__codelineno-23-305"></a>                        <span class="s2">&quot;commission&quot;</span><span class="p">:</span> <span class="n">cleared_market</span><span class="o">.</span><span class="n">commission</span><span class="p">,</span>
<a id="__codelineno-23-306" name="__codelineno-23-306" href="#__codelineno-23-306"></a>                    <span class="p">},</span>
<a id="__codelineno-23-307" name="__codelineno-23-307" href="#__codelineno-23-307"></a>                <span class="p">)</span>
<a id="__codelineno-23-308" name="__codelineno-23-308" href="#__codelineno-23-308"></a>
<a id="__codelineno-23-309" name="__codelineno-23-309" href="#__codelineno-23-309"></a>    <span class="n">framework</span><span class="o">.</span><span class="n">add_logging_control</span><span class="p">(</span>
<a id="__codelineno-23-310" name="__codelineno-23-310" href="#__codelineno-23-310"></a>        <span class="n">LiveLoggingControl</span><span class="p">()</span>
<a id="__codelineno-23-311" name="__codelineno-23-311" href="#__codelineno-23-311"></a>    <span class="p">)</span>
<a id="__codelineno-23-312" name="__codelineno-23-312" href="#__codelineno-23-312"></a>
<a id="__codelineno-23-313" name="__codelineno-23-313" href="#__codelineno-23-313"></a>    <span class="n">framework</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p><a href="https://github.com/betfair-down-under/autoHubTutorials/tree/master/howToAutomate/how_to_automate_IV">Download from Github</a></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a>    <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a>    <span class="kn">from</span> <span class="nn">joblib</span> <span class="kn">import</span> <span class="n">load</span>
<a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a>
<a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a>    <span class="n">model_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;../data/model_df.csv&#39;</span><span class="p">)</span>
<a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a>    <span class="n">feature_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;speed_index&#39;</span><span class="p">,</span> <span class="s1">&#39;box_win_percent&#39;</span><span class="p">,</span> <span class="s1">&#39;RunTime_norm_min_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;RunTime_norm_max_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;RunTime_norm_mean_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;RunTime_norm_median_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;RunTime_norm_std_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;SplitMargin_norm_min_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;SplitMargin_norm_max_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;SplitMargin_norm_mean_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;SplitMargin_norm_median_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;SplitMargin_norm_std_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_inv_min_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_inv_max_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_inv_mean_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_inv_median_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_inv_std_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_log_min_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_log_max_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_log_mean_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_log_median_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_log_std_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;Prizemoney_norm_min_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;Prizemoney_norm_max_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;Prizemoney_norm_mean_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;Prizemoney_norm_median_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;Prizemoney_norm_std_28D&#39;</span><span class="p">,</span> <span class="s1">&#39;RunTime_norm_min_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;RunTime_norm_max_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;RunTime_norm_mean_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;RunTime_norm_median_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;RunTime_norm_std_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;SplitMargin_norm_min_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;SplitMargin_norm_max_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;SplitMargin_norm_mean_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;SplitMargin_norm_median_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;SplitMargin_norm_std_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_inv_min_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_inv_max_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_inv_mean_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_inv_median_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_inv_std_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_log_min_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_log_max_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_log_mean_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_log_median_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_log_std_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;Prizemoney_norm_min_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;Prizemoney_norm_max_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;Prizemoney_norm_mean_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;Prizemoney_norm_median_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;Prizemoney_norm_std_91D&#39;</span><span class="p">,</span> <span class="s1">&#39;RunTime_norm_min_365D&#39;</span><span class="p">,</span> <span class="s1">&#39;RunTime_norm_max_365D&#39;</span><span class="p">,</span> <span class="s1">&#39;RunTime_norm_mean_365D&#39;</span><span class="p">,</span> <span class="s1">&#39;RunTime_norm_median_365D&#39;</span><span class="p">,</span> <span class="s1">&#39;RunTime_norm_std_365D&#39;</span><span class="p">,</span> <span class="s1">&#39;SplitMargin_norm_min_365D&#39;</span><span class="p">,</span> <span class="s1">&#39;SplitMargin_norm_max_365D&#39;</span><span class="p">,</span> <span class="s1">&#39;SplitMargin_norm_mean_365D&#39;</span><span class="p">,</span> <span class="s1">&#39;SplitMargin_norm_median_365D&#39;</span><span class="p">,</span> <span class="s1">&#39;SplitMargin_norm_std_365D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_inv_min_365D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_inv_max_365D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_inv_mean_365D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_inv_median_365D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_inv_std_365D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_log_min_365D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_log_max_365D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_log_mean_365D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_log_median_365D&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_log_std_365D&#39;</span><span class="p">,</span> <span class="s1">&#39;Prizemoney_norm_min_365D&#39;</span><span class="p">,</span> <span class="s1">&#39;Prizemoney_norm_max_365D&#39;</span><span class="p">,</span> <span class="s1">&#39;Prizemoney_norm_mean_365D&#39;</span><span class="p">,</span> <span class="s1">&#39;Prizemoney_norm_median_365D&#39;</span><span class="p">,</span> <span class="s1">&#39;Prizemoney_norm_std_365D&#39;</span><span class="p">]</span>
<a id="__codelineno-24-6" name="__codelineno-24-6" href="#__codelineno-24-6"></a>    <span class="n">brunos_model</span> <span class="o">=</span> <span class="n">load</span><span class="p">(</span><span class="s1">&#39;../data/logistic_regression.joblib&#39;</span><span class="p">)</span>
<a id="__codelineno-24-7" name="__codelineno-24-7" href="#__codelineno-24-7"></a>
<a id="__codelineno-24-8" name="__codelineno-24-8" href="#__codelineno-24-8"></a>    <span class="c1"># Generate predictions like normal</span>
<a id="__codelineno-24-9" name="__codelineno-24-9" href="#__codelineno-24-9"></a>    <span class="c1"># Range of dates that we want to simulate later &#39;2022-03-01&#39; to &#39;2022-04-01&#39;</span>
<a id="__codelineno-24-10" name="__codelineno-24-10" href="#__codelineno-24-10"></a>    <span class="n">model_df</span><span class="p">[</span><span class="s1">&#39;date_dt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">model_df</span><span class="p">[</span><span class="s1">&#39;date_dt&#39;</span><span class="p">])</span>
<a id="__codelineno-24-11" name="__codelineno-24-11" href="#__codelineno-24-11"></a>    <span class="n">todays_data</span> <span class="o">=</span> <span class="n">model_df</span><span class="p">[(</span><span class="n">model_df</span><span class="p">[</span><span class="s1">&#39;date_dt&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2022-03-01&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">model_df</span><span class="p">[</span><span class="s1">&#39;date_dt&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2022-04-01&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">))]</span>
<a id="__codelineno-24-12" name="__codelineno-24-12" href="#__codelineno-24-12"></a>    <span class="n">dog_win_probabilities</span> <span class="o">=</span> <span class="n">brunos_model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">todays_data</span><span class="p">[</span><span class="n">feature_cols</span><span class="p">])[:,</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-24-13" name="__codelineno-24-13" href="#__codelineno-24-13"></a>    <span class="n">todays_data</span><span class="p">[</span><span class="s1">&#39;prob_LogisticRegression&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dog_win_probabilities</span>
<a id="__codelineno-24-14" name="__codelineno-24-14" href="#__codelineno-24-14"></a>    <span class="n">todays_data</span><span class="p">[</span><span class="s1">&#39;renormalise_prob&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">todays_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;FastTrack_RaceId&#39;</span><span class="p">)[</span><span class="s1">&#39;prob_LogisticRegression&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
<a id="__codelineno-24-15" name="__codelineno-24-15" href="#__codelineno-24-15"></a>    <span class="n">todays_data</span><span class="p">[</span><span class="s1">&#39;rating&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">todays_data</span><span class="p">[</span><span class="s1">&#39;renormalise_prob&#39;</span><span class="p">]</span>
<a id="__codelineno-24-16" name="__codelineno-24-16" href="#__codelineno-24-16"></a>    <span class="n">todays_data</span> <span class="o">=</span> <span class="n">todays_data</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span> <span class="o">=</span> <span class="s1">&#39;date_dt&#39;</span><span class="p">)</span>
<a id="__codelineno-24-17" name="__codelineno-24-17" href="#__codelineno-24-17"></a>    <span class="n">todays_data</span>
<a id="__codelineno-24-18" name="__codelineno-24-18" href="#__codelineno-24-18"></a>
<a id="__codelineno-24-19" name="__codelineno-24-19" href="#__codelineno-24-19"></a>    <span class="k">def</span> <span class="nf">download_iggy_ratings</span><span class="p">(</span><span class="n">date</span><span class="p">):</span>
<a id="__codelineno-24-20" name="__codelineno-24-20" href="#__codelineno-24-20"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Downloads the Betfair Iggy model ratings for a given date and formats it into a nice DataFrame.</span>
<a id="__codelineno-24-21" name="__codelineno-24-21" href="#__codelineno-24-21"></a>
<a id="__codelineno-24-22" name="__codelineno-24-22" href="#__codelineno-24-22"></a><span class="sd">        Args:</span>
<a id="__codelineno-24-23" name="__codelineno-24-23" href="#__codelineno-24-23"></a><span class="sd">            date (datetime): the date we want to download the ratings for</span>
<a id="__codelineno-24-24" name="__codelineno-24-24" href="#__codelineno-24-24"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-24-25" name="__codelineno-24-25" href="#__codelineno-24-25"></a>        <span class="n">iggy_url_1</span> <span class="o">=</span> <span class="s1">&#39;https://betfair-data-supplier-prod.herokuapp.com/api/widgets/iggy-joey/datasets?date=&#39;</span>
<a id="__codelineno-24-26" name="__codelineno-24-26" href="#__codelineno-24-26"></a>        <span class="n">iggy_url_2</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-24-27" name="__codelineno-24-27" href="#__codelineno-24-27"></a>        <span class="n">iggy_url_3</span> <span class="o">=</span> <span class="s1">&#39;&amp;presenter=RatingsPresenter&amp;csv=true&#39;</span>
<a id="__codelineno-24-28" name="__codelineno-24-28" href="#__codelineno-24-28"></a>        <span class="n">iggy_url</span> <span class="o">=</span> <span class="n">iggy_url_1</span> <span class="o">+</span> <span class="n">iggy_url_2</span> <span class="o">+</span> <span class="n">iggy_url_3</span>
<a id="__codelineno-24-29" name="__codelineno-24-29" href="#__codelineno-24-29"></a>
<a id="__codelineno-24-30" name="__codelineno-24-30" href="#__codelineno-24-30"></a>        <span class="c1"># Download todays greyhounds ratings</span>
<a id="__codelineno-24-31" name="__codelineno-24-31" href="#__codelineno-24-31"></a>        <span class="n">iggy_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">iggy_url</span><span class="p">)</span>
<a id="__codelineno-24-32" name="__codelineno-24-32" href="#__codelineno-24-32"></a>
<a id="__codelineno-24-33" name="__codelineno-24-33" href="#__codelineno-24-33"></a>        <span class="c1"># Data clearning</span>
<a id="__codelineno-24-34" name="__codelineno-24-34" href="#__codelineno-24-34"></a>        <span class="n">iggy_df</span> <span class="o">=</span> <span class="n">iggy_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
<a id="__codelineno-24-35" name="__codelineno-24-35" href="#__codelineno-24-35"></a>        <span class="n">columns</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-24-36" name="__codelineno-24-36" href="#__codelineno-24-36"></a>            <span class="s2">&quot;meetings.races.bfExchangeMarketId&quot;</span><span class="p">:</span><span class="s2">&quot;market_id&quot;</span><span class="p">,</span>
<a id="__codelineno-24-37" name="__codelineno-24-37" href="#__codelineno-24-37"></a>            <span class="s2">&quot;meetings.races.runners.bfExchangeSelectionId&quot;</span><span class="p">:</span><span class="s2">&quot;selection_id&quot;</span><span class="p">,</span>
<a id="__codelineno-24-38" name="__codelineno-24-38" href="#__codelineno-24-38"></a>            <span class="s2">&quot;meetings.races.runners.ratedPrice&quot;</span><span class="p">:</span><span class="s2">&quot;rating&quot;</span><span class="p">,</span>
<a id="__codelineno-24-39" name="__codelineno-24-39" href="#__codelineno-24-39"></a>            <span class="s2">&quot;meetings.races.number&quot;</span><span class="p">:</span><span class="s2">&quot;RaceNum&quot;</span><span class="p">,</span>
<a id="__codelineno-24-40" name="__codelineno-24-40" href="#__codelineno-24-40"></a>            <span class="s2">&quot;meetings.name&quot;</span><span class="p">:</span><span class="s2">&quot;Track&quot;</span><span class="p">,</span>
<a id="__codelineno-24-41" name="__codelineno-24-41" href="#__codelineno-24-41"></a>            <span class="s2">&quot;meetings.races.runners.name&quot;</span><span class="p">:</span><span class="s2">&quot;DogName&quot;</span>
<a id="__codelineno-24-42" name="__codelineno-24-42" href="#__codelineno-24-42"></a>            <span class="p">}</span>
<a id="__codelineno-24-43" name="__codelineno-24-43" href="#__codelineno-24-43"></a>        <span class="p">)</span>
<a id="__codelineno-24-44" name="__codelineno-24-44" href="#__codelineno-24-44"></a>        <span class="c1"># iggy_df = iggy_df[[&#39;market_id&#39;,&#39;selection_id&#39;,&#39;rating&#39;]]</span>
<a id="__codelineno-24-45" name="__codelineno-24-45" href="#__codelineno-24-45"></a>        <span class="n">iggy_df</span><span class="p">[</span><span class="s1">&#39;market_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">iggy_df</span><span class="p">[</span><span class="s1">&#39;market_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
<a id="__codelineno-24-46" name="__codelineno-24-46" href="#__codelineno-24-46"></a>        <span class="n">iggy_df</span><span class="p">[</span><span class="s1">&#39;date_dt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">date</span>
<a id="__codelineno-24-47" name="__codelineno-24-47" href="#__codelineno-24-47"></a>
<a id="__codelineno-24-48" name="__codelineno-24-48" href="#__codelineno-24-48"></a>        <span class="c1"># Set market_id and selection_id as index for easy referencing</span>
<a id="__codelineno-24-49" name="__codelineno-24-49" href="#__codelineno-24-49"></a>        <span class="c1"># iggy_df = iggy_df.set_index([&#39;market_id&#39;,&#39;selection_id&#39;])</span>
<a id="__codelineno-24-50" name="__codelineno-24-50" href="#__codelineno-24-50"></a>        <span class="k">return</span><span class="p">(</span><span class="n">iggy_df</span><span class="p">)</span>
<a id="__codelineno-24-51" name="__codelineno-24-51" href="#__codelineno-24-51"></a>
<a id="__codelineno-24-52" name="__codelineno-24-52" href="#__codelineno-24-52"></a>    <span class="c1"># Download historical ratings over a time period and convert into a big DataFrame.</span>
<a id="__codelineno-24-53" name="__codelineno-24-53" href="#__codelineno-24-53"></a>    <span class="n">back_test_period</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="s1">&#39;2022-03-01&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;2022-04-01&#39;</span><span class="p">)</span>
<a id="__codelineno-24-54" name="__codelineno-24-54" href="#__codelineno-24-54"></a>    <span class="n">frames</span> <span class="o">=</span> <span class="p">[</span><span class="n">download_iggy_ratings</span><span class="p">(</span><span class="n">day</span><span class="p">)</span> <span class="k">for</span> <span class="n">day</span> <span class="ow">in</span> <span class="n">back_test_period</span><span class="p">]</span>
<a id="__codelineno-24-55" name="__codelineno-24-55" href="#__codelineno-24-55"></a>    <span class="n">iggy_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">frames</span><span class="p">)</span>
<a id="__codelineno-24-56" name="__codelineno-24-56" href="#__codelineno-24-56"></a>    <span class="n">iggy_df</span>
<a id="__codelineno-24-57" name="__codelineno-24-57" href="#__codelineno-24-57"></a>
<a id="__codelineno-24-58" name="__codelineno-24-58" href="#__codelineno-24-58"></a>    <span class="c1"># format DogNames to merge</span>
<a id="__codelineno-24-59" name="__codelineno-24-59" href="#__codelineno-24-59"></a>    <span class="n">todays_data</span><span class="p">[</span><span class="s1">&#39;DogName&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">todays_data</span><span class="p">[</span><span class="s1">&#39;DogName&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Res&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
<a id="__codelineno-24-60" name="__codelineno-24-60" href="#__codelineno-24-60"></a>    <span class="n">iggy_df</span><span class="p">[</span><span class="s1">&#39;DogName&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">iggy_df</span><span class="p">[</span><span class="s1">&#39;DogName&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
<a id="__codelineno-24-61" name="__codelineno-24-61" href="#__codelineno-24-61"></a>    <span class="c1"># Merge</span>
<a id="__codelineno-24-62" name="__codelineno-24-62" href="#__codelineno-24-62"></a>    <span class="n">backtest</span> <span class="o">=</span> <span class="n">iggy_df</span><span class="p">[[</span><span class="s1">&#39;market_id&#39;</span><span class="p">,</span><span class="s1">&#39;selection_id&#39;</span><span class="p">,</span><span class="s1">&#39;DogName&#39;</span><span class="p">,</span><span class="s1">&#39;date_dt&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">todays_data</span><span class="p">[[</span><span class="s1">&#39;rating&#39;</span><span class="p">,</span><span class="s1">&#39;DogName&#39;</span><span class="p">,</span><span class="s1">&#39;date_dt&#39;</span><span class="p">]],</span> <span class="n">how</span> <span class="o">=</span> <span class="s1">&#39;inner&#39;</span><span class="p">,</span> <span class="n">on</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;DogName&#39;</span><span class="p">,</span><span class="s1">&#39;date_dt&#39;</span><span class="p">])</span>
<a id="__codelineno-24-63" name="__codelineno-24-63" href="#__codelineno-24-63"></a>    <span class="n">backtest</span>
<a id="__codelineno-24-64" name="__codelineno-24-64" href="#__codelineno-24-64"></a>
<a id="__codelineno-24-65" name="__codelineno-24-65" href="#__codelineno-24-65"></a>    <span class="c1"># Save predictions for if we want to backtest/simulate it later</span>
<a id="__codelineno-24-66" name="__codelineno-24-66" href="#__codelineno-24-66"></a>    <span class="n">backtest</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;../data/backtest.csv&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="c1"># Csv format</span>
</code></pre></div>
</div>
</div>
</div>
<hr />
<h2 id="disclaimer">Disclaimer</h2>
<p>Note that whilst models and automated strategies are fun and rewarding to create, we can't promise that your model or betting strategy will be profitable, and we make no representations in relation to the code shared or information on this page. If you're using this code or implementing your own strategies, you do so entirely at your own risk and you are responsible for any winnings/losses incurred. Under no circumstances will Betfair be liable for any loss or damage you suffer.</p>









  




                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
    
      <nav class="md-footer__inner md-grid" aria-label="footer.title">
        
          
          <a href="../How_to_Automate_3/" class="md-footer__link md-footer__link--prev" aria-label="Previous: How to Automate 3" rel="prev">
            <div class="md-footer__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <div class="md-ellipsis">
                <span class="md-footer__direction">
                  Previous
                </span>
                How to Automate 3
              </div>
            </div>
          </a>
        
        
          
          <a href="../How_to_Automate_5/" class="md-footer__link md-footer__link--next" aria-label="Next: How to Automate 5" rel="next">
            <div class="md-footer__title">
              <div class="md-ellipsis">
                <span class="md-footer__direction">
                  Next
                </span>
                How to Automate 5
              </div>
            </div>
            <div class="md-footer__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
    <div class="md-footer-meta md-typeset">
      <div class="md-footer-meta__inner md-grid">
        <div class="md-copyright">
  
  
</div>
        
          <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://twitter.com/Betfair_Aus" target="_blank" rel="noopener" title="twitter.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.7.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://linkedin.com/company/betfair-australia" target="_blank" rel="noopener" title="linkedin.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3M135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5m282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://facebook.com/betfairaustralia" target="_blank" rel="noopener" title="facebook.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.7.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M512 256C512 114.6 397.4 0 256 0S0 114.6 0 256c0 120 82.7 220.8 194.2 248.5V334.2h-52.8V256h52.8v-33.7c0-87.1 39.4-127.5 125-127.5 16.2 0 44.2 3.2 55.7 6.4V172c-6-.6-16.5-1-29.6-1-42 0-58.2 15.9-58.2 57.2V256h83.6l-14.4 78.2H287v175.9C413.8 494.8 512 386.9 512 256"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://youtube.com/user/betfairaus" target="_blank" rel="noopener" title="youtube.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.7.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M549.655 124.083c-6.281-23.65-24.787-42.276-48.284-48.597C458.781 64 288 64 288 64S117.22 64 74.629 75.486c-23.497 6.322-42.003 24.947-48.284 48.597-11.412 42.867-11.412 132.305-11.412 132.305s0 89.438 11.412 132.305c6.281 23.65 24.787 41.5 48.284 47.821C117.22 448 288 448 288 448s170.78 0 213.371-11.486c23.497-6.321 42.003-24.171 48.284-47.821 11.412-42.867 11.412-132.305 11.412-132.305s0-89.438-11.412-132.305m-317.51 213.508V175.185l142.739 81.205z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://github.com/betfair-datascientists" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
</div>
        
      </div>

      <div class="bf-footer">
          <div class="bf-footer-inner">
              <p class="bf-light">Betfair Pty Limited is licensed and regulated by the Northern Territory Government of Australia.</p>
              <p class="bf-dark">Betfair Pty Limited's gambling operations are governed by its <a class='inner-link' href="https://www.betfair.com.au/info/responsible-gambling/">Responsible Gambling Code of Conduct</a> and for South
              Australian residents by the <a class='inner-link' href="https://www.betfair.com.au/info/pdf/SA-GCoP.pdf">South Australian Responsible Gambling Code of Practice.</a></p>
              <p class="bf-dark">BetStop is the Australian National Self-Exclusion Register. For more information, please visit <a class="inner-link" href="https://betstop.gov.au">https://betstop.gov.au</a><br /> <div class="full-screen"> <p style="font-family: Arial, sans-serif; font-size: 1.2rem; font-weight: bold; text-align: center;">What are you really gambling with&#63</p> <p style="font-family: Arial, sans-serif; font-size: 0.8rem; font-weight: bold; text-align: center;">For free and confidential support call 1800 858 858 or visit <a href="http://www.gamblinghelponline.org.au" style="color: black; text-decoration: underline;">gamblinghelponline.org.au</a></p> </div> </p>
              <ul class="bf-links">
                <li><a href="https://www.betfair.com.au/hub/help/account-help/responsible-gambling/">Responsible Gambling</a><span>|</span></li>
                <li><a href="http://www.betfair.com/AUS_NZL/aboutUs/Terms.and.Conditions/">Terms & Conditions</a><span>|</span></li>
                <li><a href="https://www.betfair.com.au/info/privacy-policy/">Privacy Policy</a><span>|</span></li>
                <li><a href="http://www.betfair.com/en/aboutUs/Rules.and.Regulations/">Rules & Regulations</a><span>|</span></li>
                <li><a href="https://www.betfair.com/AUS_NZL/aboutUs/Dispute.Resolution">Dispute Resolution</a></li>
              </ul>
          </div>
      </div>
    </div>

    <script src="https://js.adsrvr.org/up_loader.1.1.0.js" type="text/javascript"></script>
    <script type="text/javascript">
        ttd_dom_ready( function() {
            if (typeof TTDUniversalPixelApi === 'function') {
                var universalPixelApi = new TTDUniversalPixelApi();
                universalPixelApi.init("y12d1ir", ["8ml4f17"], "https://insight.adsrvr.org/track/up");
            }
        });
    </script>

</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["toc.integrate", "navigation.instant", "navigation.tabs", "navigation.top", "navigation.expand", "navigation.sections", "search.suggest", "search.highlight", "search.share"], "search": "../../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.88dd0f4e.min.js"></script>
      
        <script src="../../js/scripts.js"></script>
      
    
  </body>
</html>