
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Documentation, guides and articles on creating, developing and implementing automated betting strategies, using data analysis to inform betting models and how to interact with the Betfair API.">
      
      
        <meta name="author" content="Betfair Data Scientists">
      
      
        <link rel="canonical" href="https://betfair-datascientists.github.io/tutorials/How_to_Automate_4_archived/">
      
      
      
      
      <link rel="icon" href="../../img/BetfairFavicon.ico">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.5">
    
    
      
        <title>How to Automate 4 archived - The Automation Hub</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.8608ea7d.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/betfair.css">
    
      <link rel="stylesheet" href="../../css/buttons_and_animations.css">
    
      <link rel="stylesheet" href="../../css/fonts.css">
    
      <link rel="stylesheet" href="../../css/ansi-colours.css">
    
      <link rel="stylesheet" href="../../css/jupyter-cells.css">
    
      <link rel="stylesheet" href="../../css/pandas-dataframe.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","UA-125973915-1"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","UA-125973915-1",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=UA-125973915-1",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="betfair" data-md-color-primary="amber" data-md-color-accent="orange">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#how-to-automate-iv-automate-your-own-model" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      
  
  <header class="md-header" data-md-component="header">
    <nav class="md-header__inner md-grid" aria-label="header.title">
      <a href="../.." title="The Automation Hub" class="md-header__button md-logo" aria-label="The Automation Hub" data-md-component="logo">
        
  <img src="../../img/logo.svg" alt="logo">

      </a>
      <label class="md-header__button md-icon" for="__drawer">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
      </label>
      <div class="md-header__title" data-md-component="header-title">
        <div class="md-header__ellipsis">
          <div class="md-header__topic">
            <span class="md-ellipsis">
              The Automation Hub
            </span>
          </div>
          <div class="md-header__topic" data-md-component="header-topic">
            <span class="md-ellipsis">
              
                How to Automate 4 archived
              
            </span>
          </div>
        </div>
      </div>

      
        <form class="md-header__option" data-md-component="palette">
          
            
            
            <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="betfair" data-md-color-primary="amber" data-md-color-accent="orange"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
            
              <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg>
              </label>
            
          
            
            
            <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="amber" data-md-color-accent="orange"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
            
              <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"/></svg>
              </label>
            
          
        </form>
      
      

      
     
      <div class="bf-nav">
        <a class="bf-hidable" href="https://www.betfair.com.au/exchange/plus/"><svg class="exchangeLogo" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:cc="http://creativecommons.org/ns#"
          xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 38.775 4.59" width="24" height="17">
          <path class="st1" d="m 160.3,-136.95 v 26" />
          <g transform="translate(18.8,-137.15)">
            <path d="m 2.2901089,126.53441 v 5.20093 H -3.3107216 L 7.4888397,144.33446 18.2884,131.73534 h -5.598633 v -5.20093 z m -8.6000974,8.10132 -10.8017585,12.59913 h 5.60083 v 5.2998 h 10.3996581 v -5.2998 h 5.6008306 z" />
          </g>
        </svg><span> Exchange</span></a>
        <a href="https://www.betfair.com.au/hub/">Hub</a>
      </div>

      

    </nav>
    
  </header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../data/dataListing/" class="md-tabs__link">
          
  
  Data

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../wagering/betfairHowTo/" class="md-tabs__link">
          
  
  Wagering

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../api/apiResources/" class="md-tabs__link">
          
  
  API

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../modelling/springRacingDatathon/" class="md-tabs__link">
          
  
  Modelling

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../How_to_Automate_1/" class="md-tabs__link">
          
  
  Tutorials

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../mentalGame/intro/" class="md-tabs__link">
          
  
  Mental Game

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../contactUs/test/" class="md-tabs__link">
          
  
  Contact Us

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="The Automation Hub" class="md-nav__button md-logo" aria-label="The Automation Hub" data-md-component="logo">
      
  <img src="../../img/logo.svg" alt="logo">

    </a>
    The Automation Hub
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Data
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Data
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../data/dataListing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CSV Files
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../data/usingHistoricDataSite/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Historic Data Site
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Wagering
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Wagering
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../wagering/betfairHowTo/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Betfair How-To
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../wagering/bettingGlossary/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Betting Glossary
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../wagering/stakingMethods/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Staking Methods and Bankroll Management
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../wagering/valueAndOdds/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Value and Odds
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../wagering/commission/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Commission and other charges
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../wagering/hubPredictionsModel/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Hub Predictions Model
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../wagering/2ndPlaceVoid/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Cashback 2nd Markets
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../wagering/exactaQuinella/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Exactas & Quinella
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    API
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            API
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/apiResources/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    API resources
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/apiappkey/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to access the Betfair API
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/apiRtutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    API tutorial in R
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/apiPythontutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    API tutorial in Python
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Modelling
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Modelling
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/springRacingDatathon/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Spring Racing Datathon
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/howToModel/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Intro to modelling
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/dataSources/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Pricing Data Sources
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/cloudOrLocalMachine/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Cloud or Local
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/monteCarloSimulations/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Monte Carlo Simulations
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_6" >
        
          
          <label class="md-nav__link" for="__nav_5_6" id="__nav_5_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    AFL
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_6">
            <span class="md-nav__icon md-icon"></span>
            AFL
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/AFLPlayerDisposalsTutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Player Disposal Lines
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/AFLPlayerDisposalsFlumine/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Betting Player Disposal Markets
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/modellingTheBrownlowMedal/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How does a Data Scientist model the Brownlow?
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_7" >
        
          
          <label class="md-nav__link" for="__nav_5_7" id="__nav_5_7_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    AFL (Archive)
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_7">
            <span class="md-nav__icon md-icon"></span>
            AFL (Archive)
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/AFLmodellingPython/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    AFL modelling walk through in Python
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/brownlowModelTutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Modelling the Brownlow Medal in Python
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_8" >
        
          
          <label class="md-nav__link" for="__nav_5_8" id="__nav_5_8_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Greyhounds
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_8">
            <span class="md-nav__icon md-icon"></span>
            Greyhounds
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/topazTutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Greyhound Topaz API (Python)
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_9" >
        
          
          <label class="md-nav__link" for="__nav_5_9" id="__nav_5_9_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Greyhounds (Archive)
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_9">
            <span class="md-nav__icon md-icon"></span>
            Greyhounds (Archive)
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/fasttrackTutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Greyhound FastTrack API (Python)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/greyhoundModellingPython/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Greyhound modelling (Python)
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_10" >
        
          
          <label class="md-nav__link" for="__nav_5_10" id="__nav_5_10_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Soccer
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_10">
            <span class="md-nav__icon md-icon"></span>
            Soccer
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/howToBuildASoccerBotPartI/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How To Build A Soccer Bot P1
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/howToBuildASoccerBotPartII/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How To Build A Soccer Bot P2
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/howToBuildASoccerBotPartIII/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How To Build A Soccer Bot P3
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_11" >
        
          
          <label class="md-nav__link" for="__nav_5_11" id="__nav_5_11_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Soccer (Archive)
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_11_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_11">
            <span class="md-nav__icon md-icon"></span>
            Soccer (Archive)
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/soccerModellingTutorialPython/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Soccer modelling (Python)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/EPLmlPython/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    EPL Machine Learning (Python)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/soccerModellingELO2022WorldCup/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Soccer modelling (R) - 2022 FIFA World Cup
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/soccerEloTutorialR/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Elo soccer tutorial (R)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/soccerModellingTutorialR/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Soccer modelling (R)
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_12" >
        
          
          <label class="md-nav__link" for="__nav_5_12" id="__nav_5_12_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Tennis (Archive)
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_12_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_12">
            <span class="md-nav__icon md-icon"></span>
            Tennis (Archive)
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/howToModelTheAusOpen/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to model the Australian Open
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/AusOpenRTutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Aus Open R Tutorial
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/AusOpenPythonTutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Aus Open Python Tutorial
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Tutorials
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Tutorials
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../How_to_Automate_1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to Automate 1
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../How_to_Automate_2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to Automate 2
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../How_to_Automate_3/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to Automate 3
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../How_to_Automate_4/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to Automate 4
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../How_to_Automate_5/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to Automate 5
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../resultsLoggingTutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Flumine Results to CSV Files
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../flumineSimulations/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Flumine Simulations
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../processingTarFiles101/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Take away the pain! Processing TAR Files 101
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../jsonToCsvRevisited/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    JSON to CSV | Revisited
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../backtestingRatingsTutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Back testing ratings in Python
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../automatedBettingAnglesTutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Automated betting angles in Python
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../analysingAndPredictingMarketMovements/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Do they know? Analysing Betfair market formation & market movements
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../analysingAndPredictingBSP/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Wisdom of the crowd? Analysing & understanding BSP
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Mental Game
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            Mental Game
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/intro/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Intro
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/roleOfEmotions/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Part 1
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/mapYourEmotions/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Part 2
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/handlingBadVariance/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Part 3
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/winbyBeingGreatatLosing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Part 4
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/correctingyouremotions/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Part 5
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/responsibleGambling/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Part 6
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/InchwormConcept/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Part 7
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/HighExpectations/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Part 8
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/TappingYourIntuition/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Part 9
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_8" >
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Contact Us
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            Contact Us
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../contactUs/test/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Meet the Team
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script>
(function() {
  function addWidgetsRenderer() {
    var requireJsScript = document.createElement('script');
    requireJsScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js';

    var mimeElement = document.querySelector('script[type="application/vnd.jupyter.widget-view+json"]');
    var jupyterWidgetsScript = document.createElement('script');
    var widgetRendererSrc = 'https://unpkg.com/@jupyter-widgets/html-manager@*/dist/embed-amd.js';
    var widgetState;

    // Fallback for older version:
    try {
      widgetState = mimeElement && JSON.parse(mimeElement.innerHTML);

      if (widgetState && (widgetState.version_major < 2 || !widgetState.version_major)) {
        widgetRendererSrc = 'jupyter-js-widgets@*/dist/embed.js';
      }
    } catch(e) {}

    jupyterWidgetsScript.src = widgetRendererSrc;

    document.body.appendChild(requireJsScript);
    document.body.appendChild(jupyterWidgetsScript);
  }

  document.addEventListener('DOMContentLoaded', addWidgetsRenderer);
}());
</script>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="how-to-automate-iv-automate-your-own-model">How to Automate IV: Automate your own Model</h1>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<hr />
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><em>This is an archived version of How to Automate 4</em> the latest version is available <a href="../How_to_Automate_4">here</a></p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>For this tutorial we will be automating the model that Bruno taught us how to make in the <a href="https://betfair-datascientists.github.io/modelling/greyhoundModellingPython/">Greyhound Modelling Tutorial</a>. This tutorial follows on logically from <a href="../How_to_Automate_3">How to Automate III</a>. If you haven't already, make sure you take a look at the <a href="../How_to_Automate_1">rest of the series</a> first those before continuing here as they cover some key concepts!</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<hr />
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="saving-and-loading-in-our-model">Saving and loading in our model</h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>To generate our predictions, we have two options: we can generate our predictions using the same notebook used to train our model then read those predictions into this notebook, or we can save the model and read that model into this notebook.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>For this tutorial we have chosen to save the model, as it becomes a bit less confusing and easier to manage, although there are some pieces of code we may have to write twice (copy and paste). So first we will need to run the code from the tutorial and then save the model. This is super as simple we can just copy and paste the complete code provided at the <a href="https://betfair-datascientists.github.io/modelling/greyhoundModellingPython/#complete-code">end of the tutorial</a> or <a href="https://github.com/betfair-down-under/autoHubTutorials/tree/master/greyhoundModelling">download from Github</a>. Then we can just run this extra line code (which I have copied from the <a href="https://scikit-learn.org/stable/modules/model_persistence.html">documentation page</a>) at the end of the notebook to save the model. </p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>from joblib import dump
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>dump(models[&#39;LogisticRegression&#39;], &#39;logistic_regression.joblib&#39;)
</code></pre></div>
<p>Now that the file is saved, let's read it into this note book:</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">joblib</span><span class="w"> </span><span class="kn">import</span> <span class="n">load</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="n">brunos_model</span> <span class="o">=</span> <span class="n">load</span><span class="p">(</span><span class="s1">&#39;logistic_regression.joblib&#39;</span><span class="p">)</span>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="n">brunos_model</span>
</code></pre></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_text output_subarea output_execute_result">
<pre>
<code>LogisticRegression(n_jobs=-1, solver='saga')</code>
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<hr />
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="generating-predictions-for-today">Generating predictions for today</h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now that we have the model loaded in, we need the data, to generate our predictions for today's races!</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="c1"># Import libraries required to download today&#39;s races</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="c1"># Allow imports from src folder</span>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="n">module_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;../src&#39;</span><span class="p">))</span>
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="k">if</span> <span class="n">module_path</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
<a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a>    <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">module_path</span><span class="p">)</span>
<a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a>
<a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a><span class="kn">from</span><span class="w"> </span><span class="nn">dateutil.relativedelta</span><span class="w"> </span><span class="kn">import</span> <span class="n">relativedelta</span>
<a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a><span class="kn">from</span><span class="w"> </span><span class="nn">dateutil</span><span class="w"> </span><span class="kn">import</span> <span class="n">tz</span>
<a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a><span class="kn">from</span><span class="w"> </span><span class="nn">pandas.tseries.offsets</span><span class="w"> </span><span class="kn">import</span> <span class="n">MonthEnd</span>
<a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">MinMaxScaler</span>
<a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a><span class="kn">import</span><span class="w"> </span><span class="nn">itertools</span>
<a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a>
<a id="__codelineno-2-17" name="__codelineno-2-17" href="#__codelineno-2-17"></a><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<a id="__codelineno-2-18" name="__codelineno-2-18" href="#__codelineno-2-18"></a><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<a id="__codelineno-2-19" name="__codelineno-2-19" href="#__codelineno-2-19"></a><span class="kn">from</span><span class="w"> </span><span class="nn">nltk.tokenize</span><span class="w"> </span><span class="kn">import</span> <span class="n">regexp_tokenize</span>
<a id="__codelineno-2-20" name="__codelineno-2-20" href="#__codelineno-2-20"></a>
<a id="__codelineno-2-21" name="__codelineno-2-21" href="#__codelineno-2-21"></a><span class="c1"># settings to display all columns</span>
<a id="__codelineno-2-22" name="__codelineno-2-22" href="#__codelineno-2-22"></a><span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s2">&quot;display.max_columns&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-2-23" name="__codelineno-2-23" href="#__codelineno-2-23"></a>
<a id="__codelineno-2-24" name="__codelineno-2-24" href="#__codelineno-2-24"></a><span class="kn">import</span><span class="w"> </span><span class="nn">fasttrack</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ft</span>
<a id="__codelineno-2-25" name="__codelineno-2-25" href="#__codelineno-2-25"></a>
<a id="__codelineno-2-26" name="__codelineno-2-26" href="#__codelineno-2-26"></a><span class="kn">from</span><span class="w"> </span><span class="nn">dotenv</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_dotenv</span>
<a id="__codelineno-2-27" name="__codelineno-2-27" href="#__codelineno-2-27"></a><span class="n">load_dotenv</span><span class="p">()</span>
</code></pre></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_text output_subarea output_execute_result">
<pre>
<code>True</code>
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="c1"># Validate FastTrack API connection</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="n">api_key</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;FAST_TRACK_API_KEY&#39;</span><span class="p">,)</span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="n">client</span> <span class="o">=</span> <span class="n">ft</span><span class="o">.</span><span class="n">Fasttrack</span><span class="p">(</span><span class="n">api_key</span><span class="p">)</span>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="n">track_codes</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">listTracks</span><span class="p">()</span>
</code></pre></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_subarea output_stream output_stdout output_text">
<pre>
<code>Valid Security Key
</code>
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="c1"># Import race data excluding NZ races</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="n">au_tracks_filter</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">track_codes</span><span class="p">[</span><span class="n">track_codes</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;NZ&#39;</span><span class="p">][</span><span class="s1">&#39;track_code&#39;</span><span class="p">])</span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="c1"># Time window to import data</span>
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="c1"># First day of the month 46 months back from now</span>
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="n">date_from</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span> <span class="o">-</span> <span class="n">relativedelta</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="mi">46</span><span class="p">))</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">day</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a><span class="c1"># First day of previous month</span>
<a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a><span class="n">date_to</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span> <span class="o">-</span> <span class="n">relativedelta</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">day</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a>
<a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a><span class="c1"># Dataframes to populate data with</span>
<a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a><span class="n">race_details</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
<a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a><span class="n">dog_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
<a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a>
<a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a><span class="c1"># For each month, either fetch data from API or use local CSV file if we already have downloaded it</span>
<a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a><span class="k">for</span> <span class="n">start</span> <span class="ow">in</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">date_from</span><span class="p">,</span> <span class="n">date_to</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;MS&#39;</span><span class="p">):</span>
<a id="__codelineno-4-16" name="__codelineno-4-16" href="#__codelineno-4-16"></a>    <span class="n">start_date</span> <span class="o">=</span> <span class="n">start</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-4-17" name="__codelineno-4-17" href="#__codelineno-4-17"></a>    <span class="n">end_date</span> <span class="o">=</span> <span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="n">MonthEnd</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-4-18" name="__codelineno-4-18" href="#__codelineno-4-18"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-4-19" name="__codelineno-4-19" href="#__codelineno-4-19"></a>        <span class="n">filename_races</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;FT_AU_RACES_</span><span class="si">{</span><span class="n">start_date</span><span class="si">}</span><span class="s1">.csv&#39;</span>
<a id="__codelineno-4-20" name="__codelineno-4-20" href="#__codelineno-4-20"></a>        <span class="n">filename_dogs</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;FT_AU_DOGS_</span><span class="si">{</span><span class="n">start_date</span><span class="si">}</span><span class="s1">.csv&#39;</span>
<a id="__codelineno-4-21" name="__codelineno-4-21" href="#__codelineno-4-21"></a>
<a id="__codelineno-4-22" name="__codelineno-4-22" href="#__codelineno-4-22"></a>        <span class="n">filepath_races</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;../data/</span><span class="si">{</span><span class="n">filename_races</span><span class="si">}</span><span class="s1">&#39;</span>
<a id="__codelineno-4-23" name="__codelineno-4-23" href="#__codelineno-4-23"></a>        <span class="n">filepath_dogs</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;../data/</span><span class="si">{</span><span class="n">filename_dogs</span><span class="si">}</span><span class="s1">&#39;</span>
<a id="__codelineno-4-24" name="__codelineno-4-24" href="#__codelineno-4-24"></a>
<a id="__codelineno-4-25" name="__codelineno-4-25" href="#__codelineno-4-25"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Loading data from </span><span class="si">{</span><span class="n">start_date</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">end_date</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-4-26" name="__codelineno-4-26" href="#__codelineno-4-26"></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filepath_races</span><span class="p">):</span>
<a id="__codelineno-4-27" name="__codelineno-4-27" href="#__codelineno-4-27"></a>            <span class="c1"># Load local CSV file</span>
<a id="__codelineno-4-28" name="__codelineno-4-28" href="#__codelineno-4-28"></a>            <span class="n">month_race_details</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">filepath_races</span><span class="p">)</span> 
<a id="__codelineno-4-29" name="__codelineno-4-29" href="#__codelineno-4-29"></a>            <span class="n">month_dog_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">filepath_dogs</span><span class="p">)</span> 
<a id="__codelineno-4-30" name="__codelineno-4-30" href="#__codelineno-4-30"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-4-31" name="__codelineno-4-31" href="#__codelineno-4-31"></a>            <span class="c1"># Fetch data from API</span>
<a id="__codelineno-4-32" name="__codelineno-4-32" href="#__codelineno-4-32"></a>            <span class="n">month_race_details</span><span class="p">,</span> <span class="n">month_dog_results</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">getRaceResults</span><span class="p">(</span><span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">,</span> <span class="n">au_tracks_filter</span><span class="p">)</span>
<a id="__codelineno-4-33" name="__codelineno-4-33" href="#__codelineno-4-33"></a>            <span class="n">month_race_details</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">filepath_races</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-4-34" name="__codelineno-4-34" href="#__codelineno-4-34"></a>            <span class="n">month_dog_results</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">filepath_dogs</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-4-35" name="__codelineno-4-35" href="#__codelineno-4-35"></a>
<a id="__codelineno-4-36" name="__codelineno-4-36" href="#__codelineno-4-36"></a>        <span class="c1"># Combine monthly data</span>
<a id="__codelineno-4-37" name="__codelineno-4-37" href="#__codelineno-4-37"></a>        <span class="n">race_details</span> <span class="o">=</span> <span class="n">race_details</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">month_race_details</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-4-38" name="__codelineno-4-38" href="#__codelineno-4-38"></a>        <span class="n">dog_results</span> <span class="o">=</span> <span class="n">dog_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">month_dog_results</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-4-39" name="__codelineno-4-39" href="#__codelineno-4-39"></a>    <span class="k">except</span><span class="p">:</span>
<a id="__codelineno-4-40" name="__codelineno-4-40" href="#__codelineno-4-40"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Could not load data from </span><span class="si">{</span><span class="n">start_date</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">end_date</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</code></pre></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_subarea output_stream output_stdout output_text">
<pre>
<code>Loading data from 2018-09-01 to 2018-09-30
Loading data from 2018-10-01 to 2018-10-31
Loading data from 2018-11-01 to 2018-11-30
Loading data from 2018-12-01 to 2018-12-31
Loading data from 2019-01-01 to 2019-01-31
Loading data from 2019-02-01 to 2019-02-28
Loading data from 2019-03-01 to 2019-03-31
Loading data from 2019-04-01 to 2019-04-30
Loading data from 2019-05-01 to 2019-05-31
Loading data from 2019-06-01 to 2019-06-30
Loading data from 2019-07-01 to 2019-07-31
Loading data from 2019-08-01 to 2019-08-31
Loading data from 2019-09-01 to 2019-09-30
Loading data from 2019-10-01 to 2019-10-31
Loading data from 2019-11-01 to 2019-11-30
Loading data from 2019-12-01 to 2019-12-31
Loading data from 2020-01-01 to 2020-01-31
Loading data from 2020-02-01 to 2020-02-29
Loading data from 2020-03-01 to 2020-03-31
Loading data from 2020-04-01 to 2020-04-30
Loading data from 2020-05-01 to 2020-05-31
Loading data from 2020-06-01 to 2020-06-30
Loading data from 2020-07-01 to 2020-07-31
Loading data from 2020-08-01 to 2020-08-31
Loading data from 2020-09-01 to 2020-09-30
Loading data from 2020-10-01 to 2020-10-31
Loading data from 2020-11-01 to 2020-11-30
Loading data from 2020-12-01 to 2020-12-31
Loading data from 2021-01-01 to 2021-01-31
Loading data from 2021-02-01 to 2021-02-28
Loading data from 2021-03-01 to 2021-03-31
Loading data from 2021-04-01 to 2021-04-30
Loading data from 2021-05-01 to 2021-05-31
Loading data from 2021-06-01 to 2021-06-30
Loading data from 2021-07-01 to 2021-07-31
Loading data from 2021-08-01 to 2021-08-31
Loading data from 2021-09-01 to 2021-09-30
Loading data from 2021-10-01 to 2021-10-31
Loading data from 2021-11-01 to 2021-11-30
Loading data from 2021-12-01 to 2021-12-31
Loading data from 2022-01-01 to 2022-01-31
</code>
</pre>
</div>
</div>
<div class="output_area">
<div class="output_subarea output_stream output_stderr output_text">
<pre>
<code>c:\Users\zhoui\greyhounds_bruno\greyhound-modelling\venv_greyhounds\lib\site-packages\IPython\core\interactiveshell.py:3441: DtypeWarning: Columns (10) have mixed types.Specify dtype option on import or set low_memory=False.
  exec(code_obj, self.user_global_ns, self.user_ns)
</code>
</pre>
</div>
</div>
<div class="output_area">
<div class="output_subarea output_stream output_stdout output_text">
<pre>
<code>Loading data from 2022-02-01 to 2022-02-28
Loading data from 2022-03-01 to 2022-03-31
Loading data from 2022-04-01 to 2022-04-30
Loading data from 2022-05-01 to 2022-05-31
Loading data from 2022-06-01 to 2022-06-30
</code>
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This piece of code we copied and pasted from the <a href="https://betfair-datascientists.github.io/modelling/greyhoundModellingPython/">Greyhound Modelling Tutorial</a> is fantastic! It has downloaded/read-in a ton of historic data! There is an issue though! We don't have the data for today's races, and also for any races that has occurred this month. This is because the code above only downloaded data up until the end of last month. </p>
<p>For example, if we are in the middle of June, then any races in the first two weeks of June won't be downloaded by the chunk of code above. An issue is that if we download it now, when tomorrow rolls around it won't include the extra races that have finished today. </p>
<p>So, the simple but inefficient solution is that every single day we redownload all the races that have already concluded this month. (Ideally you have some sort of database set up or you store and download your data in a daily format instead of the monthly format)</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="n">race_details</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span>
</code></pre></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th></th>
<th>@id</th>
<th>RaceNum</th>
<th>RaceName</th>
<th>RaceTime</th>
<th>Distance</th>
<th>RaceGrade</th>
<th>Track</th>
<th>date</th>
</tr>
</thead>
<tbody>
<tr>
<th>88510</th>
<td>792243395</td>
<td>6</td>
<td>SKY RACING (N/P) STAKE</td>
<td>01:27PM</td>
<td>300m</td>
<td>Restricted Win</td>
<td>Murray Bridge (MBS)</td>
<td>07 Jun 22</td>
</tr>
<tr>
<th>88511</th>
<td>792243396</td>
<td>7</td>
<td>KURT DONSBERG PHOTOGRAPHY MIXED STAKE</td>
<td>01:44PM</td>
<td>300m</td>
<td>Mixed 4/5</td>
<td>Murray Bridge (MBS)</td>
<td>07 Jun 22</td>
</tr>
<tr>
<th>88512</th>
<td>792243397</td>
<td>8</td>
<td>GREYHOUNDS AS PETS</td>
<td>02:04PM</td>
<td>300m</td>
<td>Grade 5 Final</td>
<td>Murray Bridge (MBS)</td>
<td>07 Jun 22</td>
</tr>
<tr>
<th>88513</th>
<td>792243398</td>
<td>9</td>
<td>@THEDOGSSA (N/P) STAKE</td>
<td>02:19PM</td>
<td>300m</td>
<td>Restricted Win</td>
<td>Murray Bridge (MBS)</td>
<td>07 Jun 22</td>
</tr>
<tr>
<th>88514</th>
<td>792243399</td>
<td>10</td>
<td>FOLLOW THEDOGSSA ON TWITTER (N/P) STAKE</td>
<td>02:39PM</td>
<td>300m</td>
<td>Restricted Win</td>
<td>Murray Bridge (MBS)</td>
<td>07 Jun 22</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="n">current_month_start_date</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">day</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="n">current_month_end_date</span> <span class="o">=</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">day</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span> <span class="n">MonthEnd</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="n">current_month_end_date</span> <span class="o">=</span> <span class="p">(</span><span class="n">current_month_end_date</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="s1">&#39;1 day&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a>
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Start date: </span><span class="si">{</span><span class="n">current_month_start_date</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;End Date: </span><span class="si">{</span><span class="n">current_month_end_date</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</code></pre></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_subarea output_stream output_stdout output_text">
<pre>
<code>Start date: 2022-07-01
End Date: 2022-07-30
</code>
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="c1"># Download data for races that have concluded this current month up untill today</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="c1"># Start and end dates for current month</span>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="n">current_month_start_date</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">day</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="n">current_month_end_date</span> <span class="o">=</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">day</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span> <span class="n">MonthEnd</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="n">current_month_end_date</span> <span class="o">=</span> <span class="p">(</span><span class="n">current_month_end_date</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="s1">&#39;1 day&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a>
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a><span class="c1"># Files names </span>
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a><span class="n">filename_races</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;FT_AU_RACES_</span><span class="si">{</span><span class="n">current_month_start_date</span><span class="si">}</span><span class="s1">.csv&#39;</span>
<a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a><span class="n">filename_dogs</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;FT_AU_DOGS_</span><span class="si">{</span><span class="n">current_month_start_date</span><span class="si">}</span><span class="s1">.csv&#39;</span>
<a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a><span class="c1"># Where to store files locally</span>
<a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a><span class="n">filepath_races</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;../data/</span><span class="si">{</span><span class="n">filename_races</span><span class="si">}</span><span class="s1">&#39;</span>
<a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a><span class="n">filepath_dogs</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;../data/</span><span class="si">{</span><span class="n">filename_dogs</span><span class="si">}</span><span class="s1">&#39;</span>
<a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a>
<a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a><span class="c1"># Fetch data from API</span>
<a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a><span class="n">month_race_details</span><span class="p">,</span> <span class="n">month_dog_results</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">getRaceResults</span><span class="p">(</span><span class="n">current_month_start_date</span><span class="p">,</span> <span class="n">current_month_end_date</span><span class="p">,</span> <span class="n">au_tracks_filter</span><span class="p">)</span>
<a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a>
<a id="__codelineno-7-17" name="__codelineno-7-17" href="#__codelineno-7-17"></a><span class="c1"># Save the files locally and replace any out of date fields</span>
<a id="__codelineno-7-18" name="__codelineno-7-18" href="#__codelineno-7-18"></a><span class="n">month_race_details</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">filepath_races</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-7-19" name="__codelineno-7-19" href="#__codelineno-7-19"></a><span class="n">month_dog_results</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">filepath_dogs</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_subarea output_stream output_stdout output_text">
<pre>
<code>Getting meets for each date ..
</code>
</pre>
</div>
</div>
<div class="output_area">
<div class="output_subarea output_stream output_stderr output_text">
<pre>
<code>100%|██████████| 30/30 [00:14&lt;00:00,  2.01it/s]
</code>
</pre>
</div>
</div>
<div class="output_area">
<div class="output_subarea output_stream output_stdout output_text">
<pre>
<code>Getting historic results details ..
</code>
</pre>
</div>
</div>
<div class="output_area">
<div class="output_subarea output_stream output_stderr output_text">
<pre>
<code>100%|██████████| 162/162 [01:30&lt;00:00,  1.80it/s]
</code>
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="n">dog_results</span>
</code></pre></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th></th>
<th>@id</th>
<th>Place</th>
<th>DogName</th>
<th>Box</th>
<th>Rug</th>
<th>Weight</th>
<th>StartPrice</th>
<th>Handicap</th>
<th>Margin1</th>
<th>Margin2</th>
<th>PIR</th>
<th>Checks</th>
<th>Comments</th>
<th>SplitMargin</th>
<th>RunTime</th>
<th>Prizemoney</th>
<th>RaceId</th>
<th>TrainerId</th>
<th>TrainerName</th>
</tr>
</thead>
<tbody>
<tr>
<th>0</th>
<td>114215500</td>
<td>1</td>
<td>DR. MURPHY</td>
<td>7.0</td>
<td>10</td>
<td>29.7</td>
<td>$4.10</td>
<td>NaN</td>
<td>4.24</td>
<td>NaN</td>
<td>Q/111</td>
<td>0</td>
<td>NaN</td>
<td>4.70</td>
<td>22.84</td>
<td>NaN</td>
<td>356387352</td>
<td>107925</td>
<td>W McMahon</td>
</tr>
<tr>
<th>1</th>
<td>131737955</td>
<td>2</td>
<td>MOLLY SPOLLY</td>
<td>8.0</td>
<td>8</td>
<td>27.3</td>
<td>$2.20F</td>
<td>NaN</td>
<td>4.24</td>
<td>4.24</td>
<td>M/222</td>
<td>0</td>
<td>NaN</td>
<td>4.72</td>
<td>23.14</td>
<td>NaN</td>
<td>356387352</td>
<td>199516</td>
<td>K Leviston</td>
</tr>
<tr>
<th>2</th>
<td>204414097</td>
<td>3</td>
<td>ASTON NARITA</td>
<td>2.0</td>
<td>2</td>
<td>29.2</td>
<td>$4.50</td>
<td>NaN</td>
<td>4.94</td>
<td>0.70</td>
<td>M/343</td>
<td>2</td>
<td>NaN</td>
<td>4.88</td>
<td>23.19</td>
<td>NaN</td>
<td>356387352</td>
<td>101224</td>
<td>K Gorman</td>
</tr>
<tr>
<th>3</th>
<td>126744995</td>
<td>4</td>
<td>ONI</td>
<td>6.0</td>
<td>6</td>
<td>25.0</td>
<td>$15.50</td>
<td>NaN</td>
<td>5.70</td>
<td>0.76</td>
<td>S/674</td>
<td>0</td>
<td>NaN</td>
<td>4.95</td>
<td>23.24</td>
<td>NaN</td>
<td>356387352</td>
<td>107925</td>
<td>W McMahon</td>
</tr>
<tr>
<th>4</th>
<td>120958941</td>
<td>5</td>
<td>DARCON FLASH</td>
<td>1.0</td>
<td>1</td>
<td>29.3</td>
<td>$31.00</td>
<td>NaN</td>
<td>6.54</td>
<td>0.84</td>
<td>M/765</td>
<td>8</td>
<td>NaN</td>
<td>4.96</td>
<td>23.30</td>
<td>NaN</td>
<td>356387352</td>
<td>125087</td>
<td>R Conway</td>
</tr>
<tr>
<th>...</th>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr>
<th>749514</th>
<td>415996416</td>
<td>1</td>
<td>WEBLEC WHIRL</td>
<td>2.0</td>
<td>2</td>
<td>27.6</td>
<td>$4.20</td>
<td>NaN</td>
<td>0.10</td>
<td>NaN</td>
<td>0</td>
<td>0</td>
<td>NaN</td>
<td>4.38</td>
<td>16.75</td>
<td>510.0</td>
<td>792243399</td>
<td>76598</td>
<td>N Loechel</td>
</tr>
<tr>
<th>749515</th>
<td>557002281</td>
<td>2</td>
<td>UP THERE BILLY</td>
<td>1.0</td>
<td>1</td>
<td>32.7</td>
<td>$1.80F</td>
<td>NaN</td>
<td>0.10</td>
<td>0.14</td>
<td>NaN</td>
<td>0</td>
<td>NaN</td>
<td>4.43</td>
<td>16.76</td>
<td>175.0</td>
<td>792243399</td>
<td>327728</td>
<td>J Trengove</td>
</tr>
<tr>
<th>749516</th>
<td>529022935</td>
<td>3</td>
<td>WEBLEC FLAME</td>
<td>6.0</td>
<td>6</td>
<td>31.8</td>
<td>$5.50</td>
<td>NaN</td>
<td>4.25</td>
<td>4.00</td>
<td>NaN</td>
<td>0</td>
<td>NaN</td>
<td>4.48</td>
<td>17.04</td>
<td>140.0</td>
<td>792243399</td>
<td>76598</td>
<td>N Loechel</td>
</tr>
<tr>
<th>749517</th>
<td>383604709</td>
<td>4</td>
<td>STRAIGHT BLAZE</td>
<td>8.0</td>
<td>8</td>
<td>34.7</td>
<td>$23.00</td>
<td>NaN</td>
<td>5.00</td>
<td>0.86</td>
<td>NaN</td>
<td>0</td>
<td>NaN</td>
<td>4.61</td>
<td>17.10</td>
<td>115.0</td>
<td>792243399</td>
<td>123529</td>
<td>D Johnstone</td>
</tr>
<tr>
<th>749518</th>
<td>529022943</td>
<td>5</td>
<td>WEBLEC MIST</td>
<td>4.0</td>
<td>4</td>
<td>27.6</td>
<td>$7.00</td>
<td>NaN</td>
<td>15.00</td>
<td>10.14</td>
<td>0</td>
<td>0</td>
<td>VINJ(21)</td>
<td>4.67</td>
<td>17.81</td>
<td>0.0</td>
<td>792243399</td>
<td>76598</td>
<td>N Loechel</td>
</tr>
</tbody>
</table>
<p>749519 rows × 19 columns</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="c1"># This is super important I have spent literally hours before I found out this was causing errors</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;@id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;@id&#39;</span><span class="p">])</span>
</code></pre></div>

</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="c1"># Append the extra data to our data frames </span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="n">race_details</span> <span class="o">=</span> <span class="n">race_details</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">month_race_details</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="n">dog_results</span> <span class="o">=</span> <span class="n">dog_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">month_dog_results</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>

</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>What we are really interested in are races that are scheduled for today as we want to use our model to predict their ratings. So, let's write some code we can run in the morning that will download the data for the day:</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="c1"># Download the data for todays races</span>
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="n">todays_date</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="n">todays_races</span><span class="p">,</span> <span class="n">todays_dogs</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">getFullFormat</span><span class="p">(</span><span class="n">dt</span><span class="o">=</span> <span class="n">todays_date</span><span class="p">,</span> <span class="n">tracks</span> <span class="o">=</span> <span class="n">au_tracks_filter</span><span class="p">)</span>
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a>
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a><span class="n">display</span><span class="p">(</span><span class="n">todays_races</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">todays_dogs</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
</code></pre></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_subarea output_stream output_stdout output_text">
<pre>
<code>Getting meets for each date ..
</code>
</pre>
</div>
</div>
<div class="output_area">
<div class="output_subarea output_stream output_stderr output_text">
<pre>
<code>100%|██████████| 1/1 [00:00&lt;00:00,  1.89it/s]
</code>
</pre>
</div>
</div>
<div class="output_area">
<div class="output_subarea output_stream output_stdout output_text">
<pre>
<code>Getting dog lineups ..
</code>
</pre>
</div>
</div>
<div class="output_area">
<div class="output_subarea output_stream output_stderr output_text">
<pre>
<code>100%|██████████| 12/12 [00:13&lt;00:00,  1.14s/it]
</code>
</pre>
</div>
</div>
<div class="output_area">
<div class="output_html rendered_html output_subarea">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th></th>
<th>@id</th>
<th>RaceNum</th>
<th>RaceName</th>
<th>RaceTime</th>
<th>RaceTimeDateUTC</th>
<th>Distance</th>
<th>RaceGrade</th>
<th>PrizeMoney1</th>
<th>PrizeMoney2</th>
<th>PrizeMoney3</th>
<th>PrizeMoney4</th>
<th>PrizeMoney5</th>
<th>PrizeMoney6</th>
<th>PrizeMoney7</th>
<th>PrizeMoney8</th>
<th>GOBIS</th>
<th>Hurdle</th>
<th>Handicap</th>
<th>TAB</th>
<th>GradeCode</th>
<th>VICGREYS</th>
<th>RaceComment</th>
<th>Track</th>
<th>Date</th>
<th>Quali</th>
<th>TipsComments_Bet</th>
<th>TipsComments_Tips</th>
</tr>
</thead>
<tbody>
<tr>
<th>0</th>
<td>801896110</td>
<td>1</td>
<td>GPP LASER3300</td>
<td>06:44PM</td>
<td>04 Jul 22 08:44AM</td>
<td>385m</td>
<td>Maiden</td>
<td>$1600</td>
<td>$460</td>
<td>$230</td>
<td>$115</td>
<td>None</td>
<td>None</td>
<td>None</td>
<td>None</td>
<td>None</td>
<td>None</td>
<td>None</td>
<td>TRI/QUIN R/D EXACTA PICK4</td>
<td>M</td>
<td>None</td>
<td>"KASUMI BERRY (5) is a well bred type and her ...</td>
<td>Shepparton</td>
<td>04 Jul 22</td>
<td>None</td>
<td>Box Quinella 1,2,4,7 ($10 for 166.67%)</td>
<td>4, 7, 1, 2</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="output_area">
<div class="output_html rendered_html output_subarea">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th></th>
<th>@id</th>
<th>RaceBox</th>
<th>DogName</th>
<th>BestTime</th>
<th>DogHandicap</th>
<th>Odds</th>
<th>Rating</th>
<th>Speed</th>
<th>DogComment</th>
<th>StartsTOT</th>
<th>StartsTTD</th>
<th>Suburb</th>
<th>Owner</th>
<th>Colour</th>
<th>Sex</th>
<th>Whelped</th>
<th>DogGrade</th>
<th>DogGOBIS</th>
<th>DogPRIZE</th>
<th>AgedPrizeMoney</th>
<th>Form</th>
<th>DamId</th>
<th>DamName</th>
<th>SireId</th>
<th>SireName</th>
<th>TrainerId</th>
<th>TrainerName</th>
<th>RaceId</th>
</tr>
</thead>
<tbody>
<tr>
<th>0</th>
<td>536196758</td>
<td>1</td>
<td>HAVE A SHIRAZ</td>
<td>FSH</td>
<td>None</td>
<td>$4.60</td>
<td>0</td>
<td>None</td>
<td>Dam produced the highly talented Flaming rush</td>
<td>Starts 0-0-0-0</td>
<td>Trk/Dst 0-0-0-0</td>
<td>Heathcote</td>
<td>Paul Ellis</td>
<td>BK</td>
<td>B</td>
<td>03 Dec 19</td>
<td>M</td>
<td>N</td>
<td>0</td>
<td>0</td>
<td>[None, None, None, None, None]</td>
<td>1550070039</td>
<td>Pepper Shiraz</td>
<td>-710494</td>
<td>Barcia Bale</td>
<td>117228</td>
<td>Jason Formosa</td>
<td>801896110</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="c1"># It seems that the todays_races dataframe doesn&#39;t have the date column, so let&#39;s add that on</span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="n">todays_races</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> %b %y&#39;</span><span class="p">)</span>
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="n">todays_races</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th></th>
<th>@id</th>
<th>RaceNum</th>
<th>RaceName</th>
<th>RaceTime</th>
<th>RaceTimeDateUTC</th>
<th>Distance</th>
<th>RaceGrade</th>
<th>PrizeMoney1</th>
<th>PrizeMoney2</th>
<th>PrizeMoney3</th>
<th>PrizeMoney4</th>
<th>PrizeMoney5</th>
<th>PrizeMoney6</th>
<th>PrizeMoney7</th>
<th>PrizeMoney8</th>
<th>GOBIS</th>
<th>Hurdle</th>
<th>Handicap</th>
<th>TAB</th>
<th>GradeCode</th>
<th>VICGREYS</th>
<th>RaceComment</th>
<th>Track</th>
<th>Date</th>
<th>Quali</th>
<th>TipsComments_Bet</th>
<th>TipsComments_Tips</th>
<th>date</th>
</tr>
</thead>
<tbody>
<tr>
<th>0</th>
<td>801896110</td>
<td>1</td>
<td>GPP LASER3300</td>
<td>06:44PM</td>
<td>04 Jul 22 08:44AM</td>
<td>385m</td>
<td>Maiden</td>
<td>$1600</td>
<td>$460</td>
<td>$230</td>
<td>$115</td>
<td>None</td>
<td>None</td>
<td>None</td>
<td>None</td>
<td>None</td>
<td>None</td>
<td>None</td>
<td>TRI/QUIN R/D EXACTA PICK4</td>
<td>M</td>
<td>None</td>
<td>"KASUMI BERRY (5) is a well bred type and her ...</td>
<td>Shepparton</td>
<td>04 Jul 22</td>
<td>None</td>
<td>Box Quinella 1,2,4,7 ($10 for 166.67%)</td>
<td>4, 7, 1, 2</td>
<td>04 Jul 22</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="c1"># It also seems that in todays_dogs dataframe Box is labeled as RaceBox instead, so let&#39;s rename it</span>
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="c1"># We can also see that there are some specific dogs that have &quot;Res.&quot; as a suffix of their name, i.e. they are reserve dogs,</span>
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="c1"># We will treat this later</span>
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a><span class="n">todays_dogs</span> <span class="o">=</span> <span class="n">todays_dogs</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;RaceBox&quot;</span><span class="p">:</span><span class="s2">&quot;Box&quot;</span><span class="p">})</span>
<a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a><span class="n">todays_dogs</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</code></pre></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th></th>
<th>@id</th>
<th>Box</th>
<th>DogName</th>
<th>BestTime</th>
<th>DogHandicap</th>
<th>Odds</th>
<th>Rating</th>
<th>Speed</th>
<th>DogComment</th>
<th>StartsTOT</th>
<th>StartsTTD</th>
<th>Suburb</th>
<th>Owner</th>
<th>Colour</th>
<th>Sex</th>
<th>Whelped</th>
<th>DogGrade</th>
<th>DogGOBIS</th>
<th>DogPRIZE</th>
<th>AgedPrizeMoney</th>
<th>Form</th>
<th>DamId</th>
<th>DamName</th>
<th>SireId</th>
<th>SireName</th>
<th>TrainerId</th>
<th>TrainerName</th>
<th>RaceId</th>
</tr>
</thead>
<tbody>
<tr>
<th>1061</th>
<td>400500428</td>
<td>5</td>
<td>TEQUILA TALKING</td>
<td>22.63</td>
<td>None</td>
<td>None</td>
<td>100</td>
<td>66.425</td>
<td>None</td>
<td>Starts 58-11-7-12</td>
<td>Trk/Dst 28-6-5-5</td>
<td>Wolffdene</td>
<td>Fives Alive Synd D Wolff,N Brauer</td>
<td>BE</td>
<td>D</td>
<td>19 Oct 18</td>
<td>4</td>
<td>N</td>
<td>28855</td>
<td>None</td>
<td>[{'Place': '2nd', 'FormBox': '5', 'Weight': '3...</td>
<td>255840075</td>
<td>Sivamet</td>
<td>-737547</td>
<td>Hostile</td>
<td>93322</td>
<td>Michael Brauer</td>
<td>801490825</td>
</tr>
<tr>
<th>1062</th>
<td>525622257</td>
<td>7</td>
<td>REFERRAL</td>
<td>FSTD</td>
<td>None</td>
<td>None</td>
<td>81</td>
<td>61.343</td>
<td>None</td>
<td>Starts 51-4-7-6</td>
<td>Trk/Dst 0-0-0-0</td>
<td>Laidley Heights</td>
<td>Bad Decisions Synd P O'Reilly,A Pearce,D Henery</td>
<td>BD</td>
<td>D</td>
<td>22 Oct 19</td>
<td>5</td>
<td>N</td>
<td>13945</td>
<td>None</td>
<td>[{'Place': '5th', 'FormBox': '7', 'Weight': '3...</td>
<td>257880044</td>
<td>Lovelace</td>
<td>792880037</td>
<td>Sh Avatar</td>
<td>313314</td>
<td>Andrew Pearce</td>
<td>801490825</td>
</tr>
<tr>
<th>1063</th>
<td>566347962</td>
<td>8</td>
<td>STARDUST DREAMS</td>
<td>NBT</td>
<td>None</td>
<td>None</td>
<td>92</td>
<td>61.271</td>
<td>None</td>
<td>Starts 22-3-4-2</td>
<td>Trk/Dst 2-0-1-0</td>
<td>Park Ridge</td>
<td>Kerri-Lyn Harkness</td>
<td>BK</td>
<td>D</td>
<td>07 Mar 20</td>
<td>5</td>
<td>N</td>
<td>8240</td>
<td>None</td>
<td>[{'Place': '2nd', 'FormBox': '8', 'Weight': '3...</td>
<td>118703516</td>
<td>Ellie Belles</td>
<td>141317074</td>
<td>My Redeemer</td>
<td>127311</td>
<td>Stephen Woods</td>
<td>801490825</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="c1"># Appending todays data to this months data</span>
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="n">month_dog_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">month_dog_results</span><span class="p">,</span><span class="n">todays_dogs</span><span class="p">],</span><span class="n">join</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">)[</span><span class="n">month_dog_results</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="n">month_race_details</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">month_race_details</span><span class="p">,</span><span class="n">todays_races</span><span class="p">],</span><span class="n">join</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">)[</span><span class="n">month_race_details</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
<a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a>
<a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a><span class="c1"># Appending this months data to the rest of our historical data</span>
<a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a><span class="n">race_details</span> <span class="o">=</span> <span class="n">race_details</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">month_race_details</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a><span class="n">dog_results</span> <span class="o">=</span> <span class="n">dog_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">month_dog_results</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>

</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<hr />
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="cleaning-our-data-and-feature-creation">Cleaning our data and feature creation</h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Originally I thought that since we now that we have all the data we can easily copy and paste the code used in the <a href="https://betfair-datascientists.github.io/modelling/greyhoundModellingPython/">greyhound modelling tutorial</a> to clean our data and create the features. </p>
<p>But after staring at weird predictions and spending hours trying to work out why some things weren't working I realised that for the most part we can copy and paste code, but when working with the live data we do need to make a few changes. I'll point them out when we get to it, but the main things that tripped me up is the data types the FastTrack API gives and that we need a system to work around reserve dogs</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="n">race_details</span>
</code></pre></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th></th>
<th>@id</th>
<th>RaceNum</th>
<th>RaceName</th>
<th>RaceTime</th>
<th>Distance</th>
<th>RaceGrade</th>
<th>Track</th>
<th>date</th>
</tr>
</thead>
<tbody>
<tr>
<th>0</th>
<td>356387352</td>
<td>1</td>
<td>RUTTER'S BUTCHERY &amp; POULTRY</td>
<td>05:29PM</td>
<td>395m</td>
<td>Mixed 6/7</td>
<td>Traralgon</td>
<td>01 Sep 18</td>
</tr>
<tr>
<th>1</th>
<td>356387359</td>
<td>2</td>
<td>TAB - WE LOVE A BET</td>
<td>05:47PM</td>
<td>395m</td>
<td>Grade 5</td>
<td>Traralgon</td>
<td>01 Sep 18</td>
</tr>
<tr>
<th>2</th>
<td>356387358</td>
<td>3</td>
<td>HALEY CONCRETING</td>
<td>06:05PM</td>
<td>395m</td>
<td>Grade 5</td>
<td>Traralgon</td>
<td>01 Sep 18</td>
</tr>
<tr>
<th>3</th>
<td>356387355</td>
<td>4</td>
<td>R.W &amp; A.R INGLIS ELECTRICIANS</td>
<td>06:29PM</td>
<td>395m</td>
<td>Free For All</td>
<td>Traralgon</td>
<td>01 Sep 18</td>
</tr>
<tr>
<th>4</th>
<td>356387363</td>
<td>5</td>
<td>PRINTMAC</td>
<td>06:45PM</td>
<td>525m</td>
<td>Grade 5</td>
<td>Traralgon</td>
<td>01 Sep 18</td>
</tr>
<tr>
<th>...</th>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr>
<th>89359</th>
<td>801490821</td>
<td>5</td>
<td>SENNACHIE @ STUD - STEVE WHITE</td>
<td>08:13PM</td>
<td>520m</td>
<td>Grade 5 Heat</td>
<td>Albion Park</td>
<td>04 Jul 22</td>
</tr>
<tr>
<th>89360</th>
<td>801490822</td>
<td>6</td>
<td>ORSON ALLEN @ METICULOUS LODGE</td>
<td>08:35PM</td>
<td>520m</td>
<td>Grade 5 Heat</td>
<td>Albion Park</td>
<td>04 Jul 22</td>
</tr>
<tr>
<th>89361</th>
<td>801490823</td>
<td>7</td>
<td>SKY RACING</td>
<td>08:53PM</td>
<td>600m</td>
<td>Mixed 4/5</td>
<td>Albion Park</td>
<td>04 Jul 22</td>
</tr>
<tr>
<th>89362</th>
<td>801490824</td>
<td>8</td>
<td>BORGBET TIPPING SERVICE</td>
<td>09:15PM</td>
<td>520m</td>
<td>Mixed 3/4</td>
<td>Albion Park</td>
<td>04 Jul 22</td>
</tr>
<tr>
<th>89363</th>
<td>801490825</td>
<td>9</td>
<td>TIGGERLONG TONK @ STUD</td>
<td>09:37PM</td>
<td>395m</td>
<td>Mixed 4/5</td>
<td>Albion Park</td>
<td>04 Jul 22</td>
</tr>
</tbody>
</table>
<p>89364 rows × 8 columns</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The first thing that tripped me up was when <code>FastTrack_DogId</code> for live data was in a string format, and because everything looks like it works, it took ages to find this error. So, let's make sure we deal with it here using:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a>dog_results[&#39;FastTrack_DogId&#39;] = pd.to_numeric(dog_results[&#39;FastTrack_DogId&#39;])
</code></pre></div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="c1">## Cleanse and normalise the data</span>
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a><span class="c1"># Clean up the race dataset</span>
<a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a><span class="n">race_details</span> <span class="o">=</span> <span class="n">race_details</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;@id&#39;</span><span class="p">:</span> <span class="s1">&#39;FastTrack_RaceId&#39;</span><span class="p">})</span>
<a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a><span class="n">race_details</span><span class="p">[</span><span class="s1">&#39;Distance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">race_details</span><span class="p">[</span><span class="s1">&#39;Distance&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;m&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)))</span>
<a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a><span class="n">race_details</span><span class="p">[</span><span class="s1">&#39;date_dt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">race_details</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">],</span> <span class="nb">format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> %b %y&#39;</span><span class="p">)</span>
<a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a><span class="c1"># Clean up the dogs results dataset</span>
<a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a><span class="n">dog_results</span> <span class="o">=</span> <span class="n">dog_results</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;@id&#39;</span><span class="p">:</span> <span class="s1">&#39;FastTrack_DogId&#39;</span><span class="p">,</span> <span class="s1">&#39;RaceId&#39;</span><span class="p">:</span> <span class="s1">&#39;FastTrack_RaceId&#39;</span><span class="p">})</span>
<a id="__codelineno-17-8" name="__codelineno-17-8" href="#__codelineno-17-8"></a>
<a id="__codelineno-17-9" name="__codelineno-17-9" href="#__codelineno-17-9"></a><span class="c1"># New line of code (rest of this code chunk is copied from bruno&#39;s code)</span>
<a id="__codelineno-17-10" name="__codelineno-17-10" href="#__codelineno-17-10"></a><span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;FastTrack_DogId&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;FastTrack_DogId&#39;</span><span class="p">])</span>
<a id="__codelineno-17-11" name="__codelineno-17-11" href="#__codelineno-17-11"></a>
<a id="__codelineno-17-12" name="__codelineno-17-12" href="#__codelineno-17-12"></a><span class="c1"># Combine dogs results with race attributes</span>
<a id="__codelineno-17-13" name="__codelineno-17-13" href="#__codelineno-17-13"></a><span class="n">dog_results</span> <span class="o">=</span> <span class="n">dog_results</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
<a id="__codelineno-17-14" name="__codelineno-17-14" href="#__codelineno-17-14"></a>    <span class="n">race_details</span><span class="p">,</span> 
<a id="__codelineno-17-15" name="__codelineno-17-15" href="#__codelineno-17-15"></a>    <span class="n">how</span> <span class="o">=</span> <span class="s1">&#39;left&#39;</span><span class="p">,</span>
<a id="__codelineno-17-16" name="__codelineno-17-16" href="#__codelineno-17-16"></a>    <span class="n">on</span> <span class="o">=</span> <span class="s1">&#39;FastTrack_RaceId&#39;</span>
<a id="__codelineno-17-17" name="__codelineno-17-17" href="#__codelineno-17-17"></a><span class="p">)</span>
<a id="__codelineno-17-18" name="__codelineno-17-18" href="#__codelineno-17-18"></a>
<a id="__codelineno-17-19" name="__codelineno-17-19" href="#__codelineno-17-19"></a><span class="c1"># Convert StartPrice to probability</span>
<a id="__codelineno-17-20" name="__codelineno-17-20" href="#__codelineno-17-20"></a><span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;StartPrice&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;StartPrice&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;$&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;F&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">x</span><span class="p">)</span>
<a id="__codelineno-17-21" name="__codelineno-17-21" href="#__codelineno-17-21"></a><span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;StartPrice_probability&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;StartPrice&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-17-22" name="__codelineno-17-22" href="#__codelineno-17-22"></a><span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;StartPrice_probability&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dog_results</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;FastTrack_RaceId&#39;</span><span class="p">)[</span><span class="s1">&#39;StartPrice_probability&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
<a id="__codelineno-17-23" name="__codelineno-17-23" href="#__codelineno-17-23"></a>
<a id="__codelineno-17-24" name="__codelineno-17-24" href="#__codelineno-17-24"></a><span class="c1"># Discard entries without results (scratched or did not finish)</span>
<a id="__codelineno-17-25" name="__codelineno-17-25" href="#__codelineno-17-25"></a><span class="n">dog_results</span> <span class="o">=</span> <span class="n">dog_results</span><span class="p">[</span><span class="o">~</span><span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;Box&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span>
<a id="__codelineno-17-26" name="__codelineno-17-26" href="#__codelineno-17-26"></a><span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;Box&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;Box&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<a id="__codelineno-17-27" name="__codelineno-17-27" href="#__codelineno-17-27"></a>
<a id="__codelineno-17-28" name="__codelineno-17-28" href="#__codelineno-17-28"></a><span class="c1"># Clean up other attributes</span>
<a id="__codelineno-17-29" name="__codelineno-17-29" href="#__codelineno-17-29"></a><span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;RunTime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;RunTime&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
<a id="__codelineno-17-30" name="__codelineno-17-30" href="#__codelineno-17-30"></a><span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;SplitMargin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;SplitMargin&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
<a id="__codelineno-17-31" name="__codelineno-17-31" href="#__codelineno-17-31"></a><span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;Prizemoney&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;Prizemoney&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-17-32" name="__codelineno-17-32" href="#__codelineno-17-32"></a><span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;Place&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;Place&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span><span class="p">),</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;coerce&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-17-33" name="__codelineno-17-33" href="#__codelineno-17-33"></a><span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;win&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;Place&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-17-34" name="__codelineno-17-34" href="#__codelineno-17-34"></a>
<a id="__codelineno-17-35" name="__codelineno-17-35" href="#__codelineno-17-35"></a><span class="c1"># Normalise some of the raw values</span>
<a id="__codelineno-17-36" name="__codelineno-17-36" href="#__codelineno-17-36"></a><span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;Prizemoney_norm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;Prizemoney&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">12</span>
<a id="__codelineno-17-37" name="__codelineno-17-37" href="#__codelineno-17-37"></a><span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;Place_inv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;Place&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-17-38" name="__codelineno-17-38" href="#__codelineno-17-38"></a><span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;Place_log&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;Place&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-17-39" name="__codelineno-17-39" href="#__codelineno-17-39"></a><span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;RunSpeed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;RunTime&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;Distance&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</code></pre></div>

</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="c1">## Generate features using raw data</span>
<a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="c1"># Calculate median winner time per track/distance</span>
<a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a><span class="n">win_results</span> <span class="o">=</span> <span class="n">dog_results</span><span class="p">[</span><span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;win&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a><span class="n">median_win_time</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">win_results</span><span class="p">[</span><span class="n">win_results</span><span class="p">[</span><span class="s1">&#39;RunTime&#39;</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;Track&#39;</span><span class="p">,</span> <span class="s1">&#39;Distance&#39;</span><span class="p">])[</span><span class="s1">&#39;RunTime&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">())</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;RunTime&quot;</span><span class="p">:</span> <span class="s2">&quot;RunTime_median&quot;</span><span class="p">})</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a><span class="n">median_win_split_time</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">win_results</span><span class="p">[</span><span class="n">win_results</span><span class="p">[</span><span class="s1">&#39;SplitMargin&#39;</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;Track&#39;</span><span class="p">,</span> <span class="s1">&#39;Distance&#39;</span><span class="p">])[</span><span class="s1">&#39;SplitMargin&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">())</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;SplitMargin&quot;</span><span class="p">:</span> <span class="s2">&quot;SplitMargin_median&quot;</span><span class="p">})</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a><span class="n">median_win_time</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
<a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a>
<a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a><span class="c1"># Calculate track speed index</span>
<a id="__codelineno-18-9" name="__codelineno-18-9" href="#__codelineno-18-9"></a><span class="n">median_win_time</span><span class="p">[</span><span class="s1">&#39;speed_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">median_win_time</span><span class="p">[</span><span class="s1">&#39;RunTime_median&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">median_win_time</span><span class="p">[</span><span class="s1">&#39;Distance&#39;</span><span class="p">])</span>
<a id="__codelineno-18-10" name="__codelineno-18-10" href="#__codelineno-18-10"></a><span class="n">median_win_time</span><span class="p">[</span><span class="s1">&#39;speed_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">MinMaxScaler</span><span class="p">()</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">median_win_time</span><span class="p">[[</span><span class="s1">&#39;speed_index&#39;</span><span class="p">]])</span>
<a id="__codelineno-18-11" name="__codelineno-18-11" href="#__codelineno-18-11"></a><span class="n">median_win_time</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
<a id="__codelineno-18-12" name="__codelineno-18-12" href="#__codelineno-18-12"></a>
<a id="__codelineno-18-13" name="__codelineno-18-13" href="#__codelineno-18-13"></a><span class="c1"># Compare dogs finish time with median winner time</span>
<a id="__codelineno-18-14" name="__codelineno-18-14" href="#__codelineno-18-14"></a><span class="n">dog_results</span> <span class="o">=</span> <span class="n">dog_results</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">median_win_time</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Track&#39;</span><span class="p">,</span> <span class="s1">&#39;Distance&#39;</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
<a id="__codelineno-18-15" name="__codelineno-18-15" href="#__codelineno-18-15"></a><span class="n">dog_results</span> <span class="o">=</span> <span class="n">dog_results</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">median_win_split_time</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Track&#39;</span><span class="p">,</span> <span class="s1">&#39;Distance&#39;</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
<a id="__codelineno-18-16" name="__codelineno-18-16" href="#__codelineno-18-16"></a>
<a id="__codelineno-18-17" name="__codelineno-18-17" href="#__codelineno-18-17"></a><span class="c1"># Normalise time comparison</span>
<a id="__codelineno-18-18" name="__codelineno-18-18" href="#__codelineno-18-18"></a><span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;RunTime_norm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;RunTime_median&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;RunTime&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">)</span>
<a id="__codelineno-18-19" name="__codelineno-18-19" href="#__codelineno-18-19"></a><span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;RunTime_norm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">MinMaxScaler</span><span class="p">()</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">dog_results</span><span class="p">[[</span><span class="s1">&#39;RunTime_norm&#39;</span><span class="p">]])</span>
<a id="__codelineno-18-20" name="__codelineno-18-20" href="#__codelineno-18-20"></a><span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;SplitMargin_norm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;SplitMargin_median&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;SplitMargin&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">)</span>
<a id="__codelineno-18-21" name="__codelineno-18-21" href="#__codelineno-18-21"></a><span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;SplitMargin_norm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">MinMaxScaler</span><span class="p">()</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">dog_results</span><span class="p">[[</span><span class="s1">&#39;SplitMargin_norm&#39;</span><span class="p">]])</span>
<a id="__codelineno-18-22" name="__codelineno-18-22" href="#__codelineno-18-22"></a><span class="n">dog_results</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
<a id="__codelineno-18-23" name="__codelineno-18-23" href="#__codelineno-18-23"></a>
<a id="__codelineno-18-24" name="__codelineno-18-24" href="#__codelineno-18-24"></a><span class="c1"># Calculate box winning percentage for each track/distance</span>
<a id="__codelineno-18-25" name="__codelineno-18-25" href="#__codelineno-18-25"></a><span class="n">box_win_percent</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">dog_results</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;Track&#39;</span><span class="p">,</span> <span class="s1">&#39;Distance&#39;</span><span class="p">,</span> <span class="s1">&#39;Box&#39;</span><span class="p">])[</span><span class="s1">&#39;win&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;win&quot;</span><span class="p">:</span> <span class="s2">&quot;box_win_percent&quot;</span><span class="p">})</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<a id="__codelineno-18-26" name="__codelineno-18-26" href="#__codelineno-18-26"></a><span class="c1"># Add to dog results dataframe</span>
<a id="__codelineno-18-27" name="__codelineno-18-27" href="#__codelineno-18-27"></a><span class="n">dog_results</span> <span class="o">=</span> <span class="n">dog_results</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">box_win_percent</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Track&#39;</span><span class="p">,</span> <span class="s1">&#39;Distance&#39;</span><span class="p">,</span> <span class="s1">&#39;Box&#39;</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
<a id="__codelineno-18-28" name="__codelineno-18-28" href="#__codelineno-18-28"></a><span class="c1"># Display example of barrier winning probabilities</span>
<a id="__codelineno-18-29" name="__codelineno-18-29" href="#__codelineno-18-29"></a><span class="nb">print</span><span class="p">(</span><span class="n">box_win_percent</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>
</code></pre></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_subarea output_stream output_stdout output_text">
<pre>
<code>         Track  Distance  Box  box_win_percent
0  Albion Park       331    1         0.198089
1  Albion Park       331    2         0.152116
2  Albion Park       331    3         0.127354
3  Albion Park       331    4         0.126605
4  Albion Park       331    5         0.111058
5  Albion Park       331    6         0.109304
6  Albion Park       331    7         0.105310
7  Albion Park       331    8         0.115146
</code>
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The second thing that we need to add is related to reserve dogs, and this took me ages to come to this solution, but if you have a better one, please submit a pull request.</p>
<p>Basically, a single greyhound can be a reserve dog for multiple races on the same day. They each appear as a new row in our data frame. For example, 'MACI REID' is a reserve dog for three different races on the 2022-09-02:</p>
<p><img alt="reserve_dogs_example" src="../hta_img/reserve_dogs_example.png" /></p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>When we try lag our data by using <code>.shift(1)</code> like in Bruno's original code it will produce the wrong values for our features. In the above example only the first race The Gardens Race 4 (the third row) will have correct data but all the rows under it will have incorrectly calculated features. We need each of the following rows to be the same as the third row. The solution that I have come up with is a little bit complicated, but it gets the job done:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a># Please submit a pull request if you have a better solution
<a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a>temp = rolling_result.reset_index()
<a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a>temp = temp[temp[&#39;date_dt&#39;] == pd.Timestamp.now().normalize()]
<a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a>temp.groupby([&#39;FastTrack_DogId&#39;,&#39;date_dt&#39;]).first()
<a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a>rolling_result.loc[pd.IndexSlice[:, pd.Timestamp.now().normalize()], :] = temp.groupby([&#39;FastTrack_DogId&#39;,&#39;date_dt&#39;]).first()
</code></pre></div>
<p>Basically, for each greyhound we can just take the first row of data (which is correct) and set the rest of today's races to have the same value</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="c1"># Generate rolling window features</span>
<a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a><span class="n">dataset</span> <span class="o">=</span> <span class="n">dog_results</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a><span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;FastTrack_DogId&#39;</span><span class="p">,</span> <span class="s1">&#39;date_dt&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
<a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a>
<a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a><span class="c1"># Use rolling window of 28, 91 and 365 days</span>
<a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a><span class="n">rolling_windows</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;28D&#39;</span><span class="p">,</span> <span class="s1">&#39;91D&#39;</span><span class="p">,</span> <span class="s1">&#39;365D&#39;</span><span class="p">]</span>
<a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a><span class="c1"># Features to use for rolling windows calculation</span>
<a id="__codelineno-20-8" name="__codelineno-20-8" href="#__codelineno-20-8"></a><span class="n">features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;RunTime_norm&#39;</span><span class="p">,</span> <span class="s1">&#39;SplitMargin_norm&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_inv&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_log&#39;</span><span class="p">,</span> <span class="s1">&#39;Prizemoney_norm&#39;</span><span class="p">]</span>
<a id="__codelineno-20-9" name="__codelineno-20-9" href="#__codelineno-20-9"></a><span class="c1"># Aggregation functions to apply</span>
<a id="__codelineno-20-10" name="__codelineno-20-10" href="#__codelineno-20-10"></a><span class="n">aggregates</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;median&#39;</span><span class="p">,</span> <span class="s1">&#39;std&#39;</span><span class="p">]</span>
<a id="__codelineno-20-11" name="__codelineno-20-11" href="#__codelineno-20-11"></a><span class="c1"># Keep track of generated feature names</span>
<a id="__codelineno-20-12" name="__codelineno-20-12" href="#__codelineno-20-12"></a><span class="n">feature_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;speed_index&#39;</span><span class="p">,</span> <span class="s1">&#39;box_win_percent&#39;</span><span class="p">]</span>
<a id="__codelineno-20-13" name="__codelineno-20-13" href="#__codelineno-20-13"></a>
<a id="__codelineno-20-14" name="__codelineno-20-14" href="#__codelineno-20-14"></a><span class="k">for</span> <span class="n">rolling_window</span> <span class="ow">in</span> <span class="n">rolling_windows</span><span class="p">:</span>
<a id="__codelineno-20-15" name="__codelineno-20-15" href="#__codelineno-20-15"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Processing rolling window </span><span class="si">{</span><span class="n">rolling_window</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-20-16" name="__codelineno-20-16" href="#__codelineno-20-16"></a>
<a id="__codelineno-20-17" name="__codelineno-20-17" href="#__codelineno-20-17"></a>        <span class="n">rolling_result</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-20-18" name="__codelineno-20-18" href="#__codelineno-20-18"></a>            <span class="n">dataset</span>
<a id="__codelineno-20-19" name="__codelineno-20-19" href="#__codelineno-20-19"></a>            <span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
<a id="__codelineno-20-20" name="__codelineno-20-20" href="#__codelineno-20-20"></a>            <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;FastTrack_DogId&#39;</span><span class="p">)[</span><span class="n">features</span><span class="p">]</span>
<a id="__codelineno-20-21" name="__codelineno-20-21" href="#__codelineno-20-21"></a>            <span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">rolling_window</span><span class="p">)</span>
<a id="__codelineno-20-22" name="__codelineno-20-22" href="#__codelineno-20-22"></a>            <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">aggregates</span><span class="p">)</span>
<a id="__codelineno-20-23" name="__codelineno-20-23" href="#__codelineno-20-23"></a>            <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># Thanks to Brett for finding this!</span>
<a id="__codelineno-20-24" name="__codelineno-20-24" href="#__codelineno-20-24"></a>            <span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-20-25" name="__codelineno-20-25" href="#__codelineno-20-25"></a>        <span class="p">)</span>
<a id="__codelineno-20-26" name="__codelineno-20-26" href="#__codelineno-20-26"></a>
<a id="__codelineno-20-27" name="__codelineno-20-27" href="#__codelineno-20-27"></a>        <span class="c1"># My own dodgey code to work with reserve dogs</span>
<a id="__codelineno-20-28" name="__codelineno-20-28" href="#__codelineno-20-28"></a>        <span class="n">temp</span> <span class="o">=</span> <span class="n">rolling_result</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<a id="__codelineno-20-29" name="__codelineno-20-29" href="#__codelineno-20-29"></a>        <span class="n">temp</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="n">temp</span><span class="p">[</span><span class="s1">&#39;date_dt&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">normalize</span><span class="p">()]</span>
<a id="__codelineno-20-30" name="__codelineno-20-30" href="#__codelineno-20-30"></a>        <span class="n">temp</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;FastTrack_DogId&#39;</span><span class="p">,</span><span class="s1">&#39;date_dt&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
<a id="__codelineno-20-31" name="__codelineno-20-31" href="#__codelineno-20-31"></a>        <span class="n">rolling_result</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">IndexSlice</span><span class="p">[:,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">normalize</span><span class="p">()],</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;FastTrack_DogId&#39;</span><span class="p">,</span><span class="s1">&#39;date_dt&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
<a id="__codelineno-20-32" name="__codelineno-20-32" href="#__codelineno-20-32"></a>
<a id="__codelineno-20-33" name="__codelineno-20-33" href="#__codelineno-20-33"></a>        <span class="c1"># Generate list of rolling window feature names (eg: RunTime_norm_min_365D)</span>
<a id="__codelineno-20-34" name="__codelineno-20-34" href="#__codelineno-20-34"></a>        <span class="n">agg_features_cols</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">a</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">rolling_window</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">f</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">aggregates</span><span class="p">)]</span>
<a id="__codelineno-20-35" name="__codelineno-20-35" href="#__codelineno-20-35"></a>        <span class="c1"># Add features to dataset</span>
<a id="__codelineno-20-36" name="__codelineno-20-36" href="#__codelineno-20-36"></a>        <span class="n">dataset</span><span class="p">[</span><span class="n">agg_features_cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">rolling_result</span>
<a id="__codelineno-20-37" name="__codelineno-20-37" href="#__codelineno-20-37"></a>        <span class="c1"># Keep track of generated feature names</span>
<a id="__codelineno-20-38" name="__codelineno-20-38" href="#__codelineno-20-38"></a>        <span class="n">feature_cols</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">agg_features_cols</span><span class="p">)</span>
</code></pre></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_subarea output_stream output_stdout output_text">
<pre>
<code>Processing rolling window 28D
</code>
</pre>
</div>
</div>
<div class="output_area">
<div class="output_subarea output_stream output_stderr output_text">
<pre>
<code>c:\Users\zhoui\greyhounds_bruno\greyhound-modelling\venv_greyhounds\lib\site-packages\pandas\core\generic.py:4150: PerformanceWarning: dropping on a non-lexsorted multi-index without a level parameter may impact performance.
  obj = obj._drop_axis(labels, axis, level=level, errors=errors)
</code>
</pre>
</div>
</div>
<div class="output_area">
<div class="output_subarea output_stream output_stdout output_text">
<pre>
<code>Processing rolling window 91D
</code>
</pre>
</div>
</div>
<div class="output_area">
<div class="output_subarea output_stream output_stderr output_text">
<pre>
<code>c:\Users\zhoui\greyhounds_bruno\greyhound-modelling\venv_greyhounds\lib\site-packages\pandas\core\generic.py:4150: PerformanceWarning: dropping on a non-lexsorted multi-index without a level parameter may impact performance.
  obj = obj._drop_axis(labels, axis, level=level, errors=errors)
</code>
</pre>
</div>
</div>
<div class="output_area">
<div class="output_subarea output_stream output_stdout output_text">
<pre>
<code>Processing rolling window 365D
</code>
</pre>
</div>
</div>
<div class="output_area">
<div class="output_subarea output_stream output_stderr output_text">
<pre>
<code>c:\Users\zhoui\greyhounds_bruno\greyhound-modelling\venv_greyhounds\lib\site-packages\pandas\core\generic.py:4150: PerformanceWarning: dropping on a non-lexsorted multi-index without a level parameter may impact performance.
  obj = obj._drop_axis(labels, axis, level=level, errors=errors)
</code>
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="c1"># Replace missing values with 0</span>
<a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a><span class="n">dataset</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a><span class="n">display</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>
<a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a>
<a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a><span class="c1"># Only keep data after 2018-12-01</span>
<a id="__codelineno-21-6" name="__codelineno-21-6" href="#__codelineno-21-6"></a><span class="n">model_df</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<a id="__codelineno-21-7" name="__codelineno-21-7" href="#__codelineno-21-7"></a><span class="n">feature_cols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">feature_cols</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<a id="__codelineno-21-8" name="__codelineno-21-8" href="#__codelineno-21-8"></a><span class="n">model_df</span> <span class="o">=</span> <span class="n">model_df</span><span class="p">[</span><span class="n">model_df</span><span class="p">[</span><span class="s1">&#39;date_dt&#39;</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span><span class="o">=</span> <span class="s1">&#39;2018-12-01&#39;</span><span class="p">]</span>
<a id="__codelineno-21-9" name="__codelineno-21-9" href="#__codelineno-21-9"></a>
<a id="__codelineno-21-10" name="__codelineno-21-10" href="#__codelineno-21-10"></a><span class="c1"># This line was originally part of Bruno&#39;s tutorial, but we don&#39;t run it in this script</span>
<a id="__codelineno-21-11" name="__codelineno-21-11" href="#__codelineno-21-11"></a><span class="c1"># model_df = model_df[[&#39;date_dt&#39;, &#39;FastTrack_RaceId&#39;, &#39;DogName&#39;, &#39;win&#39;, &#39;StartPrice_probability&#39;] + feature_cols]</span>
<a id="__codelineno-21-12" name="__codelineno-21-12" href="#__codelineno-21-12"></a>
<a id="__codelineno-21-13" name="__codelineno-21-13" href="#__codelineno-21-13"></a><span class="c1"># Only train model off of races where each dog has a value for each feature</span>
<a id="__codelineno-21-14" name="__codelineno-21-14" href="#__codelineno-21-14"></a><span class="n">races_exclude</span> <span class="o">=</span> <span class="n">model_df</span><span class="p">[</span><span class="n">model_df</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)][</span><span class="s1">&#39;FastTrack_RaceId&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
<a id="__codelineno-21-15" name="__codelineno-21-15" href="#__codelineno-21-15"></a><span class="n">model_df</span> <span class="o">=</span> <span class="n">model_df</span><span class="p">[</span><span class="o">~</span><span class="n">model_df</span><span class="p">[</span><span class="s1">&#39;FastTrack_RaceId&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">races_exclude</span><span class="p">)]</span>
</code></pre></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_html rendered_html output_subarea">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th></th>
<th></th>
<th>Place</th>
<th>DogName</th>
<th>Box</th>
<th>Rug</th>
<th>Weight</th>
<th>StartPrice</th>
<th>Handicap</th>
<th>Margin1</th>
<th>Margin2</th>
<th>PIR</th>
<th>Checks</th>
<th>Comments</th>
<th>SplitMargin</th>
<th>RunTime</th>
<th>Prizemoney</th>
<th>FastTrack_RaceId</th>
<th>TrainerId</th>
<th>TrainerName</th>
<th>RaceNum</th>
<th>RaceName</th>
<th>RaceTime</th>
<th>Distance</th>
<th>RaceGrade</th>
<th>Track</th>
<th>date</th>
<th>StartPrice_probability</th>
<th>win</th>
<th>Prizemoney_norm</th>
<th>Place_inv</th>
<th>Place_log</th>
<th>RunSpeed</th>
<th>RunTime_median</th>
<th>speed_index</th>
<th>SplitMargin_median</th>
<th>RunTime_norm</th>
<th>SplitMargin_norm</th>
<th>box_win_percent</th>
<th>RunTime_norm_min_28D</th>
<th>RunTime_norm_max_28D</th>
<th>RunTime_norm_mean_28D</th>
<th>RunTime_norm_median_28D</th>
<th>RunTime_norm_std_28D</th>
<th>SplitMargin_norm_min_28D</th>
<th>SplitMargin_norm_max_28D</th>
<th>SplitMargin_norm_mean_28D</th>
<th>SplitMargin_norm_median_28D</th>
<th>SplitMargin_norm_std_28D</th>
<th>Place_inv_min_28D</th>
<th>Place_inv_max_28D</th>
<th>Place_inv_mean_28D</th>
<th>Place_inv_median_28D</th>
<th>Place_inv_std_28D</th>
<th>Place_log_min_28D</th>
<th>Place_log_max_28D</th>
<th>Place_log_mean_28D</th>
<th>Place_log_median_28D</th>
<th>Place_log_std_28D</th>
<th>Prizemoney_norm_min_28D</th>
<th>Prizemoney_norm_max_28D</th>
<th>Prizemoney_norm_mean_28D</th>
<th>Prizemoney_norm_median_28D</th>
<th>Prizemoney_norm_std_28D</th>
<th>RunTime_norm_min_91D</th>
<th>RunTime_norm_max_91D</th>
<th>RunTime_norm_mean_91D</th>
<th>RunTime_norm_median_91D</th>
<th>RunTime_norm_std_91D</th>
<th>SplitMargin_norm_min_91D</th>
<th>SplitMargin_norm_max_91D</th>
<th>SplitMargin_norm_mean_91D</th>
<th>SplitMargin_norm_median_91D</th>
<th>SplitMargin_norm_std_91D</th>
<th>Place_inv_min_91D</th>
<th>Place_inv_max_91D</th>
<th>Place_inv_mean_91D</th>
<th>Place_inv_median_91D</th>
<th>Place_inv_std_91D</th>
<th>Place_log_min_91D</th>
<th>Place_log_max_91D</th>
<th>Place_log_mean_91D</th>
<th>Place_log_median_91D</th>
<th>Place_log_std_91D</th>
<th>Prizemoney_norm_min_91D</th>
<th>Prizemoney_norm_max_91D</th>
<th>Prizemoney_norm_mean_91D</th>
<th>Prizemoney_norm_median_91D</th>
<th>Prizemoney_norm_std_91D</th>
<th>RunTime_norm_min_365D</th>
<th>RunTime_norm_max_365D</th>
<th>RunTime_norm_mean_365D</th>
<th>RunTime_norm_median_365D</th>
<th>RunTime_norm_std_365D</th>
<th>SplitMargin_norm_min_365D</th>
<th>SplitMargin_norm_max_365D</th>
<th>SplitMargin_norm_mean_365D</th>
<th>SplitMargin_norm_median_365D</th>
<th>SplitMargin_norm_std_365D</th>
<th>Place_inv_min_365D</th>
<th>Place_inv_max_365D</th>
<th>Place_inv_mean_365D</th>
<th>Place_inv_median_365D</th>
<th>Place_inv_std_365D</th>
<th>Place_log_min_365D</th>
<th>Place_log_max_365D</th>
<th>Place_log_mean_365D</th>
<th>Place_log_median_365D</th>
<th>Place_log_std_365D</th>
<th>Prizemoney_norm_min_365D</th>
<th>Prizemoney_norm_max_365D</th>
<th>Prizemoney_norm_mean_365D</th>
<th>Prizemoney_norm_median_365D</th>
<th>Prizemoney_norm_std_365D</th>
</tr>
<tr>
<th>FastTrack_DogId</th>
<th>date_dt</th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<th rowspan="8" valign="top">-2143477291</th>
<th>2018-09-02</th>
<td>7.0</td>
<td>YOU TELAM ANFY</td>
<td>1</td>
<td>1</td>
<td>31.2</td>
<td>5.2</td>
<td>0.0</td>
<td>7.0</td>
<td>0.57</td>
<td>8</td>
<td>0</td>
<td>8.0</td>
<td>7.48</td>
<td>19.85</td>
<td>0.0</td>
<td>354469749</td>
<td>8462</td>
<td>A Bunney</td>
<td>12</td>
<td>BRISGREYS.COM</td>
<td>09:01PM</td>
<td>331</td>
<td>GRADE 5  PATHWAY NON-PENALTY</td>
<td>Albion Park</td>
<td>02 Sep 18</td>
<td>0.161184</td>
<td>0</td>
<td>0.0</td>
<td>0.142857</td>
<td>0.903090</td>
<td>0.059970</td>
<td>19.17</td>
<td>0.600092</td>
<td>7.18</td>
<td>0.328715</td>
<td>0.299465</td>
<td>0.198089</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.00000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
</tr>
<tr>
<th>2018-09-16</th>
<td>4.0</td>
<td>YOU TELAM ANFY</td>
<td>1</td>
<td>1</td>
<td>31.0</td>
<td>61.0</td>
<td>0.0</td>
<td>10.0</td>
<td>5.0</td>
<td>8</td>
<td>0</td>
<td>8.0</td>
<td>7.43</td>
<td>19.75</td>
<td>0.0</td>
<td>360928569</td>
<td>8462</td>
<td>A Bunney</td>
<td>11</td>
<td>SKY RACING</td>
<td>05:24PM</td>
<td>331</td>
<td>Grade 5</td>
<td>Albion Park</td>
<td>16 Sep 18</td>
<td>0.013847</td>
<td>0</td>
<td>0.0</td>
<td>0.250000</td>
<td>0.698970</td>
<td>0.059668</td>
<td>19.17</td>
<td>0.600092</td>
<td>7.18</td>
<td>0.353165</td>
<td>0.331763</td>
<td>0.198089</td>
<td>0.328715</td>
<td>0.328715</td>
<td>0.328715</td>
<td>0.328715</td>
<td>0.000000</td>
<td>0.299465</td>
<td>0.299465</td>
<td>0.299465</td>
<td>0.299465</td>
<td>0.000000</td>
<td>0.142857</td>
<td>0.142857</td>
<td>0.142857</td>
<td>0.142857</td>
<td>0.000000</td>
<td>0.903090</td>
<td>0.903090</td>
<td>0.903090</td>
<td>0.903090</td>
<td>0.000000</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.328715</td>
<td>0.328715</td>
<td>0.328715</td>
<td>0.328715</td>
<td>0.000000</td>
<td>0.299465</td>
<td>0.299465</td>
<td>0.299465</td>
<td>0.299465</td>
<td>0.000000</td>
<td>0.142857</td>
<td>0.142857</td>
<td>0.142857</td>
<td>0.142857</td>
<td>0.000000</td>
<td>0.903090</td>
<td>0.903090</td>
<td>0.903090</td>
<td>0.903090</td>
<td>0.000000</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.328715</td>
<td>0.328715</td>
<td>0.328715</td>
<td>0.328715</td>
<td>0.000000</td>
<td>0.299465</td>
<td>0.299465</td>
<td>0.299465</td>
<td>0.299465</td>
<td>0.000000</td>
<td>0.142857</td>
<td>0.142857</td>
<td>0.142857</td>
<td>0.142857</td>
<td>0.000000</td>
<td>0.90309</td>
<td>0.903090</td>
<td>0.903090</td>
<td>0.903090</td>
<td>0.000000</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
</tr>
<tr>
<th>2018-10-07</th>
<td>7.0</td>
<td>YOU TELAM ANFY</td>
<td>1</td>
<td>1</td>
<td>30.5</td>
<td>71.0</td>
<td>0.0</td>
<td>8.25</td>
<td>4.0</td>
<td>7</td>
<td>0</td>
<td>7.0</td>
<td>7.42</td>
<td>19.71</td>
<td>0.0</td>
<td>367774713</td>
<td>8462</td>
<td>A Bunney</td>
<td>11</td>
<td>SKY RACING</td>
<td>08:27PM</td>
<td>331</td>
<td>Grade 5</td>
<td>Albion Park</td>
<td>07 Oct 18</td>
<td>0.011604</td>
<td>0</td>
<td>0.0</td>
<td>0.142857</td>
<td>0.903090</td>
<td>0.059547</td>
<td>19.17</td>
<td>0.600092</td>
<td>7.18</td>
<td>0.363014</td>
<td>0.338275</td>
<td>0.198089</td>
<td>0.328715</td>
<td>0.353165</td>
<td>0.340940</td>
<td>0.340940</td>
<td>0.017288</td>
<td>0.299465</td>
<td>0.331763</td>
<td>0.315614</td>
<td>0.315614</td>
<td>0.022838</td>
<td>0.142857</td>
<td>0.250000</td>
<td>0.196429</td>
<td>0.196429</td>
<td>0.075761</td>
<td>0.698970</td>
<td>0.903090</td>
<td>0.801030</td>
<td>0.801030</td>
<td>0.144335</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.328715</td>
<td>0.353165</td>
<td>0.340940</td>
<td>0.340940</td>
<td>0.017288</td>
<td>0.299465</td>
<td>0.331763</td>
<td>0.315614</td>
<td>0.315614</td>
<td>0.022838</td>
<td>0.142857</td>
<td>0.250000</td>
<td>0.196429</td>
<td>0.196429</td>
<td>0.075761</td>
<td>0.698970</td>
<td>0.903090</td>
<td>0.801030</td>
<td>0.801030</td>
<td>0.144335</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.328715</td>
<td>0.353165</td>
<td>0.340940</td>
<td>0.340940</td>
<td>0.017288</td>
<td>0.299465</td>
<td>0.331763</td>
<td>0.315614</td>
<td>0.315614</td>
<td>0.022838</td>
<td>0.142857</td>
<td>0.250000</td>
<td>0.196429</td>
<td>0.196429</td>
<td>0.075761</td>
<td>0.69897</td>
<td>0.903090</td>
<td>0.801030</td>
<td>0.801030</td>
<td>0.144335</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
</tr>
<tr>
<th>2018-10-21</th>
<td>5.0</td>
<td>YOU TELAM ANFY</td>
<td>7</td>
<td>9</td>
<td>29.8</td>
<td>26.0</td>
<td>0.0</td>
<td>5.25</td>
<td>0.29</td>
<td>6</td>
<td>0</td>
<td>6.0</td>
<td>7.46</td>
<td>19.85</td>
<td>0.0</td>
<td>370420123</td>
<td>8462</td>
<td>A Bunney</td>
<td>12</td>
<td>ZILLMERE SPORTS</td>
<td>08:55PM</td>
<td>331</td>
<td>GRADE 5  PATHWAY NON-PENALTY</td>
<td>Albion Park</td>
<td>21 Oct 18</td>
<td>0.032235</td>
<td>0</td>
<td>0.0</td>
<td>0.200000</td>
<td>0.778151</td>
<td>0.059970</td>
<td>19.17</td>
<td>0.600092</td>
<td>7.18</td>
<td>0.328715</td>
<td>0.312332</td>
<td>0.105310</td>
<td>0.353165</td>
<td>0.363014</td>
<td>0.358089</td>
<td>0.358089</td>
<td>0.006964</td>
<td>0.331763</td>
<td>0.338275</td>
<td>0.335019</td>
<td>0.335019</td>
<td>0.004605</td>
<td>0.142857</td>
<td>0.250000</td>
<td>0.196429</td>
<td>0.196429</td>
<td>0.075761</td>
<td>0.698970</td>
<td>0.903090</td>
<td>0.801030</td>
<td>0.801030</td>
<td>0.144335</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.328715</td>
<td>0.363014</td>
<td>0.348298</td>
<td>0.353165</td>
<td>0.017659</td>
<td>0.299465</td>
<td>0.338275</td>
<td>0.323168</td>
<td>0.331763</td>
<td>0.020784</td>
<td>0.142857</td>
<td>0.250000</td>
<td>0.178571</td>
<td>0.142857</td>
<td>0.061859</td>
<td>0.698970</td>
<td>0.903090</td>
<td>0.835050</td>
<td>0.903090</td>
<td>0.117849</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.328715</td>
<td>0.363014</td>
<td>0.348298</td>
<td>0.353165</td>
<td>0.017659</td>
<td>0.299465</td>
<td>0.338275</td>
<td>0.323168</td>
<td>0.331763</td>
<td>0.020784</td>
<td>0.142857</td>
<td>0.250000</td>
<td>0.178571</td>
<td>0.142857</td>
<td>0.061859</td>
<td>0.69897</td>
<td>0.903090</td>
<td>0.835050</td>
<td>0.903090</td>
<td>0.117849</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
</tr>
<tr>
<th>2018-11-18</th>
<td>5.0</td>
<td>YOU TELAM ANFY</td>
<td>1</td>
<td>1</td>
<td>30.2</td>
<td>41.0</td>
<td>0.0</td>
<td>6.25</td>
<td>3.14</td>
<td>6</td>
<td>0</td>
<td>6.0</td>
<td>7.43</td>
<td>19.86</td>
<td>0.0</td>
<td>378695693</td>
<td>8462</td>
<td>A Bunney</td>
<td>10</td>
<td>ZILLMERE SPORTS</td>
<td>08:16PM</td>
<td>331</td>
<td>Grade 5</td>
<td>Albion Park</td>
<td>18 Nov 18</td>
<td>0.020215</td>
<td>0</td>
<td>0.0</td>
<td>0.200000</td>
<td>0.778151</td>
<td>0.060000</td>
<td>19.17</td>
<td>0.600092</td>
<td>7.18</td>
<td>0.326284</td>
<td>0.331763</td>
<td>0.198089</td>
<td>0.328715</td>
<td>0.363014</td>
<td>0.345865</td>
<td>0.345865</td>
<td>0.024253</td>
<td>0.312332</td>
<td>0.338275</td>
<td>0.325304</td>
<td>0.325304</td>
<td>0.018344</td>
<td>0.142857</td>
<td>0.200000</td>
<td>0.171429</td>
<td>0.171429</td>
<td>0.040406</td>
<td>0.778151</td>
<td>0.903090</td>
<td>0.840621</td>
<td>0.840621</td>
<td>0.088345</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.328715</td>
<td>0.363014</td>
<td>0.343402</td>
<td>0.340940</td>
<td>0.017429</td>
<td>0.299465</td>
<td>0.338275</td>
<td>0.320459</td>
<td>0.322048</td>
<td>0.017814</td>
<td>0.142857</td>
<td>0.250000</td>
<td>0.183929</td>
<td>0.171429</td>
<td>0.051632</td>
<td>0.698970</td>
<td>0.903090</td>
<td>0.820825</td>
<td>0.840621</td>
<td>0.100341</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.328715</td>
<td>0.363014</td>
<td>0.343402</td>
<td>0.340940</td>
<td>0.017429</td>
<td>0.299465</td>
<td>0.338275</td>
<td>0.320459</td>
<td>0.322048</td>
<td>0.017814</td>
<td>0.142857</td>
<td>0.250000</td>
<td>0.183929</td>
<td>0.171429</td>
<td>0.051632</td>
<td>0.69897</td>
<td>0.903090</td>
<td>0.820825</td>
<td>0.840621</td>
<td>0.100341</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
</tr>
<tr>
<th>2019-06-23</th>
<td>5.0</td>
<td>YOU TELAM ANFY</td>
<td>1</td>
<td>1</td>
<td>29.6</td>
<td>51.0</td>
<td>0.0</td>
<td>5.75</td>
<td>0.86</td>
<td>8</td>
<td>0</td>
<td>8.0</td>
<td>7.44</td>
<td>19.66</td>
<td>0.0</td>
<td>445056131</td>
<td>8462</td>
<td>A Bunney</td>
<td>9</td>
<td>GREYHOUND ADOPTION PROGRAM</td>
<td>07:54PM</td>
<td>331</td>
<td>Grade 5</td>
<td>Albion Park</td>
<td>23 Jun 19</td>
<td>0.016271</td>
<td>0</td>
<td>0.0</td>
<td>0.200000</td>
<td>0.778151</td>
<td>0.059396</td>
<td>19.17</td>
<td>0.600092</td>
<td>7.18</td>
<td>0.375381</td>
<td>0.325269</td>
<td>0.198089</td>
<td>0.326284</td>
<td>0.326284</td>
<td>0.326284</td>
<td>0.326284</td>
<td>0.000000</td>
<td>0.331763</td>
<td>0.331763</td>
<td>0.331763</td>
<td>0.331763</td>
<td>0.000000</td>
<td>0.200000</td>
<td>0.200000</td>
<td>0.200000</td>
<td>0.200000</td>
<td>0.000000</td>
<td>0.778151</td>
<td>0.778151</td>
<td>0.778151</td>
<td>0.778151</td>
<td>0.000000</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.326284</td>
<td>0.363014</td>
<td>0.339979</td>
<td>0.328715</td>
<td>0.016924</td>
<td>0.299465</td>
<td>0.338275</td>
<td>0.322720</td>
<td>0.331763</td>
<td>0.016234</td>
<td>0.142857</td>
<td>0.250000</td>
<td>0.187143</td>
<td>0.200000</td>
<td>0.045288</td>
<td>0.698970</td>
<td>0.903090</td>
<td>0.812290</td>
<td>0.778151</td>
<td>0.088969</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.326284</td>
<td>0.363014</td>
<td>0.339979</td>
<td>0.328715</td>
<td>0.016924</td>
<td>0.299465</td>
<td>0.338275</td>
<td>0.322720</td>
<td>0.331763</td>
<td>0.016234</td>
<td>0.142857</td>
<td>0.250000</td>
<td>0.187143</td>
<td>0.200000</td>
<td>0.045288</td>
<td>0.69897</td>
<td>0.903090</td>
<td>0.812290</td>
<td>0.778151</td>
<td>0.088969</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
</tr>
<tr>
<th>2019-06-30</th>
<td>8.0</td>
<td>YOU TELAM ANFY</td>
<td>4</td>
<td>10</td>
<td>29.5</td>
<td>51.0</td>
<td>0.0</td>
<td>17.25</td>
<td>2.0</td>
<td>7</td>
<td>0</td>
<td>7.0</td>
<td>11.38</td>
<td>24.16</td>
<td>0.0</td>
<td>448789428</td>
<td>8462</td>
<td>A Bunney</td>
<td>7</td>
<td>SKY RACING</td>
<td>07:45PM</td>
<td>395</td>
<td>Open</td>
<td>Albion Park</td>
<td>30 Jun 19</td>
<td>0.015995</td>
<td>0</td>
<td>0.0</td>
<td>0.125000</td>
<td>0.954243</td>
<td>0.061165</td>
<td>22.85</td>
<td>0.588509</td>
<td>10.58</td>
<td>0.228891</td>
<td>0.148506</td>
<td>0.130206</td>
<td>0.375381</td>
<td>0.375381</td>
<td>0.375381</td>
<td>0.375381</td>
<td>0.000000</td>
<td>0.325269</td>
<td>0.325269</td>
<td>0.325269</td>
<td>0.325269</td>
<td>0.000000</td>
<td>0.200000</td>
<td>0.200000</td>
<td>0.200000</td>
<td>0.200000</td>
<td>0.000000</td>
<td>0.778151</td>
<td>0.778151</td>
<td>0.778151</td>
<td>0.778151</td>
<td>0.000000</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.375381</td>
<td>0.375381</td>
<td>0.375381</td>
<td>0.375381</td>
<td>0.000000</td>
<td>0.325269</td>
<td>0.325269</td>
<td>0.325269</td>
<td>0.325269</td>
<td>0.000000</td>
<td>0.200000</td>
<td>0.200000</td>
<td>0.200000</td>
<td>0.200000</td>
<td>0.000000</td>
<td>0.778151</td>
<td>0.778151</td>
<td>0.778151</td>
<td>0.778151</td>
<td>0.000000</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.326284</td>
<td>0.375381</td>
<td>0.345879</td>
<td>0.340940</td>
<td>0.020929</td>
<td>0.299465</td>
<td>0.338275</td>
<td>0.323145</td>
<td>0.328516</td>
<td>0.014558</td>
<td>0.142857</td>
<td>0.250000</td>
<td>0.189286</td>
<td>0.200000</td>
<td>0.040846</td>
<td>0.69897</td>
<td>0.903090</td>
<td>0.806601</td>
<td>0.778151</td>
<td>0.080787</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
</tr>
<tr>
<th>2019-08-25</th>
<td>6.0</td>
<td>YOU TELAM ANFY</td>
<td>4</td>
<td>4</td>
<td>29.5</td>
<td>14.0</td>
<td>0.0</td>
<td>5.0</td>
<td>0.57</td>
<td>3</td>
<td>0</td>
<td>3.0</td>
<td>7.33</td>
<td>19.72</td>
<td>0.0</td>
<td>465432748</td>
<td>8462</td>
<td>A Bunney</td>
<td>9</td>
<td>FABREGAS @ METICULOUS LODGE</td>
<td>07:40PM</td>
<td>331</td>
<td>Masters Grade 5</td>
<td>Albion Park</td>
<td>25 Aug 19</td>
<td>0.058684</td>
<td>0</td>
<td>0.0</td>
<td>0.166667</td>
<td>0.845098</td>
<td>0.059577</td>
<td>19.17</td>
<td>0.600092</td>
<td>7.18</td>
<td>0.360548</td>
<td>0.397681</td>
<td>0.126605</td>
<td>0.228891</td>
<td>0.375381</td>
<td>0.302136</td>
<td>0.302136</td>
<td>0.103585</td>
<td>0.148506</td>
<td>0.325269</td>
<td>0.236887</td>
<td>0.236887</td>
<td>0.124990</td>
<td>0.125000</td>
<td>0.200000</td>
<td>0.162500</td>
<td>0.162500</td>
<td>0.053033</td>
<td>0.778151</td>
<td>0.954243</td>
<td>0.866197</td>
<td>0.866197</td>
<td>0.124515</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.228891</td>
<td>0.375381</td>
<td>0.302136</td>
<td>0.302136</td>
<td>0.103585</td>
<td>0.148506</td>
<td>0.325269</td>
<td>0.236887</td>
<td>0.236887</td>
<td>0.124990</td>
<td>0.125000</td>
<td>0.200000</td>
<td>0.162500</td>
<td>0.162500</td>
<td>0.053033</td>
<td>0.778151</td>
<td>0.954243</td>
<td>0.866197</td>
<td>0.866197</td>
<td>0.124515</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.228891</td>
<td>0.375381</td>
<td>0.329166</td>
<td>0.328715</td>
<td>0.048169</td>
<td>0.148506</td>
<td>0.338275</td>
<td>0.298196</td>
<td>0.325269</td>
<td>0.067332</td>
<td>0.125000</td>
<td>0.250000</td>
<td>0.180102</td>
<td>0.200000</td>
<td>0.044505</td>
<td>0.69897</td>
<td>0.954243</td>
<td>0.827692</td>
<td>0.778151</td>
<td>0.092481</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<hr />
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="generate-predictions">Generate predictions</h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now this is the part that gets a bit hairy, so I am going to split it up into two parts. The good thing is that the coding will remain relatively simple.</p>
<p>The two things that I want to do is place live bets and save our predictions so that we can use them in a simulator we will create in the <a href="../How_to_Automate_5">Part V</a>.</p>
<p>Let's save our historical ratings for our simulator first as its quick and straight forward and then move on to placing live bets:</p>
<!-- There are two things we are
but , the coding will all be very simple bu idea can get a bit confusing. 

This is where I am going to take a quick step back. Because not only do I want to be able to predict things live and use that to place bets I also want to generate predictions for our historic data and then put that through a simulator we will create later on. So this next part is entirely optional, if you don't want to simulate model performance you can skip to the next section.  -->
<!-- This is where I wanted to take a step back. Not only do I want to be able to 
However since historic files do not have reserve dogs/scratching, if we wanted to simulate the exchange with historic files we could just predict probabilities no

However what I actually want to do is be able to get the correct
I've spent hours working around this and the best solution I have come up with is to use the `market_catalogue` from the Betfair API to retrieve the list of dogs that will run in a race. Using the list we can select the corresponding data from our dataframe.

But this presents a second problem, because we will have multiple entries for the same dog because of reserve dogs. So then we will need select the correct one otherwise things such as box will be wrong. There are a few ways around this, you can merge on Track Name and Race Name, but the solution I have come up with is selecting the FastTrack_RaceId: -->
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="getting-data-ready-for-our-simulator">Getting data ready for our simulator</h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Feeding our predictions through the simulator is entirely optional, but, in my opinion it is where the real sauce is made. The idea is that if we are testing our model live, we can also use the simulator to test what would happen if we tested different staking methodologies, market timings and bet placement to optimise our model. This way you can have a model but test out different strategies to optimise model performance. The thing is, I have had a play with the simulator already and we can't simulate <code>market_catalogue</code> unless you have recorded it yourself (which is what I'll be using to get <code>market_id</code> and <code>selection_id</code> to place live bets). The simulator we will use later on will only take your ratings, market_id and selection_id, so we need our data in a similar format to what we had in <a href="../How_to_Automate_3">How to automate III</a>. In other words, since we don't have  <code>market_catalogue</code> in the simulator, we need another way to get the market_id and selection_id.</p>
<p>My hacky work around is to generate the probabilities like normal (since the data is historical), we don't need to deal with reserve dogs and scratching's, then get the <code>market_id</code> and <code>selection_id</code> from the Betfair datascience greyhound model by merging on DogName and date. We can take the code we wrote in <a href="../How_to_Automate_3">How to automate III</a> that downloads the greyhound ratings and convert that into a function that downloads the ratings for a date range.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="c1"># Generate predictions like normal</span>
<a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a><span class="c1"># Range of dates that we want to simulate later &#39;2022-03-01&#39; to &#39;2022-04-01&#39;</span>
<a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a><span class="n">todays_data</span> <span class="o">=</span> <span class="n">model_df</span><span class="p">[(</span><span class="n">model_df</span><span class="p">[</span><span class="s1">&#39;date_dt&#39;</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span><span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2022-03-01&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">))</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span> <span class="p">(</span><span class="n">model_df</span><span class="p">[</span><span class="s1">&#39;date_dt&#39;</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2022-04-01&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">))]</span>
<a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a><span class="n">dog_win_probabilities</span> <span class="o">=</span> <span class="n">brunos_model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">todays_data</span><span class="p">[</span><span class="n">feature_cols</span><span class="p">])[:,</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a><span class="n">todays_data</span><span class="p">[</span><span class="s1">&#39;prob_LogisticRegression&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dog_win_probabilities</span>
<a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a><span class="n">todays_data</span><span class="p">[</span><span class="s1">&#39;renormalise_prob&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">todays_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;FastTrack_RaceId&#39;</span><span class="p">)[</span><span class="s1">&#39;prob_LogisticRegression&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
<a id="__codelineno-22-7" name="__codelineno-22-7" href="#__codelineno-22-7"></a><span class="n">todays_data</span><span class="p">[</span><span class="s1">&#39;rating&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">todays_data</span><span class="p">[</span><span class="s1">&#39;renormalise_prob&#39;</span><span class="p">]</span>
<a id="__codelineno-22-8" name="__codelineno-22-8" href="#__codelineno-22-8"></a><span class="n">todays_data</span> <span class="o">=</span> <span class="n">todays_data</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span> <span class="o">=</span> <span class="s1">&#39;date_dt&#39;</span><span class="p">)</span>
<a id="__codelineno-22-9" name="__codelineno-22-9" href="#__codelineno-22-9"></a><span class="n">todays_data</span>
</code></pre></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_subarea output_stream output_stderr output_text">
<pre>
<code>C:\Users\zhoui\AppData\Local\Temp/ipykernel_25584/3121846001.py:5: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  todays_data['prob_LogisticRegression'] = dog_win_probabilities
C:\Users\zhoui\AppData\Local\Temp/ipykernel_25584/3121846001.py:6: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  todays_data['renormalise_prob'] = todays_data.groupby('FastTrack_RaceId')['prob_LogisticRegression'].apply(lambda x: x / x.sum())
C:\Users\zhoui\AppData\Local\Temp/ipykernel_25584/3121846001.py:7: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  todays_data['rating'] = 1/todays_data['renormalise_prob']
</code>
</pre>
</div>
</div>
<div class="output_area">
<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th></th>
<th>FastTrack_DogId</th>
<th>date_dt</th>
<th>Place</th>
<th>DogName</th>
<th>Box</th>
<th>Rug</th>
<th>Weight</th>
<th>StartPrice</th>
<th>Handicap</th>
<th>Margin1</th>
<th>Margin2</th>
<th>PIR</th>
<th>Checks</th>
<th>Comments</th>
<th>SplitMargin</th>
<th>RunTime</th>
<th>Prizemoney</th>
<th>FastTrack_RaceId</th>
<th>TrainerId</th>
<th>TrainerName</th>
<th>RaceNum</th>
<th>RaceName</th>
<th>RaceTime</th>
<th>Distance</th>
<th>RaceGrade</th>
<th>Track</th>
<th>date</th>
<th>StartPrice_probability</th>
<th>win</th>
<th>Prizemoney_norm</th>
<th>Place_inv</th>
<th>Place_log</th>
<th>RunSpeed</th>
<th>RunTime_median</th>
<th>speed_index</th>
<th>SplitMargin_median</th>
<th>RunTime_norm</th>
<th>SplitMargin_norm</th>
<th>box_win_percent</th>
<th>RunTime_norm_min_28D</th>
<th>RunTime_norm_max_28D</th>
<th>RunTime_norm_mean_28D</th>
<th>RunTime_norm_median_28D</th>
<th>RunTime_norm_std_28D</th>
<th>SplitMargin_norm_min_28D</th>
<th>SplitMargin_norm_max_28D</th>
<th>SplitMargin_norm_mean_28D</th>
<th>SplitMargin_norm_median_28D</th>
<th>SplitMargin_norm_std_28D</th>
<th>Place_inv_min_28D</th>
<th>Place_inv_max_28D</th>
<th>Place_inv_mean_28D</th>
<th>Place_inv_median_28D</th>
<th>Place_inv_std_28D</th>
<th>Place_log_min_28D</th>
<th>Place_log_max_28D</th>
<th>Place_log_mean_28D</th>
<th>Place_log_median_28D</th>
<th>Place_log_std_28D</th>
<th>Prizemoney_norm_min_28D</th>
<th>Prizemoney_norm_max_28D</th>
<th>Prizemoney_norm_mean_28D</th>
<th>Prizemoney_norm_median_28D</th>
<th>Prizemoney_norm_std_28D</th>
<th>RunTime_norm_min_91D</th>
<th>RunTime_norm_max_91D</th>
<th>RunTime_norm_mean_91D</th>
<th>RunTime_norm_median_91D</th>
<th>RunTime_norm_std_91D</th>
<th>SplitMargin_norm_min_91D</th>
<th>SplitMargin_norm_max_91D</th>
<th>SplitMargin_norm_mean_91D</th>
<th>SplitMargin_norm_median_91D</th>
<th>SplitMargin_norm_std_91D</th>
<th>Place_inv_min_91D</th>
<th>Place_inv_max_91D</th>
<th>Place_inv_mean_91D</th>
<th>Place_inv_median_91D</th>
<th>Place_inv_std_91D</th>
<th>Place_log_min_91D</th>
<th>Place_log_max_91D</th>
<th>Place_log_mean_91D</th>
<th>Place_log_median_91D</th>
<th>Place_log_std_91D</th>
<th>Prizemoney_norm_min_91D</th>
<th>Prizemoney_norm_max_91D</th>
<th>Prizemoney_norm_mean_91D</th>
<th>Prizemoney_norm_median_91D</th>
<th>Prizemoney_norm_std_91D</th>
<th>RunTime_norm_min_365D</th>
<th>RunTime_norm_max_365D</th>
<th>RunTime_norm_mean_365D</th>
<th>RunTime_norm_median_365D</th>
<th>RunTime_norm_std_365D</th>
<th>SplitMargin_norm_min_365D</th>
<th>SplitMargin_norm_max_365D</th>
<th>SplitMargin_norm_mean_365D</th>
<th>SplitMargin_norm_median_365D</th>
<th>SplitMargin_norm_std_365D</th>
<th>Place_inv_min_365D</th>
<th>Place_inv_max_365D</th>
<th>Place_inv_mean_365D</th>
<th>Place_inv_median_365D</th>
<th>Place_inv_std_365D</th>
<th>Place_log_min_365D</th>
<th>Place_log_max_365D</th>
<th>Place_log_mean_365D</th>
<th>Place_log_median_365D</th>
<th>Place_log_std_365D</th>
<th>Prizemoney_norm_min_365D</th>
<th>Prizemoney_norm_max_365D</th>
<th>Prizemoney_norm_mean_365D</th>
<th>Prizemoney_norm_median_365D</th>
<th>Prizemoney_norm_std_365D</th>
<th>prob_LogisticRegression</th>
<th>renormalise_prob</th>
<th>rating</th>
</tr>
</thead>
<tbody>
<tr>
<th>526490</th>
<td>523685389</td>
<td>2022-03-01</td>
<td>1.0</td>
<td>JOSEPH RUMBLE</td>
<td>8</td>
<td>8</td>
<td>30.1</td>
<td>2.5</td>
<td>0.0</td>
<td>8.25</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.00</td>
<td>21.83</td>
<td>1365.0</td>
<td>764579619</td>
<td>91264</td>
<td>B Belford</td>
<td>1</td>
<td>TAB</td>
<td>06:55PM</td>
<td>380</td>
<td>Novice Non Penalty</td>
<td>Townsville</td>
<td>01 Mar 22</td>
<td>0.318829</td>
<td>1</td>
<td>0.261288</td>
<td>1.000000</td>
<td>0.301030</td>
<td>0.057447</td>
<td>22.10</td>
<td>0.641825</td>
<td>7.56</td>
<td>0.561842</td>
<td>0.000000</td>
<td>0.123070</td>
<td>0.514985</td>
<td>0.514985</td>
<td>0.514985</td>
<td>0.514985</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>1.000000</td>
<td>1.00</td>
<td>1.000000</td>
<td>1.000000</td>
<td>0.000000</td>
<td>0.301030</td>
<td>0.301030</td>
<td>0.301030</td>
<td>0.301030</td>
<td>0.000000</td>
<td>0.264578</td>
<td>0.264578</td>
<td>2.645776e-01</td>
<td>0.264578</td>
<td>0.000000</td>
<td>0.386805</td>
<td>0.514985</td>
<td>0.450895</td>
<td>0.450895</td>
<td>0.090637</td>
<td>0.482301</td>
<td>0.482301</td>
<td>0.482301</td>
<td>0.482301</td>
<td>0.000000</td>
<td>0.500000</td>
<td>1.00</td>
<td>0.750000</td>
<td>0.750000</td>
<td>0.353553</td>
<td>0.30103</td>
<td>0.477121</td>
<td>0.389076</td>
<td>0.389076</td>
<td>0.124515</td>
<td>0.238161</td>
<td>0.264578</td>
<td>0.251369</td>
<td>0.251369</td>
<td>0.018679</td>
<td>0.386805</td>
<td>0.514985</td>
<td>0.450895</td>
<td>0.450895</td>
<td>0.090637</td>
<td>0.482301</td>
<td>0.482301</td>
<td>0.482301</td>
<td>0.482301</td>
<td>0.000000</td>
<td>0.500000</td>
<td>1.00</td>
<td>0.750000</td>
<td>0.750000</td>
<td>0.353553</td>
<td>0.30103</td>
<td>0.477121</td>
<td>0.389076</td>
<td>0.389076</td>
<td>0.124515</td>
<td>0.238161</td>
<td>0.264578</td>
<td>0.251369</td>
<td>0.251369</td>
<td>0.018679</td>
<td>0.360558</td>
<td>0.321076</td>
<td>3.114527</td>
</tr>
<tr>
<th>494469</th>
<td>482776246</td>
<td>2022-03-01</td>
<td>1.0</td>
<td>BLAZING NENNA</td>
<td>4</td>
<td>4</td>
<td>25.7</td>
<td>2.3</td>
<td>0.0</td>
<td>3.31</td>
<td>0</td>
<td>Q/11</td>
<td>0</td>
<td>0</td>
<td>10.27</td>
<td>23.30</td>
<td>0.0</td>
<td>764625202</td>
<td>115912</td>
<td>M Delbridge</td>
<td>6</td>
<td>CHS GROUP HT3</td>
<td>05:37PM</td>
<td>410</td>
<td>Grade 5 Heat</td>
<td>Horsham</td>
<td>01 Mar 22</td>
<td>0.365634</td>
<td>1</td>
<td>0.000000</td>
<td>1.000000</td>
<td>0.301030</td>
<td>0.056829</td>
<td>23.46</td>
<td>0.480327</td>
<td>10.39</td>
<td>0.534335</td>
<td>0.558423</td>
<td>0.131261</td>
<td>0.500000</td>
<td>0.513187</td>
<td>0.504396</td>
<td>0.500000</td>
<td>0.007613</td>
<td>0.464830</td>
<td>0.633333</td>
<td>0.570108</td>
<td>0.612161</td>
<td>0.091786</td>
<td>0.250000</td>
<td>1.00</td>
<td>0.500000</td>
<td>0.250000</td>
<td>0.433013</td>
<td>0.301030</td>
<td>0.698970</td>
<td>0.566323</td>
<td>0.698970</td>
<td>0.229751</td>
<td>0.000000</td>
<td>0.000000</td>
<td>1.628327e-15</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.307377</td>
<td>0.609439</td>
<td>0.508348</td>
<td>0.524719</td>
<td>0.074167</td>
<td>0.373358</td>
<td>0.651515</td>
<td>0.543480</td>
<td>0.584034</td>
<td>0.093516</td>
<td>0.142857</td>
<td>1.00</td>
<td>0.535714</td>
<td>0.500000</td>
<td>0.324194</td>
<td>0.30103</td>
<td>0.903090</td>
<td>0.528325</td>
<td>0.477121</td>
<td>0.198314</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.233840</td>
<td>0.609439</td>
<td>0.493044</td>
<td>0.512184</td>
<td>0.074069</td>
<td>0.000000</td>
<td>0.651515</td>
<td>0.515072</td>
<td>0.539757</td>
<td>0.120687</td>
<td>0.125000</td>
<td>1.00</td>
<td>0.443328</td>
<td>0.333333</td>
<td>0.314640</td>
<td>0.30103</td>
<td>0.954243</td>
<td>0.607971</td>
<td>0.602060</td>
<td>0.219526</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.204496</td>
<td>0.145077</td>
<td>6.892877</td>
</tr>
<tr>
<th>583640</th>
<td>578899991</td>
<td>2022-03-01</td>
<td>4.0</td>
<td>RIVER RAGING</td>
<td>2</td>
<td>2</td>
<td>30.3</td>
<td>13.8</td>
<td>0.0</td>
<td>3.71</td>
<td>1.13</td>
<td>M/3</td>
<td>0</td>
<td>0</td>
<td>6.89</td>
<td>20.36</td>
<td>0.0</td>
<td>764592641</td>
<td>283109</td>
<td>L Dalziel</td>
<td>1</td>
<td>FOLLOW @GRV_NEWS ON TWITTER</td>
<td>11:08AM</td>
<td>350</td>
<td>Maiden</td>
<td>Healesville</td>
<td>01 Mar 22</td>
<td>0.061390</td>
<td>0</td>
<td>0.000000</td>
<td>0.250000</td>
<td>0.698970</td>
<td>0.058171</td>
<td>19.56</td>
<td>0.250778</td>
<td>6.64</td>
<td>0.303536</td>
<td>0.318578</td>
<td>0.138427</td>
<td>0.312992</td>
<td>0.312992</td>
<td>0.312992</td>
<td>0.312992</td>
<td>0.000000</td>
<td>0.346715</td>
<td>0.346715</td>
<td>0.346715</td>
<td>0.346715</td>
<td>0.000000</td>
<td>0.250000</td>
<td>0.25</td>
<td>0.250000</td>
<td>0.250000</td>
<td>0.000000</td>
<td>0.698970</td>
<td>0.698970</td>
<td>0.698970</td>
<td>0.698970</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000e+00</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.241288</td>
<td>0.312992</td>
<td>0.285038</td>
<td>0.303536</td>
<td>0.033489</td>
<td>0.251704</td>
<td>0.346715</td>
<td>0.290635</td>
<td>0.290765</td>
<td>0.038193</td>
<td>0.142857</td>
<td>0.25</td>
<td>0.201905</td>
<td>0.200000</td>
<td>0.048369</td>
<td>0.69897</td>
<td>0.903090</td>
<td>0.784856</td>
<td>0.778151</td>
<td>0.090009</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.241288</td>
<td>0.312992</td>
<td>0.285038</td>
<td>0.303536</td>
<td>0.033489</td>
<td>0.251704</td>
<td>0.346715</td>
<td>0.290635</td>
<td>0.290765</td>
<td>0.038193</td>
<td>0.142857</td>
<td>0.25</td>
<td>0.201905</td>
<td>0.200000</td>
<td>0.048369</td>
<td>0.69897</td>
<td>0.903090</td>
<td>0.784856</td>
<td>0.778151</td>
<td>0.090009</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.065977</td>
<td>0.102443</td>
<td>9.761504</td>
</tr>
<tr>
<th>385698</th>
<td>419530408</td>
<td>2022-03-01</td>
<td>5.0</td>
<td>FREENEY</td>
<td>8</td>
<td>8</td>
<td>25.1</td>
<td>14.0</td>
<td>0.0</td>
<td>8.25</td>
<td>1.14</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.00</td>
<td>22.47</td>
<td>20.0</td>
<td>764579628</td>
<td>63422</td>
<td>R Lound</td>
<td>10</td>
<td>BURDEKIN VET CLINIC</td>
<td>09:55PM</td>
<td>380</td>
<td>Grade 5</td>
<td>Townsville</td>
<td>01 Mar 22</td>
<td>0.058903</td>
<td>0</td>
<td>0.110185</td>
<td>0.200000</td>
<td>0.778151</td>
<td>0.059132</td>
<td>22.10</td>
<td>0.641825</td>
<td>7.56</td>
<td>0.417668</td>
<td>0.000000</td>
<td>0.123070</td>
<td>0.389381</td>
<td>0.406750</td>
<td>0.398065</td>
<td>0.398065</td>
<td>0.012282</td>
<td>0.519920</td>
<td>0.519920</td>
<td>0.519920</td>
<td>0.519920</td>
<td>0.000000</td>
<td>0.125000</td>
<td>0.25</td>
<td>0.187500</td>
<td>0.187500</td>
<td>0.088388</td>
<td>0.698970</td>
<td>0.954243</td>
<td>0.826606</td>
<td>0.826606</td>
<td>0.180505</td>
<td>0.110185</td>
<td>0.161208</td>
<td>1.356966e-01</td>
<td>0.135697</td>
<td>0.036079</td>
<td>0.378587</td>
<td>0.520445</td>
<td>0.438208</td>
<td>0.435239</td>
<td>0.050906</td>
<td>0.519920</td>
<td>0.519920</td>
<td>0.519920</td>
<td>0.519920</td>
<td>0.000000</td>
<td>0.125000</td>
<td>1.00</td>
<td>0.398810</td>
<td>0.250000</td>
<td>0.304154</td>
<td>0.30103</td>
<td>0.954243</td>
<td>0.636079</td>
<td>0.698970</td>
<td>0.229354</td>
<td>0.086783</td>
<td>0.256326</td>
<td>0.171119</td>
<td>0.161208</td>
<td>0.059824</td>
<td>0.277345</td>
<td>0.547967</td>
<td>0.448106</td>
<td>0.459606</td>
<td>0.067232</td>
<td>0.486807</td>
<td>0.519920</td>
<td>0.509978</td>
<td>0.516591</td>
<td>0.015762</td>
<td>0.125000</td>
<td>1.00</td>
<td>0.437302</td>
<td>0.333333</td>
<td>0.287424</td>
<td>0.30103</td>
<td>0.954243</td>
<td>0.595411</td>
<td>0.602060</td>
<td>0.199176</td>
<td>0.000000</td>
<td>0.256326</td>
<td>0.161721</td>
<td>0.181581</td>
<td>0.080195</td>
<td>0.148800</td>
<td>0.136846</td>
<td>7.307467</td>
</tr>
<tr>
<th>453065</th>
<td>451768903</td>
<td>2022-03-01</td>
<td>5.0</td>
<td>ENCOURAGING</td>
<td>2</td>
<td>2</td>
<td>22.1</td>
<td>15.0</td>
<td>0.0</td>
<td>6.0</td>
<td>0.29</td>
<td>455</td>
<td>0</td>
<td>455</td>
<td>10.35</td>
<td>22.57</td>
<td>0.0</td>
<td>764579685</td>
<td>70111</td>
<td>B Young</td>
<td>12</td>
<td>GOSSIE TIGERS GOOD TIMES</td>
<td>10:39PM</td>
<td>388</td>
<td>Non Graded</td>
<td>Gosford</td>
<td>01 Mar 22</td>
<td>0.058204</td>
<td>0</td>
<td>0.000000</td>
<td>0.200000</td>
<td>0.778151</td>
<td>0.058170</td>
<td>22.39</td>
<td>0.564085</td>
<td>10.19</td>
<td>0.460124</td>
<td>0.422705</td>
<td>0.166667</td>
<td>0.462217</td>
<td>0.582400</td>
<td>0.498498</td>
<td>0.474688</td>
<td>0.056299</td>
<td>0.413211</td>
<td>0.605769</td>
<td>0.539241</td>
<td>0.568992</td>
<td>0.086316</td>
<td>0.200000</td>
<td>0.50</td>
<td>0.300000</td>
<td>0.250000</td>
<td>0.135401</td>
<td>0.000000</td>
<td>0.778151</td>
<td>0.530643</td>
<td>0.698970</td>
<td>0.317165</td>
<td>0.000000</td>
<td>0.227091</td>
<td>4.541824e-02</td>
<td>0.000000</td>
<td>0.101558</td>
<td>0.435567</td>
<td>0.582400</td>
<td>0.510280</td>
<td>0.506062</td>
<td>0.043547</td>
<td>0.335526</td>
<td>0.605769</td>
<td>0.507137</td>
<td>0.513845</td>
<td>0.080824</td>
<td>0.200000</td>
<td>1.00</td>
<td>0.559375</td>
<td>0.500000</td>
<td>0.321914</td>
<td>0.00000</td>
<td>0.778151</td>
<td>0.476169</td>
<td>0.477121</td>
<td>0.204293</td>
<td>0.000000</td>
<td>0.269225</td>
<td>0.170899</td>
<td>0.227091</td>
<td>0.115477</td>
<td>0.435567</td>
<td>0.620208</td>
<td>0.519683</td>
<td>0.508949</td>
<td>0.050995</td>
<td>0.335526</td>
<td>0.676056</td>
<td>0.528287</td>
<td>0.534247</td>
<td>0.085502</td>
<td>0.200000</td>
<td>1.00</td>
<td>0.592857</td>
<td>0.500000</td>
<td>0.310625</td>
<td>0.00000</td>
<td>0.778151</td>
<td>0.460377</td>
<td>0.477121</td>
<td>0.185631</td>
<td>0.000000</td>
<td>0.269225</td>
<td>0.187400</td>
<td>0.227091</td>
<td>0.105954</td>
<td>0.310750</td>
<td>0.189764</td>
<td>5.269698</td>
</tr>
<tr>
<th>...</th>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr>
<th>269364</th>
<td>328634961</td>
<td>2022-03-31</td>
<td>6.0</td>
<td>LUNARAY</td>
<td>7</td>
<td>7</td>
<td>28.8</td>
<td>18.8</td>
<td>0.0</td>
<td>6.96</td>
<td>0.24</td>
<td>M/766</td>
<td>0</td>
<td>0</td>
<td>6.99</td>
<td>25.92</td>
<td>0.0</td>
<td>771803534</td>
<td>117062</td>
<td>V Mileto</td>
<td>6</td>
<td>SHEPPARTON WORKWEAR &amp; SAFETY</td>
<td>01:19PM</td>
<td>450</td>
<td>Grade 5 T3</td>
<td>Shepparton</td>
<td>31 Mar 22</td>
<td>0.044487</td>
<td>0</td>
<td>0.000000</td>
<td>0.166667</td>
<td>0.845098</td>
<td>0.057600</td>
<td>25.55</td>
<td>0.404304</td>
<td>6.70</td>
<td>0.428627</td>
<td>0.292561</td>
<td>0.118601</td>
<td>0.370377</td>
<td>0.461165</td>
<td>0.415771</td>
<td>0.415771</td>
<td>0.064197</td>
<td>0.320144</td>
<td>0.341040</td>
<td>0.330592</td>
<td>0.330592</td>
<td>0.014776</td>
<td>0.200000</td>
<td>0.25</td>
<td>0.225000</td>
<td>0.225000</td>
<td>0.035355</td>
<td>0.698970</td>
<td>0.778151</td>
<td>0.738561</td>
<td>0.738561</td>
<td>0.055990</td>
<td>0.000000</td>
<td>0.000000</td>
<td>2.720046e-15</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.282853</td>
<td>0.461165</td>
<td>0.399299</td>
<td>0.415352</td>
<td>0.060173</td>
<td>0.000000</td>
<td>0.397661</td>
<td>0.280607</td>
<td>0.320144</td>
<td>0.129212</td>
<td>0.125000</td>
<td>1.00</td>
<td>0.379762</td>
<td>0.250000</td>
<td>0.297826</td>
<td>0.30103</td>
<td>0.954243</td>
<td>0.644364</td>
<td>0.698970</td>
<td>0.211158</td>
<td>0.000000</td>
<td>0.159040</td>
<td>0.022720</td>
<td>0.000000</td>
<td>0.060112</td>
<td>0.280719</td>
<td>0.529528</td>
<td>0.410459</td>
<td>0.414407</td>
<td>0.058641</td>
<td>0.000000</td>
<td>0.441003</td>
<td>0.297743</td>
<td>0.312132</td>
<td>0.111641</td>
<td>0.125000</td>
<td>1.00</td>
<td>0.324033</td>
<td>0.250000</td>
<td>0.245639</td>
<td>0.30103</td>
<td>0.954243</td>
<td>0.687225</td>
<td>0.698970</td>
<td>0.181101</td>
<td>0.000000</td>
<td>0.177795</td>
<td>0.010526</td>
<td>0.000000</td>
<td>0.041488</td>
<td>0.075047</td>
<td>0.097817</td>
<td>10.223167</td>
</tr>
<tr>
<th>538082</th>
<td>534921234</td>
<td>2022-03-31</td>
<td>6.0</td>
<td>QUINNLEY BALE</td>
<td>6</td>
<td>6</td>
<td>26.7</td>
<td>18.0</td>
<td>0.0</td>
<td>7.5</td>
<td>1.14</td>
<td>56</td>
<td>0</td>
<td>56</td>
<td>5.47</td>
<td>17.83</td>
<td>0.0</td>
<td>771810563</td>
<td>98781</td>
<td>S Rhodes</td>
<td>12</td>
<td>WATCH LIVE ON SPORTSBET</td>
<td>10:46PM</td>
<td>297</td>
<td>Grade 5</td>
<td>Dapto</td>
<td>31 Mar 22</td>
<td>0.046607</td>
<td>0</td>
<td>0.000000</td>
<td>0.166667</td>
<td>0.845098</td>
<td>0.060034</td>
<td>17.19</td>
<td>0.593790</td>
<td>5.37</td>
<td>0.320527</td>
<td>0.408592</td>
<td>0.120301</td>
<td>0.288301</td>
<td>0.347716</td>
<td>0.318008</td>
<td>0.318008</td>
<td>0.042013</td>
<td>0.303220</td>
<td>0.390710</td>
<td>0.346965</td>
<td>0.346965</td>
<td>0.061865</td>
<td>0.142857</td>
<td>0.50</td>
<td>0.321429</td>
<td>0.321429</td>
<td>0.252538</td>
<td>0.477121</td>
<td>0.903090</td>
<td>0.690106</td>
<td>0.690106</td>
<td>0.301205</td>
<td>0.000000</td>
<td>0.221975</td>
<td>1.109875e-01</td>
<td>0.110988</td>
<td>0.156960</td>
<td>0.288301</td>
<td>0.471082</td>
<td>0.384562</td>
<td>0.389432</td>
<td>0.082219</td>
<td>0.303220</td>
<td>0.426606</td>
<td>0.368411</td>
<td>0.371909</td>
<td>0.052814</td>
<td>0.142857</td>
<td>1.00</td>
<td>0.473214</td>
<td>0.375000</td>
<td>0.381742</td>
<td>0.30103</td>
<td>0.903090</td>
<td>0.595053</td>
<td>0.588046</td>
<td>0.262071</td>
<td>0.000000</td>
<td>0.264698</td>
<td>0.121668</td>
<td>0.110988</td>
<td>0.141569</td>
<td>0.236247</td>
<td>0.500000</td>
<td>0.387665</td>
<td>0.390897</td>
<td>0.075799</td>
<td>0.000000</td>
<td>0.481447</td>
<td>0.342572</td>
<td>0.353107</td>
<td>0.117160</td>
<td>0.125000</td>
<td>1.00</td>
<td>0.374454</td>
<td>0.250000</td>
<td>0.278973</td>
<td>0.00000</td>
<td>0.954243</td>
<td>0.605624</td>
<td>0.650515</td>
<td>0.270858</td>
<td>0.000000</td>
<td>0.264698</td>
<td>0.053752</td>
<td>0.000000</td>
<td>0.100704</td>
<td>0.068536</td>
<td>0.065307</td>
<td>15.312345</td>
</tr>
<tr>
<th>363059</th>
<td>403640676</td>
<td>2022-03-31</td>
<td>3.0</td>
<td>SAINT CHARLOTTE</td>
<td>5</td>
<td>5</td>
<td>27.7</td>
<td>18.0</td>
<td>0.0</td>
<td>4.5</td>
<td>0.14</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>10.87</td>
<td>23.59</td>
<td>140.0</td>
<td>771539517</td>
<td>67189</td>
<td>W Wilson</td>
<td>8</td>
<td>EXCHANGE PRINTERS (N/P) STAKE</td>
<td>01:52PM</td>
<td>400</td>
<td>Restricted Win</td>
<td>Mount Gambier</td>
<td>31 Mar 22</td>
<td>0.041828</td>
<td>0</td>
<td>0.179102</td>
<td>0.333333</td>
<td>0.602060</td>
<td>0.058975</td>
<td>23.39</td>
<td>0.696399</td>
<td>10.98</td>
<td>0.457609</td>
<td>0.550598</td>
<td>0.147799</td>
<td>0.401509</td>
<td>0.534438</td>
<td>0.467974</td>
<td>0.467974</td>
<td>0.093995</td>
<td>0.328496</td>
<td>0.527473</td>
<td>0.427984</td>
<td>0.427984</td>
<td>0.140698</td>
<td>0.125000</td>
<td>1.00</td>
<td>0.562500</td>
<td>0.562500</td>
<td>0.618718</td>
<td>0.301030</td>
<td>0.954243</td>
<td>0.627636</td>
<td>0.627636</td>
<td>0.461891</td>
<td>0.000000</td>
<td>0.225702</td>
<td>1.128509e-01</td>
<td>0.112851</td>
<td>0.159595</td>
<td>0.401509</td>
<td>0.534438</td>
<td>0.475213</td>
<td>0.486146</td>
<td>0.041384</td>
<td>0.328496</td>
<td>0.564576</td>
<td>0.467640</td>
<td>0.504558</td>
<td>0.078033</td>
<td>0.125000</td>
<td>1.00</td>
<td>0.440833</td>
<td>0.333333</td>
<td>0.320552</td>
<td>0.30103</td>
<td>0.954243</td>
<td>0.603688</td>
<td>0.602060</td>
<td>0.220083</td>
<td>0.000000</td>
<td>0.225702</td>
<td>0.135590</td>
<td>0.179102</td>
<td>0.095348</td>
<td>0.257933</td>
<td>0.534438</td>
<td>0.457113</td>
<td>0.477655</td>
<td>0.064917</td>
<td>0.212446</td>
<td>0.564576</td>
<td>0.443305</td>
<td>0.445950</td>
<td>0.089104</td>
<td>0.125000</td>
<td>1.00</td>
<td>0.358408</td>
<td>0.250000</td>
<td>0.274086</td>
<td>0.30103</td>
<td>0.954243</td>
<td>0.660966</td>
<td>0.698970</td>
<td>0.195529</td>
<td>0.000000</td>
<td>0.225702</td>
<td>0.106690</td>
<td>0.172038</td>
<td>0.098393</td>
<td>0.155050</td>
<td>0.100326</td>
<td>9.967472</td>
</tr>
<tr>
<th>362095</th>
<td>403093108</td>
<td>2022-03-31</td>
<td>3.0</td>
<td>SILVER SANDALS</td>
<td>5</td>
<td>5</td>
<td>27.0</td>
<td>10.0</td>
<td>0.0</td>
<td>2.5</td>
<td>2.29</td>
<td>42</td>
<td>0</td>
<td>42</td>
<td>5.58</td>
<td>31.67</td>
<td>800.0</td>
<td>771539501</td>
<td>87148</td>
<td>S Lawrance</td>
<td>2</td>
<td>SKY RACING</td>
<td>06:40PM</td>
<td>520</td>
<td>Masters Grade 5</td>
<td>Ipswich</td>
<td>31 Mar 22</td>
<td>0.083134</td>
<td>0</td>
<td>0.241969</td>
<td>0.333333</td>
<td>0.602060</td>
<td>0.060904</td>
<td>30.79</td>
<td>0.823159</td>
<td>5.42</td>
<td>0.361067</td>
<td>0.356631</td>
<td>0.095370</td>
<td>0.435748</td>
<td>0.439595</td>
<td>0.437671</td>
<td>0.437671</td>
<td>0.002720</td>
<td>0.354196</td>
<td>0.368046</td>
<td>0.361121</td>
<td>0.361121</td>
<td>0.009793</td>
<td>0.333333</td>
<td>1.00</td>
<td>0.666667</td>
<td>0.666667</td>
<td>0.471405</td>
<td>0.301030</td>
<td>0.602060</td>
<td>0.451545</td>
<td>0.451545</td>
<td>0.212860</td>
<td>0.207730</td>
<td>0.275374</td>
<td>2.415521e-01</td>
<td>0.241552</td>
<td>0.047832</td>
<td>0.330867</td>
<td>0.507902</td>
<td>0.426973</td>
<td>0.435748</td>
<td>0.052271</td>
<td>0.198046</td>
<td>0.460029</td>
<td>0.340578</td>
<td>0.340419</td>
<td>0.073412</td>
<td>0.166667</td>
<td>1.00</td>
<td>0.498485</td>
<td>0.333333</td>
<td>0.340462</td>
<td>0.30103</td>
<td>0.845098</td>
<td>0.560166</td>
<td>0.602060</td>
<td>0.203530</td>
<td>0.110185</td>
<td>0.275374</td>
<td>0.199906</td>
<td>0.207730</td>
<td>0.064087</td>
<td>0.297445</td>
<td>0.507902</td>
<td>0.398206</td>
<td>0.402791</td>
<td>0.056453</td>
<td>0.156690</td>
<td>0.460029</td>
<td>0.325128</td>
<td>0.317851</td>
<td>0.074465</td>
<td>0.125000</td>
<td>1.00</td>
<td>0.328665</td>
<td>0.225000</td>
<td>0.260181</td>
<td>0.30103</td>
<td>0.954243</td>
<td>0.694669</td>
<td>0.738561</td>
<td>0.197928</td>
<td>0.000000</td>
<td>0.275374</td>
<td>0.127103</td>
<td>0.138606</td>
<td>0.097759</td>
<td>0.081817</td>
<td>0.110114</td>
<td>9.081527</td>
</tr>
<tr>
<th>565804</th>
<td>556974861</td>
<td>2022-03-31</td>
<td>2.0</td>
<td>ORSON LAURIE</td>
<td>3</td>
<td>3</td>
<td>30.4</td>
<td>3.1</td>
<td>0.0</td>
<td>0.75</td>
<td>0.86</td>
<td>112</td>
<td>0</td>
<td>112</td>
<td>8.32</td>
<td>23.04</td>
<td>530.0</td>
<td>771810580</td>
<td>125472</td>
<td>E Harris</td>
<td>4</td>
<td>RIVERINA STOCKFEEDS</td>
<td>08:04PM</td>
<td>411</td>
<td>Free For All</td>
<td>Casino</td>
<td>31 Mar 22</td>
<td>0.275736</td>
<td>0</td>
<td>0.227091</td>
<td>0.500000</td>
<td>0.477121</td>
<td>0.056058</td>
<td>23.37</td>
<td>0.418680</td>
<td>8.62</td>
<td>0.571615</td>
<td>0.680288</td>
<td>0.062500</td>
<td>0.351105</td>
<td>0.583040</td>
<td>0.453627</td>
<td>0.445632</td>
<td>0.092450</td>
<td>0.487805</td>
<td>0.651134</td>
<td>0.562563</td>
<td>0.574442</td>
<td>0.064323</td>
<td>0.142857</td>
<td>1.00</td>
<td>0.362698</td>
<td>0.183333</td>
<td>0.339607</td>
<td>0.000000</td>
<td>0.903090</td>
<td>0.592798</td>
<td>0.778151</td>
<td>0.343479</td>
<td>0.000000</td>
<td>0.267033</td>
<td>7.058912e-02</td>
<td>0.000000</td>
<td>0.121104</td>
<td>0.351105</td>
<td>0.588161</td>
<td>0.473661</td>
<td>0.483607</td>
<td>0.085113</td>
<td>0.465422</td>
<td>0.664141</td>
<td>0.554578</td>
<td>0.574442</td>
<td>0.067472</td>
<td>0.142857</td>
<td>1.00</td>
<td>0.543492</td>
<td>0.500000</td>
<td>0.401886</td>
<td>0.00000</td>
<td>0.903090</td>
<td>0.545322</td>
<td>0.477121</td>
<td>0.298264</td>
<td>0.000000</td>
<td>0.275104</td>
<td>0.142790</td>
<td>0.167586</td>
<td>0.124768</td>
<td>0.351105</td>
<td>0.588161</td>
<td>0.479065</td>
<td>0.494281</td>
<td>0.085020</td>
<td>0.465422</td>
<td>0.664141</td>
<td>0.557285</td>
<td>0.574442</td>
<td>0.065012</td>
<td>0.142857</td>
<td>1.00</td>
<td>0.572024</td>
<td>0.500000</td>
<td>0.404685</td>
<td>0.00000</td>
<td>0.903090</td>
<td>0.530952</td>
<td>0.477121</td>
<td>0.294808</td>
<td>0.000000</td>
<td>0.275104</td>
<td>0.149961</td>
<td>0.224986</td>
<td>0.124372</td>
<td>0.150460</td>
<td>0.123089</td>
<td>8.124181</td>
</tr>
</tbody>
</table>
<p>26438 rows × 117 columns</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">download_iggy_ratings</span><span class="p">(</span><span class="n">date</span><span class="p">):</span>
<a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Downloads the Betfair Iggy model ratings for a given date and formats it into a nice DataFrame.</span>
<a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a>
<a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a><span class="sd">    Args:</span>
<a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a><span class="sd">        date (datetime): the date we want to download the ratings for</span>
<a id="__codelineno-23-6" name="__codelineno-23-6" href="#__codelineno-23-6"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-23-7" name="__codelineno-23-7" href="#__codelineno-23-7"></a>    <span class="n">iggy_url_1</span> <span class="o">=</span> <span class="s1">&#39;https://betfair-data-supplier-prod.herokuapp.com/api/widgets/iggy-joey/datasets?date=&#39;</span>
<a id="__codelineno-23-8" name="__codelineno-23-8" href="#__codelineno-23-8"></a>    <span class="n">iggy_url_2</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-23-9" name="__codelineno-23-9" href="#__codelineno-23-9"></a>    <span class="n">iggy_url_3</span> <span class="o">=</span> <span class="s1">&#39;&amp;amp;presenter=RatingsPresenter&amp;amp;csv=true&#39;</span>
<a id="__codelineno-23-10" name="__codelineno-23-10" href="#__codelineno-23-10"></a>    <span class="n">iggy_url</span> <span class="o">=</span> <span class="n">iggy_url_1</span> <span class="o">+</span> <span class="n">iggy_url_2</span> <span class="o">+</span> <span class="n">iggy_url_3</span>
<a id="__codelineno-23-11" name="__codelineno-23-11" href="#__codelineno-23-11"></a>
<a id="__codelineno-23-12" name="__codelineno-23-12" href="#__codelineno-23-12"></a>    <span class="c1"># Download todays greyhounds ratings</span>
<a id="__codelineno-23-13" name="__codelineno-23-13" href="#__codelineno-23-13"></a>    <span class="n">iggy_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">iggy_url</span><span class="p">)</span>
<a id="__codelineno-23-14" name="__codelineno-23-14" href="#__codelineno-23-14"></a>
<a id="__codelineno-23-15" name="__codelineno-23-15" href="#__codelineno-23-15"></a>    <span class="c1"># Data clearning</span>
<a id="__codelineno-23-16" name="__codelineno-23-16" href="#__codelineno-23-16"></a>    <span class="n">iggy_df</span> <span class="o">=</span> <span class="n">iggy_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
<a id="__codelineno-23-17" name="__codelineno-23-17" href="#__codelineno-23-17"></a>    <span class="n">columns</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-23-18" name="__codelineno-23-18" href="#__codelineno-23-18"></a>        <span class="s2">&quot;meetings.races.bfExchangeMarketId&quot;</span><span class="p">:</span><span class="s2">&quot;market_id&quot;</span><span class="p">,</span>
<a id="__codelineno-23-19" name="__codelineno-23-19" href="#__codelineno-23-19"></a>        <span class="s2">&quot;meetings.races.runners.bfExchangeSelectionId&quot;</span><span class="p">:</span><span class="s2">&quot;selection_id&quot;</span><span class="p">,</span>
<a id="__codelineno-23-20" name="__codelineno-23-20" href="#__codelineno-23-20"></a>        <span class="s2">&quot;meetings.races.runners.ratedPrice&quot;</span><span class="p">:</span><span class="s2">&quot;rating&quot;</span><span class="p">,</span>
<a id="__codelineno-23-21" name="__codelineno-23-21" href="#__codelineno-23-21"></a>        <span class="s2">&quot;meetings.races.number&quot;</span><span class="p">:</span><span class="s2">&quot;RaceNum&quot;</span><span class="p">,</span>
<a id="__codelineno-23-22" name="__codelineno-23-22" href="#__codelineno-23-22"></a>        <span class="s2">&quot;meetings.name&quot;</span><span class="p">:</span><span class="s2">&quot;Track&quot;</span><span class="p">,</span>
<a id="__codelineno-23-23" name="__codelineno-23-23" href="#__codelineno-23-23"></a>        <span class="s2">&quot;meetings.races.runners.name&quot;</span><span class="p">:</span><span class="s2">&quot;DogName&quot;</span>
<a id="__codelineno-23-24" name="__codelineno-23-24" href="#__codelineno-23-24"></a>        <span class="p">}</span>
<a id="__codelineno-23-25" name="__codelineno-23-25" href="#__codelineno-23-25"></a>    <span class="p">)</span>
<a id="__codelineno-23-26" name="__codelineno-23-26" href="#__codelineno-23-26"></a>    <span class="c1"># iggy_df = iggy_df[[&#39;market_id&#39;,&#39;selection_id&#39;,&#39;rating&#39;]]</span>
<a id="__codelineno-23-27" name="__codelineno-23-27" href="#__codelineno-23-27"></a>    <span class="n">iggy_df</span><span class="p">[</span><span class="s1">&#39;market_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">iggy_df</span><span class="p">[</span><span class="s1">&#39;market_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
<a id="__codelineno-23-28" name="__codelineno-23-28" href="#__codelineno-23-28"></a>    <span class="n">iggy_df</span><span class="p">[</span><span class="s1">&#39;date_dt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">date</span>
<a id="__codelineno-23-29" name="__codelineno-23-29" href="#__codelineno-23-29"></a>
<a id="__codelineno-23-30" name="__codelineno-23-30" href="#__codelineno-23-30"></a>    <span class="c1"># Set market_id and selection_id as index for easy referencing</span>
<a id="__codelineno-23-31" name="__codelineno-23-31" href="#__codelineno-23-31"></a>    <span class="c1"># iggy_df = iggy_df.set_index([&#39;market_id&#39;,&#39;selection_id&#39;])</span>
<a id="__codelineno-23-32" name="__codelineno-23-32" href="#__codelineno-23-32"></a>    <span class="k">return</span><span class="p">(</span><span class="n">iggy_df</span><span class="p">)</span>
<a id="__codelineno-23-33" name="__codelineno-23-33" href="#__codelineno-23-33"></a>
<a id="__codelineno-23-34" name="__codelineno-23-34" href="#__codelineno-23-34"></a><span class="c1"># Download historical ratings over a time period and convert into a big DataFrame.</span>
<a id="__codelineno-23-35" name="__codelineno-23-35" href="#__codelineno-23-35"></a><span class="n">back_test_period</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="s1">&#39;2022-03-01&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;2022-04-01&#39;</span><span class="p">)</span>
<a id="__codelineno-23-36" name="__codelineno-23-36" href="#__codelineno-23-36"></a><span class="n">frames</span> <span class="o">=</span> <span class="p">[</span><span class="n">download_iggy_ratings</span><span class="p">(</span><span class="n">day</span><span class="p">)</span> <span class="k">for</span> <span class="n">day</span> <span class="ow">in</span> <span class="n">back_test_period</span><span class="p">]</span>
<a id="__codelineno-23-37" name="__codelineno-23-37" href="#__codelineno-23-37"></a><span class="n">iggy_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">frames</span><span class="p">)</span>
<a id="__codelineno-23-38" name="__codelineno-23-38" href="#__codelineno-23-38"></a><span class="n">iggy_df</span>
</code></pre></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th></th>
<th>Track</th>
<th>meetings.bfExchangeEventId</th>
<th>meetings.races.name</th>
<th>RaceNum</th>
<th>market_id</th>
<th>meetings.races.comment</th>
<th>selection_id</th>
<th>meetings.races.runners.number</th>
<th>DogName</th>
<th>rating</th>
<th>date_dt</th>
</tr>
</thead>
<tbody>
<tr>
<th>0</th>
<td>Devonport</td>
<td>3</td>
<td>R1 452m Gr6</td>
<td>1</td>
<td>1.195395419</td>
<td>NaN</td>
<td>43154446</td>
<td>1</td>
<td>Magic Rogue</td>
<td>11.07</td>
<td>2022-03-01</td>
</tr>
<tr>
<th>1</th>
<td>Devonport</td>
<td>3</td>
<td>R1 452m Gr6</td>
<td>1</td>
<td>1.195395419</td>
<td>NaN</td>
<td>43154447</td>
<td>2</td>
<td>Youre Off</td>
<td>6.10</td>
<td>2022-03-01</td>
</tr>
<tr>
<th>2</th>
<td>Devonport</td>
<td>3</td>
<td>R1 452m Gr6</td>
<td>1</td>
<td>1.195395419</td>
<td>NaN</td>
<td>42352031</td>
<td>3</td>
<td>Castle Town</td>
<td>6.60</td>
<td>2022-03-01</td>
</tr>
<tr>
<th>3</th>
<td>Devonport</td>
<td>3</td>
<td>R1 452m Gr6</td>
<td>1</td>
<td>1.195395419</td>
<td>NaN</td>
<td>43154448</td>
<td>4</td>
<td>Buckle Up Aumond</td>
<td>8.02</td>
<td>2022-03-01</td>
</tr>
<tr>
<th>4</th>
<td>Devonport</td>
<td>3</td>
<td>R1 452m Gr6</td>
<td>1</td>
<td>1.195395419</td>
<td>NaN</td>
<td>42413752</td>
<td>5</td>
<td>Was That Then</td>
<td>17.14</td>
<td>2022-03-01</td>
</tr>
<tr>
<th>...</th>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr>
<th>906</th>
<td>Wentworth Park</td>
<td>11</td>
<td>R9 520m Heat</td>
<td>9</td>
<td>1.196971034</td>
<td>NaN</td>
<td>27692794</td>
<td>3</td>
<td>Mercator Closer</td>
<td>24.49</td>
<td>2022-04-01</td>
</tr>
<tr>
<th>907</th>
<td>Wentworth Park</td>
<td>11</td>
<td>R9 520m Heat</td>
<td>9</td>
<td>1.196971034</td>
<td>NaN</td>
<td>36057267</td>
<td>4</td>
<td>Kooringa Lucy</td>
<td>2.61</td>
<td>2022-04-01</td>
</tr>
<tr>
<th>908</th>
<td>Wentworth Park</td>
<td>11</td>
<td>R9 520m Heat</td>
<td>9</td>
<td>1.196971034</td>
<td>NaN</td>
<td>25540155</td>
<td>6</td>
<td>Shanjo Prince</td>
<td>213.53</td>
<td>2022-04-01</td>
</tr>
<tr>
<th>909</th>
<td>Wentworth Park</td>
<td>11</td>
<td>R9 520m Heat</td>
<td>9</td>
<td>1.196971034</td>
<td>NaN</td>
<td>39788790</td>
<td>7</td>
<td>Lots Of Chatter</td>
<td>2.10</td>
<td>2022-04-01</td>
</tr>
<tr>
<th>910</th>
<td>Wentworth Park</td>
<td>11</td>
<td>R9 520m Heat</td>
<td>9</td>
<td>1.196971034</td>
<td>NaN</td>
<td>30681833</td>
<td>8</td>
<td>Zipping Brady</td>
<td>18.25</td>
<td>2022-04-01</td>
</tr>
</tbody>
</table>
<p>27346 rows × 11 columns</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="c1"># format DogNames to merge</span>
<a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a><span class="n">todays_data</span><span class="p">[</span><span class="s1">&#39;DogName&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">todays_data</span><span class="p">[</span><span class="s1">&#39;DogName&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Res&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
<a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a><span class="n">iggy_df</span><span class="p">[</span><span class="s1">&#39;DogName&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">iggy_df</span><span class="p">[</span><span class="s1">&#39;DogName&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
<a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a><span class="c1"># Merge</span>
<a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a><span class="n">backtest</span> <span class="o">=</span> <span class="n">iggy_df</span><span class="p">[[</span><span class="s1">&#39;market_id&#39;</span><span class="p">,</span><span class="s1">&#39;selection_id&#39;</span><span class="p">,</span><span class="s1">&#39;DogName&#39;</span><span class="p">,</span><span class="s1">&#39;date_dt&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">todays_data</span><span class="p">[[</span><span class="s1">&#39;rating&#39;</span><span class="p">,</span><span class="s1">&#39;DogName&#39;</span><span class="p">,</span><span class="s1">&#39;date_dt&#39;</span><span class="p">]],</span> <span class="n">how</span> <span class="o">=</span> <span class="s1">&#39;inner&#39;</span><span class="p">,</span> <span class="n">on</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;DogName&#39;</span><span class="p">,</span><span class="s1">&#39;date_dt&#39;</span><span class="p">])</span>
<a id="__codelineno-24-6" name="__codelineno-24-6" href="#__codelineno-24-6"></a><span class="n">backtest</span>
</code></pre></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th></th>
<th>market_id</th>
<th>selection_id</th>
<th>DogName</th>
<th>date_dt</th>
<th>rating</th>
</tr>
</thead>
<tbody>
<tr>
<th>0</th>
<td>1.195395419</td>
<td>43154446</td>
<td>MAGIC ROGUE</td>
<td>2022-03-01</td>
<td>8.137725</td>
</tr>
<tr>
<th>1</th>
<td>1.195395419</td>
<td>43154447</td>
<td>YOURE OFF</td>
<td>2022-03-01</td>
<td>6.051752</td>
</tr>
<tr>
<th>2</th>
<td>1.195395419</td>
<td>42352031</td>
<td>CASTLE TOWN</td>
<td>2022-03-01</td>
<td>9.768546</td>
</tr>
<tr>
<th>3</th>
<td>1.195395419</td>
<td>43154448</td>
<td>BUCKLE UP AUMOND</td>
<td>2022-03-01</td>
<td>13.656089</td>
</tr>
<tr>
<th>4</th>
<td>1.195395419</td>
<td>42413752</td>
<td>WAS THAT THEN</td>
<td>2022-03-01</td>
<td>11.941057</td>
</tr>
<tr>
<th>...</th>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr>
<th>25540</th>
<td>1.196921144</td>
<td>39309141</td>
<td>RANAKO BALE</td>
<td>2022-03-31</td>
<td>3.975601</td>
</tr>
<tr>
<th>25541</th>
<td>1.196921144</td>
<td>39348645</td>
<td>NEVAEH BALE</td>
<td>2022-03-31</td>
<td>3.917458</td>
</tr>
<tr>
<th>25542</th>
<td>1.196921144</td>
<td>26870111</td>
<td>INGA MIA</td>
<td>2022-03-31</td>
<td>7.459386</td>
</tr>
<tr>
<th>25543</th>
<td>1.196921144</td>
<td>42472271</td>
<td>WINNIE COASTER</td>
<td>2022-03-31</td>
<td>7.046953</td>
</tr>
<tr>
<th>25544</th>
<td>1.196921144</td>
<td>40022831</td>
<td>ASTON HEBE</td>
<td>2022-03-31</td>
<td>4.603341</td>
</tr>
</tbody>
</table>
<p>25545 rows × 5 columns</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="c1"># Save predictions for if we want to backtest/simulate it later</span>
<a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a><span class="n">backtest</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;backtest.csv&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="c1"># Csv format</span>
<a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a><span class="c1"># backtest.to_pickle(&#39;backtest.pkl&#39;) # pickle format (faster, but can&#39;t open in excel)</span>
</code></pre></div>

</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Perfect, with our hacky solution we have managed to merge around a months' worth of data relatively quickly and saved it in a csv format. With all the merging it seems we have only lost around 1000 - 2000 rows of data out of 27,000 rows of data, which seems only a small price to pay.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="getting-data-ready-for-placing-live-bets">Getting data ready for placing live bets</h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Placing live bets is pretty simple but we have one issue. FastTrack Data alone is unable to tell us how many greyhounds will run in the race. For example, this race later today (2022-07-04) has 8 runners + 2 reserves:</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="n">todays_data</span><span class="p">[</span><span class="n">todays_data</span><span class="p">[</span><span class="s1">&#39;FastTrack_RaceId&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;798906744&#39;</span><span class="p">]</span>
</code></pre></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th></th>
<th></th>
<th></th>
<th>FastTrack_DogId</th>
<th>date_dt</th>
<th>Place</th>
<th>DogName</th>
<th>Box</th>
<th>Rug</th>
<th>Weight</th>
<th>StartPrice</th>
<th>Handicap</th>
<th>Margin1</th>
<th>Margin2</th>
<th>PIR</th>
<th>Checks</th>
<th>Comments</th>
<th>SplitMargin</th>
<th>RunTime</th>
<th>Prizemoney</th>
<th>FastTrack_RaceId</th>
<th>TrainerId</th>
<th>TrainerName</th>
<th>RaceName</th>
<th>RaceTime</th>
<th>Distance</th>
<th>RaceGrade</th>
<th>date</th>
<th>StartPrice_probability</th>
<th>win</th>
<th>Prizemoney_norm</th>
<th>Place_inv</th>
<th>Place_log</th>
<th>RunSpeed</th>
<th>RunTime_median</th>
<th>speed_index</th>
<th>SplitMargin_median</th>
<th>RunTime_norm</th>
<th>SplitMargin_norm</th>
<th>box_win_percent</th>
<th>RunTime_norm_min_28D</th>
<th>RunTime_norm_max_28D</th>
<th>RunTime_norm_mean_28D</th>
<th>RunTime_norm_median_28D</th>
<th>RunTime_norm_std_28D</th>
<th>SplitMargin_norm_min_28D</th>
<th>SplitMargin_norm_max_28D</th>
<th>SplitMargin_norm_mean_28D</th>
<th>SplitMargin_norm_median_28D</th>
<th>SplitMargin_norm_std_28D</th>
<th>Place_inv_min_28D</th>
<th>Place_inv_max_28D</th>
<th>Place_inv_mean_28D</th>
<th>Place_inv_median_28D</th>
<th>Place_inv_std_28D</th>
<th>Place_log_min_28D</th>
<th>Place_log_max_28D</th>
<th>Place_log_mean_28D</th>
<th>Place_log_median_28D</th>
<th>Place_log_std_28D</th>
<th>Prizemoney_norm_min_28D</th>
<th>Prizemoney_norm_max_28D</th>
<th>Prizemoney_norm_mean_28D</th>
<th>Prizemoney_norm_median_28D</th>
<th>Prizemoney_norm_std_28D</th>
<th>RunTime_norm_min_91D</th>
<th>RunTime_norm_max_91D</th>
<th>RunTime_norm_mean_91D</th>
<th>RunTime_norm_median_91D</th>
<th>RunTime_norm_std_91D</th>
<th>SplitMargin_norm_min_91D</th>
<th>SplitMargin_norm_max_91D</th>
<th>SplitMargin_norm_mean_91D</th>
<th>SplitMargin_norm_median_91D</th>
<th>SplitMargin_norm_std_91D</th>
<th>Place_inv_min_91D</th>
<th>Place_inv_max_91D</th>
<th>Place_inv_mean_91D</th>
<th>Place_inv_median_91D</th>
<th>Place_inv_std_91D</th>
<th>Place_log_min_91D</th>
<th>Place_log_max_91D</th>
<th>Place_log_mean_91D</th>
<th>Place_log_median_91D</th>
<th>Place_log_std_91D</th>
<th>Prizemoney_norm_min_91D</th>
<th>Prizemoney_norm_max_91D</th>
<th>Prizemoney_norm_mean_91D</th>
<th>Prizemoney_norm_median_91D</th>
<th>Prizemoney_norm_std_91D</th>
<th>RunTime_norm_min_365D</th>
<th>RunTime_norm_max_365D</th>
<th>RunTime_norm_mean_365D</th>
<th>RunTime_norm_median_365D</th>
<th>RunTime_norm_std_365D</th>
<th>SplitMargin_norm_min_365D</th>
<th>SplitMargin_norm_max_365D</th>
<th>SplitMargin_norm_mean_365D</th>
<th>SplitMargin_norm_median_365D</th>
<th>SplitMargin_norm_std_365D</th>
<th>Place_inv_min_365D</th>
<th>Place_inv_max_365D</th>
<th>Place_inv_mean_365D</th>
<th>Place_inv_median_365D</th>
<th>Place_inv_std_365D</th>
<th>Place_log_min_365D</th>
<th>Place_log_max_365D</th>
<th>Place_log_mean_365D</th>
<th>Place_log_median_365D</th>
<th>Place_log_std_365D</th>
<th>Prizemoney_norm_min_365D</th>
<th>Prizemoney_norm_max_365D</th>
<th>Prizemoney_norm_mean_365D</th>
<th>Prizemoney_norm_median_365D</th>
<th>Prizemoney_norm_std_365D</th>
<th>prob_LogisticRegression</th>
</tr>
<tr>
<th>DogName_bf</th>
<th>Track</th>
<th>RaceNum</th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<th>YOU SEE LINA</th>
<th>Cannington</th>
<th>1</th>
<td>530411826</td>
<td>2022-07-04</td>
<td>0.0</td>
<td>YOU SEE LINA</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0.0</td>
<td>0.0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>798906744</td>
<td>10408</td>
<td>Michael McLennan</td>
<td>FREE ENTRY TABTOUCH PARK</td>
<td>01:32PM</td>
<td>275</td>
<td>Maiden</td>
<td>04 Jul 22</td>
<td>0.0</td>
<td>0</td>
<td>0.0</td>
<td>inf</td>
<td>0.0</td>
<td>0.0</td>
<td>16.21</td>
<td>0.777366</td>
<td>5.58</td>
<td>0.0</td>
<td>0.0</td>
<td>0.167785</td>
<td>0.363135</td>
<td>0.419607</td>
<td>0.395672</td>
<td>0.404274</td>
<td>0.029202</td>
<td>0.395833</td>
<td>0.432534</td>
<td>0.410499</td>
<td>0.403130</td>
<td>0.019428</td>
<td>0.200000</td>
<td>0.500000</td>
<td>0.300000</td>
<td>0.200000</td>
<td>0.173205</td>
<td>0.477121</td>
<td>0.778151</td>
<td>0.677808</td>
<td>0.778151</td>
<td>0.173800</td>
<td>0.0</td>
<td>0.213623</td>
<td>7.120781e-02</td>
<td>0.000000</td>
<td>0.123336</td>
<td>0.184971</td>
<td>0.419607</td>
<td>0.324576</td>
<td>0.346645</td>
<td>0.092382</td>
<td>0.220812</td>
<td>0.432534</td>
<td>0.338647</td>
<td>0.353089</td>
<td>0.084555</td>
<td>0.166667</td>
<td>0.500000</td>
<td>0.316667</td>
<td>0.266667</td>
<td>0.153116</td>
<td>0.477121</td>
<td>0.845098</td>
<td>0.659617</td>
<td>0.690106</td>
<td>0.162743</td>
<td>0.0</td>
<td>0.213623</td>
<td>0.101436</td>
<td>0.092505</td>
<td>0.111554</td>
<td>0.179269</td>
<td>0.419607</td>
<td>0.303822</td>
<td>0.326906</td>
<td>0.075138</td>
<td>0.133803</td>
<td>0.432534</td>
<td>0.315318</td>
<td>0.310345</td>
<td>0.082022</td>
<td>0.125000</td>
<td>0.500000</td>
<td>0.247937</td>
<td>0.200000</td>
<td>0.121737</td>
<td>0.477121</td>
<td>0.954243</td>
<td>0.743299</td>
<td>0.778151</td>
<td>0.156196</td>
<td>0.0</td>
<td>0.213623</td>
<td>0.085118</td>
<td>0.000000</td>
<td>0.095461</td>
<td>0.115534</td>
</tr>
<tr>
<th>BELLA LINA</th>
<th>Cannington</th>
<th>1</th>
<td>547605028</td>
<td>2022-07-04</td>
<td>0.0</td>
<td>BELLA LINA</td>
<td>5</td>
<td>0</td>
<td>0</td>
<td>0.0</td>
<td>0.0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>798906744</td>
<td>83951</td>
<td>Rodney Noden</td>
<td>FREE ENTRY TABTOUCH PARK</td>
<td>01:32PM</td>
<td>275</td>
<td>Maiden</td>
<td>04 Jul 22</td>
<td>0.0</td>
<td>0</td>
<td>0.0</td>
<td>inf</td>
<td>0.0</td>
<td>0.0</td>
<td>16.21</td>
<td>0.777366</td>
<td>5.58</td>
<td>0.0</td>
<td>0.0</td>
<td>0.111111</td>
<td>0.228705</td>
<td>0.307236</td>
<td>0.273491</td>
<td>0.284534</td>
<td>0.040413</td>
<td>0.220812</td>
<td>0.285592</td>
<td>0.245073</td>
<td>0.228814</td>
<td>0.035318</td>
<td>0.166667</td>
<td>0.200000</td>
<td>0.188889</td>
<td>0.200000</td>
<td>0.019245</td>
<td>0.778151</td>
<td>0.845098</td>
<td>0.800467</td>
<td>0.778151</td>
<td>0.038652</td>
<td>0.0</td>
<td>0.000000</td>
<td>3.700743e-16</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.158046</td>
<td>0.307236</td>
<td>0.246575</td>
<td>0.264844</td>
<td>0.050600</td>
<td>0.029221</td>
<td>0.285592</td>
<td>0.203061</td>
<td>0.228814</td>
<td>0.091884</td>
<td>0.142857</td>
<td>0.200000</td>
<td>0.187075</td>
<td>0.200000</td>
<td>0.023119</td>
<td>0.778151</td>
<td>0.903090</td>
<td>0.805563</td>
<td>0.778151</td>
<td>0.049718</td>
<td>0.0</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.084276</td>
<td>0.307236</td>
<td>0.225040</td>
<td>0.234235</td>
<td>0.061784</td>
<td>0.029221</td>
<td>0.366864</td>
<td>0.240440</td>
<td>0.236842</td>
<td>0.088850</td>
<td>0.125000</td>
<td>0.250000</td>
<td>0.174702</td>
<td>0.166667</td>
<td>0.034400</td>
<td>0.698970</td>
<td>0.954243</td>
<td>0.835377</td>
<td>0.845098</td>
<td>0.073324</td>
<td>0.0</td>
<td>0.142298</td>
<td>0.008894</td>
<td>0.000000</td>
<td>0.035574</td>
<td>0.031221</td>
</tr>
<tr>
<th>PENNY KEEPING</th>
<th>Cannington</th>
<th>1</th>
<td>561780971</td>
<td>2022-07-04</td>
<td>0.0</td>
<td>PENNY KEEPING</td>
<td>8</td>
<td>0</td>
<td>0</td>
<td>0.0</td>
<td>0.0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>798906744</td>
<td>68481</td>
<td>Bradley Cook</td>
<td>FREE ENTRY TABTOUCH PARK</td>
<td>01:32PM</td>
<td>275</td>
<td>Maiden</td>
<td>04 Jul 22</td>
<td>0.0</td>
<td>0</td>
<td>0.0</td>
<td>inf</td>
<td>0.0</td>
<td>0.0</td>
<td>16.21</td>
<td>0.777366</td>
<td>5.58</td>
<td>0.0</td>
<td>0.0</td>
<td>0.100671</td>
<td>0.076736</td>
<td>0.356220</td>
<td>0.228759</td>
<td>0.253321</td>
<td>0.141352</td>
<td>0.424645</td>
<td>0.513538</td>
<td>0.474906</td>
<td>0.486535</td>
<td>0.045573</td>
<td>0.125000</td>
<td>0.500000</td>
<td>0.250000</td>
<td>0.125000</td>
<td>0.216506</td>
<td>0.477121</td>
<td>0.954243</td>
<td>0.795202</td>
<td>0.954243</td>
<td>0.275466</td>
<td>0.0</td>
<td>0.000000</td>
<td>0.000000e+00</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.076736</td>
<td>0.356220</td>
<td>0.236342</td>
<td>0.256207</td>
<td>0.116406</td>
<td>0.424645</td>
<td>0.513538</td>
<td>0.467291</td>
<td>0.465490</td>
<td>0.040207</td>
<td>0.125000</td>
<td>0.500000</td>
<td>0.223214</td>
<td>0.133929</td>
<td>0.184716</td>
<td>0.477121</td>
<td>0.954243</td>
<td>0.822174</td>
<td>0.928666</td>
<td>0.231296</td>
<td>0.0</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.076736</td>
<td>0.356220</td>
<td>0.236342</td>
<td>0.256207</td>
<td>0.116406</td>
<td>0.424645</td>
<td>0.513538</td>
<td>0.467291</td>
<td>0.465490</td>
<td>0.040207</td>
<td>0.125000</td>
<td>0.500000</td>
<td>0.223214</td>
<td>0.133929</td>
<td>0.184716</td>
<td>0.477121</td>
<td>0.954243</td>
<td>0.822174</td>
<td>0.928666</td>
<td>0.231296</td>
<td>0.0</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.049673</td>
</tr>
<tr>
<th>WHAT A PHOENIX</th>
<th>Cannington</th>
<th>1</th>
<td>603189486</td>
<td>2022-07-04</td>
<td>0.0</td>
<td>WHAT A PHOENIX</td>
<td>7</td>
<td>0</td>
<td>0</td>
<td>0.0</td>
<td>0.0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>798906744</td>
<td>10408</td>
<td>Michael McLennan</td>
<td>FREE ENTRY TABTOUCH PARK</td>
<td>01:32PM</td>
<td>275</td>
<td>Maiden</td>
<td>04 Jul 22</td>
<td>0.0</td>
<td>0</td>
<td>0.0</td>
<td>inf</td>
<td>0.0</td>
<td>0.0</td>
<td>16.21</td>
<td>0.777366</td>
<td>5.58</td>
<td>0.0</td>
<td>0.0</td>
<td>0.108392</td>
<td>0.155537</td>
<td>0.318460</td>
<td>0.227087</td>
<td>0.207265</td>
<td>0.083251</td>
<td>0.000000</td>
<td>0.338235</td>
<td>0.150847</td>
<td>0.114306</td>
<td>0.172053</td>
<td>0.125000</td>
<td>0.250000</td>
<td>0.166667</td>
<td>0.125000</td>
<td>0.072169</td>
<td>0.698970</td>
<td>0.954243</td>
<td>0.869152</td>
<td>0.954243</td>
<td>0.147382</td>
<td>0.0</td>
<td>0.000000</td>
<td>0.000000e+00</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.155537</td>
<td>0.318460</td>
<td>0.227087</td>
<td>0.207265</td>
<td>0.083251</td>
<td>0.000000</td>
<td>0.338235</td>
<td>0.150847</td>
<td>0.114306</td>
<td>0.172053</td>
<td>0.125000</td>
<td>0.250000</td>
<td>0.166667</td>
<td>0.125000</td>
<td>0.072169</td>
<td>0.698970</td>
<td>0.954243</td>
<td>0.869152</td>
<td>0.954243</td>
<td>0.147382</td>
<td>0.0</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.155537</td>
<td>0.318460</td>
<td>0.227087</td>
<td>0.207265</td>
<td>0.083251</td>
<td>0.000000</td>
<td>0.338235</td>
<td>0.150847</td>
<td>0.114306</td>
<td>0.172053</td>
<td>0.125000</td>
<td>0.250000</td>
<td>0.166667</td>
<td>0.125000</td>
<td>0.072169</td>
<td>0.698970</td>
<td>0.954243</td>
<td>0.869152</td>
<td>0.954243</td>
<td>0.147382</td>
<td>0.0</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.040679</td>
</tr>
<tr>
<th>WHAT A QUIZ</th>
<th>Cannington</th>
<th>1</th>
<td>603189487</td>
<td>2022-07-04</td>
<td>0.0</td>
<td>WHAT A QUIZ</td>
<td>2</td>
<td>0</td>
<td>0</td>
<td>0.0</td>
<td>0.0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>798906744</td>
<td>72510</td>
<td>Barry McPherson</td>
<td>FREE ENTRY TABTOUCH PARK</td>
<td>01:32PM</td>
<td>275</td>
<td>Maiden</td>
<td>04 Jul 22</td>
<td>0.0</td>
<td>0</td>
<td>0.0</td>
<td>inf</td>
<td>0.0</td>
<td>0.0</td>
<td>16.21</td>
<td>0.777366</td>
<td>5.58</td>
<td>0.0</td>
<td>0.0</td>
<td>0.141892</td>
<td>0.233563</td>
<td>0.233563</td>
<td>0.233563</td>
<td>0.233563</td>
<td>0.000000</td>
<td>0.302920</td>
<td>0.302920</td>
<td>0.302920</td>
<td>0.302920</td>
<td>0.000000</td>
<td>0.250000</td>
<td>0.250000</td>
<td>0.250000</td>
<td>0.250000</td>
<td>0.000000</td>
<td>0.698970</td>
<td>0.698970</td>
<td>0.698970</td>
<td>0.698970</td>
<td>0.000000</td>
<td>0.0</td>
<td>0.000000</td>
<td>0.000000e+00</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.233563</td>
<td>0.233563</td>
<td>0.233563</td>
<td>0.233563</td>
<td>0.000000</td>
<td>0.302920</td>
<td>0.302920</td>
<td>0.302920</td>
<td>0.302920</td>
<td>0.000000</td>
<td>0.250000</td>
<td>0.250000</td>
<td>0.250000</td>
<td>0.250000</td>
<td>0.000000</td>
<td>0.698970</td>
<td>0.698970</td>
<td>0.698970</td>
<td>0.698970</td>
<td>0.000000</td>
<td>0.0</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.233563</td>
<td>0.233563</td>
<td>0.233563</td>
<td>0.233563</td>
<td>0.000000</td>
<td>0.302920</td>
<td>0.302920</td>
<td>0.302920</td>
<td>0.302920</td>
<td>0.000000</td>
<td>0.250000</td>
<td>0.250000</td>
<td>0.250000</td>
<td>0.250000</td>
<td>0.000000</td>
<td>0.698970</td>
<td>0.698970</td>
<td>0.698970</td>
<td>0.698970</td>
<td>0.000000</td>
<td>0.0</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.043975</td>
</tr>
<tr>
<th>WHAT A SHAKER</th>
<th>Cannington</th>
<th>1</th>
<td>603189986</td>
<td>2022-07-04</td>
<td>0.0</td>
<td>WHAT A SHAKER</td>
<td>4</td>
<td>0</td>
<td>0</td>
<td>0.0</td>
<td>0.0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>798906744</td>
<td>72510</td>
<td>Barry McPherson</td>
<td>FREE ENTRY TABTOUCH PARK</td>
<td>01:32PM</td>
<td>275</td>
<td>Maiden</td>
<td>04 Jul 22</td>
<td>0.0</td>
<td>0</td>
<td>0.0</td>
<td>inf</td>
<td>0.0</td>
<td>0.0</td>
<td>16.21</td>
<td>0.777366</td>
<td>5.58</td>
<td>0.0</td>
<td>0.0</td>
<td>0.125000</td>
<td>0.282892</td>
<td>0.282892</td>
<td>0.282892</td>
<td>0.282892</td>
<td>0.000000</td>
<td>0.268116</td>
<td>0.268116</td>
<td>0.268116</td>
<td>0.268116</td>
<td>0.000000</td>
<td>0.333333</td>
<td>0.333333</td>
<td>0.333333</td>
<td>0.333333</td>
<td>0.000000</td>
<td>0.602060</td>
<td>0.602060</td>
<td>0.602060</td>
<td>0.602060</td>
<td>0.000000</td>
<td>0.0</td>
<td>0.000000</td>
<td>0.000000e+00</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.282892</td>
<td>0.282892</td>
<td>0.282892</td>
<td>0.282892</td>
<td>0.000000</td>
<td>0.268116</td>
<td>0.268116</td>
<td>0.268116</td>
<td>0.268116</td>
<td>0.000000</td>
<td>0.333333</td>
<td>0.333333</td>
<td>0.333333</td>
<td>0.333333</td>
<td>0.000000</td>
<td>0.602060</td>
<td>0.602060</td>
<td>0.602060</td>
<td>0.602060</td>
<td>0.000000</td>
<td>0.0</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.282892</td>
<td>0.282892</td>
<td>0.282892</td>
<td>0.282892</td>
<td>0.000000</td>
<td>0.268116</td>
<td>0.268116</td>
<td>0.268116</td>
<td>0.268116</td>
<td>0.000000</td>
<td>0.333333</td>
<td>0.333333</td>
<td>0.333333</td>
<td>0.333333</td>
<td>0.000000</td>
<td>0.602060</td>
<td>0.602060</td>
<td>0.602060</td>
<td>0.602060</td>
<td>0.000000</td>
<td>0.0</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.059174</td>
</tr>
<tr>
<th>WIZARDS LEGEND</th>
<th>Cannington</th>
<th>1</th>
<td>614056673</td>
<td>2022-07-04</td>
<td>0.0</td>
<td>WIZARD'S LEGEND Res.</td>
<td>10</td>
<td>0</td>
<td>0</td>
<td>0.0</td>
<td>0.0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>798906744</td>
<td>127397</td>
<td>Colin Bainbridge</td>
<td>FREE ENTRY TABTOUCH PARK</td>
<td>01:32PM</td>
<td>275</td>
<td>Maiden</td>
<td>04 Jul 22</td>
<td>0.0</td>
<td>0</td>
<td>0.0</td>
<td>inf</td>
<td>0.0</td>
<td>0.0</td>
<td>16.21</td>
<td>0.777366</td>
<td>5.58</td>
<td>0.0</td>
<td>0.0</td>
<td>0.000000</td>
<td>0.307944</td>
<td>0.341758</td>
<td>0.326417</td>
<td>0.327983</td>
<td>0.015946</td>
<td>0.206724</td>
<td>0.288937</td>
<td>0.259703</td>
<td>0.271576</td>
<td>0.036365</td>
<td>0.166667</td>
<td>0.250000</td>
<td>0.204167</td>
<td>0.200000</td>
<td>0.034359</td>
<td>0.698970</td>
<td>0.845098</td>
<td>0.775093</td>
<td>0.778151</td>
<td>0.059761</td>
<td>0.0</td>
<td>0.151629</td>
<td>3.790717e-02</td>
<td>0.000000</td>
<td>0.075814</td>
<td>0.089468</td>
<td>0.341758</td>
<td>0.269683</td>
<td>0.313202</td>
<td>0.093934</td>
<td>0.103960</td>
<td>0.377622</td>
<td>0.240904</td>
<td>0.244173</td>
<td>0.081242</td>
<td>0.125000</td>
<td>0.250000</td>
<td>0.194792</td>
<td>0.200000</td>
<td>0.042477</td>
<td>0.698970</td>
<td>0.954243</td>
<td>0.797104</td>
<td>0.778151</td>
<td>0.084209</td>
<td>0.0</td>
<td>0.151629</td>
<td>0.037164</td>
<td>0.000000</td>
<td>0.068832</td>
<td>0.089468</td>
<td>0.341758</td>
<td>0.275533</td>
<td>0.303754</td>
<td>0.077507</td>
<td>0.103960</td>
<td>0.377622</td>
<td>0.242702</td>
<td>0.244173</td>
<td>0.071625</td>
<td>0.125000</td>
<td>0.333333</td>
<td>0.204266</td>
<td>0.200000</td>
<td>0.058218</td>
<td>0.602060</td>
<td>0.954243</td>
<td>0.785504</td>
<td>0.778151</td>
<td>0.099650</td>
<td>0.0</td>
<td>0.151629</td>
<td>0.037412</td>
<td>0.000000</td>
<td>0.067696</td>
<td>0.019388</td>
</tr>
<tr>
<th>WIZARDS DRAMA</th>
<th>Cannington</th>
<th>1</th>
<td>614057677</td>
<td>2022-07-04</td>
<td>0.0</td>
<td>WIZARD'S DRAMA Res.</td>
<td>9</td>
<td>0</td>
<td>0</td>
<td>0.0</td>
<td>0.0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>798906744</td>
<td>127397</td>
<td>Colin Bainbridge</td>
<td>FREE ENTRY TABTOUCH PARK</td>
<td>01:32PM</td>
<td>275</td>
<td>Maiden</td>
<td>04 Jul 22</td>
<td>0.0</td>
<td>0</td>
<td>0.0</td>
<td>inf</td>
<td>0.0</td>
<td>0.0</td>
<td>16.21</td>
<td>0.777366</td>
<td>5.58</td>
<td>0.0</td>
<td>0.0</td>
<td>0.000000</td>
<td>0.225948</td>
<td>0.344591</td>
<td>0.271951</td>
<td>0.245316</td>
<td>0.063648</td>
<td>0.150000</td>
<td>0.269231</td>
<td>0.221376</td>
<td>0.244898</td>
<td>0.063000</td>
<td>0.142857</td>
<td>0.500000</td>
<td>0.280952</td>
<td>0.200000</td>
<td>0.191840</td>
<td>0.477121</td>
<td>0.903090</td>
<td>0.719454</td>
<td>0.778151</td>
<td>0.218967</td>
<td>0.0</td>
<td>0.209986</td>
<td>6.999522e-02</td>
<td>0.000000</td>
<td>0.121235</td>
<td>0.086870</td>
<td>0.344591</td>
<td>0.234575</td>
<td>0.238391</td>
<td>0.084399</td>
<td>0.088816</td>
<td>0.269231</td>
<td>0.188587</td>
<td>0.189288</td>
<td>0.067980</td>
<td>0.142857</td>
<td>0.500000</td>
<td>0.229762</td>
<td>0.171429</td>
<td>0.139270</td>
<td>0.477121</td>
<td>0.903090</td>
<td>0.777252</td>
<td>0.840621</td>
<td>0.169536</td>
<td>0.0</td>
<td>0.209986</td>
<td>0.059278</td>
<td>0.000000</td>
<td>0.094057</td>
<td>0.036656</td>
<td>0.344591</td>
<td>0.200202</td>
<td>0.228706</td>
<td>0.100907</td>
<td>0.069444</td>
<td>0.269231</td>
<td>0.170954</td>
<td>0.162215</td>
<td>0.071007</td>
<td>0.125000</td>
<td>0.500000</td>
<td>0.229613</td>
<td>0.171429</td>
<td>0.130210</td>
<td>0.477121</td>
<td>0.954243</td>
<td>0.777477</td>
<td>0.840621</td>
<td>0.171435</td>
<td>0.0</td>
<td>0.209986</td>
<td>0.044459</td>
<td>0.000000</td>
<td>0.084096</td>
<td>0.014393</td>
</tr>
<tr>
<th>DASHING ONYX</th>
<th>Cannington</th>
<th>1</th>
<td>626191408</td>
<td>2022-07-04</td>
<td>0.0</td>
<td>DASHING ONYX</td>
<td>6</td>
<td>0</td>
<td>0</td>
<td>0.0</td>
<td>0.0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>798906744</td>
<td>67839</td>
<td>Graeme Hall</td>
<td>FREE ENTRY TABTOUCH PARK</td>
<td>01:32PM</td>
<td>275</td>
<td>Maiden</td>
<td>04 Jul 22</td>
<td>0.0</td>
<td>0</td>
<td>0.0</td>
<td>inf</td>
<td>0.0</td>
<td>0.0</td>
<td>16.21</td>
<td>0.777366</td>
<td>5.58</td>
<td>0.0</td>
<td>0.0</td>
<td>0.144876</td>
<td>0.262045</td>
<td>0.359113</td>
<td>0.314231</td>
<td>0.321535</td>
<td>0.048944</td>
<td>0.244898</td>
<td>0.377622</td>
<td>0.319292</td>
<td>0.335355</td>
<td>0.067805</td>
<td>0.166667</td>
<td>0.333333</td>
<td>0.277778</td>
<td>0.333333</td>
<td>0.096225</td>
<td>0.602060</td>
<td>0.845098</td>
<td>0.683073</td>
<td>0.602060</td>
<td>0.140318</td>
<td>0.0</td>
<td>0.185009</td>
<td>1.233393e-01</td>
<td>0.185009</td>
<td>0.106815</td>
<td>0.229498</td>
<td>0.359113</td>
<td>0.293047</td>
<td>0.291790</td>
<td>0.058241</td>
<td>0.244898</td>
<td>0.377622</td>
<td>0.318715</td>
<td>0.326170</td>
<td>0.055374</td>
<td>0.142857</td>
<td>0.333333</td>
<td>0.244048</td>
<td>0.250000</td>
<td>0.103555</td>
<td>0.602060</td>
<td>0.903090</td>
<td>0.738077</td>
<td>0.723579</td>
<td>0.158833</td>
<td>0.0</td>
<td>0.185009</td>
<td>0.092505</td>
<td>0.092505</td>
<td>0.106815</td>
<td>0.229498</td>
<td>0.359113</td>
<td>0.293047</td>
<td>0.291790</td>
<td>0.058241</td>
<td>0.244898</td>
<td>0.377622</td>
<td>0.318715</td>
<td>0.326170</td>
<td>0.055374</td>
<td>0.142857</td>
<td>0.333333</td>
<td>0.244048</td>
<td>0.250000</td>
<td>0.103555</td>
<td>0.602060</td>
<td>0.903090</td>
<td>0.738077</td>
<td>0.723579</td>
<td>0.158833</td>
<td>0.0</td>
<td>0.185009</td>
<td>0.092505</td>
<td>0.092505</td>
<td>0.106815</td>
<td>0.096959</td>
</tr>
<tr>
<th>WINTER RAIN</th>
<th>Cannington</th>
<th>1</th>
<td>637972981</td>
<td>2022-07-04</td>
<td>0.0</td>
<td>WINTER RAIN</td>
<td>3</td>
<td>0</td>
<td>0</td>
<td>0.0</td>
<td>0.0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>798906744</td>
<td>27464</td>
<td>Jennifer Thompson</td>
<td>FREE ENTRY TABTOUCH PARK</td>
<td>01:32PM</td>
<td>275</td>
<td>Maiden</td>
<td>04 Jul 22</td>
<td>0.0</td>
<td>0</td>
<td>0.0</td>
<td>inf</td>
<td>0.0</td>
<td>0.0</td>
<td>16.21</td>
<td>0.777366</td>
<td>5.58</td>
<td>0.0</td>
<td>0.0</td>
<td>0.101754</td>
<td>0.239673</td>
<td>0.371004</td>
<td>0.305338</td>
<td>0.305338</td>
<td>0.092865</td>
<td>0.133803</td>
<td>0.350640</td>
<td>0.242221</td>
<td>0.242221</td>
<td>0.153327</td>
<td>0.166667</td>
<td>0.500000</td>
<td>0.333333</td>
<td>0.333333</td>
<td>0.235702</td>
<td>0.477121</td>
<td>0.845098</td>
<td>0.661110</td>
<td>0.661110</td>
<td>0.260199</td>
<td>0.0</td>
<td>0.000000</td>
<td>0.000000e+00</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.239673</td>
<td>0.371004</td>
<td>0.305338</td>
<td>0.305338</td>
<td>0.092865</td>
<td>0.133803</td>
<td>0.350640</td>
<td>0.242221</td>
<td>0.242221</td>
<td>0.153327</td>
<td>0.166667</td>
<td>0.500000</td>
<td>0.333333</td>
<td>0.333333</td>
<td>0.235702</td>
<td>0.477121</td>
<td>0.845098</td>
<td>0.661110</td>
<td>0.661110</td>
<td>0.260199</td>
<td>0.0</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.239673</td>
<td>0.371004</td>
<td>0.305338</td>
<td>0.305338</td>
<td>0.092865</td>
<td>0.133803</td>
<td>0.350640</td>
<td>0.242221</td>
<td>0.242221</td>
<td>0.153327</td>
<td>0.166667</td>
<td>0.500000</td>
<td>0.333333</td>
<td>0.333333</td>
<td>0.235702</td>
<td>0.477121</td>
<td>0.845098</td>
<td>0.661110</td>
<td>0.661110</td>
<td>0.260199</td>
<td>0.0</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.101402</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>If we predict probabilities and renormalise now, we will calculate incorrect probabilities.</p>
<p>I've spent a really long time thinking about this and testing different methods that didn't work or weren't optimal. The best solution (and least complicated) that I have come up with is to predict probabilities on the FastTrack data first. Then a few minutes before the jump when all the lineups have been confirmed we use <code>market_catalogue</code> from the Betfair API to merge our predicted probabilities, merging on <code>DogName</code>,<code>Track</code> and <code>RaceNum</code>. If we merge on these three fields, it will bypass any issues with reserve dogs and scratchings. Then we can renormalise probabilities live within Flumine.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="c1"># Select todays data </span>
<a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a><span class="n">todays_data</span> <span class="o">=</span> <span class="n">model_df</span><span class="p">[</span><span class="n">model_df</span><span class="p">[</span><span class="s1">&#39;date_dt&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)]</span>
<a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a>
<a id="__codelineno-27-4" name="__codelineno-27-4" href="#__codelineno-27-4"></a><span class="c1"># Generate runner win predictions</span>
<a id="__codelineno-27-5" name="__codelineno-27-5" href="#__codelineno-27-5"></a><span class="n">dog_win_probabilities</span> <span class="o">=</span> <span class="n">brunos_model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">todays_data</span><span class="p">[</span><span class="n">feature_cols</span><span class="p">])[:,</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-27-6" name="__codelineno-27-6" href="#__codelineno-27-6"></a><span class="n">todays_data</span><span class="p">[</span><span class="s1">&#39;prob_LogisticRegression&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dog_win_probabilities</span>
<a id="__codelineno-27-7" name="__codelineno-27-7" href="#__codelineno-27-7"></a>
<a id="__codelineno-27-8" name="__codelineno-27-8" href="#__codelineno-27-8"></a><span class="c1"># We no longer renomralise probability in this chunk of code, do it in Flumine instead</span>
<a id="__codelineno-27-9" name="__codelineno-27-9" href="#__codelineno-27-9"></a><span class="c1"># todays_data[&#39;renormalise_prob&#39;] = todays_data.groupby(&#39;FastTrack_RaceId&#39;)[&#39;prob_LogisticRegression&#39;].apply(lambda x: x / x.sum())</span>
<a id="__codelineno-27-10" name="__codelineno-27-10" href="#__codelineno-27-10"></a><span class="c1"># todays_data[&#39;rating&#39;] = 1/todays_data[&#39;renormalise_prob&#39;]</span>
<a id="__codelineno-27-11" name="__codelineno-27-11" href="#__codelineno-27-11"></a><span class="c1"># todays_data = todays_data.sort_values(by = &#39;date_dt&#39;)</span>
<a id="__codelineno-27-12" name="__codelineno-27-12" href="#__codelineno-27-12"></a>
<a id="__codelineno-27-13" name="__codelineno-27-13" href="#__codelineno-27-13"></a><span class="n">todays_data</span>
</code></pre></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_subarea output_stream output_stderr output_text">
<pre>
<code>C:\Users\zhoui\AppData\Local\Temp/ipykernel_25584/2638603781.py:6: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  todays_data['prob_LogisticRegression'] = dog_win_probabilities
</code>
</pre>
</div>
</div>
<div class="output_area">
<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th></th>
<th>FastTrack_DogId</th>
<th>date_dt</th>
<th>Place</th>
<th>DogName</th>
<th>Box</th>
<th>Rug</th>
<th>Weight</th>
<th>StartPrice</th>
<th>Handicap</th>
<th>Margin1</th>
<th>Margin2</th>
<th>PIR</th>
<th>Checks</th>
<th>Comments</th>
<th>SplitMargin</th>
<th>RunTime</th>
<th>Prizemoney</th>
<th>FastTrack_RaceId</th>
<th>TrainerId</th>
<th>TrainerName</th>
<th>RaceNum</th>
<th>RaceName</th>
<th>RaceTime</th>
<th>Distance</th>
<th>RaceGrade</th>
<th>Track</th>
<th>date</th>
<th>StartPrice_probability</th>
<th>win</th>
<th>Prizemoney_norm</th>
<th>Place_inv</th>
<th>Place_log</th>
<th>RunSpeed</th>
<th>RunTime_median</th>
<th>speed_index</th>
<th>SplitMargin_median</th>
<th>RunTime_norm</th>
<th>SplitMargin_norm</th>
<th>box_win_percent</th>
<th>RunTime_norm_min_28D</th>
<th>RunTime_norm_max_28D</th>
<th>RunTime_norm_mean_28D</th>
<th>RunTime_norm_median_28D</th>
<th>RunTime_norm_std_28D</th>
<th>SplitMargin_norm_min_28D</th>
<th>SplitMargin_norm_max_28D</th>
<th>SplitMargin_norm_mean_28D</th>
<th>SplitMargin_norm_median_28D</th>
<th>SplitMargin_norm_std_28D</th>
<th>Place_inv_min_28D</th>
<th>Place_inv_max_28D</th>
<th>Place_inv_mean_28D</th>
<th>Place_inv_median_28D</th>
<th>Place_inv_std_28D</th>
<th>Place_log_min_28D</th>
<th>Place_log_max_28D</th>
<th>Place_log_mean_28D</th>
<th>Place_log_median_28D</th>
<th>Place_log_std_28D</th>
<th>Prizemoney_norm_min_28D</th>
<th>Prizemoney_norm_max_28D</th>
<th>Prizemoney_norm_mean_28D</th>
<th>Prizemoney_norm_median_28D</th>
<th>Prizemoney_norm_std_28D</th>
<th>RunTime_norm_min_91D</th>
<th>RunTime_norm_max_91D</th>
<th>RunTime_norm_mean_91D</th>
<th>RunTime_norm_median_91D</th>
<th>RunTime_norm_std_91D</th>
<th>SplitMargin_norm_min_91D</th>
<th>SplitMargin_norm_max_91D</th>
<th>SplitMargin_norm_mean_91D</th>
<th>SplitMargin_norm_median_91D</th>
<th>SplitMargin_norm_std_91D</th>
<th>Place_inv_min_91D</th>
<th>Place_inv_max_91D</th>
<th>Place_inv_mean_91D</th>
<th>Place_inv_median_91D</th>
<th>Place_inv_std_91D</th>
<th>Place_log_min_91D</th>
<th>Place_log_max_91D</th>
<th>Place_log_mean_91D</th>
<th>Place_log_median_91D</th>
<th>Place_log_std_91D</th>
<th>Prizemoney_norm_min_91D</th>
<th>Prizemoney_norm_max_91D</th>
<th>Prizemoney_norm_mean_91D</th>
<th>Prizemoney_norm_median_91D</th>
<th>Prizemoney_norm_std_91D</th>
<th>RunTime_norm_min_365D</th>
<th>RunTime_norm_max_365D</th>
<th>RunTime_norm_mean_365D</th>
<th>RunTime_norm_median_365D</th>
<th>RunTime_norm_std_365D</th>
<th>SplitMargin_norm_min_365D</th>
<th>SplitMargin_norm_max_365D</th>
<th>SplitMargin_norm_mean_365D</th>
<th>SplitMargin_norm_median_365D</th>
<th>SplitMargin_norm_std_365D</th>
<th>Place_inv_min_365D</th>
<th>Place_inv_max_365D</th>
<th>Place_inv_mean_365D</th>
<th>Place_inv_median_365D</th>
<th>Place_inv_std_365D</th>
<th>Place_log_min_365D</th>
<th>Place_log_max_365D</th>
<th>Place_log_mean_365D</th>
<th>Place_log_median_365D</th>
<th>Place_log_std_365D</th>
<th>Prizemoney_norm_min_365D</th>
<th>Prizemoney_norm_max_365D</th>
<th>Prizemoney_norm_mean_365D</th>
<th>Prizemoney_norm_median_365D</th>
<th>Prizemoney_norm_std_365D</th>
<th>prob_LogisticRegression</th>
</tr>
</thead>
<tbody>
<tr>
<th>44514</th>
<td>148673258</td>
<td>2022-07-04</td>
<td>0.0</td>
<td>SPEEDY MARINA</td>
<td>5</td>
<td>0</td>
<td>0</td>
<td>0.0</td>
<td>0.0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>801455740</td>
<td>65928</td>
<td>Dawn Lee</td>
<td>5</td>
<td>LADBROKES BLENDED BETS 1-3 WIN</td>
<td>04:37PM</td>
<td>307</td>
<td>Grade 5</td>
<td>Bathurst</td>
<td>04 Jul 22</td>
<td>0.0</td>
<td>0</td>
<td>0.0</td>
<td>inf</td>
<td>0.0</td>
<td>0.0</td>
<td>17.830</td>
<td>0.628105</td>
<td>7.880</td>
<td>0.0</td>
<td>0.0</td>
<td>0.136986</td>
<td>0.317232</td>
<td>0.317232</td>
<td>0.317232</td>
<td>0.317232</td>
<td>0.000000</td>
<td>0.173267</td>
<td>0.173267</td>
<td>0.173267</td>
<td>0.173267</td>
<td>0.000000</td>
<td>0.333333</td>
<td>0.333333</td>
<td>0.333333</td>
<td>0.333333</td>
<td>0.000000</td>
<td>0.602060</td>
<td>0.602060</td>
<td>6.020600e-01</td>
<td>0.602060</td>
<td>0.000000</td>
<td>0.212109</td>
<td>0.212109</td>
<td>2.121089e-01</td>
<td>0.212109</td>
<td>0.000000e+00</td>
<td>0.317232</td>
<td>0.332373</td>
<td>0.324803</td>
<td>0.324803</td>
<td>0.010706</td>
<td>0.173267</td>
<td>0.210579</td>
<td>0.191923</td>
<td>0.191923</td>
<td>0.026383</td>
<td>0.166667</td>
<td>0.333333</td>
<td>0.250000</td>
<td>0.250000</td>
<td>0.117851</td>
<td>0.602060</td>
<td>0.845098</td>
<td>7.235790e-01</td>
<td>0.723579</td>
<td>0.171854</td>
<td>0.000000</td>
<td>0.212109</td>
<td>0.106054</td>
<td>0.106054</td>
<td>0.149984</td>
<td>0.236982</td>
<td>0.371585</td>
<td>0.306603</td>
<td>0.317232</td>
<td>0.052095</td>
<td>0.173267</td>
<td>0.406600</td>
<td>0.242140</td>
<td>0.210579</td>
<td>0.096894</td>
<td>0.125000</td>
<td>0.333333</td>
<td>0.186905</td>
<td>0.166667</td>
<td>0.083715</td>
<td>0.602060</td>
<td>0.954243</td>
<td>8.299177e-01</td>
<td>0.845098</td>
<td>0.135269</td>
<td>0.000000</td>
<td>0.212109</td>
<td>0.042422</td>
<td>0.000000</td>
<td>0.094858</td>
<td>0.073607</td>
</tr>
<tr>
<th>54463</th>
<td>161977365</td>
<td>2022-07-04</td>
<td>0.0</td>
<td>FILTHY PHANTOM</td>
<td>7</td>
<td>0</td>
<td>0</td>
<td>0.0</td>
<td>0.0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>801448232</td>
<td>110385</td>
<td>Tony Hinrichsen</td>
<td>5</td>
<td>GIDDY-UP (N/P) STAKE</td>
<td>07:27PM</td>
<td>342</td>
<td>Masters</td>
<td>Angle Park</td>
<td>04 Jul 22</td>
<td>0.0</td>
<td>0</td>
<td>0.0</td>
<td>inf</td>
<td>0.0</td>
<td>0.0</td>
<td>19.675</td>
<td>0.533632</td>
<td>7.730</td>
<td>0.0</td>
<td>0.0</td>
<td>0.124590</td>
<td>0.386907</td>
<td>0.455919</td>
<td>0.427165</td>
<td>0.420839</td>
<td>0.028492</td>
<td>0.314004</td>
<td>0.500000</td>
<td>0.408769</td>
<td>0.394027</td>
<td>0.082256</td>
<td>0.166667</td>
<td>0.333333</td>
<td>0.220000</td>
<td>0.200000</td>
<td>0.064979</td>
<td>0.602060</td>
<td>0.845098</td>
<td>7.563224e-01</td>
<td>0.778151</td>
<td>0.090977</td>
<td>0.000000</td>
<td>0.182760</td>
<td>3.655208e-02</td>
<td>0.000000</td>
<td>8.173293e-02</td>
<td>0.386907</td>
<td>0.572783</td>
<td>0.449667</td>
<td>0.436026</td>
<td>0.053935</td>
<td>0.210921</td>
<td>0.551665</td>
<td>0.403088</td>
<td>0.394027</td>
<td>0.092070</td>
<td>0.142857</td>
<td>1.000000</td>
<td>0.291209</td>
<td>0.200000</td>
<td>0.235613</td>
<td>0.000000</td>
<td>0.903090</td>
<td>6.692431e-01</td>
<td>0.778151</td>
<td>0.257193</td>
<td>0.000000</td>
<td>0.249855</td>
<td>0.057150</td>
<td>0.000000</td>
<td>0.095131</td>
<td>0.277002</td>
<td>0.572783</td>
<td>0.459854</td>
<td>0.456897</td>
<td>0.059514</td>
<td>0.210921</td>
<td>0.616496</td>
<td>0.443040</td>
<td>0.443820</td>
<td>0.089192</td>
<td>0.142857</td>
<td>1.000000</td>
<td>0.464354</td>
<td>0.333333</td>
<td>0.320517</td>
<td>0.000000</td>
<td>0.903090</td>
<td>5.716763e-01</td>
<td>0.602060</td>
<td>0.227821</td>
<td>0.000000</td>
<td>0.249855</td>
<td>0.121936</td>
<td>0.180363</td>
<td>0.106520</td>
<td>0.128265</td>
</tr>
<tr>
<th>77950</th>
<td>196384049</td>
<td>2022-07-04</td>
<td>0.0</td>
<td>HOUND 'EM DOWN</td>
<td>7</td>
<td>0</td>
<td>0</td>
<td>0.0</td>
<td>0.0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>801490787</td>
<td>313281</td>
<td>Steven Winstanley</td>
<td>3</td>
<td>ZIPPING GARTH @ STUD 0-2 WIN</td>
<td>07:36PM</td>
<td>565</td>
<td>Mixed Maiden and Grade Five</td>
<td>Maitland</td>
<td>04 Jul 22</td>
<td>0.0</td>
<td>0</td>
<td>0.0</td>
<td>inf</td>
<td>0.0</td>
<td>0.0</td>
<td>31.875</td>
<td>0.342029</td>
<td>13.795</td>
<td>0.0</td>
<td>0.0</td>
<td>0.200000</td>
<td>0.233442</td>
<td>0.277637</td>
<td>0.261405</td>
<td>0.273136</td>
<td>0.024321</td>
<td>0.218310</td>
<td>0.316690</td>
<td>0.270554</td>
<td>0.276662</td>
<td>0.049474</td>
<td>0.142857</td>
<td>0.200000</td>
<td>0.161905</td>
<td>0.142857</td>
<td>0.032991</td>
<td>0.778151</td>
<td>0.903090</td>
<td>8.614437e-01</td>
<td>0.903090</td>
<td>0.072133</td>
<td>0.000000</td>
<td>0.000000</td>
<td>4.440892e-16</td>
<td>0.000000</td>
<td>0.000000e+00</td>
<td>0.194132</td>
<td>0.355912</td>
<td>0.279655</td>
<td>0.277637</td>
<td>0.046001</td>
<td>0.218310</td>
<td>0.316690</td>
<td>0.271078</td>
<td>0.275180</td>
<td>0.032574</td>
<td>0.125000</td>
<td>0.200000</td>
<td>0.158862</td>
<td>0.142857</td>
<td>0.026641</td>
<td>0.778151</td>
<td>0.954243</td>
<td>8.681223e-01</td>
<td>0.903090</td>
<td>0.060784</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.194132</td>
<td>0.462627</td>
<td>0.328446</td>
<td>0.316396</td>
<td>0.054098</td>
<td>0.218310</td>
<td>0.346154</td>
<td>0.292413</td>
<td>0.296715</td>
<td>0.036166</td>
<td>0.125000</td>
<td>0.333333</td>
<td>0.187245</td>
<td>0.166667</td>
<td>0.054481</td>
<td>0.000000</td>
<td>0.954243</td>
<td>7.520173e-01</td>
<td>0.845098</td>
<td>0.239572</td>
<td>0.000000</td>
<td>0.212109</td>
<td>0.014373</td>
<td>0.000000</td>
<td>0.050118</td>
<td>0.070298</td>
</tr>
<tr>
<th>121171</th>
<td>230053393</td>
<td>2022-07-04</td>
<td>0.0</td>
<td>CAWBOURNE CROSS</td>
<td>3</td>
<td>0</td>
<td>0</td>
<td>0.0</td>
<td>0.0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>801448232</td>
<td>104699</td>
<td>Lisa Rasmussen</td>
<td>5</td>
<td>GIDDY-UP (N/P) STAKE</td>
<td>07:27PM</td>
<td>342</td>
<td>Masters</td>
<td>Angle Park</td>
<td>04 Jul 22</td>
<td>0.0</td>
<td>0</td>
<td>0.0</td>
<td>inf</td>
<td>0.0</td>
<td>0.0</td>
<td>19.675</td>
<td>0.533632</td>
<td>7.730</td>
<td>0.0</td>
<td>0.0</td>
<td>0.169811</td>
<td>0.336395</td>
<td>0.413836</td>
<td>0.386878</td>
<td>0.410402</td>
<td>0.043753</td>
<td>0.500000</td>
<td>0.500000</td>
<td>0.500000</td>
<td>0.500000</td>
<td>0.000000</td>
<td>0.142857</td>
<td>0.250000</td>
<td>0.186508</td>
<td>0.166667</td>
<td>0.056260</td>
<td>0.698970</td>
<td>0.903090</td>
<td>8.157193e-01</td>
<td>0.845098</td>
<td>0.105184</td>
<td>0.000000</td>
<td>0.000000</td>
<td>3.700743e-16</td>
<td>0.000000</td>
<td>2.533726e-17</td>
<td>0.336395</td>
<td>0.491121</td>
<td>0.420107</td>
<td>0.412119</td>
<td>0.059452</td>
<td>0.401747</td>
<td>0.506477</td>
<td>0.480510</td>
<td>0.500000</td>
<td>0.044239</td>
<td>0.142857</td>
<td>0.500000</td>
<td>0.273810</td>
<td>0.250000</td>
<td>0.129975</td>
<td>0.477121</td>
<td>0.903090</td>
<td>7.042182e-01</td>
<td>0.698970</td>
<td>0.155860</td>
<td>0.000000</td>
<td>0.188140</td>
<td>0.058566</td>
<td>0.000000</td>
<td>0.091070</td>
<td>0.280126</td>
<td>0.505631</td>
<td>0.403460</td>
<td>0.405048</td>
<td>0.064662</td>
<td>0.329857</td>
<td>0.610664</td>
<td>0.472084</td>
<td>0.500000</td>
<td>0.079724</td>
<td>0.142857</td>
<td>0.500000</td>
<td>0.269048</td>
<td>0.225000</td>
<td>0.125458</td>
<td>0.477121</td>
<td>0.903090</td>
<td>7.115827e-01</td>
<td>0.738561</td>
<td>0.144209</td>
<td>0.000000</td>
<td>0.205324</td>
<td>0.060368</td>
<td>0.000000</td>
<td>0.090871</td>
<td>0.179535</td>
</tr>
<tr>
<th>142478</th>
<td>243599770</td>
<td>2022-07-04</td>
<td>0.0</td>
<td>SKAIKRU</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0.0</td>
<td>0.0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>801455741</td>
<td>83214</td>
<td>Robert Sonter</td>
<td>6</td>
<td>BATHURST RSL CLUB</td>
<td>04:59PM</td>
<td>450</td>
<td>Grade 5</td>
<td>Bathurst</td>
<td>04 Jul 22</td>
<td>0.0</td>
<td>0</td>
<td>0.0</td>
<td>inf</td>
<td>0.0</td>
<td>0.0</td>
<td>26.000</td>
<td>0.576406</td>
<td>15.450</td>
<td>0.0</td>
<td>0.0</td>
<td>0.159574</td>
<td>0.392354</td>
<td>0.392354</td>
<td>0.392354</td>
<td>0.392354</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.250000</td>
<td>0.250000</td>
<td>0.250000</td>
<td>0.250000</td>
<td>0.000000</td>
<td>0.698970</td>
<td>0.698970</td>
<td>6.989700e-01</td>
<td>0.698970</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>1.998401e-15</td>
<td>0.000000</td>
<td>0.000000e+00</td>
<td>0.293318</td>
<td>0.392354</td>
<td>0.329286</td>
<td>0.302186</td>
<td>0.054798</td>
<td>0.238956</td>
<td>0.238956</td>
<td>0.238956</td>
<td>0.238956</td>
<td>0.000000</td>
<td>0.142857</td>
<td>0.333333</td>
<td>0.242063</td>
<td>0.250000</td>
<td>0.095486</td>
<td>0.602060</td>
<td>0.903090</td>
<td>7.347067e-01</td>
<td>0.698970</td>
<td>0.153664</td>
<td>0.000000</td>
<td>0.167027</td>
<td>0.055676</td>
<td>0.000000</td>
<td>0.096433</td>
<td>0.285293</td>
<td>0.392354</td>
<td>0.317943</td>
<td>0.303341</td>
<td>0.036066</td>
<td>0.162722</td>
<td>0.258454</td>
<td>0.223927</td>
<td>0.237266</td>
<td>0.042031</td>
<td>0.125000</td>
<td>0.333333</td>
<td>0.202551</td>
<td>0.200000</td>
<td>0.070985</td>
<td>0.602060</td>
<td>0.954243</td>
<td>7.942519e-01</td>
<td>0.778151</td>
<td>0.120113</td>
<td>0.000000</td>
<td>0.167027</td>
<td>0.023861</td>
<td>0.000000</td>
<td>0.063130</td>
<td>0.092948</td>
</tr>
<tr>
<th>...</th>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr>
<th>599603</th>
<td>673011364</td>
<td>2022-07-04</td>
<td>0.0</td>
<td>FERAL AGENT</td>
<td>8</td>
<td>0</td>
<td>0</td>
<td>0.0</td>
<td>0.0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>801455737</td>
<td>96421</td>
<td>Derek Kerr</td>
<td>2</td>
<td>ZIPPING GARTH @ STUD MAIDEN</td>
<td>03:28PM</td>
<td>307</td>
<td>Maiden</td>
<td>Bathurst</td>
<td>04 Jul 22</td>
<td>0.0</td>
<td>0</td>
<td>0.0</td>
<td>inf</td>
<td>0.0</td>
<td>0.0</td>
<td>17.830</td>
<td>0.628105</td>
<td>7.880</td>
<td>0.0</td>
<td>0.0</td>
<td>0.177215</td>
<td>0.409480</td>
<td>0.425999</td>
<td>0.418593</td>
<td>0.420299</td>
<td>0.008391</td>
<td>0.411700</td>
<td>0.431973</td>
<td>0.421836</td>
<td>0.421836</td>
<td>0.014335</td>
<td>0.250000</td>
<td>1.000000</td>
<td>0.527778</td>
<td>0.333333</td>
<td>0.411074</td>
<td>0.301030</td>
<td>0.698970</td>
<td>5.340200e-01</td>
<td>0.602060</td>
<td>0.207512</td>
<td>0.000000</td>
<td>0.231573</td>
<td>1.478939e-01</td>
<td>0.212109</td>
<td>1.284491e-01</td>
<td>0.409480</td>
<td>0.425999</td>
<td>0.418593</td>
<td>0.420299</td>
<td>0.008391</td>
<td>0.411700</td>
<td>0.431973</td>
<td>0.421836</td>
<td>0.421836</td>
<td>0.014335</td>
<td>0.250000</td>
<td>1.000000</td>
<td>0.527778</td>
<td>0.333333</td>
<td>0.411074</td>
<td>0.301030</td>
<td>0.698970</td>
<td>5.340200e-01</td>
<td>0.602060</td>
<td>0.207512</td>
<td>0.000000</td>
<td>0.231573</td>
<td>0.147894</td>
<td>0.212109</td>
<td>0.128449</td>
<td>0.409480</td>
<td>0.425999</td>
<td>0.418593</td>
<td>0.420299</td>
<td>0.008391</td>
<td>0.411700</td>
<td>0.431973</td>
<td>0.421836</td>
<td>0.421836</td>
<td>0.014335</td>
<td>0.250000</td>
<td>1.000000</td>
<td>0.527778</td>
<td>0.333333</td>
<td>0.411074</td>
<td>0.301030</td>
<td>0.698970</td>
<td>5.340200e-01</td>
<td>0.602060</td>
<td>0.207512</td>
<td>0.000000</td>
<td>0.231573</td>
<td>0.147894</td>
<td>0.212109</td>
<td>0.128449</td>
<td>0.194287</td>
</tr>
<tr>
<th>599956</th>
<td>694776805</td>
<td>2022-07-04</td>
<td>0.0</td>
<td>WENDY MAREE</td>
<td>3</td>
<td>0</td>
<td>0</td>
<td>0.0</td>
<td>0.0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>801490818</td>
<td>307271</td>
<td>Brian Baker</td>
<td>2</td>
<td>GARRARD'S HORSE AND HOUND</td>
<td>07:11PM</td>
<td>520</td>
<td>Novice Non Penalty</td>
<td>Albion Park</td>
<td>04 Jul 22</td>
<td>0.0</td>
<td>0</td>
<td>0.0</td>
<td>inf</td>
<td>0.0</td>
<td>0.0</td>
<td>30.220</td>
<td>0.634509</td>
<td>5.630</td>
<td>0.0</td>
<td>0.0</td>
<td>0.136417</td>
<td>0.325934</td>
<td>0.410627</td>
<td>0.368281</td>
<td>0.368281</td>
<td>0.059887</td>
<td>0.168325</td>
<td>0.336770</td>
<td>0.252547</td>
<td>0.252547</td>
<td>0.119108</td>
<td>0.200000</td>
<td>0.250000</td>
<td>0.225000</td>
<td>0.225000</td>
<td>0.035355</td>
<td>0.698970</td>
<td>0.778151</td>
<td>7.385606e-01</td>
<td>0.738561</td>
<td>0.055990</td>
<td>0.110185</td>
<td>0.193690</td>
<td>1.519376e-01</td>
<td>0.151938</td>
<td>5.904714e-02</td>
<td>0.325934</td>
<td>0.410627</td>
<td>0.366778</td>
<td>0.363772</td>
<td>0.042426</td>
<td>0.168325</td>
<td>0.344322</td>
<td>0.283139</td>
<td>0.336770</td>
<td>0.099504</td>
<td>0.200000</td>
<td>0.250000</td>
<td>0.216667</td>
<td>0.200000</td>
<td>0.028868</td>
<td>0.698970</td>
<td>0.778151</td>
<td>7.517575e-01</td>
<td>0.778151</td>
<td>0.045715</td>
<td>0.110185</td>
<td>0.193690</td>
<td>0.138020</td>
<td>0.110185</td>
<td>0.048212</td>
<td>0.305980</td>
<td>0.410627</td>
<td>0.355981</td>
<td>0.361146</td>
<td>0.036561</td>
<td>0.168325</td>
<td>0.344322</td>
<td>0.274549</td>
<td>0.279411</td>
<td>0.067105</td>
<td>0.142857</td>
<td>0.333333</td>
<td>0.221032</td>
<td>0.200000</td>
<td>0.064636</td>
<td>0.602060</td>
<td>0.903090</td>
<td>7.564290e-01</td>
<td>0.778151</td>
<td>0.100056</td>
<td>0.110185</td>
<td>0.218690</td>
<td>0.142187</td>
<td>0.110185</td>
<td>0.050203</td>
<td>0.123793</td>
</tr>
<tr>
<th>600100</th>
<td>707214702</td>
<td>2022-07-04</td>
<td>0.0</td>
<td>WARDEN JODIE Res.</td>
<td>10</td>
<td>0</td>
<td>0</td>
<td>0.0</td>
<td>0.0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>801455737</td>
<td>75264</td>
<td>Sam Simonetta</td>
<td>2</td>
<td>ZIPPING GARTH @ STUD MAIDEN</td>
<td>03:28PM</td>
<td>307</td>
<td>Maiden</td>
<td>Bathurst</td>
<td>04 Jul 22</td>
<td>0.0</td>
<td>0</td>
<td>0.0</td>
<td>inf</td>
<td>0.0</td>
<td>0.0</td>
<td>17.830</td>
<td>0.628105</td>
<td>7.880</td>
<td>0.0</td>
<td>0.0</td>
<td>0.000000</td>
<td>0.146202</td>
<td>0.146202</td>
<td>0.146202</td>
<td>0.146202</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.125000</td>
<td>0.125000</td>
<td>0.125000</td>
<td>0.125000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.954243</td>
<td>1.908485e-01</td>
<td>0.000000</td>
<td>0.426750</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000e+00</td>
<td>0.000000</td>
<td>0.000000e+00</td>
<td>0.146202</td>
<td>0.146202</td>
<td>0.146202</td>
<td>0.146202</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.125000</td>
<td>0.125000</td>
<td>0.125000</td>
<td>0.125000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.954243</td>
<td>1.908485e-01</td>
<td>0.000000</td>
<td>0.426750</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.146202</td>
<td>0.146202</td>
<td>0.146202</td>
<td>0.146202</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.125000</td>
<td>0.125000</td>
<td>0.125000</td>
<td>0.125000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.954243</td>
<td>1.908485e-01</td>
<td>0.000000</td>
<td>0.426750</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.014319</td>
</tr>
<tr>
<th>600105</th>
<td>707215693</td>
<td>2022-07-04</td>
<td>0.0</td>
<td>MYSTERY ANNE</td>
<td>3</td>
<td>0</td>
<td>0</td>
<td>0.0</td>
<td>0.0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>801455737</td>
<td>75264</td>
<td>Sam Simonetta</td>
<td>2</td>
<td>ZIPPING GARTH @ STUD MAIDEN</td>
<td>03:28PM</td>
<td>307</td>
<td>Maiden</td>
<td>Bathurst</td>
<td>04 Jul 22</td>
<td>0.0</td>
<td>0</td>
<td>0.0</td>
<td>inf</td>
<td>0.0</td>
<td>0.0</td>
<td>17.830</td>
<td>0.628105</td>
<td>7.880</td>
<td>0.0</td>
<td>0.0</td>
<td>0.125874</td>
<td>0.331265</td>
<td>0.331265</td>
<td>0.331265</td>
<td>0.331265</td>
<td>0.000000</td>
<td>0.473776</td>
<td>0.473776</td>
<td>0.473776</td>
<td>0.473776</td>
<td>0.000000</td>
<td>0.250000</td>
<td>0.250000</td>
<td>0.250000</td>
<td>0.250000</td>
<td>0.000000</td>
<td>0.698970</td>
<td>0.698970</td>
<td>6.989700e-01</td>
<td>0.698970</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000e+00</td>
<td>0.000000</td>
<td>0.000000e+00</td>
<td>0.331265</td>
<td>0.331265</td>
<td>0.331265</td>
<td>0.331265</td>
<td>0.000000</td>
<td>0.473776</td>
<td>0.473776</td>
<td>0.473776</td>
<td>0.473776</td>
<td>0.000000</td>
<td>0.250000</td>
<td>0.250000</td>
<td>0.250000</td>
<td>0.250000</td>
<td>0.000000</td>
<td>0.698970</td>
<td>0.698970</td>
<td>6.989700e-01</td>
<td>0.698970</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.331265</td>
<td>0.331265</td>
<td>0.331265</td>
<td>0.331265</td>
<td>0.000000</td>
<td>0.473776</td>
<td>0.473776</td>
<td>0.473776</td>
<td>0.473776</td>
<td>0.000000</td>
<td>0.250000</td>
<td>0.250000</td>
<td>0.250000</td>
<td>0.250000</td>
<td>0.000000</td>
<td>0.698970</td>
<td>0.698970</td>
<td>6.989700e-01</td>
<td>0.698970</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.090248</td>
</tr>
<tr>
<th>600106</th>
<td>707215696</td>
<td>2022-07-04</td>
<td>0.0</td>
<td>BROKEN PROMISES</td>
<td>2</td>
<td>0</td>
<td>0</td>
<td>0.0</td>
<td>0.0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>801455736</td>
<td>75264</td>
<td>Sam Simonetta</td>
<td>1</td>
<td>WELCOME GBOTA MAIDEN</td>
<td>03:07PM</td>
<td>450</td>
<td>Maiden</td>
<td>Bathurst</td>
<td>04 Jul 22</td>
<td>0.0</td>
<td>0</td>
<td>0.0</td>
<td>inf</td>
<td>0.0</td>
<td>0.0</td>
<td>26.000</td>
<td>0.576406</td>
<td>15.450</td>
<td>0.0</td>
<td>0.0</td>
<td>0.139785</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>2.708944e-14</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000e+00</td>
<td>0.000000</td>
<td>0.000000e+00</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>2.642331e-14</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>2.842171e-14</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.060767</td>
</tr>
</tbody>
</table>
<p>1704 rows × 115 columns</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Before we merge, let's do some minor formatting changes to the FastTrack names so we can match onto the Betfair names. Betfair excludes all apostrophes and full stops in their naming convention, so we'll create a Betfair equivalent dog name on the dataset removing these characters. We also need to do this for the tracks, sometimes FastTrack will name tracks differently to Betfair e.g., Sandown Park from Betfair is known as Sandown (SAP) in the FastTrack database.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a><span class="c1"># Prepare data for easy reference in flumine</span>
<a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a><span class="n">todays_data</span><span class="p">[</span><span class="s1">&#39;DogName_bf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">todays_data</span><span class="p">[</span><span class="s1">&#39;DogName&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Res&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
<a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a><span class="n">todays_data</span><span class="o">.</span><span class="n">replace</span><span class="p">({</span><span class="s1">&#39;Sandown (SAP)&#39;</span><span class="p">:</span> <span class="s1">&#39;Sandown Park&#39;</span><span class="p">},</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-28-4" name="__codelineno-28-4" href="#__codelineno-28-4"></a><span class="n">todays_data</span> <span class="o">=</span> <span class="n">todays_data</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;DogName_bf&#39;</span><span class="p">,</span><span class="s1">&#39;Track&#39;</span><span class="p">,</span><span class="s1">&#39;RaceNum&#39;</span><span class="p">])</span>
<a id="__codelineno-28-5" name="__codelineno-28-5" href="#__codelineno-28-5"></a><span class="n">todays_data</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</code></pre></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_subarea output_stream output_stderr output_text">
<pre>
<code>C:\Users\zhoui\AppData\Local\Temp/ipykernel_25584/90992895.py:2: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  todays_data['DogName_bf'] = todays_data['DogName'].apply(lambda x: x.replace("'", "").replace(".", "").replace("Res", "").strip())
</code>
</pre>
</div>
</div>
<div class="output_area">
<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th></th>
<th></th>
<th></th>
<th>FastTrack_DogId</th>
<th>date_dt</th>
<th>Place</th>
<th>DogName</th>
<th>Box</th>
<th>Rug</th>
<th>Weight</th>
<th>StartPrice</th>
<th>Handicap</th>
<th>Margin1</th>
<th>Margin2</th>
<th>PIR</th>
<th>Checks</th>
<th>Comments</th>
<th>SplitMargin</th>
<th>RunTime</th>
<th>Prizemoney</th>
<th>FastTrack_RaceId</th>
<th>TrainerId</th>
<th>TrainerName</th>
<th>RaceName</th>
<th>RaceTime</th>
<th>Distance</th>
<th>RaceGrade</th>
<th>date</th>
<th>StartPrice_probability</th>
<th>win</th>
<th>Prizemoney_norm</th>
<th>Place_inv</th>
<th>Place_log</th>
<th>RunSpeed</th>
<th>RunTime_median</th>
<th>speed_index</th>
<th>SplitMargin_median</th>
<th>RunTime_norm</th>
<th>SplitMargin_norm</th>
<th>box_win_percent</th>
<th>RunTime_norm_min_28D</th>
<th>RunTime_norm_max_28D</th>
<th>RunTime_norm_mean_28D</th>
<th>RunTime_norm_median_28D</th>
<th>RunTime_norm_std_28D</th>
<th>SplitMargin_norm_min_28D</th>
<th>SplitMargin_norm_max_28D</th>
<th>SplitMargin_norm_mean_28D</th>
<th>SplitMargin_norm_median_28D</th>
<th>SplitMargin_norm_std_28D</th>
<th>Place_inv_min_28D</th>
<th>Place_inv_max_28D</th>
<th>Place_inv_mean_28D</th>
<th>Place_inv_median_28D</th>
<th>Place_inv_std_28D</th>
<th>Place_log_min_28D</th>
<th>Place_log_max_28D</th>
<th>Place_log_mean_28D</th>
<th>Place_log_median_28D</th>
<th>Place_log_std_28D</th>
<th>Prizemoney_norm_min_28D</th>
<th>Prizemoney_norm_max_28D</th>
<th>Prizemoney_norm_mean_28D</th>
<th>Prizemoney_norm_median_28D</th>
<th>Prizemoney_norm_std_28D</th>
<th>RunTime_norm_min_91D</th>
<th>RunTime_norm_max_91D</th>
<th>RunTime_norm_mean_91D</th>
<th>RunTime_norm_median_91D</th>
<th>RunTime_norm_std_91D</th>
<th>SplitMargin_norm_min_91D</th>
<th>SplitMargin_norm_max_91D</th>
<th>SplitMargin_norm_mean_91D</th>
<th>SplitMargin_norm_median_91D</th>
<th>SplitMargin_norm_std_91D</th>
<th>Place_inv_min_91D</th>
<th>Place_inv_max_91D</th>
<th>Place_inv_mean_91D</th>
<th>Place_inv_median_91D</th>
<th>Place_inv_std_91D</th>
<th>Place_log_min_91D</th>
<th>Place_log_max_91D</th>
<th>Place_log_mean_91D</th>
<th>Place_log_median_91D</th>
<th>Place_log_std_91D</th>
<th>Prizemoney_norm_min_91D</th>
<th>Prizemoney_norm_max_91D</th>
<th>Prizemoney_norm_mean_91D</th>
<th>Prizemoney_norm_median_91D</th>
<th>Prizemoney_norm_std_91D</th>
<th>RunTime_norm_min_365D</th>
<th>RunTime_norm_max_365D</th>
<th>RunTime_norm_mean_365D</th>
<th>RunTime_norm_median_365D</th>
<th>RunTime_norm_std_365D</th>
<th>SplitMargin_norm_min_365D</th>
<th>SplitMargin_norm_max_365D</th>
<th>SplitMargin_norm_mean_365D</th>
<th>SplitMargin_norm_median_365D</th>
<th>SplitMargin_norm_std_365D</th>
<th>Place_inv_min_365D</th>
<th>Place_inv_max_365D</th>
<th>Place_inv_mean_365D</th>
<th>Place_inv_median_365D</th>
<th>Place_inv_std_365D</th>
<th>Place_log_min_365D</th>
<th>Place_log_max_365D</th>
<th>Place_log_mean_365D</th>
<th>Place_log_median_365D</th>
<th>Place_log_std_365D</th>
<th>Prizemoney_norm_min_365D</th>
<th>Prizemoney_norm_max_365D</th>
<th>Prizemoney_norm_mean_365D</th>
<th>Prizemoney_norm_median_365D</th>
<th>Prizemoney_norm_std_365D</th>
<th>prob_LogisticRegression</th>
</tr>
<tr>
<th>DogName_bf</th>
<th>Track</th>
<th>RaceNum</th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<th>SPEEDY MARINA</th>
<th>Bathurst</th>
<th>5</th>
<td>148673258</td>
<td>2022-07-04</td>
<td>0.0</td>
<td>SPEEDY MARINA</td>
<td>5</td>
<td>0</td>
<td>0</td>
<td>0.0</td>
<td>0.0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>801455740</td>
<td>65928</td>
<td>Dawn Lee</td>
<td>LADBROKES BLENDED BETS 1-3 WIN</td>
<td>04:37PM</td>
<td>307</td>
<td>Grade 5</td>
<td>04 Jul 22</td>
<td>0.0</td>
<td>0</td>
<td>0.0</td>
<td>inf</td>
<td>0.0</td>
<td>0.0</td>
<td>17.830</td>
<td>0.628105</td>
<td>7.880</td>
<td>0.0</td>
<td>0.0</td>
<td>0.136986</td>
<td>0.317232</td>
<td>0.317232</td>
<td>0.317232</td>
<td>0.317232</td>
<td>0.000000</td>
<td>0.173267</td>
<td>0.173267</td>
<td>0.173267</td>
<td>0.173267</td>
<td>0.000000</td>
<td>0.333333</td>
<td>0.333333</td>
<td>0.333333</td>
<td>0.333333</td>
<td>0.000000</td>
<td>0.602060</td>
<td>0.602060</td>
<td>0.602060</td>
<td>0.602060</td>
<td>0.000000</td>
<td>0.212109</td>
<td>0.212109</td>
<td>2.121089e-01</td>
<td>0.212109</td>
<td>0.000000e+00</td>
<td>0.317232</td>
<td>0.332373</td>
<td>0.324803</td>
<td>0.324803</td>
<td>0.010706</td>
<td>0.173267</td>
<td>0.210579</td>
<td>0.191923</td>
<td>0.191923</td>
<td>0.026383</td>
<td>0.166667</td>
<td>0.333333</td>
<td>0.250000</td>
<td>0.250000</td>
<td>0.117851</td>
<td>0.602060</td>
<td>0.845098</td>
<td>0.723579</td>
<td>0.723579</td>
<td>0.171854</td>
<td>0.0</td>
<td>0.212109</td>
<td>0.106054</td>
<td>0.106054</td>
<td>0.149984</td>
<td>0.236982</td>
<td>0.371585</td>
<td>0.306603</td>
<td>0.317232</td>
<td>0.052095</td>
<td>0.173267</td>
<td>0.406600</td>
<td>0.242140</td>
<td>0.210579</td>
<td>0.096894</td>
<td>0.125000</td>
<td>0.333333</td>
<td>0.186905</td>
<td>0.166667</td>
<td>0.083715</td>
<td>0.602060</td>
<td>0.954243</td>
<td>0.829918</td>
<td>0.845098</td>
<td>0.135269</td>
<td>0.0</td>
<td>0.212109</td>
<td>0.042422</td>
<td>0.000000</td>
<td>0.094858</td>
<td>0.073607</td>
</tr>
<tr>
<th>FILTHY PHANTOM</th>
<th>Angle Park</th>
<th>5</th>
<td>161977365</td>
<td>2022-07-04</td>
<td>0.0</td>
<td>FILTHY PHANTOM</td>
<td>7</td>
<td>0</td>
<td>0</td>
<td>0.0</td>
<td>0.0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>801448232</td>
<td>110385</td>
<td>Tony Hinrichsen</td>
<td>GIDDY-UP (N/P) STAKE</td>
<td>07:27PM</td>
<td>342</td>
<td>Masters</td>
<td>04 Jul 22</td>
<td>0.0</td>
<td>0</td>
<td>0.0</td>
<td>inf</td>
<td>0.0</td>
<td>0.0</td>
<td>19.675</td>
<td>0.533632</td>
<td>7.730</td>
<td>0.0</td>
<td>0.0</td>
<td>0.124590</td>
<td>0.386907</td>
<td>0.455919</td>
<td>0.427165</td>
<td>0.420839</td>
<td>0.028492</td>
<td>0.314004</td>
<td>0.500000</td>
<td>0.408769</td>
<td>0.394027</td>
<td>0.082256</td>
<td>0.166667</td>
<td>0.333333</td>
<td>0.220000</td>
<td>0.200000</td>
<td>0.064979</td>
<td>0.602060</td>
<td>0.845098</td>
<td>0.756322</td>
<td>0.778151</td>
<td>0.090977</td>
<td>0.000000</td>
<td>0.182760</td>
<td>3.655208e-02</td>
<td>0.000000</td>
<td>8.173293e-02</td>
<td>0.386907</td>
<td>0.572783</td>
<td>0.449667</td>
<td>0.436026</td>
<td>0.053935</td>
<td>0.210921</td>
<td>0.551665</td>
<td>0.403088</td>
<td>0.394027</td>
<td>0.092070</td>
<td>0.142857</td>
<td>1.000000</td>
<td>0.291209</td>
<td>0.200000</td>
<td>0.235613</td>
<td>0.000000</td>
<td>0.903090</td>
<td>0.669243</td>
<td>0.778151</td>
<td>0.257193</td>
<td>0.0</td>
<td>0.249855</td>
<td>0.057150</td>
<td>0.000000</td>
<td>0.095131</td>
<td>0.277002</td>
<td>0.572783</td>
<td>0.459854</td>
<td>0.456897</td>
<td>0.059514</td>
<td>0.210921</td>
<td>0.616496</td>
<td>0.443040</td>
<td>0.443820</td>
<td>0.089192</td>
<td>0.142857</td>
<td>1.000000</td>
<td>0.464354</td>
<td>0.333333</td>
<td>0.320517</td>
<td>0.000000</td>
<td>0.903090</td>
<td>0.571676</td>
<td>0.602060</td>
<td>0.227821</td>
<td>0.0</td>
<td>0.249855</td>
<td>0.121936</td>
<td>0.180363</td>
<td>0.106520</td>
<td>0.128265</td>
</tr>
<tr>
<th>HOUND EM DOWN</th>
<th>Maitland</th>
<th>3</th>
<td>196384049</td>
<td>2022-07-04</td>
<td>0.0</td>
<td>HOUND 'EM DOWN</td>
<td>7</td>
<td>0</td>
<td>0</td>
<td>0.0</td>
<td>0.0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>801490787</td>
<td>313281</td>
<td>Steven Winstanley</td>
<td>ZIPPING GARTH @ STUD 0-2 WIN</td>
<td>07:36PM</td>
<td>565</td>
<td>Mixed Maiden and Grade Five</td>
<td>04 Jul 22</td>
<td>0.0</td>
<td>0</td>
<td>0.0</td>
<td>inf</td>
<td>0.0</td>
<td>0.0</td>
<td>31.875</td>
<td>0.342029</td>
<td>13.795</td>
<td>0.0</td>
<td>0.0</td>
<td>0.200000</td>
<td>0.233442</td>
<td>0.277637</td>
<td>0.261405</td>
<td>0.273136</td>
<td>0.024321</td>
<td>0.218310</td>
<td>0.316690</td>
<td>0.270554</td>
<td>0.276662</td>
<td>0.049474</td>
<td>0.142857</td>
<td>0.200000</td>
<td>0.161905</td>
<td>0.142857</td>
<td>0.032991</td>
<td>0.778151</td>
<td>0.903090</td>
<td>0.861444</td>
<td>0.903090</td>
<td>0.072133</td>
<td>0.000000</td>
<td>0.000000</td>
<td>4.440892e-16</td>
<td>0.000000</td>
<td>0.000000e+00</td>
<td>0.194132</td>
<td>0.355912</td>
<td>0.279655</td>
<td>0.277637</td>
<td>0.046001</td>
<td>0.218310</td>
<td>0.316690</td>
<td>0.271078</td>
<td>0.275180</td>
<td>0.032574</td>
<td>0.125000</td>
<td>0.200000</td>
<td>0.158862</td>
<td>0.142857</td>
<td>0.026641</td>
<td>0.778151</td>
<td>0.954243</td>
<td>0.868122</td>
<td>0.903090</td>
<td>0.060784</td>
<td>0.0</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.194132</td>
<td>0.462627</td>
<td>0.328446</td>
<td>0.316396</td>
<td>0.054098</td>
<td>0.218310</td>
<td>0.346154</td>
<td>0.292413</td>
<td>0.296715</td>
<td>0.036166</td>
<td>0.125000</td>
<td>0.333333</td>
<td>0.187245</td>
<td>0.166667</td>
<td>0.054481</td>
<td>0.000000</td>
<td>0.954243</td>
<td>0.752017</td>
<td>0.845098</td>
<td>0.239572</td>
<td>0.0</td>
<td>0.212109</td>
<td>0.014373</td>
<td>0.000000</td>
<td>0.050118</td>
<td>0.070298</td>
</tr>
<tr>
<th>CAWBOURNE CROSS</th>
<th>Angle Park</th>
<th>5</th>
<td>230053393</td>
<td>2022-07-04</td>
<td>0.0</td>
<td>CAWBOURNE CROSS</td>
<td>3</td>
<td>0</td>
<td>0</td>
<td>0.0</td>
<td>0.0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>801448232</td>
<td>104699</td>
<td>Lisa Rasmussen</td>
<td>GIDDY-UP (N/P) STAKE</td>
<td>07:27PM</td>
<td>342</td>
<td>Masters</td>
<td>04 Jul 22</td>
<td>0.0</td>
<td>0</td>
<td>0.0</td>
<td>inf</td>
<td>0.0</td>
<td>0.0</td>
<td>19.675</td>
<td>0.533632</td>
<td>7.730</td>
<td>0.0</td>
<td>0.0</td>
<td>0.169811</td>
<td>0.336395</td>
<td>0.413836</td>
<td>0.386878</td>
<td>0.410402</td>
<td>0.043753</td>
<td>0.500000</td>
<td>0.500000</td>
<td>0.500000</td>
<td>0.500000</td>
<td>0.000000</td>
<td>0.142857</td>
<td>0.250000</td>
<td>0.186508</td>
<td>0.166667</td>
<td>0.056260</td>
<td>0.698970</td>
<td>0.903090</td>
<td>0.815719</td>
<td>0.845098</td>
<td>0.105184</td>
<td>0.000000</td>
<td>0.000000</td>
<td>3.700743e-16</td>
<td>0.000000</td>
<td>2.533726e-17</td>
<td>0.336395</td>
<td>0.491121</td>
<td>0.420107</td>
<td>0.412119</td>
<td>0.059452</td>
<td>0.401747</td>
<td>0.506477</td>
<td>0.480510</td>
<td>0.500000</td>
<td>0.044239</td>
<td>0.142857</td>
<td>0.500000</td>
<td>0.273810</td>
<td>0.250000</td>
<td>0.129975</td>
<td>0.477121</td>
<td>0.903090</td>
<td>0.704218</td>
<td>0.698970</td>
<td>0.155860</td>
<td>0.0</td>
<td>0.188140</td>
<td>0.058566</td>
<td>0.000000</td>
<td>0.091070</td>
<td>0.280126</td>
<td>0.505631</td>
<td>0.403460</td>
<td>0.405048</td>
<td>0.064662</td>
<td>0.329857</td>
<td>0.610664</td>
<td>0.472084</td>
<td>0.500000</td>
<td>0.079724</td>
<td>0.142857</td>
<td>0.500000</td>
<td>0.269048</td>
<td>0.225000</td>
<td>0.125458</td>
<td>0.477121</td>
<td>0.903090</td>
<td>0.711583</td>
<td>0.738561</td>
<td>0.144209</td>
<td>0.0</td>
<td>0.205324</td>
<td>0.060368</td>
<td>0.000000</td>
<td>0.090871</td>
<td>0.179535</td>
</tr>
<tr>
<th>SKAIKRU</th>
<th>Bathurst</th>
<th>6</th>
<td>243599770</td>
<td>2022-07-04</td>
<td>0.0</td>
<td>SKAIKRU</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0.0</td>
<td>0.0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>801455741</td>
<td>83214</td>
<td>Robert Sonter</td>
<td>BATHURST RSL CLUB</td>
<td>04:59PM</td>
<td>450</td>
<td>Grade 5</td>
<td>04 Jul 22</td>
<td>0.0</td>
<td>0</td>
<td>0.0</td>
<td>inf</td>
<td>0.0</td>
<td>0.0</td>
<td>26.000</td>
<td>0.576406</td>
<td>15.450</td>
<td>0.0</td>
<td>0.0</td>
<td>0.159574</td>
<td>0.392354</td>
<td>0.392354</td>
<td>0.392354</td>
<td>0.392354</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.250000</td>
<td>0.250000</td>
<td>0.250000</td>
<td>0.250000</td>
<td>0.000000</td>
<td>0.698970</td>
<td>0.698970</td>
<td>0.698970</td>
<td>0.698970</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>1.998401e-15</td>
<td>0.000000</td>
<td>0.000000e+00</td>
<td>0.293318</td>
<td>0.392354</td>
<td>0.329286</td>
<td>0.302186</td>
<td>0.054798</td>
<td>0.238956</td>
<td>0.238956</td>
<td>0.238956</td>
<td>0.238956</td>
<td>0.000000</td>
<td>0.142857</td>
<td>0.333333</td>
<td>0.242063</td>
<td>0.250000</td>
<td>0.095486</td>
<td>0.602060</td>
<td>0.903090</td>
<td>0.734707</td>
<td>0.698970</td>
<td>0.153664</td>
<td>0.0</td>
<td>0.167027</td>
<td>0.055676</td>
<td>0.000000</td>
<td>0.096433</td>
<td>0.285293</td>
<td>0.392354</td>
<td>0.317943</td>
<td>0.303341</td>
<td>0.036066</td>
<td>0.162722</td>
<td>0.258454</td>
<td>0.223927</td>
<td>0.237266</td>
<td>0.042031</td>
<td>0.125000</td>
<td>0.333333</td>
<td>0.202551</td>
<td>0.200000</td>
<td>0.070985</td>
<td>0.602060</td>
<td>0.954243</td>
<td>0.794252</td>
<td>0.778151</td>
<td>0.120113</td>
<td>0.0</td>
<td>0.167027</td>
<td>0.023861</td>
<td>0.000000</td>
<td>0.063130</td>
<td>0.092948</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>If you look closely at the data frame above you might notice that for reserve dogs, they will have a Box number of 9 or 10. There is only ever a max of 8 greyhounds per race therefore we will need to adjust it somehow. I didn't notice this issue for quite a while, but the good thing is the website gives us the info we need to adjust: </p>
<p><img alt="reserve_dog" src="../hta_img/reserve_dog.png" /></p>
<p>We can see that Rhinestone Ash is a reserve dog and has the number 9, if you click on rules, you can see what Box it is starting from: </p>
<p><img alt="reserve_dog_2" src="../hta_img/reserve_dog_2.png" /></p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The problem is, my webscraping is pretty poor, and it would take significant time for me to learn it. But after going through the <a href="https://docs.developer.betfair.com/display/1smk3cen4v3lu3yomq5qye0ni/Betting+Type+Definitions#BettingTypeDefinitions-MarketDescription">documentation</a> again, changes to boxes are actually available through the API under the <code>clarifications</code> attribute of <code>marketDescription</code>. You will be able to access this within Flumine as <code>market.market_catalogue.description.clarifications</code>, but it's a bit weird. It returns box changes as a string that looks like this: <img alt="box_changes" src="../hta_img/box_changes.png" /></p>
<p>Originally I had planned to leave this article as it is since, I've never worked with anything like this before and its already getting pretty long, however huge shoutout to Betfair Quants community and especially <a href="https://github.com/Landrin-br">Brett</a> who provided his solution to working with box changes. </p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">nltk.tokenize</span><span class="w"> </span><span class="kn">import</span> <span class="n">regexp_tokenize</span>
<a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a><span class="c1"># my_string is an example string, that you will need to get live from the api via: market.market_catalogue.description.clarifications.replace(&quot;&lt;br/&gt; Dog&quot;,&quot;&lt;br/&gt;Dog&quot;)</span>
<a id="__codelineno-29-3" name="__codelineno-29-3" href="#__codelineno-29-3"></a><span class="n">my_string</span> <span class="o">=</span> <span class="s2">&quot;&lt;br/&gt;Box changes:&lt;br/&gt;Dog 9. Tralee Blaze starts from box no. 8&lt;br/&gt;&lt;br/&gt;Dog 6. That Other One starts from box no. 2&lt;br/&gt;&lt;br/&gt;&quot;</span>
<a id="__codelineno-29-4" name="__codelineno-29-4" href="#__codelineno-29-4"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;HTML Comment: </span><span class="si">{</span><span class="n">my_string</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-29-5" name="__codelineno-29-5" href="#__codelineno-29-5"></a><span class="n">pattern1</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;(?&amp;lt;=&lt;br/&gt;Dog ).+?(?= starts)&#39;</span>
<a id="__codelineno-29-6" name="__codelineno-29-6" href="#__codelineno-29-6"></a><span class="n">pattern2</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;(?&amp;lt;=\bbox no. )(\w+)&quot;</span>
<a id="__codelineno-29-7" name="__codelineno-29-7" href="#__codelineno-29-7"></a><span class="n">runners_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="p">(</span><span class="n">regexp_tokenize</span><span class="p">(</span><span class="n">my_string</span><span class="p">,</span> <span class="n">pattern1</span><span class="p">),</span> <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;runner_name&#39;</span><span class="p">])</span>
<a id="__codelineno-29-8" name="__codelineno-29-8" href="#__codelineno-29-8"></a><span class="n">runners_df</span><span class="p">[</span><span class="s1">&#39;runner_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">runners_df</span><span class="p">[</span><span class="s1">&#39;runner_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
<a id="__codelineno-29-9" name="__codelineno-29-9" href="#__codelineno-29-9"></a><span class="c1"># Remove dog name from runner_number</span>
<a id="__codelineno-29-10" name="__codelineno-29-10" href="#__codelineno-29-10"></a><span class="n">runners_df</span><span class="p">[</span><span class="s1">&#39;runner_number&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">runners_df</span><span class="p">[</span><span class="s1">&#39;runner_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[:(</span><span class="n">x</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
<a id="__codelineno-29-11" name="__codelineno-29-11" href="#__codelineno-29-11"></a><span class="c1"># Remove dog number from runner_name</span>
<a id="__codelineno-29-12" name="__codelineno-29-12" href="#__codelineno-29-12"></a><span class="n">runners_df</span><span class="p">[</span><span class="s1">&#39;runner_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">runners_df</span><span class="p">[</span><span class="s1">&#39;runner_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[(</span><span class="n">x</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):]</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
<a id="__codelineno-29-13" name="__codelineno-29-13" href="#__codelineno-29-13"></a><span class="n">runners_df</span><span class="p">[</span><span class="s1">&#39;Box&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">regexp_tokenize</span><span class="p">(</span><span class="n">my_string</span><span class="p">,</span> <span class="n">pattern2</span><span class="p">)</span>
<a id="__codelineno-29-14" name="__codelineno-29-14" href="#__codelineno-29-14"></a><span class="n">runners_df</span>
</code></pre></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_subarea output_stream output_stdout output_text">
<pre>
<code>HTML Comment: &lt;br&gt;Box changes:&lt;br&gt;Dog 9. Tralee Blaze starts from box no. 8&lt;br&gt;&lt;br&gt;Dog 6. That Other One starts from box no. 2&lt;br&gt;&lt;br&gt;
</code>
</pre>
</div>
</div>
<div class="output_area">
<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th></th>
<th>runner_name</th>
<th>runner_number</th>
<th>Box</th>
</tr>
</thead>
<tbody>
<tr>
<th>0</th>
<td>TRALEE BLAZE</td>
<td>9</td>
<td>8</td>
</tr>
<tr>
<th>1</th>
<td>THAT OTHER ONE</td>
<td>6</td>
<td>2</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Brett's solution is amazing, there is only one problem, currently our code is structured so that we generate our predictions in the morning well before the race starts. To implement the above fix, we need to generate our predictions just before the race starts to incorporate the Box information. </p>
<p>This means we need to write a little bit more code to make it happen, but we are almost there. </p>
<p>So now my plan to update the old data and generate probabilities just before the race. So now just before the jump my code structure will look like this:</p>
<ul>
<li>pull any data on box changes from the Betfair API</li>
<li>convert the box change data into a dataframe named <code>runners_df</code> using the Brett's code</li>
<li>in my original dataframe named <code>todays_data</code> replace any Box data with <code>runners_df</code> data, otherwise leave it untouched</li>
<li>then merge the <code>box_win_percent</code> dataframe back onto the <code>todays_data</code> dataframe </li>
<li>now we can predict probabilities again and then renormalise them</li>
</ul>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>It may sound a little complicated but as we already have Brett's code there is only a few extra lines of code we need to write. This is what we will add into our Flumine strategy along with Brett's code:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a># Running Brett&#39;s code gives us a nice dataframe named runners_df that we can work with
<a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a># Replace any old Box info in our original dataframe with data available in 
<a id="__codelineno-30-3" name="__codelineno-30-3" href="#__codelineno-30-3"></a>runners_df = runners_df.set_index(&#39;runner_name&#39;)
<a id="__codelineno-30-4" name="__codelineno-30-4" href="#__codelineno-30-4"></a>todays_data.loc[(runners_df.index[runners_df.index.isin(dog_names)],track,race_number),&#39;Box&#39;] = runners_df.loc[runners_df.index.isin(dog_names),&#39;Box&#39;].to_list()
<a id="__codelineno-30-5" name="__codelineno-30-5" href="#__codelineno-30-5"></a># Merge box_win_percent data onto todays_data
<a id="__codelineno-30-6" name="__codelineno-30-6" href="#__codelineno-30-6"></a>todays_data = todays_data.merge(box_win_percent, on=[&#39;Track&#39;, &#39;Distance&#39;, &#39;Box&#39;], how=&#39;left&#39;)
<a id="__codelineno-30-7" name="__codelineno-30-7" href="#__codelineno-30-7"></a># Merge box_win_percentage back on:
<a id="__codelineno-30-8" name="__codelineno-30-8" href="#__codelineno-30-8"></a>todays_data = todays_data.drop(columns = &#39;box_win_percentage&#39;, axis = 1)
<a id="__codelineno-30-9" name="__codelineno-30-9" href="#__codelineno-30-9"></a>todays_data = todays_data.merge(box_win_percent, on = [&#39;Track&#39;, &#39;Distance&#39;,&#39;Box&#39;], how = &#39;left&#39;)
<a id="__codelineno-30-10" name="__codelineno-30-10" href="#__codelineno-30-10"></a>
<a id="__codelineno-30-11" name="__codelineno-30-11" href="#__codelineno-30-11"></a># Generate probabilities using Bruno&#39;s model
<a id="__codelineno-30-12" name="__codelineno-30-12" href="#__codelineno-30-12"></a>todays_data.loc[(dog_names,track,race_number),&#39;prob_LogisticRegression&#39;] = brunos_model.predict_proba(todays_data.loc[(dog_names,track,race_number)][feature_cols])[:,1]
<a id="__codelineno-30-13" name="__codelineno-30-13" href="#__codelineno-30-13"></a># renomalise probabilities
<a id="__codelineno-30-14" name="__codelineno-30-14" href="#__codelineno-30-14"></a>probabilities = todays_data.loc[dog_names,track,race_number][&#39;prob_LogisticRegression&#39;]
<a id="__codelineno-30-15" name="__codelineno-30-15" href="#__codelineno-30-15"></a>todays_data.loc[(dog_names,track,race_number),&#39;renormalised_prob&#39;] = probabilities/probabilities.sum()
<a id="__codelineno-30-16" name="__codelineno-30-16" href="#__codelineno-30-16"></a># convert probaiblities to ratings
<a id="__codelineno-30-17" name="__codelineno-30-17" href="#__codelineno-30-17"></a>todays_data.loc[(dog_names,track,race_number),&#39;rating&#39;] = 1/todays_data.loc[dog_names,track,race_number][&#39;renormalised_prob&#39;]
</code></pre></div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now everything is done, and we can finally move onto placing our bets</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<hr />
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="automating-our-predictions">Automating our predictions</h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now that we have our data nicely set up. We can reference our probabilities by getting the DogName, Track and RaceNum from the Betfair polling API and then renormalised probabilities to calculate ratings with only a few lines of code. Then the rest is the same as How to <a href="">Automate III</a></p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a><span class="c1"># Import libraries for logging in</span>
<a id="__codelineno-31-2" name="__codelineno-31-2" href="#__codelineno-31-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">betfairlightweight</span>
<a id="__codelineno-31-3" name="__codelineno-31-3" href="#__codelineno-31-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">flumine</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flumine</span><span class="p">,</span> <span class="n">clients</span>
<a id="__codelineno-31-4" name="__codelineno-31-4" href="#__codelineno-31-4"></a>
<a id="__codelineno-31-5" name="__codelineno-31-5" href="#__codelineno-31-5"></a><span class="c1"># Credentials to login and logging in </span>
<a id="__codelineno-31-6" name="__codelineno-31-6" href="#__codelineno-31-6"></a><span class="n">trading</span> <span class="o">=</span> <span class="n">betfairlightweight</span><span class="o">.</span><span class="n">APIClient</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">,</span><span class="s1">&#39;password&#39;</span><span class="p">,</span><span class="n">app_key</span><span class="o">=</span><span class="s1">&#39;appkey&#39;</span><span class="p">)</span>
<a id="__codelineno-31-7" name="__codelineno-31-7" href="#__codelineno-31-7"></a><span class="n">client</span> <span class="o">=</span> <span class="n">clients</span><span class="o">.</span><span class="n">BetfairClient</span><span class="p">(</span><span class="n">trading</span><span class="p">,</span> <span class="n">interactive_login</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-31-8" name="__codelineno-31-8" href="#__codelineno-31-8"></a>
<a id="__codelineno-31-9" name="__codelineno-31-9" href="#__codelineno-31-9"></a><span class="c1"># Login</span>
<a id="__codelineno-31-10" name="__codelineno-31-10" href="#__codelineno-31-10"></a><span class="n">framework</span> <span class="o">=</span> <span class="n">Flumine</span><span class="p">(</span><span class="n">client</span><span class="o">=</span><span class="n">client</span><span class="p">)</span>
<a id="__codelineno-31-11" name="__codelineno-31-11" href="#__codelineno-31-11"></a>
<a id="__codelineno-31-12" name="__codelineno-31-12" href="#__codelineno-31-12"></a><span class="c1"># Code to login when using security certificates</span>
<a id="__codelineno-31-13" name="__codelineno-31-13" href="#__codelineno-31-13"></a><span class="c1"># trading = betfairlightweight.APIClient(&#39;username&#39;,&#39;password&#39;,app_key=&#39;appkey&#39;, certs=r&#39;C:\Users\zhoui\openssl_certs&#39;)</span>
<a id="__codelineno-31-14" name="__codelineno-31-14" href="#__codelineno-31-14"></a><span class="c1"># client = clients.BetfairClient(trading)</span>
<a id="__codelineno-31-15" name="__codelineno-31-15" href="#__codelineno-31-15"></a>
<a id="__codelineno-31-16" name="__codelineno-31-16" href="#__codelineno-31-16"></a><span class="c1"># framework = Flumine(client=client)</span>
</code></pre></div>

</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a><span class="c1"># Import libraries and logging</span>
<a id="__codelineno-32-2" name="__codelineno-32-2" href="#__codelineno-32-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">flumine</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseStrategy</span> 
<a id="__codelineno-32-3" name="__codelineno-32-3" href="#__codelineno-32-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">flumine.order.trade</span><span class="w"> </span><span class="kn">import</span> <span class="n">Trade</span>
<a id="__codelineno-32-4" name="__codelineno-32-4" href="#__codelineno-32-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">flumine.order.order</span><span class="w"> </span><span class="kn">import</span> <span class="n">LimitOrder</span>
<a id="__codelineno-32-5" name="__codelineno-32-5" href="#__codelineno-32-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">flumine.markets.market</span><span class="w"> </span><span class="kn">import</span> <span class="n">Market</span>
<a id="__codelineno-32-6" name="__codelineno-32-6" href="#__codelineno-32-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">betfairlightweight.filters</span><span class="w"> </span><span class="kn">import</span> <span class="n">streaming_market_filter</span>
<a id="__codelineno-32-7" name="__codelineno-32-7" href="#__codelineno-32-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">betfairlightweight.resources</span><span class="w"> </span><span class="kn">import</span> <span class="n">MarketBook</span>
<a id="__codelineno-32-8" name="__codelineno-32-8" href="#__codelineno-32-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<a id="__codelineno-32-9" name="__codelineno-32-9" href="#__codelineno-32-9"></a><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<a id="__codelineno-32-10" name="__codelineno-32-10" href="#__codelineno-32-10"></a><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<a id="__codelineno-32-11" name="__codelineno-32-11" href="#__codelineno-32-11"></a><span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span>
<a id="__codelineno-32-12" name="__codelineno-32-12" href="#__codelineno-32-12"></a><span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<a id="__codelineno-32-13" name="__codelineno-32-13" href="#__codelineno-32-13"></a><span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;how_to_automate_4.log&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1">:</span><span class="si">%(levelname)s</span><span class="s1">:</span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">)</span>
</code></pre></div>

</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let's create a new class for our strategy called FlatBetting that finds the best available to back and lay price 60 seconds before the jump. If any of those prices have value, we will place a flat bet for $5 at those prices. This code is almost the same as <a href="../How_to_Automate_3">How to Automate III</a></p>
<p>Since we are now editing our <code>todays_data</code> dataframe inside our Flumine strategy we will also need to convert <code>todays_data</code> to a global variable which is a simple one liner:
<div class="highlight"><pre><span></span><code><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a>global todays_data
</code></pre></div></p>
<p>I also wanted to call out one gotcha that, Brett found that is almost impossible to find unless you are keeping a close eye on your logs. Sometimes the polling API and streaming API doesn't match up when there are scratchings, so we need to check if it does:
<div class="highlight"><pre><span></span><code><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a># Check the polling API and streaming API matches up (sometimes it doesn&#39;t)
<a id="__codelineno-34-2" name="__codelineno-34-2" href="#__codelineno-34-2"></a>if runner_cata.selection_id == runner.selection_id:
</code></pre></div></p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">FlatBetting</span><span class="p">(</span><span class="n">BaseStrategy</span><span class="p">):</span>
<a id="__codelineno-35-2" name="__codelineno-35-2" href="#__codelineno-35-2"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-35-3" name="__codelineno-35-3" href="#__codelineno-35-3"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;starting strategy &#39;FlatBetting&#39; using the model we created the Greyhound modelling in Python Tutorial&quot;</span><span class="p">)</span>
<a id="__codelineno-35-4" name="__codelineno-35-4" href="#__codelineno-35-4"></a>
<a id="__codelineno-35-5" name="__codelineno-35-5" href="#__codelineno-35-5"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">check_market_book</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">market</span><span class="p">:</span> <span class="n">Market</span><span class="p">,</span> <span class="n">market_book</span><span class="p">:</span> <span class="n">MarketBook</span><span class="p">)</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-35-6" name="__codelineno-35-6" href="#__codelineno-35-6"></a>        <span class="k">if</span> <span class="n">market_book</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="s2">&quot;CLOSED&quot;</span><span class="p">:</span>
<a id="__codelineno-35-7" name="__codelineno-35-7" href="#__codelineno-35-7"></a>            <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-35-8" name="__codelineno-35-8" href="#__codelineno-35-8"></a>
<a id="__codelineno-35-9" name="__codelineno-35-9" href="#__codelineno-35-9"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">process_market_book</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">market</span><span class="p">:</span> <span class="n">Market</span><span class="p">,</span> <span class="n">market_book</span><span class="p">:</span> <span class="n">MarketBook</span><span class="p">)</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-35-10" name="__codelineno-35-10" href="#__codelineno-35-10"></a>        <span class="c1"># Convert dataframe to a global variable</span>
<a id="__codelineno-35-11" name="__codelineno-35-11" href="#__codelineno-35-11"></a>        <span class="k">global</span> <span class="n">todays_data</span>
<a id="__codelineno-35-12" name="__codelineno-35-12" href="#__codelineno-35-12"></a>
<a id="__codelineno-35-13" name="__codelineno-35-13" href="#__codelineno-35-13"></a>        <span class="c1"># At the 60 second mark:</span>
<a id="__codelineno-35-14" name="__codelineno-35-14" href="#__codelineno-35-14"></a>        <span class="k">if</span> <span class="n">market</span><span class="o">.</span><span class="n">seconds_to_start</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span> <span class="mi">60</span> <span class="ow">and</span> <span class="n">market_book</span><span class="o">.</span><span class="n">inplay</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
<a id="__codelineno-35-15" name="__codelineno-35-15" href="#__codelineno-35-15"></a>            <span class="c1"># get the list of dog_names, name of the track/venue and race_number/RaceNum from Betfair Polling API</span>
<a id="__codelineno-35-16" name="__codelineno-35-16" href="#__codelineno-35-16"></a>            <span class="n">dog_names</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-35-17" name="__codelineno-35-17" href="#__codelineno-35-17"></a>            <span class="n">track</span> <span class="o">=</span> <span class="n">market</span><span class="o">.</span><span class="n">market_catalogue</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">venue</span>
<a id="__codelineno-35-18" name="__codelineno-35-18" href="#__codelineno-35-18"></a>            <span class="n">race_number</span> <span class="o">=</span> <span class="n">market</span><span class="o">.</span><span class="n">market_catalogue</span><span class="o">.</span><span class="n">market_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># comes out as R1/R2/R3 .. etc</span>
<a id="__codelineno-35-19" name="__codelineno-35-19" href="#__codelineno-35-19"></a>            <span class="n">race_number</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;[^0-9]&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">race_number</span><span class="p">)</span>  <span class="c1"># only keep the numbers </span>
<a id="__codelineno-35-20" name="__codelineno-35-20" href="#__codelineno-35-20"></a>            <span class="k">for</span> <span class="n">runner_cata</span> <span class="ow">in</span> <span class="n">market</span><span class="o">.</span><span class="n">market_catalogue</span><span class="o">.</span><span class="n">runners</span><span class="p">:</span>
<a id="__codelineno-35-21" name="__codelineno-35-21" href="#__codelineno-35-21"></a>                <span class="n">dog_name</span> <span class="o">=</span> <span class="n">runner_cata</span><span class="o">.</span><span class="n">runner_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
<a id="__codelineno-35-22" name="__codelineno-35-22" href="#__codelineno-35-22"></a>                <span class="n">dog_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dog_name</span><span class="p">)</span>
<a id="__codelineno-35-23" name="__codelineno-35-23" href="#__codelineno-35-23"></a>
<a id="__codelineno-35-24" name="__codelineno-35-24" href="#__codelineno-35-24"></a>            <span class="c1"># Check if there are box changes, if there are then use Brett&#39;s code</span>
<a id="__codelineno-35-25" name="__codelineno-35-25" href="#__codelineno-35-25"></a>            <span class="k">if</span> <span class="n">market</span><span class="o">.</span><span class="n">market_catalogue</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">clarifications</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-35-26" name="__codelineno-35-26" href="#__codelineno-35-26"></a>                <span class="c1"># Brett&#39;s code to get Box changes:</span>
<a id="__codelineno-35-27" name="__codelineno-35-27" href="#__codelineno-35-27"></a>                <span class="n">my_string</span> <span class="o">=</span> <span class="n">market</span><span class="o">.</span><span class="n">market_catalogue</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">clarifications</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;br/&gt; Dog&quot;</span><span class="p">,</span><span class="s2">&quot;&lt;br/&gt;Dog&quot;</span><span class="p">)</span>
<a id="__codelineno-35-28" name="__codelineno-35-28" href="#__codelineno-35-28"></a>                <span class="n">pattern1</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;(?&amp;lt;=&lt;br/&gt;Dog ).+?(?= starts)&#39;</span>
<a id="__codelineno-35-29" name="__codelineno-35-29" href="#__codelineno-35-29"></a>                <span class="n">pattern2</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;(?&amp;lt;=\bbox no. )(\w+)&quot;</span>
<a id="__codelineno-35-30" name="__codelineno-35-30" href="#__codelineno-35-30"></a>                <span class="n">runners_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="p">(</span><span class="n">regexp_tokenize</span><span class="p">(</span><span class="n">my_string</span><span class="p">,</span> <span class="n">pattern1</span><span class="p">),</span> <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;runner_name&#39;</span><span class="p">])</span>
<a id="__codelineno-35-31" name="__codelineno-35-31" href="#__codelineno-35-31"></a>                <span class="n">runners_df</span><span class="p">[</span><span class="s1">&#39;runner_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">runners_df</span><span class="p">[</span><span class="s1">&#39;runner_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
<a id="__codelineno-35-32" name="__codelineno-35-32" href="#__codelineno-35-32"></a>                <span class="c1"># Remove dog name from runner_number</span>
<a id="__codelineno-35-33" name="__codelineno-35-33" href="#__codelineno-35-33"></a>                <span class="n">runners_df</span><span class="p">[</span><span class="s1">&#39;runner_number&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">runners_df</span><span class="p">[</span><span class="s1">&#39;runner_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[:(</span><span class="n">x</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
<a id="__codelineno-35-34" name="__codelineno-35-34" href="#__codelineno-35-34"></a>                <span class="c1"># Remove dog number from runner_name</span>
<a id="__codelineno-35-35" name="__codelineno-35-35" href="#__codelineno-35-35"></a>                <span class="n">runners_df</span><span class="p">[</span><span class="s1">&#39;runner_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">runners_df</span><span class="p">[</span><span class="s1">&#39;runner_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[(</span><span class="n">x</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):]</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
<a id="__codelineno-35-36" name="__codelineno-35-36" href="#__codelineno-35-36"></a>                <span class="n">runners_df</span><span class="p">[</span><span class="s1">&#39;Box&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">regexp_tokenize</span><span class="p">(</span><span class="n">my_string</span><span class="p">,</span> <span class="n">pattern2</span><span class="p">)</span>
<a id="__codelineno-35-37" name="__codelineno-35-37" href="#__codelineno-35-37"></a>
<a id="__codelineno-35-38" name="__codelineno-35-38" href="#__codelineno-35-38"></a>                <span class="c1"># Replace any old Box info in our original dataframe with data available in runners_df</span>
<a id="__codelineno-35-39" name="__codelineno-35-39" href="#__codelineno-35-39"></a>                <span class="n">runners_df</span> <span class="o">=</span> <span class="n">runners_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;runner_name&#39;</span><span class="p">)</span>
<a id="__codelineno-35-40" name="__codelineno-35-40" href="#__codelineno-35-40"></a>                <span class="n">todays_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">runners_df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">runners_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">dog_names</span><span class="p">)],</span><span class="n">track</span><span class="p">,</span><span class="n">race_number</span><span class="p">),</span><span class="s1">&#39;Box&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">runners_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">runners_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">dog_names</span><span class="p">),</span><span class="s1">&#39;Box&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
<a id="__codelineno-35-41" name="__codelineno-35-41" href="#__codelineno-35-41"></a>                <span class="c1"># Merge box_win_percentage back on:</span>
<a id="__codelineno-35-42" name="__codelineno-35-42" href="#__codelineno-35-42"></a>                <span class="n">todays_data</span> <span class="o">=</span> <span class="n">todays_data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="s1">&#39;box_win_percentage&#39;</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-35-43" name="__codelineno-35-43" href="#__codelineno-35-43"></a>                <span class="n">todays_data</span> <span class="o">=</span> <span class="n">todays_data</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">box_win_percent</span><span class="p">,</span> <span class="n">on</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Track&#39;</span><span class="p">,</span> <span class="s1">&#39;Distance&#39;</span><span class="p">,</span><span class="s1">&#39;Box&#39;</span><span class="p">],</span> <span class="n">how</span> <span class="o">=</span> <span class="s1">&#39;left&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;DogName_bf&#39;</span><span class="p">,</span><span class="s1">&#39;Track&#39;</span><span class="p">,</span><span class="s1">&#39;RaceNum&#39;</span><span class="p">])</span>
<a id="__codelineno-35-44" name="__codelineno-35-44" href="#__codelineno-35-44"></a>
<a id="__codelineno-35-45" name="__codelineno-35-45" href="#__codelineno-35-45"></a>            <span class="c1"># Generate probabilities using Bruno&#39;s model</span>
<a id="__codelineno-35-46" name="__codelineno-35-46" href="#__codelineno-35-46"></a>            <span class="n">todays_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">dog_names</span><span class="p">,</span><span class="n">track</span><span class="p">,</span><span class="n">race_number</span><span class="p">),</span><span class="s1">&#39;prob_LogisticRegression&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">brunos_model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">todays_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">dog_names</span><span class="p">,</span><span class="n">track</span><span class="p">,</span><span class="n">race_number</span><span class="p">)][</span><span class="n">feature_cols</span><span class="p">])[:,</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-35-47" name="__codelineno-35-47" href="#__codelineno-35-47"></a>            <span class="c1"># renomalise probabilities</span>
<a id="__codelineno-35-48" name="__codelineno-35-48" href="#__codelineno-35-48"></a>            <span class="n">probabilities</span> <span class="o">=</span> <span class="n">todays_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dog_names</span><span class="p">,</span><span class="n">track</span><span class="p">,</span><span class="n">race_number</span><span class="p">][</span><span class="s1">&#39;prob_LogisticRegression&#39;</span><span class="p">]</span>
<a id="__codelineno-35-49" name="__codelineno-35-49" href="#__codelineno-35-49"></a>            <span class="n">todays_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">dog_names</span><span class="p">,</span><span class="n">track</span><span class="p">,</span><span class="n">race_number</span><span class="p">),</span><span class="s1">&#39;renormalised_prob&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">probabilities</span><span class="o">/</span><span class="n">probabilities</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<a id="__codelineno-35-50" name="__codelineno-35-50" href="#__codelineno-35-50"></a>            <span class="c1"># convert probaiblities to ratings</span>
<a id="__codelineno-35-51" name="__codelineno-35-51" href="#__codelineno-35-51"></a>            <span class="n">todays_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">dog_names</span><span class="p">,</span><span class="n">track</span><span class="p">,</span><span class="n">race_number</span><span class="p">),</span><span class="s1">&#39;rating&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">todays_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dog_names</span><span class="p">,</span><span class="n">track</span><span class="p">,</span><span class="n">race_number</span><span class="p">][</span><span class="s1">&#39;renormalised_prob&#39;</span><span class="p">]</span>
<a id="__codelineno-35-52" name="__codelineno-35-52" href="#__codelineno-35-52"></a>
<a id="__codelineno-35-53" name="__codelineno-35-53" href="#__codelineno-35-53"></a>            <span class="c1"># Use both the polling api (market.catalogue) and the streaming api at once:</span>
<a id="__codelineno-35-54" name="__codelineno-35-54" href="#__codelineno-35-54"></a>            <span class="k">for</span> <span class="n">runner_cata</span><span class="p">,</span> <span class="n">runner</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">market</span><span class="o">.</span><span class="n">market_catalogue</span><span class="o">.</span><span class="n">runners</span><span class="p">,</span> <span class="n">market_book</span><span class="o">.</span><span class="n">runners</span><span class="p">):</span>
<a id="__codelineno-35-55" name="__codelineno-35-55" href="#__codelineno-35-55"></a>                <span class="c1"># Check the polling api and streaming api matches up (sometimes it doesn&#39;t)</span>
<a id="__codelineno-35-56" name="__codelineno-35-56" href="#__codelineno-35-56"></a>                <span class="k">if</span> <span class="n">runner_cata</span><span class="o">.</span><span class="n">selection_id</span> <span class="o">==</span> <span class="n">runner</span><span class="o">.</span><span class="n">selection_id</span><span class="p">:</span>
<a id="__codelineno-35-57" name="__codelineno-35-57" href="#__codelineno-35-57"></a>                    <span class="c1"># Get the dog_name from polling api then reference our data for our model rating</span>
<a id="__codelineno-35-58" name="__codelineno-35-58" href="#__codelineno-35-58"></a>                    <span class="n">dog_name</span> <span class="o">=</span> <span class="n">runner_cata</span><span class="o">.</span><span class="n">runner_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
<a id="__codelineno-35-59" name="__codelineno-35-59" href="#__codelineno-35-59"></a>
<a id="__codelineno-35-60" name="__codelineno-35-60" href="#__codelineno-35-60"></a>                    <span class="c1"># Rest is the same as How to Automate III</span>
<a id="__codelineno-35-61" name="__codelineno-35-61" href="#__codelineno-35-61"></a>                    <span class="n">model_price</span> <span class="o">=</span> <span class="n">todays_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dog_name</span><span class="p">,</span><span class="n">track</span><span class="p">,</span><span class="n">race_number</span><span class="p">][</span><span class="s1">&#39;rating&#39;</span><span class="p">]</span>
<a id="__codelineno-35-62" name="__codelineno-35-62" href="#__codelineno-35-62"></a>                    <span class="c1">### If you have an issue such as:</span>
<a id="__codelineno-35-63" name="__codelineno-35-63" href="#__codelineno-35-63"></a>                        <span class="c1"># Unknown error The truth value of a Series is ambiguous. Use a.empty, a.bool(), a.item(), a.any() or a.all().</span>
<a id="__codelineno-35-64" name="__codelineno-35-64" href="#__codelineno-35-64"></a>                        <span class="c1"># Then do model_price = todays_data.loc[dog_name,track,race_number][&#39;rating&#39;].item()</span>
<a id="__codelineno-35-65" name="__codelineno-35-65" href="#__codelineno-35-65"></a>
<a id="__codelineno-35-66" name="__codelineno-35-66" href="#__codelineno-35-66"></a>                    <span class="c1"># Log info before placing bets</span>
<a id="__codelineno-35-67" name="__codelineno-35-67" href="#__codelineno-35-67"></a>                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;dog_name: </span><span class="si">{</span><span class="n">dog_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-35-68" name="__codelineno-35-68" href="#__codelineno-35-68"></a>                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;model_price: </span><span class="si">{</span><span class="n">model_price</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-35-69" name="__codelineno-35-69" href="#__codelineno-35-69"></a>                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;market_id: </span><span class="si">{</span><span class="n">market_book</span><span class="o">.</span><span class="n">market_id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-35-70" name="__codelineno-35-70" href="#__codelineno-35-70"></a>                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;selection_id: </span><span class="si">{</span><span class="n">runner</span><span class="o">.</span><span class="n">selection_id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-35-71" name="__codelineno-35-71" href="#__codelineno-35-71"></a>
<a id="__codelineno-35-72" name="__codelineno-35-72" href="#__codelineno-35-72"></a>                    <span class="c1"># If best available to back price is &amp;gt; rated price then flat $5 back</span>
<a id="__codelineno-35-73" name="__codelineno-35-73" href="#__codelineno-35-73"></a>                    <span class="k">if</span> <span class="n">runner</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;ACTIVE&quot;</span> <span class="ow">and</span> <span class="n">runner</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">available_to_back</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;price&#39;</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="n">model_price</span><span class="p">:</span>
<a id="__codelineno-35-74" name="__codelineno-35-74" href="#__codelineno-35-74"></a>                        <span class="n">trade</span> <span class="o">=</span> <span class="n">Trade</span><span class="p">(</span>
<a id="__codelineno-35-75" name="__codelineno-35-75" href="#__codelineno-35-75"></a>                        <span class="n">market_id</span><span class="o">=</span><span class="n">market_book</span><span class="o">.</span><span class="n">market_id</span><span class="p">,</span>
<a id="__codelineno-35-76" name="__codelineno-35-76" href="#__codelineno-35-76"></a>                        <span class="n">selection_id</span><span class="o">=</span><span class="n">runner</span><span class="o">.</span><span class="n">selection_id</span><span class="p">,</span>
<a id="__codelineno-35-77" name="__codelineno-35-77" href="#__codelineno-35-77"></a>                        <span class="n">handicap</span><span class="o">=</span><span class="n">runner</span><span class="o">.</span><span class="n">handicap</span><span class="p">,</span>
<a id="__codelineno-35-78" name="__codelineno-35-78" href="#__codelineno-35-78"></a>                        <span class="n">strategy</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-35-79" name="__codelineno-35-79" href="#__codelineno-35-79"></a>                        <span class="p">)</span>
<a id="__codelineno-35-80" name="__codelineno-35-80" href="#__codelineno-35-80"></a>                        <span class="n">order</span> <span class="o">=</span> <span class="n">trade</span><span class="o">.</span><span class="n">create_order</span><span class="p">(</span>
<a id="__codelineno-35-81" name="__codelineno-35-81" href="#__codelineno-35-81"></a>                            <span class="n">side</span><span class="o">=</span><span class="s2">&quot;BACK&quot;</span><span class="p">,</span> <span class="n">order_type</span><span class="o">=</span><span class="n">LimitOrder</span><span class="p">(</span><span class="n">price</span><span class="o">=</span><span class="n">runner</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">available_to_back</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;price&#39;</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="mf">5.00</span><span class="p">)</span>
<a id="__codelineno-35-82" name="__codelineno-35-82" href="#__codelineno-35-82"></a>                        <span class="p">)</span>
<a id="__codelineno-35-83" name="__codelineno-35-83" href="#__codelineno-35-83"></a>                        <span class="n">market</span><span class="o">.</span><span class="n">place_order</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
<a id="__codelineno-35-84" name="__codelineno-35-84" href="#__codelineno-35-84"></a>                    <span class="c1"># If best available to lay price is &amp;lt; rated price then flat $5 lay</span>
<a id="__codelineno-35-85" name="__codelineno-35-85" href="#__codelineno-35-85"></a>                    <span class="k">if</span> <span class="n">runner</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;ACTIVE&quot;</span> <span class="ow">and</span> <span class="n">runner</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">available_to_lay</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;price&#39;</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span> <span class="n">model_price</span><span class="p">:</span>
<a id="__codelineno-35-86" name="__codelineno-35-86" href="#__codelineno-35-86"></a>                        <span class="n">trade</span> <span class="o">=</span> <span class="n">Trade</span><span class="p">(</span>
<a id="__codelineno-35-87" name="__codelineno-35-87" href="#__codelineno-35-87"></a>                        <span class="n">market_id</span><span class="o">=</span><span class="n">market_book</span><span class="o">.</span><span class="n">market_id</span><span class="p">,</span>
<a id="__codelineno-35-88" name="__codelineno-35-88" href="#__codelineno-35-88"></a>                        <span class="n">selection_id</span><span class="o">=</span><span class="n">runner</span><span class="o">.</span><span class="n">selection_id</span><span class="p">,</span>
<a id="__codelineno-35-89" name="__codelineno-35-89" href="#__codelineno-35-89"></a>                        <span class="n">handicap</span><span class="o">=</span><span class="n">runner</span><span class="o">.</span><span class="n">handicap</span><span class="p">,</span>
<a id="__codelineno-35-90" name="__codelineno-35-90" href="#__codelineno-35-90"></a>                        <span class="n">strategy</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-35-91" name="__codelineno-35-91" href="#__codelineno-35-91"></a>                        <span class="p">)</span>
<a id="__codelineno-35-92" name="__codelineno-35-92" href="#__codelineno-35-92"></a>                        <span class="n">order</span> <span class="o">=</span> <span class="n">trade</span><span class="o">.</span><span class="n">create_order</span><span class="p">(</span>
<a id="__codelineno-35-93" name="__codelineno-35-93" href="#__codelineno-35-93"></a>                            <span class="n">side</span><span class="o">=</span><span class="s2">&quot;LAY&quot;</span><span class="p">,</span> <span class="n">order_type</span><span class="o">=</span><span class="n">LimitOrder</span><span class="p">(</span><span class="n">price</span><span class="o">=</span><span class="n">runner</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">available_to_lay</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;price&#39;</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="mf">5.00</span><span class="p">)</span>
<a id="__codelineno-35-94" name="__codelineno-35-94" href="#__codelineno-35-94"></a>                        <span class="p">)</span>
<a id="__codelineno-35-95" name="__codelineno-35-95" href="#__codelineno-35-95"></a>                        <span class="n">market</span><span class="o">.</span><span class="n">place_order</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
</code></pre></div>

</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>As the model we have built is a greyhound model for Australian racing let's point our strategy to Australian greyhound win markets</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a><span class="n">greyhounds_strategy</span> <span class="o">=</span> <span class="n">FlatBetting</span><span class="p">(</span>
<a id="__codelineno-36-2" name="__codelineno-36-2" href="#__codelineno-36-2"></a>    <span class="n">market_filter</span><span class="o">=</span><span class="n">streaming_market_filter</span><span class="p">(</span>
<a id="__codelineno-36-3" name="__codelineno-36-3" href="#__codelineno-36-3"></a>        <span class="n">event_type_ids</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;4339&quot;</span><span class="p">],</span> <span class="c1"># Greyhounds markets</span>
<a id="__codelineno-36-4" name="__codelineno-36-4" href="#__codelineno-36-4"></a>        <span class="n">country_codes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;AU&quot;</span><span class="p">],</span> <span class="c1"># Australian markets</span>
<a id="__codelineno-36-5" name="__codelineno-36-5" href="#__codelineno-36-5"></a>        <span class="n">market_types</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;WIN&quot;</span><span class="p">],</span> <span class="c1"># Win markets</span>
<a id="__codelineno-36-6" name="__codelineno-36-6" href="#__codelineno-36-6"></a>    <span class="p">),</span>
<a id="__codelineno-36-7" name="__codelineno-36-7" href="#__codelineno-36-7"></a>    <span class="n">max_order_exposure</span><span class="o">=</span> <span class="mi">50</span><span class="p">,</span> <span class="c1"># Max exposure per order = 50</span>
<a id="__codelineno-36-8" name="__codelineno-36-8" href="#__codelineno-36-8"></a>    <span class="n">max_trade_count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="c1"># Max 1 trade per selection</span>
<a id="__codelineno-36-9" name="__codelineno-36-9" href="#__codelineno-36-9"></a>    <span class="n">max_live_trade_count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="c1"># Max 1 unmatched trade per selection</span>
<a id="__codelineno-36-10" name="__codelineno-36-10" href="#__codelineno-36-10"></a><span class="p">)</span>
<a id="__codelineno-36-11" name="__codelineno-36-11" href="#__codelineno-36-11"></a>
<a id="__codelineno-36-12" name="__codelineno-36-12" href="#__codelineno-36-12"></a><span class="n">framework</span><span class="o">.</span><span class="n">add_strategy</span><span class="p">(</span><span class="n">greyhounds_strategy</span><span class="p">)</span>
</code></pre></div>

</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>And add our auto-terminate and bet logging from the previous tutorials:</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a><span class="c1"># import logging</span>
<a id="__codelineno-37-2" name="__codelineno-37-2" href="#__codelineno-37-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span>
<a id="__codelineno-37-3" name="__codelineno-37-3" href="#__codelineno-37-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">flumine.worker</span><span class="w"> </span><span class="kn">import</span> <span class="n">BackgroundWorker</span>
<a id="__codelineno-37-4" name="__codelineno-37-4" href="#__codelineno-37-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">flumine.events.events</span><span class="w"> </span><span class="kn">import</span> <span class="n">TerminationEvent</span>
<a id="__codelineno-37-5" name="__codelineno-37-5" href="#__codelineno-37-5"></a>
<a id="__codelineno-37-6" name="__codelineno-37-6" href="#__codelineno-37-6"></a><span class="c1"># logger = logging.getLogger(__name__)</span>
<a id="__codelineno-37-7" name="__codelineno-37-7" href="#__codelineno-37-7"></a>
<a id="__codelineno-37-8" name="__codelineno-37-8" href="#__codelineno-37-8"></a><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-37-9" name="__codelineno-37-9" href="#__codelineno-37-9"></a><span class="sd">Worker can be used as followed:</span>
<a id="__codelineno-37-10" name="__codelineno-37-10" href="#__codelineno-37-10"></a><span class="sd">    framework.add_worker(</span>
<a id="__codelineno-37-11" name="__codelineno-37-11" href="#__codelineno-37-11"></a><span class="sd">        BackgroundWorker(</span>
<a id="__codelineno-37-12" name="__codelineno-37-12" href="#__codelineno-37-12"></a><span class="sd">            framework,</span>
<a id="__codelineno-37-13" name="__codelineno-37-13" href="#__codelineno-37-13"></a><span class="sd">            terminate,</span>
<a id="__codelineno-37-14" name="__codelineno-37-14" href="#__codelineno-37-14"></a><span class="sd">            func_kwargs={&quot;today_only&quot;: True, &quot;seconds_closed&quot;: 1200},</span>
<a id="__codelineno-37-15" name="__codelineno-37-15" href="#__codelineno-37-15"></a><span class="sd">            interval=60,</span>
<a id="__codelineno-37-16" name="__codelineno-37-16" href="#__codelineno-37-16"></a><span class="sd">            start_delay=60,</span>
<a id="__codelineno-37-17" name="__codelineno-37-17" href="#__codelineno-37-17"></a><span class="sd">        )</span>
<a id="__codelineno-37-18" name="__codelineno-37-18" href="#__codelineno-37-18"></a><span class="sd">    )</span>
<a id="__codelineno-37-19" name="__codelineno-37-19" href="#__codelineno-37-19"></a><span class="sd">This will run every 60s and will terminate </span>
<a id="__codelineno-37-20" name="__codelineno-37-20" href="#__codelineno-37-20"></a><span class="sd">the framework if all markets starting &#39;today&#39; </span>
<a id="__codelineno-37-21" name="__codelineno-37-21" href="#__codelineno-37-21"></a><span class="sd">have been closed for at least 1200s</span>
<a id="__codelineno-37-22" name="__codelineno-37-22" href="#__codelineno-37-22"></a><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-37-23" name="__codelineno-37-23" href="#__codelineno-37-23"></a>
<a id="__codelineno-37-24" name="__codelineno-37-24" href="#__codelineno-37-24"></a>
<a id="__codelineno-37-25" name="__codelineno-37-25" href="#__codelineno-37-25"></a><span class="c1"># Function that stops automation running at the end of the day</span>
<a id="__codelineno-37-26" name="__codelineno-37-26" href="#__codelineno-37-26"></a><span class="k">def</span><span class="w"> </span><span class="nf">terminate</span><span class="p">(</span>
<a id="__codelineno-37-27" name="__codelineno-37-27" href="#__codelineno-37-27"></a>    <span class="n">context</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">flumine</span><span class="p">,</span> <span class="n">today_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">seconds_closed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">600</span>
<a id="__codelineno-37-28" name="__codelineno-37-28" href="#__codelineno-37-28"></a><span class="p">)</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-37-29" name="__codelineno-37-29" href="#__codelineno-37-29"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;terminate framework if no markets</span>
<a id="__codelineno-37-30" name="__codelineno-37-30" href="#__codelineno-37-30"></a><span class="sd">    live today.</span>
<a id="__codelineno-37-31" name="__codelineno-37-31" href="#__codelineno-37-31"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-37-32" name="__codelineno-37-32" href="#__codelineno-37-32"></a>    <span class="n">markets</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">flumine</span><span class="o">.</span><span class="n">markets</span><span class="o">.</span><span class="n">markets</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
<a id="__codelineno-37-33" name="__codelineno-37-33" href="#__codelineno-37-33"></a>    <span class="n">markets_today</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-37-34" name="__codelineno-37-34" href="#__codelineno-37-34"></a>        <span class="n">m</span>
<a id="__codelineno-37-35" name="__codelineno-37-35" href="#__codelineno-37-35"></a>        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">markets</span>
<a id="__codelineno-37-36" name="__codelineno-37-36" href="#__codelineno-37-36"></a>        <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">market_start_datetime</span><span class="o">.</span><span class="n">date</span><span class="p">()</span> <span class="o">==</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
<a id="__codelineno-37-37" name="__codelineno-37-37" href="#__codelineno-37-37"></a>        <span class="ow">and</span> <span class="p">(</span>
<a id="__codelineno-37-38" name="__codelineno-37-38" href="#__codelineno-37-38"></a>            <span class="n">m</span><span class="o">.</span><span class="n">elapsed_seconds_closed</span> <span class="ow">is</span> <span class="kc">None</span>
<a id="__codelineno-37-39" name="__codelineno-37-39" href="#__codelineno-37-39"></a>            <span class="ow">or</span> <span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">elapsed_seconds_closed</span> <span class="ow">and</span> <span class="n">m</span><span class="o">.</span><span class="n">elapsed_seconds_closed</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span> <span class="n">seconds_closed</span><span class="p">)</span>
<a id="__codelineno-37-40" name="__codelineno-37-40" href="#__codelineno-37-40"></a>        <span class="p">)</span>
<a id="__codelineno-37-41" name="__codelineno-37-41" href="#__codelineno-37-41"></a>    <span class="p">]</span>
<a id="__codelineno-37-42" name="__codelineno-37-42" href="#__codelineno-37-42"></a>    <span class="k">if</span> <span class="n">today_only</span><span class="p">:</span>
<a id="__codelineno-37-43" name="__codelineno-37-43" href="#__codelineno-37-43"></a>        <span class="n">market_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">markets_today</span><span class="p">)</span>
<a id="__codelineno-37-44" name="__codelineno-37-44" href="#__codelineno-37-44"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-37-45" name="__codelineno-37-45" href="#__codelineno-37-45"></a>        <span class="n">market_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">markets</span><span class="p">)</span>
<a id="__codelineno-37-46" name="__codelineno-37-46" href="#__codelineno-37-46"></a>    <span class="k">if</span> <span class="n">market_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-37-47" name="__codelineno-37-47" href="#__codelineno-37-47"></a>        <span class="c1"># logger.info(&quot;No more markets available, terminating framework&quot;)</span>
<a id="__codelineno-37-48" name="__codelineno-37-48" href="#__codelineno-37-48"></a>        <span class="n">flumine</span><span class="o">.</span><span class="n">handler_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">TerminationEvent</span><span class="p">(</span><span class="n">flumine</span><span class="p">))</span>
<a id="__codelineno-37-49" name="__codelineno-37-49" href="#__codelineno-37-49"></a>
<a id="__codelineno-37-50" name="__codelineno-37-50" href="#__codelineno-37-50"></a><span class="c1"># Add the stopped to our framework</span>
<a id="__codelineno-37-51" name="__codelineno-37-51" href="#__codelineno-37-51"></a><span class="n">framework</span><span class="o">.</span><span class="n">add_worker</span><span class="p">(</span>
<a id="__codelineno-37-52" name="__codelineno-37-52" href="#__codelineno-37-52"></a>    <span class="n">BackgroundWorker</span><span class="p">(</span>
<a id="__codelineno-37-53" name="__codelineno-37-53" href="#__codelineno-37-53"></a>        <span class="n">framework</span><span class="p">,</span>
<a id="__codelineno-37-54" name="__codelineno-37-54" href="#__codelineno-37-54"></a>        <span class="n">terminate</span><span class="p">,</span>
<a id="__codelineno-37-55" name="__codelineno-37-55" href="#__codelineno-37-55"></a>        <span class="n">func_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;today_only&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;seconds_closed&quot;</span><span class="p">:</span> <span class="mi">1200</span><span class="p">},</span>
<a id="__codelineno-37-56" name="__codelineno-37-56" href="#__codelineno-37-56"></a>        <span class="n">interval</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
<a id="__codelineno-37-57" name="__codelineno-37-57" href="#__codelineno-37-57"></a>        <span class="n">start_delay</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
<a id="__codelineno-37-58" name="__codelineno-37-58" href="#__codelineno-37-58"></a>    <span class="p">)</span>
<a id="__codelineno-37-59" name="__codelineno-37-59" href="#__codelineno-37-59"></a><span class="p">)</span>
</code></pre></div>

</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<a id="__codelineno-38-2" name="__codelineno-38-2" href="#__codelineno-38-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">csv</span>
<a id="__codelineno-38-3" name="__codelineno-38-3" href="#__codelineno-38-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<a id="__codelineno-38-4" name="__codelineno-38-4" href="#__codelineno-38-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">flumine.controls.loggingcontrols</span><span class="w"> </span><span class="kn">import</span> <span class="n">LoggingControl</span>
<a id="__codelineno-38-5" name="__codelineno-38-5" href="#__codelineno-38-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">flumine.order.ordertype</span><span class="w"> </span><span class="kn">import</span> <span class="n">OrderTypes</span>
<a id="__codelineno-38-6" name="__codelineno-38-6" href="#__codelineno-38-6"></a>
<a id="__codelineno-38-7" name="__codelineno-38-7" href="#__codelineno-38-7"></a><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<a id="__codelineno-38-8" name="__codelineno-38-8" href="#__codelineno-38-8"></a>
<a id="__codelineno-38-9" name="__codelineno-38-9" href="#__codelineno-38-9"></a><span class="n">FIELDNAMES</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-38-10" name="__codelineno-38-10" href="#__codelineno-38-10"></a>    <span class="s2">&quot;bet_id&quot;</span><span class="p">,</span>
<a id="__codelineno-38-11" name="__codelineno-38-11" href="#__codelineno-38-11"></a>    <span class="s2">&quot;strategy_name&quot;</span><span class="p">,</span>
<a id="__codelineno-38-12" name="__codelineno-38-12" href="#__codelineno-38-12"></a>    <span class="s2">&quot;market_id&quot;</span><span class="p">,</span>
<a id="__codelineno-38-13" name="__codelineno-38-13" href="#__codelineno-38-13"></a>    <span class="s2">&quot;selection_id&quot;</span><span class="p">,</span>
<a id="__codelineno-38-14" name="__codelineno-38-14" href="#__codelineno-38-14"></a>    <span class="s2">&quot;trade_id&quot;</span><span class="p">,</span>
<a id="__codelineno-38-15" name="__codelineno-38-15" href="#__codelineno-38-15"></a>    <span class="s2">&quot;date_time_placed&quot;</span><span class="p">,</span>
<a id="__codelineno-38-16" name="__codelineno-38-16" href="#__codelineno-38-16"></a>    <span class="s2">&quot;price&quot;</span><span class="p">,</span>
<a id="__codelineno-38-17" name="__codelineno-38-17" href="#__codelineno-38-17"></a>    <span class="s2">&quot;price_matched&quot;</span><span class="p">,</span>
<a id="__codelineno-38-18" name="__codelineno-38-18" href="#__codelineno-38-18"></a>    <span class="s2">&quot;size&quot;</span><span class="p">,</span>
<a id="__codelineno-38-19" name="__codelineno-38-19" href="#__codelineno-38-19"></a>    <span class="s2">&quot;size_matched&quot;</span><span class="p">,</span>
<a id="__codelineno-38-20" name="__codelineno-38-20" href="#__codelineno-38-20"></a>    <span class="s2">&quot;profit&quot;</span><span class="p">,</span>
<a id="__codelineno-38-21" name="__codelineno-38-21" href="#__codelineno-38-21"></a>    <span class="s2">&quot;side&quot;</span><span class="p">,</span>
<a id="__codelineno-38-22" name="__codelineno-38-22" href="#__codelineno-38-22"></a>    <span class="s2">&quot;elapsed_seconds_executable&quot;</span><span class="p">,</span>
<a id="__codelineno-38-23" name="__codelineno-38-23" href="#__codelineno-38-23"></a>    <span class="s2">&quot;order_status&quot;</span><span class="p">,</span>
<a id="__codelineno-38-24" name="__codelineno-38-24" href="#__codelineno-38-24"></a>    <span class="s2">&quot;market_note&quot;</span><span class="p">,</span>
<a id="__codelineno-38-25" name="__codelineno-38-25" href="#__codelineno-38-25"></a>    <span class="s2">&quot;trade_notes&quot;</span><span class="p">,</span>
<a id="__codelineno-38-26" name="__codelineno-38-26" href="#__codelineno-38-26"></a>    <span class="s2">&quot;order_notes&quot;</span><span class="p">,</span>
<a id="__codelineno-38-27" name="__codelineno-38-27" href="#__codelineno-38-27"></a><span class="p">]</span>
<a id="__codelineno-38-28" name="__codelineno-38-28" href="#__codelineno-38-28"></a>
<a id="__codelineno-38-29" name="__codelineno-38-29" href="#__codelineno-38-29"></a>
<a id="__codelineno-38-30" name="__codelineno-38-30" href="#__codelineno-38-30"></a><span class="k">class</span><span class="w"> </span><span class="nc">LiveLoggingControl</span><span class="p">(</span><span class="n">LoggingControl</span><span class="p">):</span>
<a id="__codelineno-38-31" name="__codelineno-38-31" href="#__codelineno-38-31"></a>    <span class="n">NAME</span> <span class="o">=</span> <span class="s2">&quot;BACKTEST_LOGGING_CONTROL&quot;</span>
<a id="__codelineno-38-32" name="__codelineno-38-32" href="#__codelineno-38-32"></a>
<a id="__codelineno-38-33" name="__codelineno-38-33" href="#__codelineno-38-33"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-38-34" name="__codelineno-38-34" href="#__codelineno-38-34"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">LiveLoggingControl</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-38-35" name="__codelineno-38-35" href="#__codelineno-38-35"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_setup</span><span class="p">()</span>
<a id="__codelineno-38-36" name="__codelineno-38-36" href="#__codelineno-38-36"></a>
<a id="__codelineno-38-37" name="__codelineno-38-37" href="#__codelineno-38-37"></a>    <span class="c1"># Changed file path and checks if the file orders_hta_4.csv already exists, if it doens&#39;t then create it</span>
<a id="__codelineno-38-38" name="__codelineno-38-38" href="#__codelineno-38-38"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-38-39" name="__codelineno-38-39" href="#__codelineno-38-39"></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;orders_hta_4.csv&quot;</span><span class="p">):</span>
<a id="__codelineno-38-40" name="__codelineno-38-40" href="#__codelineno-38-40"></a>            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Results file exists&quot;</span><span class="p">)</span>
<a id="__codelineno-38-41" name="__codelineno-38-41" href="#__codelineno-38-41"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-38-42" name="__codelineno-38-42" href="#__codelineno-38-42"></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;orders_hta_4.csv&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">m</span><span class="p">:</span>
<a id="__codelineno-38-43" name="__codelineno-38-43" href="#__codelineno-38-43"></a>                <span class="n">csv_writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictWriter</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">fieldnames</span><span class="o">=</span><span class="n">FIELDNAMES</span><span class="p">)</span>
<a id="__codelineno-38-44" name="__codelineno-38-44" href="#__codelineno-38-44"></a>                <span class="n">csv_writer</span><span class="o">.</span><span class="n">writeheader</span><span class="p">()</span>
<a id="__codelineno-38-45" name="__codelineno-38-45" href="#__codelineno-38-45"></a>
<a id="__codelineno-38-46" name="__codelineno-38-46" href="#__codelineno-38-46"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_process_cleared_orders_meta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
<a id="__codelineno-38-47" name="__codelineno-38-47" href="#__codelineno-38-47"></a>        <span class="n">orders</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">event</span>
<a id="__codelineno-38-48" name="__codelineno-38-48" href="#__codelineno-38-48"></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;orders_hta_4.csv&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">m</span><span class="p">:</span>
<a id="__codelineno-38-49" name="__codelineno-38-49" href="#__codelineno-38-49"></a>            <span class="k">for</span> <span class="n">order</span> <span class="ow">in</span> <span class="n">orders</span><span class="p">:</span>
<a id="__codelineno-38-50" name="__codelineno-38-50" href="#__codelineno-38-50"></a>                <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">order_type</span><span class="o">.</span><span class="n">ORDER_TYPE</span> <span class="o">==</span> <span class="n">OrderTypes</span><span class="o">.</span><span class="n">LIMIT</span><span class="p">:</span>
<a id="__codelineno-38-51" name="__codelineno-38-51" href="#__codelineno-38-51"></a>                    <span class="n">size</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">order_type</span><span class="o">.</span><span class="n">size</span>
<a id="__codelineno-38-52" name="__codelineno-38-52" href="#__codelineno-38-52"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-38-53" name="__codelineno-38-53" href="#__codelineno-38-53"></a>                    <span class="n">size</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">order_type</span><span class="o">.</span><span class="n">liability</span>
<a id="__codelineno-38-54" name="__codelineno-38-54" href="#__codelineno-38-54"></a>                <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">order_type</span><span class="o">.</span><span class="n">ORDER_TYPE</span> <span class="o">==</span> <span class="n">OrderTypes</span><span class="o">.</span><span class="n">MARKET_ON_CLOSE</span><span class="p">:</span>
<a id="__codelineno-38-55" name="__codelineno-38-55" href="#__codelineno-38-55"></a>                    <span class="n">price</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-38-56" name="__codelineno-38-56" href="#__codelineno-38-56"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-38-57" name="__codelineno-38-57" href="#__codelineno-38-57"></a>                    <span class="n">price</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">order_type</span><span class="o">.</span><span class="n">price</span>
<a id="__codelineno-38-58" name="__codelineno-38-58" href="#__codelineno-38-58"></a>                <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-38-59" name="__codelineno-38-59" href="#__codelineno-38-59"></a>                    <span class="n">order_data</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-38-60" name="__codelineno-38-60" href="#__codelineno-38-60"></a>                        <span class="s2">&quot;bet_id&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">bet_id</span><span class="p">,</span>
<a id="__codelineno-38-61" name="__codelineno-38-61" href="#__codelineno-38-61"></a>                        <span class="s2">&quot;strategy_name&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">trade</span><span class="o">.</span><span class="n">strategy</span><span class="p">,</span>
<a id="__codelineno-38-62" name="__codelineno-38-62" href="#__codelineno-38-62"></a>                        <span class="s2">&quot;market_id&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">market_id</span><span class="p">,</span>
<a id="__codelineno-38-63" name="__codelineno-38-63" href="#__codelineno-38-63"></a>                        <span class="s2">&quot;selection_id&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">selection_id</span><span class="p">,</span>
<a id="__codelineno-38-64" name="__codelineno-38-64" href="#__codelineno-38-64"></a>                        <span class="s2">&quot;trade_id&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">trade</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
<a id="__codelineno-38-65" name="__codelineno-38-65" href="#__codelineno-38-65"></a>                        <span class="s2">&quot;date_time_placed&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">responses</span><span class="o">.</span><span class="n">date_time_placed</span><span class="p">,</span>
<a id="__codelineno-38-66" name="__codelineno-38-66" href="#__codelineno-38-66"></a>                        <span class="s2">&quot;price&quot;</span><span class="p">:</span> <span class="n">price</span><span class="p">,</span>
<a id="__codelineno-38-67" name="__codelineno-38-67" href="#__codelineno-38-67"></a>                        <span class="s2">&quot;price_matched&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">average_price_matched</span><span class="p">,</span>
<a id="__codelineno-38-68" name="__codelineno-38-68" href="#__codelineno-38-68"></a>                        <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="n">size</span><span class="p">,</span>
<a id="__codelineno-38-69" name="__codelineno-38-69" href="#__codelineno-38-69"></a>                        <span class="s2">&quot;size_matched&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">size_matched</span><span class="p">,</span>
<a id="__codelineno-38-70" name="__codelineno-38-70" href="#__codelineno-38-70"></a>                        <span class="s2">&quot;profit&quot;</span><span class="p">:</span> <span class="mi">0</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">order</span><span class="o">.</span><span class="n">cleared_order</span> <span class="k">else</span> <span class="n">order</span><span class="o">.</span><span class="n">cleared_order</span><span class="o">.</span><span class="n">profit</span><span class="p">,</span>
<a id="__codelineno-38-71" name="__codelineno-38-71" href="#__codelineno-38-71"></a>                        <span class="s2">&quot;side&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">side</span><span class="p">,</span>
<a id="__codelineno-38-72" name="__codelineno-38-72" href="#__codelineno-38-72"></a>                        <span class="s2">&quot;elapsed_seconds_executable&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">elapsed_seconds_executable</span><span class="p">,</span>
<a id="__codelineno-38-73" name="__codelineno-38-73" href="#__codelineno-38-73"></a>                        <span class="s2">&quot;order_status&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
<a id="__codelineno-38-74" name="__codelineno-38-74" href="#__codelineno-38-74"></a>                        <span class="s2">&quot;market_note&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">trade</span><span class="o">.</span><span class="n">market_notes</span><span class="p">,</span>
<a id="__codelineno-38-75" name="__codelineno-38-75" href="#__codelineno-38-75"></a>                        <span class="s2">&quot;trade_notes&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">trade</span><span class="o">.</span><span class="n">notes_str</span><span class="p">,</span>
<a id="__codelineno-38-76" name="__codelineno-38-76" href="#__codelineno-38-76"></a>                        <span class="s2">&quot;order_notes&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">notes_str</span><span class="p">,</span>
<a id="__codelineno-38-77" name="__codelineno-38-77" href="#__codelineno-38-77"></a>                    <span class="p">}</span>
<a id="__codelineno-38-78" name="__codelineno-38-78" href="#__codelineno-38-78"></a>                    <span class="n">csv_writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictWriter</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">fieldnames</span><span class="o">=</span><span class="n">FIELDNAMES</span><span class="p">)</span>
<a id="__codelineno-38-79" name="__codelineno-38-79" href="#__codelineno-38-79"></a>                    <span class="n">csv_writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">order_data</span><span class="p">)</span>
<a id="__codelineno-38-80" name="__codelineno-38-80" href="#__codelineno-38-80"></a>                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-38-81" name="__codelineno-38-81" href="#__codelineno-38-81"></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-38-82" name="__codelineno-38-82" href="#__codelineno-38-82"></a>                        <span class="s2">&quot;_process_cleared_orders_meta: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">,</span>
<a id="__codelineno-38-83" name="__codelineno-38-83" href="#__codelineno-38-83"></a>                        <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;order&quot;</span><span class="p">:</span> <span class="n">order</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">e</span><span class="p">},</span>
<a id="__codelineno-38-84" name="__codelineno-38-84" href="#__codelineno-38-84"></a>                    <span class="p">)</span>
<a id="__codelineno-38-85" name="__codelineno-38-85" href="#__codelineno-38-85"></a>
<a id="__codelineno-38-86" name="__codelineno-38-86" href="#__codelineno-38-86"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Orders updated&quot;</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;order_count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">orders</span><span class="p">)})</span>
<a id="__codelineno-38-87" name="__codelineno-38-87" href="#__codelineno-38-87"></a>
<a id="__codelineno-38-88" name="__codelineno-38-88" href="#__codelineno-38-88"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_process_cleared_markets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
<a id="__codelineno-38-89" name="__codelineno-38-89" href="#__codelineno-38-89"></a>        <span class="n">cleared_markets</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">event</span>
<a id="__codelineno-38-90" name="__codelineno-38-90" href="#__codelineno-38-90"></a>        <span class="k">for</span> <span class="n">cleared_market</span> <span class="ow">in</span> <span class="n">cleared_markets</span><span class="o">.</span><span class="n">orders</span><span class="p">:</span>
<a id="__codelineno-38-91" name="__codelineno-38-91" href="#__codelineno-38-91"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-38-92" name="__codelineno-38-92" href="#__codelineno-38-92"></a>                <span class="s2">&quot;Cleared market&quot;</span><span class="p">,</span>
<a id="__codelineno-38-93" name="__codelineno-38-93" href="#__codelineno-38-93"></a>                <span class="n">extra</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-38-94" name="__codelineno-38-94" href="#__codelineno-38-94"></a>                    <span class="s2">&quot;market_id&quot;</span><span class="p">:</span> <span class="n">cleared_market</span><span class="o">.</span><span class="n">market_id</span><span class="p">,</span>
<a id="__codelineno-38-95" name="__codelineno-38-95" href="#__codelineno-38-95"></a>                    <span class="s2">&quot;bet_count&quot;</span><span class="p">:</span> <span class="n">cleared_market</span><span class="o">.</span><span class="n">bet_count</span><span class="p">,</span>
<a id="__codelineno-38-96" name="__codelineno-38-96" href="#__codelineno-38-96"></a>                    <span class="s2">&quot;profit&quot;</span><span class="p">:</span> <span class="n">cleared_market</span><span class="o">.</span><span class="n">profit</span><span class="p">,</span>
<a id="__codelineno-38-97" name="__codelineno-38-97" href="#__codelineno-38-97"></a>                    <span class="s2">&quot;commission&quot;</span><span class="p">:</span> <span class="n">cleared_market</span><span class="o">.</span><span class="n">commission</span><span class="p">,</span>
<a id="__codelineno-38-98" name="__codelineno-38-98" href="#__codelineno-38-98"></a>                <span class="p">},</span>
<a id="__codelineno-38-99" name="__codelineno-38-99" href="#__codelineno-38-99"></a>            <span class="p">)</span>
<a id="__codelineno-38-100" name="__codelineno-38-100" href="#__codelineno-38-100"></a>
<a id="__codelineno-38-101" name="__codelineno-38-101" href="#__codelineno-38-101"></a><span class="n">framework</span><span class="o">.</span><span class="n">add_logging_control</span><span class="p">(</span>
<a id="__codelineno-38-102" name="__codelineno-38-102" href="#__codelineno-38-102"></a>    <span class="n">LiveLoggingControl</span><span class="p">()</span>
<a id="__codelineno-38-103" name="__codelineno-38-103" href="#__codelineno-38-103"></a><span class="p">)</span>
</code></pre></div>

</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><a id="__codelineno-39-1" name="__codelineno-39-1" href="#__codelineno-39-1"></a><span class="n">framework</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</code></pre></div>

</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<hr />
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="conclusion-and-next-steps">Conclusion and next steps</h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Boom! We now have an automated script that will downloads all the data we need in the morning, generates a set of predictions, place flat stakes bets, logs all bets and switches itself off at the end of the day. All we need to do is hit play in the morning!</p>
<p>We have now written code automation code for three different strategies, however we haven't actually backtested any of our strategies or models yet. So for the final part of the How to Automate series we will be writing code to <a href="">How to simulate the Exchange to backtest and optimise our strategies</a>. Make sure not to miss it as this is where I believe the sauce is made (not that I have made significant sauce).</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="complete-code">Complete code</h4>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Run the code from your ide by using py <code>&lt;filename&gt;</code>.py, making sure you amend the path to point to your input data.</p>
<p><a href="https://github.com/betfair-down-under/autoHubTutorials/tree/master">Download from Github</a>
</filename></p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">joblib</span><span class="w"> </span><span class="kn">import</span> <span class="n">load</span>
<a id="__codelineno-40-2" name="__codelineno-40-2" href="#__codelineno-40-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<a id="__codelineno-40-3" name="__codelineno-40-3" href="#__codelineno-40-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<a id="__codelineno-40-4" name="__codelineno-40-4" href="#__codelineno-40-4"></a>
<a id="__codelineno-40-5" name="__codelineno-40-5" href="#__codelineno-40-5"></a><span class="c1"># Allow imports from src folder</span>
<a id="__codelineno-40-6" name="__codelineno-40-6" href="#__codelineno-40-6"></a><span class="n">module_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;../src&#39;</span><span class="p">))</span>
<a id="__codelineno-40-7" name="__codelineno-40-7" href="#__codelineno-40-7"></a><span class="k">if</span> <span class="n">module_path</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
<a id="__codelineno-40-8" name="__codelineno-40-8" href="#__codelineno-40-8"></a>    <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">module_path</span><span class="p">)</span>
<a id="__codelineno-40-9" name="__codelineno-40-9" href="#__codelineno-40-9"></a>
<a id="__codelineno-40-10" name="__codelineno-40-10" href="#__codelineno-40-10"></a><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<a id="__codelineno-40-11" name="__codelineno-40-11" href="#__codelineno-40-11"></a><span class="kn">from</span><span class="w"> </span><span class="nn">dateutil.relativedelta</span><span class="w"> </span><span class="kn">import</span> <span class="n">relativedelta</span>
<a id="__codelineno-40-12" name="__codelineno-40-12" href="#__codelineno-40-12"></a><span class="kn">from</span><span class="w"> </span><span class="nn">dateutil</span><span class="w"> </span><span class="kn">import</span> <span class="n">tz</span>
<a id="__codelineno-40-13" name="__codelineno-40-13" href="#__codelineno-40-13"></a><span class="kn">from</span><span class="w"> </span><span class="nn">pandas.tseries.offsets</span><span class="w"> </span><span class="kn">import</span> <span class="n">MonthEnd</span>
<a id="__codelineno-40-14" name="__codelineno-40-14" href="#__codelineno-40-14"></a><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">MinMaxScaler</span>
<a id="__codelineno-40-15" name="__codelineno-40-15" href="#__codelineno-40-15"></a><span class="kn">import</span><span class="w"> </span><span class="nn">itertools</span>
<a id="__codelineno-40-16" name="__codelineno-40-16" href="#__codelineno-40-16"></a>
<a id="__codelineno-40-17" name="__codelineno-40-17" href="#__codelineno-40-17"></a><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<a id="__codelineno-40-18" name="__codelineno-40-18" href="#__codelineno-40-18"></a><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<a id="__codelineno-40-19" name="__codelineno-40-19" href="#__codelineno-40-19"></a><span class="kn">from</span><span class="w"> </span><span class="nn">nltk.tokenize</span><span class="w"> </span><span class="kn">import</span> <span class="n">regexp_tokenize</span>
<a id="__codelineno-40-20" name="__codelineno-40-20" href="#__codelineno-40-20"></a>
<a id="__codelineno-40-21" name="__codelineno-40-21" href="#__codelineno-40-21"></a><span class="c1"># settings to display all columns</span>
<a id="__codelineno-40-22" name="__codelineno-40-22" href="#__codelineno-40-22"></a><span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s2">&quot;display.max_columns&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-40-23" name="__codelineno-40-23" href="#__codelineno-40-23"></a>
<a id="__codelineno-40-24" name="__codelineno-40-24" href="#__codelineno-40-24"></a><span class="kn">import</span><span class="w"> </span><span class="nn">fasttrack</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ft</span>
<a id="__codelineno-40-25" name="__codelineno-40-25" href="#__codelineno-40-25"></a>
<a id="__codelineno-40-26" name="__codelineno-40-26" href="#__codelineno-40-26"></a><span class="kn">from</span><span class="w"> </span><span class="nn">dotenv</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_dotenv</span>
<a id="__codelineno-40-27" name="__codelineno-40-27" href="#__codelineno-40-27"></a><span class="n">load_dotenv</span><span class="p">()</span>
<a id="__codelineno-40-28" name="__codelineno-40-28" href="#__codelineno-40-28"></a>
<a id="__codelineno-40-29" name="__codelineno-40-29" href="#__codelineno-40-29"></a><span class="c1"># Import libraries for logging in</span>
<a id="__codelineno-40-30" name="__codelineno-40-30" href="#__codelineno-40-30"></a><span class="kn">import</span><span class="w"> </span><span class="nn">betfairlightweight</span>
<a id="__codelineno-40-31" name="__codelineno-40-31" href="#__codelineno-40-31"></a><span class="kn">from</span><span class="w"> </span><span class="nn">flumine</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flumine</span><span class="p">,</span> <span class="n">clients</span>
<a id="__codelineno-40-32" name="__codelineno-40-32" href="#__codelineno-40-32"></a><span class="c1"># Import libraries and logging</span>
<a id="__codelineno-40-33" name="__codelineno-40-33" href="#__codelineno-40-33"></a><span class="kn">from</span><span class="w"> </span><span class="nn">flumine</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseStrategy</span> 
<a id="__codelineno-40-34" name="__codelineno-40-34" href="#__codelineno-40-34"></a><span class="kn">from</span><span class="w"> </span><span class="nn">flumine.order.trade</span><span class="w"> </span><span class="kn">import</span> <span class="n">Trade</span>
<a id="__codelineno-40-35" name="__codelineno-40-35" href="#__codelineno-40-35"></a><span class="kn">from</span><span class="w"> </span><span class="nn">flumine.order.order</span><span class="w"> </span><span class="kn">import</span> <span class="n">LimitOrder</span>
<a id="__codelineno-40-36" name="__codelineno-40-36" href="#__codelineno-40-36"></a><span class="kn">from</span><span class="w"> </span><span class="nn">flumine.markets.market</span><span class="w"> </span><span class="kn">import</span> <span class="n">Market</span>
<a id="__codelineno-40-37" name="__codelineno-40-37" href="#__codelineno-40-37"></a><span class="kn">from</span><span class="w"> </span><span class="nn">betfairlightweight.filters</span><span class="w"> </span><span class="kn">import</span> <span class="n">streaming_market_filter</span>
<a id="__codelineno-40-38" name="__codelineno-40-38" href="#__codelineno-40-38"></a><span class="kn">from</span><span class="w"> </span><span class="nn">betfairlightweight.resources</span><span class="w"> </span><span class="kn">import</span> <span class="n">MarketBook</span>
<a id="__codelineno-40-39" name="__codelineno-40-39" href="#__codelineno-40-39"></a><span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<a id="__codelineno-40-40" name="__codelineno-40-40" href="#__codelineno-40-40"></a><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<a id="__codelineno-40-41" name="__codelineno-40-41" href="#__codelineno-40-41"></a><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<a id="__codelineno-40-42" name="__codelineno-40-42" href="#__codelineno-40-42"></a><span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span>
<a id="__codelineno-40-43" name="__codelineno-40-43" href="#__codelineno-40-43"></a><span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<a id="__codelineno-40-44" name="__codelineno-40-44" href="#__codelineno-40-44"></a><span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;how_to_automate_4.log&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1">:</span><span class="si">%(levelname)s</span><span class="s1">:</span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-40-45" name="__codelineno-40-45" href="#__codelineno-40-45"></a>
<a id="__codelineno-40-46" name="__codelineno-40-46" href="#__codelineno-40-46"></a><span class="c1"># import logging</span>
<a id="__codelineno-40-47" name="__codelineno-40-47" href="#__codelineno-40-47"></a><span class="kn">from</span><span class="w"> </span><span class="nn">flumine.worker</span><span class="w"> </span><span class="kn">import</span> <span class="n">BackgroundWorker</span>
<a id="__codelineno-40-48" name="__codelineno-40-48" href="#__codelineno-40-48"></a><span class="kn">from</span><span class="w"> </span><span class="nn">flumine.events.events</span><span class="w"> </span><span class="kn">import</span> <span class="n">TerminationEvent</span>
<a id="__codelineno-40-49" name="__codelineno-40-49" href="#__codelineno-40-49"></a>
<a id="__codelineno-40-50" name="__codelineno-40-50" href="#__codelineno-40-50"></a><span class="kn">import</span><span class="w"> </span><span class="nn">csv</span>
<a id="__codelineno-40-51" name="__codelineno-40-51" href="#__codelineno-40-51"></a><span class="kn">from</span><span class="w"> </span><span class="nn">flumine.controls.loggingcontrols</span><span class="w"> </span><span class="kn">import</span> <span class="n">LoggingControl</span>
<a id="__codelineno-40-52" name="__codelineno-40-52" href="#__codelineno-40-52"></a><span class="kn">from</span><span class="w"> </span><span class="nn">flumine.order.ordertype</span><span class="w"> </span><span class="kn">import</span> <span class="n">OrderTypes</span>
<a id="__codelineno-40-53" name="__codelineno-40-53" href="#__codelineno-40-53"></a>
<a id="__codelineno-40-54" name="__codelineno-40-54" href="#__codelineno-40-54"></a><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<a id="__codelineno-40-55" name="__codelineno-40-55" href="#__codelineno-40-55"></a>
<a id="__codelineno-40-56" name="__codelineno-40-56" href="#__codelineno-40-56"></a><span class="n">brunos_model</span> <span class="o">=</span> <span class="n">load</span><span class="p">(</span><span class="s1">&#39;logistic_regression.joblib&#39;</span><span class="p">)</span>
<a id="__codelineno-40-57" name="__codelineno-40-57" href="#__codelineno-40-57"></a><span class="n">brunos_model</span>
<a id="__codelineno-40-58" name="__codelineno-40-58" href="#__codelineno-40-58"></a>
<a id="__codelineno-40-59" name="__codelineno-40-59" href="#__codelineno-40-59"></a><span class="c1"># Validate FastTrack API connection</span>
<a id="__codelineno-40-60" name="__codelineno-40-60" href="#__codelineno-40-60"></a><span class="n">api_key</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;FAST_TRACK_API_KEY&#39;</span><span class="p">,)</span>
<a id="__codelineno-40-61" name="__codelineno-40-61" href="#__codelineno-40-61"></a><span class="n">client</span> <span class="o">=</span> <span class="n">ft</span><span class="o">.</span><span class="n">Fasttrack</span><span class="p">(</span><span class="n">api_key</span><span class="p">)</span>
<a id="__codelineno-40-62" name="__codelineno-40-62" href="#__codelineno-40-62"></a><span class="n">track_codes</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">listTracks</span><span class="p">()</span>
<a id="__codelineno-40-63" name="__codelineno-40-63" href="#__codelineno-40-63"></a>
<a id="__codelineno-40-64" name="__codelineno-40-64" href="#__codelineno-40-64"></a><span class="c1"># Import race data excluding NZ races</span>
<a id="__codelineno-40-65" name="__codelineno-40-65" href="#__codelineno-40-65"></a><span class="n">au_tracks_filter</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">track_codes</span><span class="p">[</span><span class="n">track_codes</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;NZ&#39;</span><span class="p">][</span><span class="s1">&#39;track_code&#39;</span><span class="p">])</span>
<a id="__codelineno-40-66" name="__codelineno-40-66" href="#__codelineno-40-66"></a>
<a id="__codelineno-40-67" name="__codelineno-40-67" href="#__codelineno-40-67"></a><span class="c1"># Time window to import data</span>
<a id="__codelineno-40-68" name="__codelineno-40-68" href="#__codelineno-40-68"></a><span class="c1"># First day of the month 46 months back from now</span>
<a id="__codelineno-40-69" name="__codelineno-40-69" href="#__codelineno-40-69"></a><span class="n">date_from</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span> <span class="o">-</span> <span class="n">relativedelta</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="mi">46</span><span class="p">))</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">day</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-40-70" name="__codelineno-40-70" href="#__codelineno-40-70"></a><span class="c1"># First day of previous month</span>
<a id="__codelineno-40-71" name="__codelineno-40-71" href="#__codelineno-40-71"></a><span class="n">date_to</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span> <span class="o">-</span> <span class="n">relativedelta</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">day</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-40-72" name="__codelineno-40-72" href="#__codelineno-40-72"></a>
<a id="__codelineno-40-73" name="__codelineno-40-73" href="#__codelineno-40-73"></a><span class="c1"># Dataframes to populate data with</span>
<a id="__codelineno-40-74" name="__codelineno-40-74" href="#__codelineno-40-74"></a><span class="n">race_details</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
<a id="__codelineno-40-75" name="__codelineno-40-75" href="#__codelineno-40-75"></a><span class="n">dog_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
<a id="__codelineno-40-76" name="__codelineno-40-76" href="#__codelineno-40-76"></a>
<a id="__codelineno-40-77" name="__codelineno-40-77" href="#__codelineno-40-77"></a><span class="c1"># For each month, either fetch data from API or use local CSV file if we already have downloaded it</span>
<a id="__codelineno-40-78" name="__codelineno-40-78" href="#__codelineno-40-78"></a><span class="k">for</span> <span class="n">start</span> <span class="ow">in</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">date_from</span><span class="p">,</span> <span class="n">date_to</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;MS&#39;</span><span class="p">):</span>
<a id="__codelineno-40-79" name="__codelineno-40-79" href="#__codelineno-40-79"></a>    <span class="n">start_date</span> <span class="o">=</span> <span class="n">start</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-40-80" name="__codelineno-40-80" href="#__codelineno-40-80"></a>    <span class="n">end_date</span> <span class="o">=</span> <span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="n">MonthEnd</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-40-81" name="__codelineno-40-81" href="#__codelineno-40-81"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-40-82" name="__codelineno-40-82" href="#__codelineno-40-82"></a>        <span class="n">filename_races</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;FT_AU_RACES_</span><span class="si">{</span><span class="n">start_date</span><span class="si">}</span><span class="s1">.csv&#39;</span>
<a id="__codelineno-40-83" name="__codelineno-40-83" href="#__codelineno-40-83"></a>        <span class="n">filename_dogs</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;FT_AU_DOGS_</span><span class="si">{</span><span class="n">start_date</span><span class="si">}</span><span class="s1">.csv&#39;</span>
<a id="__codelineno-40-84" name="__codelineno-40-84" href="#__codelineno-40-84"></a>
<a id="__codelineno-40-85" name="__codelineno-40-85" href="#__codelineno-40-85"></a>        <span class="n">filepath_races</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;../data/</span><span class="si">{</span><span class="n">filename_races</span><span class="si">}</span><span class="s1">&#39;</span>
<a id="__codelineno-40-86" name="__codelineno-40-86" href="#__codelineno-40-86"></a>        <span class="n">filepath_dogs</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;../data/</span><span class="si">{</span><span class="n">filename_dogs</span><span class="si">}</span><span class="s1">&#39;</span>
<a id="__codelineno-40-87" name="__codelineno-40-87" href="#__codelineno-40-87"></a>
<a id="__codelineno-40-88" name="__codelineno-40-88" href="#__codelineno-40-88"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Loading data from </span><span class="si">{</span><span class="n">start_date</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">end_date</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-40-89" name="__codelineno-40-89" href="#__codelineno-40-89"></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filepath_races</span><span class="p">):</span>
<a id="__codelineno-40-90" name="__codelineno-40-90" href="#__codelineno-40-90"></a>            <span class="c1"># Load local CSV file</span>
<a id="__codelineno-40-91" name="__codelineno-40-91" href="#__codelineno-40-91"></a>            <span class="n">month_race_details</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">filepath_races</span><span class="p">)</span> 
<a id="__codelineno-40-92" name="__codelineno-40-92" href="#__codelineno-40-92"></a>            <span class="n">month_dog_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">filepath_dogs</span><span class="p">)</span> 
<a id="__codelineno-40-93" name="__codelineno-40-93" href="#__codelineno-40-93"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-40-94" name="__codelineno-40-94" href="#__codelineno-40-94"></a>            <span class="c1"># Fetch data from API</span>
<a id="__codelineno-40-95" name="__codelineno-40-95" href="#__codelineno-40-95"></a>            <span class="n">month_race_details</span><span class="p">,</span> <span class="n">month_dog_results</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">getRaceResults</span><span class="p">(</span><span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">,</span> <span class="n">au_tracks_filter</span><span class="p">)</span>
<a id="__codelineno-40-96" name="__codelineno-40-96" href="#__codelineno-40-96"></a>            <span class="n">month_race_details</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">filepath_races</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-40-97" name="__codelineno-40-97" href="#__codelineno-40-97"></a>            <span class="n">month_dog_results</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">filepath_dogs</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-40-98" name="__codelineno-40-98" href="#__codelineno-40-98"></a>
<a id="__codelineno-40-99" name="__codelineno-40-99" href="#__codelineno-40-99"></a>        <span class="c1"># Combine monthly data</span>
<a id="__codelineno-40-100" name="__codelineno-40-100" href="#__codelineno-40-100"></a>        <span class="n">race_details</span> <span class="o">=</span> <span class="n">race_details</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">month_race_details</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-40-101" name="__codelineno-40-101" href="#__codelineno-40-101"></a>        <span class="n">dog_results</span> <span class="o">=</span> <span class="n">dog_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">month_dog_results</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-40-102" name="__codelineno-40-102" href="#__codelineno-40-102"></a>    <span class="k">except</span><span class="p">:</span>
<a id="__codelineno-40-103" name="__codelineno-40-103" href="#__codelineno-40-103"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Could not load data from </span><span class="si">{</span><span class="n">start_date</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">end_date</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-40-104" name="__codelineno-40-104" href="#__codelineno-40-104"></a>
<a id="__codelineno-40-105" name="__codelineno-40-105" href="#__codelineno-40-105"></a><span class="n">race_details</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span>
<a id="__codelineno-40-106" name="__codelineno-40-106" href="#__codelineno-40-106"></a>
<a id="__codelineno-40-107" name="__codelineno-40-107" href="#__codelineno-40-107"></a><span class="n">current_month_start_date</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">day</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-40-108" name="__codelineno-40-108" href="#__codelineno-40-108"></a><span class="n">current_month_end_date</span> <span class="o">=</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">day</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span> <span class="n">MonthEnd</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<a id="__codelineno-40-109" name="__codelineno-40-109" href="#__codelineno-40-109"></a><span class="n">current_month_end_date</span> <span class="o">=</span> <span class="p">(</span><span class="n">current_month_end_date</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="s1">&#39;1 day&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-40-110" name="__codelineno-40-110" href="#__codelineno-40-110"></a>
<a id="__codelineno-40-111" name="__codelineno-40-111" href="#__codelineno-40-111"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Start date: </span><span class="si">{</span><span class="n">current_month_start_date</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-40-112" name="__codelineno-40-112" href="#__codelineno-40-112"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;End Date: </span><span class="si">{</span><span class="n">current_month_end_date</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-40-113" name="__codelineno-40-113" href="#__codelineno-40-113"></a>
<a id="__codelineno-40-114" name="__codelineno-40-114" href="#__codelineno-40-114"></a><span class="c1"># Download data for races that have concluded this current month up untill today</span>
<a id="__codelineno-40-115" name="__codelineno-40-115" href="#__codelineno-40-115"></a><span class="c1"># Start and end dates for current month</span>
<a id="__codelineno-40-116" name="__codelineno-40-116" href="#__codelineno-40-116"></a><span class="n">current_month_start_date</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">day</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-40-117" name="__codelineno-40-117" href="#__codelineno-40-117"></a><span class="n">current_month_end_date</span> <span class="o">=</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">day</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span> <span class="n">MonthEnd</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<a id="__codelineno-40-118" name="__codelineno-40-118" href="#__codelineno-40-118"></a><span class="n">current_month_end_date</span> <span class="o">=</span> <span class="p">(</span><span class="n">current_month_end_date</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="s1">&#39;1 day&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-40-119" name="__codelineno-40-119" href="#__codelineno-40-119"></a>
<a id="__codelineno-40-120" name="__codelineno-40-120" href="#__codelineno-40-120"></a><span class="c1"># Files names </span>
<a id="__codelineno-40-121" name="__codelineno-40-121" href="#__codelineno-40-121"></a><span class="n">filename_races</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;FT_AU_RACES_</span><span class="si">{</span><span class="n">current_month_start_date</span><span class="si">}</span><span class="s1">.csv&#39;</span>
<a id="__codelineno-40-122" name="__codelineno-40-122" href="#__codelineno-40-122"></a><span class="n">filename_dogs</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;FT_AU_DOGS_</span><span class="si">{</span><span class="n">current_month_start_date</span><span class="si">}</span><span class="s1">.csv&#39;</span>
<a id="__codelineno-40-123" name="__codelineno-40-123" href="#__codelineno-40-123"></a><span class="c1"># Where to store files locally</span>
<a id="__codelineno-40-124" name="__codelineno-40-124" href="#__codelineno-40-124"></a><span class="n">filepath_races</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;../data/</span><span class="si">{</span><span class="n">filename_races</span><span class="si">}</span><span class="s1">&#39;</span>
<a id="__codelineno-40-125" name="__codelineno-40-125" href="#__codelineno-40-125"></a><span class="n">filepath_dogs</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;../data/</span><span class="si">{</span><span class="n">filename_dogs</span><span class="si">}</span><span class="s1">&#39;</span>
<a id="__codelineno-40-126" name="__codelineno-40-126" href="#__codelineno-40-126"></a>
<a id="__codelineno-40-127" name="__codelineno-40-127" href="#__codelineno-40-127"></a><span class="c1"># Fetch data from API</span>
<a id="__codelineno-40-128" name="__codelineno-40-128" href="#__codelineno-40-128"></a><span class="n">month_race_details</span><span class="p">,</span> <span class="n">month_dog_results</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">getRaceResults</span><span class="p">(</span><span class="n">current_month_start_date</span><span class="p">,</span> <span class="n">current_month_end_date</span><span class="p">,</span> <span class="n">au_tracks_filter</span><span class="p">)</span>
<a id="__codelineno-40-129" name="__codelineno-40-129" href="#__codelineno-40-129"></a>
<a id="__codelineno-40-130" name="__codelineno-40-130" href="#__codelineno-40-130"></a><span class="c1"># Save the files locally and replace any out of date fields</span>
<a id="__codelineno-40-131" name="__codelineno-40-131" href="#__codelineno-40-131"></a><span class="n">month_race_details</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">filepath_races</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-40-132" name="__codelineno-40-132" href="#__codelineno-40-132"></a><span class="n">month_dog_results</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">filepath_dogs</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-40-133" name="__codelineno-40-133" href="#__codelineno-40-133"></a>
<a id="__codelineno-40-134" name="__codelineno-40-134" href="#__codelineno-40-134"></a><span class="n">dog_results</span>
<a id="__codelineno-40-135" name="__codelineno-40-135" href="#__codelineno-40-135"></a>
<a id="__codelineno-40-136" name="__codelineno-40-136" href="#__codelineno-40-136"></a><span class="c1"># This is super important I have spent literally hours before I found out this was causing errors</span>
<a id="__codelineno-40-137" name="__codelineno-40-137" href="#__codelineno-40-137"></a><span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;@id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;@id&#39;</span><span class="p">])</span>
<a id="__codelineno-40-138" name="__codelineno-40-138" href="#__codelineno-40-138"></a>
<a id="__codelineno-40-139" name="__codelineno-40-139" href="#__codelineno-40-139"></a><span class="c1"># Append the extra data to our data frames </span>
<a id="__codelineno-40-140" name="__codelineno-40-140" href="#__codelineno-40-140"></a><span class="n">race_details</span> <span class="o">=</span> <span class="n">race_details</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">month_race_details</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-40-141" name="__codelineno-40-141" href="#__codelineno-40-141"></a><span class="n">dog_results</span> <span class="o">=</span> <span class="n">dog_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">month_dog_results</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-40-142" name="__codelineno-40-142" href="#__codelineno-40-142"></a>
<a id="__codelineno-40-143" name="__codelineno-40-143" href="#__codelineno-40-143"></a><span class="c1"># Download the data for todays races</span>
<a id="__codelineno-40-144" name="__codelineno-40-144" href="#__codelineno-40-144"></a><span class="n">todays_date</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-40-145" name="__codelineno-40-145" href="#__codelineno-40-145"></a><span class="n">todays_races</span><span class="p">,</span> <span class="n">todays_dogs</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">getFullFormat</span><span class="p">(</span><span class="n">dt</span><span class="o">=</span> <span class="n">todays_date</span><span class="p">,</span> <span class="n">tracks</span> <span class="o">=</span> <span class="n">au_tracks_filter</span><span class="p">)</span>
<a id="__codelineno-40-146" name="__codelineno-40-146" href="#__codelineno-40-146"></a>
<a id="__codelineno-40-147" name="__codelineno-40-147" href="#__codelineno-40-147"></a><span class="c1"># display is for ipython notebooks only</span>
<a id="__codelineno-40-148" name="__codelineno-40-148" href="#__codelineno-40-148"></a><span class="c1"># display(todays_races.head(1), todays_dogs.head(1))</span>
<a id="__codelineno-40-149" name="__codelineno-40-149" href="#__codelineno-40-149"></a>
<a id="__codelineno-40-150" name="__codelineno-40-150" href="#__codelineno-40-150"></a><span class="c1"># It seems that the todays_races dataframe doesn&#39;t have the date column, so let&#39;s add that on</span>
<a id="__codelineno-40-151" name="__codelineno-40-151" href="#__codelineno-40-151"></a><span class="n">todays_races</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> %b %y&#39;</span><span class="p">)</span>
<a id="__codelineno-40-152" name="__codelineno-40-152" href="#__codelineno-40-152"></a><span class="n">todays_races</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-40-153" name="__codelineno-40-153" href="#__codelineno-40-153"></a>
<a id="__codelineno-40-154" name="__codelineno-40-154" href="#__codelineno-40-154"></a><span class="c1"># It also seems that in todays_dogs dataframe Box is labeled as RaceBox instead, so let&#39;s rename it</span>
<a id="__codelineno-40-155" name="__codelineno-40-155" href="#__codelineno-40-155"></a><span class="c1"># We can also see that there are some specific dogs that have &quot;Res.&quot; as a suffix of their name, i.e. they are reserve dogs,</span>
<a id="__codelineno-40-156" name="__codelineno-40-156" href="#__codelineno-40-156"></a><span class="c1"># We will treat this later</span>
<a id="__codelineno-40-157" name="__codelineno-40-157" href="#__codelineno-40-157"></a><span class="n">todays_dogs</span> <span class="o">=</span> <span class="n">todays_dogs</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;RaceBox&quot;</span><span class="p">:</span><span class="s2">&quot;Box&quot;</span><span class="p">})</span>
<a id="__codelineno-40-158" name="__codelineno-40-158" href="#__codelineno-40-158"></a><span class="n">todays_dogs</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a id="__codelineno-40-159" name="__codelineno-40-159" href="#__codelineno-40-159"></a>
<a id="__codelineno-40-160" name="__codelineno-40-160" href="#__codelineno-40-160"></a><span class="c1"># Appending todays data to this months data</span>
<a id="__codelineno-40-161" name="__codelineno-40-161" href="#__codelineno-40-161"></a><span class="n">month_dog_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">month_dog_results</span><span class="p">,</span><span class="n">todays_dogs</span><span class="p">],</span><span class="n">join</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">)[</span><span class="n">month_dog_results</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
<a id="__codelineno-40-162" name="__codelineno-40-162" href="#__codelineno-40-162"></a><span class="n">month_race_details</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">month_race_details</span><span class="p">,</span><span class="n">todays_races</span><span class="p">],</span><span class="n">join</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">)[</span><span class="n">month_race_details</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
<a id="__codelineno-40-163" name="__codelineno-40-163" href="#__codelineno-40-163"></a>
<a id="__codelineno-40-164" name="__codelineno-40-164" href="#__codelineno-40-164"></a><span class="c1"># Appending this months data to the rest of our historical data</span>
<a id="__codelineno-40-165" name="__codelineno-40-165" href="#__codelineno-40-165"></a><span class="n">race_details</span> <span class="o">=</span> <span class="n">race_details</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">month_race_details</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-40-166" name="__codelineno-40-166" href="#__codelineno-40-166"></a><span class="n">dog_results</span> <span class="o">=</span> <span class="n">dog_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">month_dog_results</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-40-167" name="__codelineno-40-167" href="#__codelineno-40-167"></a>
<a id="__codelineno-40-168" name="__codelineno-40-168" href="#__codelineno-40-168"></a><span class="n">race_details</span>
<a id="__codelineno-40-169" name="__codelineno-40-169" href="#__codelineno-40-169"></a>
<a id="__codelineno-40-170" name="__codelineno-40-170" href="#__codelineno-40-170"></a><span class="c1">## Cleanse and normalise the data</span>
<a id="__codelineno-40-171" name="__codelineno-40-171" href="#__codelineno-40-171"></a><span class="c1"># Clean up the race dataset</span>
<a id="__codelineno-40-172" name="__codelineno-40-172" href="#__codelineno-40-172"></a><span class="n">race_details</span> <span class="o">=</span> <span class="n">race_details</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;@id&#39;</span><span class="p">:</span> <span class="s1">&#39;FastTrack_RaceId&#39;</span><span class="p">})</span>
<a id="__codelineno-40-173" name="__codelineno-40-173" href="#__codelineno-40-173"></a><span class="n">race_details</span><span class="p">[</span><span class="s1">&#39;Distance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">race_details</span><span class="p">[</span><span class="s1">&#39;Distance&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;m&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)))</span>
<a id="__codelineno-40-174" name="__codelineno-40-174" href="#__codelineno-40-174"></a><span class="n">race_details</span><span class="p">[</span><span class="s1">&#39;date_dt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">race_details</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">],</span> <span class="nb">format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> %b %y&#39;</span><span class="p">)</span>
<a id="__codelineno-40-175" name="__codelineno-40-175" href="#__codelineno-40-175"></a><span class="c1"># Clean up the dogs results dataset</span>
<a id="__codelineno-40-176" name="__codelineno-40-176" href="#__codelineno-40-176"></a><span class="n">dog_results</span> <span class="o">=</span> <span class="n">dog_results</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;@id&#39;</span><span class="p">:</span> <span class="s1">&#39;FastTrack_DogId&#39;</span><span class="p">,</span> <span class="s1">&#39;RaceId&#39;</span><span class="p">:</span> <span class="s1">&#39;FastTrack_RaceId&#39;</span><span class="p">})</span>
<a id="__codelineno-40-177" name="__codelineno-40-177" href="#__codelineno-40-177"></a>
<a id="__codelineno-40-178" name="__codelineno-40-178" href="#__codelineno-40-178"></a><span class="c1"># New line of code (rest of this code chunk is copied from bruno&#39;s code)</span>
<a id="__codelineno-40-179" name="__codelineno-40-179" href="#__codelineno-40-179"></a><span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;FastTrack_DogId&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;FastTrack_DogId&#39;</span><span class="p">])</span>
<a id="__codelineno-40-180" name="__codelineno-40-180" href="#__codelineno-40-180"></a>
<a id="__codelineno-40-181" name="__codelineno-40-181" href="#__codelineno-40-181"></a><span class="c1"># Combine dogs results with race attributes</span>
<a id="__codelineno-40-182" name="__codelineno-40-182" href="#__codelineno-40-182"></a><span class="n">dog_results</span> <span class="o">=</span> <span class="n">dog_results</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
<a id="__codelineno-40-183" name="__codelineno-40-183" href="#__codelineno-40-183"></a>    <span class="n">race_details</span><span class="p">,</span> 
<a id="__codelineno-40-184" name="__codelineno-40-184" href="#__codelineno-40-184"></a>    <span class="n">how</span> <span class="o">=</span> <span class="s1">&#39;left&#39;</span><span class="p">,</span>
<a id="__codelineno-40-185" name="__codelineno-40-185" href="#__codelineno-40-185"></a>    <span class="n">on</span> <span class="o">=</span> <span class="s1">&#39;FastTrack_RaceId&#39;</span>
<a id="__codelineno-40-186" name="__codelineno-40-186" href="#__codelineno-40-186"></a><span class="p">)</span>
<a id="__codelineno-40-187" name="__codelineno-40-187" href="#__codelineno-40-187"></a>
<a id="__codelineno-40-188" name="__codelineno-40-188" href="#__codelineno-40-188"></a><span class="c1"># Convert StartPrice to probability</span>
<a id="__codelineno-40-189" name="__codelineno-40-189" href="#__codelineno-40-189"></a><span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;StartPrice&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;StartPrice&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;$&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;F&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">x</span><span class="p">)</span>
<a id="__codelineno-40-190" name="__codelineno-40-190" href="#__codelineno-40-190"></a><span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;StartPrice_probability&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;StartPrice&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-40-191" name="__codelineno-40-191" href="#__codelineno-40-191"></a><span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;StartPrice_probability&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dog_results</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;FastTrack_RaceId&#39;</span><span class="p">)[</span><span class="s1">&#39;StartPrice_probability&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
<a id="__codelineno-40-192" name="__codelineno-40-192" href="#__codelineno-40-192"></a>
<a id="__codelineno-40-193" name="__codelineno-40-193" href="#__codelineno-40-193"></a><span class="c1"># Discard entries without results (scratched or did not finish)</span>
<a id="__codelineno-40-194" name="__codelineno-40-194" href="#__codelineno-40-194"></a><span class="n">dog_results</span> <span class="o">=</span> <span class="n">dog_results</span><span class="p">[</span><span class="o">~</span><span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;Box&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span>
<a id="__codelineno-40-195" name="__codelineno-40-195" href="#__codelineno-40-195"></a><span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;Box&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;Box&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<a id="__codelineno-40-196" name="__codelineno-40-196" href="#__codelineno-40-196"></a>
<a id="__codelineno-40-197" name="__codelineno-40-197" href="#__codelineno-40-197"></a><span class="c1"># Clean up other attributes</span>
<a id="__codelineno-40-198" name="__codelineno-40-198" href="#__codelineno-40-198"></a><span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;RunTime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;RunTime&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
<a id="__codelineno-40-199" name="__codelineno-40-199" href="#__codelineno-40-199"></a><span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;SplitMargin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;SplitMargin&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
<a id="__codelineno-40-200" name="__codelineno-40-200" href="#__codelineno-40-200"></a><span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;Prizemoney&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;Prizemoney&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-40-201" name="__codelineno-40-201" href="#__codelineno-40-201"></a><span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;Place&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;Place&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span><span class="p">),</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;coerce&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-40-202" name="__codelineno-40-202" href="#__codelineno-40-202"></a><span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;win&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;Place&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-40-203" name="__codelineno-40-203" href="#__codelineno-40-203"></a>
<a id="__codelineno-40-204" name="__codelineno-40-204" href="#__codelineno-40-204"></a><span class="c1"># Normalise some of the raw values</span>
<a id="__codelineno-40-205" name="__codelineno-40-205" href="#__codelineno-40-205"></a><span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;Prizemoney_norm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;Prizemoney&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">12</span>
<a id="__codelineno-40-206" name="__codelineno-40-206" href="#__codelineno-40-206"></a><span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;Place_inv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;Place&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-40-207" name="__codelineno-40-207" href="#__codelineno-40-207"></a><span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;Place_log&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;Place&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-40-208" name="__codelineno-40-208" href="#__codelineno-40-208"></a><span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;RunSpeed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;RunTime&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;Distance&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-40-209" name="__codelineno-40-209" href="#__codelineno-40-209"></a>
<a id="__codelineno-40-210" name="__codelineno-40-210" href="#__codelineno-40-210"></a><span class="c1">## Generate features using raw data</span>
<a id="__codelineno-40-211" name="__codelineno-40-211" href="#__codelineno-40-211"></a><span class="c1"># Calculate median winner time per track/distance</span>
<a id="__codelineno-40-212" name="__codelineno-40-212" href="#__codelineno-40-212"></a><span class="n">win_results</span> <span class="o">=</span> <span class="n">dog_results</span><span class="p">[</span><span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;win&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-40-213" name="__codelineno-40-213" href="#__codelineno-40-213"></a><span class="n">median_win_time</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">win_results</span><span class="p">[</span><span class="n">win_results</span><span class="p">[</span><span class="s1">&#39;RunTime&#39;</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;Track&#39;</span><span class="p">,</span> <span class="s1">&#39;Distance&#39;</span><span class="p">])[</span><span class="s1">&#39;RunTime&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">())</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;RunTime&quot;</span><span class="p">:</span> <span class="s2">&quot;RunTime_median&quot;</span><span class="p">})</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<a id="__codelineno-40-214" name="__codelineno-40-214" href="#__codelineno-40-214"></a><span class="n">median_win_split_time</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">win_results</span><span class="p">[</span><span class="n">win_results</span><span class="p">[</span><span class="s1">&#39;SplitMargin&#39;</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;Track&#39;</span><span class="p">,</span> <span class="s1">&#39;Distance&#39;</span><span class="p">])[</span><span class="s1">&#39;SplitMargin&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">())</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;SplitMargin&quot;</span><span class="p">:</span> <span class="s2">&quot;SplitMargin_median&quot;</span><span class="p">})</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<a id="__codelineno-40-215" name="__codelineno-40-215" href="#__codelineno-40-215"></a><span class="n">median_win_time</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
<a id="__codelineno-40-216" name="__codelineno-40-216" href="#__codelineno-40-216"></a>
<a id="__codelineno-40-217" name="__codelineno-40-217" href="#__codelineno-40-217"></a><span class="c1"># Calculate track speed index</span>
<a id="__codelineno-40-218" name="__codelineno-40-218" href="#__codelineno-40-218"></a><span class="n">median_win_time</span><span class="p">[</span><span class="s1">&#39;speed_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">median_win_time</span><span class="p">[</span><span class="s1">&#39;RunTime_median&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">median_win_time</span><span class="p">[</span><span class="s1">&#39;Distance&#39;</span><span class="p">])</span>
<a id="__codelineno-40-219" name="__codelineno-40-219" href="#__codelineno-40-219"></a><span class="n">median_win_time</span><span class="p">[</span><span class="s1">&#39;speed_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">MinMaxScaler</span><span class="p">()</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">median_win_time</span><span class="p">[[</span><span class="s1">&#39;speed_index&#39;</span><span class="p">]])</span>
<a id="__codelineno-40-220" name="__codelineno-40-220" href="#__codelineno-40-220"></a><span class="n">median_win_time</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
<a id="__codelineno-40-221" name="__codelineno-40-221" href="#__codelineno-40-221"></a>
<a id="__codelineno-40-222" name="__codelineno-40-222" href="#__codelineno-40-222"></a><span class="c1"># Compare dogs finish time with median winner time</span>
<a id="__codelineno-40-223" name="__codelineno-40-223" href="#__codelineno-40-223"></a><span class="n">dog_results</span> <span class="o">=</span> <span class="n">dog_results</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">median_win_time</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Track&#39;</span><span class="p">,</span> <span class="s1">&#39;Distance&#39;</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
<a id="__codelineno-40-224" name="__codelineno-40-224" href="#__codelineno-40-224"></a><span class="n">dog_results</span> <span class="o">=</span> <span class="n">dog_results</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">median_win_split_time</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Track&#39;</span><span class="p">,</span> <span class="s1">&#39;Distance&#39;</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
<a id="__codelineno-40-225" name="__codelineno-40-225" href="#__codelineno-40-225"></a>
<a id="__codelineno-40-226" name="__codelineno-40-226" href="#__codelineno-40-226"></a><span class="c1"># Normalise time comparison</span>
<a id="__codelineno-40-227" name="__codelineno-40-227" href="#__codelineno-40-227"></a><span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;RunTime_norm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;RunTime_median&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;RunTime&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">)</span>
<a id="__codelineno-40-228" name="__codelineno-40-228" href="#__codelineno-40-228"></a><span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;RunTime_norm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">MinMaxScaler</span><span class="p">()</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">dog_results</span><span class="p">[[</span><span class="s1">&#39;RunTime_norm&#39;</span><span class="p">]])</span>
<a id="__codelineno-40-229" name="__codelineno-40-229" href="#__codelineno-40-229"></a><span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;SplitMargin_norm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;SplitMargin_median&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;SplitMargin&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">)</span>
<a id="__codelineno-40-230" name="__codelineno-40-230" href="#__codelineno-40-230"></a><span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;SplitMargin_norm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">MinMaxScaler</span><span class="p">()</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">dog_results</span><span class="p">[[</span><span class="s1">&#39;SplitMargin_norm&#39;</span><span class="p">]])</span>
<a id="__codelineno-40-231" name="__codelineno-40-231" href="#__codelineno-40-231"></a><span class="n">dog_results</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
<a id="__codelineno-40-232" name="__codelineno-40-232" href="#__codelineno-40-232"></a>
<a id="__codelineno-40-233" name="__codelineno-40-233" href="#__codelineno-40-233"></a><span class="c1"># Calculate box winning percentage for each track/distance</span>
<a id="__codelineno-40-234" name="__codelineno-40-234" href="#__codelineno-40-234"></a><span class="n">box_win_percent</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">dog_results</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;Track&#39;</span><span class="p">,</span> <span class="s1">&#39;Distance&#39;</span><span class="p">,</span> <span class="s1">&#39;Box&#39;</span><span class="p">])[</span><span class="s1">&#39;win&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;win&quot;</span><span class="p">:</span> <span class="s2">&quot;box_win_percent&quot;</span><span class="p">})</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<a id="__codelineno-40-235" name="__codelineno-40-235" href="#__codelineno-40-235"></a><span class="c1"># Add to dog results dataframe</span>
<a id="__codelineno-40-236" name="__codelineno-40-236" href="#__codelineno-40-236"></a><span class="n">dog_results</span> <span class="o">=</span> <span class="n">dog_results</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">box_win_percent</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Track&#39;</span><span class="p">,</span> <span class="s1">&#39;Distance&#39;</span><span class="p">,</span> <span class="s1">&#39;Box&#39;</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
<a id="__codelineno-40-237" name="__codelineno-40-237" href="#__codelineno-40-237"></a><span class="c1"># Display example of barrier winning probabilities</span>
<a id="__codelineno-40-238" name="__codelineno-40-238" href="#__codelineno-40-238"></a><span class="nb">print</span><span class="p">(</span><span class="n">box_win_percent</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>
<a id="__codelineno-40-239" name="__codelineno-40-239" href="#__codelineno-40-239"></a>
<a id="__codelineno-40-240" name="__codelineno-40-240" href="#__codelineno-40-240"></a><span class="n">dog_results</span><span class="p">[</span><span class="n">dog_results</span><span class="p">[</span><span class="s1">&#39;FastTrack_DogId&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">592253143</span><span class="p">]</span><span class="o">.</span><span class="n">tail</span><span class="p">()[[</span><span class="s1">&#39;date_dt&#39;</span><span class="p">,</span><span class="s1">&#39;Place&#39;</span><span class="p">,</span><span class="s1">&#39;DogName&#39;</span><span class="p">,</span><span class="s1">&#39;RaceNum&#39;</span><span class="p">,</span><span class="s1">&#39;Track&#39;</span><span class="p">,</span><span class="s1">&#39;Distance&#39;</span><span class="p">,</span><span class="s1">&#39;win&#39;</span><span class="p">,</span><span class="s1">&#39;Prizemoney_norm&#39;</span><span class="p">,</span><span class="s1">&#39;Place_inv&#39;</span><span class="p">,</span><span class="s1">&#39;Place_log&#39;</span><span class="p">]]</span>
<a id="__codelineno-40-241" name="__codelineno-40-241" href="#__codelineno-40-241"></a>
<a id="__codelineno-40-242" name="__codelineno-40-242" href="#__codelineno-40-242"></a><span class="c1"># Generate rolling window features</span>
<a id="__codelineno-40-243" name="__codelineno-40-243" href="#__codelineno-40-243"></a><span class="n">dataset</span> <span class="o">=</span> <span class="n">dog_results</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-40-244" name="__codelineno-40-244" href="#__codelineno-40-244"></a><span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;FastTrack_DogId&#39;</span><span class="p">,</span> <span class="s1">&#39;date_dt&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
<a id="__codelineno-40-245" name="__codelineno-40-245" href="#__codelineno-40-245"></a>
<a id="__codelineno-40-246" name="__codelineno-40-246" href="#__codelineno-40-246"></a><span class="c1"># Use rolling window of 28, 91 and 365 days</span>
<a id="__codelineno-40-247" name="__codelineno-40-247" href="#__codelineno-40-247"></a><span class="n">rolling_windows</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;28D&#39;</span><span class="p">,</span> <span class="s1">&#39;91D&#39;</span><span class="p">,</span> <span class="s1">&#39;365D&#39;</span><span class="p">]</span>
<a id="__codelineno-40-248" name="__codelineno-40-248" href="#__codelineno-40-248"></a><span class="c1"># Features to use for rolling windows calculation</span>
<a id="__codelineno-40-249" name="__codelineno-40-249" href="#__codelineno-40-249"></a><span class="n">features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;RunTime_norm&#39;</span><span class="p">,</span> <span class="s1">&#39;SplitMargin_norm&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_inv&#39;</span><span class="p">,</span> <span class="s1">&#39;Place_log&#39;</span><span class="p">,</span> <span class="s1">&#39;Prizemoney_norm&#39;</span><span class="p">]</span>
<a id="__codelineno-40-250" name="__codelineno-40-250" href="#__codelineno-40-250"></a><span class="c1"># Aggregation functions to apply</span>
<a id="__codelineno-40-251" name="__codelineno-40-251" href="#__codelineno-40-251"></a><span class="n">aggregates</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;median&#39;</span><span class="p">,</span> <span class="s1">&#39;std&#39;</span><span class="p">]</span>
<a id="__codelineno-40-252" name="__codelineno-40-252" href="#__codelineno-40-252"></a><span class="c1"># Keep track of generated feature names</span>
<a id="__codelineno-40-253" name="__codelineno-40-253" href="#__codelineno-40-253"></a><span class="n">feature_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;speed_index&#39;</span><span class="p">,</span> <span class="s1">&#39;box_win_percent&#39;</span><span class="p">]</span>
<a id="__codelineno-40-254" name="__codelineno-40-254" href="#__codelineno-40-254"></a>
<a id="__codelineno-40-255" name="__codelineno-40-255" href="#__codelineno-40-255"></a><span class="k">for</span> <span class="n">rolling_window</span> <span class="ow">in</span> <span class="n">rolling_windows</span><span class="p">:</span>
<a id="__codelineno-40-256" name="__codelineno-40-256" href="#__codelineno-40-256"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Processing rolling window </span><span class="si">{</span><span class="n">rolling_window</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-40-257" name="__codelineno-40-257" href="#__codelineno-40-257"></a>
<a id="__codelineno-40-258" name="__codelineno-40-258" href="#__codelineno-40-258"></a>        <span class="n">rolling_result</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-40-259" name="__codelineno-40-259" href="#__codelineno-40-259"></a>            <span class="n">dataset</span>
<a id="__codelineno-40-260" name="__codelineno-40-260" href="#__codelineno-40-260"></a>            <span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
<a id="__codelineno-40-261" name="__codelineno-40-261" href="#__codelineno-40-261"></a>            <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;FastTrack_DogId&#39;</span><span class="p">)[</span><span class="n">features</span><span class="p">]</span>
<a id="__codelineno-40-262" name="__codelineno-40-262" href="#__codelineno-40-262"></a>            <span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">rolling_window</span><span class="p">)</span>
<a id="__codelineno-40-263" name="__codelineno-40-263" href="#__codelineno-40-263"></a>            <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">aggregates</span><span class="p">)</span>
<a id="__codelineno-40-264" name="__codelineno-40-264" href="#__codelineno-40-264"></a>            <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># Thanks to Brett for finding this!</span>
<a id="__codelineno-40-265" name="__codelineno-40-265" href="#__codelineno-40-265"></a>            <span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-40-266" name="__codelineno-40-266" href="#__codelineno-40-266"></a>        <span class="p">)</span>
<a id="__codelineno-40-267" name="__codelineno-40-267" href="#__codelineno-40-267"></a>
<a id="__codelineno-40-268" name="__codelineno-40-268" href="#__codelineno-40-268"></a>        <span class="c1"># My own dodgey code to work with reserve dogs</span>
<a id="__codelineno-40-269" name="__codelineno-40-269" href="#__codelineno-40-269"></a>        <span class="n">temp</span> <span class="o">=</span> <span class="n">rolling_result</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<a id="__codelineno-40-270" name="__codelineno-40-270" href="#__codelineno-40-270"></a>        <span class="n">temp</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="n">temp</span><span class="p">[</span><span class="s1">&#39;date_dt&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">normalize</span><span class="p">()]</span>
<a id="__codelineno-40-271" name="__codelineno-40-271" href="#__codelineno-40-271"></a>        <span class="n">temp</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;FastTrack_DogId&#39;</span><span class="p">,</span><span class="s1">&#39;date_dt&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
<a id="__codelineno-40-272" name="__codelineno-40-272" href="#__codelineno-40-272"></a>        <span class="n">rolling_result</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">IndexSlice</span><span class="p">[:,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">normalize</span><span class="p">()],</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;FastTrack_DogId&#39;</span><span class="p">,</span><span class="s1">&#39;date_dt&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
<a id="__codelineno-40-273" name="__codelineno-40-273" href="#__codelineno-40-273"></a>
<a id="__codelineno-40-274" name="__codelineno-40-274" href="#__codelineno-40-274"></a>        <span class="c1"># Generate list of rolling window feature names (eg: RunTime_norm_min_365D)</span>
<a id="__codelineno-40-275" name="__codelineno-40-275" href="#__codelineno-40-275"></a>        <span class="n">agg_features_cols</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">a</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">rolling_window</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">f</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">aggregates</span><span class="p">)]</span>
<a id="__codelineno-40-276" name="__codelineno-40-276" href="#__codelineno-40-276"></a>        <span class="c1"># Add features to dataset</span>
<a id="__codelineno-40-277" name="__codelineno-40-277" href="#__codelineno-40-277"></a>        <span class="n">dataset</span><span class="p">[</span><span class="n">agg_features_cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">rolling_result</span>
<a id="__codelineno-40-278" name="__codelineno-40-278" href="#__codelineno-40-278"></a>        <span class="c1"># Keep track of generated feature names</span>
<a id="__codelineno-40-279" name="__codelineno-40-279" href="#__codelineno-40-279"></a>        <span class="n">feature_cols</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">agg_features_cols</span><span class="p">)</span>
<a id="__codelineno-40-280" name="__codelineno-40-280" href="#__codelineno-40-280"></a>
<a id="__codelineno-40-281" name="__codelineno-40-281" href="#__codelineno-40-281"></a><span class="c1"># Replace missing values with 0</span>
<a id="__codelineno-40-282" name="__codelineno-40-282" href="#__codelineno-40-282"></a><span class="n">dataset</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-40-283" name="__codelineno-40-283" href="#__codelineno-40-283"></a><span class="c1"># display(dataset.head(8))  # display is only for ipython notebooks</span>
<a id="__codelineno-40-284" name="__codelineno-40-284" href="#__codelineno-40-284"></a>
<a id="__codelineno-40-285" name="__codelineno-40-285" href="#__codelineno-40-285"></a><span class="c1"># Only keep data after 2018-12-01</span>
<a id="__codelineno-40-286" name="__codelineno-40-286" href="#__codelineno-40-286"></a><span class="n">model_df</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<a id="__codelineno-40-287" name="__codelineno-40-287" href="#__codelineno-40-287"></a><span class="n">feature_cols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">feature_cols</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<a id="__codelineno-40-288" name="__codelineno-40-288" href="#__codelineno-40-288"></a><span class="n">model_df</span> <span class="o">=</span> <span class="n">model_df</span><span class="p">[</span><span class="n">model_df</span><span class="p">[</span><span class="s1">&#39;date_dt&#39;</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span><span class="o">=</span> <span class="s1">&#39;2018-12-01&#39;</span><span class="p">]</span>
<a id="__codelineno-40-289" name="__codelineno-40-289" href="#__codelineno-40-289"></a>
<a id="__codelineno-40-290" name="__codelineno-40-290" href="#__codelineno-40-290"></a><span class="c1"># This line was originally part of Bruno&#39;s tutorial, but we don&#39;t run it in this script</span>
<a id="__codelineno-40-291" name="__codelineno-40-291" href="#__codelineno-40-291"></a><span class="c1"># model_df = model_df[[&#39;date_dt&#39;, &#39;FastTrack_RaceId&#39;, &#39;DogName&#39;, &#39;win&#39;, &#39;StartPrice_probability&#39;] + feature_cols]</span>
<a id="__codelineno-40-292" name="__codelineno-40-292" href="#__codelineno-40-292"></a>
<a id="__codelineno-40-293" name="__codelineno-40-293" href="#__codelineno-40-293"></a><span class="c1"># Only train model off of races where each dog has a value for each feature</span>
<a id="__codelineno-40-294" name="__codelineno-40-294" href="#__codelineno-40-294"></a><span class="n">races_exclude</span> <span class="o">=</span> <span class="n">model_df</span><span class="p">[</span><span class="n">model_df</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)][</span><span class="s1">&#39;FastTrack_RaceId&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
<a id="__codelineno-40-295" name="__codelineno-40-295" href="#__codelineno-40-295"></a><span class="n">model_df</span> <span class="o">=</span> <span class="n">model_df</span><span class="p">[</span><span class="o">~</span><span class="n">model_df</span><span class="p">[</span><span class="s1">&#39;FastTrack_RaceId&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">races_exclude</span><span class="p">)]</span>
<a id="__codelineno-40-296" name="__codelineno-40-296" href="#__codelineno-40-296"></a>
<a id="__codelineno-40-297" name="__codelineno-40-297" href="#__codelineno-40-297"></a><span class="c1"># Generate predictions like normal</span>
<a id="__codelineno-40-298" name="__codelineno-40-298" href="#__codelineno-40-298"></a><span class="c1"># Range of dates that we want to simulate later &#39;2022-03-01&#39; to &#39;2022-04-01&#39;</span>
<a id="__codelineno-40-299" name="__codelineno-40-299" href="#__codelineno-40-299"></a><span class="n">todays_data</span> <span class="o">=</span> <span class="n">model_df</span><span class="p">[(</span><span class="n">model_df</span><span class="p">[</span><span class="s1">&#39;date_dt&#39;</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span><span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2022-03-01&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">))</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span> <span class="p">(</span><span class="n">model_df</span><span class="p">[</span><span class="s1">&#39;date_dt&#39;</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2022-04-01&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">))]</span>
<a id="__codelineno-40-300" name="__codelineno-40-300" href="#__codelineno-40-300"></a><span class="n">dog_win_probabilities</span> <span class="o">=</span> <span class="n">brunos_model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">todays_data</span><span class="p">[</span><span class="n">feature_cols</span><span class="p">])[:,</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-40-301" name="__codelineno-40-301" href="#__codelineno-40-301"></a><span class="n">todays_data</span><span class="p">[</span><span class="s1">&#39;prob_LogisticRegression&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dog_win_probabilities</span>
<a id="__codelineno-40-302" name="__codelineno-40-302" href="#__codelineno-40-302"></a><span class="n">todays_data</span><span class="p">[</span><span class="s1">&#39;renormalise_prob&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">todays_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;FastTrack_RaceId&#39;</span><span class="p">)[</span><span class="s1">&#39;prob_LogisticRegression&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
<a id="__codelineno-40-303" name="__codelineno-40-303" href="#__codelineno-40-303"></a><span class="n">todays_data</span><span class="p">[</span><span class="s1">&#39;rating&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">todays_data</span><span class="p">[</span><span class="s1">&#39;renormalise_prob&#39;</span><span class="p">]</span>
<a id="__codelineno-40-304" name="__codelineno-40-304" href="#__codelineno-40-304"></a><span class="n">todays_data</span> <span class="o">=</span> <span class="n">todays_data</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span> <span class="o">=</span> <span class="s1">&#39;date_dt&#39;</span><span class="p">)</span>
<a id="__codelineno-40-305" name="__codelineno-40-305" href="#__codelineno-40-305"></a><span class="n">todays_data</span>
<a id="__codelineno-40-306" name="__codelineno-40-306" href="#__codelineno-40-306"></a>
<a id="__codelineno-40-307" name="__codelineno-40-307" href="#__codelineno-40-307"></a><span class="k">def</span><span class="w"> </span><span class="nf">download_iggy_ratings</span><span class="p">(</span><span class="n">date</span><span class="p">):</span>
<a id="__codelineno-40-308" name="__codelineno-40-308" href="#__codelineno-40-308"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Downloads the Betfair Iggy model ratings for a given date and formats it into a nice DataFrame.</span>
<a id="__codelineno-40-309" name="__codelineno-40-309" href="#__codelineno-40-309"></a>
<a id="__codelineno-40-310" name="__codelineno-40-310" href="#__codelineno-40-310"></a><span class="sd">    Args:</span>
<a id="__codelineno-40-311" name="__codelineno-40-311" href="#__codelineno-40-311"></a><span class="sd">        date (datetime): the date we want to download the ratings for</span>
<a id="__codelineno-40-312" name="__codelineno-40-312" href="#__codelineno-40-312"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-40-313" name="__codelineno-40-313" href="#__codelineno-40-313"></a>    <span class="n">iggy_url_1</span> <span class="o">=</span> <span class="s1">&#39;https://betfair-data-supplier-prod.herokuapp.com/api/widgets/iggy-joey/datasets?date=&#39;</span>
<a id="__codelineno-40-314" name="__codelineno-40-314" href="#__codelineno-40-314"></a>    <span class="n">iggy_url_2</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-40-315" name="__codelineno-40-315" href="#__codelineno-40-315"></a>    <span class="n">iggy_url_3</span> <span class="o">=</span> <span class="s1">&#39;&amp;amp;presenter=RatingsPresenter&amp;amp;csv=true&#39;</span>
<a id="__codelineno-40-316" name="__codelineno-40-316" href="#__codelineno-40-316"></a>    <span class="n">iggy_url</span> <span class="o">=</span> <span class="n">iggy_url_1</span> <span class="o">+</span> <span class="n">iggy_url_2</span> <span class="o">+</span> <span class="n">iggy_url_3</span>
<a id="__codelineno-40-317" name="__codelineno-40-317" href="#__codelineno-40-317"></a>
<a id="__codelineno-40-318" name="__codelineno-40-318" href="#__codelineno-40-318"></a>    <span class="c1"># Download todays greyhounds ratings</span>
<a id="__codelineno-40-319" name="__codelineno-40-319" href="#__codelineno-40-319"></a>    <span class="n">iggy_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">iggy_url</span><span class="p">)</span>
<a id="__codelineno-40-320" name="__codelineno-40-320" href="#__codelineno-40-320"></a>
<a id="__codelineno-40-321" name="__codelineno-40-321" href="#__codelineno-40-321"></a>    <span class="c1"># Data clearning</span>
<a id="__codelineno-40-322" name="__codelineno-40-322" href="#__codelineno-40-322"></a>    <span class="n">iggy_df</span> <span class="o">=</span> <span class="n">iggy_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
<a id="__codelineno-40-323" name="__codelineno-40-323" href="#__codelineno-40-323"></a>    <span class="n">columns</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-40-324" name="__codelineno-40-324" href="#__codelineno-40-324"></a>        <span class="s2">&quot;meetings.races.bfExchangeMarketId&quot;</span><span class="p">:</span><span class="s2">&quot;market_id&quot;</span><span class="p">,</span>
<a id="__codelineno-40-325" name="__codelineno-40-325" href="#__codelineno-40-325"></a>        <span class="s2">&quot;meetings.races.runners.bfExchangeSelectionId&quot;</span><span class="p">:</span><span class="s2">&quot;selection_id&quot;</span><span class="p">,</span>
<a id="__codelineno-40-326" name="__codelineno-40-326" href="#__codelineno-40-326"></a>        <span class="s2">&quot;meetings.races.runners.ratedPrice&quot;</span><span class="p">:</span><span class="s2">&quot;rating&quot;</span><span class="p">,</span>
<a id="__codelineno-40-327" name="__codelineno-40-327" href="#__codelineno-40-327"></a>        <span class="s2">&quot;meetings.races.number&quot;</span><span class="p">:</span><span class="s2">&quot;RaceNum&quot;</span><span class="p">,</span>
<a id="__codelineno-40-328" name="__codelineno-40-328" href="#__codelineno-40-328"></a>        <span class="s2">&quot;meetings.name&quot;</span><span class="p">:</span><span class="s2">&quot;Track&quot;</span><span class="p">,</span>
<a id="__codelineno-40-329" name="__codelineno-40-329" href="#__codelineno-40-329"></a>        <span class="s2">&quot;meetings.races.runners.name&quot;</span><span class="p">:</span><span class="s2">&quot;DogName&quot;</span>
<a id="__codelineno-40-330" name="__codelineno-40-330" href="#__codelineno-40-330"></a>        <span class="p">}</span>
<a id="__codelineno-40-331" name="__codelineno-40-331" href="#__codelineno-40-331"></a>    <span class="p">)</span>
<a id="__codelineno-40-332" name="__codelineno-40-332" href="#__codelineno-40-332"></a>    <span class="c1"># iggy_df = iggy_df[[&#39;market_id&#39;,&#39;selection_id&#39;,&#39;rating&#39;]]</span>
<a id="__codelineno-40-333" name="__codelineno-40-333" href="#__codelineno-40-333"></a>    <span class="n">iggy_df</span><span class="p">[</span><span class="s1">&#39;market_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">iggy_df</span><span class="p">[</span><span class="s1">&#39;market_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
<a id="__codelineno-40-334" name="__codelineno-40-334" href="#__codelineno-40-334"></a>    <span class="n">iggy_df</span><span class="p">[</span><span class="s1">&#39;date_dt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">date</span>
<a id="__codelineno-40-335" name="__codelineno-40-335" href="#__codelineno-40-335"></a>
<a id="__codelineno-40-336" name="__codelineno-40-336" href="#__codelineno-40-336"></a>    <span class="c1"># Set market_id and selection_id as index for easy referencing</span>
<a id="__codelineno-40-337" name="__codelineno-40-337" href="#__codelineno-40-337"></a>    <span class="c1"># iggy_df = iggy_df.set_index([&#39;market_id&#39;,&#39;selection_id&#39;])</span>
<a id="__codelineno-40-338" name="__codelineno-40-338" href="#__codelineno-40-338"></a>    <span class="k">return</span><span class="p">(</span><span class="n">iggy_df</span><span class="p">)</span>
<a id="__codelineno-40-339" name="__codelineno-40-339" href="#__codelineno-40-339"></a>
<a id="__codelineno-40-340" name="__codelineno-40-340" href="#__codelineno-40-340"></a><span class="c1"># Download historical ratings over a time period and convert into a big DataFrame.</span>
<a id="__codelineno-40-341" name="__codelineno-40-341" href="#__codelineno-40-341"></a><span class="n">back_test_period</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="s1">&#39;2022-03-01&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;2022-04-01&#39;</span><span class="p">)</span>
<a id="__codelineno-40-342" name="__codelineno-40-342" href="#__codelineno-40-342"></a><span class="n">frames</span> <span class="o">=</span> <span class="p">[</span><span class="n">download_iggy_ratings</span><span class="p">(</span><span class="n">day</span><span class="p">)</span> <span class="k">for</span> <span class="n">day</span> <span class="ow">in</span> <span class="n">back_test_period</span><span class="p">]</span>
<a id="__codelineno-40-343" name="__codelineno-40-343" href="#__codelineno-40-343"></a><span class="n">iggy_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">frames</span><span class="p">)</span>
<a id="__codelineno-40-344" name="__codelineno-40-344" href="#__codelineno-40-344"></a><span class="n">iggy_df</span>
<a id="__codelineno-40-345" name="__codelineno-40-345" href="#__codelineno-40-345"></a>
<a id="__codelineno-40-346" name="__codelineno-40-346" href="#__codelineno-40-346"></a><span class="c1"># format DogNames to merge</span>
<a id="__codelineno-40-347" name="__codelineno-40-347" href="#__codelineno-40-347"></a><span class="n">todays_data</span><span class="p">[</span><span class="s1">&#39;DogName&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">todays_data</span><span class="p">[</span><span class="s1">&#39;DogName&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Res&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
<a id="__codelineno-40-348" name="__codelineno-40-348" href="#__codelineno-40-348"></a><span class="n">iggy_df</span><span class="p">[</span><span class="s1">&#39;DogName&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">iggy_df</span><span class="p">[</span><span class="s1">&#39;DogName&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
<a id="__codelineno-40-349" name="__codelineno-40-349" href="#__codelineno-40-349"></a><span class="c1"># Merge</span>
<a id="__codelineno-40-350" name="__codelineno-40-350" href="#__codelineno-40-350"></a><span class="n">backtest</span> <span class="o">=</span> <span class="n">iggy_df</span><span class="p">[[</span><span class="s1">&#39;market_id&#39;</span><span class="p">,</span><span class="s1">&#39;selection_id&#39;</span><span class="p">,</span><span class="s1">&#39;DogName&#39;</span><span class="p">,</span><span class="s1">&#39;date_dt&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">todays_data</span><span class="p">[[</span><span class="s1">&#39;rating&#39;</span><span class="p">,</span><span class="s1">&#39;DogName&#39;</span><span class="p">,</span><span class="s1">&#39;date_dt&#39;</span><span class="p">]],</span> <span class="n">how</span> <span class="o">=</span> <span class="s1">&#39;inner&#39;</span><span class="p">,</span> <span class="n">on</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;DogName&#39;</span><span class="p">,</span><span class="s1">&#39;date_dt&#39;</span><span class="p">])</span>
<a id="__codelineno-40-351" name="__codelineno-40-351" href="#__codelineno-40-351"></a><span class="n">backtest</span>
<a id="__codelineno-40-352" name="__codelineno-40-352" href="#__codelineno-40-352"></a>
<a id="__codelineno-40-353" name="__codelineno-40-353" href="#__codelineno-40-353"></a><span class="c1"># Save predictions for if we want to backtest/simulate it later</span>
<a id="__codelineno-40-354" name="__codelineno-40-354" href="#__codelineno-40-354"></a><span class="n">backtest</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;backtest.csv&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="c1"># Csv format</span>
<a id="__codelineno-40-355" name="__codelineno-40-355" href="#__codelineno-40-355"></a><span class="c1"># backtest.to_pickle(&#39;backtest.pkl&#39;) # pickle format (faster, but can&#39;t open in excel)</span>
<a id="__codelineno-40-356" name="__codelineno-40-356" href="#__codelineno-40-356"></a>
<a id="__codelineno-40-357" name="__codelineno-40-357" href="#__codelineno-40-357"></a><span class="n">todays_data</span><span class="p">[</span><span class="n">todays_data</span><span class="p">[</span><span class="s1">&#39;FastTrack_RaceId&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;798906744&#39;</span><span class="p">]</span>
<a id="__codelineno-40-358" name="__codelineno-40-358" href="#__codelineno-40-358"></a>
<a id="__codelineno-40-359" name="__codelineno-40-359" href="#__codelineno-40-359"></a><span class="c1"># Select todays data </span>
<a id="__codelineno-40-360" name="__codelineno-40-360" href="#__codelineno-40-360"></a><span class="n">todays_data</span> <span class="o">=</span> <span class="n">model_df</span><span class="p">[</span><span class="n">model_df</span><span class="p">[</span><span class="s1">&#39;date_dt&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)]</span>
<a id="__codelineno-40-361" name="__codelineno-40-361" href="#__codelineno-40-361"></a>
<a id="__codelineno-40-362" name="__codelineno-40-362" href="#__codelineno-40-362"></a><span class="c1"># Generate runner win predictions</span>
<a id="__codelineno-40-363" name="__codelineno-40-363" href="#__codelineno-40-363"></a><span class="n">dog_win_probabilities</span> <span class="o">=</span> <span class="n">brunos_model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">todays_data</span><span class="p">[</span><span class="n">feature_cols</span><span class="p">])[:,</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-40-364" name="__codelineno-40-364" href="#__codelineno-40-364"></a><span class="n">todays_data</span><span class="p">[</span><span class="s1">&#39;prob_LogisticRegression&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dog_win_probabilities</span>
<a id="__codelineno-40-365" name="__codelineno-40-365" href="#__codelineno-40-365"></a>
<a id="__codelineno-40-366" name="__codelineno-40-366" href="#__codelineno-40-366"></a><span class="c1"># We no longer renomralise probability in this chunk of code, do it in Flumine instead</span>
<a id="__codelineno-40-367" name="__codelineno-40-367" href="#__codelineno-40-367"></a><span class="c1"># todays_data[&#39;renormalise_prob&#39;] = todays_data.groupby(&#39;FastTrack_RaceId&#39;)[&#39;prob_LogisticRegression&#39;].apply(lambda x: x / x.sum())</span>
<a id="__codelineno-40-368" name="__codelineno-40-368" href="#__codelineno-40-368"></a><span class="c1"># todays_data[&#39;rating&#39;] = 1/todays_data[&#39;renormalise_prob&#39;]</span>
<a id="__codelineno-40-369" name="__codelineno-40-369" href="#__codelineno-40-369"></a><span class="c1"># todays_data = todays_data.sort_values(by = &#39;date_dt&#39;)</span>
<a id="__codelineno-40-370" name="__codelineno-40-370" href="#__codelineno-40-370"></a>
<a id="__codelineno-40-371" name="__codelineno-40-371" href="#__codelineno-40-371"></a><span class="n">todays_data</span>
<a id="__codelineno-40-372" name="__codelineno-40-372" href="#__codelineno-40-372"></a>
<a id="__codelineno-40-373" name="__codelineno-40-373" href="#__codelineno-40-373"></a><span class="c1"># Prepare data for easy reference in flumine</span>
<a id="__codelineno-40-374" name="__codelineno-40-374" href="#__codelineno-40-374"></a><span class="n">todays_data</span><span class="p">[</span><span class="s1">&#39;DogName_bf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">todays_data</span><span class="p">[</span><span class="s1">&#39;DogName&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Res&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
<a id="__codelineno-40-375" name="__codelineno-40-375" href="#__codelineno-40-375"></a><span class="n">todays_data</span><span class="o">.</span><span class="n">replace</span><span class="p">({</span><span class="s1">&#39;Sandown (SAP)&#39;</span><span class="p">:</span> <span class="s1">&#39;Sandown Park&#39;</span><span class="p">},</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-40-376" name="__codelineno-40-376" href="#__codelineno-40-376"></a><span class="n">todays_data</span> <span class="o">=</span> <span class="n">todays_data</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;DogName_bf&#39;</span><span class="p">,</span><span class="s1">&#39;Track&#39;</span><span class="p">,</span><span class="s1">&#39;RaceNum&#39;</span><span class="p">])</span>
<a id="__codelineno-40-377" name="__codelineno-40-377" href="#__codelineno-40-377"></a><span class="n">todays_data</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
<a id="__codelineno-40-378" name="__codelineno-40-378" href="#__codelineno-40-378"></a>
<a id="__codelineno-40-379" name="__codelineno-40-379" href="#__codelineno-40-379"></a><span class="c1"># Credentials to login and logging in </span>
<a id="__codelineno-40-380" name="__codelineno-40-380" href="#__codelineno-40-380"></a><span class="n">trading</span> <span class="o">=</span> <span class="n">betfairlightweight</span><span class="o">.</span><span class="n">APIClient</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">,</span><span class="s1">&#39;password&#39;</span><span class="p">,</span><span class="n">app_key</span><span class="o">=</span><span class="s1">&#39;appkey&#39;</span><span class="p">)</span>
<a id="__codelineno-40-381" name="__codelineno-40-381" href="#__codelineno-40-381"></a><span class="n">client</span> <span class="o">=</span> <span class="n">clients</span><span class="o">.</span><span class="n">BetfairClient</span><span class="p">(</span><span class="n">trading</span><span class="p">,</span> <span class="n">interactive_login</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-40-382" name="__codelineno-40-382" href="#__codelineno-40-382"></a>
<a id="__codelineno-40-383" name="__codelineno-40-383" href="#__codelineno-40-383"></a><span class="c1"># Login</span>
<a id="__codelineno-40-384" name="__codelineno-40-384" href="#__codelineno-40-384"></a><span class="n">framework</span> <span class="o">=</span> <span class="n">Flumine</span><span class="p">(</span><span class="n">client</span><span class="o">=</span><span class="n">client</span><span class="p">)</span>
<a id="__codelineno-40-385" name="__codelineno-40-385" href="#__codelineno-40-385"></a>
<a id="__codelineno-40-386" name="__codelineno-40-386" href="#__codelineno-40-386"></a><span class="c1"># Code to login when using security certificates</span>
<a id="__codelineno-40-387" name="__codelineno-40-387" href="#__codelineno-40-387"></a><span class="c1"># trading = betfairlightweight.APIClient(&#39;username&#39;,&#39;password&#39;,app_key=&#39;appkey&#39;, certs=r&#39;C:\Users\zhoui\openssl_certs&#39;)</span>
<a id="__codelineno-40-388" name="__codelineno-40-388" href="#__codelineno-40-388"></a><span class="c1"># client = clients.BetfairClient(trading)</span>
<a id="__codelineno-40-389" name="__codelineno-40-389" href="#__codelineno-40-389"></a>
<a id="__codelineno-40-390" name="__codelineno-40-390" href="#__codelineno-40-390"></a><span class="c1"># framework = Flumine(client=client)</span>
<a id="__codelineno-40-391" name="__codelineno-40-391" href="#__codelineno-40-391"></a>
<a id="__codelineno-40-392" name="__codelineno-40-392" href="#__codelineno-40-392"></a><span class="k">class</span><span class="w"> </span><span class="nc">FlatBetting</span><span class="p">(</span><span class="n">BaseStrategy</span><span class="p">):</span>
<a id="__codelineno-40-393" name="__codelineno-40-393" href="#__codelineno-40-393"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-40-394" name="__codelineno-40-394" href="#__codelineno-40-394"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;starting strategy &#39;FlatBetting&#39; using the model we created the Greyhound modelling in Python Tutorial&quot;</span><span class="p">)</span>
<a id="__codelineno-40-395" name="__codelineno-40-395" href="#__codelineno-40-395"></a>
<a id="__codelineno-40-396" name="__codelineno-40-396" href="#__codelineno-40-396"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">check_market_book</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">market</span><span class="p">:</span> <span class="n">Market</span><span class="p">,</span> <span class="n">market_book</span><span class="p">:</span> <span class="n">MarketBook</span><span class="p">)</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-40-397" name="__codelineno-40-397" href="#__codelineno-40-397"></a>        <span class="k">if</span> <span class="n">market_book</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="s2">&quot;CLOSED&quot;</span><span class="p">:</span>
<a id="__codelineno-40-398" name="__codelineno-40-398" href="#__codelineno-40-398"></a>            <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-40-399" name="__codelineno-40-399" href="#__codelineno-40-399"></a>
<a id="__codelineno-40-400" name="__codelineno-40-400" href="#__codelineno-40-400"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">process_market_book</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">market</span><span class="p">:</span> <span class="n">Market</span><span class="p">,</span> <span class="n">market_book</span><span class="p">:</span> <span class="n">MarketBook</span><span class="p">)</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-40-401" name="__codelineno-40-401" href="#__codelineno-40-401"></a>        <span class="c1"># Convert dataframe to a global variable</span>
<a id="__codelineno-40-402" name="__codelineno-40-402" href="#__codelineno-40-402"></a>        <span class="k">global</span> <span class="n">todays_data</span>
<a id="__codelineno-40-403" name="__codelineno-40-403" href="#__codelineno-40-403"></a>
<a id="__codelineno-40-404" name="__codelineno-40-404" href="#__codelineno-40-404"></a>        <span class="c1"># At the 60 second mark:</span>
<a id="__codelineno-40-405" name="__codelineno-40-405" href="#__codelineno-40-405"></a>        <span class="k">if</span> <span class="n">market</span><span class="o">.</span><span class="n">seconds_to_start</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span> <span class="mi">60</span> <span class="ow">and</span> <span class="n">market_book</span><span class="o">.</span><span class="n">inplay</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
<a id="__codelineno-40-406" name="__codelineno-40-406" href="#__codelineno-40-406"></a>            <span class="c1"># get the list of dog_names, name of the track/venue and race_number/RaceNum from Betfair Polling API</span>
<a id="__codelineno-40-407" name="__codelineno-40-407" href="#__codelineno-40-407"></a>            <span class="n">dog_names</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-40-408" name="__codelineno-40-408" href="#__codelineno-40-408"></a>            <span class="n">track</span> <span class="o">=</span> <span class="n">market</span><span class="o">.</span><span class="n">market_catalogue</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">venue</span>
<a id="__codelineno-40-409" name="__codelineno-40-409" href="#__codelineno-40-409"></a>            <span class="n">race_number</span> <span class="o">=</span> <span class="n">market</span><span class="o">.</span><span class="n">market_catalogue</span><span class="o">.</span><span class="n">market_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># comes out as R1/R2/R3 .. etc</span>
<a id="__codelineno-40-410" name="__codelineno-40-410" href="#__codelineno-40-410"></a>            <span class="n">race_number</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;[^0-9]&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">race_number</span><span class="p">)</span>  <span class="c1"># only keep the numbers </span>
<a id="__codelineno-40-411" name="__codelineno-40-411" href="#__codelineno-40-411"></a>            <span class="k">for</span> <span class="n">runner_cata</span> <span class="ow">in</span> <span class="n">market</span><span class="o">.</span><span class="n">market_catalogue</span><span class="o">.</span><span class="n">runners</span><span class="p">:</span>
<a id="__codelineno-40-412" name="__codelineno-40-412" href="#__codelineno-40-412"></a>                <span class="n">dog_name</span> <span class="o">=</span> <span class="n">runner_cata</span><span class="o">.</span><span class="n">runner_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
<a id="__codelineno-40-413" name="__codelineno-40-413" href="#__codelineno-40-413"></a>                <span class="n">dog_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dog_name</span><span class="p">)</span>
<a id="__codelineno-40-414" name="__codelineno-40-414" href="#__codelineno-40-414"></a>
<a id="__codelineno-40-415" name="__codelineno-40-415" href="#__codelineno-40-415"></a>            <span class="c1"># Check if there are box changes, if there are then use Brett&#39;s code</span>
<a id="__codelineno-40-416" name="__codelineno-40-416" href="#__codelineno-40-416"></a>            <span class="k">if</span> <span class="n">market</span><span class="o">.</span><span class="n">market_catalogue</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">clarifications</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-40-417" name="__codelineno-40-417" href="#__codelineno-40-417"></a>                <span class="c1"># Brett&#39;s code to get Box changes:</span>
<a id="__codelineno-40-418" name="__codelineno-40-418" href="#__codelineno-40-418"></a>                <span class="n">my_string</span> <span class="o">=</span> <span class="n">market</span><span class="o">.</span><span class="n">market_catalogue</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">clarifications</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;br/&gt; Dog&quot;</span><span class="p">,</span><span class="s2">&quot;&lt;br/&gt;Dog&quot;</span><span class="p">)</span>
<a id="__codelineno-40-419" name="__codelineno-40-419" href="#__codelineno-40-419"></a>                <span class="n">pattern1</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;(?&amp;lt;=&lt;br/&gt;Dog ).+?(?= starts)&#39;</span>
<a id="__codelineno-40-420" name="__codelineno-40-420" href="#__codelineno-40-420"></a>                <span class="n">pattern2</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;(?&amp;lt;=\bbox no. )(\w+)&quot;</span>
<a id="__codelineno-40-421" name="__codelineno-40-421" href="#__codelineno-40-421"></a>                <span class="n">runners_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="p">(</span><span class="n">regexp_tokenize</span><span class="p">(</span><span class="n">my_string</span><span class="p">,</span> <span class="n">pattern1</span><span class="p">),</span> <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;runner_name&#39;</span><span class="p">])</span>
<a id="__codelineno-40-422" name="__codelineno-40-422" href="#__codelineno-40-422"></a>                <span class="n">runners_df</span><span class="p">[</span><span class="s1">&#39;runner_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">runners_df</span><span class="p">[</span><span class="s1">&#39;runner_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
<a id="__codelineno-40-423" name="__codelineno-40-423" href="#__codelineno-40-423"></a>                <span class="c1"># Remove dog name from runner_number</span>
<a id="__codelineno-40-424" name="__codelineno-40-424" href="#__codelineno-40-424"></a>                <span class="n">runners_df</span><span class="p">[</span><span class="s1">&#39;runner_number&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">runners_df</span><span class="p">[</span><span class="s1">&#39;runner_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[:(</span><span class="n">x</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
<a id="__codelineno-40-425" name="__codelineno-40-425" href="#__codelineno-40-425"></a>                <span class="c1"># Remove dog number from runner_name</span>
<a id="__codelineno-40-426" name="__codelineno-40-426" href="#__codelineno-40-426"></a>                <span class="n">runners_df</span><span class="p">[</span><span class="s1">&#39;runner_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">runners_df</span><span class="p">[</span><span class="s1">&#39;runner_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[(</span><span class="n">x</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):]</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
<a id="__codelineno-40-427" name="__codelineno-40-427" href="#__codelineno-40-427"></a>                <span class="n">runners_df</span><span class="p">[</span><span class="s1">&#39;Box&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">regexp_tokenize</span><span class="p">(</span><span class="n">my_string</span><span class="p">,</span> <span class="n">pattern2</span><span class="p">)</span>
<a id="__codelineno-40-428" name="__codelineno-40-428" href="#__codelineno-40-428"></a>
<a id="__codelineno-40-429" name="__codelineno-40-429" href="#__codelineno-40-429"></a>                <span class="c1"># Replace any old Box info in our original dataframe with data available in runners_df</span>
<a id="__codelineno-40-430" name="__codelineno-40-430" href="#__codelineno-40-430"></a>                <span class="n">runners_df</span> <span class="o">=</span> <span class="n">runners_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;runner_name&#39;</span><span class="p">)</span>
<a id="__codelineno-40-431" name="__codelineno-40-431" href="#__codelineno-40-431"></a>                <span class="n">todays_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">runners_df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">runners_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">dog_names</span><span class="p">)],</span><span class="n">track</span><span class="p">,</span><span class="n">race_number</span><span class="p">),</span><span class="s1">&#39;Box&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">runners_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">runners_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">dog_names</span><span class="p">),</span><span class="s1">&#39;Box&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
<a id="__codelineno-40-432" name="__codelineno-40-432" href="#__codelineno-40-432"></a>                <span class="c1"># Merge box_win_percentage back on:</span>
<a id="__codelineno-40-433" name="__codelineno-40-433" href="#__codelineno-40-433"></a>                <span class="n">todays_data</span> <span class="o">=</span> <span class="n">todays_data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="s1">&#39;box_win_percentage&#39;</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-40-434" name="__codelineno-40-434" href="#__codelineno-40-434"></a>                <span class="n">todays_data</span> <span class="o">=</span> <span class="n">todays_data</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">box_win_percent</span><span class="p">,</span> <span class="n">on</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Track&#39;</span><span class="p">,</span> <span class="s1">&#39;Distance&#39;</span><span class="p">,</span><span class="s1">&#39;Box&#39;</span><span class="p">],</span> <span class="n">how</span> <span class="o">=</span> <span class="s1">&#39;left&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;DogName_bf&#39;</span><span class="p">,</span><span class="s1">&#39;Track&#39;</span><span class="p">,</span><span class="s1">&#39;RaceNum&#39;</span><span class="p">])</span>
<a id="__codelineno-40-435" name="__codelineno-40-435" href="#__codelineno-40-435"></a>
<a id="__codelineno-40-436" name="__codelineno-40-436" href="#__codelineno-40-436"></a>            <span class="c1"># Generate probabilities using Bruno&#39;s model</span>
<a id="__codelineno-40-437" name="__codelineno-40-437" href="#__codelineno-40-437"></a>            <span class="n">todays_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">dog_names</span><span class="p">,</span><span class="n">track</span><span class="p">,</span><span class="n">race_number</span><span class="p">),</span><span class="s1">&#39;prob_LogisticRegression&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">brunos_model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">todays_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">dog_names</span><span class="p">,</span><span class="n">track</span><span class="p">,</span><span class="n">race_number</span><span class="p">)][</span><span class="n">feature_cols</span><span class="p">])[:,</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-40-438" name="__codelineno-40-438" href="#__codelineno-40-438"></a>            <span class="c1"># renomalise probabilities</span>
<a id="__codelineno-40-439" name="__codelineno-40-439" href="#__codelineno-40-439"></a>            <span class="n">probabilities</span> <span class="o">=</span> <span class="n">todays_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dog_names</span><span class="p">,</span><span class="n">track</span><span class="p">,</span><span class="n">race_number</span><span class="p">][</span><span class="s1">&#39;prob_LogisticRegression&#39;</span><span class="p">]</span>
<a id="__codelineno-40-440" name="__codelineno-40-440" href="#__codelineno-40-440"></a>            <span class="n">todays_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">dog_names</span><span class="p">,</span><span class="n">track</span><span class="p">,</span><span class="n">race_number</span><span class="p">),</span><span class="s1">&#39;renormalised_prob&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">probabilities</span><span class="o">/</span><span class="n">probabilities</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<a id="__codelineno-40-441" name="__codelineno-40-441" href="#__codelineno-40-441"></a>            <span class="c1"># convert probaiblities to ratings</span>
<a id="__codelineno-40-442" name="__codelineno-40-442" href="#__codelineno-40-442"></a>            <span class="n">todays_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">dog_names</span><span class="p">,</span><span class="n">track</span><span class="p">,</span><span class="n">race_number</span><span class="p">),</span><span class="s1">&#39;rating&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">todays_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dog_names</span><span class="p">,</span><span class="n">track</span><span class="p">,</span><span class="n">race_number</span><span class="p">][</span><span class="s1">&#39;renormalised_prob&#39;</span><span class="p">]</span>
<a id="__codelineno-40-443" name="__codelineno-40-443" href="#__codelineno-40-443"></a>
<a id="__codelineno-40-444" name="__codelineno-40-444" href="#__codelineno-40-444"></a>            <span class="c1"># Use both the polling api (market.catalogue) and the streaming api at once:</span>
<a id="__codelineno-40-445" name="__codelineno-40-445" href="#__codelineno-40-445"></a>            <span class="k">for</span> <span class="n">runner_cata</span><span class="p">,</span> <span class="n">runner</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">market</span><span class="o">.</span><span class="n">market_catalogue</span><span class="o">.</span><span class="n">runners</span><span class="p">,</span> <span class="n">market_book</span><span class="o">.</span><span class="n">runners</span><span class="p">):</span>
<a id="__codelineno-40-446" name="__codelineno-40-446" href="#__codelineno-40-446"></a>                <span class="c1"># Check the polling api and streaming api matches up (sometimes it doesn&#39;t)</span>
<a id="__codelineno-40-447" name="__codelineno-40-447" href="#__codelineno-40-447"></a>                <span class="k">if</span> <span class="n">runner_cata</span><span class="o">.</span><span class="n">selection_id</span> <span class="o">==</span> <span class="n">runner</span><span class="o">.</span><span class="n">selection_id</span><span class="p">:</span>
<a id="__codelineno-40-448" name="__codelineno-40-448" href="#__codelineno-40-448"></a>                    <span class="c1"># Get the dog_name from polling api then reference our data for our model rating</span>
<a id="__codelineno-40-449" name="__codelineno-40-449" href="#__codelineno-40-449"></a>                    <span class="n">dog_name</span> <span class="o">=</span> <span class="n">runner_cata</span><span class="o">.</span><span class="n">runner_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
<a id="__codelineno-40-450" name="__codelineno-40-450" href="#__codelineno-40-450"></a>
<a id="__codelineno-40-451" name="__codelineno-40-451" href="#__codelineno-40-451"></a>                    <span class="c1"># Rest is the same as How to Automate III</span>
<a id="__codelineno-40-452" name="__codelineno-40-452" href="#__codelineno-40-452"></a>                    <span class="n">model_price</span> <span class="o">=</span> <span class="n">todays_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dog_name</span><span class="p">,</span><span class="n">track</span><span class="p">,</span><span class="n">race_number</span><span class="p">][</span><span class="s1">&#39;rating&#39;</span><span class="p">]</span>
<a id="__codelineno-40-453" name="__codelineno-40-453" href="#__codelineno-40-453"></a>                    <span class="c1">### If you have an issue such as:</span>
<a id="__codelineno-40-454" name="__codelineno-40-454" href="#__codelineno-40-454"></a>                        <span class="c1"># Unknown error The truth value of a Series is ambiguous. Use a.empty, a.bool(), a.item(), a.any() or a.all().</span>
<a id="__codelineno-40-455" name="__codelineno-40-455" href="#__codelineno-40-455"></a>                        <span class="c1"># Then do model_price = todays_data.loc[dog_name,track,race_number][&#39;rating&#39;].item()</span>
<a id="__codelineno-40-456" name="__codelineno-40-456" href="#__codelineno-40-456"></a>
<a id="__codelineno-40-457" name="__codelineno-40-457" href="#__codelineno-40-457"></a>                    <span class="c1"># Log info before placing bets</span>
<a id="__codelineno-40-458" name="__codelineno-40-458" href="#__codelineno-40-458"></a>                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;dog_name: </span><span class="si">{</span><span class="n">dog_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-40-459" name="__codelineno-40-459" href="#__codelineno-40-459"></a>                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;model_price: </span><span class="si">{</span><span class="n">model_price</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-40-460" name="__codelineno-40-460" href="#__codelineno-40-460"></a>                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;market_id: </span><span class="si">{</span><span class="n">market_book</span><span class="o">.</span><span class="n">market_id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-40-461" name="__codelineno-40-461" href="#__codelineno-40-461"></a>                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;selection_id: </span><span class="si">{</span><span class="n">runner</span><span class="o">.</span><span class="n">selection_id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-40-462" name="__codelineno-40-462" href="#__codelineno-40-462"></a>
<a id="__codelineno-40-463" name="__codelineno-40-463" href="#__codelineno-40-463"></a>                    <span class="c1"># If best available to back price is &amp;gt; rated price then flat $5 back</span>
<a id="__codelineno-40-464" name="__codelineno-40-464" href="#__codelineno-40-464"></a>                    <span class="k">if</span> <span class="n">runner</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;ACTIVE&quot;</span> <span class="ow">and</span> <span class="n">runner</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">available_to_back</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;price&#39;</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="n">model_price</span><span class="p">:</span>
<a id="__codelineno-40-465" name="__codelineno-40-465" href="#__codelineno-40-465"></a>                        <span class="n">trade</span> <span class="o">=</span> <span class="n">Trade</span><span class="p">(</span>
<a id="__codelineno-40-466" name="__codelineno-40-466" href="#__codelineno-40-466"></a>                        <span class="n">market_id</span><span class="o">=</span><span class="n">market_book</span><span class="o">.</span><span class="n">market_id</span><span class="p">,</span>
<a id="__codelineno-40-467" name="__codelineno-40-467" href="#__codelineno-40-467"></a>                        <span class="n">selection_id</span><span class="o">=</span><span class="n">runner</span><span class="o">.</span><span class="n">selection_id</span><span class="p">,</span>
<a id="__codelineno-40-468" name="__codelineno-40-468" href="#__codelineno-40-468"></a>                        <span class="n">handicap</span><span class="o">=</span><span class="n">runner</span><span class="o">.</span><span class="n">handicap</span><span class="p">,</span>
<a id="__codelineno-40-469" name="__codelineno-40-469" href="#__codelineno-40-469"></a>                        <span class="n">strategy</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-40-470" name="__codelineno-40-470" href="#__codelineno-40-470"></a>                        <span class="p">)</span>
<a id="__codelineno-40-471" name="__codelineno-40-471" href="#__codelineno-40-471"></a>                        <span class="n">order</span> <span class="o">=</span> <span class="n">trade</span><span class="o">.</span><span class="n">create_order</span><span class="p">(</span>
<a id="__codelineno-40-472" name="__codelineno-40-472" href="#__codelineno-40-472"></a>                            <span class="n">side</span><span class="o">=</span><span class="s2">&quot;BACK&quot;</span><span class="p">,</span> <span class="n">order_type</span><span class="o">=</span><span class="n">LimitOrder</span><span class="p">(</span><span class="n">price</span><span class="o">=</span><span class="n">runner</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">available_to_back</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;price&#39;</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="mf">5.00</span><span class="p">)</span>
<a id="__codelineno-40-473" name="__codelineno-40-473" href="#__codelineno-40-473"></a>                        <span class="p">)</span>
<a id="__codelineno-40-474" name="__codelineno-40-474" href="#__codelineno-40-474"></a>                        <span class="n">market</span><span class="o">.</span><span class="n">place_order</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
<a id="__codelineno-40-475" name="__codelineno-40-475" href="#__codelineno-40-475"></a>                    <span class="c1"># If best available to lay price is &amp;lt; rated price then flat $5 lay</span>
<a id="__codelineno-40-476" name="__codelineno-40-476" href="#__codelineno-40-476"></a>                    <span class="k">if</span> <span class="n">runner</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;ACTIVE&quot;</span> <span class="ow">and</span> <span class="n">runner</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">available_to_lay</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;price&#39;</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span> <span class="n">model_price</span><span class="p">:</span>
<a id="__codelineno-40-477" name="__codelineno-40-477" href="#__codelineno-40-477"></a>                        <span class="n">trade</span> <span class="o">=</span> <span class="n">Trade</span><span class="p">(</span>
<a id="__codelineno-40-478" name="__codelineno-40-478" href="#__codelineno-40-478"></a>                        <span class="n">market_id</span><span class="o">=</span><span class="n">market_book</span><span class="o">.</span><span class="n">market_id</span><span class="p">,</span>
<a id="__codelineno-40-479" name="__codelineno-40-479" href="#__codelineno-40-479"></a>                        <span class="n">selection_id</span><span class="o">=</span><span class="n">runner</span><span class="o">.</span><span class="n">selection_id</span><span class="p">,</span>
<a id="__codelineno-40-480" name="__codelineno-40-480" href="#__codelineno-40-480"></a>                        <span class="n">handicap</span><span class="o">=</span><span class="n">runner</span><span class="o">.</span><span class="n">handicap</span><span class="p">,</span>
<a id="__codelineno-40-481" name="__codelineno-40-481" href="#__codelineno-40-481"></a>                        <span class="n">strategy</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-40-482" name="__codelineno-40-482" href="#__codelineno-40-482"></a>                        <span class="p">)</span>
<a id="__codelineno-40-483" name="__codelineno-40-483" href="#__codelineno-40-483"></a>                        <span class="n">order</span> <span class="o">=</span> <span class="n">trade</span><span class="o">.</span><span class="n">create_order</span><span class="p">(</span>
<a id="__codelineno-40-484" name="__codelineno-40-484" href="#__codelineno-40-484"></a>                            <span class="n">side</span><span class="o">=</span><span class="s2">&quot;LAY&quot;</span><span class="p">,</span> <span class="n">order_type</span><span class="o">=</span><span class="n">LimitOrder</span><span class="p">(</span><span class="n">price</span><span class="o">=</span><span class="n">runner</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">available_to_lay</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;price&#39;</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="mf">5.00</span><span class="p">)</span>
<a id="__codelineno-40-485" name="__codelineno-40-485" href="#__codelineno-40-485"></a>                        <span class="p">)</span>
<a id="__codelineno-40-486" name="__codelineno-40-486" href="#__codelineno-40-486"></a>                        <span class="n">market</span><span class="o">.</span><span class="n">place_order</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
<a id="__codelineno-40-487" name="__codelineno-40-487" href="#__codelineno-40-487"></a>
<a id="__codelineno-40-488" name="__codelineno-40-488" href="#__codelineno-40-488"></a><span class="n">greyhounds_strategy</span> <span class="o">=</span> <span class="n">FlatBetting</span><span class="p">(</span>
<a id="__codelineno-40-489" name="__codelineno-40-489" href="#__codelineno-40-489"></a>    <span class="n">market_filter</span><span class="o">=</span><span class="n">streaming_market_filter</span><span class="p">(</span>
<a id="__codelineno-40-490" name="__codelineno-40-490" href="#__codelineno-40-490"></a>        <span class="n">event_type_ids</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;4339&quot;</span><span class="p">],</span> <span class="c1"># Greyhounds markets</span>
<a id="__codelineno-40-491" name="__codelineno-40-491" href="#__codelineno-40-491"></a>        <span class="n">country_codes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;AU&quot;</span><span class="p">],</span> <span class="c1"># Australian markets</span>
<a id="__codelineno-40-492" name="__codelineno-40-492" href="#__codelineno-40-492"></a>        <span class="n">market_types</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;WIN&quot;</span><span class="p">],</span> <span class="c1"># Win markets</span>
<a id="__codelineno-40-493" name="__codelineno-40-493" href="#__codelineno-40-493"></a>    <span class="p">),</span>
<a id="__codelineno-40-494" name="__codelineno-40-494" href="#__codelineno-40-494"></a>    <span class="n">max_order_exposure</span><span class="o">=</span> <span class="mi">50</span><span class="p">,</span> <span class="c1"># Max exposure per order = 50</span>
<a id="__codelineno-40-495" name="__codelineno-40-495" href="#__codelineno-40-495"></a>    <span class="n">max_trade_count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="c1"># Max 1 trade per selection</span>
<a id="__codelineno-40-496" name="__codelineno-40-496" href="#__codelineno-40-496"></a>    <span class="n">max_live_trade_count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="c1"># Max 1 unmatched trade per selection</span>
<a id="__codelineno-40-497" name="__codelineno-40-497" href="#__codelineno-40-497"></a><span class="p">)</span>
<a id="__codelineno-40-498" name="__codelineno-40-498" href="#__codelineno-40-498"></a>
<a id="__codelineno-40-499" name="__codelineno-40-499" href="#__codelineno-40-499"></a><span class="n">framework</span><span class="o">.</span><span class="n">add_strategy</span><span class="p">(</span><span class="n">greyhounds_strategy</span><span class="p">)</span>
<a id="__codelineno-40-500" name="__codelineno-40-500" href="#__codelineno-40-500"></a>
<a id="__codelineno-40-501" name="__codelineno-40-501" href="#__codelineno-40-501"></a><span class="c1"># logger = logging.getLogger(__name__)</span>
<a id="__codelineno-40-502" name="__codelineno-40-502" href="#__codelineno-40-502"></a>
<a id="__codelineno-40-503" name="__codelineno-40-503" href="#__codelineno-40-503"></a><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-40-504" name="__codelineno-40-504" href="#__codelineno-40-504"></a><span class="sd">Worker can be used as followed:</span>
<a id="__codelineno-40-505" name="__codelineno-40-505" href="#__codelineno-40-505"></a><span class="sd">    framework.add_worker(</span>
<a id="__codelineno-40-506" name="__codelineno-40-506" href="#__codelineno-40-506"></a><span class="sd">        BackgroundWorker(</span>
<a id="__codelineno-40-507" name="__codelineno-40-507" href="#__codelineno-40-507"></a><span class="sd">            framework,</span>
<a id="__codelineno-40-508" name="__codelineno-40-508" href="#__codelineno-40-508"></a><span class="sd">            terminate,</span>
<a id="__codelineno-40-509" name="__codelineno-40-509" href="#__codelineno-40-509"></a><span class="sd">            func_kwargs={&quot;today_only&quot;: True, &quot;seconds_closed&quot;: 1200},</span>
<a id="__codelineno-40-510" name="__codelineno-40-510" href="#__codelineno-40-510"></a><span class="sd">            interval=60,</span>
<a id="__codelineno-40-511" name="__codelineno-40-511" href="#__codelineno-40-511"></a><span class="sd">            start_delay=60,</span>
<a id="__codelineno-40-512" name="__codelineno-40-512" href="#__codelineno-40-512"></a><span class="sd">        )</span>
<a id="__codelineno-40-513" name="__codelineno-40-513" href="#__codelineno-40-513"></a><span class="sd">    )</span>
<a id="__codelineno-40-514" name="__codelineno-40-514" href="#__codelineno-40-514"></a><span class="sd">This will run every 60s and will terminate </span>
<a id="__codelineno-40-515" name="__codelineno-40-515" href="#__codelineno-40-515"></a><span class="sd">the framework if all markets starting &#39;today&#39; </span>
<a id="__codelineno-40-516" name="__codelineno-40-516" href="#__codelineno-40-516"></a><span class="sd">have been closed for at least 1200s</span>
<a id="__codelineno-40-517" name="__codelineno-40-517" href="#__codelineno-40-517"></a><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-40-518" name="__codelineno-40-518" href="#__codelineno-40-518"></a>
<a id="__codelineno-40-519" name="__codelineno-40-519" href="#__codelineno-40-519"></a>
<a id="__codelineno-40-520" name="__codelineno-40-520" href="#__codelineno-40-520"></a><span class="c1"># Function that stops automation running at the end of the day</span>
<a id="__codelineno-40-521" name="__codelineno-40-521" href="#__codelineno-40-521"></a><span class="k">def</span><span class="w"> </span><span class="nf">terminate</span><span class="p">(</span>
<a id="__codelineno-40-522" name="__codelineno-40-522" href="#__codelineno-40-522"></a>    <span class="n">context</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">flumine</span><span class="p">,</span> <span class="n">today_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">seconds_closed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">600</span>
<a id="__codelineno-40-523" name="__codelineno-40-523" href="#__codelineno-40-523"></a><span class="p">)</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-40-524" name="__codelineno-40-524" href="#__codelineno-40-524"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;terminate framework if no markets</span>
<a id="__codelineno-40-525" name="__codelineno-40-525" href="#__codelineno-40-525"></a><span class="sd">    live today.</span>
<a id="__codelineno-40-526" name="__codelineno-40-526" href="#__codelineno-40-526"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-40-527" name="__codelineno-40-527" href="#__codelineno-40-527"></a>    <span class="n">markets</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">flumine</span><span class="o">.</span><span class="n">markets</span><span class="o">.</span><span class="n">markets</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
<a id="__codelineno-40-528" name="__codelineno-40-528" href="#__codelineno-40-528"></a>    <span class="n">markets_today</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-40-529" name="__codelineno-40-529" href="#__codelineno-40-529"></a>        <span class="n">m</span>
<a id="__codelineno-40-530" name="__codelineno-40-530" href="#__codelineno-40-530"></a>        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">markets</span>
<a id="__codelineno-40-531" name="__codelineno-40-531" href="#__codelineno-40-531"></a>        <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">market_start_datetime</span><span class="o">.</span><span class="n">date</span><span class="p">()</span> <span class="o">==</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
<a id="__codelineno-40-532" name="__codelineno-40-532" href="#__codelineno-40-532"></a>        <span class="ow">and</span> <span class="p">(</span>
<a id="__codelineno-40-533" name="__codelineno-40-533" href="#__codelineno-40-533"></a>            <span class="n">m</span><span class="o">.</span><span class="n">elapsed_seconds_closed</span> <span class="ow">is</span> <span class="kc">None</span>
<a id="__codelineno-40-534" name="__codelineno-40-534" href="#__codelineno-40-534"></a>            <span class="ow">or</span> <span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">elapsed_seconds_closed</span> <span class="ow">and</span> <span class="n">m</span><span class="o">.</span><span class="n">elapsed_seconds_closed</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span> <span class="n">seconds_closed</span><span class="p">)</span>
<a id="__codelineno-40-535" name="__codelineno-40-535" href="#__codelineno-40-535"></a>        <span class="p">)</span>
<a id="__codelineno-40-536" name="__codelineno-40-536" href="#__codelineno-40-536"></a>    <span class="p">]</span>
<a id="__codelineno-40-537" name="__codelineno-40-537" href="#__codelineno-40-537"></a>    <span class="k">if</span> <span class="n">today_only</span><span class="p">:</span>
<a id="__codelineno-40-538" name="__codelineno-40-538" href="#__codelineno-40-538"></a>        <span class="n">market_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">markets_today</span><span class="p">)</span>
<a id="__codelineno-40-539" name="__codelineno-40-539" href="#__codelineno-40-539"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-40-540" name="__codelineno-40-540" href="#__codelineno-40-540"></a>        <span class="n">market_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">markets</span><span class="p">)</span>
<a id="__codelineno-40-541" name="__codelineno-40-541" href="#__codelineno-40-541"></a>    <span class="k">if</span> <span class="n">market_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-40-542" name="__codelineno-40-542" href="#__codelineno-40-542"></a>        <span class="c1"># logger.info(&quot;No more markets available, terminating framework&quot;)</span>
<a id="__codelineno-40-543" name="__codelineno-40-543" href="#__codelineno-40-543"></a>        <span class="n">flumine</span><span class="o">.</span><span class="n">handler_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">TerminationEvent</span><span class="p">(</span><span class="n">flumine</span><span class="p">))</span>
<a id="__codelineno-40-544" name="__codelineno-40-544" href="#__codelineno-40-544"></a>
<a id="__codelineno-40-545" name="__codelineno-40-545" href="#__codelineno-40-545"></a><span class="c1"># Add the stopped to our framework</span>
<a id="__codelineno-40-546" name="__codelineno-40-546" href="#__codelineno-40-546"></a><span class="n">framework</span><span class="o">.</span><span class="n">add_worker</span><span class="p">(</span>
<a id="__codelineno-40-547" name="__codelineno-40-547" href="#__codelineno-40-547"></a>    <span class="n">BackgroundWorker</span><span class="p">(</span>
<a id="__codelineno-40-548" name="__codelineno-40-548" href="#__codelineno-40-548"></a>        <span class="n">framework</span><span class="p">,</span>
<a id="__codelineno-40-549" name="__codelineno-40-549" href="#__codelineno-40-549"></a>        <span class="n">terminate</span><span class="p">,</span>
<a id="__codelineno-40-550" name="__codelineno-40-550" href="#__codelineno-40-550"></a>        <span class="n">func_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;today_only&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;seconds_closed&quot;</span><span class="p">:</span> <span class="mi">1200</span><span class="p">},</span>
<a id="__codelineno-40-551" name="__codelineno-40-551" href="#__codelineno-40-551"></a>        <span class="n">interval</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
<a id="__codelineno-40-552" name="__codelineno-40-552" href="#__codelineno-40-552"></a>        <span class="n">start_delay</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
<a id="__codelineno-40-553" name="__codelineno-40-553" href="#__codelineno-40-553"></a>    <span class="p">)</span>
<a id="__codelineno-40-554" name="__codelineno-40-554" href="#__codelineno-40-554"></a><span class="p">)</span>
<a id="__codelineno-40-555" name="__codelineno-40-555" href="#__codelineno-40-555"></a>
<a id="__codelineno-40-556" name="__codelineno-40-556" href="#__codelineno-40-556"></a><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<a id="__codelineno-40-557" name="__codelineno-40-557" href="#__codelineno-40-557"></a>
<a id="__codelineno-40-558" name="__codelineno-40-558" href="#__codelineno-40-558"></a><span class="n">FIELDNAMES</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-40-559" name="__codelineno-40-559" href="#__codelineno-40-559"></a>    <span class="s2">&quot;bet_id&quot;</span><span class="p">,</span>
<a id="__codelineno-40-560" name="__codelineno-40-560" href="#__codelineno-40-560"></a>    <span class="s2">&quot;strategy_name&quot;</span><span class="p">,</span>
<a id="__codelineno-40-561" name="__codelineno-40-561" href="#__codelineno-40-561"></a>    <span class="s2">&quot;market_id&quot;</span><span class="p">,</span>
<a id="__codelineno-40-562" name="__codelineno-40-562" href="#__codelineno-40-562"></a>    <span class="s2">&quot;selection_id&quot;</span><span class="p">,</span>
<a id="__codelineno-40-563" name="__codelineno-40-563" href="#__codelineno-40-563"></a>    <span class="s2">&quot;trade_id&quot;</span><span class="p">,</span>
<a id="__codelineno-40-564" name="__codelineno-40-564" href="#__codelineno-40-564"></a>    <span class="s2">&quot;date_time_placed&quot;</span><span class="p">,</span>
<a id="__codelineno-40-565" name="__codelineno-40-565" href="#__codelineno-40-565"></a>    <span class="s2">&quot;price&quot;</span><span class="p">,</span>
<a id="__codelineno-40-566" name="__codelineno-40-566" href="#__codelineno-40-566"></a>    <span class="s2">&quot;price_matched&quot;</span><span class="p">,</span>
<a id="__codelineno-40-567" name="__codelineno-40-567" href="#__codelineno-40-567"></a>    <span class="s2">&quot;size&quot;</span><span class="p">,</span>
<a id="__codelineno-40-568" name="__codelineno-40-568" href="#__codelineno-40-568"></a>    <span class="s2">&quot;size_matched&quot;</span><span class="p">,</span>
<a id="__codelineno-40-569" name="__codelineno-40-569" href="#__codelineno-40-569"></a>    <span class="s2">&quot;profit&quot;</span><span class="p">,</span>
<a id="__codelineno-40-570" name="__codelineno-40-570" href="#__codelineno-40-570"></a>    <span class="s2">&quot;side&quot;</span><span class="p">,</span>
<a id="__codelineno-40-571" name="__codelineno-40-571" href="#__codelineno-40-571"></a>    <span class="s2">&quot;elapsed_seconds_executable&quot;</span><span class="p">,</span>
<a id="__codelineno-40-572" name="__codelineno-40-572" href="#__codelineno-40-572"></a>    <span class="s2">&quot;order_status&quot;</span><span class="p">,</span>
<a id="__codelineno-40-573" name="__codelineno-40-573" href="#__codelineno-40-573"></a>    <span class="s2">&quot;market_note&quot;</span><span class="p">,</span>
<a id="__codelineno-40-574" name="__codelineno-40-574" href="#__codelineno-40-574"></a>    <span class="s2">&quot;trade_notes&quot;</span><span class="p">,</span>
<a id="__codelineno-40-575" name="__codelineno-40-575" href="#__codelineno-40-575"></a>    <span class="s2">&quot;order_notes&quot;</span><span class="p">,</span>
<a id="__codelineno-40-576" name="__codelineno-40-576" href="#__codelineno-40-576"></a><span class="p">]</span>
<a id="__codelineno-40-577" name="__codelineno-40-577" href="#__codelineno-40-577"></a>
<a id="__codelineno-40-578" name="__codelineno-40-578" href="#__codelineno-40-578"></a>
<a id="__codelineno-40-579" name="__codelineno-40-579" href="#__codelineno-40-579"></a><span class="k">class</span><span class="w"> </span><span class="nc">LiveLoggingControl</span><span class="p">(</span><span class="n">LoggingControl</span><span class="p">):</span>
<a id="__codelineno-40-580" name="__codelineno-40-580" href="#__codelineno-40-580"></a>    <span class="n">NAME</span> <span class="o">=</span> <span class="s2">&quot;BACKTEST_LOGGING_CONTROL&quot;</span>
<a id="__codelineno-40-581" name="__codelineno-40-581" href="#__codelineno-40-581"></a>
<a id="__codelineno-40-582" name="__codelineno-40-582" href="#__codelineno-40-582"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-40-583" name="__codelineno-40-583" href="#__codelineno-40-583"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">LiveLoggingControl</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-40-584" name="__codelineno-40-584" href="#__codelineno-40-584"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_setup</span><span class="p">()</span>
<a id="__codelineno-40-585" name="__codelineno-40-585" href="#__codelineno-40-585"></a>
<a id="__codelineno-40-586" name="__codelineno-40-586" href="#__codelineno-40-586"></a>    <span class="c1"># Changed file path and checks if the file orders_hta_4.csv already exists, if it doens&#39;t then create it</span>
<a id="__codelineno-40-587" name="__codelineno-40-587" href="#__codelineno-40-587"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-40-588" name="__codelineno-40-588" href="#__codelineno-40-588"></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;orders_hta_4.csv&quot;</span><span class="p">):</span>
<a id="__codelineno-40-589" name="__codelineno-40-589" href="#__codelineno-40-589"></a>            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Results file exists&quot;</span><span class="p">)</span>
<a id="__codelineno-40-590" name="__codelineno-40-590" href="#__codelineno-40-590"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-40-591" name="__codelineno-40-591" href="#__codelineno-40-591"></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;orders_hta_4.csv&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">m</span><span class="p">:</span>
<a id="__codelineno-40-592" name="__codelineno-40-592" href="#__codelineno-40-592"></a>                <span class="n">csv_writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictWriter</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">fieldnames</span><span class="o">=</span><span class="n">FIELDNAMES</span><span class="p">)</span>
<a id="__codelineno-40-593" name="__codelineno-40-593" href="#__codelineno-40-593"></a>                <span class="n">csv_writer</span><span class="o">.</span><span class="n">writeheader</span><span class="p">()</span>
<a id="__codelineno-40-594" name="__codelineno-40-594" href="#__codelineno-40-594"></a>
<a id="__codelineno-40-595" name="__codelineno-40-595" href="#__codelineno-40-595"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_process_cleared_orders_meta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
<a id="__codelineno-40-596" name="__codelineno-40-596" href="#__codelineno-40-596"></a>        <span class="n">orders</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">event</span>
<a id="__codelineno-40-597" name="__codelineno-40-597" href="#__codelineno-40-597"></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;orders_hta_4.csv&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">m</span><span class="p">:</span>
<a id="__codelineno-40-598" name="__codelineno-40-598" href="#__codelineno-40-598"></a>            <span class="k">for</span> <span class="n">order</span> <span class="ow">in</span> <span class="n">orders</span><span class="p">:</span>
<a id="__codelineno-40-599" name="__codelineno-40-599" href="#__codelineno-40-599"></a>                <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">order_type</span><span class="o">.</span><span class="n">ORDER_TYPE</span> <span class="o">==</span> <span class="n">OrderTypes</span><span class="o">.</span><span class="n">LIMIT</span><span class="p">:</span>
<a id="__codelineno-40-600" name="__codelineno-40-600" href="#__codelineno-40-600"></a>                    <span class="n">size</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">order_type</span><span class="o">.</span><span class="n">size</span>
<a id="__codelineno-40-601" name="__codelineno-40-601" href="#__codelineno-40-601"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-40-602" name="__codelineno-40-602" href="#__codelineno-40-602"></a>                    <span class="n">size</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">order_type</span><span class="o">.</span><span class="n">liability</span>
<a id="__codelineno-40-603" name="__codelineno-40-603" href="#__codelineno-40-603"></a>                <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">order_type</span><span class="o">.</span><span class="n">ORDER_TYPE</span> <span class="o">==</span> <span class="n">OrderTypes</span><span class="o">.</span><span class="n">MARKET_ON_CLOSE</span><span class="p">:</span>
<a id="__codelineno-40-604" name="__codelineno-40-604" href="#__codelineno-40-604"></a>                    <span class="n">price</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-40-605" name="__codelineno-40-605" href="#__codelineno-40-605"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-40-606" name="__codelineno-40-606" href="#__codelineno-40-606"></a>                    <span class="n">price</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">order_type</span><span class="o">.</span><span class="n">price</span>
<a id="__codelineno-40-607" name="__codelineno-40-607" href="#__codelineno-40-607"></a>                <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-40-608" name="__codelineno-40-608" href="#__codelineno-40-608"></a>                    <span class="n">order_data</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-40-609" name="__codelineno-40-609" href="#__codelineno-40-609"></a>                        <span class="s2">&quot;bet_id&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">bet_id</span><span class="p">,</span>
<a id="__codelineno-40-610" name="__codelineno-40-610" href="#__codelineno-40-610"></a>                        <span class="s2">&quot;strategy_name&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">trade</span><span class="o">.</span><span class="n">strategy</span><span class="p">,</span>
<a id="__codelineno-40-611" name="__codelineno-40-611" href="#__codelineno-40-611"></a>                        <span class="s2">&quot;market_id&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">market_id</span><span class="p">,</span>
<a id="__codelineno-40-612" name="__codelineno-40-612" href="#__codelineno-40-612"></a>                        <span class="s2">&quot;selection_id&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">selection_id</span><span class="p">,</span>
<a id="__codelineno-40-613" name="__codelineno-40-613" href="#__codelineno-40-613"></a>                        <span class="s2">&quot;trade_id&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">trade</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
<a id="__codelineno-40-614" name="__codelineno-40-614" href="#__codelineno-40-614"></a>                        <span class="s2">&quot;date_time_placed&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">responses</span><span class="o">.</span><span class="n">date_time_placed</span><span class="p">,</span>
<a id="__codelineno-40-615" name="__codelineno-40-615" href="#__codelineno-40-615"></a>                        <span class="s2">&quot;price&quot;</span><span class="p">:</span> <span class="n">price</span><span class="p">,</span>
<a id="__codelineno-40-616" name="__codelineno-40-616" href="#__codelineno-40-616"></a>                        <span class="s2">&quot;price_matched&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">average_price_matched</span><span class="p">,</span>
<a id="__codelineno-40-617" name="__codelineno-40-617" href="#__codelineno-40-617"></a>                        <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="n">size</span><span class="p">,</span>
<a id="__codelineno-40-618" name="__codelineno-40-618" href="#__codelineno-40-618"></a>                        <span class="s2">&quot;size_matched&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">size_matched</span><span class="p">,</span>
<a id="__codelineno-40-619" name="__codelineno-40-619" href="#__codelineno-40-619"></a>                        <span class="s2">&quot;profit&quot;</span><span class="p">:</span> <span class="mi">0</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">order</span><span class="o">.</span><span class="n">cleared_order</span> <span class="k">else</span> <span class="n">order</span><span class="o">.</span><span class="n">cleared_order</span><span class="o">.</span><span class="n">profit</span><span class="p">,</span>
<a id="__codelineno-40-620" name="__codelineno-40-620" href="#__codelineno-40-620"></a>                        <span class="s2">&quot;side&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">side</span><span class="p">,</span>
<a id="__codelineno-40-621" name="__codelineno-40-621" href="#__codelineno-40-621"></a>                        <span class="s2">&quot;elapsed_seconds_executable&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">elapsed_seconds_executable</span><span class="p">,</span>
<a id="__codelineno-40-622" name="__codelineno-40-622" href="#__codelineno-40-622"></a>                        <span class="s2">&quot;order_status&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
<a id="__codelineno-40-623" name="__codelineno-40-623" href="#__codelineno-40-623"></a>                        <span class="s2">&quot;market_note&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">trade</span><span class="o">.</span><span class="n">market_notes</span><span class="p">,</span>
<a id="__codelineno-40-624" name="__codelineno-40-624" href="#__codelineno-40-624"></a>                        <span class="s2">&quot;trade_notes&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">trade</span><span class="o">.</span><span class="n">notes_str</span><span class="p">,</span>
<a id="__codelineno-40-625" name="__codelineno-40-625" href="#__codelineno-40-625"></a>                        <span class="s2">&quot;order_notes&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">notes_str</span><span class="p">,</span>
<a id="__codelineno-40-626" name="__codelineno-40-626" href="#__codelineno-40-626"></a>                    <span class="p">}</span>
<a id="__codelineno-40-627" name="__codelineno-40-627" href="#__codelineno-40-627"></a>                    <span class="n">csv_writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictWriter</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">fieldnames</span><span class="o">=</span><span class="n">FIELDNAMES</span><span class="p">)</span>
<a id="__codelineno-40-628" name="__codelineno-40-628" href="#__codelineno-40-628"></a>                    <span class="n">csv_writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">order_data</span><span class="p">)</span>
<a id="__codelineno-40-629" name="__codelineno-40-629" href="#__codelineno-40-629"></a>                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-40-630" name="__codelineno-40-630" href="#__codelineno-40-630"></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-40-631" name="__codelineno-40-631" href="#__codelineno-40-631"></a>                        <span class="s2">&quot;_process_cleared_orders_meta: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">,</span>
<a id="__codelineno-40-632" name="__codelineno-40-632" href="#__codelineno-40-632"></a>                        <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;order&quot;</span><span class="p">:</span> <span class="n">order</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">e</span><span class="p">},</span>
<a id="__codelineno-40-633" name="__codelineno-40-633" href="#__codelineno-40-633"></a>                    <span class="p">)</span>
<a id="__codelineno-40-634" name="__codelineno-40-634" href="#__codelineno-40-634"></a>
<a id="__codelineno-40-635" name="__codelineno-40-635" href="#__codelineno-40-635"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Orders updated&quot;</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;order_count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">orders</span><span class="p">)})</span>
<a id="__codelineno-40-636" name="__codelineno-40-636" href="#__codelineno-40-636"></a>
<a id="__codelineno-40-637" name="__codelineno-40-637" href="#__codelineno-40-637"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_process_cleared_markets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
<a id="__codelineno-40-638" name="__codelineno-40-638" href="#__codelineno-40-638"></a>        <span class="n">cleared_markets</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">event</span>
<a id="__codelineno-40-639" name="__codelineno-40-639" href="#__codelineno-40-639"></a>        <span class="k">for</span> <span class="n">cleared_market</span> <span class="ow">in</span> <span class="n">cleared_markets</span><span class="o">.</span><span class="n">orders</span><span class="p">:</span>
<a id="__codelineno-40-640" name="__codelineno-40-640" href="#__codelineno-40-640"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-40-641" name="__codelineno-40-641" href="#__codelineno-40-641"></a>                <span class="s2">&quot;Cleared market&quot;</span><span class="p">,</span>
<a id="__codelineno-40-642" name="__codelineno-40-642" href="#__codelineno-40-642"></a>                <span class="n">extra</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-40-643" name="__codelineno-40-643" href="#__codelineno-40-643"></a>                    <span class="s2">&quot;market_id&quot;</span><span class="p">:</span> <span class="n">cleared_market</span><span class="o">.</span><span class="n">market_id</span><span class="p">,</span>
<a id="__codelineno-40-644" name="__codelineno-40-644" href="#__codelineno-40-644"></a>                    <span class="s2">&quot;bet_count&quot;</span><span class="p">:</span> <span class="n">cleared_market</span><span class="o">.</span><span class="n">bet_count</span><span class="p">,</span>
<a id="__codelineno-40-645" name="__codelineno-40-645" href="#__codelineno-40-645"></a>                    <span class="s2">&quot;profit&quot;</span><span class="p">:</span> <span class="n">cleared_market</span><span class="o">.</span><span class="n">profit</span><span class="p">,</span>
<a id="__codelineno-40-646" name="__codelineno-40-646" href="#__codelineno-40-646"></a>                    <span class="s2">&quot;commission&quot;</span><span class="p">:</span> <span class="n">cleared_market</span><span class="o">.</span><span class="n">commission</span><span class="p">,</span>
<a id="__codelineno-40-647" name="__codelineno-40-647" href="#__codelineno-40-647"></a>                <span class="p">},</span>
<a id="__codelineno-40-648" name="__codelineno-40-648" href="#__codelineno-40-648"></a>            <span class="p">)</span>
<a id="__codelineno-40-649" name="__codelineno-40-649" href="#__codelineno-40-649"></a>
<a id="__codelineno-40-650" name="__codelineno-40-650" href="#__codelineno-40-650"></a><span class="n">framework</span><span class="o">.</span><span class="n">add_logging_control</span><span class="p">(</span>
<a id="__codelineno-40-651" name="__codelineno-40-651" href="#__codelineno-40-651"></a>    <span class="n">LiveLoggingControl</span><span class="p">()</span>
<a id="__codelineno-40-652" name="__codelineno-40-652" href="#__codelineno-40-652"></a><span class="p">)</span>
<a id="__codelineno-40-653" name="__codelineno-40-653" href="#__codelineno-40-653"></a>
<a id="__codelineno-40-654" name="__codelineno-40-654" href="#__codelineno-40-654"></a><span class="n">framework</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</code></pre></div>

</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<hr />
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="disclaimer">Disclaimer</h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Note that whilst models and automated strategies are fun and rewarding to create, we can't promise that your model or betting strategy will be profitable, and we make no representations in relation to the code shared or information on this page. If you're using this code or implementing your own strategies, you do so entirely at your own risk and you are responsible for any winnings/losses incurred. Under no circumstances will Betfair be liable for any loss or damage you suffer.</p>
</div>
</div>
</div>









  




                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
    
    <div class="md-footer-meta md-typeset">
      <div class="md-footer-meta__inner md-grid">
        <div class="md-copyright">
  
  
</div>
        
          <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://twitter.com/Betfair_Aus" target="_blank" rel="noopener" title="twitter.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://linkedin.com/company/betfair-australia" target="_blank" rel="noopener" title="linkedin.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3M135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5m282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://facebook.com/betfairaustralia" target="_blank" rel="noopener" title="facebook.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M512 256C512 114.6 397.4 0 256 0S0 114.6 0 256c0 120 82.7 220.8 194.2 248.5V334.2h-52.8V256h52.8v-33.7c0-87.1 39.4-127.5 125-127.5 16.2 0 44.2 3.2 55.7 6.4V172c-6-.6-16.5-1-29.6-1-42 0-58.2 15.9-58.2 57.2V256h83.6l-14.4 78.2H287v175.9C413.8 494.8 512 386.9 512 256"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://youtube.com/user/betfairaus" target="_blank" rel="noopener" title="youtube.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M549.655 124.083c-6.281-23.65-24.787-42.276-48.284-48.597C458.781 64 288 64 288 64S117.22 64 74.629 75.486c-23.497 6.322-42.003 24.947-48.284 48.597-11.412 42.867-11.412 132.305-11.412 132.305s0 89.438 11.412 132.305c6.281 23.65 24.787 41.5 48.284 47.821C117.22 448 288 448 288 448s170.78 0 213.371-11.486c23.497-6.321 42.003-24.171 48.284-47.821 11.412-42.867 11.412-132.305 11.412-132.305s0-89.438-11.412-132.305m-317.51 213.508V175.185l142.739 81.205z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://github.com/betfair-datascientists" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
</div>
        
      </div>

      <div class="bf-footer">
          <div class="bf-footer-inner">
              <p class="bf-light">Betfair Pty Limited is licensed and regulated by the Northern Territory Government of Australia.</p>
              <p class="bf-dark">Betfair Pty Limited's gambling operations are governed by its <a class='inner-link' href="https://www.betfair.com.au/info/responsible-gambling/">Responsible Gambling Code of Conduct</a> and for South
              Australian residents by the <a class='inner-link' href="https://www.betfair.com.au/info/pdf/SA-GCoP.pdf">South Australian Responsible Gambling Code of Practice.</a></p>
              <!-- BetStop block in white box -->
              <div class="full-screen">
                  <p style="font-family: Arial, sans-serif; font-size: 1.2rem; font-weight: bold; text-align: center;">
                    BetStop is the Australian National Self-Exclusion Register. For more information, please visit 
                    <a href="https://betstop.gov.au" style="font-family: Arial, sans-serif; font-size: 1.2rem; font-weight: bold; color: black; text-decoration: none;">
                      https://betstop.gov.au
                    </a>
                  </p>
              </div>
              <br />
              <!-- RG footer block -->
              <div class="full-screen"> <p style="font-family: Arial, sans-serif; font-size: 1.2rem; font-weight: bold; text-align: center;">Imagine what you could be buying instead.</p> <p style="font-family: Arial, sans-serif; font-size: 0.8rem; font-weight: bold; text-align: center;">For free and confidential support call 1800 858 858 or visit <a href="http://www.gamblinghelponline.org.au" style="color: black; text-decoration: underline;">gamblinghelponline.org.au</a></p> </div>
              <ul class="bf-links">
                <li><a href="https://www.betfair.com.au/hub/help/account-help/responsible-gambling/">Responsible Gambling</a><span>|</span></li>
                <li><a href="http://www.betfair.com/AUS_NZL/aboutUs/Terms.and.Conditions/">Terms & Conditions</a><span>|</span></li>
                <li><a href="https://www.betfair.com.au/info/privacy-policy/">Privacy Policy</a><span>|</span></li>
                <li><a href="http://www.betfair.com/en/aboutUs/Rules.and.Regulations/">Rules & Regulations</a><span>|</span></li>
                <li><a href="https://www.betfair.com/AUS_NZL/aboutUs/Dispute.Resolution">Dispute Resolution</a></li>
              </ul>
          </div>
      </div>
    </div>

    <script src="https://js.adsrvr.org/up_loader.1.1.0.js" type="text/javascript"></script>
    <script type="text/javascript">
        ttd_dom_ready( function() {
            if (typeof TTDUniversalPixelApi === 'function') {
                var universalPixelApi = new TTDUniversalPixelApi();
                universalPixelApi.init("y12d1ir", ["8ml4f17"], "https://insight.adsrvr.org/track/up");
            }
        });
    </script>

</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["toc.integrate", "navigation.instant", "navigation.tabs", "navigation.top", "navigation.expand", "navigation.sections", "search.suggest", "search.highlight", "search.share"], "search": "../../assets/javascripts/workers/search.f8cc74c7.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.f1b6f286.min.js"></script>
      
        <script src="../../js/scripts.js"></script>
      
    
  </body>
</html>