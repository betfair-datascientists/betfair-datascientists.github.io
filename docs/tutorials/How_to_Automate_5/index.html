
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Documentation, guides and articles on creating, developing and implementing automated betting strategies, using data analysis to inform betting models and how to interact with the Betfair API.">
      
      
        <meta name="author" content="Betfair Data Scientists">
      
      
        <link rel="canonical" href="https://betfair-datascientists.github.io/tutorials/How_to_Automate_5/">
      
      
        <link rel="prev" href="../How_to_Automate_4/">
      
      
        <link rel="next" href="../processingTarFiles101/">
      
      
      <link rel="icon" href="../../img/BetfairFavicon.ico">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.4.6">
    
    
      
        <title>How to Automate 5 - The Automation Hub</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.35e1ed30.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.356b1318.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/betfair.css">
    
      <link rel="stylesheet" href="../../css/buttons_and_animations.css">
    
      <link rel="stylesheet" href="../../css/fonts.css">
    
      <link rel="stylesheet" href="../../css/ansi-colours.css">
    
      <link rel="stylesheet" href="../../css/jupyter-cells.css">
    
      <link rel="stylesheet" href="../../css/pandas-dataframe.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function n(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],n("js",new Date),n("config","UA-125973915-1"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&n("event","search",{search_term:this.value})}),document$.subscribe(function(){var a=document.forms.feedback;if(void 0!==a)for(var e of a.querySelectorAll("[type=submit]"))e.addEventListener("click",function(e){e.preventDefault();var t=document.location.pathname,e=this.getAttribute("data-md-value");n("event","feedback",{page:t,data:e}),a.firstElementChild.disabled=!0;e=a.querySelector(".md-feedback__note [data-md-value='"+e+"']");e&&(e.hidden=!1)}),a.hidden=!1}),location$.subscribe(function(e){n("config","UA-125973915-1",{page_path:e.pathname})})});var e=document.createElement("script");e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id=UA-125973915-1",document.getElementById("__analytics").insertAdjacentElement("afterEnd",e)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="betfair" data-md-color-primary="amber" data-md-color-accent="orange">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#how-to-automate-5" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      
  
  <header class="md-header" data-md-component="header">
    <nav class="md-header__inner md-grid" aria-label="header.title">
      <a href="../.." title="The Automation Hub" class="md-header__button md-logo" aria-label="The Automation Hub" data-md-component="logo">
        
  <img src="../../img/logo.svg" alt="logo">

      </a>
      <label class="md-header__button md-icon" for="__drawer">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
      </label>
      <div class="md-header__title" data-md-component="header-title">
        <div class="md-header__ellipsis">
          <div class="md-header__topic">
            <span class="md-ellipsis">
              The Automation Hub
            </span>
          </div>
          <div class="md-header__topic" data-md-component="header-topic">
            <span class="md-ellipsis">
              
                How to Automate 5
              
            </span>
          </div>
        </div>
      </div>

      
        <form class="md-header__option" data-md-component="palette">
          
            
            
            <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="betfair" data-md-color-primary="amber" data-md-color-accent="orange"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
            
              <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3 3.19.09m3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95 2.06.05m-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31Z"/></svg>
              </label>
            
          
            
            
            <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="amber" data-md-color-accent="orange"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
            
              <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5c-.84 0-1.65.15-2.39.42L12 2M3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29L3.34 7m.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14L3.36 17M20.65 7l-1.77 3.79a7.023 7.023 0 0 0-2.38-4.15l4.15.36m-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29L20.64 17M12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44L12 22Z"/></svg>
              </label>
            
          
        </form>
      
      

      
     
      <div class="bf-nav">
        <a class="bf-hidable" href="https://www.betfair.com.au/exchange/plus/"><svg class="exchangeLogo" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:cc="http://creativecommons.org/ns#"
          xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 38.775 4.59" width="24" height="17">
          <path class="st1" d="m 160.3,-136.95 v 26" />
          <g transform="translate(18.8,-137.15)">
            <path d="m 2.2901089,126.53441 v 5.20093 H -3.3107216 L 7.4888397,144.33446 18.2884,131.73534 h -5.598633 v -5.20093 z m -8.6000974,8.10132 -10.8017585,12.59913 h 5.60083 v 5.2998 h 10.3996581 v -5.2998 h 5.6008306 z" />
          </g>
        </svg><span> Exchange</span></a>
        <a href="https://www.betfair.com.au/hub/">Hub</a>
      </div>

      

    </nav>
    
  </header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../data/dataListing/" class="md-tabs__link">
          
  
  Data

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../wagering/betfairHowTo/" class="md-tabs__link">
          
  
  Wagering

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../api/apiResources/" class="md-tabs__link">
          
  
  API

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../modelling/SpringRacingDatathon/" class="md-tabs__link">
          
  
  Modelling

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../automation/GoldenRulesofAutomation/" class="md-tabs__link">
          
  
  Automation

        </a>
      </li>
    
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../How_to_Automate_1/" class="md-tabs__link">
          
  
  Tutorials

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../mentalGame/intro/" class="md-tabs__link">
          
  
  Mental Game

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../contactUs/test/" class="md-tabs__link">
          
  
  Contact Us

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="The Automation Hub" class="md-nav__button md-logo" aria-label="The Automation Hub" data-md-component="logo">
      
  <img src="../../img/logo.svg" alt="logo">

    </a>
    The Automation Hub
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Data
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Data
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../data/dataListing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CSV Files
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Wagering
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Wagering
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../wagering/betfairHowTo/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Betfair How-To
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../wagering/bettingGlossary/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Betting Glossary
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../wagering/stakingMethods/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Staking Methods and Bankroll Management
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../wagering/valueAndOdds/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Value and Odds
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../wagering/commission/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Commission and other charges
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  <span class="md-ellipsis">
    API
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            API
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../api/apiResources/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    API resources
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../api/apiappkey/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to access the Betfair API
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../api/apiRtutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    API tutorial in R
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../api/apiPythontutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    API tutorial in Python
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Modelling
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Modelling
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/SpringRacingDatathon/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Spring Racing Data Modelling Competition
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/howToModel/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Intro to modelling
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/dataSources/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Pricing Data Sources
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_4" >
        
          
          <label class="md-nav__link" for="__nav_5_4" id="__nav_5_4_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Racing
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_4">
            <span class="md-nav__icon md-icon"></span>
            Racing
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/fasttrackTutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Greyhound form FastTrack API
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/greyhoundModellingPython/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Greyhound modelling in Python
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_5" >
        
          
          <label class="md-nav__link" for="__nav_5_5" id="__nav_5_5_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Soccer
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_5">
            <span class="md-nav__icon md-icon"></span>
            Soccer
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/soccerModellingELO2022WorldCup/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Soccer modelling tutorial in R for 2022 FIFA World Cup
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/soccerModellingTutorialPython/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Soccer modelling tutorial in Python
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/EPLmlPython/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    EPL ML walk through in Python
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_6" >
        
          
          <label class="md-nav__link" for="__nav_5_6" id="__nav_5_6_label" tabindex="">
            
  
  <span class="md-ellipsis">
    AFL
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_6">
            <span class="md-nav__icon md-icon"></span>
            AFL
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/AFLmodellingPython/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    AFL modelling walk through in Python
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/brownlowModelTutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Modelling the Brownlow Medal in Python
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_7" >
        
          
          <label class="md-nav__link" for="__nav_5_7" id="__nav_5_7_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Tennis
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_7">
            <span class="md-nav__icon md-icon"></span>
            Tennis
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/howToModelTheAusOpen/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to model the Australian Open
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/AusOpenRTutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Aus Open R Tutorial
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/AusOpenPythonTutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Aus Open Python Tutorial
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Automation
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Automation
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/GoldenRulesofAutomation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Golden rules of automation
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/overview/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Tools Overview
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6_3" >
        
          
          <label class="md-nav__link" for="__nav_6_3" id="__nav_6_3_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Bet Angel
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_3">
            <span class="md-nav__icon md-icon"></span>
            Bet Angel
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/betAngel/betAngel/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Overview
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/betAngelbeginners/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Beginner's guide
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/betAngelintermediate/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Intermediate guide
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/betAngeladvanced/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Advanced guide
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/betAngelRatingsAutomation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Ratings auto
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/betAngelMarketFavouriteAutomation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Market fav auto
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/betAngelTippingAutomation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Tipping auto
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/betAngelSimultaneousMarkets/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Simultaneous markets
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/betAngelKellyStake/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Kelly criterion staking
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6_4" >
        
          
          <label class="md-nav__link" for="__nav_6_4" id="__nav_6_4_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Gruss Betting Assistant
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_4">
            <span class="md-nav__icon md-icon"></span>
            Gruss Betting Assistant
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/Gruss/Gruss/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Overview
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/GrussSettingupbasicmarketview/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Setup basic market view and one click betting
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/grussRatingsAutomation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Ratings auto
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/grussMarketFavouriteAutomation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Market fav auto
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/grusslSimultaneousMarkets/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Simultaneous markets
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/grussKellyStake/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Kelly criterion staking
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6_5" >
        
          
          <label class="md-nav__link" for="__nav_6_5" id="__nav_6_5_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Cymatic Trader
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_5">
            <span class="md-nav__icon md-icon"></span>
            Cymatic Trader
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/CymaticTrader/CymaticTrader/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Overview
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/cymaticTraderRatingsAutomation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Ratings auto
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6_6" >
        
          
          <label class="md-nav__link" for="__nav_6_6" id="__nav_6_6_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Geeks Toy
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_6">
            <span class="md-nav__icon md-icon"></span>
            Geeks Toy
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/GeeksToyinstallationandsetup/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Installation and setup
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/GeeksToybasicmarketviewstakingandoneclickbetting/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Setup basic market view and one click betting
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/geeksToyRefreshSettings/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Optimising refresh settings
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6_7" >
        
          
          <label class="md-nav__link" for="__nav_6_7" id="__nav_6_7_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Bet Jet Pro
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_7">
            <span class="md-nav__icon md-icon"></span>
            Bet Jet Pro
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/betJetOverview/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Overview
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" checked>
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Tutorials
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            Tutorials
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../How_to_Automate_1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to Automate 1
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../How_to_Automate_2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to Automate 2
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../How_to_Automate_3/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to Automate 3
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../How_to_Automate_4/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to Automate 4
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    How to Automate 5
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    How to Automate 5
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#set-up" class="md-nav__link">
    Set up
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#how-the-sims-work" class="md-nav__link">
    How the sims work
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#running-sims-how-to-automate-ii" class="md-nav__link">
    Running Sims: How to Automate II
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#running-sims-how-to-automate-iii" class="md-nav__link">
    Running Sims: How to Automate III
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#simulating-how-to-automate-iv" class="md-nav__link">
    Simulating How to Automate IV
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gotta-go-fast" class="md-nav__link">
    Gotta go fast
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#analysing-and-optimising-our-results" class="md-nav__link">
    Analysing and optimising our results
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conclusion-and-next-steps" class="md-nav__link">
    Conclusion and next steps
  </a>
  
    <nav class="md-nav" aria-label="Conclusion and next steps">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#complete-code" class="md-nav__link">
    Complete Code
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#disclaimer" class="md-nav__link">
    Disclaimer
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../processingTarFiles101/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Take away the pain! Processing TAR Files 101
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../jsonToCsvRevisited/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    JSON to CSV | Revisited
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../backtestingRatingsTutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Back testing ratings in Python
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../automatedBettingAnglesTutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Automated betting angles in Python
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../analysingAndPredictingMarketMovements/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Do they know? Analysing Betfair market formation & market movements
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../analysingAndPredictingBSP/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Wisdom of the crowd? Analysing & understanding BSP
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_8" >
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Mental Game
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            Mental Game
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/intro/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Intro
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/roleOfEmotions/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Part 1
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/mapYourEmotions/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Part 2
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/handlingBadVariance/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Part 3
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/winbyBeingGreatatLosing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Part 4
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/correctingyouremotions/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Part 5
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/responsibleGambling/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Part 6
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/InchwormConcept/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Part 7
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/HighExpectations/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Part 8
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/TappingYourIntuition/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Part 9
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_9" >
        
          
          <label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Contact Us
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9">
            <span class="md-nav__icon md-icon"></span>
            Contact Us
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../contactUs/test/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Meet the Team
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="how-to-automate-5">How to Automate 5</h1>
<hr />
<div class="admonition note">
<p class="admonition-title">Before you start</p>
<p>This tutorial follows on from our <a href="../How_to_Automate_1">How to Automate series</a> which stepped through how to create a trading bot for a few different strategies. Make sure you take a look through them first before you start here.</p>
</div>
<p>This is the final part of the How to Automate series (for a while at least). In my previous posts we have created a few different strategies, but I haven't actually backtested or simulated any of them yet. How will do we even know if they have any edge? </p>
<p>Today we test those strategies by running simulations and try to optimise performance.</p>
<p>But how do we test strategies?</p>
<p>One method is to follow the steps shown in this fantastic article: <a href="../backtestingRatingsTutorial">Backtesting wagering models with Betfair JSON stream data</a>. But if you already have access to Betfair historic data or you have reccorded it yourself, you are not making full use of your data. This is because the above method will take all the amazing data thats has been collected and only extract a sliver of data from a few time points.</p>
<p>Flumine is amazing because it can make full use of the entire dataset to simulate the market from when the market is first created to settlement. Instead of looking at the prices at 3 minutes before the race and assuming we get matched we can for example simulate placing a back bet hours before the race starts and replay exactly what happened in that market second by second to see if we would have gotten matched between the time we placed the bet and when the market settles. This is really cool because we might have a really awesome model that is close to being profitable but not quite and we want to optimise it.</p>
<p>This will give us the most realistic back testing available and let us test if we are getting matched for the volume and price we want and if we have any edge at all.</p>
<p>Something that is important to note is that although this is the most realistic backtest you can probably get, it is not 100% accurate. This is because we are simply replaying a market with our orders being added in, we cannot take into account how other market participants react. If we place a huge order e.g. $1000 or more we will likely trigger other peoples bots the market will likely move against us.</p>
<p>But either way, we can still try some really cool things such as testing different time points to place bets without needing to re-extract data each time, change staking methodology or placing bets a few ticks away from the best available prices and hoping it gets matched.</p>
<hr />
<h2 id="set-up">Set up</h2>
<p>Before we get started, although Jupyter Notebook/lab is a quants' favourite tool we need to use a different IDE such as VS Code for our simulation code (feel free to try it out, it didn't work for me and I read a note somewhere about it in the docs, but can't find it anymore). All code files are made available on <a href="https://github.com/betfair-down-under/autoHubTutorials/tree/master">github</a>.</p>
<p>I am going to use the March 2022 Greyhound Pro data and I've provided a sample of that data in the github repo which you can use to follow along, but if your an Australian and New Zealand customer make sure to shoot an email to <a href="&#109;&#97;&#105;&#108;&#116;&#111;&#58;&#100;&#97;&#116;&#97;&#64;&#98;&#101;&#116;&#102;&#97;&#105;&#114;&#46;&#99;&#111;&#109;&#46;&#97;&#117;">&#100;&#97;&#116;&#97;&#64;&#98;&#101;&#116;&#102;&#97;&#105;&#114;&#46;&#99;&#111;&#109;&#46;&#97;&#117;</a>. </p>
<p>Simulation mode in Flumine requires your data to be structured a certain way. So, if you have purchased data you will need it to be extracted formatted so that each market file is within a single file, instead or having files within files within files (default).</p>
<p>You can do it manually, which will take an unimaginable amount of time, but I've written a simple script that will do it for you. But you just need to do few things before you run the script. </p>
<ul>
<li>Take your data that has the .tar extension, mine was 2022_03_MarGreyhoundsPro.tar and extract it using winrar/7zip etc this will create a file named 2022_03_MarGreyhoundsPro</li>
<li>make sure 2022_03_MarGreyhoundsPro is stored in the same location as the data extractor script</li>
<li>create a new empty folder that you want the extracted data to be outputted to, I created output_2022_03_MarGreyhoundsPro</li>
<li>then run the script</li>
</ul>
<div class="highlight"><span class="filename">Extracts and formats the content of .tar files</span><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="c1"># Extracts all the bzip2 files (.bz2) </span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="c1"># contained within the specified output_folder and any sub-folders</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="c1"># and writes them to a file with their market_id as their file name</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="c1"># This will take around 10 mins to run for one month of Pro Greyhound data</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="kn">import</span> <span class="nn">glob</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="kn">import</span> <span class="nn">bz2</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="kn">import</span> <span class="nn">shutil</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="c1"># Folder containing bz2 files or any subfolders with bz2 files</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="hll"><span class="n">input_folder</span> <span class="o">=</span> <span class="s1">&#39;2022_04_AprGreyhoundsPro&#39;</span>  <span class="c1"># change to what you have named your folder e.g. &#39;sample_monthly_data&#39;</span>
</span><a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="c1"># Folder to write our extracted bz2 files to, this folder needs to already be created</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="hll"><span class="n">output_folder</span> <span class="o">=</span> <span class="s1">&#39;output_2022_04_AprGreyhoundsPro&#39;</span>  <span class="c1"># change to what you have named your folder e.g. &#39;sample_monthly_data_output&#39;</span>
</span><a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a><span class="c1"># Returns a list of paths to bz2 files within the input folder and any sub folders</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a><span class="n">files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">iglob</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">input_folder</span><span class="si">}</span><span class="s1">/**/**/**/**/**/*.bz2&#39;</span><span class="p">,</span> <span class="n">recursive</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a><span class="c1"># Extracts each bz2 file and write it to the output folder</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a><span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>    <span class="n">market_id</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="o">-</span><span class="mi">15</span><span class="p">:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">market_id</span><span class="p">)</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>    <span class="k">with</span> <span class="n">bz2</span><span class="o">.</span><span class="n">BZ2File</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">as</span> <span class="n">fr</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">output_folder</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">market_id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span><span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fw</span><span class="p">:</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>        <span class="n">shutil</span><span class="o">.</span><span class="n">copyfileobj</span><span class="p">(</span><span class="n">fr</span><span class="p">,</span><span class="n">fw</span><span class="p">)</span>
</code></pre></div>
<p>Now we are all set up lets run our sim!</p>
<hr />
<h2 id="how-the-sims-work">How the sims work</h2>
<p>Flumine is pretty cool, by default it hooks up to the Betfair API and it will run our strategy on live markets. When we set it to simulation mode we can hook it up to the historic data instead. The historic data is basically photos of the exhange up to every 50ms, in simulation mode Flumine essentially quickly scans through each picture sequentially essentially replaying the market. Just like how you would <code>add_strategy()</code> to Flumine to add a strategy that runs live, you can do the same thing in simulation mode and it will place into the simulated markets it creates.</p>
<p>The coolest thing is, it is super easy to change it to simulation mode:</p>
<div class="highlight"><span class="filename">Setting Flumine to simulation Mode</span><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="c1"># Set Flumine to simulation mode</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="n">client</span> <span class="o">=</span> <span class="n">clients</span><span class="o">.</span><span class="n">SimulatedClient</span><span class="p">()</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="n">framework</span> <span class="o">=</span> <span class="n">FlumineSimulation</span><span class="p">(</span><span class="n">client</span><span class="o">=</span><span class="n">client</span><span class="p">)</span>
</code></pre></div>
<p>and instead of pointing it to markets you want to run your strategy on, you point it to your historic data files instead (as it is quite slow I would also suggest only replaying a subsection of the historic files, you can change that with the listner_kwargs), then just run it as you would any other strategy in Flumine:</p>
<div class="highlight"><span class="filename">Pointing the simulation to the historical files</span><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="c1"># Searches for all betfair data files within the folder sample_monthly_data_output</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="n">data_folder</span> <span class="o">=</span> <span class="s1">&#39;sample_monthly_data_output&#39;</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="n">data_files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">data_folder</span><span class="p">,)</span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="n">data_files</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">data_folder</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">data_files</span><span class="p">]</span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="n">strategy</span> <span class="o">=</span> <span class="n">BackFavStrategy</span><span class="p">(</span>
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a>    <span class="c1"># market_filter selects what portion of the historic data we simulate our strategy on</span>
<a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a>    <span class="c1"># markets selects the list of betfair historic data files</span>
<a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a>    <span class="c1"># market_types specifies the type of markets</span>
<a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a>    <span class="c1"># listener_kwargs specifies the time period we simulate for each market</span>
<a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a>    <span class="n">market_filter</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a><span class="hll">        <span class="s2">&quot;markets&quot;</span><span class="p">:</span> <span class="n">data_files</span><span class="p">,</span>  
</span><a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a>        <span class="s1">&#39;market_types&#39;</span><span class="p">:[</span><span class="s1">&#39;WIN&#39;</span><span class="p">],</span>
<a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a><span class="hll">        <span class="s2">&quot;listener_kwargs&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;inplay&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;seconds_to_start&quot;</span><span class="p">:</span> <span class="mi">80</span><span class="p">},</span>  
</span><a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a>        <span class="p">},</span>
<a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a>    <span class="n">max_order_exposure</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
<a id="__codelineno-2-17" name="__codelineno-2-17" href="#__codelineno-2-17"></a>    <span class="n">max_selection_exposure</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
<a id="__codelineno-2-18" name="__codelineno-2-18" href="#__codelineno-2-18"></a>    <span class="n">max_live_trade_count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-2-19" name="__codelineno-2-19" href="#__codelineno-2-19"></a>    <span class="n">max_trade_count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-2-20" name="__codelineno-2-20" href="#__codelineno-2-20"></a><span class="p">)</span>
<a id="__codelineno-2-21" name="__codelineno-2-21" href="#__codelineno-2-21"></a><span class="c1"># Run our strategy on the simulated market</span>
<a id="__codelineno-2-22" name="__codelineno-2-22" href="#__codelineno-2-22"></a><span class="n">framework</span><span class="o">.</span><span class="n">add_strategy</span><span class="p">(</span><span class="n">strategy</span><span class="p">)</span>
<a id="__codelineno-2-23" name="__codelineno-2-23" href="#__codelineno-2-23"></a><span class="n">framework</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</code></pre></div>
<hr />
<h2 id="running-sims-how-to-automate-ii">Running Sims: How to Automate II</h2>
<p>First off the bat is simulating the strategy we created in How to Automate II. </p>
<p>Its actually pretty easy to simulate using Flumine especially if your strategy doesn't require outside data. In fact almost all our code we previously made can just be copied accross. We just need to set Flumine to simulation mode and point it to our data files instead of at the Betfair API, which is only a few lines of code and once you read it, its pretty self explanatory.</p>
<p>One thing we must remember to do is to add the bet logging code we made in How to Automate II so we can analyse how our strategy went afterwards. I've copied both the changes you need to make and also the complete code, give that bad boy a spin, and it will create a csv file as a log of all bets placed. </p>
<p>A months worth of data will take ages to run (like 8 hours on my slow laptop), but the sample data should only take around 10 mins (we will go into speeding up the sims later).</p>
<div class="tabbed-set tabbed-alternate" data-tabs="1:2"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio" /><input id="__tabbed_1_2" name="__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="__tabbed_1_1">Changes you need to make</label><label for="__tabbed_1_2">Complete Code, changes are at the bottom</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="c1"># Searches for all betfair data files within the folder sample_monthly_data_output</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="n">data_folder</span> <span class="o">=</span> <span class="s1">&#39;sample_monthly_data_output&#39;</span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="n">data_files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">data_folder</span><span class="p">,)</span>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="n">data_files</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">data_folder</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">data_files</span><span class="p">]</span>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a>
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="c1"># Set Flumine to simulation mode</span>
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a><span class="n">client</span> <span class="o">=</span> <span class="n">clients</span><span class="o">.</span><span class="n">SimulatedClient</span><span class="p">()</span>
<a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a><span class="n">framework</span> <span class="o">=</span> <span class="n">FlumineSimulation</span><span class="p">(</span><span class="n">client</span><span class="o">=</span><span class="n">client</span><span class="p">)</span>
<a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a>
<a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a><span class="c1"># Set parameters for our strategy</span>
<a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a><span class="n">strategy</span> <span class="o">=</span> <span class="n">BackFavStrategy</span><span class="p">(</span>
<a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a>    <span class="c1"># market_filter selects what portion of the historic data we simulate our strategy on</span>
<a id="__codelineno-3-13" name="__codelineno-3-13" href="#__codelineno-3-13"></a>    <span class="c1"># markets selects the list of betfair historic data files</span>
<a id="__codelineno-3-14" name="__codelineno-3-14" href="#__codelineno-3-14"></a>    <span class="c1"># market_types specifies the type of markets</span>
<a id="__codelineno-3-15" name="__codelineno-3-15" href="#__codelineno-3-15"></a>    <span class="c1"># listener_kwargs specifies the time period we simulate for each market</span>
<a id="__codelineno-3-16" name="__codelineno-3-16" href="#__codelineno-3-16"></a>    <span class="n">market_filter</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-3-17" name="__codelineno-3-17" href="#__codelineno-3-17"></a>        <span class="s2">&quot;markets&quot;</span><span class="p">:</span> <span class="n">data_files</span><span class="p">,</span>  
<a id="__codelineno-3-18" name="__codelineno-3-18" href="#__codelineno-3-18"></a>        <span class="s1">&#39;market_types&#39;</span><span class="p">:[</span><span class="s1">&#39;WIN&#39;</span><span class="p">],</span>
<a id="__codelineno-3-19" name="__codelineno-3-19" href="#__codelineno-3-19"></a>        <span class="s2">&quot;listener_kwargs&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;inplay&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;seconds_to_start&quot;</span><span class="p">:</span> <span class="mi">80</span><span class="p">},</span>  
<a id="__codelineno-3-20" name="__codelineno-3-20" href="#__codelineno-3-20"></a>        <span class="p">},</span>
<a id="__codelineno-3-21" name="__codelineno-3-21" href="#__codelineno-3-21"></a>    <span class="n">max_order_exposure</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
<a id="__codelineno-3-22" name="__codelineno-3-22" href="#__codelineno-3-22"></a>    <span class="n">max_selection_exposure</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
<a id="__codelineno-3-23" name="__codelineno-3-23" href="#__codelineno-3-23"></a>    <span class="n">max_live_trade_count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-3-24" name="__codelineno-3-24" href="#__codelineno-3-24"></a>    <span class="n">max_trade_count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-3-25" name="__codelineno-3-25" href="#__codelineno-3-25"></a><span class="p">)</span>
<a id="__codelineno-3-26" name="__codelineno-3-26" href="#__codelineno-3-26"></a><span class="c1"># Run our strategy on the simulated market</span>
<a id="__codelineno-3-27" name="__codelineno-3-27" href="#__codelineno-3-27"></a><span class="n">framework</span><span class="o">.</span><span class="n">add_strategy</span><span class="p">(</span><span class="n">strategy</span><span class="p">)</span>
<a id="__codelineno-3-28" name="__codelineno-3-28" href="#__codelineno-3-28"></a><span class="n">framework</span><span class="o">.</span><span class="n">add_logging_control</span><span class="p">(</span>
<a id="__codelineno-3-29" name="__codelineno-3-29" href="#__codelineno-3-29"></a>    <span class="n">BacktestLoggingControl</span><span class="p">()</span>
<a id="__codelineno-3-30" name="__codelineno-3-30" href="#__codelineno-3-30"></a><span class="p">)</span>
<a id="__codelineno-3-31" name="__codelineno-3-31" href="#__codelineno-3-31"></a><span class="n">framework</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="c1"># Import libraries</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="kn">import</span> <span class="nn">glob</span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="kn">import</span> <span class="nn">os</span>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="kn">import</span> <span class="nn">time</span>
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="kn">import</span> <span class="nn">logging</span>
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="kn">import</span> <span class="nn">csv</span>
<a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a><span class="kn">import</span> <span class="nn">json</span>
<a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a><span class="kn">import</span> <span class="nn">math</span>
<a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a><span class="kn">from</span> <span class="nn">pythonjsonlogger</span> <span class="kn">import</span> <span class="n">jsonlogger</span>
<a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a><span class="kn">from</span> <span class="nn">flumine</span> <span class="kn">import</span> <span class="n">FlumineSimulation</span><span class="p">,</span> <span class="n">BaseStrategy</span><span class="p">,</span> <span class="n">utils</span><span class="p">,</span> <span class="n">clients</span>
<a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a><span class="kn">from</span> <span class="nn">flumine.order.trade</span> <span class="kn">import</span> <span class="n">Trade</span>
<a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a><span class="kn">from</span> <span class="nn">flumine.order.order</span> <span class="kn">import</span> <span class="n">LimitOrder</span><span class="p">,</span> <span class="n">OrderStatus</span>
<a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a><span class="kn">from</span> <span class="nn">flumine.order.ordertype</span> <span class="kn">import</span> <span class="n">OrderTypes</span>
<a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a><span class="kn">from</span> <span class="nn">flumine.markets.market</span> <span class="kn">import</span> <span class="n">Market</span>
<a id="__codelineno-4-16" name="__codelineno-4-16" href="#__codelineno-4-16"></a><span class="kn">from</span> <span class="nn">flumine.controls.loggingcontrols</span> <span class="kn">import</span> <span class="n">LoggingControl</span>
<a id="__codelineno-4-17" name="__codelineno-4-17" href="#__codelineno-4-17"></a><span class="kn">from</span> <span class="nn">betfairlightweight.filters</span> <span class="kn">import</span> <span class="n">streaming_market_filter</span>
<a id="__codelineno-4-18" name="__codelineno-4-18" href="#__codelineno-4-18"></a><span class="kn">from</span> <span class="nn">betfairlightweight.resources</span> <span class="kn">import</span> <span class="n">MarketBook</span>
<a id="__codelineno-4-19" name="__codelineno-4-19" href="#__codelineno-4-19"></a><span class="kn">from</span> <span class="nn">pythonjsonlogger</span> <span class="kn">import</span> <span class="n">jsonlogger</span>
<a id="__codelineno-4-20" name="__codelineno-4-20" href="#__codelineno-4-20"></a><span class="kn">from</span> <span class="nn">concurrent</span> <span class="kn">import</span> <span class="n">futuresimport</span> <span class="n">glob</span>
<a id="__codelineno-4-21" name="__codelineno-4-21" href="#__codelineno-4-21"></a>
<a id="__codelineno-4-22" name="__codelineno-4-22" href="#__codelineno-4-22"></a><span class="c1"># Logging</span>
<a id="__codelineno-4-23" name="__codelineno-4-23" href="#__codelineno-4-23"></a><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span>
<a id="__codelineno-4-24" name="__codelineno-4-24" href="#__codelineno-4-24"></a><span class="n">custom_format</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%(asctime) %</span><span class="s2">(levelname) %(message)&quot;</span>
<a id="__codelineno-4-25" name="__codelineno-4-25" href="#__codelineno-4-25"></a><span class="n">log_handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()</span>
<a id="__codelineno-4-26" name="__codelineno-4-26" href="#__codelineno-4-26"></a><span class="n">formatter</span> <span class="o">=</span> <span class="n">jsonlogger</span><span class="o">.</span><span class="n">JsonFormatter</span><span class="p">(</span><span class="n">custom_format</span><span class="p">)</span>
<a id="__codelineno-4-27" name="__codelineno-4-27" href="#__codelineno-4-27"></a><span class="n">formatter</span><span class="o">.</span><span class="n">converter</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">gmtime</span>
<a id="__codelineno-4-28" name="__codelineno-4-28" href="#__codelineno-4-28"></a><span class="n">log_handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
<a id="__codelineno-4-29" name="__codelineno-4-29" href="#__codelineno-4-29"></a><span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">log_handler</span><span class="p">)</span>
<a id="__codelineno-4-30" name="__codelineno-4-30" href="#__codelineno-4-30"></a><span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>  <span class="c1"># Set to logging.CRITICAL to speed up simulation</span>
<a id="__codelineno-4-31" name="__codelineno-4-31" href="#__codelineno-4-31"></a>
<a id="__codelineno-4-32" name="__codelineno-4-32" href="#__codelineno-4-32"></a><span class="k">class</span> <span class="nc">BackFavStrategy</span><span class="p">(</span><span class="n">BaseStrategy</span><span class="p">):</span>
<a id="__codelineno-4-33" name="__codelineno-4-33" href="#__codelineno-4-33"></a>
<a id="__codelineno-4-34" name="__codelineno-4-34" href="#__codelineno-4-34"></a>    <span class="c1"># Defines what happens when we start our strategy i.e. this method will run once when we first start running our strategy</span>
<a id="__codelineno-4-35" name="__codelineno-4-35" href="#__codelineno-4-35"></a>    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-4-36" name="__codelineno-4-36" href="#__codelineno-4-36"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;starting strategy &#39;BackFavStrategy&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-4-37" name="__codelineno-4-37" href="#__codelineno-4-37"></a>
<a id="__codelineno-4-38" name="__codelineno-4-38" href="#__codelineno-4-38"></a>    <span class="k">def</span> <span class="nf">check_market_book</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">market</span><span class="p">:</span> <span class="n">Market</span><span class="p">,</span> <span class="n">market_book</span><span class="p">:</span> <span class="n">MarketBook</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-4-39" name="__codelineno-4-39" href="#__codelineno-4-39"></a>        <span class="c1"># process_market_book only executed if this returns True</span>
<a id="__codelineno-4-40" name="__codelineno-4-40" href="#__codelineno-4-40"></a>        <span class="k">if</span> <span class="n">market_book</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="s2">&quot;CLOSED&quot;</span><span class="p">:</span>
<a id="__codelineno-4-41" name="__codelineno-4-41" href="#__codelineno-4-41"></a>            <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-4-42" name="__codelineno-4-42" href="#__codelineno-4-42"></a>
<a id="__codelineno-4-43" name="__codelineno-4-43" href="#__codelineno-4-43"></a>    <span class="k">def</span> <span class="nf">process_market_book</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">market</span><span class="p">:</span> <span class="n">Market</span><span class="p">,</span> <span class="n">market_book</span><span class="p">:</span> <span class="n">MarketBook</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-4-44" name="__codelineno-4-44" href="#__codelineno-4-44"></a>
<a id="__codelineno-4-45" name="__codelineno-4-45" href="#__codelineno-4-45"></a>        <span class="c1"># Collect data on last price traded and the number of bets we have placed</span>
<a id="__codelineno-4-46" name="__codelineno-4-46" href="#__codelineno-4-46"></a>        <span class="n">snapshot_last_price_traded</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-4-47" name="__codelineno-4-47" href="#__codelineno-4-47"></a>        <span class="n">snapshot_runner_context</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-4-48" name="__codelineno-4-48" href="#__codelineno-4-48"></a>        <span class="k">for</span> <span class="n">runner</span> <span class="ow">in</span> <span class="n">market_book</span><span class="o">.</span><span class="n">runners</span><span class="p">:</span>
<a id="__codelineno-4-49" name="__codelineno-4-49" href="#__codelineno-4-49"></a>                <span class="n">snapshot_last_price_traded</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">runner</span><span class="o">.</span><span class="n">selection_id</span><span class="p">,</span><span class="n">runner</span><span class="o">.</span><span class="n">last_price_traded</span><span class="p">])</span>
<a id="__codelineno-4-50" name="__codelineno-4-50" href="#__codelineno-4-50"></a>                <span class="c1"># Get runner context for each runner</span>
<a id="__codelineno-4-51" name="__codelineno-4-51" href="#__codelineno-4-51"></a>                <span class="n">runner_context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_runner_context</span><span class="p">(</span>
<a id="__codelineno-4-52" name="__codelineno-4-52" href="#__codelineno-4-52"></a>                    <span class="n">market</span><span class="o">.</span><span class="n">market_id</span><span class="p">,</span> <span class="n">runner</span><span class="o">.</span><span class="n">selection_id</span><span class="p">,</span> <span class="n">runner</span><span class="o">.</span><span class="n">handicap</span>
<a id="__codelineno-4-53" name="__codelineno-4-53" href="#__codelineno-4-53"></a>                <span class="p">)</span>
<a id="__codelineno-4-54" name="__codelineno-4-54" href="#__codelineno-4-54"></a>                <span class="n">snapshot_runner_context</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">runner_context</span><span class="o">.</span><span class="n">selection_id</span><span class="p">,</span> <span class="n">runner_context</span><span class="o">.</span><span class="n">executable_orders</span><span class="p">,</span> <span class="n">runner_context</span><span class="o">.</span><span class="n">live_trade_count</span><span class="p">,</span> <span class="n">runner_context</span><span class="o">.</span><span class="n">trade_count</span><span class="p">])</span>
<a id="__codelineno-4-55" name="__codelineno-4-55" href="#__codelineno-4-55"></a>
<a id="__codelineno-4-56" name="__codelineno-4-56" href="#__codelineno-4-56"></a>        <span class="c1"># Convert last price traded data to dataframe</span>
<a id="__codelineno-4-57" name="__codelineno-4-57" href="#__codelineno-4-57"></a>        <span class="n">snapshot_last_price_traded</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">snapshot_last_price_traded</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;selection_id&#39;</span><span class="p">,</span><span class="s1">&#39;last_traded_price&#39;</span><span class="p">])</span>
<a id="__codelineno-4-58" name="__codelineno-4-58" href="#__codelineno-4-58"></a>        <span class="c1"># Find the selection_id of the favourite</span>
<a id="__codelineno-4-59" name="__codelineno-4-59" href="#__codelineno-4-59"></a>        <span class="n">snapshot_last_price_traded</span> <span class="o">=</span> <span class="n">snapshot_last_price_traded</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;last_traded_price&#39;</span><span class="p">])</span>
<a id="__codelineno-4-60" name="__codelineno-4-60" href="#__codelineno-4-60"></a>        <span class="n">fav_selection_id</span> <span class="o">=</span> <span class="n">snapshot_last_price_traded</span><span class="p">[</span><span class="s1">&#39;selection_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-4-61" name="__codelineno-4-61" href="#__codelineno-4-61"></a>        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">snapshot_last_price_traded</span><span class="p">)</span> <span class="c1"># logging</span>
<a id="__codelineno-4-62" name="__codelineno-4-62" href="#__codelineno-4-62"></a>
<a id="__codelineno-4-63" name="__codelineno-4-63" href="#__codelineno-4-63"></a>        <span class="c1"># Convert data on number of bets we have placed to a dataframe</span>
<a id="__codelineno-4-64" name="__codelineno-4-64" href="#__codelineno-4-64"></a>        <span class="n">snapshot_runner_context</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">snapshot_runner_context</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;selection_id&#39;</span><span class="p">,</span><span class="s1">&#39;executable_orders&#39;</span><span class="p">,</span><span class="s1">&#39;live_trade_count&#39;</span><span class="p">,</span><span class="s1">&#39;trade_count&#39;</span><span class="p">])</span>
<a id="__codelineno-4-65" name="__codelineno-4-65" href="#__codelineno-4-65"></a>        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">snapshot_runner_context</span><span class="p">)</span> <span class="c1"># logging</span>
<a id="__codelineno-4-66" name="__codelineno-4-66" href="#__codelineno-4-66"></a>
<a id="__codelineno-4-67" name="__codelineno-4-67" href="#__codelineno-4-67"></a>        <span class="k">for</span> <span class="n">runner</span> <span class="ow">in</span> <span class="n">market_book</span><span class="o">.</span><span class="n">runners</span><span class="p">:</span>
<a id="__codelineno-4-68" name="__codelineno-4-68" href="#__codelineno-4-68"></a>            <span class="k">if</span> <span class="n">runner</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;ACTIVE&quot;</span> <span class="ow">and</span> <span class="n">market</span><span class="o">.</span><span class="n">seconds_to_start</span> <span class="o">&lt;</span> <span class="mi">60</span> <span class="ow">and</span> <span class="n">market_book</span><span class="o">.</span><span class="n">inplay</span> <span class="o">==</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">runner</span><span class="o">.</span><span class="n">selection_id</span> <span class="o">==</span> <span class="n">fav_selection_id</span> <span class="ow">and</span> <span class="n">snapshot_runner_context</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-4-69" name="__codelineno-4-69" href="#__codelineno-4-69"></a>                <span class="n">trade</span> <span class="o">=</span> <span class="n">Trade</span><span class="p">(</span>
<a id="__codelineno-4-70" name="__codelineno-4-70" href="#__codelineno-4-70"></a>                    <span class="n">market_id</span><span class="o">=</span><span class="n">market_book</span><span class="o">.</span><span class="n">market_id</span><span class="p">,</span>
<a id="__codelineno-4-71" name="__codelineno-4-71" href="#__codelineno-4-71"></a>                    <span class="n">selection_id</span><span class="o">=</span><span class="n">runner</span><span class="o">.</span><span class="n">selection_id</span><span class="p">,</span>
<a id="__codelineno-4-72" name="__codelineno-4-72" href="#__codelineno-4-72"></a>                    <span class="n">handicap</span><span class="o">=</span><span class="n">runner</span><span class="o">.</span><span class="n">handicap</span><span class="p">,</span>
<a id="__codelineno-4-73" name="__codelineno-4-73" href="#__codelineno-4-73"></a>                    <span class="n">strategy</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-4-74" name="__codelineno-4-74" href="#__codelineno-4-74"></a>                <span class="p">)</span>
<a id="__codelineno-4-75" name="__codelineno-4-75" href="#__codelineno-4-75"></a>                <span class="n">order</span> <span class="o">=</span> <span class="n">trade</span><span class="o">.</span><span class="n">create_order</span><span class="p">(</span>
<a id="__codelineno-4-76" name="__codelineno-4-76" href="#__codelineno-4-76"></a>                    <span class="n">side</span><span class="o">=</span><span class="s2">&quot;BACK&quot;</span><span class="p">,</span> <span class="n">order_type</span><span class="o">=</span><span class="n">LimitOrder</span><span class="p">(</span><span class="n">price</span><span class="o">=</span><span class="n">runner</span><span class="o">.</span><span class="n">last_price_traded</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<a id="__codelineno-4-77" name="__codelineno-4-77" href="#__codelineno-4-77"></a>                <span class="p">)</span>
<a id="__codelineno-4-78" name="__codelineno-4-78" href="#__codelineno-4-78"></a>                <span class="n">market</span><span class="o">.</span><span class="n">place_order</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
<a id="__codelineno-4-79" name="__codelineno-4-79" href="#__codelineno-4-79"></a>
<a id="__codelineno-4-80" name="__codelineno-4-80" href="#__codelineno-4-80"></a><span class="c1"># Fields we want to log in our simulations</span>
<a id="__codelineno-4-81" name="__codelineno-4-81" href="#__codelineno-4-81"></a><span class="n">FIELDNAMES</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-4-82" name="__codelineno-4-82" href="#__codelineno-4-82"></a>    <span class="s2">&quot;bet_id&quot;</span><span class="p">,</span>
<a id="__codelineno-4-83" name="__codelineno-4-83" href="#__codelineno-4-83"></a>    <span class="s2">&quot;strategy_name&quot;</span><span class="p">,</span>
<a id="__codelineno-4-84" name="__codelineno-4-84" href="#__codelineno-4-84"></a>    <span class="s2">&quot;market_id&quot;</span><span class="p">,</span>
<a id="__codelineno-4-85" name="__codelineno-4-85" href="#__codelineno-4-85"></a>    <span class="s2">&quot;selection_id&quot;</span><span class="p">,</span>
<a id="__codelineno-4-86" name="__codelineno-4-86" href="#__codelineno-4-86"></a>    <span class="s2">&quot;trade_id&quot;</span><span class="p">,</span>
<a id="__codelineno-4-87" name="__codelineno-4-87" href="#__codelineno-4-87"></a>    <span class="s2">&quot;date_time_placed&quot;</span><span class="p">,</span>
<a id="__codelineno-4-88" name="__codelineno-4-88" href="#__codelineno-4-88"></a>    <span class="s2">&quot;price&quot;</span><span class="p">,</span>
<a id="__codelineno-4-89" name="__codelineno-4-89" href="#__codelineno-4-89"></a>    <span class="s2">&quot;price_matched&quot;</span><span class="p">,</span>
<a id="__codelineno-4-90" name="__codelineno-4-90" href="#__codelineno-4-90"></a>    <span class="s2">&quot;size&quot;</span><span class="p">,</span>
<a id="__codelineno-4-91" name="__codelineno-4-91" href="#__codelineno-4-91"></a>    <span class="s2">&quot;size_matched&quot;</span><span class="p">,</span>
<a id="__codelineno-4-92" name="__codelineno-4-92" href="#__codelineno-4-92"></a>    <span class="s2">&quot;profit&quot;</span><span class="p">,</span>
<a id="__codelineno-4-93" name="__codelineno-4-93" href="#__codelineno-4-93"></a>    <span class="s2">&quot;side&quot;</span><span class="p">,</span>
<a id="__codelineno-4-94" name="__codelineno-4-94" href="#__codelineno-4-94"></a>    <span class="s2">&quot;elapsed_seconds_executable&quot;</span><span class="p">,</span>
<a id="__codelineno-4-95" name="__codelineno-4-95" href="#__codelineno-4-95"></a>    <span class="s2">&quot;order_status&quot;</span><span class="p">,</span>
<a id="__codelineno-4-96" name="__codelineno-4-96" href="#__codelineno-4-96"></a>    <span class="s2">&quot;market_note&quot;</span><span class="p">,</span>
<a id="__codelineno-4-97" name="__codelineno-4-97" href="#__codelineno-4-97"></a>    <span class="s2">&quot;trade_notes&quot;</span><span class="p">,</span>
<a id="__codelineno-4-98" name="__codelineno-4-98" href="#__codelineno-4-98"></a>    <span class="s2">&quot;order_notes&quot;</span><span class="p">,</span>
<a id="__codelineno-4-99" name="__codelineno-4-99" href="#__codelineno-4-99"></a><span class="p">]</span>
<a id="__codelineno-4-100" name="__codelineno-4-100" href="#__codelineno-4-100"></a>
<a id="__codelineno-4-101" name="__codelineno-4-101" href="#__codelineno-4-101"></a><span class="c1"># Log results from simulation into csv file named sim_hta_2.csv</span>
<a id="__codelineno-4-102" name="__codelineno-4-102" href="#__codelineno-4-102"></a><span class="c1"># If the csv file doesn&#39;t exist then it is created, otherwise we append results to the csv file</span>
<a id="__codelineno-4-103" name="__codelineno-4-103" href="#__codelineno-4-103"></a><span class="k">class</span> <span class="nc">BacktestLoggingControl</span><span class="p">(</span><span class="n">LoggingControl</span><span class="p">):</span>
<a id="__codelineno-4-104" name="__codelineno-4-104" href="#__codelineno-4-104"></a>    <span class="n">NAME</span> <span class="o">=</span> <span class="s2">&quot;BACKTEST_LOGGING_CONTROL&quot;</span>
<a id="__codelineno-4-105" name="__codelineno-4-105" href="#__codelineno-4-105"></a>
<a id="__codelineno-4-106" name="__codelineno-4-106" href="#__codelineno-4-106"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-4-107" name="__codelineno-4-107" href="#__codelineno-4-107"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">BacktestLoggingControl</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-4-108" name="__codelineno-4-108" href="#__codelineno-4-108"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_setup</span><span class="p">()</span>
<a id="__codelineno-4-109" name="__codelineno-4-109" href="#__codelineno-4-109"></a>
<a id="__codelineno-4-110" name="__codelineno-4-110" href="#__codelineno-4-110"></a>    <span class="k">def</span> <span class="nf">_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-4-111" name="__codelineno-4-111" href="#__codelineno-4-111"></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;sim_hta_2.csv&quot;</span><span class="p">):</span>
<a id="__codelineno-4-112" name="__codelineno-4-112" href="#__codelineno-4-112"></a>            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Results file exists&quot;</span><span class="p">)</span>
<a id="__codelineno-4-113" name="__codelineno-4-113" href="#__codelineno-4-113"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-4-114" name="__codelineno-4-114" href="#__codelineno-4-114"></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;sim_hta_2.csv&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">m</span><span class="p">:</span>
<a id="__codelineno-4-115" name="__codelineno-4-115" href="#__codelineno-4-115"></a>                <span class="n">csv_writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictWriter</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">fieldnames</span><span class="o">=</span><span class="n">FIELDNAMES</span><span class="p">)</span>
<a id="__codelineno-4-116" name="__codelineno-4-116" href="#__codelineno-4-116"></a>                <span class="n">csv_writer</span><span class="o">.</span><span class="n">writeheader</span><span class="p">()</span>
<a id="__codelineno-4-117" name="__codelineno-4-117" href="#__codelineno-4-117"></a>
<a id="__codelineno-4-118" name="__codelineno-4-118" href="#__codelineno-4-118"></a>    <span class="k">def</span> <span class="nf">_process_cleared_orders_meta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
<a id="__codelineno-4-119" name="__codelineno-4-119" href="#__codelineno-4-119"></a>        <span class="n">orders</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">event</span>
<a id="__codelineno-4-120" name="__codelineno-4-120" href="#__codelineno-4-120"></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;sim_hta_2.csv&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">m</span><span class="p">:</span>
<a id="__codelineno-4-121" name="__codelineno-4-121" href="#__codelineno-4-121"></a>            <span class="k">for</span> <span class="n">order</span> <span class="ow">in</span> <span class="n">orders</span><span class="p">:</span>
<a id="__codelineno-4-122" name="__codelineno-4-122" href="#__codelineno-4-122"></a>                <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">order_type</span><span class="o">.</span><span class="n">ORDER_TYPE</span> <span class="o">==</span> <span class="n">OrderTypes</span><span class="o">.</span><span class="n">LIMIT</span><span class="p">:</span>
<a id="__codelineno-4-123" name="__codelineno-4-123" href="#__codelineno-4-123"></a>                    <span class="n">size</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">order_type</span><span class="o">.</span><span class="n">size</span>
<a id="__codelineno-4-124" name="__codelineno-4-124" href="#__codelineno-4-124"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-4-125" name="__codelineno-4-125" href="#__codelineno-4-125"></a>                    <span class="n">size</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">order_type</span><span class="o">.</span><span class="n">liability</span>
<a id="__codelineno-4-126" name="__codelineno-4-126" href="#__codelineno-4-126"></a>                <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">order_type</span><span class="o">.</span><span class="n">ORDER_TYPE</span> <span class="o">==</span> <span class="n">OrderTypes</span><span class="o">.</span><span class="n">MARKET_ON_CLOSE</span><span class="p">:</span>
<a id="__codelineno-4-127" name="__codelineno-4-127" href="#__codelineno-4-127"></a>                    <span class="n">price</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-4-128" name="__codelineno-4-128" href="#__codelineno-4-128"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-4-129" name="__codelineno-4-129" href="#__codelineno-4-129"></a>                    <span class="n">price</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">order_type</span><span class="o">.</span><span class="n">price</span>
<a id="__codelineno-4-130" name="__codelineno-4-130" href="#__codelineno-4-130"></a>                <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-4-131" name="__codelineno-4-131" href="#__codelineno-4-131"></a>                    <span class="n">order_data</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-4-132" name="__codelineno-4-132" href="#__codelineno-4-132"></a>                        <span class="s2">&quot;bet_id&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">bet_id</span><span class="p">,</span>
<a id="__codelineno-4-133" name="__codelineno-4-133" href="#__codelineno-4-133"></a>                        <span class="s2">&quot;strategy_name&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">trade</span><span class="o">.</span><span class="n">strategy</span><span class="p">,</span>
<a id="__codelineno-4-134" name="__codelineno-4-134" href="#__codelineno-4-134"></a>                        <span class="s2">&quot;market_id&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">market_id</span><span class="p">,</span>
<a id="__codelineno-4-135" name="__codelineno-4-135" href="#__codelineno-4-135"></a>                        <span class="s2">&quot;selection_id&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">selection_id</span><span class="p">,</span>
<a id="__codelineno-4-136" name="__codelineno-4-136" href="#__codelineno-4-136"></a>                        <span class="s2">&quot;trade_id&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">trade</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
<a id="__codelineno-4-137" name="__codelineno-4-137" href="#__codelineno-4-137"></a>                        <span class="s2">&quot;date_time_placed&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">responses</span><span class="o">.</span><span class="n">date_time_placed</span><span class="p">,</span>
<a id="__codelineno-4-138" name="__codelineno-4-138" href="#__codelineno-4-138"></a>                        <span class="s2">&quot;price&quot;</span><span class="p">:</span> <span class="n">price</span><span class="p">,</span>
<a id="__codelineno-4-139" name="__codelineno-4-139" href="#__codelineno-4-139"></a>                        <span class="s2">&quot;price_matched&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">average_price_matched</span><span class="p">,</span>
<a id="__codelineno-4-140" name="__codelineno-4-140" href="#__codelineno-4-140"></a>                        <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="n">size</span><span class="p">,</span>
<a id="__codelineno-4-141" name="__codelineno-4-141" href="#__codelineno-4-141"></a>                        <span class="s2">&quot;size_matched&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">size_matched</span><span class="p">,</span>
<a id="__codelineno-4-142" name="__codelineno-4-142" href="#__codelineno-4-142"></a>                        <span class="s2">&quot;profit&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">simulated</span><span class="o">.</span><span class="n">profit</span><span class="p">,</span>
<a id="__codelineno-4-143" name="__codelineno-4-143" href="#__codelineno-4-143"></a>                        <span class="s2">&quot;side&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">side</span><span class="p">,</span>
<a id="__codelineno-4-144" name="__codelineno-4-144" href="#__codelineno-4-144"></a>                        <span class="s2">&quot;elapsed_seconds_executable&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">elapsed_seconds_executable</span><span class="p">,</span>
<a id="__codelineno-4-145" name="__codelineno-4-145" href="#__codelineno-4-145"></a>                        <span class="s2">&quot;order_status&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
<a id="__codelineno-4-146" name="__codelineno-4-146" href="#__codelineno-4-146"></a>                        <span class="s2">&quot;market_note&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">trade</span><span class="o">.</span><span class="n">market_notes</span><span class="p">,</span>
<a id="__codelineno-4-147" name="__codelineno-4-147" href="#__codelineno-4-147"></a>                        <span class="s2">&quot;trade_notes&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">trade</span><span class="o">.</span><span class="n">notes_str</span><span class="p">,</span>
<a id="__codelineno-4-148" name="__codelineno-4-148" href="#__codelineno-4-148"></a>                        <span class="s2">&quot;order_notes&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">notes_str</span><span class="p">,</span>
<a id="__codelineno-4-149" name="__codelineno-4-149" href="#__codelineno-4-149"></a>                    <span class="p">}</span>
<a id="__codelineno-4-150" name="__codelineno-4-150" href="#__codelineno-4-150"></a>                    <span class="n">csv_writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictWriter</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">fieldnames</span><span class="o">=</span><span class="n">FIELDNAMES</span><span class="p">)</span>
<a id="__codelineno-4-151" name="__codelineno-4-151" href="#__codelineno-4-151"></a>                    <span class="n">csv_writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">order_data</span><span class="p">)</span>
<a id="__codelineno-4-152" name="__codelineno-4-152" href="#__codelineno-4-152"></a>                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-4-153" name="__codelineno-4-153" href="#__codelineno-4-153"></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-4-154" name="__codelineno-4-154" href="#__codelineno-4-154"></a>                        <span class="s2">&quot;_process_cleared_orders_meta: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">,</span>
<a id="__codelineno-4-155" name="__codelineno-4-155" href="#__codelineno-4-155"></a>                        <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;order&quot;</span><span class="p">:</span> <span class="n">order</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">e</span><span class="p">},</span>
<a id="__codelineno-4-156" name="__codelineno-4-156" href="#__codelineno-4-156"></a>                    <span class="p">)</span>
<a id="__codelineno-4-157" name="__codelineno-4-157" href="#__codelineno-4-157"></a>
<a id="__codelineno-4-158" name="__codelineno-4-158" href="#__codelineno-4-158"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Orders updated&quot;</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;order_count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">orders</span><span class="p">)})</span>
<a id="__codelineno-4-159" name="__codelineno-4-159" href="#__codelineno-4-159"></a>
<a id="__codelineno-4-160" name="__codelineno-4-160" href="#__codelineno-4-160"></a>    <span class="k">def</span> <span class="nf">_process_cleared_markets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
<a id="__codelineno-4-161" name="__codelineno-4-161" href="#__codelineno-4-161"></a>        <span class="n">cleared_markets</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">event</span>
<a id="__codelineno-4-162" name="__codelineno-4-162" href="#__codelineno-4-162"></a>        <span class="k">for</span> <span class="n">cleared_market</span> <span class="ow">in</span> <span class="n">cleared_markets</span><span class="o">.</span><span class="n">orders</span><span class="p">:</span>
<a id="__codelineno-4-163" name="__codelineno-4-163" href="#__codelineno-4-163"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-4-164" name="__codelineno-4-164" href="#__codelineno-4-164"></a>                <span class="s2">&quot;Cleared market&quot;</span><span class="p">,</span>
<a id="__codelineno-4-165" name="__codelineno-4-165" href="#__codelineno-4-165"></a>                <span class="n">extra</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-4-166" name="__codelineno-4-166" href="#__codelineno-4-166"></a>                    <span class="s2">&quot;market_id&quot;</span><span class="p">:</span> <span class="n">cleared_market</span><span class="o">.</span><span class="n">market_id</span><span class="p">,</span>
<a id="__codelineno-4-167" name="__codelineno-4-167" href="#__codelineno-4-167"></a>                    <span class="s2">&quot;bet_count&quot;</span><span class="p">:</span> <span class="n">cleared_market</span><span class="o">.</span><span class="n">bet_count</span><span class="p">,</span>
<a id="__codelineno-4-168" name="__codelineno-4-168" href="#__codelineno-4-168"></a>                    <span class="s2">&quot;profit&quot;</span><span class="p">:</span> <span class="n">cleared_market</span><span class="o">.</span><span class="n">profit</span><span class="p">,</span>
<a id="__codelineno-4-169" name="__codelineno-4-169" href="#__codelineno-4-169"></a>                    <span class="s2">&quot;commission&quot;</span><span class="p">:</span> <span class="n">cleared_market</span><span class="o">.</span><span class="n">commission</span><span class="p">,</span>
<a id="__codelineno-4-170" name="__codelineno-4-170" href="#__codelineno-4-170"></a>                <span class="p">},</span>
<a id="__codelineno-4-171" name="__codelineno-4-171" href="#__codelineno-4-171"></a>            <span class="p">)</span>
<a id="__codelineno-4-172" name="__codelineno-4-172" href="#__codelineno-4-172"></a>
<a id="__codelineno-4-173" name="__codelineno-4-173" href="#__codelineno-4-173"></a><span class="c1"># Searches for all betfair data files within the folder sample_monthly_data_output</span>
<a id="__codelineno-4-174" name="__codelineno-4-174" href="#__codelineno-4-174"></a><span class="n">data_folder</span> <span class="o">=</span> <span class="s1">&#39;sample_monthly_data_output&#39;</span>
<a id="__codelineno-4-175" name="__codelineno-4-175" href="#__codelineno-4-175"></a><span class="n">data_files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">data_folder</span><span class="p">,)</span>
<a id="__codelineno-4-176" name="__codelineno-4-176" href="#__codelineno-4-176"></a><span class="n">data_files</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">data_folder</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">data_files</span><span class="p">]</span>
<a id="__codelineno-4-177" name="__codelineno-4-177" href="#__codelineno-4-177"></a>
<a id="__codelineno-4-178" name="__codelineno-4-178" href="#__codelineno-4-178"></a><span class="c1"># Set Flumine to simulation mode</span>
<a id="__codelineno-4-179" name="__codelineno-4-179" href="#__codelineno-4-179"></a><span class="n">client</span> <span class="o">=</span> <span class="n">clients</span><span class="o">.</span><span class="n">SimulatedClient</span><span class="p">()</span>
<a id="__codelineno-4-180" name="__codelineno-4-180" href="#__codelineno-4-180"></a><span class="n">framework</span> <span class="o">=</span> <span class="n">FlumineSimulation</span><span class="p">(</span><span class="n">client</span><span class="o">=</span><span class="n">client</span><span class="p">)</span>
<a id="__codelineno-4-181" name="__codelineno-4-181" href="#__codelineno-4-181"></a>
<a id="__codelineno-4-182" name="__codelineno-4-182" href="#__codelineno-4-182"></a><span class="c1"># Set parameters for our strategy</span>
<a id="__codelineno-4-183" name="__codelineno-4-183" href="#__codelineno-4-183"></a><span class="n">strategy</span> <span class="o">=</span> <span class="n">BackFavStrategy</span><span class="p">(</span>
<a id="__codelineno-4-184" name="__codelineno-4-184" href="#__codelineno-4-184"></a>    <span class="c1"># market_filter selects what portion of the historic data we simulate our strategy on</span>
<a id="__codelineno-4-185" name="__codelineno-4-185" href="#__codelineno-4-185"></a>    <span class="c1"># markets selects the list of betfair historic data files</span>
<a id="__codelineno-4-186" name="__codelineno-4-186" href="#__codelineno-4-186"></a>    <span class="c1"># market_types specifies the type of markets</span>
<a id="__codelineno-4-187" name="__codelineno-4-187" href="#__codelineno-4-187"></a>    <span class="c1"># listener_kwargs specifies the time period we simulate for each market</span>
<a id="__codelineno-4-188" name="__codelineno-4-188" href="#__codelineno-4-188"></a>    <span class="n">market_filter</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-4-189" name="__codelineno-4-189" href="#__codelineno-4-189"></a>        <span class="s2">&quot;markets&quot;</span><span class="p">:</span> <span class="n">data_files</span><span class="p">,</span>  
<a id="__codelineno-4-190" name="__codelineno-4-190" href="#__codelineno-4-190"></a>        <span class="s1">&#39;market_types&#39;</span><span class="p">:[</span><span class="s1">&#39;WIN&#39;</span><span class="p">],</span>
<a id="__codelineno-4-191" name="__codelineno-4-191" href="#__codelineno-4-191"></a>        <span class="s2">&quot;listener_kwargs&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;inplay&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;seconds_to_start&quot;</span><span class="p">:</span> <span class="mi">80</span><span class="p">},</span>  
<a id="__codelineno-4-192" name="__codelineno-4-192" href="#__codelineno-4-192"></a>        <span class="p">},</span>
<a id="__codelineno-4-193" name="__codelineno-4-193" href="#__codelineno-4-193"></a>    <span class="n">max_order_exposure</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
<a id="__codelineno-4-194" name="__codelineno-4-194" href="#__codelineno-4-194"></a>    <span class="n">max_selection_exposure</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
<a id="__codelineno-4-195" name="__codelineno-4-195" href="#__codelineno-4-195"></a>    <span class="n">max_live_trade_count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-4-196" name="__codelineno-4-196" href="#__codelineno-4-196"></a>    <span class="n">max_trade_count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-4-197" name="__codelineno-4-197" href="#__codelineno-4-197"></a><span class="p">)</span>
<a id="__codelineno-4-198" name="__codelineno-4-198" href="#__codelineno-4-198"></a><span class="c1"># Run our strategy on the simulated market</span>
<a id="__codelineno-4-199" name="__codelineno-4-199" href="#__codelineno-4-199"></a><span class="n">framework</span><span class="o">.</span><span class="n">add_strategy</span><span class="p">(</span><span class="n">strategy</span><span class="p">)</span>
<a id="__codelineno-4-200" name="__codelineno-4-200" href="#__codelineno-4-200"></a><span class="n">framework</span><span class="o">.</span><span class="n">add_logging_control</span><span class="p">(</span>
<a id="__codelineno-4-201" name="__codelineno-4-201" href="#__codelineno-4-201"></a>    <span class="n">BacktestLoggingControl</span><span class="p">()</span>
<a id="__codelineno-4-202" name="__codelineno-4-202" href="#__codelineno-4-202"></a><span class="p">)</span>
<a id="__codelineno-4-203" name="__codelineno-4-203" href="#__codelineno-4-203"></a><span class="n">framework</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</code></pre></div>
</div>
</div>
</div>
<hr />
<h2 id="running-sims-how-to-automate-iii">Running Sims: How to Automate III</h2>
<p>Okay, so we got the first one running pretty easily, a little too easily (a few lines of code and no major issues or hacky work arounds), lets test out a strategy that requires external data. In <a href="../How_to_Automate_3">How to Automate III</a> we automated the betfair data scientists model, lets now simulate performance. I'm going to do just the greyhound model, 'Iggy', at the moment, but the code is basically the same for the thoroughbred model, 'Kash'.</p>
<p>Because we didn't save any of our ratings in How to Automate III we will need to redownload it now. And instead or redownloading just one days worth of data lets test out a whole month at a time. Lets reuse the function we created in How to Automate IV that we used a hacky work around that downloads the ratings for a range of dates:</p>
<div class="highlight"><span class="filename">Download a whole month of Iggy ratings and convert it to a DataFrame</span><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="k">def</span> <span class="nf">download_iggy_ratings</span><span class="p">(</span><span class="n">date</span><span class="p">):</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Downloads the Betfair Iggy model ratings for a given date and formats it into a nice DataFrame.</span>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="sd">    Args:</span>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="sd">        date (datetime): the date we want to download the ratings for</span>
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a>    <span class="n">iggy_url_1</span> <span class="o">=</span> <span class="s1">&#39;https://betfair-data-supplier-prod.herokuapp.com/api/widgets/iggy-joey/datasets?date=&#39;</span>
<a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a>    <span class="n">iggy_url_2</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a>    <span class="n">iggy_url_3</span> <span class="o">=</span> <span class="s1">&#39;&amp;presenter=RatingsPresenter&amp;csv=true&#39;</span>
<a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a>    <span class="n">iggy_url</span> <span class="o">=</span> <span class="n">iggy_url_1</span> <span class="o">+</span> <span class="n">iggy_url_2</span> <span class="o">+</span> <span class="n">iggy_url_3</span>
<a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a>
<a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a>    <span class="c1"># Download todays greyhounds ratings</span>
<a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a>    <span class="n">iggy_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">iggy_url</span><span class="p">)</span>
<a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a>
<a id="__codelineno-5-15" name="__codelineno-5-15" href="#__codelineno-5-15"></a>    <span class="c1"># Data clearning</span>
<a id="__codelineno-5-16" name="__codelineno-5-16" href="#__codelineno-5-16"></a>    <span class="n">iggy_df</span> <span class="o">=</span> <span class="n">iggy_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;meetings.races.bfExchangeMarketId&quot;</span><span class="p">:</span><span class="s2">&quot;market_id&quot;</span><span class="p">,</span><span class="s2">&quot;meetings.races.runners.bfExchangeSelectionId&quot;</span><span class="p">:</span><span class="s2">&quot;selection_id&quot;</span><span class="p">,</span><span class="s2">&quot;meetings.races.runners.ratedPrice&quot;</span><span class="p">:</span><span class="s2">&quot;rating&quot;</span><span class="p">})</span>
<a id="__codelineno-5-17" name="__codelineno-5-17" href="#__codelineno-5-17"></a>    <span class="n">iggy_df</span> <span class="o">=</span> <span class="n">iggy_df</span><span class="p">[[</span><span class="s1">&#39;market_id&#39;</span><span class="p">,</span><span class="s1">&#39;selection_id&#39;</span><span class="p">,</span><span class="s1">&#39;rating&#39;</span><span class="p">]]</span>
<a id="__codelineno-5-18" name="__codelineno-5-18" href="#__codelineno-5-18"></a>    <span class="n">iggy_df</span><span class="p">[</span><span class="s1">&#39;market_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">iggy_df</span><span class="p">[</span><span class="s1">&#39;market_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
<a id="__codelineno-5-19" name="__codelineno-5-19" href="#__codelineno-5-19"></a>
<a id="__codelineno-5-20" name="__codelineno-5-20" href="#__codelineno-5-20"></a>    <span class="c1"># Set market_id and selection_id as index for easy referencing</span>
<a id="__codelineno-5-21" name="__codelineno-5-21" href="#__codelineno-5-21"></a>    <span class="n">iggy_df</span> <span class="o">=</span> <span class="n">iggy_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;market_id&#39;</span><span class="p">,</span><span class="s1">&#39;selection_id&#39;</span><span class="p">])</span>
<a id="__codelineno-5-22" name="__codelineno-5-22" href="#__codelineno-5-22"></a>    <span class="k">return</span><span class="p">(</span><span class="n">iggy_df</span><span class="p">)</span>
<a id="__codelineno-5-23" name="__codelineno-5-23" href="#__codelineno-5-23"></a>
<a id="__codelineno-5-24" name="__codelineno-5-24" href="#__codelineno-5-24"></a><span class="c1"># Download historical ratings over a time period and convert into a big DataFrame.</span>
<a id="__codelineno-5-25" name="__codelineno-5-25" href="#__codelineno-5-25"></a><span class="n">back_test_period</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="s1">&#39;2022/02/27&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;2022/03/05&#39;</span><span class="p">)</span>
<a id="__codelineno-5-26" name="__codelineno-5-26" href="#__codelineno-5-26"></a><span class="n">frames</span> <span class="o">=</span> <span class="p">[</span><span class="n">download_iggy_ratings</span><span class="p">(</span><span class="n">day</span><span class="p">)</span> <span class="k">for</span> <span class="n">day</span> <span class="ow">in</span> <span class="n">back_test_period</span><span class="p">]</span>
<a id="__codelineno-5-27" name="__codelineno-5-27" href="#__codelineno-5-27"></a><span class="n">iggy_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">frames</span><span class="p">)</span>
<a id="__codelineno-5-28" name="__codelineno-5-28" href="#__codelineno-5-28"></a><span class="nb">print</span><span class="p">(</span><span class="n">iggy_df</span><span class="p">)</span>
</code></pre></div>
<p>Now that we have downloaded a whole month of Iggy ratings to simulate it is crazy easy to simulate. We do the same thing we did when simulating How to Automate II: copy and paste the original code, and set Flumine into simulation mode pointing it to the historic data instead of the Betfair API.</p>
<div class="tabbed-set tabbed-alternate" data-tabs="2:2"><input checked="checked" id="__tabbed_2_1" name="__tabbed_2" type="radio" /><input id="__tabbed_2_2" name="__tabbed_2" type="radio" /><div class="tabbed-labels"><label for="__tabbed_2_1">Changes made to the original How to Automate III code</label><label for="__tabbed_2_2">Complete Code</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="k">def</span> <span class="nf">download_iggy_ratings</span><span class="p">(</span><span class="n">date</span><span class="p">):</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Downloads the Betfair Iggy model ratings for a given date and formats it into a nice DataFrame.</span>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="sd">    Args:</span>
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="sd">        date (datetime): the date we want to download the ratings for</span>
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a>    <span class="n">iggy_url_1</span> <span class="o">=</span> <span class="s1">&#39;https://betfair-data-supplier-prod.herokuapp.com/api/widgets/iggy-joey/datasets?date=&#39;</span>
<a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a>    <span class="n">iggy_url_2</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a>    <span class="n">iggy_url_3</span> <span class="o">=</span> <span class="s1">&#39;&amp;presenter=RatingsPresenter&amp;csv=true&#39;</span>
<a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a>    <span class="n">iggy_url</span> <span class="o">=</span> <span class="n">iggy_url_1</span> <span class="o">+</span> <span class="n">iggy_url_2</span> <span class="o">+</span> <span class="n">iggy_url_3</span>
<a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a>
<a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a>    <span class="c1"># Download todays greyhounds ratings</span>
<a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a>    <span class="n">iggy_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">iggy_url</span><span class="p">)</span>
<a id="__codelineno-6-14" name="__codelineno-6-14" href="#__codelineno-6-14"></a>
<a id="__codelineno-6-15" name="__codelineno-6-15" href="#__codelineno-6-15"></a>    <span class="c1"># Data clearning</span>
<a id="__codelineno-6-16" name="__codelineno-6-16" href="#__codelineno-6-16"></a>    <span class="n">iggy_df</span> <span class="o">=</span> <span class="n">iggy_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;meetings.races.bfExchangeMarketId&quot;</span><span class="p">:</span><span class="s2">&quot;market_id&quot;</span><span class="p">,</span><span class="s2">&quot;meetings.races.runners.bfExchangeSelectionId&quot;</span><span class="p">:</span><span class="s2">&quot;selection_id&quot;</span><span class="p">,</span><span class="s2">&quot;meetings.races.runners.ratedPrice&quot;</span><span class="p">:</span><span class="s2">&quot;rating&quot;</span><span class="p">})</span>
<a id="__codelineno-6-17" name="__codelineno-6-17" href="#__codelineno-6-17"></a>    <span class="n">iggy_df</span> <span class="o">=</span> <span class="n">iggy_df</span><span class="p">[[</span><span class="s1">&#39;market_id&#39;</span><span class="p">,</span><span class="s1">&#39;selection_id&#39;</span><span class="p">,</span><span class="s1">&#39;rating&#39;</span><span class="p">]]</span>
<a id="__codelineno-6-18" name="__codelineno-6-18" href="#__codelineno-6-18"></a>    <span class="n">iggy_df</span><span class="p">[</span><span class="s1">&#39;market_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">iggy_df</span><span class="p">[</span><span class="s1">&#39;market_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
<a id="__codelineno-6-19" name="__codelineno-6-19" href="#__codelineno-6-19"></a>
<a id="__codelineno-6-20" name="__codelineno-6-20" href="#__codelineno-6-20"></a>    <span class="c1"># Set market_id and selection_id as index for easy referencing</span>
<a id="__codelineno-6-21" name="__codelineno-6-21" href="#__codelineno-6-21"></a>    <span class="n">iggy_df</span> <span class="o">=</span> <span class="n">iggy_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;market_id&#39;</span><span class="p">,</span><span class="s1">&#39;selection_id&#39;</span><span class="p">])</span>
<a id="__codelineno-6-22" name="__codelineno-6-22" href="#__codelineno-6-22"></a>    <span class="k">return</span><span class="p">(</span><span class="n">iggy_df</span><span class="p">)</span>
<a id="__codelineno-6-23" name="__codelineno-6-23" href="#__codelineno-6-23"></a>
<a id="__codelineno-6-24" name="__codelineno-6-24" href="#__codelineno-6-24"></a><span class="c1"># Download historical ratings over a time period and convert into a big DataFrame.</span>
<a id="__codelineno-6-25" name="__codelineno-6-25" href="#__codelineno-6-25"></a><span class="n">back_test_period</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="s1">&#39;2022/02/27&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;2022/03/05&#39;</span><span class="p">)</span>
<a id="__codelineno-6-26" name="__codelineno-6-26" href="#__codelineno-6-26"></a><span class="n">frames</span> <span class="o">=</span> <span class="p">[</span><span class="n">download_iggy_ratings</span><span class="p">(</span><span class="n">day</span><span class="p">)</span> <span class="k">for</span> <span class="n">day</span> <span class="ow">in</span> <span class="n">back_test_period</span><span class="p">]</span>
<a id="__codelineno-6-27" name="__codelineno-6-27" href="#__codelineno-6-27"></a><span class="n">iggy_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">frames</span><span class="p">)</span>
<a id="__codelineno-6-28" name="__codelineno-6-28" href="#__codelineno-6-28"></a><span class="nb">print</span><span class="p">(</span><span class="n">iggy_df</span><span class="p">)</span>
<a id="__codelineno-6-29" name="__codelineno-6-29" href="#__codelineno-6-29"></a>
<a id="__codelineno-6-30" name="__codelineno-6-30" href="#__codelineno-6-30"></a><span class="c1"># Searches for all betfair data files within the folder sample_monthly_data_output</span>
<a id="__codelineno-6-31" name="__codelineno-6-31" href="#__codelineno-6-31"></a><span class="n">data_folder</span> <span class="o">=</span> <span class="s1">&#39;sample_monthly_data_output&#39;</span>
<a id="__codelineno-6-32" name="__codelineno-6-32" href="#__codelineno-6-32"></a><span class="n">data_files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">data_folder</span><span class="p">,)</span>
<a id="__codelineno-6-33" name="__codelineno-6-33" href="#__codelineno-6-33"></a><span class="n">data_files</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">data_folder</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">data_files</span><span class="p">]</span>
<a id="__codelineno-6-34" name="__codelineno-6-34" href="#__codelineno-6-34"></a>
<a id="__codelineno-6-35" name="__codelineno-6-35" href="#__codelineno-6-35"></a><span class="c1"># Set Flumine to simulation mode</span>
<a id="__codelineno-6-36" name="__codelineno-6-36" href="#__codelineno-6-36"></a><span class="n">client</span> <span class="o">=</span> <span class="n">clients</span><span class="o">.</span><span class="n">SimulatedClient</span><span class="p">()</span>
<a id="__codelineno-6-37" name="__codelineno-6-37" href="#__codelineno-6-37"></a><span class="n">framework</span> <span class="o">=</span> <span class="n">FlumineSimulation</span><span class="p">(</span><span class="n">client</span><span class="o">=</span><span class="n">client</span><span class="p">)</span>
<a id="__codelineno-6-38" name="__codelineno-6-38" href="#__codelineno-6-38"></a>
<a id="__codelineno-6-39" name="__codelineno-6-39" href="#__codelineno-6-39"></a><span class="c1"># Set parameters for our strategy</span>
<a id="__codelineno-6-40" name="__codelineno-6-40" href="#__codelineno-6-40"></a><span class="n">strategy</span> <span class="o">=</span> <span class="n">FlatIggyModel</span><span class="p">(</span>
<a id="__codelineno-6-41" name="__codelineno-6-41" href="#__codelineno-6-41"></a>    <span class="n">market_filter</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-6-42" name="__codelineno-6-42" href="#__codelineno-6-42"></a>        <span class="s2">&quot;markets&quot;</span><span class="p">:</span> <span class="n">data_files</span><span class="p">,</span>  
<a id="__codelineno-6-43" name="__codelineno-6-43" href="#__codelineno-6-43"></a>        <span class="s1">&#39;market_types&#39;</span><span class="p">:[</span><span class="s1">&#39;WIN&#39;</span><span class="p">],</span>
<a id="__codelineno-6-44" name="__codelineno-6-44" href="#__codelineno-6-44"></a>        <span class="s2">&quot;listener_kwargs&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;inplay&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;seconds_to_start&quot;</span><span class="p">:</span> <span class="mi">80</span><span class="p">},</span>  
<a id="__codelineno-6-45" name="__codelineno-6-45" href="#__codelineno-6-45"></a>        <span class="p">},</span>
<a id="__codelineno-6-46" name="__codelineno-6-46" href="#__codelineno-6-46"></a>    <span class="n">max_order_exposure</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
<a id="__codelineno-6-47" name="__codelineno-6-47" href="#__codelineno-6-47"></a>    <span class="n">max_selection_exposure</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
<a id="__codelineno-6-48" name="__codelineno-6-48" href="#__codelineno-6-48"></a>    <span class="n">max_live_trade_count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-6-49" name="__codelineno-6-49" href="#__codelineno-6-49"></a>    <span class="n">max_trade_count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-6-50" name="__codelineno-6-50" href="#__codelineno-6-50"></a><span class="p">)</span>
<a id="__codelineno-6-51" name="__codelineno-6-51" href="#__codelineno-6-51"></a><span class="c1"># Run our strategy on the simulated market</span>
<a id="__codelineno-6-52" name="__codelineno-6-52" href="#__codelineno-6-52"></a><span class="n">framework</span><span class="o">.</span><span class="n">add_strategy</span><span class="p">(</span><span class="n">strategy</span><span class="p">)</span>
<a id="__codelineno-6-53" name="__codelineno-6-53" href="#__codelineno-6-53"></a><span class="n">framework</span><span class="o">.</span><span class="n">add_logging_control</span><span class="p">(</span>
<a id="__codelineno-6-54" name="__codelineno-6-54" href="#__codelineno-6-54"></a>    <span class="n">BacktestLoggingControl</span><span class="p">()</span>
<a id="__codelineno-6-55" name="__codelineno-6-55" href="#__codelineno-6-55"></a><span class="p">)</span>
<a id="__codelineno-6-56" name="__codelineno-6-56" href="#__codelineno-6-56"></a><span class="n">framework</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="c1"># Import libraries</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="kn">import</span> <span class="nn">glob</span>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="kn">import</span> <span class="nn">os</span>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="kn">import</span> <span class="nn">time</span>
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="kn">import</span> <span class="nn">logging</span>
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="kn">import</span> <span class="nn">csv</span>
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a><span class="kn">from</span> <span class="nn">pythonjsonlogger</span> <span class="kn">import</span> <span class="n">jsonlogger</span>
<a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a><span class="kn">from</span> <span class="nn">flumine</span> <span class="kn">import</span> <span class="n">FlumineSimulation</span><span class="p">,</span> <span class="n">BaseStrategy</span><span class="p">,</span> <span class="n">utils</span><span class="p">,</span> <span class="n">clients</span>
<a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a><span class="kn">from</span> <span class="nn">flumine.order.trade</span> <span class="kn">import</span> <span class="n">Trade</span>
<a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a><span class="kn">from</span> <span class="nn">flumine.order.order</span> <span class="kn">import</span> <span class="n">LimitOrder</span><span class="p">,</span> <span class="n">OrderStatus</span>
<a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a><span class="kn">from</span> <span class="nn">flumine.order.ordertype</span> <span class="kn">import</span> <span class="n">OrderTypes</span>
<a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a><span class="kn">from</span> <span class="nn">flumine.markets.market</span> <span class="kn">import</span> <span class="n">Market</span>
<a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a><span class="kn">from</span> <span class="nn">flumine.controls.loggingcontrols</span> <span class="kn">import</span> <span class="n">LoggingControl</span>
<a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a><span class="kn">from</span> <span class="nn">betfairlightweight.filters</span> <span class="kn">import</span> <span class="n">streaming_market_filter</span>
<a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a><span class="kn">from</span> <span class="nn">betfairlightweight.resources</span> <span class="kn">import</span> <span class="n">MarketBook</span>
<a id="__codelineno-7-17" name="__codelineno-7-17" href="#__codelineno-7-17"></a>
<a id="__codelineno-7-18" name="__codelineno-7-18" href="#__codelineno-7-18"></a><span class="c1"># Logging</span>
<a id="__codelineno-7-19" name="__codelineno-7-19" href="#__codelineno-7-19"></a><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span>
<a id="__codelineno-7-20" name="__codelineno-7-20" href="#__codelineno-7-20"></a><span class="n">custom_format</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%(asctime) %</span><span class="s2">(levelname) %(message)&quot;</span>
<a id="__codelineno-7-21" name="__codelineno-7-21" href="#__codelineno-7-21"></a><span class="n">log_handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()</span>
<a id="__codelineno-7-22" name="__codelineno-7-22" href="#__codelineno-7-22"></a><span class="n">formatter</span> <span class="o">=</span> <span class="n">jsonlogger</span><span class="o">.</span><span class="n">JsonFormatter</span><span class="p">(</span><span class="n">custom_format</span><span class="p">)</span>
<a id="__codelineno-7-23" name="__codelineno-7-23" href="#__codelineno-7-23"></a><span class="n">formatter</span><span class="o">.</span><span class="n">converter</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">gmtime</span>
<a id="__codelineno-7-24" name="__codelineno-7-24" href="#__codelineno-7-24"></a><span class="n">log_handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
<a id="__codelineno-7-25" name="__codelineno-7-25" href="#__codelineno-7-25"></a><span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">log_handler</span><span class="p">)</span>
<a id="__codelineno-7-26" name="__codelineno-7-26" href="#__codelineno-7-26"></a><span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>  <span class="c1"># Set to logging.CRITICAL to speed up simulation</span>
<a id="__codelineno-7-27" name="__codelineno-7-27" href="#__codelineno-7-27"></a>
<a id="__codelineno-7-28" name="__codelineno-7-28" href="#__codelineno-7-28"></a><span class="k">def</span> <span class="nf">download_iggy_ratings</span><span class="p">(</span><span class="n">date</span><span class="p">):</span>
<a id="__codelineno-7-29" name="__codelineno-7-29" href="#__codelineno-7-29"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Downloads the Betfair Iggy model ratings for a given date and formats it into a nice DataFrame.</span>
<a id="__codelineno-7-30" name="__codelineno-7-30" href="#__codelineno-7-30"></a>
<a id="__codelineno-7-31" name="__codelineno-7-31" href="#__codelineno-7-31"></a><span class="sd">    Args:</span>
<a id="__codelineno-7-32" name="__codelineno-7-32" href="#__codelineno-7-32"></a><span class="sd">        date (datetime): the date we want to download the ratings for</span>
<a id="__codelineno-7-33" name="__codelineno-7-33" href="#__codelineno-7-33"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-7-34" name="__codelineno-7-34" href="#__codelineno-7-34"></a>    <span class="n">iggy_url_1</span> <span class="o">=</span> <span class="s1">&#39;https://betfair-data-supplier-prod.herokuapp.com/api/widgets/iggy-joey/datasets?date=&#39;</span>
<a id="__codelineno-7-35" name="__codelineno-7-35" href="#__codelineno-7-35"></a>    <span class="n">iggy_url_2</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-7-36" name="__codelineno-7-36" href="#__codelineno-7-36"></a>    <span class="n">iggy_url_3</span> <span class="o">=</span> <span class="s1">&#39;&amp;presenter=RatingsPresenter&amp;csv=true&#39;</span>
<a id="__codelineno-7-37" name="__codelineno-7-37" href="#__codelineno-7-37"></a>    <span class="n">iggy_url</span> <span class="o">=</span> <span class="n">iggy_url_1</span> <span class="o">+</span> <span class="n">iggy_url_2</span> <span class="o">+</span> <span class="n">iggy_url_3</span>
<a id="__codelineno-7-38" name="__codelineno-7-38" href="#__codelineno-7-38"></a>
<a id="__codelineno-7-39" name="__codelineno-7-39" href="#__codelineno-7-39"></a>    <span class="c1"># Download todays greyhounds ratings</span>
<a id="__codelineno-7-40" name="__codelineno-7-40" href="#__codelineno-7-40"></a>    <span class="n">iggy_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">iggy_url</span><span class="p">)</span>
<a id="__codelineno-7-41" name="__codelineno-7-41" href="#__codelineno-7-41"></a>
<a id="__codelineno-7-42" name="__codelineno-7-42" href="#__codelineno-7-42"></a>    <span class="c1"># Data clearning</span>
<a id="__codelineno-7-43" name="__codelineno-7-43" href="#__codelineno-7-43"></a>    <span class="n">iggy_df</span> <span class="o">=</span> <span class="n">iggy_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;meetings.races.bfExchangeMarketId&quot;</span><span class="p">:</span><span class="s2">&quot;market_id&quot;</span><span class="p">,</span><span class="s2">&quot;meetings.races.runners.bfExchangeSelectionId&quot;</span><span class="p">:</span><span class="s2">&quot;selection_id&quot;</span><span class="p">,</span><span class="s2">&quot;meetings.races.runners.ratedPrice&quot;</span><span class="p">:</span><span class="s2">&quot;rating&quot;</span><span class="p">})</span>
<a id="__codelineno-7-44" name="__codelineno-7-44" href="#__codelineno-7-44"></a>    <span class="n">iggy_df</span> <span class="o">=</span> <span class="n">iggy_df</span><span class="p">[[</span><span class="s1">&#39;market_id&#39;</span><span class="p">,</span><span class="s1">&#39;selection_id&#39;</span><span class="p">,</span><span class="s1">&#39;rating&#39;</span><span class="p">]]</span>
<a id="__codelineno-7-45" name="__codelineno-7-45" href="#__codelineno-7-45"></a>    <span class="n">iggy_df</span><span class="p">[</span><span class="s1">&#39;market_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">iggy_df</span><span class="p">[</span><span class="s1">&#39;market_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
<a id="__codelineno-7-46" name="__codelineno-7-46" href="#__codelineno-7-46"></a>
<a id="__codelineno-7-47" name="__codelineno-7-47" href="#__codelineno-7-47"></a>    <span class="c1"># Set market_id and selection_id as index for easy referencing</span>
<a id="__codelineno-7-48" name="__codelineno-7-48" href="#__codelineno-7-48"></a>    <span class="n">iggy_df</span> <span class="o">=</span> <span class="n">iggy_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;market_id&#39;</span><span class="p">,</span><span class="s1">&#39;selection_id&#39;</span><span class="p">])</span>
<a id="__codelineno-7-49" name="__codelineno-7-49" href="#__codelineno-7-49"></a>    <span class="k">return</span><span class="p">(</span><span class="n">iggy_df</span><span class="p">)</span>
<a id="__codelineno-7-50" name="__codelineno-7-50" href="#__codelineno-7-50"></a>
<a id="__codelineno-7-51" name="__codelineno-7-51" href="#__codelineno-7-51"></a><span class="c1"># Download historical ratings over a time period and convert into a big DataFrame.</span>
<a id="__codelineno-7-52" name="__codelineno-7-52" href="#__codelineno-7-52"></a><span class="n">back_test_period</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="s1">&#39;2022/02/27&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;2022/03/05&#39;</span><span class="p">)</span>
<a id="__codelineno-7-53" name="__codelineno-7-53" href="#__codelineno-7-53"></a><span class="n">frames</span> <span class="o">=</span> <span class="p">[</span><span class="n">download_iggy_ratings</span><span class="p">(</span><span class="n">day</span><span class="p">)</span> <span class="k">for</span> <span class="n">day</span> <span class="ow">in</span> <span class="n">back_test_period</span><span class="p">]</span>
<a id="__codelineno-7-54" name="__codelineno-7-54" href="#__codelineno-7-54"></a><span class="n">iggy_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">frames</span><span class="p">)</span>
<a id="__codelineno-7-55" name="__codelineno-7-55" href="#__codelineno-7-55"></a><span class="nb">print</span><span class="p">(</span><span class="n">iggy_df</span><span class="p">)</span>
<a id="__codelineno-7-56" name="__codelineno-7-56" href="#__codelineno-7-56"></a>
<a id="__codelineno-7-57" name="__codelineno-7-57" href="#__codelineno-7-57"></a><span class="c1"># Create strategy, this is the exact same strategy shown in How to Automate III</span>
<a id="__codelineno-7-58" name="__codelineno-7-58" href="#__codelineno-7-58"></a><span class="k">class</span> <span class="nc">FlatIggyModel</span><span class="p">(</span><span class="n">BaseStrategy</span><span class="p">):</span>
<a id="__codelineno-7-59" name="__codelineno-7-59" href="#__codelineno-7-59"></a>    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-7-60" name="__codelineno-7-60" href="#__codelineno-7-60"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;starting strategy &#39;FlatIggyModel&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-7-61" name="__codelineno-7-61" href="#__codelineno-7-61"></a>
<a id="__codelineno-7-62" name="__codelineno-7-62" href="#__codelineno-7-62"></a>    <span class="k">def</span> <span class="nf">check_market_book</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">market</span><span class="p">:</span> <span class="n">Market</span><span class="p">,</span> <span class="n">market_book</span><span class="p">:</span> <span class="n">MarketBook</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-7-63" name="__codelineno-7-63" href="#__codelineno-7-63"></a>        <span class="k">if</span> <span class="n">market_book</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="s2">&quot;CLOSED&quot;</span><span class="p">:</span>
<a id="__codelineno-7-64" name="__codelineno-7-64" href="#__codelineno-7-64"></a>            <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-7-65" name="__codelineno-7-65" href="#__codelineno-7-65"></a>
<a id="__codelineno-7-66" name="__codelineno-7-66" href="#__codelineno-7-66"></a>    <span class="k">def</span> <span class="nf">process_market_book</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">market</span><span class="p">:</span> <span class="n">Market</span><span class="p">,</span> <span class="n">market_book</span><span class="p">:</span> <span class="n">MarketBook</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-7-67" name="__codelineno-7-67" href="#__codelineno-7-67"></a>        <span class="k">if</span> <span class="n">market</span><span class="o">.</span><span class="n">seconds_to_start</span> <span class="o">&lt;</span> <span class="mi">60</span> <span class="ow">and</span> <span class="n">market_book</span><span class="o">.</span><span class="n">inplay</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
<a id="__codelineno-7-68" name="__codelineno-7-68" href="#__codelineno-7-68"></a>            <span class="k">for</span> <span class="n">runner</span> <span class="ow">in</span> <span class="n">market_book</span><span class="o">.</span><span class="n">runners</span><span class="p">:</span>
<a id="__codelineno-7-69" name="__codelineno-7-69" href="#__codelineno-7-69"></a>                <span class="k">if</span> <span class="n">runner</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;ACTIVE&quot;</span> <span class="ow">and</span> <span class="n">runner</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">available_to_back</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;price&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">iggy_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">market_book</span><span class="o">.</span><span class="n">market_id</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">runner</span><span class="o">.</span><span class="n">selection_id</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">():</span>
<a id="__codelineno-7-70" name="__codelineno-7-70" href="#__codelineno-7-70"></a>                    <span class="n">trade</span> <span class="o">=</span> <span class="n">Trade</span><span class="p">(</span>
<a id="__codelineno-7-71" name="__codelineno-7-71" href="#__codelineno-7-71"></a>                    <span class="n">market_id</span><span class="o">=</span><span class="n">market_book</span><span class="o">.</span><span class="n">market_id</span><span class="p">,</span>
<a id="__codelineno-7-72" name="__codelineno-7-72" href="#__codelineno-7-72"></a>                    <span class="n">selection_id</span><span class="o">=</span><span class="n">runner</span><span class="o">.</span><span class="n">selection_id</span><span class="p">,</span>
<a id="__codelineno-7-73" name="__codelineno-7-73" href="#__codelineno-7-73"></a>                    <span class="n">handicap</span><span class="o">=</span><span class="n">runner</span><span class="o">.</span><span class="n">handicap</span><span class="p">,</span>
<a id="__codelineno-7-74" name="__codelineno-7-74" href="#__codelineno-7-74"></a>                    <span class="n">strategy</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-7-75" name="__codelineno-7-75" href="#__codelineno-7-75"></a>                    <span class="p">)</span>
<a id="__codelineno-7-76" name="__codelineno-7-76" href="#__codelineno-7-76"></a>                    <span class="n">order</span> <span class="o">=</span> <span class="n">trade</span><span class="o">.</span><span class="n">create_order</span><span class="p">(</span>
<a id="__codelineno-7-77" name="__codelineno-7-77" href="#__codelineno-7-77"></a>                        <span class="n">side</span><span class="o">=</span><span class="s2">&quot;BACK&quot;</span><span class="p">,</span> <span class="n">order_type</span><span class="o">=</span><span class="n">LimitOrder</span><span class="p">(</span><span class="n">price</span><span class="o">=</span><span class="n">runner</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">available_to_back</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;price&#39;</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="mf">5.00</span><span class="p">)</span>
<a id="__codelineno-7-78" name="__codelineno-7-78" href="#__codelineno-7-78"></a>                    <span class="p">)</span>
<a id="__codelineno-7-79" name="__codelineno-7-79" href="#__codelineno-7-79"></a>                    <span class="n">market</span><span class="o">.</span><span class="n">place_order</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
<a id="__codelineno-7-80" name="__codelineno-7-80" href="#__codelineno-7-80"></a>                <span class="k">if</span> <span class="n">runner</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;ACTIVE&quot;</span> <span class="ow">and</span> <span class="n">runner</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">available_to_lay</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;price&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">iggy_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">market_book</span><span class="o">.</span><span class="n">market_id</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">runner</span><span class="o">.</span><span class="n">selection_id</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">():</span>
<a id="__codelineno-7-81" name="__codelineno-7-81" href="#__codelineno-7-81"></a>                    <span class="n">trade</span> <span class="o">=</span> <span class="n">Trade</span><span class="p">(</span>
<a id="__codelineno-7-82" name="__codelineno-7-82" href="#__codelineno-7-82"></a>                    <span class="n">market_id</span><span class="o">=</span><span class="n">market_book</span><span class="o">.</span><span class="n">market_id</span><span class="p">,</span>
<a id="__codelineno-7-83" name="__codelineno-7-83" href="#__codelineno-7-83"></a>                    <span class="n">selection_id</span><span class="o">=</span><span class="n">runner</span><span class="o">.</span><span class="n">selection_id</span><span class="p">,</span>
<a id="__codelineno-7-84" name="__codelineno-7-84" href="#__codelineno-7-84"></a>                    <span class="n">handicap</span><span class="o">=</span><span class="n">runner</span><span class="o">.</span><span class="n">handicap</span><span class="p">,</span>
<a id="__codelineno-7-85" name="__codelineno-7-85" href="#__codelineno-7-85"></a>                    <span class="n">strategy</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-7-86" name="__codelineno-7-86" href="#__codelineno-7-86"></a>                    <span class="p">)</span>
<a id="__codelineno-7-87" name="__codelineno-7-87" href="#__codelineno-7-87"></a>                    <span class="n">order</span> <span class="o">=</span> <span class="n">trade</span><span class="o">.</span><span class="n">create_order</span><span class="p">(</span>
<a id="__codelineno-7-88" name="__codelineno-7-88" href="#__codelineno-7-88"></a>                        <span class="n">side</span><span class="o">=</span><span class="s2">&quot;LAY&quot;</span><span class="p">,</span> <span class="n">order_type</span><span class="o">=</span><span class="n">LimitOrder</span><span class="p">(</span><span class="n">price</span><span class="o">=</span><span class="n">runner</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">available_to_lay</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;price&#39;</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="mf">5.00</span><span class="p">)</span>
<a id="__codelineno-7-89" name="__codelineno-7-89" href="#__codelineno-7-89"></a>                    <span class="p">)</span>
<a id="__codelineno-7-90" name="__codelineno-7-90" href="#__codelineno-7-90"></a>                    <span class="n">market</span><span class="o">.</span><span class="n">place_order</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
<a id="__codelineno-7-91" name="__codelineno-7-91" href="#__codelineno-7-91"></a>
<a id="__codelineno-7-92" name="__codelineno-7-92" href="#__codelineno-7-92"></a><span class="c1"># Fields we want to log in our simulations</span>
<a id="__codelineno-7-93" name="__codelineno-7-93" href="#__codelineno-7-93"></a><span class="n">FIELDNAMES</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-7-94" name="__codelineno-7-94" href="#__codelineno-7-94"></a>    <span class="s2">&quot;bet_id&quot;</span><span class="p">,</span>
<a id="__codelineno-7-95" name="__codelineno-7-95" href="#__codelineno-7-95"></a>    <span class="s2">&quot;strategy_name&quot;</span><span class="p">,</span>
<a id="__codelineno-7-96" name="__codelineno-7-96" href="#__codelineno-7-96"></a>    <span class="s2">&quot;market_id&quot;</span><span class="p">,</span>
<a id="__codelineno-7-97" name="__codelineno-7-97" href="#__codelineno-7-97"></a>    <span class="s2">&quot;selection_id&quot;</span><span class="p">,</span>
<a id="__codelineno-7-98" name="__codelineno-7-98" href="#__codelineno-7-98"></a>    <span class="s2">&quot;trade_id&quot;</span><span class="p">,</span>
<a id="__codelineno-7-99" name="__codelineno-7-99" href="#__codelineno-7-99"></a>    <span class="s2">&quot;date_time_placed&quot;</span><span class="p">,</span>
<a id="__codelineno-7-100" name="__codelineno-7-100" href="#__codelineno-7-100"></a>    <span class="s2">&quot;price&quot;</span><span class="p">,</span>
<a id="__codelineno-7-101" name="__codelineno-7-101" href="#__codelineno-7-101"></a>    <span class="s2">&quot;price_matched&quot;</span><span class="p">,</span>
<a id="__codelineno-7-102" name="__codelineno-7-102" href="#__codelineno-7-102"></a>    <span class="s2">&quot;size&quot;</span><span class="p">,</span>
<a id="__codelineno-7-103" name="__codelineno-7-103" href="#__codelineno-7-103"></a>    <span class="s2">&quot;size_matched&quot;</span><span class="p">,</span>
<a id="__codelineno-7-104" name="__codelineno-7-104" href="#__codelineno-7-104"></a>    <span class="s2">&quot;profit&quot;</span><span class="p">,</span>
<a id="__codelineno-7-105" name="__codelineno-7-105" href="#__codelineno-7-105"></a>    <span class="s2">&quot;side&quot;</span><span class="p">,</span>
<a id="__codelineno-7-106" name="__codelineno-7-106" href="#__codelineno-7-106"></a>    <span class="s2">&quot;elapsed_seconds_executable&quot;</span><span class="p">,</span>
<a id="__codelineno-7-107" name="__codelineno-7-107" href="#__codelineno-7-107"></a>    <span class="s2">&quot;order_status&quot;</span><span class="p">,</span>
<a id="__codelineno-7-108" name="__codelineno-7-108" href="#__codelineno-7-108"></a>    <span class="s2">&quot;market_note&quot;</span><span class="p">,</span>
<a id="__codelineno-7-109" name="__codelineno-7-109" href="#__codelineno-7-109"></a>    <span class="s2">&quot;trade_notes&quot;</span><span class="p">,</span>
<a id="__codelineno-7-110" name="__codelineno-7-110" href="#__codelineno-7-110"></a>    <span class="s2">&quot;order_notes&quot;</span><span class="p">,</span>
<a id="__codelineno-7-111" name="__codelineno-7-111" href="#__codelineno-7-111"></a><span class="p">]</span>
<a id="__codelineno-7-112" name="__codelineno-7-112" href="#__codelineno-7-112"></a>
<a id="__codelineno-7-113" name="__codelineno-7-113" href="#__codelineno-7-113"></a><span class="c1"># Log results from simulation into csv file named sim_hta_3.csv</span>
<a id="__codelineno-7-114" name="__codelineno-7-114" href="#__codelineno-7-114"></a><span class="c1"># If the csv file doesn&#39;t exist then it is created, otherwise we append results to the csv file</span>
<a id="__codelineno-7-115" name="__codelineno-7-115" href="#__codelineno-7-115"></a><span class="k">class</span> <span class="nc">BacktestLoggingControl</span><span class="p">(</span><span class="n">LoggingControl</span><span class="p">):</span>
<a id="__codelineno-7-116" name="__codelineno-7-116" href="#__codelineno-7-116"></a>    <span class="n">NAME</span> <span class="o">=</span> <span class="s2">&quot;BACKTEST_LOGGING_CONTROL&quot;</span>
<a id="__codelineno-7-117" name="__codelineno-7-117" href="#__codelineno-7-117"></a>
<a id="__codelineno-7-118" name="__codelineno-7-118" href="#__codelineno-7-118"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-7-119" name="__codelineno-7-119" href="#__codelineno-7-119"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">BacktestLoggingControl</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-7-120" name="__codelineno-7-120" href="#__codelineno-7-120"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_setup</span><span class="p">()</span>
<a id="__codelineno-7-121" name="__codelineno-7-121" href="#__codelineno-7-121"></a>
<a id="__codelineno-7-122" name="__codelineno-7-122" href="#__codelineno-7-122"></a>    <span class="k">def</span> <span class="nf">_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-7-123" name="__codelineno-7-123" href="#__codelineno-7-123"></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;sim_hta_3.csv&quot;</span><span class="p">):</span>
<a id="__codelineno-7-124" name="__codelineno-7-124" href="#__codelineno-7-124"></a>            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Results file exists&quot;</span><span class="p">)</span>
<a id="__codelineno-7-125" name="__codelineno-7-125" href="#__codelineno-7-125"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-7-126" name="__codelineno-7-126" href="#__codelineno-7-126"></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;sim_hta_3.csv&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">m</span><span class="p">:</span>
<a id="__codelineno-7-127" name="__codelineno-7-127" href="#__codelineno-7-127"></a>                <span class="n">csv_writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictWriter</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">fieldnames</span><span class="o">=</span><span class="n">FIELDNAMES</span><span class="p">)</span>
<a id="__codelineno-7-128" name="__codelineno-7-128" href="#__codelineno-7-128"></a>                <span class="n">csv_writer</span><span class="o">.</span><span class="n">writeheader</span><span class="p">()</span>
<a id="__codelineno-7-129" name="__codelineno-7-129" href="#__codelineno-7-129"></a>
<a id="__codelineno-7-130" name="__codelineno-7-130" href="#__codelineno-7-130"></a>    <span class="k">def</span> <span class="nf">_process_cleared_orders_meta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
<a id="__codelineno-7-131" name="__codelineno-7-131" href="#__codelineno-7-131"></a>        <span class="n">orders</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">event</span>
<a id="__codelineno-7-132" name="__codelineno-7-132" href="#__codelineno-7-132"></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;sim_hta_3.csv&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">m</span><span class="p">:</span>
<a id="__codelineno-7-133" name="__codelineno-7-133" href="#__codelineno-7-133"></a>            <span class="k">for</span> <span class="n">order</span> <span class="ow">in</span> <span class="n">orders</span><span class="p">:</span>
<a id="__codelineno-7-134" name="__codelineno-7-134" href="#__codelineno-7-134"></a>                <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">order_type</span><span class="o">.</span><span class="n">ORDER_TYPE</span> <span class="o">==</span> <span class="n">OrderTypes</span><span class="o">.</span><span class="n">LIMIT</span><span class="p">:</span>
<a id="__codelineno-7-135" name="__codelineno-7-135" href="#__codelineno-7-135"></a>                    <span class="n">size</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">order_type</span><span class="o">.</span><span class="n">size</span>
<a id="__codelineno-7-136" name="__codelineno-7-136" href="#__codelineno-7-136"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-7-137" name="__codelineno-7-137" href="#__codelineno-7-137"></a>                    <span class="n">size</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">order_type</span><span class="o">.</span><span class="n">liability</span>
<a id="__codelineno-7-138" name="__codelineno-7-138" href="#__codelineno-7-138"></a>                <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">order_type</span><span class="o">.</span><span class="n">ORDER_TYPE</span> <span class="o">==</span> <span class="n">OrderTypes</span><span class="o">.</span><span class="n">MARKET_ON_CLOSE</span><span class="p">:</span>
<a id="__codelineno-7-139" name="__codelineno-7-139" href="#__codelineno-7-139"></a>                    <span class="n">price</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-7-140" name="__codelineno-7-140" href="#__codelineno-7-140"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-7-141" name="__codelineno-7-141" href="#__codelineno-7-141"></a>                    <span class="n">price</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">order_type</span><span class="o">.</span><span class="n">price</span>
<a id="__codelineno-7-142" name="__codelineno-7-142" href="#__codelineno-7-142"></a>                <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-7-143" name="__codelineno-7-143" href="#__codelineno-7-143"></a>                    <span class="n">order_data</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-7-144" name="__codelineno-7-144" href="#__codelineno-7-144"></a>                        <span class="s2">&quot;bet_id&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">bet_id</span><span class="p">,</span>
<a id="__codelineno-7-145" name="__codelineno-7-145" href="#__codelineno-7-145"></a>                        <span class="s2">&quot;strategy_name&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">trade</span><span class="o">.</span><span class="n">strategy</span><span class="p">,</span>
<a id="__codelineno-7-146" name="__codelineno-7-146" href="#__codelineno-7-146"></a>                        <span class="s2">&quot;market_id&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">market_id</span><span class="p">,</span>
<a id="__codelineno-7-147" name="__codelineno-7-147" href="#__codelineno-7-147"></a>                        <span class="s2">&quot;selection_id&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">selection_id</span><span class="p">,</span>
<a id="__codelineno-7-148" name="__codelineno-7-148" href="#__codelineno-7-148"></a>                        <span class="s2">&quot;trade_id&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">trade</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
<a id="__codelineno-7-149" name="__codelineno-7-149" href="#__codelineno-7-149"></a>                        <span class="s2">&quot;date_time_placed&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">responses</span><span class="o">.</span><span class="n">date_time_placed</span><span class="p">,</span>
<a id="__codelineno-7-150" name="__codelineno-7-150" href="#__codelineno-7-150"></a>                        <span class="s2">&quot;price&quot;</span><span class="p">:</span> <span class="n">price</span><span class="p">,</span>
<a id="__codelineno-7-151" name="__codelineno-7-151" href="#__codelineno-7-151"></a>                        <span class="s2">&quot;price_matched&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">average_price_matched</span><span class="p">,</span>
<a id="__codelineno-7-152" name="__codelineno-7-152" href="#__codelineno-7-152"></a>                        <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="n">size</span><span class="p">,</span>
<a id="__codelineno-7-153" name="__codelineno-7-153" href="#__codelineno-7-153"></a>                        <span class="s2">&quot;size_matched&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">size_matched</span><span class="p">,</span>
<a id="__codelineno-7-154" name="__codelineno-7-154" href="#__codelineno-7-154"></a>                        <span class="s2">&quot;profit&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">simulated</span><span class="o">.</span><span class="n">profit</span><span class="p">,</span>
<a id="__codelineno-7-155" name="__codelineno-7-155" href="#__codelineno-7-155"></a>                        <span class="s2">&quot;side&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">side</span><span class="p">,</span>
<a id="__codelineno-7-156" name="__codelineno-7-156" href="#__codelineno-7-156"></a>                        <span class="s2">&quot;elapsed_seconds_executable&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">elapsed_seconds_executable</span><span class="p">,</span>
<a id="__codelineno-7-157" name="__codelineno-7-157" href="#__codelineno-7-157"></a>                        <span class="s2">&quot;order_status&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
<a id="__codelineno-7-158" name="__codelineno-7-158" href="#__codelineno-7-158"></a>                        <span class="s2">&quot;market_note&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">trade</span><span class="o">.</span><span class="n">market_notes</span><span class="p">,</span>
<a id="__codelineno-7-159" name="__codelineno-7-159" href="#__codelineno-7-159"></a>                        <span class="s2">&quot;trade_notes&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">trade</span><span class="o">.</span><span class="n">notes_str</span><span class="p">,</span>
<a id="__codelineno-7-160" name="__codelineno-7-160" href="#__codelineno-7-160"></a>                        <span class="s2">&quot;order_notes&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">notes_str</span><span class="p">,</span>
<a id="__codelineno-7-161" name="__codelineno-7-161" href="#__codelineno-7-161"></a>                    <span class="p">}</span>
<a id="__codelineno-7-162" name="__codelineno-7-162" href="#__codelineno-7-162"></a>                    <span class="n">csv_writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictWriter</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">fieldnames</span><span class="o">=</span><span class="n">FIELDNAMES</span><span class="p">)</span>
<a id="__codelineno-7-163" name="__codelineno-7-163" href="#__codelineno-7-163"></a>                    <span class="n">csv_writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">order_data</span><span class="p">)</span>
<a id="__codelineno-7-164" name="__codelineno-7-164" href="#__codelineno-7-164"></a>                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-7-165" name="__codelineno-7-165" href="#__codelineno-7-165"></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-7-166" name="__codelineno-7-166" href="#__codelineno-7-166"></a>                        <span class="s2">&quot;_process_cleared_orders_meta: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">,</span>
<a id="__codelineno-7-167" name="__codelineno-7-167" href="#__codelineno-7-167"></a>                        <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;order&quot;</span><span class="p">:</span> <span class="n">order</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">e</span><span class="p">},</span>
<a id="__codelineno-7-168" name="__codelineno-7-168" href="#__codelineno-7-168"></a>                    <span class="p">)</span>
<a id="__codelineno-7-169" name="__codelineno-7-169" href="#__codelineno-7-169"></a>
<a id="__codelineno-7-170" name="__codelineno-7-170" href="#__codelineno-7-170"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Orders updated&quot;</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;order_count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">orders</span><span class="p">)})</span>
<a id="__codelineno-7-171" name="__codelineno-7-171" href="#__codelineno-7-171"></a>
<a id="__codelineno-7-172" name="__codelineno-7-172" href="#__codelineno-7-172"></a>    <span class="k">def</span> <span class="nf">_process_cleared_markets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
<a id="__codelineno-7-173" name="__codelineno-7-173" href="#__codelineno-7-173"></a>        <span class="n">cleared_markets</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">event</span>
<a id="__codelineno-7-174" name="__codelineno-7-174" href="#__codelineno-7-174"></a>        <span class="k">for</span> <span class="n">cleared_market</span> <span class="ow">in</span> <span class="n">cleared_markets</span><span class="o">.</span><span class="n">orders</span><span class="p">:</span>
<a id="__codelineno-7-175" name="__codelineno-7-175" href="#__codelineno-7-175"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-7-176" name="__codelineno-7-176" href="#__codelineno-7-176"></a>                <span class="s2">&quot;Cleared market&quot;</span><span class="p">,</span>
<a id="__codelineno-7-177" name="__codelineno-7-177" href="#__codelineno-7-177"></a>                <span class="n">extra</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-7-178" name="__codelineno-7-178" href="#__codelineno-7-178"></a>                    <span class="s2">&quot;market_id&quot;</span><span class="p">:</span> <span class="n">cleared_market</span><span class="o">.</span><span class="n">market_id</span><span class="p">,</span>
<a id="__codelineno-7-179" name="__codelineno-7-179" href="#__codelineno-7-179"></a>                    <span class="s2">&quot;bet_count&quot;</span><span class="p">:</span> <span class="n">cleared_market</span><span class="o">.</span><span class="n">bet_count</span><span class="p">,</span>
<a id="__codelineno-7-180" name="__codelineno-7-180" href="#__codelineno-7-180"></a>                    <span class="s2">&quot;profit&quot;</span><span class="p">:</span> <span class="n">cleared_market</span><span class="o">.</span><span class="n">profit</span><span class="p">,</span>
<a id="__codelineno-7-181" name="__codelineno-7-181" href="#__codelineno-7-181"></a>                    <span class="s2">&quot;commission&quot;</span><span class="p">:</span> <span class="n">cleared_market</span><span class="o">.</span><span class="n">commission</span><span class="p">,</span>
<a id="__codelineno-7-182" name="__codelineno-7-182" href="#__codelineno-7-182"></a>                <span class="p">},</span>
<a id="__codelineno-7-183" name="__codelineno-7-183" href="#__codelineno-7-183"></a>            <span class="p">)</span>
<a id="__codelineno-7-184" name="__codelineno-7-184" href="#__codelineno-7-184"></a>
<a id="__codelineno-7-185" name="__codelineno-7-185" href="#__codelineno-7-185"></a><span class="c1"># Searches for all betfair data files within the folder sample_monthly_data_output</span>
<a id="__codelineno-7-186" name="__codelineno-7-186" href="#__codelineno-7-186"></a><span class="n">data_folder</span> <span class="o">=</span> <span class="s1">&#39;sample_monthly_data_output&#39;</span>
<a id="__codelineno-7-187" name="__codelineno-7-187" href="#__codelineno-7-187"></a><span class="n">data_files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">data_folder</span><span class="p">,)</span>
<a id="__codelineno-7-188" name="__codelineno-7-188" href="#__codelineno-7-188"></a><span class="n">data_files</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">data_folder</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">data_files</span><span class="p">]</span>
<a id="__codelineno-7-189" name="__codelineno-7-189" href="#__codelineno-7-189"></a>
<a id="__codelineno-7-190" name="__codelineno-7-190" href="#__codelineno-7-190"></a><span class="c1"># Set Flumine to simulation mode</span>
<a id="__codelineno-7-191" name="__codelineno-7-191" href="#__codelineno-7-191"></a><span class="n">client</span> <span class="o">=</span> <span class="n">clients</span><span class="o">.</span><span class="n">SimulatedClient</span><span class="p">()</span>
<a id="__codelineno-7-192" name="__codelineno-7-192" href="#__codelineno-7-192"></a><span class="n">framework</span> <span class="o">=</span> <span class="n">FlumineSimulation</span><span class="p">(</span><span class="n">client</span><span class="o">=</span><span class="n">client</span><span class="p">)</span>
<a id="__codelineno-7-193" name="__codelineno-7-193" href="#__codelineno-7-193"></a>
<a id="__codelineno-7-194" name="__codelineno-7-194" href="#__codelineno-7-194"></a><span class="c1"># Set parameters for our strategy</span>
<a id="__codelineno-7-195" name="__codelineno-7-195" href="#__codelineno-7-195"></a><span class="n">strategy</span> <span class="o">=</span> <span class="n">FlatIggyModel</span><span class="p">(</span>
<a id="__codelineno-7-196" name="__codelineno-7-196" href="#__codelineno-7-196"></a>    <span class="n">market_filter</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-7-197" name="__codelineno-7-197" href="#__codelineno-7-197"></a>        <span class="s2">&quot;markets&quot;</span><span class="p">:</span> <span class="n">data_files</span><span class="p">,</span>  
<a id="__codelineno-7-198" name="__codelineno-7-198" href="#__codelineno-7-198"></a>        <span class="s1">&#39;market_types&#39;</span><span class="p">:[</span><span class="s1">&#39;WIN&#39;</span><span class="p">],</span>
<a id="__codelineno-7-199" name="__codelineno-7-199" href="#__codelineno-7-199"></a>        <span class="s2">&quot;listener_kwargs&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;inplay&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;seconds_to_start&quot;</span><span class="p">:</span> <span class="mi">80</span><span class="p">},</span>  
<a id="__codelineno-7-200" name="__codelineno-7-200" href="#__codelineno-7-200"></a>        <span class="p">},</span>
<a id="__codelineno-7-201" name="__codelineno-7-201" href="#__codelineno-7-201"></a>    <span class="n">max_order_exposure</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
<a id="__codelineno-7-202" name="__codelineno-7-202" href="#__codelineno-7-202"></a>    <span class="n">max_selection_exposure</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
<a id="__codelineno-7-203" name="__codelineno-7-203" href="#__codelineno-7-203"></a>    <span class="n">max_live_trade_count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-7-204" name="__codelineno-7-204" href="#__codelineno-7-204"></a>    <span class="n">max_trade_count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-7-205" name="__codelineno-7-205" href="#__codelineno-7-205"></a><span class="p">)</span>
<a id="__codelineno-7-206" name="__codelineno-7-206" href="#__codelineno-7-206"></a><span class="c1"># Run our strategy on the simulated market</span>
<a id="__codelineno-7-207" name="__codelineno-7-207" href="#__codelineno-7-207"></a><span class="n">framework</span><span class="o">.</span><span class="n">add_strategy</span><span class="p">(</span><span class="n">strategy</span><span class="p">)</span>
<a id="__codelineno-7-208" name="__codelineno-7-208" href="#__codelineno-7-208"></a><span class="n">framework</span><span class="o">.</span><span class="n">add_logging_control</span><span class="p">(</span>
<a id="__codelineno-7-209" name="__codelineno-7-209" href="#__codelineno-7-209"></a>    <span class="n">BacktestLoggingControl</span><span class="p">()</span>
<a id="__codelineno-7-210" name="__codelineno-7-210" href="#__codelineno-7-210"></a><span class="p">)</span>
<a id="__codelineno-7-211" name="__codelineno-7-211" href="#__codelineno-7-211"></a><span class="n">framework</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</code></pre></div>
</div>
</div>
</div>
<hr />
<h2 id="simulating-how-to-automate-iv">Simulating How to Automate IV</h2>
<p>Because we coded How to Automate IV with simulating in mind (I didn't originally and had to recode it a few times), its easy for us to simulate the performance of our model. As we saved our model ratings to a csv, reading it in now actually makes the code simpler then what we created for placing live bets. This is because the issues we had working around reserve dogs and matching with the Betfair API has been taken care of (there are no reserve dogs to work around in the historic data). In fact thanks to my hacky work around in How to Automate IV the data is also in the same format as How to Automate III so we can basically use almost the exact same code we used to simulate How to Automate III. </p>
<p>The only real differences from simulating How to Automate III and How to Automate IV is that we need to have the csv file of predictions already, read that in, and change any naming conventions that might be different.</p>
<div class="tabbed-set tabbed-alternate" data-tabs="3:2"><input checked="checked" id="__tabbed_3_1" name="__tabbed_3" type="radio" /><input id="__tabbed_3_2" name="__tabbed_3" type="radio" /><div class="tabbed-labels"><label for="__tabbed_3_1">Read in model predictions and format dataframe for easy reference</label><label for="__tabbed_3_2">Complete code, almost the same as simulating How to Automate III</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="c1"># Read in predictions from hta_4</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="n">todays_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;backtest.csv&#39;</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="p">({</span><span class="s2">&quot;market_id&quot;</span><span class="p">:</span><span class="nb">str</span><span class="p">}))</span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="n">todays_data</span> <span class="o">=</span> <span class="n">todays_data</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;market_id&#39;</span><span class="p">,</span><span class="s1">&#39;selection_id&#39;</span><span class="p">])</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="c1"># Import libraries</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="kn">import</span> <span class="nn">glob</span>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="kn">import</span> <span class="nn">os</span>
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="kn">import</span> <span class="nn">time</span>
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a><span class="kn">import</span> <span class="nn">logging</span>
<a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a><span class="kn">import</span> <span class="nn">csv</span>
<a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a><span class="kn">import</span> <span class="nn">json</span>
<a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a><span class="kn">from</span> <span class="nn">pythonjsonlogger</span> <span class="kn">import</span> <span class="n">jsonlogger</span>
<a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a><span class="kn">from</span> <span class="nn">flumine</span> <span class="kn">import</span> <span class="n">FlumineSimulation</span><span class="p">,</span> <span class="n">BaseStrategy</span><span class="p">,</span> <span class="n">utils</span><span class="p">,</span> <span class="n">clients</span>
<a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a><span class="kn">from</span> <span class="nn">flumine.order.trade</span> <span class="kn">import</span> <span class="n">Trade</span>
<a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a><span class="kn">from</span> <span class="nn">flumine.order.order</span> <span class="kn">import</span> <span class="n">LimitOrder</span><span class="p">,</span> <span class="n">OrderStatus</span>
<a id="__codelineno-9-13" name="__codelineno-9-13" href="#__codelineno-9-13"></a><span class="kn">from</span> <span class="nn">flumine.order.ordertype</span> <span class="kn">import</span> <span class="n">OrderTypes</span>
<a id="__codelineno-9-14" name="__codelineno-9-14" href="#__codelineno-9-14"></a><span class="kn">from</span> <span class="nn">flumine.markets.market</span> <span class="kn">import</span> <span class="n">Market</span>
<a id="__codelineno-9-15" name="__codelineno-9-15" href="#__codelineno-9-15"></a><span class="kn">from</span> <span class="nn">flumine.controls.loggingcontrols</span> <span class="kn">import</span> <span class="n">LoggingControl</span>
<a id="__codelineno-9-16" name="__codelineno-9-16" href="#__codelineno-9-16"></a><span class="kn">from</span> <span class="nn">betfairlightweight.filters</span> <span class="kn">import</span> <span class="n">streaming_market_filter</span>
<a id="__codelineno-9-17" name="__codelineno-9-17" href="#__codelineno-9-17"></a><span class="kn">from</span> <span class="nn">betfairlightweight.resources</span> <span class="kn">import</span> <span class="n">MarketBook</span>
<a id="__codelineno-9-18" name="__codelineno-9-18" href="#__codelineno-9-18"></a><span class="kn">from</span> <span class="nn">dateutil</span> <span class="kn">import</span> <span class="n">tz</span>
<a id="__codelineno-9-19" name="__codelineno-9-19" href="#__codelineno-9-19"></a><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<a id="__codelineno-9-20" name="__codelineno-9-20" href="#__codelineno-9-20"></a><span class="kn">from</span> <span class="nn">dateutil.relativedelta</span> <span class="kn">import</span> <span class="n">relativedelta</span>
<a id="__codelineno-9-21" name="__codelineno-9-21" href="#__codelineno-9-21"></a><span class="kn">from</span> <span class="nn">betfairlightweight.resources</span> <span class="kn">import</span> <span class="n">MarketCatalogue</span>
<a id="__codelineno-9-22" name="__codelineno-9-22" href="#__codelineno-9-22"></a><span class="kn">from</span> <span class="nn">flumine.markets.middleware</span> <span class="kn">import</span> <span class="n">Middleware</span>
<a id="__codelineno-9-23" name="__codelineno-9-23" href="#__codelineno-9-23"></a>
<a id="__codelineno-9-24" name="__codelineno-9-24" href="#__codelineno-9-24"></a><span class="c1"># Logging</span>
<a id="__codelineno-9-25" name="__codelineno-9-25" href="#__codelineno-9-25"></a><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span>
<a id="__codelineno-9-26" name="__codelineno-9-26" href="#__codelineno-9-26"></a><span class="n">custom_format</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%(asctime) %</span><span class="s2">(levelname) %(message)&quot;</span>
<a id="__codelineno-9-27" name="__codelineno-9-27" href="#__codelineno-9-27"></a><span class="n">log_handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()</span>
<a id="__codelineno-9-28" name="__codelineno-9-28" href="#__codelineno-9-28"></a><span class="n">formatter</span> <span class="o">=</span> <span class="n">jsonlogger</span><span class="o">.</span><span class="n">JsonFormatter</span><span class="p">(</span><span class="n">custom_format</span><span class="p">)</span>
<a id="__codelineno-9-29" name="__codelineno-9-29" href="#__codelineno-9-29"></a><span class="n">formatter</span><span class="o">.</span><span class="n">converter</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">gmtime</span>
<a id="__codelineno-9-30" name="__codelineno-9-30" href="#__codelineno-9-30"></a><span class="n">log_handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
<a id="__codelineno-9-31" name="__codelineno-9-31" href="#__codelineno-9-31"></a><span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">log_handler</span><span class="p">)</span>
<a id="__codelineno-9-32" name="__codelineno-9-32" href="#__codelineno-9-32"></a><span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>  <span class="c1"># Set to logging.CRITICAL to speed up simulation</span>
<a id="__codelineno-9-33" name="__codelineno-9-33" href="#__codelineno-9-33"></a>
<a id="__codelineno-9-34" name="__codelineno-9-34" href="#__codelineno-9-34"></a><span class="c1"># Read in predictions from hta_4</span>
<a id="__codelineno-9-35" name="__codelineno-9-35" href="#__codelineno-9-35"></a><span class="n">todays_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;backtest.csv&#39;</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="p">({</span><span class="s2">&quot;market_id&quot;</span><span class="p">:</span><span class="nb">str</span><span class="p">}))</span>
<a id="__codelineno-9-36" name="__codelineno-9-36" href="#__codelineno-9-36"></a><span class="n">todays_data</span> <span class="o">=</span> <span class="n">todays_data</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;market_id&#39;</span><span class="p">,</span><span class="s1">&#39;selection_id&#39;</span><span class="p">])</span>
<a id="__codelineno-9-37" name="__codelineno-9-37" href="#__codelineno-9-37"></a>
<a id="__codelineno-9-38" name="__codelineno-9-38" href="#__codelineno-9-38"></a><span class="c1">### New implementation</span>
<a id="__codelineno-9-39" name="__codelineno-9-39" href="#__codelineno-9-39"></a><span class="k">class</span> <span class="nc">FlatBetting</span><span class="p">(</span><span class="n">BaseStrategy</span><span class="p">):</span>
<a id="__codelineno-9-40" name="__codelineno-9-40" href="#__codelineno-9-40"></a>    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-9-41" name="__codelineno-9-41" href="#__codelineno-9-41"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;starting strategy &#39;FlatBetting&#39; using the model we created the Greyhound modelling in Python Tutorial&quot;</span><span class="p">)</span>
<a id="__codelineno-9-42" name="__codelineno-9-42" href="#__codelineno-9-42"></a>
<a id="__codelineno-9-43" name="__codelineno-9-43" href="#__codelineno-9-43"></a>    <span class="k">def</span> <span class="nf">check_market_book</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">market</span><span class="p">:</span> <span class="n">Market</span><span class="p">,</span> <span class="n">market_book</span><span class="p">:</span> <span class="n">MarketBook</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-9-44" name="__codelineno-9-44" href="#__codelineno-9-44"></a>        <span class="k">if</span> <span class="n">market_book</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="s2">&quot;CLOSED&quot;</span><span class="p">:</span>
<a id="__codelineno-9-45" name="__codelineno-9-45" href="#__codelineno-9-45"></a>            <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-9-46" name="__codelineno-9-46" href="#__codelineno-9-46"></a>
<a id="__codelineno-9-47" name="__codelineno-9-47" href="#__codelineno-9-47"></a>    <span class="k">def</span> <span class="nf">process_market_book</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">market</span><span class="p">:</span> <span class="n">Market</span><span class="p">,</span> <span class="n">market_book</span><span class="p">:</span> <span class="n">MarketBook</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-9-48" name="__codelineno-9-48" href="#__codelineno-9-48"></a>
<a id="__codelineno-9-49" name="__codelineno-9-49" href="#__codelineno-9-49"></a>        <span class="c1"># At the 60 second mark:</span>
<a id="__codelineno-9-50" name="__codelineno-9-50" href="#__codelineno-9-50"></a>        <span class="k">if</span> <span class="n">market</span><span class="o">.</span><span class="n">seconds_to_start</span> <span class="o">&lt;</span> <span class="mi">60</span> <span class="ow">and</span> <span class="n">market_book</span><span class="o">.</span><span class="n">inplay</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
<a id="__codelineno-9-51" name="__codelineno-9-51" href="#__codelineno-9-51"></a>
<a id="__codelineno-9-52" name="__codelineno-9-52" href="#__codelineno-9-52"></a>            <span class="c1"># Can&#39;t simulate polling API</span>
<a id="__codelineno-9-53" name="__codelineno-9-53" href="#__codelineno-9-53"></a>            <span class="c1"># Only use streaming API:</span>
<a id="__codelineno-9-54" name="__codelineno-9-54" href="#__codelineno-9-54"></a>            <span class="k">for</span> <span class="n">runner</span> <span class="ow">in</span> <span class="n">market_book</span><span class="o">.</span><span class="n">runners</span><span class="p">:</span>
<a id="__codelineno-9-55" name="__codelineno-9-55" href="#__codelineno-9-55"></a>                <span class="n">model_price</span> <span class="o">=</span> <span class="n">todays_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">market</span><span class="o">.</span><span class="n">market_id</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">runner</span><span class="o">.</span><span class="n">selection_id</span><span class="p">][</span><span class="s1">&#39;rating&#39;</span><span class="p">]</span>
<a id="__codelineno-9-56" name="__codelineno-9-56" href="#__codelineno-9-56"></a>                <span class="c1"># If best available to back price is &gt; rated price then flat $5 back</span>
<a id="__codelineno-9-57" name="__codelineno-9-57" href="#__codelineno-9-57"></a>                <span class="k">if</span> <span class="n">runner</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;ACTIVE&quot;</span> <span class="ow">and</span> <span class="n">runner</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">available_to_back</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;price&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">model_price</span><span class="p">:</span>
<a id="__codelineno-9-58" name="__codelineno-9-58" href="#__codelineno-9-58"></a>                    <span class="n">trade</span> <span class="o">=</span> <span class="n">Trade</span><span class="p">(</span>
<a id="__codelineno-9-59" name="__codelineno-9-59" href="#__codelineno-9-59"></a>                    <span class="n">market_id</span><span class="o">=</span><span class="n">market_book</span><span class="o">.</span><span class="n">market_id</span><span class="p">,</span>
<a id="__codelineno-9-60" name="__codelineno-9-60" href="#__codelineno-9-60"></a>                    <span class="n">selection_id</span><span class="o">=</span><span class="n">runner</span><span class="o">.</span><span class="n">selection_id</span><span class="p">,</span>
<a id="__codelineno-9-61" name="__codelineno-9-61" href="#__codelineno-9-61"></a>                    <span class="n">handicap</span><span class="o">=</span><span class="n">runner</span><span class="o">.</span><span class="n">handicap</span><span class="p">,</span>
<a id="__codelineno-9-62" name="__codelineno-9-62" href="#__codelineno-9-62"></a>                    <span class="n">strategy</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-9-63" name="__codelineno-9-63" href="#__codelineno-9-63"></a>                    <span class="p">)</span>
<a id="__codelineno-9-64" name="__codelineno-9-64" href="#__codelineno-9-64"></a>                    <span class="n">order</span> <span class="o">=</span> <span class="n">trade</span><span class="o">.</span><span class="n">create_order</span><span class="p">(</span>
<a id="__codelineno-9-65" name="__codelineno-9-65" href="#__codelineno-9-65"></a>                        <span class="n">side</span><span class="o">=</span><span class="s2">&quot;BACK&quot;</span><span class="p">,</span> <span class="n">order_type</span><span class="o">=</span><span class="n">LimitOrder</span><span class="p">(</span><span class="n">price</span><span class="o">=</span><span class="n">runner</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">available_to_back</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;price&#39;</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="mf">5.00</span><span class="p">)</span>
<a id="__codelineno-9-66" name="__codelineno-9-66" href="#__codelineno-9-66"></a>                    <span class="p">)</span>
<a id="__codelineno-9-67" name="__codelineno-9-67" href="#__codelineno-9-67"></a>                    <span class="n">market</span><span class="o">.</span><span class="n">place_order</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
<a id="__codelineno-9-68" name="__codelineno-9-68" href="#__codelineno-9-68"></a>                <span class="c1"># If best available to lay price is &lt; rated price then flat $5 lay</span>
<a id="__codelineno-9-69" name="__codelineno-9-69" href="#__codelineno-9-69"></a>                <span class="k">if</span> <span class="n">runner</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;ACTIVE&quot;</span> <span class="ow">and</span> <span class="n">runner</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">available_to_lay</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;price&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">model_price</span><span class="p">:</span>
<a id="__codelineno-9-70" name="__codelineno-9-70" href="#__codelineno-9-70"></a>                    <span class="n">trade</span> <span class="o">=</span> <span class="n">Trade</span><span class="p">(</span>
<a id="__codelineno-9-71" name="__codelineno-9-71" href="#__codelineno-9-71"></a>                    <span class="n">market_id</span><span class="o">=</span><span class="n">market_book</span><span class="o">.</span><span class="n">market_id</span><span class="p">,</span>
<a id="__codelineno-9-72" name="__codelineno-9-72" href="#__codelineno-9-72"></a>                    <span class="n">selection_id</span><span class="o">=</span><span class="n">runner</span><span class="o">.</span><span class="n">selection_id</span><span class="p">,</span>
<a id="__codelineno-9-73" name="__codelineno-9-73" href="#__codelineno-9-73"></a>                    <span class="n">handicap</span><span class="o">=</span><span class="n">runner</span><span class="o">.</span><span class="n">handicap</span><span class="p">,</span>
<a id="__codelineno-9-74" name="__codelineno-9-74" href="#__codelineno-9-74"></a>                    <span class="n">strategy</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-9-75" name="__codelineno-9-75" href="#__codelineno-9-75"></a>                    <span class="p">)</span>
<a id="__codelineno-9-76" name="__codelineno-9-76" href="#__codelineno-9-76"></a>                    <span class="n">order</span> <span class="o">=</span> <span class="n">trade</span><span class="o">.</span><span class="n">create_order</span><span class="p">(</span>
<a id="__codelineno-9-77" name="__codelineno-9-77" href="#__codelineno-9-77"></a>                        <span class="n">side</span><span class="o">=</span><span class="s2">&quot;LAY&quot;</span><span class="p">,</span> <span class="n">order_type</span><span class="o">=</span><span class="n">LimitOrder</span><span class="p">(</span><span class="n">price</span><span class="o">=</span><span class="n">runner</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">available_to_lay</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;price&#39;</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="mf">5.00</span><span class="p">)</span>
<a id="__codelineno-9-78" name="__codelineno-9-78" href="#__codelineno-9-78"></a>                    <span class="p">)</span>
<a id="__codelineno-9-79" name="__codelineno-9-79" href="#__codelineno-9-79"></a>                    <span class="n">market</span><span class="o">.</span><span class="n">place_order</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
<a id="__codelineno-9-80" name="__codelineno-9-80" href="#__codelineno-9-80"></a>
<a id="__codelineno-9-81" name="__codelineno-9-81" href="#__codelineno-9-81"></a><span class="c1"># Fields we want to log in our simulations</span>
<a id="__codelineno-9-82" name="__codelineno-9-82" href="#__codelineno-9-82"></a><span class="n">FIELDNAMES</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-9-83" name="__codelineno-9-83" href="#__codelineno-9-83"></a>    <span class="s2">&quot;bet_id&quot;</span><span class="p">,</span>
<a id="__codelineno-9-84" name="__codelineno-9-84" href="#__codelineno-9-84"></a>    <span class="s2">&quot;strategy_name&quot;</span><span class="p">,</span>
<a id="__codelineno-9-85" name="__codelineno-9-85" href="#__codelineno-9-85"></a>    <span class="s2">&quot;market_id&quot;</span><span class="p">,</span>
<a id="__codelineno-9-86" name="__codelineno-9-86" href="#__codelineno-9-86"></a>    <span class="s2">&quot;selection_id&quot;</span><span class="p">,</span>
<a id="__codelineno-9-87" name="__codelineno-9-87" href="#__codelineno-9-87"></a>    <span class="s2">&quot;trade_id&quot;</span><span class="p">,</span>
<a id="__codelineno-9-88" name="__codelineno-9-88" href="#__codelineno-9-88"></a>    <span class="s2">&quot;date_time_placed&quot;</span><span class="p">,</span>
<a id="__codelineno-9-89" name="__codelineno-9-89" href="#__codelineno-9-89"></a>    <span class="s2">&quot;price&quot;</span><span class="p">,</span>
<a id="__codelineno-9-90" name="__codelineno-9-90" href="#__codelineno-9-90"></a>    <span class="s2">&quot;price_matched&quot;</span><span class="p">,</span>
<a id="__codelineno-9-91" name="__codelineno-9-91" href="#__codelineno-9-91"></a>    <span class="s2">&quot;size&quot;</span><span class="p">,</span>
<a id="__codelineno-9-92" name="__codelineno-9-92" href="#__codelineno-9-92"></a>    <span class="s2">&quot;size_matched&quot;</span><span class="p">,</span>
<a id="__codelineno-9-93" name="__codelineno-9-93" href="#__codelineno-9-93"></a>    <span class="s2">&quot;profit&quot;</span><span class="p">,</span>
<a id="__codelineno-9-94" name="__codelineno-9-94" href="#__codelineno-9-94"></a>    <span class="s2">&quot;side&quot;</span><span class="p">,</span>
<a id="__codelineno-9-95" name="__codelineno-9-95" href="#__codelineno-9-95"></a>    <span class="s2">&quot;elapsed_seconds_executable&quot;</span><span class="p">,</span>
<a id="__codelineno-9-96" name="__codelineno-9-96" href="#__codelineno-9-96"></a>    <span class="s2">&quot;order_status&quot;</span><span class="p">,</span>
<a id="__codelineno-9-97" name="__codelineno-9-97" href="#__codelineno-9-97"></a>    <span class="s2">&quot;market_note&quot;</span><span class="p">,</span>
<a id="__codelineno-9-98" name="__codelineno-9-98" href="#__codelineno-9-98"></a>    <span class="s2">&quot;trade_notes&quot;</span><span class="p">,</span>
<a id="__codelineno-9-99" name="__codelineno-9-99" href="#__codelineno-9-99"></a>    <span class="s2">&quot;order_notes&quot;</span><span class="p">,</span>
<a id="__codelineno-9-100" name="__codelineno-9-100" href="#__codelineno-9-100"></a><span class="p">]</span>
<a id="__codelineno-9-101" name="__codelineno-9-101" href="#__codelineno-9-101"></a>
<a id="__codelineno-9-102" name="__codelineno-9-102" href="#__codelineno-9-102"></a><span class="c1"># Log results from simulation into csv file named sim_hta_4.csv</span>
<a id="__codelineno-9-103" name="__codelineno-9-103" href="#__codelineno-9-103"></a><span class="c1"># If the csv file doesn&#39;t exist then it is created, otherwise we append results to the csv file</span>
<a id="__codelineno-9-104" name="__codelineno-9-104" href="#__codelineno-9-104"></a><span class="k">class</span> <span class="nc">BacktestLoggingControl</span><span class="p">(</span><span class="n">LoggingControl</span><span class="p">):</span>
<a id="__codelineno-9-105" name="__codelineno-9-105" href="#__codelineno-9-105"></a>    <span class="n">NAME</span> <span class="o">=</span> <span class="s2">&quot;BACKTEST_LOGGING_CONTROL&quot;</span>
<a id="__codelineno-9-106" name="__codelineno-9-106" href="#__codelineno-9-106"></a>
<a id="__codelineno-9-107" name="__codelineno-9-107" href="#__codelineno-9-107"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-9-108" name="__codelineno-9-108" href="#__codelineno-9-108"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">BacktestLoggingControl</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-9-109" name="__codelineno-9-109" href="#__codelineno-9-109"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_setup</span><span class="p">()</span>
<a id="__codelineno-9-110" name="__codelineno-9-110" href="#__codelineno-9-110"></a>
<a id="__codelineno-9-111" name="__codelineno-9-111" href="#__codelineno-9-111"></a>    <span class="k">def</span> <span class="nf">_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-9-112" name="__codelineno-9-112" href="#__codelineno-9-112"></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;sim_hta_4.csv&quot;</span><span class="p">):</span>
<a id="__codelineno-9-113" name="__codelineno-9-113" href="#__codelineno-9-113"></a>            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Results file exists&quot;</span><span class="p">)</span>
<a id="__codelineno-9-114" name="__codelineno-9-114" href="#__codelineno-9-114"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-9-115" name="__codelineno-9-115" href="#__codelineno-9-115"></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;sim_hta_4.csv&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">m</span><span class="p">:</span>
<a id="__codelineno-9-116" name="__codelineno-9-116" href="#__codelineno-9-116"></a>                <span class="n">csv_writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictWriter</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">fieldnames</span><span class="o">=</span><span class="n">FIELDNAMES</span><span class="p">)</span>
<a id="__codelineno-9-117" name="__codelineno-9-117" href="#__codelineno-9-117"></a>                <span class="n">csv_writer</span><span class="o">.</span><span class="n">writeheader</span><span class="p">()</span>
<a id="__codelineno-9-118" name="__codelineno-9-118" href="#__codelineno-9-118"></a>
<a id="__codelineno-9-119" name="__codelineno-9-119" href="#__codelineno-9-119"></a>    <span class="k">def</span> <span class="nf">_process_cleared_orders_meta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
<a id="__codelineno-9-120" name="__codelineno-9-120" href="#__codelineno-9-120"></a>        <span class="n">orders</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">event</span>
<a id="__codelineno-9-121" name="__codelineno-9-121" href="#__codelineno-9-121"></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;sim_hta_4.csv&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">m</span><span class="p">:</span>
<a id="__codelineno-9-122" name="__codelineno-9-122" href="#__codelineno-9-122"></a>            <span class="k">for</span> <span class="n">order</span> <span class="ow">in</span> <span class="n">orders</span><span class="p">:</span>
<a id="__codelineno-9-123" name="__codelineno-9-123" href="#__codelineno-9-123"></a>                <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">order_type</span><span class="o">.</span><span class="n">ORDER_TYPE</span> <span class="o">==</span> <span class="n">OrderTypes</span><span class="o">.</span><span class="n">LIMIT</span><span class="p">:</span>
<a id="__codelineno-9-124" name="__codelineno-9-124" href="#__codelineno-9-124"></a>                    <span class="n">size</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">order_type</span><span class="o">.</span><span class="n">size</span>
<a id="__codelineno-9-125" name="__codelineno-9-125" href="#__codelineno-9-125"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-9-126" name="__codelineno-9-126" href="#__codelineno-9-126"></a>                    <span class="n">size</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">order_type</span><span class="o">.</span><span class="n">liability</span>
<a id="__codelineno-9-127" name="__codelineno-9-127" href="#__codelineno-9-127"></a>                <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">order_type</span><span class="o">.</span><span class="n">ORDER_TYPE</span> <span class="o">==</span> <span class="n">OrderTypes</span><span class="o">.</span><span class="n">MARKET_ON_CLOSE</span><span class="p">:</span>
<a id="__codelineno-9-128" name="__codelineno-9-128" href="#__codelineno-9-128"></a>                    <span class="n">price</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-9-129" name="__codelineno-9-129" href="#__codelineno-9-129"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-9-130" name="__codelineno-9-130" href="#__codelineno-9-130"></a>                    <span class="n">price</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">order_type</span><span class="o">.</span><span class="n">price</span>
<a id="__codelineno-9-131" name="__codelineno-9-131" href="#__codelineno-9-131"></a>                <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-9-132" name="__codelineno-9-132" href="#__codelineno-9-132"></a>                    <span class="n">order_data</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-9-133" name="__codelineno-9-133" href="#__codelineno-9-133"></a>                        <span class="s2">&quot;bet_id&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">bet_id</span><span class="p">,</span>
<a id="__codelineno-9-134" name="__codelineno-9-134" href="#__codelineno-9-134"></a>                        <span class="s2">&quot;strategy_name&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">trade</span><span class="o">.</span><span class="n">strategy</span><span class="p">,</span>
<a id="__codelineno-9-135" name="__codelineno-9-135" href="#__codelineno-9-135"></a>                        <span class="s2">&quot;market_id&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">market_id</span><span class="p">,</span>
<a id="__codelineno-9-136" name="__codelineno-9-136" href="#__codelineno-9-136"></a>                        <span class="s2">&quot;selection_id&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">selection_id</span><span class="p">,</span>
<a id="__codelineno-9-137" name="__codelineno-9-137" href="#__codelineno-9-137"></a>                        <span class="s2">&quot;trade_id&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">trade</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
<a id="__codelineno-9-138" name="__codelineno-9-138" href="#__codelineno-9-138"></a>                        <span class="s2">&quot;date_time_placed&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">responses</span><span class="o">.</span><span class="n">date_time_placed</span><span class="p">,</span>
<a id="__codelineno-9-139" name="__codelineno-9-139" href="#__codelineno-9-139"></a>                        <span class="s2">&quot;price&quot;</span><span class="p">:</span> <span class="n">price</span><span class="p">,</span>
<a id="__codelineno-9-140" name="__codelineno-9-140" href="#__codelineno-9-140"></a>                        <span class="s2">&quot;price_matched&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">average_price_matched</span><span class="p">,</span>
<a id="__codelineno-9-141" name="__codelineno-9-141" href="#__codelineno-9-141"></a>                        <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="n">size</span><span class="p">,</span>
<a id="__codelineno-9-142" name="__codelineno-9-142" href="#__codelineno-9-142"></a>                        <span class="s2">&quot;size_matched&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">size_matched</span><span class="p">,</span>
<a id="__codelineno-9-143" name="__codelineno-9-143" href="#__codelineno-9-143"></a>                        <span class="s2">&quot;profit&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">simulated</span><span class="o">.</span><span class="n">profit</span><span class="p">,</span>
<a id="__codelineno-9-144" name="__codelineno-9-144" href="#__codelineno-9-144"></a>                        <span class="s2">&quot;side&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">side</span><span class="p">,</span>
<a id="__codelineno-9-145" name="__codelineno-9-145" href="#__codelineno-9-145"></a>                        <span class="s2">&quot;elapsed_seconds_executable&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">elapsed_seconds_executable</span><span class="p">,</span>
<a id="__codelineno-9-146" name="__codelineno-9-146" href="#__codelineno-9-146"></a>                        <span class="s2">&quot;order_status&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
<a id="__codelineno-9-147" name="__codelineno-9-147" href="#__codelineno-9-147"></a>                        <span class="s2">&quot;market_note&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">trade</span><span class="o">.</span><span class="n">market_notes</span><span class="p">,</span>
<a id="__codelineno-9-148" name="__codelineno-9-148" href="#__codelineno-9-148"></a>                        <span class="s2">&quot;trade_notes&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">trade</span><span class="o">.</span><span class="n">notes_str</span><span class="p">,</span>
<a id="__codelineno-9-149" name="__codelineno-9-149" href="#__codelineno-9-149"></a>                        <span class="s2">&quot;order_notes&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">notes_str</span><span class="p">,</span>
<a id="__codelineno-9-150" name="__codelineno-9-150" href="#__codelineno-9-150"></a>                    <span class="p">}</span>
<a id="__codelineno-9-151" name="__codelineno-9-151" href="#__codelineno-9-151"></a>                    <span class="n">csv_writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictWriter</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">fieldnames</span><span class="o">=</span><span class="n">FIELDNAMES</span><span class="p">)</span>
<a id="__codelineno-9-152" name="__codelineno-9-152" href="#__codelineno-9-152"></a>                    <span class="n">csv_writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">order_data</span><span class="p">)</span>
<a id="__codelineno-9-153" name="__codelineno-9-153" href="#__codelineno-9-153"></a>                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-9-154" name="__codelineno-9-154" href="#__codelineno-9-154"></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-9-155" name="__codelineno-9-155" href="#__codelineno-9-155"></a>                        <span class="s2">&quot;_process_cleared_orders_meta: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">,</span>
<a id="__codelineno-9-156" name="__codelineno-9-156" href="#__codelineno-9-156"></a>                        <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;order&quot;</span><span class="p">:</span> <span class="n">order</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">e</span><span class="p">},</span>
<a id="__codelineno-9-157" name="__codelineno-9-157" href="#__codelineno-9-157"></a>                    <span class="p">)</span>
<a id="__codelineno-9-158" name="__codelineno-9-158" href="#__codelineno-9-158"></a>
<a id="__codelineno-9-159" name="__codelineno-9-159" href="#__codelineno-9-159"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Orders updated&quot;</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;order_count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">orders</span><span class="p">)})</span>
<a id="__codelineno-9-160" name="__codelineno-9-160" href="#__codelineno-9-160"></a>
<a id="__codelineno-9-161" name="__codelineno-9-161" href="#__codelineno-9-161"></a>    <span class="k">def</span> <span class="nf">_process_cleared_markets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
<a id="__codelineno-9-162" name="__codelineno-9-162" href="#__codelineno-9-162"></a>        <span class="n">cleared_markets</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">event</span>
<a id="__codelineno-9-163" name="__codelineno-9-163" href="#__codelineno-9-163"></a>        <span class="k">for</span> <span class="n">cleared_market</span> <span class="ow">in</span> <span class="n">cleared_markets</span><span class="o">.</span><span class="n">orders</span><span class="p">:</span>
<a id="__codelineno-9-164" name="__codelineno-9-164" href="#__codelineno-9-164"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-9-165" name="__codelineno-9-165" href="#__codelineno-9-165"></a>                <span class="s2">&quot;Cleared market&quot;</span><span class="p">,</span>
<a id="__codelineno-9-166" name="__codelineno-9-166" href="#__codelineno-9-166"></a>                <span class="n">extra</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-9-167" name="__codelineno-9-167" href="#__codelineno-9-167"></a>                    <span class="s2">&quot;market_id&quot;</span><span class="p">:</span> <span class="n">cleared_market</span><span class="o">.</span><span class="n">market_id</span><span class="p">,</span>
<a id="__codelineno-9-168" name="__codelineno-9-168" href="#__codelineno-9-168"></a>                    <span class="s2">&quot;bet_count&quot;</span><span class="p">:</span> <span class="n">cleared_market</span><span class="o">.</span><span class="n">bet_count</span><span class="p">,</span>
<a id="__codelineno-9-169" name="__codelineno-9-169" href="#__codelineno-9-169"></a>                    <span class="s2">&quot;profit&quot;</span><span class="p">:</span> <span class="n">cleared_market</span><span class="o">.</span><span class="n">profit</span><span class="p">,</span>
<a id="__codelineno-9-170" name="__codelineno-9-170" href="#__codelineno-9-170"></a>                    <span class="s2">&quot;commission&quot;</span><span class="p">:</span> <span class="n">cleared_market</span><span class="o">.</span><span class="n">commission</span><span class="p">,</span>
<a id="__codelineno-9-171" name="__codelineno-9-171" href="#__codelineno-9-171"></a>                <span class="p">},</span>
<a id="__codelineno-9-172" name="__codelineno-9-172" href="#__codelineno-9-172"></a>            <span class="p">)</span>
<a id="__codelineno-9-173" name="__codelineno-9-173" href="#__codelineno-9-173"></a>
<a id="__codelineno-9-174" name="__codelineno-9-174" href="#__codelineno-9-174"></a><span class="c1"># Searches for all betfair data files within the folder sample_monthly_data_output</span>
<a id="__codelineno-9-175" name="__codelineno-9-175" href="#__codelineno-9-175"></a><span class="n">data_folder</span> <span class="o">=</span> <span class="s1">&#39;sample_monthly_data_output&#39;</span>
<a id="__codelineno-9-176" name="__codelineno-9-176" href="#__codelineno-9-176"></a><span class="n">data_files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">data_folder</span><span class="p">,)</span>
<a id="__codelineno-9-177" name="__codelineno-9-177" href="#__codelineno-9-177"></a><span class="n">data_files</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">data_folder</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">data_files</span><span class="p">]</span>
<a id="__codelineno-9-178" name="__codelineno-9-178" href="#__codelineno-9-178"></a>
<a id="__codelineno-9-179" name="__codelineno-9-179" href="#__codelineno-9-179"></a><span class="c1"># Set Flumine to simulation mode</span>
<a id="__codelineno-9-180" name="__codelineno-9-180" href="#__codelineno-9-180"></a><span class="n">client</span> <span class="o">=</span> <span class="n">clients</span><span class="o">.</span><span class="n">SimulatedClient</span><span class="p">()</span>
<a id="__codelineno-9-181" name="__codelineno-9-181" href="#__codelineno-9-181"></a><span class="n">framework</span> <span class="o">=</span> <span class="n">FlumineSimulation</span><span class="p">(</span><span class="n">client</span><span class="o">=</span><span class="n">client</span><span class="p">)</span>
<a id="__codelineno-9-182" name="__codelineno-9-182" href="#__codelineno-9-182"></a>
<a id="__codelineno-9-183" name="__codelineno-9-183" href="#__codelineno-9-183"></a><span class="c1"># Set parameters for our strategy</span>
<a id="__codelineno-9-184" name="__codelineno-9-184" href="#__codelineno-9-184"></a><span class="n">strategy</span> <span class="o">=</span> <span class="n">FlatBetting</span><span class="p">(</span>
<a id="__codelineno-9-185" name="__codelineno-9-185" href="#__codelineno-9-185"></a>    <span class="n">market_filter</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-9-186" name="__codelineno-9-186" href="#__codelineno-9-186"></a>        <span class="s2">&quot;markets&quot;</span><span class="p">:</span> <span class="n">data_files</span><span class="p">,</span>  
<a id="__codelineno-9-187" name="__codelineno-9-187" href="#__codelineno-9-187"></a>        <span class="s1">&#39;market_types&#39;</span><span class="p">:[</span><span class="s1">&#39;WIN&#39;</span><span class="p">],</span>
<a id="__codelineno-9-188" name="__codelineno-9-188" href="#__codelineno-9-188"></a>        <span class="s2">&quot;listener_kwargs&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;inplay&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;seconds_to_start&quot;</span><span class="p">:</span> <span class="mi">80</span><span class="p">},</span>  
<a id="__codelineno-9-189" name="__codelineno-9-189" href="#__codelineno-9-189"></a>        <span class="p">},</span>
<a id="__codelineno-9-190" name="__codelineno-9-190" href="#__codelineno-9-190"></a>    <span class="n">max_order_exposure</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
<a id="__codelineno-9-191" name="__codelineno-9-191" href="#__codelineno-9-191"></a>    <span class="n">max_selection_exposure</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
<a id="__codelineno-9-192" name="__codelineno-9-192" href="#__codelineno-9-192"></a>    <span class="n">max_live_trade_count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-9-193" name="__codelineno-9-193" href="#__codelineno-9-193"></a>    <span class="n">max_trade_count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-9-194" name="__codelineno-9-194" href="#__codelineno-9-194"></a><span class="p">)</span>
<a id="__codelineno-9-195" name="__codelineno-9-195" href="#__codelineno-9-195"></a><span class="c1"># Run our strategy on the simulated market</span>
<a id="__codelineno-9-196" name="__codelineno-9-196" href="#__codelineno-9-196"></a><span class="n">framework</span><span class="o">.</span><span class="n">add_strategy</span><span class="p">(</span><span class="n">strategy</span><span class="p">)</span>
<a id="__codelineno-9-197" name="__codelineno-9-197" href="#__codelineno-9-197"></a><span class="n">framework</span><span class="o">.</span><span class="n">add_logging_control</span><span class="p">(</span>
<a id="__codelineno-9-198" name="__codelineno-9-198" href="#__codelineno-9-198"></a>    <span class="n">BacktestLoggingControl</span><span class="p">()</span>
<a id="__codelineno-9-199" name="__codelineno-9-199" href="#__codelineno-9-199"></a><span class="p">)</span>
<a id="__codelineno-9-200" name="__codelineno-9-200" href="#__codelineno-9-200"></a><span class="n">framework</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</code></pre></div>
</div>
</div>
</div>
<hr />
<h2 id="gotta-go-fast">Gotta go fast</h2>
<p>Now that we have everything working, if you have tried any of the simulations you may notice its pretty slow. I definitely have, especially for larger files such as on 1 months worth of data (probably took me around 8 hours of just running the code in the background). The good thing is we can speed it up, the bad thing is, its via multiprocessing which I have never touched before. But turns out its not too bad. </p>
<p>You really only need to wrap your Flumine client into a function:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="k">def</span> <span class="nf">run_process</span><span class="p">(</span><span class="n">markets</span><span class="p">):</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Replays a Betfair historic data. Places bets according to the user defined strategy and tries to accurately simulate matching by replaying the historic data.</span>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a>
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a><span class="sd">    Args:</span>
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a><span class="sd">        markets (list: [file paths]): a list of file paths to where the historic data is stored locally. e.g. user/zhoui/downloads/test.csv</span>
<a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a><span class="sd">    &quot;&quot;&quot;</span>    
<a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a>    <span class="c1"># Set Flumine to simulation mode</span>
<a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a>    <span class="n">client</span> <span class="o">=</span> <span class="n">clients</span><span class="o">.</span><span class="n">SimulatedClient</span><span class="p">()</span>
<a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a>    <span class="n">framework</span> <span class="o">=</span> <span class="n">FlumineSimulation</span><span class="p">(</span><span class="n">client</span><span class="o">=</span><span class="n">client</span><span class="p">)</span>
<a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a>
<a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a>    <span class="c1"># Set parameters for our strategy</span>
<a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a>    <span class="n">strategy</span> <span class="o">=</span> <span class="n">FlatBetting</span><span class="p">(</span>
<a id="__codelineno-10-13" name="__codelineno-10-13" href="#__codelineno-10-13"></a>        <span class="n">market_filter</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-10-14" name="__codelineno-10-14" href="#__codelineno-10-14"></a>            <span class="s2">&quot;markets&quot;</span><span class="p">:</span> <span class="n">markets</span><span class="p">,</span>  
<a id="__codelineno-10-15" name="__codelineno-10-15" href="#__codelineno-10-15"></a>            <span class="s1">&#39;market_types&#39;</span><span class="p">:[</span><span class="s1">&#39;WIN&#39;</span><span class="p">],</span>
<a id="__codelineno-10-16" name="__codelineno-10-16" href="#__codelineno-10-16"></a>            <span class="s2">&quot;listener_kwargs&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;inplay&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;seconds_to_start&quot;</span><span class="p">:</span> <span class="mi">80</span><span class="p">},</span>  
<a id="__codelineno-10-17" name="__codelineno-10-17" href="#__codelineno-10-17"></a>            <span class="p">},</span>
<a id="__codelineno-10-18" name="__codelineno-10-18" href="#__codelineno-10-18"></a>        <span class="n">max_order_exposure</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
<a id="__codelineno-10-19" name="__codelineno-10-19" href="#__codelineno-10-19"></a>        <span class="n">max_selection_exposure</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
<a id="__codelineno-10-20" name="__codelineno-10-20" href="#__codelineno-10-20"></a>        <span class="n">max_live_trade_count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-10-21" name="__codelineno-10-21" href="#__codelineno-10-21"></a>        <span class="n">max_trade_count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-10-22" name="__codelineno-10-22" href="#__codelineno-10-22"></a>    <span class="p">)</span>
<a id="__codelineno-10-23" name="__codelineno-10-23" href="#__codelineno-10-23"></a>    <span class="c1"># Run our strategy on the simulated market</span>
<a id="__codelineno-10-24" name="__codelineno-10-24" href="#__codelineno-10-24"></a>    <span class="n">framework</span><span class="o">.</span><span class="n">add_strategy</span><span class="p">(</span><span class="n">strategy</span><span class="p">)</span>
<a id="__codelineno-10-25" name="__codelineno-10-25" href="#__codelineno-10-25"></a>    <span class="n">framework</span><span class="o">.</span><span class="n">add_logging_control</span><span class="p">(</span>
<a id="__codelineno-10-26" name="__codelineno-10-26" href="#__codelineno-10-26"></a>        <span class="n">BacktestLoggingControl</span><span class="p">()</span>
<a id="__codelineno-10-27" name="__codelineno-10-27" href="#__codelineno-10-27"></a>    <span class="p">)</span>
<a id="__codelineno-10-28" name="__codelineno-10-28" href="#__codelineno-10-28"></a>    <span class="n">framework</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
<a id="__codelineno-10-29" name="__codelineno-10-29" href="#__codelineno-10-29"></a>
<a id="__codelineno-10-30" name="__codelineno-10-30" href="#__codelineno-10-30"></a><span class="c1"># Searches for all betfair data files within the folder sample_monthly_data_output</span>
<a id="__codelineno-10-31" name="__codelineno-10-31" href="#__codelineno-10-31"></a><span class="n">data_folder</span> <span class="o">=</span> <span class="s1">&#39;sample_monthly_data_output&#39;</span>
<a id="__codelineno-10-32" name="__codelineno-10-32" href="#__codelineno-10-32"></a><span class="n">data_files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">data_folder</span><span class="p">,)</span>
<a id="__codelineno-10-33" name="__codelineno-10-33" href="#__codelineno-10-33"></a><span class="n">data_files</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">data_folder</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">data_files</span><span class="p">]</span>
</code></pre></div>
<p>and then split the files to run on muliple processors. You can copy the code, which is what I did, and it works without a hitch. </p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="c1"># Multi processing</span>
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a>    <span class="n">all_markets</span> <span class="o">=</span> <span class="n">data_files</span>  <span class="c1"># All the markets we want to simulate</span>
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a>    <span class="n">processes</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span>  <span class="c1"># Returns the number of CPUs in the system.</span>
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a>    <span class="n">markets_per_process</span> <span class="o">=</span> <span class="mi">8</span>   <span class="c1"># 8 is optimal as it prevents data leakage.</span>
<a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a>
<a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a>    <span class="n">_process_jobs</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a>    <span class="k">with</span> <span class="n">futures</span><span class="o">.</span><span class="n">ProcessPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="n">processes</span><span class="p">)</span> <span class="k">as</span> <span class="n">p</span><span class="p">:</span>
<a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a>        <span class="c1"># Number of chunks to split the process into depends on the number of markets we want to process and number of CPUs we have.</span>
<a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a>        <span class="n">chunk</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
<a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a>            <span class="n">markets_per_process</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_markets</span><span class="p">)</span> <span class="o">/</span> <span class="n">processes</span><span class="p">)</span>
<a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a>        <span class="p">)</span>
<a id="__codelineno-11-13" name="__codelineno-11-13" href="#__codelineno-11-13"></a>        <span class="c1"># Split all the markets we want to process into chunks to run on separate CPUs and then run them on the separate CPUs</span>
<a id="__codelineno-11-14" name="__codelineno-11-14" href="#__codelineno-11-14"></a>        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">chunks</span><span class="p">(</span><span class="n">all_markets</span><span class="p">,</span> <span class="n">chunk</span><span class="p">)):</span>
<a id="__codelineno-11-15" name="__codelineno-11-15" href="#__codelineno-11-15"></a>            <span class="n">_process_jobs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
<a id="__codelineno-11-16" name="__codelineno-11-16" href="#__codelineno-11-16"></a>                <span class="n">p</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span>
<a id="__codelineno-11-17" name="__codelineno-11-17" href="#__codelineno-11-17"></a>                    <span class="n">run_process</span><span class="p">,</span>
<a id="__codelineno-11-18" name="__codelineno-11-18" href="#__codelineno-11-18"></a>                    <span class="n">markets</span><span class="o">=</span><span class="n">m</span><span class="p">,</span>
<a id="__codelineno-11-19" name="__codelineno-11-19" href="#__codelineno-11-19"></a>                <span class="p">)</span>
<a id="__codelineno-11-20" name="__codelineno-11-20" href="#__codelineno-11-20"></a>            <span class="p">)</span>
<a id="__codelineno-11-21" name="__codelineno-11-21" href="#__codelineno-11-21"></a>        <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">futures</span><span class="o">.</span><span class="n">as_completed</span><span class="p">(</span><span class="n">_process_jobs</span><span class="p">):</span>
<a id="__codelineno-11-22" name="__codelineno-11-22" href="#__codelineno-11-22"></a>            <span class="n">job</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>  <span class="c1"># wait for result</span>
</code></pre></div>
<p>Essentially it takes all the historical markets you have e.g. 1000, and splits it into 8 chunks. Then we run our strategy on all 8 chunks simultaniously. And this gives serious speed improvements. The complete code for all three simulations using multi processing are available at the end of this post. </p>
<p>Future versions of Flumine are using the new BetfairData library to speed up simulations which once fully implemented should also give some serious speed benefits. </p>
<hr />
<h2 id="analysing-and-optimising-our-results">Analysing and optimising our results</h2>
<p>Now that we have all our speedy simulation code lets look at our results and see if we found anything good.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="kn">import</span> <span class="nn">plotly.express</span> <span class="k">as</span> <span class="nn">px</span>
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a>
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="c1"># Read data</span>
<a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a><span class="n">results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;sim_hta_4.csv&#39;</span><span class="p">,</span> <span class="n">parse_dates</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;date_time_placed&#39;</span><span class="p">],</span> <span class="n">dtype</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;market_id&#39;</span><span class="p">:</span><span class="nb">str</span><span class="p">})</span>
<a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a><span class="c1"># calculate and display cumulative pnl</span>
<a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a><span class="n">results</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;date_time_placed&#39;</span><span class="p">])</span>
<a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a><span class="n">results</span><span class="p">[</span><span class="s1">&#39;cum_profit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;profit&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
<a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a><span class="n">px</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="s1">&#39;date_time_placed&#39;</span><span class="p">,</span> <span class="s1">&#39;cum_profit&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<p><img alt="post_sim_analysis_v1" src="../hta_img/post_sim_analysis_v1.png" /></p>
<p>Before commissions the model is profitable, which is awesome as I didn't think that would be the case. Bruno has mentioned to me that the model in the tutorial was quite "basic" and not profitable, but it seems we got super lucky with a few long shots getting up in March. Lets incorporate commissions into our results and see if it remains profitable:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="n">gross_profit</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;market_id&#39;</span><span class="p">])[</span><span class="s1">&#39;profit&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="c1"># 7% commission rate on greyhounds, commissions calculated on profit at a market level</span>
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="n">calc_comms</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">gross_profit</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">gross_profit</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span> <span class="n">gross_profit</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="mf">0.07</span><span class="p">),</span> <span class="n">gross_profit</span><span class="p">)</span>
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a><span class="n">gross_profit</span><span class="p">[</span><span class="s1">&#39;net_pnl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">calc_comms</span><span class="p">(</span><span class="n">gross_profit</span><span class="p">[</span><span class="s1">&#39;profit&#39;</span><span class="p">])</span>
<a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a><span class="n">gross_profit</span><span class="p">[</span><span class="s1">&#39;cum_npl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gross_profit</span><span class="p">[</span><span class="s1">&#39;net_pnl&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
<a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a><span class="n">px</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">gross_profit</span><span class="p">,</span> <span class="n">gross_profit</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;cum_npl&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<p><img alt="post_sim_analysis_v2" src="../hta_img/post_sim_analysis_v2.png" /></p>
<p>We are close, infact we were up a bit at the start but it seems after taking into account commissions we are no longer profitable and end the month down around $800. Lets try two different things to see if we can optimse our strategy: a different staking methodology and also a different time we start placing our bets.</p>
<p>My theory is that because we are crossing the spread and taking whatever prices are available we are probably losing a bit of our edge there. If we bet when markets are more liquid then we will may lose less. But as markets become more liquid they also tend to become more efficient so lets it could work against us. Nonetheless lets test it out:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="4:3"><input checked="checked" id="__tabbed_4_1" name="__tabbed_4" type="radio" /><input id="__tabbed_4_2" name="__tabbed_4" type="radio" /><input id="__tabbed_4_3" name="__tabbed_4" type="radio" /><div class="tabbed-labels"><label for="__tabbed_4_1">Placing bets at 30 seconds instead of 60 seconds</label><label for="__tabbed_4_2">Results Before Commissions</label><label for="__tabbed_4_3">Results After Commissions</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="k">def</span> <span class="nf">process_market_book</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">market</span><span class="p">:</span> <span class="n">Market</span><span class="p">,</span> <span class="n">market_book</span><span class="p">:</span> <span class="n">MarketBook</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a>    <span class="c1"># At the 60 second mark:</span>
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a>    <span class="k">if</span> <span class="n">market</span><span class="o">.</span><span class="n">seconds_to_start</span> <span class="o">&lt;</span> <span class="mi">30</span> <span class="ow">and</span> <span class="n">market_book</span><span class="o">.</span><span class="n">inplay</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
<a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a>        <span class="c1"># Can&#39;t simulate polling API</span>
<a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a>        <span class="c1"># Only use streaming API:</span>
<a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a>        <span class="k">for</span> <span class="n">runner</span> <span class="ow">in</span> <span class="n">market_book</span><span class="o">.</span><span class="n">runners</span><span class="p">:</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p><img alt="post_sim_analysis_30secs" src="../hta_img/post_sim_analysis_30secs.png" /></p>
</div>
<div class="tabbed-block">
<p><img alt="post_sim_analysis_30secs_v2" src="../hta_img/post_sim_analysis_30secs_v2.png" /></p>
</div>
</div>
</div>
<p>So the results seem pretty similar to before. After commisions we are down around $700 so we seem to be doing slighlty better.</p>
<p>Lets try a different staking method instead, this time I have opted for a proportional staking strategy going for a fixed $10 profit on back bets and a fixed $10 liability on lay bets. There is an excellent post <a href="https://betfair-datascientists.github.io/wagering/stakingMethods/">analysing different staking methods</a> and I would encourage everyone to take a look at it. Lets see how our simulation went:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="5:3"><input checked="checked" id="__tabbed_5_1" name="__tabbed_5" type="radio" /><input id="__tabbed_5_2" name="__tabbed_5" type="radio" /><input id="__tabbed_5_3" name="__tabbed_5" type="radio" /><div class="tabbed-labels"><label for="__tabbed_5_1">Proportional Staking instead of Flat Staking</label><label for="__tabbed_5_2">Results Before Commissions</label><label for="__tabbed_5_3">Results After Commissions</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="k">if</span> <span class="n">market</span><span class="o">.</span><span class="n">seconds_to_start</span> <span class="o">&lt;</span> <span class="mi">60</span> <span class="ow">and</span> <span class="n">market_book</span><span class="o">.</span><span class="n">inplay</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a>    <span class="c1"># Can&#39;t simulate polling API</span>
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a>    <span class="c1"># Only use streaming API:</span>
<a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a>    <span class="k">for</span> <span class="n">runner</span> <span class="ow">in</span> <span class="n">market_book</span><span class="o">.</span><span class="n">runners</span><span class="p">:</span>
<a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a>        <span class="n">model_price</span> <span class="o">=</span> <span class="n">todays_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">market</span><span class="o">.</span><span class="n">market_id</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">runner</span><span class="o">.</span><span class="n">selection_id</span><span class="p">][</span><span class="s1">&#39;rating&#39;</span><span class="p">]</span>
<a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a>        <span class="c1"># If best available to back price is &gt; rated price then proportional back stake</span>
<a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a>        <span class="k">if</span> <span class="n">runner</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;ACTIVE&quot;</span> <span class="ow">and</span> <span class="n">runner</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">available_to_back</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;price&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">model_price</span><span class="p">:</span>
<a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a>            <span class="n">trade</span> <span class="o">=</span> <span class="n">Trade</span><span class="p">(</span>
<a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a>            <span class="n">market_id</span><span class="o">=</span><span class="n">market_book</span><span class="o">.</span><span class="n">market_id</span><span class="p">,</span>
<a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a>            <span class="n">selection_id</span><span class="o">=</span><span class="n">runner</span><span class="o">.</span><span class="n">selection_id</span><span class="p">,</span>
<a id="__codelineno-15-11" name="__codelineno-15-11" href="#__codelineno-15-11"></a>            <span class="n">handicap</span><span class="o">=</span><span class="n">runner</span><span class="o">.</span><span class="n">handicap</span><span class="p">,</span>
<a id="__codelineno-15-12" name="__codelineno-15-12" href="#__codelineno-15-12"></a>            <span class="n">strategy</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-15-13" name="__codelineno-15-13" href="#__codelineno-15-13"></a>            <span class="p">)</span>
<a id="__codelineno-15-14" name="__codelineno-15-14" href="#__codelineno-15-14"></a>            <span class="n">order</span> <span class="o">=</span> <span class="n">trade</span><span class="o">.</span><span class="n">create_order</span><span class="p">(</span>
<a id="__codelineno-15-15" name="__codelineno-15-15" href="#__codelineno-15-15"></a>                <span class="n">side</span><span class="o">=</span><span class="s2">&quot;BACK&quot;</span><span class="p">,</span> <span class="n">order_type</span><span class="o">=</span><span class="n">LimitOrder</span><span class="p">(</span><span class="n">price</span><span class="o">=</span><span class="n">runner</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">available_to_back</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;price&#39;</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="mi">10</span><span class="o">/</span><span class="p">(</span><span class="n">runner</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">available_to_back</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;price&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="mi">2</span><span class="p">))</span>
<a id="__codelineno-15-16" name="__codelineno-15-16" href="#__codelineno-15-16"></a>            <span class="p">)</span>
<a id="__codelineno-15-17" name="__codelineno-15-17" href="#__codelineno-15-17"></a>            <span class="n">market</span><span class="o">.</span><span class="n">place_order</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
<a id="__codelineno-15-18" name="__codelineno-15-18" href="#__codelineno-15-18"></a>        <span class="c1"># If best available to lay price is &lt; rated price then proportional lay stake</span>
<a id="__codelineno-15-19" name="__codelineno-15-19" href="#__codelineno-15-19"></a>        <span class="k">if</span> <span class="n">runner</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;ACTIVE&quot;</span> <span class="ow">and</span> <span class="n">runner</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">available_to_lay</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;price&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">model_price</span><span class="p">:</span>
<a id="__codelineno-15-20" name="__codelineno-15-20" href="#__codelineno-15-20"></a>            <span class="n">trade</span> <span class="o">=</span> <span class="n">Trade</span><span class="p">(</span>
<a id="__codelineno-15-21" name="__codelineno-15-21" href="#__codelineno-15-21"></a>            <span class="n">market_id</span><span class="o">=</span><span class="n">market_book</span><span class="o">.</span><span class="n">market_id</span><span class="p">,</span>
<a id="__codelineno-15-22" name="__codelineno-15-22" href="#__codelineno-15-22"></a>            <span class="n">selection_id</span><span class="o">=</span><span class="n">runner</span><span class="o">.</span><span class="n">selection_id</span><span class="p">,</span>
<a id="__codelineno-15-23" name="__codelineno-15-23" href="#__codelineno-15-23"></a>            <span class="n">handicap</span><span class="o">=</span><span class="n">runner</span><span class="o">.</span><span class="n">handicap</span><span class="p">,</span>
<a id="__codelineno-15-24" name="__codelineno-15-24" href="#__codelineno-15-24"></a>            <span class="n">strategy</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-15-25" name="__codelineno-15-25" href="#__codelineno-15-25"></a>            <span class="p">)</span>
<a id="__codelineno-15-26" name="__codelineno-15-26" href="#__codelineno-15-26"></a>            <span class="n">order</span> <span class="o">=</span> <span class="n">trade</span><span class="o">.</span><span class="n">create_order</span><span class="p">(</span>
<a id="__codelineno-15-27" name="__codelineno-15-27" href="#__codelineno-15-27"></a>                <span class="n">side</span><span class="o">=</span><span class="s2">&quot;LAY&quot;</span><span class="p">,</span> <span class="n">order_type</span><span class="o">=</span><span class="n">LimitOrder</span><span class="p">(</span><span class="n">price</span><span class="o">=</span><span class="n">runner</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">available_to_lay</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;price&#39;</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="mi">10</span><span class="o">/</span><span class="p">(</span><span class="n">runner</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">available_to_lay</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;price&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="mi">2</span><span class="p">))</span>
<a id="__codelineno-15-28" name="__codelineno-15-28" href="#__codelineno-15-28"></a>            <span class="p">)</span>
<a id="__codelineno-15-29" name="__codelineno-15-29" href="#__codelineno-15-29"></a>            <span class="n">market</span><span class="o">.</span><span class="n">place_order</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p><img alt="post_sim_analysis_ps" src="../hta_img/post_sim_analysis_ps.png" /></p>
</div>
<div class="tabbed-block">
<p><img alt="post_sim_analysis_ps_v2" src="../hta_img/post_sim_analysis_ps_v2.png" /></p>
</div>
</div>
</div>
<p>I'm pretty surprised, I really did not expect to be profitable after commissions. We are slightly profitable at the end but we spent a significant amount of time in the negatives during the month. Without testing it out further with more historic data I going to put this down as variance for now. And I'll hand it over to you.</p>
<hr />
<h2 id="conclusion-and-next-steps">Conclusion and next steps</h2>
<p>While we have tested our strategy and optimised it so far, I mearly tried one month of data and only three different variations of our strategy (most of which are unprofitable). Hopefully these posts help you think about what is possible when automating your strategy and how to optimise your strategy. </p>
<p>There are plenty of other things to look at when optimising your strategy such as different staking methodologies or being more selective with your bets based on the track or state. The natural next step based on my above results would be to test out proportional staking at 30 seconds and to use a longer backtesting period.</p>
<p>We need more data to draw a good conclusion about long term results, I have definitely found some strategies that fluke one month, but are long term losers using this method.</p>
<h3 id="complete-code">Complete Code</h3>
<div class="tabbed-set tabbed-alternate" data-tabs="6:3"><input checked="checked" id="__tabbed_6_1" name="__tabbed_6" type="radio" /><input id="__tabbed_6_2" name="__tabbed_6" type="radio" /><input id="__tabbed_6_3" name="__tabbed_6" type="radio" /><div class="tabbed-labels"><label for="__tabbed_6_1">Multiprocess How to Automate II</label><label for="__tabbed_6_2">Multiprocess How to Automate III</label><label for="__tabbed_6_3">Multiprocess How to Automate IV</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p><a href="https://github.com/betfair-down-under/autoHubTutorials/tree/master">Download from Github</a></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="c1"># Import libraries</span>
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="kn">import</span> <span class="nn">glob</span>
<a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="kn">import</span> <span class="nn">os</span>
<a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a><span class="kn">import</span> <span class="nn">time</span>
<a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a><span class="kn">import</span> <span class="nn">logging</span>
<a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a><span class="kn">import</span> <span class="nn">csv</span>
<a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a><span class="kn">import</span> <span class="nn">math</span>
<a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a><span class="kn">from</span> <span class="nn">pythonjsonlogger</span> <span class="kn">import</span> <span class="n">jsonlogger</span>
<a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a><span class="kn">from</span> <span class="nn">concurrent</span> <span class="kn">import</span> <span class="n">futures</span>
<a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a><span class="kn">from</span> <span class="nn">flumine</span> <span class="kn">import</span> <span class="n">FlumineSimulation</span><span class="p">,</span> <span class="n">clients</span><span class="p">,</span> <span class="n">utils</span>
<a id="__codelineno-16-11" name="__codelineno-16-11" href="#__codelineno-16-11"></a><span class="kn">from</span> <span class="nn">flumine.controls.loggingcontrols</span> <span class="kn">import</span> <span class="n">LoggingControl</span>
<a id="__codelineno-16-12" name="__codelineno-16-12" href="#__codelineno-16-12"></a><span class="kn">from</span> <span class="nn">flumine.order.ordertype</span> <span class="kn">import</span> <span class="n">OrderTypes</span>
<a id="__codelineno-16-13" name="__codelineno-16-13" href="#__codelineno-16-13"></a>
<a id="__codelineno-16-14" name="__codelineno-16-14" href="#__codelineno-16-14"></a><span class="kn">from</span> <span class="nn">flumine</span> <span class="kn">import</span> <span class="n">BaseStrategy</span> 
<a id="__codelineno-16-15" name="__codelineno-16-15" href="#__codelineno-16-15"></a><span class="kn">from</span> <span class="nn">flumine.order.trade</span> <span class="kn">import</span> <span class="n">Trade</span>
<a id="__codelineno-16-16" name="__codelineno-16-16" href="#__codelineno-16-16"></a><span class="kn">from</span> <span class="nn">flumine.order.order</span> <span class="kn">import</span> <span class="n">LimitOrder</span><span class="p">,</span> <span class="n">OrderStatus</span>
<a id="__codelineno-16-17" name="__codelineno-16-17" href="#__codelineno-16-17"></a><span class="kn">from</span> <span class="nn">flumine.markets.market</span> <span class="kn">import</span> <span class="n">Market</span>
<a id="__codelineno-16-18" name="__codelineno-16-18" href="#__codelineno-16-18"></a><span class="kn">from</span> <span class="nn">betfairlightweight.filters</span> <span class="kn">import</span> <span class="n">streaming_market_filter</span>
<a id="__codelineno-16-19" name="__codelineno-16-19" href="#__codelineno-16-19"></a><span class="kn">from</span> <span class="nn">betfairlightweight.resources</span> <span class="kn">import</span> <span class="n">MarketBook</span>
<a id="__codelineno-16-20" name="__codelineno-16-20" href="#__codelineno-16-20"></a>
<a id="__codelineno-16-21" name="__codelineno-16-21" href="#__codelineno-16-21"></a><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<a id="__codelineno-16-22" name="__codelineno-16-22" href="#__codelineno-16-22"></a><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<a id="__codelineno-16-23" name="__codelineno-16-23" href="#__codelineno-16-23"></a><span class="kn">import</span> <span class="nn">logging</span>
<a id="__codelineno-16-24" name="__codelineno-16-24" href="#__codelineno-16-24"></a>
<a id="__codelineno-16-25" name="__codelineno-16-25" href="#__codelineno-16-25"></a><span class="c1"># Logging</span>
<a id="__codelineno-16-26" name="__codelineno-16-26" href="#__codelineno-16-26"></a><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span>
<a id="__codelineno-16-27" name="__codelineno-16-27" href="#__codelineno-16-27"></a><span class="n">custom_format</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%(asctime) %</span><span class="s2">(levelname) %(message)&quot;</span>
<a id="__codelineno-16-28" name="__codelineno-16-28" href="#__codelineno-16-28"></a><span class="n">log_handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()</span>
<a id="__codelineno-16-29" name="__codelineno-16-29" href="#__codelineno-16-29"></a><span class="n">formatter</span> <span class="o">=</span> <span class="n">jsonlogger</span><span class="o">.</span><span class="n">JsonFormatter</span><span class="p">(</span><span class="n">custom_format</span><span class="p">)</span>
<a id="__codelineno-16-30" name="__codelineno-16-30" href="#__codelineno-16-30"></a><span class="n">formatter</span><span class="o">.</span><span class="n">converter</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">gmtime</span>
<a id="__codelineno-16-31" name="__codelineno-16-31" href="#__codelineno-16-31"></a><span class="n">log_handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
<a id="__codelineno-16-32" name="__codelineno-16-32" href="#__codelineno-16-32"></a><span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">log_handler</span><span class="p">)</span>
<a id="__codelineno-16-33" name="__codelineno-16-33" href="#__codelineno-16-33"></a><span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>  <span class="c1"># Set to logging.CRITICAL to speed up simulation</span>
<a id="__codelineno-16-34" name="__codelineno-16-34" href="#__codelineno-16-34"></a>
<a id="__codelineno-16-35" name="__codelineno-16-35" href="#__codelineno-16-35"></a><span class="c1"># Create a new strategy as a new class called BackFavStrategy, this in turn will allow us to create a new Python object later</span>
<a id="__codelineno-16-36" name="__codelineno-16-36" href="#__codelineno-16-36"></a>    <span class="c1"># BackFavStrategy is a child class inhereting from a predefined class in Flumine we imported above called BaseStrategy</span>
<a id="__codelineno-16-37" name="__codelineno-16-37" href="#__codelineno-16-37"></a><span class="k">class</span> <span class="nc">BackFavStrategy</span><span class="p">(</span><span class="n">BaseStrategy</span><span class="p">):</span>
<a id="__codelineno-16-38" name="__codelineno-16-38" href="#__codelineno-16-38"></a>    <span class="c1"># Defines what happens when we start our strategy i.e. this method will run once when we first start running our strategy</span>
<a id="__codelineno-16-39" name="__codelineno-16-39" href="#__codelineno-16-39"></a>    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-16-40" name="__codelineno-16-40" href="#__codelineno-16-40"></a>        <span class="c1"># We will want to change what is printed with we have multiple strategies</span>
<a id="__codelineno-16-41" name="__codelineno-16-41" href="#__codelineno-16-41"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;starting strategy &#39;BackFavStrategy&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-16-42" name="__codelineno-16-42" href="#__codelineno-16-42"></a>
<a id="__codelineno-16-43" name="__codelineno-16-43" href="#__codelineno-16-43"></a>    <span class="c1"># Defines what happens when we first look at a market</span>
<a id="__codelineno-16-44" name="__codelineno-16-44" href="#__codelineno-16-44"></a>    <span class="c1"># This method will prevent looking at markets that are closed</span>
<a id="__codelineno-16-45" name="__codelineno-16-45" href="#__codelineno-16-45"></a>    <span class="k">def</span> <span class="nf">check_market_book</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">market</span><span class="p">:</span> <span class="n">Market</span><span class="p">,</span> <span class="n">market_book</span><span class="p">:</span> <span class="n">MarketBook</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-16-46" name="__codelineno-16-46" href="#__codelineno-16-46"></a>        <span class="c1"># process_market_book only executed if this returns True</span>
<a id="__codelineno-16-47" name="__codelineno-16-47" href="#__codelineno-16-47"></a>        <span class="k">if</span> <span class="n">market_book</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="s2">&quot;CLOSED&quot;</span><span class="p">:</span>
<a id="__codelineno-16-48" name="__codelineno-16-48" href="#__codelineno-16-48"></a>            <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-16-49" name="__codelineno-16-49" href="#__codelineno-16-49"></a>
<a id="__codelineno-16-50" name="__codelineno-16-50" href="#__codelineno-16-50"></a>    <span class="c1"># If check_market_book returns true i.e. the market is open and not closed then we will run process_market_book once initially</span>
<a id="__codelineno-16-51" name="__codelineno-16-51" href="#__codelineno-16-51"></a>    <span class="c1"># After the first inital time process_market_book has been run, every single time the market ticks, process_market_book will run again</span>
<a id="__codelineno-16-52" name="__codelineno-16-52" href="#__codelineno-16-52"></a>    <span class="k">def</span> <span class="nf">process_market_book</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">market</span><span class="p">:</span> <span class="n">Market</span><span class="p">,</span> <span class="n">market_book</span><span class="p">:</span> <span class="n">MarketBook</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-16-53" name="__codelineno-16-53" href="#__codelineno-16-53"></a>
<a id="__codelineno-16-54" name="__codelineno-16-54" href="#__codelineno-16-54"></a>        <span class="c1"># Find last traded price as a dataframe</span>
<a id="__codelineno-16-55" name="__codelineno-16-55" href="#__codelineno-16-55"></a>        <span class="n">snapshot_last_price_traded</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-16-56" name="__codelineno-16-56" href="#__codelineno-16-56"></a>        <span class="n">snapshot_runner_context</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-16-57" name="__codelineno-16-57" href="#__codelineno-16-57"></a>        <span class="k">for</span> <span class="n">runner</span> <span class="ow">in</span> <span class="n">market_book</span><span class="o">.</span><span class="n">runners</span><span class="p">:</span>
<a id="__codelineno-16-58" name="__codelineno-16-58" href="#__codelineno-16-58"></a>                <span class="n">snapshot_last_price_traded</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">runner</span><span class="o">.</span><span class="n">selection_id</span><span class="p">,</span><span class="n">runner</span><span class="o">.</span><span class="n">last_price_traded</span><span class="p">])</span>
<a id="__codelineno-16-59" name="__codelineno-16-59" href="#__codelineno-16-59"></a>                <span class="c1"># Get runner context for each runner</span>
<a id="__codelineno-16-60" name="__codelineno-16-60" href="#__codelineno-16-60"></a>                <span class="n">runner_context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_runner_context</span><span class="p">(</span>
<a id="__codelineno-16-61" name="__codelineno-16-61" href="#__codelineno-16-61"></a>                    <span class="n">market</span><span class="o">.</span><span class="n">market_id</span><span class="p">,</span> <span class="n">runner</span><span class="o">.</span><span class="n">selection_id</span><span class="p">,</span> <span class="n">runner</span><span class="o">.</span><span class="n">handicap</span>
<a id="__codelineno-16-62" name="__codelineno-16-62" href="#__codelineno-16-62"></a>                <span class="p">)</span>
<a id="__codelineno-16-63" name="__codelineno-16-63" href="#__codelineno-16-63"></a>                <span class="n">snapshot_runner_context</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">runner_context</span><span class="o">.</span><span class="n">selection_id</span><span class="p">,</span> <span class="n">runner_context</span><span class="o">.</span><span class="n">executable_orders</span><span class="p">,</span> <span class="n">runner_context</span><span class="o">.</span><span class="n">live_trade_count</span><span class="p">,</span> <span class="n">runner_context</span><span class="o">.</span><span class="n">trade_count</span><span class="p">])</span>
<a id="__codelineno-16-64" name="__codelineno-16-64" href="#__codelineno-16-64"></a>
<a id="__codelineno-16-65" name="__codelineno-16-65" href="#__codelineno-16-65"></a>        <span class="n">snapshot_last_price_traded</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">snapshot_last_price_traded</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;selection_id&#39;</span><span class="p">,</span><span class="s1">&#39;last_traded_price&#39;</span><span class="p">])</span>
<a id="__codelineno-16-66" name="__codelineno-16-66" href="#__codelineno-16-66"></a>        <span class="n">snapshot_last_price_traded</span> <span class="o">=</span> <span class="n">snapshot_last_price_traded</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;last_traded_price&#39;</span><span class="p">])</span>
<a id="__codelineno-16-67" name="__codelineno-16-67" href="#__codelineno-16-67"></a>        <span class="n">fav_selection_id</span> <span class="o">=</span> <span class="n">snapshot_last_price_traded</span><span class="p">[</span><span class="s1">&#39;selection_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-16-68" name="__codelineno-16-68" href="#__codelineno-16-68"></a>
<a id="__codelineno-16-69" name="__codelineno-16-69" href="#__codelineno-16-69"></a>        <span class="n">snapshot_runner_context</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">snapshot_runner_context</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;selection_id&#39;</span><span class="p">,</span><span class="s1">&#39;executable_orders&#39;</span><span class="p">,</span><span class="s1">&#39;live_trade_count&#39;</span><span class="p">,</span><span class="s1">&#39;trade_count&#39;</span><span class="p">])</span>
<a id="__codelineno-16-70" name="__codelineno-16-70" href="#__codelineno-16-70"></a>
<a id="__codelineno-16-71" name="__codelineno-16-71" href="#__codelineno-16-71"></a>        <span class="k">for</span> <span class="n">runner</span> <span class="ow">in</span> <span class="n">market_book</span><span class="o">.</span><span class="n">runners</span><span class="p">:</span>
<a id="__codelineno-16-72" name="__codelineno-16-72" href="#__codelineno-16-72"></a>            <span class="k">if</span> <span class="n">runner</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;ACTIVE&quot;</span> <span class="ow">and</span> <span class="n">market</span><span class="o">.</span><span class="n">seconds_to_start</span> <span class="o">&lt;</span> <span class="mi">60</span> <span class="ow">and</span> <span class="n">market_book</span><span class="o">.</span><span class="n">inplay</span> <span class="o">==</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">runner</span><span class="o">.</span><span class="n">selection_id</span> <span class="o">==</span> <span class="n">fav_selection_id</span> <span class="ow">and</span> <span class="n">snapshot_runner_context</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-16-73" name="__codelineno-16-73" href="#__codelineno-16-73"></a>                <span class="n">trade</span> <span class="o">=</span> <span class="n">Trade</span><span class="p">(</span>
<a id="__codelineno-16-74" name="__codelineno-16-74" href="#__codelineno-16-74"></a>                    <span class="n">market_id</span><span class="o">=</span><span class="n">market_book</span><span class="o">.</span><span class="n">market_id</span><span class="p">,</span>
<a id="__codelineno-16-75" name="__codelineno-16-75" href="#__codelineno-16-75"></a>                    <span class="n">selection_id</span><span class="o">=</span><span class="n">runner</span><span class="o">.</span><span class="n">selection_id</span><span class="p">,</span>
<a id="__codelineno-16-76" name="__codelineno-16-76" href="#__codelineno-16-76"></a>                    <span class="n">handicap</span><span class="o">=</span><span class="n">runner</span><span class="o">.</span><span class="n">handicap</span><span class="p">,</span>
<a id="__codelineno-16-77" name="__codelineno-16-77" href="#__codelineno-16-77"></a>                    <span class="n">strategy</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-16-78" name="__codelineno-16-78" href="#__codelineno-16-78"></a>                <span class="p">)</span>
<a id="__codelineno-16-79" name="__codelineno-16-79" href="#__codelineno-16-79"></a>                <span class="n">order</span> <span class="o">=</span> <span class="n">trade</span><span class="o">.</span><span class="n">create_order</span><span class="p">(</span>
<a id="__codelineno-16-80" name="__codelineno-16-80" href="#__codelineno-16-80"></a>                    <span class="n">side</span><span class="o">=</span><span class="s2">&quot;BACK&quot;</span><span class="p">,</span> <span class="n">order_type</span><span class="o">=</span><span class="n">LimitOrder</span><span class="p">(</span><span class="n">price</span><span class="o">=</span><span class="n">runner</span><span class="o">.</span><span class="n">last_price_traded</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<a id="__codelineno-16-81" name="__codelineno-16-81" href="#__codelineno-16-81"></a>                <span class="p">)</span>
<a id="__codelineno-16-82" name="__codelineno-16-82" href="#__codelineno-16-82"></a>                <span class="n">market</span><span class="o">.</span><span class="n">place_order</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
<a id="__codelineno-16-83" name="__codelineno-16-83" href="#__codelineno-16-83"></a>
<a id="__codelineno-16-84" name="__codelineno-16-84" href="#__codelineno-16-84"></a>
<a id="__codelineno-16-85" name="__codelineno-16-85" href="#__codelineno-16-85"></a><span class="c1"># Fields we want to log in our simulations</span>
<a id="__codelineno-16-86" name="__codelineno-16-86" href="#__codelineno-16-86"></a><span class="n">FIELDNAMES</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-16-87" name="__codelineno-16-87" href="#__codelineno-16-87"></a>    <span class="s2">&quot;bet_id&quot;</span><span class="p">,</span>
<a id="__codelineno-16-88" name="__codelineno-16-88" href="#__codelineno-16-88"></a>    <span class="s2">&quot;strategy_name&quot;</span><span class="p">,</span>
<a id="__codelineno-16-89" name="__codelineno-16-89" href="#__codelineno-16-89"></a>    <span class="s2">&quot;market_id&quot;</span><span class="p">,</span>
<a id="__codelineno-16-90" name="__codelineno-16-90" href="#__codelineno-16-90"></a>    <span class="s2">&quot;selection_id&quot;</span><span class="p">,</span>
<a id="__codelineno-16-91" name="__codelineno-16-91" href="#__codelineno-16-91"></a>    <span class="s2">&quot;trade_id&quot;</span><span class="p">,</span>
<a id="__codelineno-16-92" name="__codelineno-16-92" href="#__codelineno-16-92"></a>    <span class="s2">&quot;date_time_placed&quot;</span><span class="p">,</span>
<a id="__codelineno-16-93" name="__codelineno-16-93" href="#__codelineno-16-93"></a>    <span class="s2">&quot;price&quot;</span><span class="p">,</span>
<a id="__codelineno-16-94" name="__codelineno-16-94" href="#__codelineno-16-94"></a>    <span class="s2">&quot;price_matched&quot;</span><span class="p">,</span>
<a id="__codelineno-16-95" name="__codelineno-16-95" href="#__codelineno-16-95"></a>    <span class="s2">&quot;size&quot;</span><span class="p">,</span>
<a id="__codelineno-16-96" name="__codelineno-16-96" href="#__codelineno-16-96"></a>    <span class="s2">&quot;size_matched&quot;</span><span class="p">,</span>
<a id="__codelineno-16-97" name="__codelineno-16-97" href="#__codelineno-16-97"></a>    <span class="s2">&quot;profit&quot;</span><span class="p">,</span>
<a id="__codelineno-16-98" name="__codelineno-16-98" href="#__codelineno-16-98"></a>    <span class="s2">&quot;side&quot;</span><span class="p">,</span>
<a id="__codelineno-16-99" name="__codelineno-16-99" href="#__codelineno-16-99"></a>    <span class="s2">&quot;elapsed_seconds_executable&quot;</span><span class="p">,</span>
<a id="__codelineno-16-100" name="__codelineno-16-100" href="#__codelineno-16-100"></a>    <span class="s2">&quot;order_status&quot;</span><span class="p">,</span>
<a id="__codelineno-16-101" name="__codelineno-16-101" href="#__codelineno-16-101"></a>    <span class="s2">&quot;market_note&quot;</span><span class="p">,</span>
<a id="__codelineno-16-102" name="__codelineno-16-102" href="#__codelineno-16-102"></a>    <span class="s2">&quot;trade_notes&quot;</span><span class="p">,</span>
<a id="__codelineno-16-103" name="__codelineno-16-103" href="#__codelineno-16-103"></a>    <span class="s2">&quot;order_notes&quot;</span><span class="p">,</span>
<a id="__codelineno-16-104" name="__codelineno-16-104" href="#__codelineno-16-104"></a><span class="p">]</span>
<a id="__codelineno-16-105" name="__codelineno-16-105" href="#__codelineno-16-105"></a>
<a id="__codelineno-16-106" name="__codelineno-16-106" href="#__codelineno-16-106"></a><span class="c1"># Log results from simulation into csv file named sim_hta_2.csv</span>
<a id="__codelineno-16-107" name="__codelineno-16-107" href="#__codelineno-16-107"></a><span class="c1"># If the csv file doesn&#39;t exist then it is created, otherwise we append results to the csv file</span>
<a id="__codelineno-16-108" name="__codelineno-16-108" href="#__codelineno-16-108"></a><span class="k">class</span> <span class="nc">BacktestLoggingControl</span><span class="p">(</span><span class="n">LoggingControl</span><span class="p">):</span>
<a id="__codelineno-16-109" name="__codelineno-16-109" href="#__codelineno-16-109"></a>    <span class="n">NAME</span> <span class="o">=</span> <span class="s2">&quot;BACKTEST_LOGGING_CONTROL&quot;</span>
<a id="__codelineno-16-110" name="__codelineno-16-110" href="#__codelineno-16-110"></a>
<a id="__codelineno-16-111" name="__codelineno-16-111" href="#__codelineno-16-111"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-16-112" name="__codelineno-16-112" href="#__codelineno-16-112"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">BacktestLoggingControl</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-16-113" name="__codelineno-16-113" href="#__codelineno-16-113"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_setup</span><span class="p">()</span>
<a id="__codelineno-16-114" name="__codelineno-16-114" href="#__codelineno-16-114"></a>
<a id="__codelineno-16-115" name="__codelineno-16-115" href="#__codelineno-16-115"></a>    <span class="k">def</span> <span class="nf">_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-16-116" name="__codelineno-16-116" href="#__codelineno-16-116"></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;sim_hta_2.csv&quot;</span><span class="p">):</span>
<a id="__codelineno-16-117" name="__codelineno-16-117" href="#__codelineno-16-117"></a>            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Results file exists&quot;</span><span class="p">)</span>
<a id="__codelineno-16-118" name="__codelineno-16-118" href="#__codelineno-16-118"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-16-119" name="__codelineno-16-119" href="#__codelineno-16-119"></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;sim_hta_2.csv&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">m</span><span class="p">:</span>
<a id="__codelineno-16-120" name="__codelineno-16-120" href="#__codelineno-16-120"></a>                <span class="n">csv_writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictWriter</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">fieldnames</span><span class="o">=</span><span class="n">FIELDNAMES</span><span class="p">)</span>
<a id="__codelineno-16-121" name="__codelineno-16-121" href="#__codelineno-16-121"></a>                <span class="n">csv_writer</span><span class="o">.</span><span class="n">writeheader</span><span class="p">()</span>
<a id="__codelineno-16-122" name="__codelineno-16-122" href="#__codelineno-16-122"></a>
<a id="__codelineno-16-123" name="__codelineno-16-123" href="#__codelineno-16-123"></a>    <span class="k">def</span> <span class="nf">_process_cleared_orders_meta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
<a id="__codelineno-16-124" name="__codelineno-16-124" href="#__codelineno-16-124"></a>        <span class="n">orders</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">event</span>
<a id="__codelineno-16-125" name="__codelineno-16-125" href="#__codelineno-16-125"></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;sim_hta_2.csv&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">m</span><span class="p">:</span>
<a id="__codelineno-16-126" name="__codelineno-16-126" href="#__codelineno-16-126"></a>            <span class="k">for</span> <span class="n">order</span> <span class="ow">in</span> <span class="n">orders</span><span class="p">:</span>
<a id="__codelineno-16-127" name="__codelineno-16-127" href="#__codelineno-16-127"></a>                <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">order_type</span><span class="o">.</span><span class="n">ORDER_TYPE</span> <span class="o">==</span> <span class="n">OrderTypes</span><span class="o">.</span><span class="n">LIMIT</span><span class="p">:</span>
<a id="__codelineno-16-128" name="__codelineno-16-128" href="#__codelineno-16-128"></a>                    <span class="n">size</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">order_type</span><span class="o">.</span><span class="n">size</span>
<a id="__codelineno-16-129" name="__codelineno-16-129" href="#__codelineno-16-129"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-16-130" name="__codelineno-16-130" href="#__codelineno-16-130"></a>                    <span class="n">size</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">order_type</span><span class="o">.</span><span class="n">liability</span>
<a id="__codelineno-16-131" name="__codelineno-16-131" href="#__codelineno-16-131"></a>                <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">order_type</span><span class="o">.</span><span class="n">ORDER_TYPE</span> <span class="o">==</span> <span class="n">OrderTypes</span><span class="o">.</span><span class="n">MARKET_ON_CLOSE</span><span class="p">:</span>
<a id="__codelineno-16-132" name="__codelineno-16-132" href="#__codelineno-16-132"></a>                    <span class="n">price</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-16-133" name="__codelineno-16-133" href="#__codelineno-16-133"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-16-134" name="__codelineno-16-134" href="#__codelineno-16-134"></a>                    <span class="n">price</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">order_type</span><span class="o">.</span><span class="n">price</span>
<a id="__codelineno-16-135" name="__codelineno-16-135" href="#__codelineno-16-135"></a>                <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-16-136" name="__codelineno-16-136" href="#__codelineno-16-136"></a>                    <span class="n">order_data</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-16-137" name="__codelineno-16-137" href="#__codelineno-16-137"></a>                        <span class="s2">&quot;bet_id&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">bet_id</span><span class="p">,</span>
<a id="__codelineno-16-138" name="__codelineno-16-138" href="#__codelineno-16-138"></a>                        <span class="s2">&quot;strategy_name&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">trade</span><span class="o">.</span><span class="n">strategy</span><span class="p">,</span>
<a id="__codelineno-16-139" name="__codelineno-16-139" href="#__codelineno-16-139"></a>                        <span class="s2">&quot;market_id&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">market_id</span><span class="p">,</span>
<a id="__codelineno-16-140" name="__codelineno-16-140" href="#__codelineno-16-140"></a>                        <span class="s2">&quot;selection_id&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">selection_id</span><span class="p">,</span>
<a id="__codelineno-16-141" name="__codelineno-16-141" href="#__codelineno-16-141"></a>                        <span class="s2">&quot;trade_id&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">trade</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
<a id="__codelineno-16-142" name="__codelineno-16-142" href="#__codelineno-16-142"></a>                        <span class="s2">&quot;date_time_placed&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">responses</span><span class="o">.</span><span class="n">date_time_placed</span><span class="p">,</span>
<a id="__codelineno-16-143" name="__codelineno-16-143" href="#__codelineno-16-143"></a>                        <span class="s2">&quot;price&quot;</span><span class="p">:</span> <span class="n">price</span><span class="p">,</span>
<a id="__codelineno-16-144" name="__codelineno-16-144" href="#__codelineno-16-144"></a>                        <span class="s2">&quot;price_matched&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">average_price_matched</span><span class="p">,</span>
<a id="__codelineno-16-145" name="__codelineno-16-145" href="#__codelineno-16-145"></a>                        <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="n">size</span><span class="p">,</span>
<a id="__codelineno-16-146" name="__codelineno-16-146" href="#__codelineno-16-146"></a>                        <span class="s2">&quot;size_matched&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">size_matched</span><span class="p">,</span>
<a id="__codelineno-16-147" name="__codelineno-16-147" href="#__codelineno-16-147"></a>                        <span class="s2">&quot;profit&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">simulated</span><span class="o">.</span><span class="n">profit</span><span class="p">,</span>
<a id="__codelineno-16-148" name="__codelineno-16-148" href="#__codelineno-16-148"></a>                        <span class="s2">&quot;side&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">side</span><span class="p">,</span>
<a id="__codelineno-16-149" name="__codelineno-16-149" href="#__codelineno-16-149"></a>                        <span class="s2">&quot;elapsed_seconds_executable&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">elapsed_seconds_executable</span><span class="p">,</span>
<a id="__codelineno-16-150" name="__codelineno-16-150" href="#__codelineno-16-150"></a>                        <span class="s2">&quot;order_status&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
<a id="__codelineno-16-151" name="__codelineno-16-151" href="#__codelineno-16-151"></a>                        <span class="s2">&quot;market_note&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">trade</span><span class="o">.</span><span class="n">market_notes</span><span class="p">,</span>
<a id="__codelineno-16-152" name="__codelineno-16-152" href="#__codelineno-16-152"></a>                        <span class="s2">&quot;trade_notes&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">trade</span><span class="o">.</span><span class="n">notes_str</span><span class="p">,</span>
<a id="__codelineno-16-153" name="__codelineno-16-153" href="#__codelineno-16-153"></a>                        <span class="s2">&quot;order_notes&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">notes_str</span><span class="p">,</span>
<a id="__codelineno-16-154" name="__codelineno-16-154" href="#__codelineno-16-154"></a>                    <span class="p">}</span>
<a id="__codelineno-16-155" name="__codelineno-16-155" href="#__codelineno-16-155"></a>                    <span class="n">csv_writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictWriter</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">fieldnames</span><span class="o">=</span><span class="n">FIELDNAMES</span><span class="p">)</span>
<a id="__codelineno-16-156" name="__codelineno-16-156" href="#__codelineno-16-156"></a>                    <span class="n">csv_writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">order_data</span><span class="p">)</span>
<a id="__codelineno-16-157" name="__codelineno-16-157" href="#__codelineno-16-157"></a>                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-16-158" name="__codelineno-16-158" href="#__codelineno-16-158"></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-16-159" name="__codelineno-16-159" href="#__codelineno-16-159"></a>                        <span class="s2">&quot;_process_cleared_orders_meta: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">,</span>
<a id="__codelineno-16-160" name="__codelineno-16-160" href="#__codelineno-16-160"></a>                        <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;order&quot;</span><span class="p">:</span> <span class="n">order</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">e</span><span class="p">},</span>
<a id="__codelineno-16-161" name="__codelineno-16-161" href="#__codelineno-16-161"></a>                    <span class="p">)</span>
<a id="__codelineno-16-162" name="__codelineno-16-162" href="#__codelineno-16-162"></a>
<a id="__codelineno-16-163" name="__codelineno-16-163" href="#__codelineno-16-163"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Orders updated&quot;</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;order_count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">orders</span><span class="p">)})</span>
<a id="__codelineno-16-164" name="__codelineno-16-164" href="#__codelineno-16-164"></a>
<a id="__codelineno-16-165" name="__codelineno-16-165" href="#__codelineno-16-165"></a>    <span class="k">def</span> <span class="nf">_process_cleared_markets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
<a id="__codelineno-16-166" name="__codelineno-16-166" href="#__codelineno-16-166"></a>        <span class="n">cleared_markets</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">event</span>
<a id="__codelineno-16-167" name="__codelineno-16-167" href="#__codelineno-16-167"></a>        <span class="k">for</span> <span class="n">cleared_market</span> <span class="ow">in</span> <span class="n">cleared_markets</span><span class="o">.</span><span class="n">orders</span><span class="p">:</span>
<a id="__codelineno-16-168" name="__codelineno-16-168" href="#__codelineno-16-168"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-16-169" name="__codelineno-16-169" href="#__codelineno-16-169"></a>                <span class="s2">&quot;Cleared market&quot;</span><span class="p">,</span>
<a id="__codelineno-16-170" name="__codelineno-16-170" href="#__codelineno-16-170"></a>                <span class="n">extra</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-16-171" name="__codelineno-16-171" href="#__codelineno-16-171"></a>                    <span class="s2">&quot;market_id&quot;</span><span class="p">:</span> <span class="n">cleared_market</span><span class="o">.</span><span class="n">market_id</span><span class="p">,</span>
<a id="__codelineno-16-172" name="__codelineno-16-172" href="#__codelineno-16-172"></a>                    <span class="s2">&quot;bet_count&quot;</span><span class="p">:</span> <span class="n">cleared_market</span><span class="o">.</span><span class="n">bet_count</span><span class="p">,</span>
<a id="__codelineno-16-173" name="__codelineno-16-173" href="#__codelineno-16-173"></a>                    <span class="s2">&quot;profit&quot;</span><span class="p">:</span> <span class="n">cleared_market</span><span class="o">.</span><span class="n">profit</span><span class="p">,</span>
<a id="__codelineno-16-174" name="__codelineno-16-174" href="#__codelineno-16-174"></a>                    <span class="s2">&quot;commission&quot;</span><span class="p">:</span> <span class="n">cleared_market</span><span class="o">.</span><span class="n">commission</span><span class="p">,</span>
<a id="__codelineno-16-175" name="__codelineno-16-175" href="#__codelineno-16-175"></a>                <span class="p">},</span>
<a id="__codelineno-16-176" name="__codelineno-16-176" href="#__codelineno-16-176"></a>            <span class="p">)</span>
<a id="__codelineno-16-177" name="__codelineno-16-177" href="#__codelineno-16-177"></a>
<a id="__codelineno-16-178" name="__codelineno-16-178" href="#__codelineno-16-178"></a><span class="c1"># Searches for all betfair data files within the folder sample_monthly_data_output</span>
<a id="__codelineno-16-179" name="__codelineno-16-179" href="#__codelineno-16-179"></a><span class="n">data_folder</span> <span class="o">=</span> <span class="s1">&#39;sample_monthly_data_output&#39;</span>
<a id="__codelineno-16-180" name="__codelineno-16-180" href="#__codelineno-16-180"></a><span class="n">data_files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">data_folder</span><span class="p">,)</span>
<a id="__codelineno-16-181" name="__codelineno-16-181" href="#__codelineno-16-181"></a><span class="n">data_files</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">data_folder</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">data_files</span><span class="p">]</span>
<a id="__codelineno-16-182" name="__codelineno-16-182" href="#__codelineno-16-182"></a>
<a id="__codelineno-16-183" name="__codelineno-16-183" href="#__codelineno-16-183"></a><span class="k">def</span> <span class="nf">run_process</span><span class="p">(</span><span class="n">markets</span><span class="p">):</span>
<a id="__codelineno-16-184" name="__codelineno-16-184" href="#__codelineno-16-184"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Replays a Betfair historic data. Places bets according to the user defined strategy and tries to accurately simulate matching by replaying the historic data.</span>
<a id="__codelineno-16-185" name="__codelineno-16-185" href="#__codelineno-16-185"></a>
<a id="__codelineno-16-186" name="__codelineno-16-186" href="#__codelineno-16-186"></a><span class="sd">    Args:</span>
<a id="__codelineno-16-187" name="__codelineno-16-187" href="#__codelineno-16-187"></a><span class="sd">        markets (list: [file paths]): a list of file paths to where the historic data is stored locally. e.g. user/zhoui/downloads/test.csv</span>
<a id="__codelineno-16-188" name="__codelineno-16-188" href="#__codelineno-16-188"></a><span class="sd">    &quot;&quot;&quot;</span>    
<a id="__codelineno-16-189" name="__codelineno-16-189" href="#__codelineno-16-189"></a>    <span class="c1"># Set Flumine to simulation mode</span>
<a id="__codelineno-16-190" name="__codelineno-16-190" href="#__codelineno-16-190"></a>    <span class="n">client</span> <span class="o">=</span> <span class="n">clients</span><span class="o">.</span><span class="n">SimulatedClient</span><span class="p">()</span>
<a id="__codelineno-16-191" name="__codelineno-16-191" href="#__codelineno-16-191"></a>    <span class="n">framework</span> <span class="o">=</span> <span class="n">FlumineSimulation</span><span class="p">(</span><span class="n">client</span><span class="o">=</span><span class="n">client</span><span class="p">)</span>    
<a id="__codelineno-16-192" name="__codelineno-16-192" href="#__codelineno-16-192"></a>
<a id="__codelineno-16-193" name="__codelineno-16-193" href="#__codelineno-16-193"></a>    <span class="c1"># Set parameters for our strategy</span>
<a id="__codelineno-16-194" name="__codelineno-16-194" href="#__codelineno-16-194"></a>    <span class="n">strategy</span> <span class="o">=</span> <span class="n">BackFavStrategy</span><span class="p">(</span>
<a id="__codelineno-16-195" name="__codelineno-16-195" href="#__codelineno-16-195"></a>        <span class="c1"># market_filter selects what portion of the historic data we simulate our strategy on</span>
<a id="__codelineno-16-196" name="__codelineno-16-196" href="#__codelineno-16-196"></a>        <span class="c1"># markets selects the list of betfair historic data files</span>
<a id="__codelineno-16-197" name="__codelineno-16-197" href="#__codelineno-16-197"></a>        <span class="c1"># market_types specifies the type of markets</span>
<a id="__codelineno-16-198" name="__codelineno-16-198" href="#__codelineno-16-198"></a>        <span class="c1"># listener_kwargs specifies the time period we simulate for each market</span>
<a id="__codelineno-16-199" name="__codelineno-16-199" href="#__codelineno-16-199"></a>        <span class="n">market_filter</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-16-200" name="__codelineno-16-200" href="#__codelineno-16-200"></a>            <span class="s2">&quot;markets&quot;</span><span class="p">:</span> <span class="n">markets</span><span class="p">,</span>  
<a id="__codelineno-16-201" name="__codelineno-16-201" href="#__codelineno-16-201"></a>            <span class="s1">&#39;market_types&#39;</span><span class="p">:[</span><span class="s1">&#39;WIN&#39;</span><span class="p">],</span>
<a id="__codelineno-16-202" name="__codelineno-16-202" href="#__codelineno-16-202"></a>            <span class="s2">&quot;listener_kwargs&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;inplay&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;seconds_to_start&quot;</span><span class="p">:</span> <span class="mi">80</span><span class="p">},</span>  
<a id="__codelineno-16-203" name="__codelineno-16-203" href="#__codelineno-16-203"></a>            <span class="p">},</span>
<a id="__codelineno-16-204" name="__codelineno-16-204" href="#__codelineno-16-204"></a>        <span class="n">max_order_exposure</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
<a id="__codelineno-16-205" name="__codelineno-16-205" href="#__codelineno-16-205"></a>        <span class="n">max_selection_exposure</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
<a id="__codelineno-16-206" name="__codelineno-16-206" href="#__codelineno-16-206"></a>        <span class="n">max_live_trade_count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-16-207" name="__codelineno-16-207" href="#__codelineno-16-207"></a>        <span class="n">max_trade_count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-16-208" name="__codelineno-16-208" href="#__codelineno-16-208"></a>    <span class="p">)</span>
<a id="__codelineno-16-209" name="__codelineno-16-209" href="#__codelineno-16-209"></a>    <span class="c1"># Run our strategy on the simulated market</span>
<a id="__codelineno-16-210" name="__codelineno-16-210" href="#__codelineno-16-210"></a>    <span class="n">framework</span><span class="o">.</span><span class="n">add_strategy</span><span class="p">(</span><span class="n">strategy</span><span class="p">)</span>
<a id="__codelineno-16-211" name="__codelineno-16-211" href="#__codelineno-16-211"></a>    <span class="n">framework</span><span class="o">.</span><span class="n">add_logging_control</span><span class="p">(</span>
<a id="__codelineno-16-212" name="__codelineno-16-212" href="#__codelineno-16-212"></a>        <span class="n">BacktestLoggingControl</span><span class="p">()</span>
<a id="__codelineno-16-213" name="__codelineno-16-213" href="#__codelineno-16-213"></a>    <span class="p">)</span>
<a id="__codelineno-16-214" name="__codelineno-16-214" href="#__codelineno-16-214"></a>    <span class="n">framework</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
<a id="__codelineno-16-215" name="__codelineno-16-215" href="#__codelineno-16-215"></a>
<a id="__codelineno-16-216" name="__codelineno-16-216" href="#__codelineno-16-216"></a><span class="c1"># Multi processing</span>
<a id="__codelineno-16-217" name="__codelineno-16-217" href="#__codelineno-16-217"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
<a id="__codelineno-16-218" name="__codelineno-16-218" href="#__codelineno-16-218"></a>    <span class="n">all_markets</span> <span class="o">=</span> <span class="n">data_files</span>  <span class="c1"># All the markets we want to simulate</span>
<a id="__codelineno-16-219" name="__codelineno-16-219" href="#__codelineno-16-219"></a>    <span class="n">processes</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span>  <span class="c1"># Returns the number of CPUs in the system.</span>
<a id="__codelineno-16-220" name="__codelineno-16-220" href="#__codelineno-16-220"></a>    <span class="n">markets_per_process</span> <span class="o">=</span> <span class="mi">8</span>   <span class="c1"># 8 is optimal as it prevents data leakage.</span>
<a id="__codelineno-16-221" name="__codelineno-16-221" href="#__codelineno-16-221"></a>
<a id="__codelineno-16-222" name="__codelineno-16-222" href="#__codelineno-16-222"></a>    <span class="n">_process_jobs</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-16-223" name="__codelineno-16-223" href="#__codelineno-16-223"></a>    <span class="k">with</span> <span class="n">futures</span><span class="o">.</span><span class="n">ProcessPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="n">processes</span><span class="p">)</span> <span class="k">as</span> <span class="n">p</span><span class="p">:</span>
<a id="__codelineno-16-224" name="__codelineno-16-224" href="#__codelineno-16-224"></a>        <span class="c1"># Number of chunks to split the process into depends on the number of markets we want to process and number of CPUs we have.</span>
<a id="__codelineno-16-225" name="__codelineno-16-225" href="#__codelineno-16-225"></a>        <span class="n">chunk</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
<a id="__codelineno-16-226" name="__codelineno-16-226" href="#__codelineno-16-226"></a>            <span class="n">markets_per_process</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_markets</span><span class="p">)</span> <span class="o">/</span> <span class="n">processes</span><span class="p">)</span>
<a id="__codelineno-16-227" name="__codelineno-16-227" href="#__codelineno-16-227"></a>        <span class="p">)</span>
<a id="__codelineno-16-228" name="__codelineno-16-228" href="#__codelineno-16-228"></a>        <span class="c1"># Split all the markets we want to process into chunks to run on separate CPUs and then run them on the separate CPUs</span>
<a id="__codelineno-16-229" name="__codelineno-16-229" href="#__codelineno-16-229"></a>        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">chunks</span><span class="p">(</span><span class="n">all_markets</span><span class="p">,</span> <span class="n">chunk</span><span class="p">)):</span>
<a id="__codelineno-16-230" name="__codelineno-16-230" href="#__codelineno-16-230"></a>            <span class="n">_process_jobs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
<a id="__codelineno-16-231" name="__codelineno-16-231" href="#__codelineno-16-231"></a>                <span class="n">p</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span>
<a id="__codelineno-16-232" name="__codelineno-16-232" href="#__codelineno-16-232"></a>                    <span class="n">run_process</span><span class="p">,</span>
<a id="__codelineno-16-233" name="__codelineno-16-233" href="#__codelineno-16-233"></a>                    <span class="n">markets</span><span class="o">=</span><span class="n">m</span><span class="p">,</span>
<a id="__codelineno-16-234" name="__codelineno-16-234" href="#__codelineno-16-234"></a>                <span class="p">)</span>
<a id="__codelineno-16-235" name="__codelineno-16-235" href="#__codelineno-16-235"></a>            <span class="p">)</span>
<a id="__codelineno-16-236" name="__codelineno-16-236" href="#__codelineno-16-236"></a>        <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">futures</span><span class="o">.</span><span class="n">as_completed</span><span class="p">(</span><span class="n">_process_jobs</span><span class="p">):</span>
<a id="__codelineno-16-237" name="__codelineno-16-237" href="#__codelineno-16-237"></a>            <span class="n">job</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>  <span class="c1"># wait for result</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p><a href="https://github.com/betfair-down-under/autoHubTutorials/tree/master">Download from Github</a></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="c1"># Import libraries</span>
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a><span class="kn">import</span> <span class="nn">glob</span>
<a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a><span class="kn">import</span> <span class="nn">os</span>
<a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a><span class="kn">import</span> <span class="nn">time</span>
<a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a><span class="kn">import</span> <span class="nn">logging</span>
<a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a><span class="kn">import</span> <span class="nn">csv</span>
<a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a><span class="kn">import</span> <span class="nn">math</span>
<a id="__codelineno-17-8" name="__codelineno-17-8" href="#__codelineno-17-8"></a><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<a id="__codelineno-17-9" name="__codelineno-17-9" href="#__codelineno-17-9"></a><span class="kn">from</span> <span class="nn">pythonjsonlogger</span> <span class="kn">import</span> <span class="n">jsonlogger</span>
<a id="__codelineno-17-10" name="__codelineno-17-10" href="#__codelineno-17-10"></a><span class="kn">from</span> <span class="nn">concurrent</span> <span class="kn">import</span> <span class="n">futures</span>
<a id="__codelineno-17-11" name="__codelineno-17-11" href="#__codelineno-17-11"></a><span class="kn">from</span> <span class="nn">flumine</span> <span class="kn">import</span> <span class="n">FlumineSimulation</span><span class="p">,</span> <span class="n">BaseStrategy</span><span class="p">,</span> <span class="n">utils</span><span class="p">,</span> <span class="n">clients</span>
<a id="__codelineno-17-12" name="__codelineno-17-12" href="#__codelineno-17-12"></a><span class="kn">from</span> <span class="nn">flumine.order.trade</span> <span class="kn">import</span> <span class="n">Trade</span>
<a id="__codelineno-17-13" name="__codelineno-17-13" href="#__codelineno-17-13"></a><span class="kn">from</span> <span class="nn">flumine.order.order</span> <span class="kn">import</span> <span class="n">LimitOrder</span><span class="p">,</span> <span class="n">OrderStatus</span>
<a id="__codelineno-17-14" name="__codelineno-17-14" href="#__codelineno-17-14"></a><span class="kn">from</span> <span class="nn">flumine.order.ordertype</span> <span class="kn">import</span> <span class="n">OrderTypes</span>
<a id="__codelineno-17-15" name="__codelineno-17-15" href="#__codelineno-17-15"></a><span class="kn">from</span> <span class="nn">flumine.markets.market</span> <span class="kn">import</span> <span class="n">Market</span>
<a id="__codelineno-17-16" name="__codelineno-17-16" href="#__codelineno-17-16"></a><span class="kn">from</span> <span class="nn">flumine.controls.loggingcontrols</span> <span class="kn">import</span> <span class="n">LoggingControl</span>
<a id="__codelineno-17-17" name="__codelineno-17-17" href="#__codelineno-17-17"></a><span class="kn">from</span> <span class="nn">betfairlightweight.filters</span> <span class="kn">import</span> <span class="n">streaming_market_filter</span>
<a id="__codelineno-17-18" name="__codelineno-17-18" href="#__codelineno-17-18"></a><span class="kn">from</span> <span class="nn">betfairlightweight.resources</span> <span class="kn">import</span> <span class="n">MarketBook</span>
<a id="__codelineno-17-19" name="__codelineno-17-19" href="#__codelineno-17-19"></a>
<a id="__codelineno-17-20" name="__codelineno-17-20" href="#__codelineno-17-20"></a><span class="c1"># Logging</span>
<a id="__codelineno-17-21" name="__codelineno-17-21" href="#__codelineno-17-21"></a><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span>
<a id="__codelineno-17-22" name="__codelineno-17-22" href="#__codelineno-17-22"></a><span class="n">custom_format</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%(asctime) %</span><span class="s2">(levelname) %(message)&quot;</span>
<a id="__codelineno-17-23" name="__codelineno-17-23" href="#__codelineno-17-23"></a><span class="n">log_handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()</span>
<a id="__codelineno-17-24" name="__codelineno-17-24" href="#__codelineno-17-24"></a><span class="n">formatter</span> <span class="o">=</span> <span class="n">jsonlogger</span><span class="o">.</span><span class="n">JsonFormatter</span><span class="p">(</span><span class="n">custom_format</span><span class="p">)</span>
<a id="__codelineno-17-25" name="__codelineno-17-25" href="#__codelineno-17-25"></a><span class="n">formatter</span><span class="o">.</span><span class="n">converter</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">gmtime</span>
<a id="__codelineno-17-26" name="__codelineno-17-26" href="#__codelineno-17-26"></a><span class="n">log_handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
<a id="__codelineno-17-27" name="__codelineno-17-27" href="#__codelineno-17-27"></a><span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">log_handler</span><span class="p">)</span>
<a id="__codelineno-17-28" name="__codelineno-17-28" href="#__codelineno-17-28"></a><span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>  <span class="c1"># Set to logging.CRITICAL to speed up simulation</span>
<a id="__codelineno-17-29" name="__codelineno-17-29" href="#__codelineno-17-29"></a>
<a id="__codelineno-17-30" name="__codelineno-17-30" href="#__codelineno-17-30"></a><span class="k">def</span> <span class="nf">download_iggy_ratings</span><span class="p">(</span><span class="n">date</span><span class="p">):</span>
<a id="__codelineno-17-31" name="__codelineno-17-31" href="#__codelineno-17-31"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Downloads the Betfair Iggy model ratings for a given date and formats it into a nice DataFrame.</span>
<a id="__codelineno-17-32" name="__codelineno-17-32" href="#__codelineno-17-32"></a>
<a id="__codelineno-17-33" name="__codelineno-17-33" href="#__codelineno-17-33"></a><span class="sd">    Args:</span>
<a id="__codelineno-17-34" name="__codelineno-17-34" href="#__codelineno-17-34"></a><span class="sd">        date (datetime): the date we want to download the ratings for</span>
<a id="__codelineno-17-35" name="__codelineno-17-35" href="#__codelineno-17-35"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-17-36" name="__codelineno-17-36" href="#__codelineno-17-36"></a>    <span class="n">iggy_url_1</span> <span class="o">=</span> <span class="s1">&#39;https://betfair-data-supplier-prod.herokuapp.com/api/widgets/iggy-joey/datasets?date=&#39;</span>
<a id="__codelineno-17-37" name="__codelineno-17-37" href="#__codelineno-17-37"></a>    <span class="n">iggy_url_2</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-17-38" name="__codelineno-17-38" href="#__codelineno-17-38"></a>    <span class="n">iggy_url_3</span> <span class="o">=</span> <span class="s1">&#39;&amp;presenter=RatingsPresenter&amp;csv=true&#39;</span>
<a id="__codelineno-17-39" name="__codelineno-17-39" href="#__codelineno-17-39"></a>    <span class="n">iggy_url</span> <span class="o">=</span> <span class="n">iggy_url_1</span> <span class="o">+</span> <span class="n">iggy_url_2</span> <span class="o">+</span> <span class="n">iggy_url_3</span>
<a id="__codelineno-17-40" name="__codelineno-17-40" href="#__codelineno-17-40"></a>
<a id="__codelineno-17-41" name="__codelineno-17-41" href="#__codelineno-17-41"></a>    <span class="c1"># Download todays greyhounds ratings</span>
<a id="__codelineno-17-42" name="__codelineno-17-42" href="#__codelineno-17-42"></a>    <span class="n">iggy_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">iggy_url</span><span class="p">)</span>
<a id="__codelineno-17-43" name="__codelineno-17-43" href="#__codelineno-17-43"></a>
<a id="__codelineno-17-44" name="__codelineno-17-44" href="#__codelineno-17-44"></a>    <span class="c1"># Data clearning</span>
<a id="__codelineno-17-45" name="__codelineno-17-45" href="#__codelineno-17-45"></a>    <span class="n">iggy_df</span> <span class="o">=</span> <span class="n">iggy_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;meetings.races.bfExchangeMarketId&quot;</span><span class="p">:</span><span class="s2">&quot;market_id&quot;</span><span class="p">,</span><span class="s2">&quot;meetings.races.runners.bfExchangeSelectionId&quot;</span><span class="p">:</span><span class="s2">&quot;selection_id&quot;</span><span class="p">,</span><span class="s2">&quot;meetings.races.runners.ratedPrice&quot;</span><span class="p">:</span><span class="s2">&quot;rating&quot;</span><span class="p">})</span>
<a id="__codelineno-17-46" name="__codelineno-17-46" href="#__codelineno-17-46"></a>    <span class="n">iggy_df</span> <span class="o">=</span> <span class="n">iggy_df</span><span class="p">[[</span><span class="s1">&#39;market_id&#39;</span><span class="p">,</span><span class="s1">&#39;selection_id&#39;</span><span class="p">,</span><span class="s1">&#39;rating&#39;</span><span class="p">]]</span>
<a id="__codelineno-17-47" name="__codelineno-17-47" href="#__codelineno-17-47"></a>    <span class="n">iggy_df</span><span class="p">[</span><span class="s1">&#39;market_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">iggy_df</span><span class="p">[</span><span class="s1">&#39;market_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
<a id="__codelineno-17-48" name="__codelineno-17-48" href="#__codelineno-17-48"></a>
<a id="__codelineno-17-49" name="__codelineno-17-49" href="#__codelineno-17-49"></a>    <span class="c1"># Set market_id and selection_id as index for easy referencing</span>
<a id="__codelineno-17-50" name="__codelineno-17-50" href="#__codelineno-17-50"></a>    <span class="n">iggy_df</span> <span class="o">=</span> <span class="n">iggy_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;market_id&#39;</span><span class="p">,</span><span class="s1">&#39;selection_id&#39;</span><span class="p">])</span>
<a id="__codelineno-17-51" name="__codelineno-17-51" href="#__codelineno-17-51"></a>    <span class="k">return</span><span class="p">(</span><span class="n">iggy_df</span><span class="p">)</span>
<a id="__codelineno-17-52" name="__codelineno-17-52" href="#__codelineno-17-52"></a>
<a id="__codelineno-17-53" name="__codelineno-17-53" href="#__codelineno-17-53"></a><span class="n">back_test_period</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="s1">&#39;2022/02/27&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;2022/03/05&#39;</span><span class="p">)</span>
<a id="__codelineno-17-54" name="__codelineno-17-54" href="#__codelineno-17-54"></a><span class="n">frames</span> <span class="o">=</span> <span class="p">[</span><span class="n">download_iggy_ratings</span><span class="p">(</span><span class="n">day</span><span class="p">)</span> <span class="k">for</span> <span class="n">day</span> <span class="ow">in</span> <span class="n">back_test_period</span><span class="p">]</span>
<a id="__codelineno-17-55" name="__codelineno-17-55" href="#__codelineno-17-55"></a><span class="n">iggy_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">frames</span><span class="p">)</span>
<a id="__codelineno-17-56" name="__codelineno-17-56" href="#__codelineno-17-56"></a><span class="nb">print</span><span class="p">(</span><span class="n">iggy_df</span><span class="p">)</span>
<a id="__codelineno-17-57" name="__codelineno-17-57" href="#__codelineno-17-57"></a>
<a id="__codelineno-17-58" name="__codelineno-17-58" href="#__codelineno-17-58"></a><span class="c1"># Create strategy, this is the exact same strategy shown in How to Automate III</span>
<a id="__codelineno-17-59" name="__codelineno-17-59" href="#__codelineno-17-59"></a><span class="k">class</span> <span class="nc">FlatIggyModel</span><span class="p">(</span><span class="n">BaseStrategy</span><span class="p">):</span>
<a id="__codelineno-17-60" name="__codelineno-17-60" href="#__codelineno-17-60"></a>    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-17-61" name="__codelineno-17-61" href="#__codelineno-17-61"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;starting strategy &#39;FlatIggyModel&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-17-62" name="__codelineno-17-62" href="#__codelineno-17-62"></a>
<a id="__codelineno-17-63" name="__codelineno-17-63" href="#__codelineno-17-63"></a>    <span class="k">def</span> <span class="nf">check_market_book</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">market</span><span class="p">:</span> <span class="n">Market</span><span class="p">,</span> <span class="n">market_book</span><span class="p">:</span> <span class="n">MarketBook</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-17-64" name="__codelineno-17-64" href="#__codelineno-17-64"></a>        <span class="k">if</span> <span class="n">market_book</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="s2">&quot;CLOSED&quot;</span><span class="p">:</span>
<a id="__codelineno-17-65" name="__codelineno-17-65" href="#__codelineno-17-65"></a>            <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-17-66" name="__codelineno-17-66" href="#__codelineno-17-66"></a>
<a id="__codelineno-17-67" name="__codelineno-17-67" href="#__codelineno-17-67"></a>    <span class="k">def</span> <span class="nf">process_market_book</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">market</span><span class="p">:</span> <span class="n">Market</span><span class="p">,</span> <span class="n">market_book</span><span class="p">:</span> <span class="n">MarketBook</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-17-68" name="__codelineno-17-68" href="#__codelineno-17-68"></a>        <span class="k">if</span> <span class="n">market</span><span class="o">.</span><span class="n">seconds_to_start</span> <span class="o">&lt;</span> <span class="mi">60</span> <span class="ow">and</span> <span class="n">market_book</span><span class="o">.</span><span class="n">inplay</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
<a id="__codelineno-17-69" name="__codelineno-17-69" href="#__codelineno-17-69"></a>            <span class="k">for</span> <span class="n">runner</span> <span class="ow">in</span> <span class="n">market_book</span><span class="o">.</span><span class="n">runners</span><span class="p">:</span>
<a id="__codelineno-17-70" name="__codelineno-17-70" href="#__codelineno-17-70"></a>                <span class="k">if</span> <span class="n">runner</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;ACTIVE&quot;</span> <span class="ow">and</span> <span class="n">runner</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">available_to_back</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;price&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">iggy_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">market_book</span><span class="o">.</span><span class="n">market_id</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">runner</span><span class="o">.</span><span class="n">selection_id</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">():</span>
<a id="__codelineno-17-71" name="__codelineno-17-71" href="#__codelineno-17-71"></a>                    <span class="n">trade</span> <span class="o">=</span> <span class="n">Trade</span><span class="p">(</span>
<a id="__codelineno-17-72" name="__codelineno-17-72" href="#__codelineno-17-72"></a>                    <span class="n">market_id</span><span class="o">=</span><span class="n">market_book</span><span class="o">.</span><span class="n">market_id</span><span class="p">,</span>
<a id="__codelineno-17-73" name="__codelineno-17-73" href="#__codelineno-17-73"></a>                    <span class="n">selection_id</span><span class="o">=</span><span class="n">runner</span><span class="o">.</span><span class="n">selection_id</span><span class="p">,</span>
<a id="__codelineno-17-74" name="__codelineno-17-74" href="#__codelineno-17-74"></a>                    <span class="n">handicap</span><span class="o">=</span><span class="n">runner</span><span class="o">.</span><span class="n">handicap</span><span class="p">,</span>
<a id="__codelineno-17-75" name="__codelineno-17-75" href="#__codelineno-17-75"></a>                    <span class="n">strategy</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-17-76" name="__codelineno-17-76" href="#__codelineno-17-76"></a>                    <span class="p">)</span>
<a id="__codelineno-17-77" name="__codelineno-17-77" href="#__codelineno-17-77"></a>                    <span class="n">order</span> <span class="o">=</span> <span class="n">trade</span><span class="o">.</span><span class="n">create_order</span><span class="p">(</span>
<a id="__codelineno-17-78" name="__codelineno-17-78" href="#__codelineno-17-78"></a>                        <span class="n">side</span><span class="o">=</span><span class="s2">&quot;BACK&quot;</span><span class="p">,</span> <span class="n">order_type</span><span class="o">=</span><span class="n">LimitOrder</span><span class="p">(</span><span class="n">price</span><span class="o">=</span><span class="n">runner</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">available_to_back</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;price&#39;</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="mf">5.00</span><span class="p">)</span>
<a id="__codelineno-17-79" name="__codelineno-17-79" href="#__codelineno-17-79"></a>                    <span class="p">)</span>
<a id="__codelineno-17-80" name="__codelineno-17-80" href="#__codelineno-17-80"></a>                    <span class="n">market</span><span class="o">.</span><span class="n">place_order</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
<a id="__codelineno-17-81" name="__codelineno-17-81" href="#__codelineno-17-81"></a>                <span class="k">if</span> <span class="n">runner</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;ACTIVE&quot;</span> <span class="ow">and</span> <span class="n">runner</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">available_to_lay</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;price&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">iggy_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">market_book</span><span class="o">.</span><span class="n">market_id</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">runner</span><span class="o">.</span><span class="n">selection_id</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">():</span>
<a id="__codelineno-17-82" name="__codelineno-17-82" href="#__codelineno-17-82"></a>                    <span class="n">trade</span> <span class="o">=</span> <span class="n">Trade</span><span class="p">(</span>
<a id="__codelineno-17-83" name="__codelineno-17-83" href="#__codelineno-17-83"></a>                    <span class="n">market_id</span><span class="o">=</span><span class="n">market_book</span><span class="o">.</span><span class="n">market_id</span><span class="p">,</span>
<a id="__codelineno-17-84" name="__codelineno-17-84" href="#__codelineno-17-84"></a>                    <span class="n">selection_id</span><span class="o">=</span><span class="n">runner</span><span class="o">.</span><span class="n">selection_id</span><span class="p">,</span>
<a id="__codelineno-17-85" name="__codelineno-17-85" href="#__codelineno-17-85"></a>                    <span class="n">handicap</span><span class="o">=</span><span class="n">runner</span><span class="o">.</span><span class="n">handicap</span><span class="p">,</span>
<a id="__codelineno-17-86" name="__codelineno-17-86" href="#__codelineno-17-86"></a>                    <span class="n">strategy</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-17-87" name="__codelineno-17-87" href="#__codelineno-17-87"></a>                    <span class="p">)</span>
<a id="__codelineno-17-88" name="__codelineno-17-88" href="#__codelineno-17-88"></a>                    <span class="n">order</span> <span class="o">=</span> <span class="n">trade</span><span class="o">.</span><span class="n">create_order</span><span class="p">(</span>
<a id="__codelineno-17-89" name="__codelineno-17-89" href="#__codelineno-17-89"></a>                        <span class="n">side</span><span class="o">=</span><span class="s2">&quot;LAY&quot;</span><span class="p">,</span> <span class="n">order_type</span><span class="o">=</span><span class="n">LimitOrder</span><span class="p">(</span><span class="n">price</span><span class="o">=</span><span class="n">runner</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">available_to_lay</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;price&#39;</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="mf">5.00</span><span class="p">)</span>
<a id="__codelineno-17-90" name="__codelineno-17-90" href="#__codelineno-17-90"></a>                    <span class="p">)</span>
<a id="__codelineno-17-91" name="__codelineno-17-91" href="#__codelineno-17-91"></a>                    <span class="n">market</span><span class="o">.</span><span class="n">place_order</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
<a id="__codelineno-17-92" name="__codelineno-17-92" href="#__codelineno-17-92"></a>
<a id="__codelineno-17-93" name="__codelineno-17-93" href="#__codelineno-17-93"></a><span class="c1"># Fields we want to log in our simulations</span>
<a id="__codelineno-17-94" name="__codelineno-17-94" href="#__codelineno-17-94"></a><span class="n">FIELDNAMES</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-17-95" name="__codelineno-17-95" href="#__codelineno-17-95"></a>    <span class="s2">&quot;bet_id&quot;</span><span class="p">,</span>
<a id="__codelineno-17-96" name="__codelineno-17-96" href="#__codelineno-17-96"></a>    <span class="s2">&quot;strategy_name&quot;</span><span class="p">,</span>
<a id="__codelineno-17-97" name="__codelineno-17-97" href="#__codelineno-17-97"></a>    <span class="s2">&quot;market_id&quot;</span><span class="p">,</span>
<a id="__codelineno-17-98" name="__codelineno-17-98" href="#__codelineno-17-98"></a>    <span class="s2">&quot;selection_id&quot;</span><span class="p">,</span>
<a id="__codelineno-17-99" name="__codelineno-17-99" href="#__codelineno-17-99"></a>    <span class="s2">&quot;trade_id&quot;</span><span class="p">,</span>
<a id="__codelineno-17-100" name="__codelineno-17-100" href="#__codelineno-17-100"></a>    <span class="s2">&quot;date_time_placed&quot;</span><span class="p">,</span>
<a id="__codelineno-17-101" name="__codelineno-17-101" href="#__codelineno-17-101"></a>    <span class="s2">&quot;price&quot;</span><span class="p">,</span>
<a id="__codelineno-17-102" name="__codelineno-17-102" href="#__codelineno-17-102"></a>    <span class="s2">&quot;price_matched&quot;</span><span class="p">,</span>
<a id="__codelineno-17-103" name="__codelineno-17-103" href="#__codelineno-17-103"></a>    <span class="s2">&quot;size&quot;</span><span class="p">,</span>
<a id="__codelineno-17-104" name="__codelineno-17-104" href="#__codelineno-17-104"></a>    <span class="s2">&quot;size_matched&quot;</span><span class="p">,</span>
<a id="__codelineno-17-105" name="__codelineno-17-105" href="#__codelineno-17-105"></a>    <span class="s2">&quot;profit&quot;</span><span class="p">,</span>
<a id="__codelineno-17-106" name="__codelineno-17-106" href="#__codelineno-17-106"></a>    <span class="s2">&quot;side&quot;</span><span class="p">,</span>
<a id="__codelineno-17-107" name="__codelineno-17-107" href="#__codelineno-17-107"></a>    <span class="s2">&quot;elapsed_seconds_executable&quot;</span><span class="p">,</span>
<a id="__codelineno-17-108" name="__codelineno-17-108" href="#__codelineno-17-108"></a>    <span class="s2">&quot;order_status&quot;</span><span class="p">,</span>
<a id="__codelineno-17-109" name="__codelineno-17-109" href="#__codelineno-17-109"></a>    <span class="s2">&quot;market_note&quot;</span><span class="p">,</span>
<a id="__codelineno-17-110" name="__codelineno-17-110" href="#__codelineno-17-110"></a>    <span class="s2">&quot;trade_notes&quot;</span><span class="p">,</span>
<a id="__codelineno-17-111" name="__codelineno-17-111" href="#__codelineno-17-111"></a>    <span class="s2">&quot;order_notes&quot;</span><span class="p">,</span>
<a id="__codelineno-17-112" name="__codelineno-17-112" href="#__codelineno-17-112"></a><span class="p">]</span>
<a id="__codelineno-17-113" name="__codelineno-17-113" href="#__codelineno-17-113"></a>
<a id="__codelineno-17-114" name="__codelineno-17-114" href="#__codelineno-17-114"></a><span class="c1"># Log results from simulation into csv file named sim_hta_3.csv</span>
<a id="__codelineno-17-115" name="__codelineno-17-115" href="#__codelineno-17-115"></a><span class="c1"># If the csv file doesn&#39;t exist then it is created, otherwise we append results to the csv file</span>
<a id="__codelineno-17-116" name="__codelineno-17-116" href="#__codelineno-17-116"></a><span class="k">class</span> <span class="nc">BacktestLoggingControl</span><span class="p">(</span><span class="n">LoggingControl</span><span class="p">):</span>
<a id="__codelineno-17-117" name="__codelineno-17-117" href="#__codelineno-17-117"></a>    <span class="n">NAME</span> <span class="o">=</span> <span class="s2">&quot;BACKTEST_LOGGING_CONTROL&quot;</span>
<a id="__codelineno-17-118" name="__codelineno-17-118" href="#__codelineno-17-118"></a>
<a id="__codelineno-17-119" name="__codelineno-17-119" href="#__codelineno-17-119"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-17-120" name="__codelineno-17-120" href="#__codelineno-17-120"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">BacktestLoggingControl</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-17-121" name="__codelineno-17-121" href="#__codelineno-17-121"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_setup</span><span class="p">()</span>
<a id="__codelineno-17-122" name="__codelineno-17-122" href="#__codelineno-17-122"></a>
<a id="__codelineno-17-123" name="__codelineno-17-123" href="#__codelineno-17-123"></a>    <span class="k">def</span> <span class="nf">_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-17-124" name="__codelineno-17-124" href="#__codelineno-17-124"></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;sim_hta_3.csv&quot;</span><span class="p">):</span>
<a id="__codelineno-17-125" name="__codelineno-17-125" href="#__codelineno-17-125"></a>            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Results file exists&quot;</span><span class="p">)</span>
<a id="__codelineno-17-126" name="__codelineno-17-126" href="#__codelineno-17-126"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-17-127" name="__codelineno-17-127" href="#__codelineno-17-127"></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;sim_hta_3.csv&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">m</span><span class="p">:</span>
<a id="__codelineno-17-128" name="__codelineno-17-128" href="#__codelineno-17-128"></a>                <span class="n">csv_writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictWriter</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">fieldnames</span><span class="o">=</span><span class="n">FIELDNAMES</span><span class="p">)</span>
<a id="__codelineno-17-129" name="__codelineno-17-129" href="#__codelineno-17-129"></a>                <span class="n">csv_writer</span><span class="o">.</span><span class="n">writeheader</span><span class="p">()</span>
<a id="__codelineno-17-130" name="__codelineno-17-130" href="#__codelineno-17-130"></a>
<a id="__codelineno-17-131" name="__codelineno-17-131" href="#__codelineno-17-131"></a>    <span class="k">def</span> <span class="nf">_process_cleared_orders_meta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
<a id="__codelineno-17-132" name="__codelineno-17-132" href="#__codelineno-17-132"></a>        <span class="n">orders</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">event</span>
<a id="__codelineno-17-133" name="__codelineno-17-133" href="#__codelineno-17-133"></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;sim_hta_3.csv&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">m</span><span class="p">:</span>
<a id="__codelineno-17-134" name="__codelineno-17-134" href="#__codelineno-17-134"></a>            <span class="k">for</span> <span class="n">order</span> <span class="ow">in</span> <span class="n">orders</span><span class="p">:</span>
<a id="__codelineno-17-135" name="__codelineno-17-135" href="#__codelineno-17-135"></a>                <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">order_type</span><span class="o">.</span><span class="n">ORDER_TYPE</span> <span class="o">==</span> <span class="n">OrderTypes</span><span class="o">.</span><span class="n">LIMIT</span><span class="p">:</span>
<a id="__codelineno-17-136" name="__codelineno-17-136" href="#__codelineno-17-136"></a>                    <span class="n">size</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">order_type</span><span class="o">.</span><span class="n">size</span>
<a id="__codelineno-17-137" name="__codelineno-17-137" href="#__codelineno-17-137"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-17-138" name="__codelineno-17-138" href="#__codelineno-17-138"></a>                    <span class="n">size</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">order_type</span><span class="o">.</span><span class="n">liability</span>
<a id="__codelineno-17-139" name="__codelineno-17-139" href="#__codelineno-17-139"></a>                <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">order_type</span><span class="o">.</span><span class="n">ORDER_TYPE</span> <span class="o">==</span> <span class="n">OrderTypes</span><span class="o">.</span><span class="n">MARKET_ON_CLOSE</span><span class="p">:</span>
<a id="__codelineno-17-140" name="__codelineno-17-140" href="#__codelineno-17-140"></a>                    <span class="n">price</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-17-141" name="__codelineno-17-141" href="#__codelineno-17-141"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-17-142" name="__codelineno-17-142" href="#__codelineno-17-142"></a>                    <span class="n">price</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">order_type</span><span class="o">.</span><span class="n">price</span>
<a id="__codelineno-17-143" name="__codelineno-17-143" href="#__codelineno-17-143"></a>                <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-17-144" name="__codelineno-17-144" href="#__codelineno-17-144"></a>                    <span class="n">order_data</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-17-145" name="__codelineno-17-145" href="#__codelineno-17-145"></a>                        <span class="s2">&quot;bet_id&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">bet_id</span><span class="p">,</span>
<a id="__codelineno-17-146" name="__codelineno-17-146" href="#__codelineno-17-146"></a>                        <span class="s2">&quot;strategy_name&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">trade</span><span class="o">.</span><span class="n">strategy</span><span class="p">,</span>
<a id="__codelineno-17-147" name="__codelineno-17-147" href="#__codelineno-17-147"></a>                        <span class="s2">&quot;market_id&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">market_id</span><span class="p">,</span>
<a id="__codelineno-17-148" name="__codelineno-17-148" href="#__codelineno-17-148"></a>                        <span class="s2">&quot;selection_id&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">selection_id</span><span class="p">,</span>
<a id="__codelineno-17-149" name="__codelineno-17-149" href="#__codelineno-17-149"></a>                        <span class="s2">&quot;trade_id&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">trade</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
<a id="__codelineno-17-150" name="__codelineno-17-150" href="#__codelineno-17-150"></a>                        <span class="s2">&quot;date_time_placed&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">responses</span><span class="o">.</span><span class="n">date_time_placed</span><span class="p">,</span>
<a id="__codelineno-17-151" name="__codelineno-17-151" href="#__codelineno-17-151"></a>                        <span class="s2">&quot;price&quot;</span><span class="p">:</span> <span class="n">price</span><span class="p">,</span>
<a id="__codelineno-17-152" name="__codelineno-17-152" href="#__codelineno-17-152"></a>                        <span class="s2">&quot;price_matched&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">average_price_matched</span><span class="p">,</span>
<a id="__codelineno-17-153" name="__codelineno-17-153" href="#__codelineno-17-153"></a>                        <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="n">size</span><span class="p">,</span>
<a id="__codelineno-17-154" name="__codelineno-17-154" href="#__codelineno-17-154"></a>                        <span class="s2">&quot;size_matched&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">size_matched</span><span class="p">,</span>
<a id="__codelineno-17-155" name="__codelineno-17-155" href="#__codelineno-17-155"></a>                        <span class="s2">&quot;profit&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">simulated</span><span class="o">.</span><span class="n">profit</span><span class="p">,</span>
<a id="__codelineno-17-156" name="__codelineno-17-156" href="#__codelineno-17-156"></a>                        <span class="s2">&quot;side&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">side</span><span class="p">,</span>
<a id="__codelineno-17-157" name="__codelineno-17-157" href="#__codelineno-17-157"></a>                        <span class="s2">&quot;elapsed_seconds_executable&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">elapsed_seconds_executable</span><span class="p">,</span>
<a id="__codelineno-17-158" name="__codelineno-17-158" href="#__codelineno-17-158"></a>                        <span class="s2">&quot;order_status&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
<a id="__codelineno-17-159" name="__codelineno-17-159" href="#__codelineno-17-159"></a>                        <span class="s2">&quot;market_note&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">trade</span><span class="o">.</span><span class="n">market_notes</span><span class="p">,</span>
<a id="__codelineno-17-160" name="__codelineno-17-160" href="#__codelineno-17-160"></a>                        <span class="s2">&quot;trade_notes&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">trade</span><span class="o">.</span><span class="n">notes_str</span><span class="p">,</span>
<a id="__codelineno-17-161" name="__codelineno-17-161" href="#__codelineno-17-161"></a>                        <span class="s2">&quot;order_notes&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">notes_str</span><span class="p">,</span>
<a id="__codelineno-17-162" name="__codelineno-17-162" href="#__codelineno-17-162"></a>                    <span class="p">}</span>
<a id="__codelineno-17-163" name="__codelineno-17-163" href="#__codelineno-17-163"></a>                    <span class="n">csv_writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictWriter</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">fieldnames</span><span class="o">=</span><span class="n">FIELDNAMES</span><span class="p">)</span>
<a id="__codelineno-17-164" name="__codelineno-17-164" href="#__codelineno-17-164"></a>                    <span class="n">csv_writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">order_data</span><span class="p">)</span>
<a id="__codelineno-17-165" name="__codelineno-17-165" href="#__codelineno-17-165"></a>                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-17-166" name="__codelineno-17-166" href="#__codelineno-17-166"></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-17-167" name="__codelineno-17-167" href="#__codelineno-17-167"></a>                        <span class="s2">&quot;_process_cleared_orders_meta: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">,</span>
<a id="__codelineno-17-168" name="__codelineno-17-168" href="#__codelineno-17-168"></a>                        <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;order&quot;</span><span class="p">:</span> <span class="n">order</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">e</span><span class="p">},</span>
<a id="__codelineno-17-169" name="__codelineno-17-169" href="#__codelineno-17-169"></a>                    <span class="p">)</span>
<a id="__codelineno-17-170" name="__codelineno-17-170" href="#__codelineno-17-170"></a>
<a id="__codelineno-17-171" name="__codelineno-17-171" href="#__codelineno-17-171"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Orders updated&quot;</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;order_count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">orders</span><span class="p">)})</span>
<a id="__codelineno-17-172" name="__codelineno-17-172" href="#__codelineno-17-172"></a>
<a id="__codelineno-17-173" name="__codelineno-17-173" href="#__codelineno-17-173"></a>    <span class="k">def</span> <span class="nf">_process_cleared_markets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
<a id="__codelineno-17-174" name="__codelineno-17-174" href="#__codelineno-17-174"></a>        <span class="n">cleared_markets</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">event</span>
<a id="__codelineno-17-175" name="__codelineno-17-175" href="#__codelineno-17-175"></a>        <span class="k">for</span> <span class="n">cleared_market</span> <span class="ow">in</span> <span class="n">cleared_markets</span><span class="o">.</span><span class="n">orders</span><span class="p">:</span>
<a id="__codelineno-17-176" name="__codelineno-17-176" href="#__codelineno-17-176"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-17-177" name="__codelineno-17-177" href="#__codelineno-17-177"></a>                <span class="s2">&quot;Cleared market&quot;</span><span class="p">,</span>
<a id="__codelineno-17-178" name="__codelineno-17-178" href="#__codelineno-17-178"></a>                <span class="n">extra</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-17-179" name="__codelineno-17-179" href="#__codelineno-17-179"></a>                    <span class="s2">&quot;market_id&quot;</span><span class="p">:</span> <span class="n">cleared_market</span><span class="o">.</span><span class="n">market_id</span><span class="p">,</span>
<a id="__codelineno-17-180" name="__codelineno-17-180" href="#__codelineno-17-180"></a>                    <span class="s2">&quot;bet_count&quot;</span><span class="p">:</span> <span class="n">cleared_market</span><span class="o">.</span><span class="n">bet_count</span><span class="p">,</span>
<a id="__codelineno-17-181" name="__codelineno-17-181" href="#__codelineno-17-181"></a>                    <span class="s2">&quot;profit&quot;</span><span class="p">:</span> <span class="n">cleared_market</span><span class="o">.</span><span class="n">profit</span><span class="p">,</span>
<a id="__codelineno-17-182" name="__codelineno-17-182" href="#__codelineno-17-182"></a>                    <span class="s2">&quot;commission&quot;</span><span class="p">:</span> <span class="n">cleared_market</span><span class="o">.</span><span class="n">commission</span><span class="p">,</span>
<a id="__codelineno-17-183" name="__codelineno-17-183" href="#__codelineno-17-183"></a>                <span class="p">},</span>
<a id="__codelineno-17-184" name="__codelineno-17-184" href="#__codelineno-17-184"></a>            <span class="p">)</span>
<a id="__codelineno-17-185" name="__codelineno-17-185" href="#__codelineno-17-185"></a>
<a id="__codelineno-17-186" name="__codelineno-17-186" href="#__codelineno-17-186"></a><span class="c1"># Searches for all betfair data files within the folder sample_monthly_data_output</span>
<a id="__codelineno-17-187" name="__codelineno-17-187" href="#__codelineno-17-187"></a><span class="n">data_folder</span> <span class="o">=</span> <span class="s1">&#39;sample_monthly_data_output&#39;</span>
<a id="__codelineno-17-188" name="__codelineno-17-188" href="#__codelineno-17-188"></a><span class="n">data_files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">data_folder</span><span class="p">,)</span>
<a id="__codelineno-17-189" name="__codelineno-17-189" href="#__codelineno-17-189"></a><span class="n">data_files</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">data_folder</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">data_files</span><span class="p">]</span>
<a id="__codelineno-17-190" name="__codelineno-17-190" href="#__codelineno-17-190"></a>
<a id="__codelineno-17-191" name="__codelineno-17-191" href="#__codelineno-17-191"></a><span class="k">def</span> <span class="nf">run_process</span><span class="p">(</span><span class="n">markets</span><span class="p">):</span>
<a id="__codelineno-17-192" name="__codelineno-17-192" href="#__codelineno-17-192"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Replays a Betfair historic data. Places bets according to the user defined strategy and tries to accurately simulate matching by replaying the historic data.</span>
<a id="__codelineno-17-193" name="__codelineno-17-193" href="#__codelineno-17-193"></a>
<a id="__codelineno-17-194" name="__codelineno-17-194" href="#__codelineno-17-194"></a><span class="sd">    Args:</span>
<a id="__codelineno-17-195" name="__codelineno-17-195" href="#__codelineno-17-195"></a><span class="sd">        markets (list: [file paths]): a list of file paths to where the historic data is stored locally. e.g. user/zhoui/downloads/test.csv</span>
<a id="__codelineno-17-196" name="__codelineno-17-196" href="#__codelineno-17-196"></a><span class="sd">    &quot;&quot;&quot;</span>    
<a id="__codelineno-17-197" name="__codelineno-17-197" href="#__codelineno-17-197"></a>    <span class="c1"># Set Flumine to simulation mode</span>
<a id="__codelineno-17-198" name="__codelineno-17-198" href="#__codelineno-17-198"></a>    <span class="n">client</span> <span class="o">=</span> <span class="n">clients</span><span class="o">.</span><span class="n">SimulatedClient</span><span class="p">()</span>
<a id="__codelineno-17-199" name="__codelineno-17-199" href="#__codelineno-17-199"></a>    <span class="n">framework</span> <span class="o">=</span> <span class="n">FlumineSimulation</span><span class="p">(</span><span class="n">client</span><span class="o">=</span><span class="n">client</span><span class="p">)</span>
<a id="__codelineno-17-200" name="__codelineno-17-200" href="#__codelineno-17-200"></a>
<a id="__codelineno-17-201" name="__codelineno-17-201" href="#__codelineno-17-201"></a>    <span class="c1"># Set parameters for our strategy</span>
<a id="__codelineno-17-202" name="__codelineno-17-202" href="#__codelineno-17-202"></a>    <span class="n">strategy</span> <span class="o">=</span> <span class="n">FlatIggyModel</span><span class="p">(</span>
<a id="__codelineno-17-203" name="__codelineno-17-203" href="#__codelineno-17-203"></a>        <span class="n">market_filter</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-17-204" name="__codelineno-17-204" href="#__codelineno-17-204"></a>            <span class="s2">&quot;markets&quot;</span><span class="p">:</span> <span class="n">markets</span><span class="p">,</span>  
<a id="__codelineno-17-205" name="__codelineno-17-205" href="#__codelineno-17-205"></a>            <span class="s1">&#39;market_types&#39;</span><span class="p">:[</span><span class="s1">&#39;WIN&#39;</span><span class="p">],</span>
<a id="__codelineno-17-206" name="__codelineno-17-206" href="#__codelineno-17-206"></a>            <span class="s2">&quot;listener_kwargs&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;inplay&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;seconds_to_start&quot;</span><span class="p">:</span> <span class="mi">80</span><span class="p">},</span>  
<a id="__codelineno-17-207" name="__codelineno-17-207" href="#__codelineno-17-207"></a>            <span class="p">},</span>
<a id="__codelineno-17-208" name="__codelineno-17-208" href="#__codelineno-17-208"></a>        <span class="n">max_order_exposure</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
<a id="__codelineno-17-209" name="__codelineno-17-209" href="#__codelineno-17-209"></a>        <span class="n">max_selection_exposure</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
<a id="__codelineno-17-210" name="__codelineno-17-210" href="#__codelineno-17-210"></a>        <span class="n">max_live_trade_count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-17-211" name="__codelineno-17-211" href="#__codelineno-17-211"></a>        <span class="n">max_trade_count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-17-212" name="__codelineno-17-212" href="#__codelineno-17-212"></a>    <span class="p">)</span>
<a id="__codelineno-17-213" name="__codelineno-17-213" href="#__codelineno-17-213"></a>    <span class="c1"># Run our strategy on the simulated market</span>
<a id="__codelineno-17-214" name="__codelineno-17-214" href="#__codelineno-17-214"></a>    <span class="n">framework</span><span class="o">.</span><span class="n">add_strategy</span><span class="p">(</span><span class="n">strategy</span><span class="p">)</span>
<a id="__codelineno-17-215" name="__codelineno-17-215" href="#__codelineno-17-215"></a>    <span class="n">framework</span><span class="o">.</span><span class="n">add_logging_control</span><span class="p">(</span>
<a id="__codelineno-17-216" name="__codelineno-17-216" href="#__codelineno-17-216"></a>        <span class="n">BacktestLoggingControl</span><span class="p">()</span>
<a id="__codelineno-17-217" name="__codelineno-17-217" href="#__codelineno-17-217"></a>    <span class="p">)</span>
<a id="__codelineno-17-218" name="__codelineno-17-218" href="#__codelineno-17-218"></a>    <span class="n">framework</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
<a id="__codelineno-17-219" name="__codelineno-17-219" href="#__codelineno-17-219"></a>
<a id="__codelineno-17-220" name="__codelineno-17-220" href="#__codelineno-17-220"></a><span class="c1"># Multi processing</span>
<a id="__codelineno-17-221" name="__codelineno-17-221" href="#__codelineno-17-221"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
<a id="__codelineno-17-222" name="__codelineno-17-222" href="#__codelineno-17-222"></a>    <span class="n">all_markets</span> <span class="o">=</span> <span class="n">data_files</span>  <span class="c1"># All the markets we want to simulate</span>
<a id="__codelineno-17-223" name="__codelineno-17-223" href="#__codelineno-17-223"></a>    <span class="n">processes</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span>  <span class="c1"># Returns the number of CPUs in the system.</span>
<a id="__codelineno-17-224" name="__codelineno-17-224" href="#__codelineno-17-224"></a>    <span class="n">markets_per_process</span> <span class="o">=</span> <span class="mi">8</span>   <span class="c1"># 8 is optimal as it prevents data leakage.</span>
<a id="__codelineno-17-225" name="__codelineno-17-225" href="#__codelineno-17-225"></a>
<a id="__codelineno-17-226" name="__codelineno-17-226" href="#__codelineno-17-226"></a>    <span class="n">_process_jobs</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-17-227" name="__codelineno-17-227" href="#__codelineno-17-227"></a>    <span class="k">with</span> <span class="n">futures</span><span class="o">.</span><span class="n">ProcessPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="n">processes</span><span class="p">)</span> <span class="k">as</span> <span class="n">p</span><span class="p">:</span>
<a id="__codelineno-17-228" name="__codelineno-17-228" href="#__codelineno-17-228"></a>        <span class="c1"># Number of chunks to split the process into depends on the number of markets we want to process and number of CPUs we have.</span>
<a id="__codelineno-17-229" name="__codelineno-17-229" href="#__codelineno-17-229"></a>        <span class="n">chunk</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
<a id="__codelineno-17-230" name="__codelineno-17-230" href="#__codelineno-17-230"></a>            <span class="n">markets_per_process</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_markets</span><span class="p">)</span> <span class="o">/</span> <span class="n">processes</span><span class="p">)</span>
<a id="__codelineno-17-231" name="__codelineno-17-231" href="#__codelineno-17-231"></a>        <span class="p">)</span>
<a id="__codelineno-17-232" name="__codelineno-17-232" href="#__codelineno-17-232"></a>        <span class="c1"># Split all the markets we want to process into chunks to run on separate CPUs and then run them on the separate CPUs</span>
<a id="__codelineno-17-233" name="__codelineno-17-233" href="#__codelineno-17-233"></a>        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">chunks</span><span class="p">(</span><span class="n">all_markets</span><span class="p">,</span> <span class="n">chunk</span><span class="p">)):</span>
<a id="__codelineno-17-234" name="__codelineno-17-234" href="#__codelineno-17-234"></a>            <span class="n">_process_jobs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
<a id="__codelineno-17-235" name="__codelineno-17-235" href="#__codelineno-17-235"></a>                <span class="n">p</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span>
<a id="__codelineno-17-236" name="__codelineno-17-236" href="#__codelineno-17-236"></a>                    <span class="n">run_process</span><span class="p">,</span>
<a id="__codelineno-17-237" name="__codelineno-17-237" href="#__codelineno-17-237"></a>                    <span class="n">markets</span><span class="o">=</span><span class="n">m</span><span class="p">,</span>
<a id="__codelineno-17-238" name="__codelineno-17-238" href="#__codelineno-17-238"></a>                <span class="p">)</span>
<a id="__codelineno-17-239" name="__codelineno-17-239" href="#__codelineno-17-239"></a>            <span class="p">)</span>
<a id="__codelineno-17-240" name="__codelineno-17-240" href="#__codelineno-17-240"></a>        <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">futures</span><span class="o">.</span><span class="n">as_completed</span><span class="p">(</span><span class="n">_process_jobs</span><span class="p">):</span>
<a id="__codelineno-17-241" name="__codelineno-17-241" href="#__codelineno-17-241"></a>            <span class="n">job</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>  <span class="c1"># wait for result</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p><a href="https://github.com/betfair-down-under/autoHubTutorials/tree/master">Download from Github</a></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="c1"># Import libraries</span>
<a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="kn">import</span> <span class="nn">glob</span>
<a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a><span class="kn">import</span> <span class="nn">os</span>
<a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a><span class="kn">import</span> <span class="nn">time</span>
<a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a><span class="kn">import</span> <span class="nn">logging</span>
<a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a><span class="kn">import</span> <span class="nn">csv</span>
<a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a><span class="kn">import</span> <span class="nn">json</span>
<a id="__codelineno-18-9" name="__codelineno-18-9" href="#__codelineno-18-9"></a><span class="kn">import</span> <span class="nn">math</span>
<a id="__codelineno-18-10" name="__codelineno-18-10" href="#__codelineno-18-10"></a><span class="kn">from</span> <span class="nn">pythonjsonlogger</span> <span class="kn">import</span> <span class="n">jsonlogger</span>
<a id="__codelineno-18-11" name="__codelineno-18-11" href="#__codelineno-18-11"></a><span class="kn">from</span> <span class="nn">flumine</span> <span class="kn">import</span> <span class="n">FlumineSimulation</span><span class="p">,</span> <span class="n">BaseStrategy</span><span class="p">,</span> <span class="n">utils</span><span class="p">,</span> <span class="n">clients</span>
<a id="__codelineno-18-12" name="__codelineno-18-12" href="#__codelineno-18-12"></a><span class="kn">from</span> <span class="nn">flumine.order.trade</span> <span class="kn">import</span> <span class="n">Trade</span>
<a id="__codelineno-18-13" name="__codelineno-18-13" href="#__codelineno-18-13"></a><span class="kn">from</span> <span class="nn">flumine.order.order</span> <span class="kn">import</span> <span class="n">LimitOrder</span><span class="p">,</span> <span class="n">OrderStatus</span>
<a id="__codelineno-18-14" name="__codelineno-18-14" href="#__codelineno-18-14"></a><span class="kn">from</span> <span class="nn">flumine.order.ordertype</span> <span class="kn">import</span> <span class="n">OrderTypes</span>
<a id="__codelineno-18-15" name="__codelineno-18-15" href="#__codelineno-18-15"></a><span class="kn">from</span> <span class="nn">flumine.markets.market</span> <span class="kn">import</span> <span class="n">Market</span>
<a id="__codelineno-18-16" name="__codelineno-18-16" href="#__codelineno-18-16"></a><span class="kn">from</span> <span class="nn">flumine.controls.loggingcontrols</span> <span class="kn">import</span> <span class="n">LoggingControl</span>
<a id="__codelineno-18-17" name="__codelineno-18-17" href="#__codelineno-18-17"></a><span class="kn">from</span> <span class="nn">betfairlightweight.filters</span> <span class="kn">import</span> <span class="n">streaming_market_filter</span>
<a id="__codelineno-18-18" name="__codelineno-18-18" href="#__codelineno-18-18"></a><span class="kn">from</span> <span class="nn">betfairlightweight.resources</span> <span class="kn">import</span> <span class="n">MarketBook</span>
<a id="__codelineno-18-19" name="__codelineno-18-19" href="#__codelineno-18-19"></a><span class="kn">from</span> <span class="nn">pythonjsonlogger</span> <span class="kn">import</span> <span class="n">jsonlogger</span>
<a id="__codelineno-18-20" name="__codelineno-18-20" href="#__codelineno-18-20"></a><span class="kn">from</span> <span class="nn">concurrent</span> <span class="kn">import</span> <span class="n">futures</span>
<a id="__codelineno-18-21" name="__codelineno-18-21" href="#__codelineno-18-21"></a>
<a id="__codelineno-18-22" name="__codelineno-18-22" href="#__codelineno-18-22"></a><span class="c1"># Logging</span>
<a id="__codelineno-18-23" name="__codelineno-18-23" href="#__codelineno-18-23"></a><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span>
<a id="__codelineno-18-24" name="__codelineno-18-24" href="#__codelineno-18-24"></a><span class="n">custom_format</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%(asctime) %</span><span class="s2">(levelname) %(message)&quot;</span>
<a id="__codelineno-18-25" name="__codelineno-18-25" href="#__codelineno-18-25"></a><span class="n">log_handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()</span>
<a id="__codelineno-18-26" name="__codelineno-18-26" href="#__codelineno-18-26"></a><span class="n">formatter</span> <span class="o">=</span> <span class="n">jsonlogger</span><span class="o">.</span><span class="n">JsonFormatter</span><span class="p">(</span><span class="n">custom_format</span><span class="p">)</span>
<a id="__codelineno-18-27" name="__codelineno-18-27" href="#__codelineno-18-27"></a><span class="n">formatter</span><span class="o">.</span><span class="n">converter</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">gmtime</span>
<a id="__codelineno-18-28" name="__codelineno-18-28" href="#__codelineno-18-28"></a><span class="n">log_handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
<a id="__codelineno-18-29" name="__codelineno-18-29" href="#__codelineno-18-29"></a><span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">log_handler</span><span class="p">)</span>
<a id="__codelineno-18-30" name="__codelineno-18-30" href="#__codelineno-18-30"></a><span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>  <span class="c1"># Set to logging.CRITICAL to speed up simulation</span>
<a id="__codelineno-18-31" name="__codelineno-18-31" href="#__codelineno-18-31"></a>
<a id="__codelineno-18-32" name="__codelineno-18-32" href="#__codelineno-18-32"></a><span class="c1"># Read in predictions from hta_4</span>
<a id="__codelineno-18-33" name="__codelineno-18-33" href="#__codelineno-18-33"></a><span class="n">todays_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;backtest.csv&#39;</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="p">({</span><span class="s2">&quot;market_id&quot;</span><span class="p">:</span><span class="nb">str</span><span class="p">}))</span>
<a id="__codelineno-18-34" name="__codelineno-18-34" href="#__codelineno-18-34"></a><span class="n">todays_data</span> <span class="o">=</span> <span class="n">todays_data</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;market_id&#39;</span><span class="p">,</span><span class="s1">&#39;selection_id&#39;</span><span class="p">])</span>
<a id="__codelineno-18-35" name="__codelineno-18-35" href="#__codelineno-18-35"></a>
<a id="__codelineno-18-36" name="__codelineno-18-36" href="#__codelineno-18-36"></a><span class="c1">### New implementation</span>
<a id="__codelineno-18-37" name="__codelineno-18-37" href="#__codelineno-18-37"></a><span class="k">class</span> <span class="nc">FlatBetting</span><span class="p">(</span><span class="n">BaseStrategy</span><span class="p">):</span>
<a id="__codelineno-18-38" name="__codelineno-18-38" href="#__codelineno-18-38"></a>    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-18-39" name="__codelineno-18-39" href="#__codelineno-18-39"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;starting strategy &#39;FlatBetting&#39; using the model we created the Greyhound modelling in Python Tutorial&quot;</span><span class="p">)</span>
<a id="__codelineno-18-40" name="__codelineno-18-40" href="#__codelineno-18-40"></a>
<a id="__codelineno-18-41" name="__codelineno-18-41" href="#__codelineno-18-41"></a>    <span class="k">def</span> <span class="nf">check_market_book</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">market</span><span class="p">:</span> <span class="n">Market</span><span class="p">,</span> <span class="n">market_book</span><span class="p">:</span> <span class="n">MarketBook</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-18-42" name="__codelineno-18-42" href="#__codelineno-18-42"></a>        <span class="k">if</span> <span class="n">market_book</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="s2">&quot;CLOSED&quot;</span><span class="p">:</span>
<a id="__codelineno-18-43" name="__codelineno-18-43" href="#__codelineno-18-43"></a>            <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-18-44" name="__codelineno-18-44" href="#__codelineno-18-44"></a>
<a id="__codelineno-18-45" name="__codelineno-18-45" href="#__codelineno-18-45"></a>    <span class="k">def</span> <span class="nf">process_market_book</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">market</span><span class="p">:</span> <span class="n">Market</span><span class="p">,</span> <span class="n">market_book</span><span class="p">:</span> <span class="n">MarketBook</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-18-46" name="__codelineno-18-46" href="#__codelineno-18-46"></a>
<a id="__codelineno-18-47" name="__codelineno-18-47" href="#__codelineno-18-47"></a>        <span class="c1"># At the 60 second mark:</span>
<a id="__codelineno-18-48" name="__codelineno-18-48" href="#__codelineno-18-48"></a>        <span class="k">if</span> <span class="n">market</span><span class="o">.</span><span class="n">seconds_to_start</span> <span class="o">&lt;</span> <span class="mi">60</span> <span class="ow">and</span> <span class="n">market_book</span><span class="o">.</span><span class="n">inplay</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
<a id="__codelineno-18-49" name="__codelineno-18-49" href="#__codelineno-18-49"></a>
<a id="__codelineno-18-50" name="__codelineno-18-50" href="#__codelineno-18-50"></a>            <span class="c1"># Can&#39;t simulate polling API</span>
<a id="__codelineno-18-51" name="__codelineno-18-51" href="#__codelineno-18-51"></a>            <span class="c1"># Only use streaming API:</span>
<a id="__codelineno-18-52" name="__codelineno-18-52" href="#__codelineno-18-52"></a>            <span class="k">for</span> <span class="n">runner</span> <span class="ow">in</span> <span class="n">market_book</span><span class="o">.</span><span class="n">runners</span><span class="p">:</span>
<a id="__codelineno-18-53" name="__codelineno-18-53" href="#__codelineno-18-53"></a>                <span class="n">model_price</span> <span class="o">=</span> <span class="n">todays_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">market</span><span class="o">.</span><span class="n">market_id</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">runner</span><span class="o">.</span><span class="n">selection_id</span><span class="p">][</span><span class="s1">&#39;rating&#39;</span><span class="p">]</span>
<a id="__codelineno-18-54" name="__codelineno-18-54" href="#__codelineno-18-54"></a>                <span class="c1"># If best available to back price is &gt; rated price then flat $5 back</span>
<a id="__codelineno-18-55" name="__codelineno-18-55" href="#__codelineno-18-55"></a>                <span class="k">if</span> <span class="n">runner</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;ACTIVE&quot;</span> <span class="ow">and</span> <span class="n">runner</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">available_to_back</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;price&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">model_price</span><span class="p">:</span>
<a id="__codelineno-18-56" name="__codelineno-18-56" href="#__codelineno-18-56"></a>                    <span class="n">trade</span> <span class="o">=</span> <span class="n">Trade</span><span class="p">(</span>
<a id="__codelineno-18-57" name="__codelineno-18-57" href="#__codelineno-18-57"></a>                    <span class="n">market_id</span><span class="o">=</span><span class="n">market_book</span><span class="o">.</span><span class="n">market_id</span><span class="p">,</span>
<a id="__codelineno-18-58" name="__codelineno-18-58" href="#__codelineno-18-58"></a>                    <span class="n">selection_id</span><span class="o">=</span><span class="n">runner</span><span class="o">.</span><span class="n">selection_id</span><span class="p">,</span>
<a id="__codelineno-18-59" name="__codelineno-18-59" href="#__codelineno-18-59"></a>                    <span class="n">handicap</span><span class="o">=</span><span class="n">runner</span><span class="o">.</span><span class="n">handicap</span><span class="p">,</span>
<a id="__codelineno-18-60" name="__codelineno-18-60" href="#__codelineno-18-60"></a>                    <span class="n">strategy</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-18-61" name="__codelineno-18-61" href="#__codelineno-18-61"></a>                    <span class="p">)</span>
<a id="__codelineno-18-62" name="__codelineno-18-62" href="#__codelineno-18-62"></a>                    <span class="n">order</span> <span class="o">=</span> <span class="n">trade</span><span class="o">.</span><span class="n">create_order</span><span class="p">(</span>
<a id="__codelineno-18-63" name="__codelineno-18-63" href="#__codelineno-18-63"></a>                        <span class="n">side</span><span class="o">=</span><span class="s2">&quot;BACK&quot;</span><span class="p">,</span> <span class="n">order_type</span><span class="o">=</span><span class="n">LimitOrder</span><span class="p">(</span><span class="n">price</span><span class="o">=</span><span class="n">runner</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">available_to_back</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;price&#39;</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="mf">5.00</span><span class="p">)</span>
<a id="__codelineno-18-64" name="__codelineno-18-64" href="#__codelineno-18-64"></a>                    <span class="p">)</span>
<a id="__codelineno-18-65" name="__codelineno-18-65" href="#__codelineno-18-65"></a>                    <span class="n">market</span><span class="o">.</span><span class="n">place_order</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
<a id="__codelineno-18-66" name="__codelineno-18-66" href="#__codelineno-18-66"></a>                <span class="c1"># If best available to lay price is &lt; rated price then flat $5 lay</span>
<a id="__codelineno-18-67" name="__codelineno-18-67" href="#__codelineno-18-67"></a>                <span class="k">if</span> <span class="n">runner</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;ACTIVE&quot;</span> <span class="ow">and</span> <span class="n">runner</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">available_to_lay</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;price&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">model_price</span><span class="p">:</span>
<a id="__codelineno-18-68" name="__codelineno-18-68" href="#__codelineno-18-68"></a>                    <span class="n">trade</span> <span class="o">=</span> <span class="n">Trade</span><span class="p">(</span>
<a id="__codelineno-18-69" name="__codelineno-18-69" href="#__codelineno-18-69"></a>                    <span class="n">market_id</span><span class="o">=</span><span class="n">market_book</span><span class="o">.</span><span class="n">market_id</span><span class="p">,</span>
<a id="__codelineno-18-70" name="__codelineno-18-70" href="#__codelineno-18-70"></a>                    <span class="n">selection_id</span><span class="o">=</span><span class="n">runner</span><span class="o">.</span><span class="n">selection_id</span><span class="p">,</span>
<a id="__codelineno-18-71" name="__codelineno-18-71" href="#__codelineno-18-71"></a>                    <span class="n">handicap</span><span class="o">=</span><span class="n">runner</span><span class="o">.</span><span class="n">handicap</span><span class="p">,</span>
<a id="__codelineno-18-72" name="__codelineno-18-72" href="#__codelineno-18-72"></a>                    <span class="n">strategy</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-18-73" name="__codelineno-18-73" href="#__codelineno-18-73"></a>                    <span class="p">)</span>
<a id="__codelineno-18-74" name="__codelineno-18-74" href="#__codelineno-18-74"></a>                    <span class="n">order</span> <span class="o">=</span> <span class="n">trade</span><span class="o">.</span><span class="n">create_order</span><span class="p">(</span>
<a id="__codelineno-18-75" name="__codelineno-18-75" href="#__codelineno-18-75"></a>                        <span class="n">side</span><span class="o">=</span><span class="s2">&quot;LAY&quot;</span><span class="p">,</span> <span class="n">order_type</span><span class="o">=</span><span class="n">LimitOrder</span><span class="p">(</span><span class="n">price</span><span class="o">=</span><span class="n">runner</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">available_to_lay</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;price&#39;</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="mf">5.00</span><span class="p">)</span>
<a id="__codelineno-18-76" name="__codelineno-18-76" href="#__codelineno-18-76"></a>                    <span class="p">)</span>
<a id="__codelineno-18-77" name="__codelineno-18-77" href="#__codelineno-18-77"></a>                    <span class="n">market</span><span class="o">.</span><span class="n">place_order</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
<a id="__codelineno-18-78" name="__codelineno-18-78" href="#__codelineno-18-78"></a>
<a id="__codelineno-18-79" name="__codelineno-18-79" href="#__codelineno-18-79"></a><span class="c1"># Fields we want to log in our simulations</span>
<a id="__codelineno-18-80" name="__codelineno-18-80" href="#__codelineno-18-80"></a><span class="n">FIELDNAMES</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-18-81" name="__codelineno-18-81" href="#__codelineno-18-81"></a>    <span class="s2">&quot;bet_id&quot;</span><span class="p">,</span>
<a id="__codelineno-18-82" name="__codelineno-18-82" href="#__codelineno-18-82"></a>    <span class="s2">&quot;strategy_name&quot;</span><span class="p">,</span>
<a id="__codelineno-18-83" name="__codelineno-18-83" href="#__codelineno-18-83"></a>    <span class="s2">&quot;market_id&quot;</span><span class="p">,</span>
<a id="__codelineno-18-84" name="__codelineno-18-84" href="#__codelineno-18-84"></a>    <span class="s2">&quot;selection_id&quot;</span><span class="p">,</span>
<a id="__codelineno-18-85" name="__codelineno-18-85" href="#__codelineno-18-85"></a>    <span class="s2">&quot;trade_id&quot;</span><span class="p">,</span>
<a id="__codelineno-18-86" name="__codelineno-18-86" href="#__codelineno-18-86"></a>    <span class="s2">&quot;date_time_placed&quot;</span><span class="p">,</span>
<a id="__codelineno-18-87" name="__codelineno-18-87" href="#__codelineno-18-87"></a>    <span class="s2">&quot;price&quot;</span><span class="p">,</span>
<a id="__codelineno-18-88" name="__codelineno-18-88" href="#__codelineno-18-88"></a>    <span class="s2">&quot;price_matched&quot;</span><span class="p">,</span>
<a id="__codelineno-18-89" name="__codelineno-18-89" href="#__codelineno-18-89"></a>    <span class="s2">&quot;size&quot;</span><span class="p">,</span>
<a id="__codelineno-18-90" name="__codelineno-18-90" href="#__codelineno-18-90"></a>    <span class="s2">&quot;size_matched&quot;</span><span class="p">,</span>
<a id="__codelineno-18-91" name="__codelineno-18-91" href="#__codelineno-18-91"></a>    <span class="s2">&quot;profit&quot;</span><span class="p">,</span>
<a id="__codelineno-18-92" name="__codelineno-18-92" href="#__codelineno-18-92"></a>    <span class="s2">&quot;side&quot;</span><span class="p">,</span>
<a id="__codelineno-18-93" name="__codelineno-18-93" href="#__codelineno-18-93"></a>    <span class="s2">&quot;elapsed_seconds_executable&quot;</span><span class="p">,</span>
<a id="__codelineno-18-94" name="__codelineno-18-94" href="#__codelineno-18-94"></a>    <span class="s2">&quot;order_status&quot;</span><span class="p">,</span>
<a id="__codelineno-18-95" name="__codelineno-18-95" href="#__codelineno-18-95"></a>    <span class="s2">&quot;market_note&quot;</span><span class="p">,</span>
<a id="__codelineno-18-96" name="__codelineno-18-96" href="#__codelineno-18-96"></a>    <span class="s2">&quot;trade_notes&quot;</span><span class="p">,</span>
<a id="__codelineno-18-97" name="__codelineno-18-97" href="#__codelineno-18-97"></a>    <span class="s2">&quot;order_notes&quot;</span><span class="p">,</span>
<a id="__codelineno-18-98" name="__codelineno-18-98" href="#__codelineno-18-98"></a><span class="p">]</span>
<a id="__codelineno-18-99" name="__codelineno-18-99" href="#__codelineno-18-99"></a>
<a id="__codelineno-18-100" name="__codelineno-18-100" href="#__codelineno-18-100"></a><span class="c1"># Log results from simulation into csv file named sim_hta_4.csv</span>
<a id="__codelineno-18-101" name="__codelineno-18-101" href="#__codelineno-18-101"></a><span class="c1"># If the csv file doesn&#39;t exist then it is created, otherwise we append results to the csv file</span>
<a id="__codelineno-18-102" name="__codelineno-18-102" href="#__codelineno-18-102"></a><span class="k">class</span> <span class="nc">BacktestLoggingControl</span><span class="p">(</span><span class="n">LoggingControl</span><span class="p">):</span>
<a id="__codelineno-18-103" name="__codelineno-18-103" href="#__codelineno-18-103"></a>    <span class="n">NAME</span> <span class="o">=</span> <span class="s2">&quot;BACKTEST_LOGGING_CONTROL&quot;</span>
<a id="__codelineno-18-104" name="__codelineno-18-104" href="#__codelineno-18-104"></a>
<a id="__codelineno-18-105" name="__codelineno-18-105" href="#__codelineno-18-105"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-18-106" name="__codelineno-18-106" href="#__codelineno-18-106"></a>        <span class="nb">super</span><span class="p">(</span><span class="n">BacktestLoggingControl</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-18-107" name="__codelineno-18-107" href="#__codelineno-18-107"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_setup</span><span class="p">()</span>
<a id="__codelineno-18-108" name="__codelineno-18-108" href="#__codelineno-18-108"></a>
<a id="__codelineno-18-109" name="__codelineno-18-109" href="#__codelineno-18-109"></a>    <span class="k">def</span> <span class="nf">_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-18-110" name="__codelineno-18-110" href="#__codelineno-18-110"></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;sim_hta_4.csv&quot;</span><span class="p">):</span>
<a id="__codelineno-18-111" name="__codelineno-18-111" href="#__codelineno-18-111"></a>            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Results file exists&quot;</span><span class="p">)</span>
<a id="__codelineno-18-112" name="__codelineno-18-112" href="#__codelineno-18-112"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-18-113" name="__codelineno-18-113" href="#__codelineno-18-113"></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;sim_hta_4.csv&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">m</span><span class="p">:</span>
<a id="__codelineno-18-114" name="__codelineno-18-114" href="#__codelineno-18-114"></a>                <span class="n">csv_writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictWriter</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">fieldnames</span><span class="o">=</span><span class="n">FIELDNAMES</span><span class="p">)</span>
<a id="__codelineno-18-115" name="__codelineno-18-115" href="#__codelineno-18-115"></a>                <span class="n">csv_writer</span><span class="o">.</span><span class="n">writeheader</span><span class="p">()</span>
<a id="__codelineno-18-116" name="__codelineno-18-116" href="#__codelineno-18-116"></a>
<a id="__codelineno-18-117" name="__codelineno-18-117" href="#__codelineno-18-117"></a>    <span class="k">def</span> <span class="nf">_process_cleared_orders_meta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
<a id="__codelineno-18-118" name="__codelineno-18-118" href="#__codelineno-18-118"></a>        <span class="n">orders</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">event</span>
<a id="__codelineno-18-119" name="__codelineno-18-119" href="#__codelineno-18-119"></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;sim_hta_4.csv&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">m</span><span class="p">:</span>
<a id="__codelineno-18-120" name="__codelineno-18-120" href="#__codelineno-18-120"></a>            <span class="k">for</span> <span class="n">order</span> <span class="ow">in</span> <span class="n">orders</span><span class="p">:</span>
<a id="__codelineno-18-121" name="__codelineno-18-121" href="#__codelineno-18-121"></a>                <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">order_type</span><span class="o">.</span><span class="n">ORDER_TYPE</span> <span class="o">==</span> <span class="n">OrderTypes</span><span class="o">.</span><span class="n">LIMIT</span><span class="p">:</span>
<a id="__codelineno-18-122" name="__codelineno-18-122" href="#__codelineno-18-122"></a>                    <span class="n">size</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">order_type</span><span class="o">.</span><span class="n">size</span>
<a id="__codelineno-18-123" name="__codelineno-18-123" href="#__codelineno-18-123"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-18-124" name="__codelineno-18-124" href="#__codelineno-18-124"></a>                    <span class="n">size</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">order_type</span><span class="o">.</span><span class="n">liability</span>
<a id="__codelineno-18-125" name="__codelineno-18-125" href="#__codelineno-18-125"></a>                <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">order_type</span><span class="o">.</span><span class="n">ORDER_TYPE</span> <span class="o">==</span> <span class="n">OrderTypes</span><span class="o">.</span><span class="n">MARKET_ON_CLOSE</span><span class="p">:</span>
<a id="__codelineno-18-126" name="__codelineno-18-126" href="#__codelineno-18-126"></a>                    <span class="n">price</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-18-127" name="__codelineno-18-127" href="#__codelineno-18-127"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-18-128" name="__codelineno-18-128" href="#__codelineno-18-128"></a>                    <span class="n">price</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">order_type</span><span class="o">.</span><span class="n">price</span>
<a id="__codelineno-18-129" name="__codelineno-18-129" href="#__codelineno-18-129"></a>                <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-18-130" name="__codelineno-18-130" href="#__codelineno-18-130"></a>                    <span class="n">order_data</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-18-131" name="__codelineno-18-131" href="#__codelineno-18-131"></a>                        <span class="s2">&quot;bet_id&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">bet_id</span><span class="p">,</span>
<a id="__codelineno-18-132" name="__codelineno-18-132" href="#__codelineno-18-132"></a>                        <span class="s2">&quot;strategy_name&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">trade</span><span class="o">.</span><span class="n">strategy</span><span class="p">,</span>
<a id="__codelineno-18-133" name="__codelineno-18-133" href="#__codelineno-18-133"></a>                        <span class="s2">&quot;market_id&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">market_id</span><span class="p">,</span>
<a id="__codelineno-18-134" name="__codelineno-18-134" href="#__codelineno-18-134"></a>                        <span class="s2">&quot;selection_id&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">selection_id</span><span class="p">,</span>
<a id="__codelineno-18-135" name="__codelineno-18-135" href="#__codelineno-18-135"></a>                        <span class="s2">&quot;trade_id&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">trade</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
<a id="__codelineno-18-136" name="__codelineno-18-136" href="#__codelineno-18-136"></a>                        <span class="s2">&quot;date_time_placed&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">responses</span><span class="o">.</span><span class="n">date_time_placed</span><span class="p">,</span>
<a id="__codelineno-18-137" name="__codelineno-18-137" href="#__codelineno-18-137"></a>                        <span class="s2">&quot;price&quot;</span><span class="p">:</span> <span class="n">price</span><span class="p">,</span>
<a id="__codelineno-18-138" name="__codelineno-18-138" href="#__codelineno-18-138"></a>                        <span class="s2">&quot;price_matched&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">average_price_matched</span><span class="p">,</span>
<a id="__codelineno-18-139" name="__codelineno-18-139" href="#__codelineno-18-139"></a>                        <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="n">size</span><span class="p">,</span>
<a id="__codelineno-18-140" name="__codelineno-18-140" href="#__codelineno-18-140"></a>                        <span class="s2">&quot;size_matched&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">size_matched</span><span class="p">,</span>
<a id="__codelineno-18-141" name="__codelineno-18-141" href="#__codelineno-18-141"></a>                        <span class="s2">&quot;profit&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">simulated</span><span class="o">.</span><span class="n">profit</span><span class="p">,</span>
<a id="__codelineno-18-142" name="__codelineno-18-142" href="#__codelineno-18-142"></a>                        <span class="s2">&quot;side&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">side</span><span class="p">,</span>
<a id="__codelineno-18-143" name="__codelineno-18-143" href="#__codelineno-18-143"></a>                        <span class="s2">&quot;elapsed_seconds_executable&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">elapsed_seconds_executable</span><span class="p">,</span>
<a id="__codelineno-18-144" name="__codelineno-18-144" href="#__codelineno-18-144"></a>                        <span class="s2">&quot;order_status&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
<a id="__codelineno-18-145" name="__codelineno-18-145" href="#__codelineno-18-145"></a>                        <span class="s2">&quot;market_note&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">trade</span><span class="o">.</span><span class="n">market_notes</span><span class="p">,</span>
<a id="__codelineno-18-146" name="__codelineno-18-146" href="#__codelineno-18-146"></a>                        <span class="s2">&quot;trade_notes&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">trade</span><span class="o">.</span><span class="n">notes_str</span><span class="p">,</span>
<a id="__codelineno-18-147" name="__codelineno-18-147" href="#__codelineno-18-147"></a>                        <span class="s2">&quot;order_notes&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">notes_str</span><span class="p">,</span>
<a id="__codelineno-18-148" name="__codelineno-18-148" href="#__codelineno-18-148"></a>                    <span class="p">}</span>
<a id="__codelineno-18-149" name="__codelineno-18-149" href="#__codelineno-18-149"></a>                    <span class="n">csv_writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictWriter</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">fieldnames</span><span class="o">=</span><span class="n">FIELDNAMES</span><span class="p">)</span>
<a id="__codelineno-18-150" name="__codelineno-18-150" href="#__codelineno-18-150"></a>                    <span class="n">csv_writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">order_data</span><span class="p">)</span>
<a id="__codelineno-18-151" name="__codelineno-18-151" href="#__codelineno-18-151"></a>                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-18-152" name="__codelineno-18-152" href="#__codelineno-18-152"></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-18-153" name="__codelineno-18-153" href="#__codelineno-18-153"></a>                        <span class="s2">&quot;_process_cleared_orders_meta: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">,</span>
<a id="__codelineno-18-154" name="__codelineno-18-154" href="#__codelineno-18-154"></a>                        <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;order&quot;</span><span class="p">:</span> <span class="n">order</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">e</span><span class="p">},</span>
<a id="__codelineno-18-155" name="__codelineno-18-155" href="#__codelineno-18-155"></a>                    <span class="p">)</span>
<a id="__codelineno-18-156" name="__codelineno-18-156" href="#__codelineno-18-156"></a>
<a id="__codelineno-18-157" name="__codelineno-18-157" href="#__codelineno-18-157"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Orders updated&quot;</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;order_count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">orders</span><span class="p">)})</span>
<a id="__codelineno-18-158" name="__codelineno-18-158" href="#__codelineno-18-158"></a>
<a id="__codelineno-18-159" name="__codelineno-18-159" href="#__codelineno-18-159"></a>    <span class="k">def</span> <span class="nf">_process_cleared_markets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
<a id="__codelineno-18-160" name="__codelineno-18-160" href="#__codelineno-18-160"></a>        <span class="n">cleared_markets</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">event</span>
<a id="__codelineno-18-161" name="__codelineno-18-161" href="#__codelineno-18-161"></a>        <span class="k">for</span> <span class="n">cleared_market</span> <span class="ow">in</span> <span class="n">cleared_markets</span><span class="o">.</span><span class="n">orders</span><span class="p">:</span>
<a id="__codelineno-18-162" name="__codelineno-18-162" href="#__codelineno-18-162"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-18-163" name="__codelineno-18-163" href="#__codelineno-18-163"></a>                <span class="s2">&quot;Cleared market&quot;</span><span class="p">,</span>
<a id="__codelineno-18-164" name="__codelineno-18-164" href="#__codelineno-18-164"></a>                <span class="n">extra</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-18-165" name="__codelineno-18-165" href="#__codelineno-18-165"></a>                    <span class="s2">&quot;market_id&quot;</span><span class="p">:</span> <span class="n">cleared_market</span><span class="o">.</span><span class="n">market_id</span><span class="p">,</span>
<a id="__codelineno-18-166" name="__codelineno-18-166" href="#__codelineno-18-166"></a>                    <span class="s2">&quot;bet_count&quot;</span><span class="p">:</span> <span class="n">cleared_market</span><span class="o">.</span><span class="n">bet_count</span><span class="p">,</span>
<a id="__codelineno-18-167" name="__codelineno-18-167" href="#__codelineno-18-167"></a>                    <span class="s2">&quot;profit&quot;</span><span class="p">:</span> <span class="n">cleared_market</span><span class="o">.</span><span class="n">profit</span><span class="p">,</span>
<a id="__codelineno-18-168" name="__codelineno-18-168" href="#__codelineno-18-168"></a>                    <span class="s2">&quot;commission&quot;</span><span class="p">:</span> <span class="n">cleared_market</span><span class="o">.</span><span class="n">commission</span><span class="p">,</span>
<a id="__codelineno-18-169" name="__codelineno-18-169" href="#__codelineno-18-169"></a>                <span class="p">},</span>
<a id="__codelineno-18-170" name="__codelineno-18-170" href="#__codelineno-18-170"></a>            <span class="p">)</span>
<a id="__codelineno-18-171" name="__codelineno-18-171" href="#__codelineno-18-171"></a>
<a id="__codelineno-18-172" name="__codelineno-18-172" href="#__codelineno-18-172"></a><span class="c1"># Searches for all betfair data files within the folder sample_monthly_data_output</span>
<a id="__codelineno-18-173" name="__codelineno-18-173" href="#__codelineno-18-173"></a><span class="n">data_folder</span> <span class="o">=</span> <span class="s1">&#39;sample_monthly_data_output&#39;</span>
<a id="__codelineno-18-174" name="__codelineno-18-174" href="#__codelineno-18-174"></a><span class="n">data_files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">data_folder</span><span class="p">,)</span>
<a id="__codelineno-18-175" name="__codelineno-18-175" href="#__codelineno-18-175"></a><span class="n">data_files</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">data_folder</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">data_files</span><span class="p">]</span>
<a id="__codelineno-18-176" name="__codelineno-18-176" href="#__codelineno-18-176"></a>
<a id="__codelineno-18-177" name="__codelineno-18-177" href="#__codelineno-18-177"></a><span class="k">def</span> <span class="nf">run_process</span><span class="p">(</span><span class="n">markets</span><span class="p">):</span>
<a id="__codelineno-18-178" name="__codelineno-18-178" href="#__codelineno-18-178"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Replays a Betfair historic data. Places bets according to the user defined strategy and tries to accurately simulate matching by replaying the historic data.</span>
<a id="__codelineno-18-179" name="__codelineno-18-179" href="#__codelineno-18-179"></a>
<a id="__codelineno-18-180" name="__codelineno-18-180" href="#__codelineno-18-180"></a><span class="sd">    Args:</span>
<a id="__codelineno-18-181" name="__codelineno-18-181" href="#__codelineno-18-181"></a><span class="sd">        markets (list: [file paths]): a list of file paths to where the historic data is stored locally. e.g. user/zhoui/downloads/test.csv</span>
<a id="__codelineno-18-182" name="__codelineno-18-182" href="#__codelineno-18-182"></a><span class="sd">    &quot;&quot;&quot;</span>    
<a id="__codelineno-18-183" name="__codelineno-18-183" href="#__codelineno-18-183"></a>    <span class="c1"># Set Flumine to simulation mode</span>
<a id="__codelineno-18-184" name="__codelineno-18-184" href="#__codelineno-18-184"></a>    <span class="n">client</span> <span class="o">=</span> <span class="n">clients</span><span class="o">.</span><span class="n">SimulatedClient</span><span class="p">()</span>
<a id="__codelineno-18-185" name="__codelineno-18-185" href="#__codelineno-18-185"></a>    <span class="n">framework</span> <span class="o">=</span> <span class="n">FlumineSimulation</span><span class="p">(</span><span class="n">client</span><span class="o">=</span><span class="n">client</span><span class="p">)</span>
<a id="__codelineno-18-186" name="__codelineno-18-186" href="#__codelineno-18-186"></a>
<a id="__codelineno-18-187" name="__codelineno-18-187" href="#__codelineno-18-187"></a>    <span class="c1"># Set parameters for our strategy</span>
<a id="__codelineno-18-188" name="__codelineno-18-188" href="#__codelineno-18-188"></a>    <span class="n">strategy</span> <span class="o">=</span> <span class="n">FlatBetting</span><span class="p">(</span>
<a id="__codelineno-18-189" name="__codelineno-18-189" href="#__codelineno-18-189"></a>        <span class="n">market_filter</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-18-190" name="__codelineno-18-190" href="#__codelineno-18-190"></a>            <span class="s2">&quot;markets&quot;</span><span class="p">:</span> <span class="n">markets</span><span class="p">,</span>  
<a id="__codelineno-18-191" name="__codelineno-18-191" href="#__codelineno-18-191"></a>            <span class="s1">&#39;market_types&#39;</span><span class="p">:[</span><span class="s1">&#39;WIN&#39;</span><span class="p">],</span>
<a id="__codelineno-18-192" name="__codelineno-18-192" href="#__codelineno-18-192"></a>            <span class="s2">&quot;listener_kwargs&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;inplay&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;seconds_to_start&quot;</span><span class="p">:</span> <span class="mi">80</span><span class="p">},</span>  
<a id="__codelineno-18-193" name="__codelineno-18-193" href="#__codelineno-18-193"></a>            <span class="p">},</span>
<a id="__codelineno-18-194" name="__codelineno-18-194" href="#__codelineno-18-194"></a>        <span class="n">max_order_exposure</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
<a id="__codelineno-18-195" name="__codelineno-18-195" href="#__codelineno-18-195"></a>        <span class="n">max_selection_exposure</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
<a id="__codelineno-18-196" name="__codelineno-18-196" href="#__codelineno-18-196"></a>        <span class="n">max_live_trade_count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-18-197" name="__codelineno-18-197" href="#__codelineno-18-197"></a>        <span class="n">max_trade_count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-18-198" name="__codelineno-18-198" href="#__codelineno-18-198"></a>    <span class="p">)</span>
<a id="__codelineno-18-199" name="__codelineno-18-199" href="#__codelineno-18-199"></a>    <span class="c1"># Run our strategy on the simulated market</span>
<a id="__codelineno-18-200" name="__codelineno-18-200" href="#__codelineno-18-200"></a>    <span class="n">framework</span><span class="o">.</span><span class="n">add_strategy</span><span class="p">(</span><span class="n">strategy</span><span class="p">)</span>
<a id="__codelineno-18-201" name="__codelineno-18-201" href="#__codelineno-18-201"></a>    <span class="n">framework</span><span class="o">.</span><span class="n">add_logging_control</span><span class="p">(</span>
<a id="__codelineno-18-202" name="__codelineno-18-202" href="#__codelineno-18-202"></a>        <span class="n">BacktestLoggingControl</span><span class="p">()</span>
<a id="__codelineno-18-203" name="__codelineno-18-203" href="#__codelineno-18-203"></a>    <span class="p">)</span>
<a id="__codelineno-18-204" name="__codelineno-18-204" href="#__codelineno-18-204"></a>    <span class="n">framework</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
<a id="__codelineno-18-205" name="__codelineno-18-205" href="#__codelineno-18-205"></a>
<a id="__codelineno-18-206" name="__codelineno-18-206" href="#__codelineno-18-206"></a><span class="c1"># Multi processing</span>
<a id="__codelineno-18-207" name="__codelineno-18-207" href="#__codelineno-18-207"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
<a id="__codelineno-18-208" name="__codelineno-18-208" href="#__codelineno-18-208"></a>    <span class="n">all_markets</span> <span class="o">=</span> <span class="n">data_files</span>  <span class="c1"># All the markets we want to simulate</span>
<a id="__codelineno-18-209" name="__codelineno-18-209" href="#__codelineno-18-209"></a>    <span class="n">processes</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span>  <span class="c1"># Returns the number of CPUs in the system.</span>
<a id="__codelineno-18-210" name="__codelineno-18-210" href="#__codelineno-18-210"></a>    <span class="n">markets_per_process</span> <span class="o">=</span> <span class="mi">8</span>   <span class="c1"># 8 is optimal as it prevents data leakage.</span>
<a id="__codelineno-18-211" name="__codelineno-18-211" href="#__codelineno-18-211"></a>
<a id="__codelineno-18-212" name="__codelineno-18-212" href="#__codelineno-18-212"></a>    <span class="n">_process_jobs</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-18-213" name="__codelineno-18-213" href="#__codelineno-18-213"></a>    <span class="k">with</span> <span class="n">futures</span><span class="o">.</span><span class="n">ProcessPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="n">processes</span><span class="p">)</span> <span class="k">as</span> <span class="n">p</span><span class="p">:</span>
<a id="__codelineno-18-214" name="__codelineno-18-214" href="#__codelineno-18-214"></a>        <span class="c1"># Number of chunks to split the process into depends on the number of markets we want to process and number of CPUs we have.</span>
<a id="__codelineno-18-215" name="__codelineno-18-215" href="#__codelineno-18-215"></a>        <span class="n">chunk</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
<a id="__codelineno-18-216" name="__codelineno-18-216" href="#__codelineno-18-216"></a>            <span class="n">markets_per_process</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_markets</span><span class="p">)</span> <span class="o">/</span> <span class="n">processes</span><span class="p">)</span>
<a id="__codelineno-18-217" name="__codelineno-18-217" href="#__codelineno-18-217"></a>        <span class="p">)</span>
<a id="__codelineno-18-218" name="__codelineno-18-218" href="#__codelineno-18-218"></a>        <span class="c1"># Split all the markets we want to process into chunks to run on separate CPUs and then run them on the separate CPUs</span>
<a id="__codelineno-18-219" name="__codelineno-18-219" href="#__codelineno-18-219"></a>        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">chunks</span><span class="p">(</span><span class="n">all_markets</span><span class="p">,</span> <span class="n">chunk</span><span class="p">)):</span>
<a id="__codelineno-18-220" name="__codelineno-18-220" href="#__codelineno-18-220"></a>            <span class="n">_process_jobs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
<a id="__codelineno-18-221" name="__codelineno-18-221" href="#__codelineno-18-221"></a>                <span class="n">p</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span>
<a id="__codelineno-18-222" name="__codelineno-18-222" href="#__codelineno-18-222"></a>                    <span class="n">run_process</span><span class="p">,</span>
<a id="__codelineno-18-223" name="__codelineno-18-223" href="#__codelineno-18-223"></a>                    <span class="n">markets</span><span class="o">=</span><span class="n">m</span><span class="p">,</span>
<a id="__codelineno-18-224" name="__codelineno-18-224" href="#__codelineno-18-224"></a>                <span class="p">)</span>
<a id="__codelineno-18-225" name="__codelineno-18-225" href="#__codelineno-18-225"></a>            <span class="p">)</span>
<a id="__codelineno-18-226" name="__codelineno-18-226" href="#__codelineno-18-226"></a>        <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">futures</span><span class="o">.</span><span class="n">as_completed</span><span class="p">(</span><span class="n">_process_jobs</span><span class="p">):</span>
<a id="__codelineno-18-227" name="__codelineno-18-227" href="#__codelineno-18-227"></a>            <span class="n">job</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>  <span class="c1"># wait for result</span>
</code></pre></div>
</div>
</div>
</div>
<hr />
<h2 id="disclaimer">Disclaimer</h2>
<p>Note that whilst models and automated strategies are fun and rewarding to create, we can't promise that your model or betting strategy will be profitable, and we make no representations in relation to the code shared or information on this page. If you're using this code or implementing your own strategies, you do so entirely at your own risk and you are responsible for any winnings/losses incurred. Under no circumstances will Betfair be liable for any loss or damage you suffer.</p>


  




                
              </article>
            </div>
          
          
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
    
      <nav class="md-footer__inner md-grid" aria-label="footer.title">
        
          
          <a href="../How_to_Automate_4/" class="md-footer__link md-footer__link--prev" aria-label="Previous: How to Automate 4" rel="prev">
            <div class="md-footer__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
            </div>
            <div class="md-footer__title">
              <div class="md-ellipsis">
                <span class="md-footer__direction">
                  Previous
                </span>
                How to Automate 4
              </div>
            </div>
          </a>
        
        
          
          <a href="../processingTarFiles101/" class="md-footer__link md-footer__link--next" aria-label="Next: Take away the pain! Processing TAR Files 101" rel="next">
            <div class="md-footer__title">
              <div class="md-ellipsis">
                <span class="md-footer__direction">
                  Next
                </span>
                Take away the pain! Processing TAR Files 101
              </div>
            </div>
            <div class="md-footer__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
            </div>
          </a>
        
      </nav>
    
    <div class="md-footer-meta md-typeset">
      <div class="md-footer-meta__inner md-grid">
        <div class="md-copyright">
  
  
</div>
        
          <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://twitter.com/Betfair_Aus" target="_blank" rel="noopener" title="twitter.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://linkedin.com/company/betfair-australia" target="_blank" rel="noopener" title="linkedin.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://facebook.com/betfairaustralia" target="_blank" rel="noopener" title="facebook.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M504 256C504 119 393 8 256 8S8 119 8 256c0 123.78 90.69 226.38 209.25 245V327.69h-63V256h63v-54.64c0-62.15 37-96.48 93.67-96.48 27.14 0 55.52 4.84 55.52 4.84v61h-31.28c-30.8 0-40.41 19.12-40.41 38.73V256h68.78l-11 71.69h-57.78V501C413.31 482.38 504 379.78 504 256z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://youtube.com/user/betfairaus" target="_blank" rel="noopener" title="youtube.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M549.655 124.083c-6.281-23.65-24.787-42.276-48.284-48.597C458.781 64 288 64 288 64S117.22 64 74.629 75.486c-23.497 6.322-42.003 24.947-48.284 48.597-11.412 42.867-11.412 132.305-11.412 132.305s0 89.438 11.412 132.305c6.281 23.65 24.787 41.5 48.284 47.821C117.22 448 288 448 288 448s170.78 0 213.371-11.486c23.497-6.321 42.003-24.171 48.284-47.821 11.412-42.867 11.412-132.305 11.412-132.305s0-89.438-11.412-132.305zm-317.51 213.508V175.185l142.739 81.205-142.739 81.201z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://github.com/betfair-datascientists" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
</div>
        
      </div>

      <div class="bf-footer">
          <div class="bf-footer-inner">
              <p class="bf-light">Betfair Pty Limited is licensed and regulated by the Northern Territory Government of Australia.</p>
              <p class="bf-dark">Betfair Pty Limited's gambling operations are governed by its <a class='inner-link' href="https://www.betfair.com.au/info/responsible-gambling/">Responsible Gambling Code of Conduct</a> and for South
              Australian residents by the <a class='inner-link' href="https://www.betfair.com.au/info/pdf/SA-GCoP.pdf">South Australian Responsible Gambling Code of Practice.</a></p>
              <p class="bf-dark">BetStop is the Australian National Self-Exclusion Register. For more information, please visit <a class="inner-link" href="https://betstop.gov.au">https://betstop.gov.au</a><br /> <div class="full-screen"> <p style="font-family: Arial, sans-serif; font-size: 1.2rem; font-weight: bold;text-align: center;">Imagine what you could be buying instead</p> <p style="font-family: Arial, sans-serif; font-size: 0.8rem; font-weight: bold;text-align: center;">For free and confidential support call 1800 858 858 or visit <a href="http://www.gamblinghelponline.org.au" style="color: black; text-decoration: underline;">www.gamblinghelponline.org.au</a></p> </div> </p>
              <ul class="bf-links">
                <li><a href="https://www.betfair.com.au/hub/help/account-help/responsible-gambling/">Responsible Gambling</a><span>|</span></li>
                <li><a href="http://www.betfair.com/AUS_NZL/aboutUs/Terms.and.Conditions/">Terms & Conditions</a><span>|</span></li>
                <li><a href="https://www.betfair.com.au/info/privacy-policy/">Privacy Policy</a><span>|</span></li>
                <li><a href="http://www.betfair.com/en/aboutUs/Rules.and.Regulations/">Rules & Regulations</a><span>|</span></li>
                <li><a href="https://www.betfair.com/AUS_NZL/aboutUs/Dispute.Resolution">Dispute Resolution</a></li>
              </ul>
          </div>
      </div>
    </div>

    <script src="https://js.adsrvr.org/up_loader.1.1.0.js" type="text/javascript"></script>
    <script type="text/javascript">
        ttd_dom_ready( function() {
            if (typeof TTDUniversalPixelApi === 'function') {
                var universalPixelApi = new TTDUniversalPixelApi();
                universalPixelApi.init("y12d1ir", ["8ml4f17"], "https://insight.adsrvr.org/track/up");
            }
        });
    </script>

</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["toc.integrate", "navigation.instant", "navigation.tabs", "navigation.top", "navigation.expand", "navigation.sections", "search.suggest", "search.highlight", "search.share"], "search": "../../assets/javascripts/workers/search.f886a092.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.aecac24b.min.js"></script>
      
        <script src="../../js/scripts.js"></script>
      
    
  </body>
</html>