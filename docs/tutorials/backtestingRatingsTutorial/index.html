
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Documentation, guides and articles on creating, developing and implementing automated betting strategies, using data analysis to inform betting models and how to interact with the Betfair API.">
      
      
        <meta name="author" content="Betfair Data Scientists">
      
      
        <link rel="canonical" href="https://betfair-datascientists.github.io/tutorials/backtestingRatingsTutorial/">
      
      
        <link rel="prev" href="../jsonToCsvRevisited/">
      
      
        <link rel="next" href="../automatedBettingAnglesTutorial/">
      
      
      <link rel="icon" href="../../img/BetfairFavicon.ico">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.5">
    
    
      
        <title>Back testing ratings in Python - The Automation Hub</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.8608ea7d.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/betfair.css">
    
      <link rel="stylesheet" href="../../css/buttons_and_animations.css">
    
      <link rel="stylesheet" href="../../css/fonts.css">
    
      <link rel="stylesheet" href="../../css/ansi-colours.css">
    
      <link rel="stylesheet" href="../../css/jupyter-cells.css">
    
      <link rel="stylesheet" href="../../css/pandas-dataframe.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","UA-125973915-1"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","UA-125973915-1",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=UA-125973915-1",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="betfair" data-md-color-primary="amber" data-md-color-accent="orange">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#backtesting-wagering-models-with-betfair-json-stream-data" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      
  
  <header class="md-header" data-md-component="header">
    <nav class="md-header__inner md-grid" aria-label="header.title">
      <a href="../.." title="The Automation Hub" class="md-header__button md-logo" aria-label="The Automation Hub" data-md-component="logo">
        
  <img src="../../img/logo.svg" alt="logo">

      </a>
      <label class="md-header__button md-icon" for="__drawer">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
      </label>
      <div class="md-header__title" data-md-component="header-title">
        <div class="md-header__ellipsis">
          <div class="md-header__topic">
            <span class="md-ellipsis">
              The Automation Hub
            </span>
          </div>
          <div class="md-header__topic" data-md-component="header-topic">
            <span class="md-ellipsis">
              
                Back testing ratings in Python
              
            </span>
          </div>
        </div>
      </div>

      
        <form class="md-header__option" data-md-component="palette">
          
            
            
            <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="betfair" data-md-color-primary="amber" data-md-color-accent="orange"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
            
              <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg>
              </label>
            
          
            
            
            <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="amber" data-md-color-accent="orange"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
            
              <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"/></svg>
              </label>
            
          
        </form>
      
      

      
     
      <div class="bf-nav">
        <a class="bf-hidable" href="https://www.betfair.com.au/exchange/plus/"><svg class="exchangeLogo" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:cc="http://creativecommons.org/ns#"
          xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 38.775 4.59" width="24" height="17">
          <path class="st1" d="m 160.3,-136.95 v 26" />
          <g transform="translate(18.8,-137.15)">
            <path d="m 2.2901089,126.53441 v 5.20093 H -3.3107216 L 7.4888397,144.33446 18.2884,131.73534 h -5.598633 v -5.20093 z m -8.6000974,8.10132 -10.8017585,12.59913 h 5.60083 v 5.2998 h 10.3996581 v -5.2998 h 5.6008306 z" />
          </g>
        </svg><span> Exchange</span></a>
        <a href="https://www.betfair.com.au/hub/">Hub</a>
      </div>

      

    </nav>
    
  </header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../data/dataListing/" class="md-tabs__link">
          
  
  Data

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../wagering/betfairHowTo/" class="md-tabs__link">
          
  
  Wagering

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../api/apiResources/" class="md-tabs__link">
          
  
  API

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../modelling/tennisDatathon/" class="md-tabs__link">
          
  
  Modelling

        </a>
      </li>
    
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../How_to_Automate_1/" class="md-tabs__link">
          
  
  Tutorials

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../mentalGame/intro/" class="md-tabs__link">
          
  
  Mental Game

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../contactUs/test/" class="md-tabs__link">
          
  
  Contact Us

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="The Automation Hub" class="md-nav__button md-logo" aria-label="The Automation Hub" data-md-component="logo">
      
  <img src="../../img/logo.svg" alt="logo">

    </a>
    The Automation Hub
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Data
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Data
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../data/dataListing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CSV Files
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../data/usingHistoricDataSite/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Historic Data Site
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Wagering
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Wagering
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../wagering/betfairHowTo/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Betfair How-To
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../wagering/bettingGlossary/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Betting Glossary
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../wagering/stakingMethods/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Staking Methods and Bankroll Management
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../wagering/valueAndOdds/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Value and Odds
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../wagering/commission/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Commission and other charges
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../wagering/hubPredictionsModel/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Hub Predictions Model
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../wagering/2ndPlaceVoid/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Cashback 2nd Markets
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../wagering/exactaQuinella/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Exactas & Quinella
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    API
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            API
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/apiResources/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    API resources
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/apiappkey/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to access the Betfair API
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/apiRtutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    API tutorial in R
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/apiPythontutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    API tutorial in Python
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Modelling
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Modelling
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/tennisDatathon/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Tennis Datathon
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/howToModel/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Intro to modelling
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/dataSources/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Pricing Data Sources
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/cloudOrLocalMachine/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Cloud or Local
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/monteCarloSimulations/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Monte Carlo Simulations
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_6" >
        
          
          <label class="md-nav__link" for="__nav_5_6" id="__nav_5_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    AFL
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_6">
            <span class="md-nav__icon md-icon"></span>
            AFL
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/AFLPlayerDisposalsTutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Player Disposal Lines
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/AFLPlayerDisposalsFlumine/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Betting Player Disposal Markets
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/modellingTheBrownlowMedal/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How does a Data Scientist model the Brownlow?
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_7" >
        
          
          <label class="md-nav__link" for="__nav_5_7" id="__nav_5_7_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    AFL (Archive)
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_7">
            <span class="md-nav__icon md-icon"></span>
            AFL (Archive)
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/AFLmodellingPython/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    AFL modelling walk through in Python
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/brownlowModelTutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Modelling the Brownlow Medal in Python
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_8" >
        
          
          <label class="md-nav__link" for="__nav_5_8" id="__nav_5_8_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Greyhounds
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_8">
            <span class="md-nav__icon md-icon"></span>
            Greyhounds
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/topazTutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Greyhound Topaz API (Python)
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_9" >
        
          
          <label class="md-nav__link" for="__nav_5_9" id="__nav_5_9_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Greyhounds (Archive)
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_9">
            <span class="md-nav__icon md-icon"></span>
            Greyhounds (Archive)
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/fasttrackTutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Greyhound FastTrack API (Python)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/greyhoundModellingPython/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Greyhound modelling (Python)
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_10" >
        
          
          <label class="md-nav__link" for="__nav_5_10" id="__nav_5_10_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Soccer
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_10">
            <span class="md-nav__icon md-icon"></span>
            Soccer
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/howToBuildASoccerBotPartI/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How To Build A Soccer Bot P1
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/howToBuildASoccerBotPartII/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How To Build A Soccer Bot P2
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/howToBuildASoccerBotPartIII/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How To Build A Soccer Bot P3
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_11" >
        
          
          <label class="md-nav__link" for="__nav_5_11" id="__nav_5_11_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Soccer (Archive)
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_11_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_11">
            <span class="md-nav__icon md-icon"></span>
            Soccer (Archive)
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/soccerModellingTutorialPython/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Soccer modelling (Python)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/EPLmlPython/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    EPL Machine Learning (Python)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/soccerModellingELO2022WorldCup/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Soccer modelling (R) - 2022 FIFA World Cup
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/soccerEloTutorialR/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Elo soccer tutorial (R)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/soccerModellingTutorialR/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Soccer modelling (R)
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_12" >
        
          
          <label class="md-nav__link" for="__nav_5_12" id="__nav_5_12_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Tennis (Archive)
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_12_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_12">
            <span class="md-nav__icon md-icon"></span>
            Tennis (Archive)
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/howToModelTheAusOpen/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to model the Australian Open
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/AusOpenRTutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Aus Open R Tutorial
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/AusOpenPythonTutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Aus Open Python Tutorial
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" checked>
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Tutorials
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Tutorials
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../How_to_Automate_1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to Automate 1
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../How_to_Automate_2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to Automate 2
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../How_to_Automate_3/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to Automate 3
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../How_to_Automate_4/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to Automate 4
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../How_to_Automate_5/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to Automate 5
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../flumineSimulations/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Flumine Simulations
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../processingTarFiles101/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Take away the pain! Processing TAR Files 101
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../jsonToCsvRevisited/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    JSON to CSV | Revisited
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Back testing ratings in Python
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Back testing ratings in Python
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#workshop" class="md-nav__link">
    <span class="md-ellipsis">
      Workshop
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#set-up" class="md-nav__link">
    <span class="md-ellipsis">
      Set up
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#context" class="md-nav__link">
    <span class="md-ellipsis">
      Context
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#backtesting-on-betfair" class="md-nav__link">
    <span class="md-ellipsis">
      Backtesting on Betfair
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#betfair-stream-data" class="md-nav__link">
    <span class="md-ellipsis">
      Betfair Stream Data
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#this-example-backtesting-betfair-hub-thoroughbred-model" class="md-nav__link">
    <span class="md-ellipsis">
      This example: backtesting Betfair Hub thoroughbred model
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#scrape-the-model-ratings" class="md-nav__link">
    <span class="md-ellipsis">
      Scrape The Model Ratings
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#assembling-the-odds-file" class="md-nav__link">
    <span class="md-ellipsis">
      Assembling the odds file
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Assembling the odds file">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-data" class="md-nav__link">
    <span class="md-ellipsis">
      The Data
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#unpacking-flattening-the-data" class="md-nav__link">
    <span class="md-ellipsis">
      Unpacking / flattening the data
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Unpacking / flattening the data">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-tar-load" class="md-nav__link">
    <span class="md-ellipsis">
      1: .tar load
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-scan-across-market-states-and-extract-useful-objects" class="md-nav__link">
    <span class="md-ellipsis">
      2: Scan across market states and extract useful objects
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-4-summarise-those-useful-objects-and-write-to-csv" class="md-nav__link">
    <span class="md-ellipsis">
      3 &amp; 4: Summarise those useful objects and write to .csv
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#extending-this-code" class="md-nav__link">
    <span class="md-ellipsis">
      Extending this code
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#backtesting-analysis" class="md-nav__link">
    <span class="md-ellipsis">
      Backtesting Analysis
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Backtesting Analysis">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#setting-up-your-master-data" class="md-nav__link">
    <span class="md-ellipsis">
      Setting up your master data
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#staking-outcome-functions" class="md-nav__link">
    <span class="md-ellipsis">
      Staking + Outcome Functions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#evaluation-functions" class="md-nav__link">
    <span class="md-ellipsis">
      Evaluation Functions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#testing-different-approaches" class="md-nav__link">
    <span class="md-ellipsis">
      Testing different approaches
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#searching-for-profit" class="md-nav__link">
    <span class="md-ellipsis">
      Searching For Profit
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conclusion-and-next-steps" class="md-nav__link">
    <span class="md-ellipsis">
      Conclusion and Next Steps
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Conclusion and Next Steps">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#over-to-you" class="md-nav__link">
    <span class="md-ellipsis">
      Over to you
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#complete-code" class="md-nav__link">
    <span class="md-ellipsis">
      Complete code
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#disclaimer" class="md-nav__link">
    <span class="md-ellipsis">
      Disclaimer
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../automatedBettingAnglesTutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Automated betting angles in Python
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../analysingAndPredictingMarketMovements/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Do they know? Analysing Betfair market formation & market movements
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../analysingAndPredictingBSP/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Wisdom of the crowd? Analysing & understanding BSP
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Mental Game
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            Mental Game
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/intro/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Intro
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/roleOfEmotions/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Part 1
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/mapYourEmotions/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Part 2
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/handlingBadVariance/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Part 3
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/winbyBeingGreatatLosing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Part 4
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/correctingyouremotions/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Part 5
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/responsibleGambling/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Part 6
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/InchwormConcept/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Part 7
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/HighExpectations/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Part 8
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/TappingYourIntuition/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Part 9
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_8" >
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Contact Us
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            Contact Us
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../contactUs/test/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Meet the Team
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="backtesting-wagering-models-with-betfair-json-stream-data">Backtesting wagering models with Betfair JSON stream data</h1>
<hr />
<h3 id="workshop">Workshop</h3>
<iframe width="560" height="315" src="https://www.youtube.com/embed/0UfPdeghuN8" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>

<hr />
<p>This tutorial was written by <a href="https://github.com/TMBish">Tom Bishop</a> and was <a href="https://github.com/TMBish/bfStreamTutorials/tree/main/01-backtesting">originally published on Github</a>. It is shared here with his permission. </p>
<p>This tutorial follows on logically from the <a href="https://betfair-datascientists.github.io/tutorials/jsonToCsvTutorial/">JSON to CSV tutorial</a> we shared previously. If you're still new to working with the JSON data sets we suggest you take a look at that tutorial before diving into this one. </p>
<p>As always please <a href="mailto:automation@betfair.com.au">reach out</a> with feedback, suggestions or queries, or feel free to submit a <a href="https://github.com/betfair-down-under/autoHubTutorials/pulls">pull request</a> if you catch some bugs or have other improvements! </p>
<div class="admonition note">
<p class="admonition-title">Cheat sheet</p>
<ul>
<li>
<p>If you're looking for the complete code <a href="https://betfair-datascientists.github.io/tutorials/backtestingRatingsTutorial/#complete-code">head to the bottom of the page</a> or <a href="https://github.com/betfair-down-under/autoHubTutorials/blob/aa76784071aad7703266d53dead7a713815e6107/backtestRatings/main.py">download the script from Github</a>.</p>
</li>
<li>
<p>To run the code, save it to your machine, open a command prompt, or a terminal in your text editor of choice (we're using <a href="https://code.visualstudio.com/download">VS code</a>), make sure you've navigated in the terminal to the folder you've saved the script in and then type <code>py main.py</code> (or whatever you've called your script file if not main) then hit enter. To stop the code running use Ctrl C. </p>
</li>
<li>
<p>Make sure you amend your data path to point to your data file. We'll be taking in an input of a historical tar file downloaded from the <a href="https://historicdata.betfair.com/#/help">Betfair historic data site</a>. We're using a PRO version, though the code should work on ADVANCED too. This approach won't work with the BASIC data tier. </p>
</li>
<li>
<p>We're using the <a href="https://github.com/liampauling/betfair/tree/master/betfairlightweight"><code>betfairlightweight</code></a> package to do the heavy lifting</p>
</li>
<li>
<p>We've also posted the completed code logic on the <a href="https://github.com/betfair-down-under/autoHubTutorials/blob/aa76784071aad7703266d53dead7a713815e6107/backtestRatings/main.py"><code>betfair-downunder</code> Github repo</a>.</p>
</li>
<li>
<p>You can <a href="https://www.youtube.com/watch?v=0UfPdeghuN8">watch our workshop working through this tutorial on YouTube.</a></p>
</li>
</ul>
</div>
<hr />
<p><strong>This article was written more than 2 years ago and some packages used here will have changed since the article was written. Continue at your peril</strong></p>
<h3 id="set-up">Set up</h3>
<p>I'm going to be using a jupyter notebook for this investigation which is a special type of data analysis output that is used to combine code, outputs and explanatory text in a readable single document. It's mostly closely associated with python data analysis code which is the language I'll be using here also. The entire body of python code used will be repeated at the bottom of the article where you can copy it and repurpose it for yourself.</p>
<p>If you're not familiar with python, don't worry neither am I really! I'm inexperienced with python so if you have experience with some other programming language you should be able to follow along with the logic here too. If you don't have experience using another programming language this all might appear intimidating but it's heavy on the explanatory text so you should get something out of it.</p>
<p>We need a few non standard python libraries so make sure to install <code>betfairlightweight</code> and <code>plotly</code> before you get started with something like <code>pip install betfairlightweight</code> &amp; <code>pip install plotly</code>. We'll load all our libraries and do some setup here.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">date</span><span class="p">,</span> <span class="n">timedelta</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="kn">import</span><span class="w"> </span><span class="nn">tarfile</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">zipfile</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="kn">import</span><span class="w"> </span><span class="nn">bz2</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="kn">import</span><span class="w"> </span><span class="nn">glob</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">patch</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Set</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Optional</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a><span class="kn">from</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="kn">import</span> <span class="n">zip_longest</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a><span class="kn">import</span><span class="w"> </span><span class="nn">plotly.express</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">px</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a><span class="kn">import</span><span class="w"> </span><span class="nn">betfairlightweight</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a><span class="kn">from</span><span class="w"> </span><span class="nn">betfairlightweight</span><span class="w"> </span><span class="kn">import</span> <span class="n">StreamListener</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a><span class="kn">from</span><span class="w"> </span><span class="nn">betfairlightweight.resources.bettingresources</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>    <span class="n">PriceSize</span><span class="p">,</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>    <span class="n">MarketBook</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a><span class="p">)</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a><span class="o">%</span><span class="n">config</span> <span class="n">IPCompleter</span><span class="o">.</span><span class="n">greedy</span><span class="o">=</span><span class="kc">True</span>
</code></pre></div>
<hr />
<h3 id="context">Context</h3>
<p>Backtesting is the life-blood of most successful wagering systems. In short it attempts to answer a single question for you:</p>
<blockquote>
<p>&#120591; : How much money will I win or lose if I started using this system to place bets with real money?</p>
</blockquote>
<p>Without a rigorous and quantitative backtesting approach it's really quite hard to estimate the answer to this question $ \tau $ that will be even reliably on the right side of zero.</p>
<p>You could live test your system with real bets at small stakes, however, this isn't the panacea it seems. It will take time (more than you think) for your results to converge to their long term expectation. How long? Answering this question will require some expertise with probability and statistics you might not have. Even more than that though is that depending on where you're betting your results at small stakes could be very different than at larger stakes. You might not be able get a good answer to $ \tau $ until betting at full stakes at which point finding the answer might coincide with blowing up your gambling bankroll.</p>
<p>Backtesting is also very hard. To perfectly backtest your own predicted probability on a historical race or sporting match you need to produce 2 things:</p>
<blockquote>
<p>(1) What would my predicted chance have been exactly for this selection in this market on this day in the past?</p>
<p>(2) What would have I decided to bet at what odds (exactly) and for how much stake (exactly) based on this prediction?</p>
</blockquote>
<p>The devil in the detail of backtesting tends to be in those exactlys.</p>
<p>The aim of the backtesting game is answering (2) as accurately as possible because it tells you exactly how much you would have made over your backtesting period, from there you can confidently project that rate of profitability forward.</p>
<p>It's easy to make mistakes and small errors in the quantitative reasoning can lead you to extremely misguided projections downstream.</p>
<p>Question (1) won't be in the scope of this notebook but it's equally (and probably more) important that (2) but it is the key challenge of all predictive modelling exercises so there's plenty of discussion about it elsewhere.</p>
<hr />
<h3 id="backtesting-on-betfair">Backtesting on Betfair</h3>
<p>Answering question (2) for betting on the Betfair Exchange is difficult. The Exchange is a dynamic system that changes from one micro second to the next.</p>
<blockquote>
<p>What number should you use for odds? How much could you assume to get down at those odds?</p>
</blockquote>
<p>The conventional and easiest approach is to backtest at the BSP. The BSP is simple because it's a single number (to use for both back and lay bets) and is a taken price (there's no uncertainty about getting matched). Depending on the liquidity of the market a reasonably sized stake might also not move the BSP very much. For some markets you may be able to safely assume you could be $10s of dollars at the BSP without moving it an inch. However, that's definitely not true of all BSP markets and you need to be generally aware that your Betfair orders in the future will change the state of the exchange, and large bets will move the BSP in an unfavourable direction.</p>
<p>Aside from uncertainty around the liquidity and resilience of the BSP, many many markets don't have a BSP. So what do we do then?</p>
<p>Typically what a lot of people (who have a relationship with Betfair Australia) do at this point is request a data dump. They might request an odds file for all Australian harness race win markets since June 2018 with results and 4 different price points: the BSP, the last traded price, the weighted average price (WAP) traded in 3 minutes before the race starts, and the WAP for all bets matched prior to 3 mins before the race.</p>
<p>However, you will likely need to be an existing VIP customer to get this file and it's not a perfect solution: it might take 2 weeks to get, you can't refresh it, you can't test more hypothetical price points after your initial analysis amongst many other problems.</p>
<blockquote>
<p>What if you could produce this valuable data file yourself?</p>
</blockquote>
<hr />
<h3 id="betfair-stream-data">Betfair Stream Data</h3>
<p>Betfair's historical stream data is an extremely rich source of data. However, in it's raw form it's difficult to handle for the uninitiated. It also might not be immediately obvious how many different things this dataset could be used for without seeing some examples. These guides will hopefully demystify how to turn this raw data into a familiar and usable format whilst also hopefully providing some inspiration for the kinds of value that can be excavated from it.</p>
<hr />
<h3 id="this-example-backtesting-betfair-hub-thoroughbred-model">This example: backtesting Betfair Hub thoroughbred model</h3>
<p>To illustrate how you can use the stream files to backtest the outputs of a rating system we'll use the Australian Thoroughbred Rating model available on the Betfair Hub. The most recent model iteration only goes back till Feb 28th 2021 however as an illustrative example this is fine. We'd normally want to backtest with a lot more historical data than this, which just means in this case our estimation of future performance will be unreliable.</p>
<p>I'm interested to see how we would have fared betting all selections rated by this model according to a few different staking schemes and also at a few different times / price points.</p>
<div class="admonition note">
<p class="admonition-title">Old ratings</p>
<p>If you want to pull in ratings from before Feb 2021 to add to your database for more complete backtesting these are available in a <a href="../resources/oldRatingsDump.7z">data dump here</a>.</p>
</div>
<hr />
<h2 id="scrape-the-model-ratings">Scrape The Model Ratings</h2>
<p>If you travel to the Betfair hub ratings page you'll find that URL links behind the ratings download buttons have a consistent URL pattern that looks very scrape friendly.</p>
<p><img alt="Betfair Hub Ratings" src="../img/ratingsExample.png" /></p>
<p>We can take advantage of this consistency and use some simple python code to scrape all the ratings into a pandas dataframe.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="c1"># Function to return Pandas DF of hub ratings for a particular date</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">getHubRatings</span><span class="p">(</span><span class="n">dte</span><span class="p">):</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>    <span class="c1"># Substitute the date into the URL</span>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>    <span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;https://betfair-data-supplier-prod.herokuapp.com/api/widgets/kash-ratings-model/datasets?date=</span><span class="si">{}</span><span class="s1">presenter=RatingsPresenter&amp;json=true&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dte</span><span class="p">)</span>
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a>
<a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a>    <span class="c1"># Convert the response into JSON</span>
<a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a>    <span class="n">responseJson</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
<a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a>
<a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a>    <span class="n">hubList</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a>
<a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">responseJson</span><span class="p">:</span>
<a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a>        <span class="k">return</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a>
<a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a>
<a id="__codelineno-1-16" name="__codelineno-1-16" href="#__codelineno-1-16"></a>    <span class="c1"># Want an normalised table (1 row per selection)</span>
<a id="__codelineno-1-17" name="__codelineno-1-17" href="#__codelineno-1-17"></a>    <span class="c1"># Brute force / simple approach is to loop through meetings / races / runners and pull out the key fields</span>
<a id="__codelineno-1-18" name="__codelineno-1-18" href="#__codelineno-1-18"></a>    <span class="k">for</span> <span class="n">meeting</span> <span class="ow">in</span> <span class="n">responseJson</span><span class="p">[</span><span class="s1">&#39;meetings&#39;</span><span class="p">]:</span>
<a id="__codelineno-1-19" name="__codelineno-1-19" href="#__codelineno-1-19"></a>        <span class="k">for</span> <span class="n">race</span> <span class="ow">in</span> <span class="n">meeting</span><span class="p">[</span><span class="s1">&#39;races&#39;</span><span class="p">]:</span>
<a id="__codelineno-1-20" name="__codelineno-1-20" href="#__codelineno-1-20"></a>            <span class="k">for</span> <span class="n">runner</span> <span class="ow">in</span> <span class="n">race</span><span class="p">[</span><span class="s1">&#39;runners&#39;</span><span class="p">]:</span>
<a id="__codelineno-1-21" name="__codelineno-1-21" href="#__codelineno-1-21"></a>                <span class="n">hubList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
<a id="__codelineno-1-22" name="__codelineno-1-22" href="#__codelineno-1-22"></a>                    <span class="p">{</span>
<a id="__codelineno-1-23" name="__codelineno-1-23" href="#__codelineno-1-23"></a>                        <span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="n">dte</span><span class="p">,</span>
<a id="__codelineno-1-24" name="__codelineno-1-24" href="#__codelineno-1-24"></a>                        <span class="s1">&#39;track&#39;</span><span class="p">:</span> <span class="n">meeting</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
<a id="__codelineno-1-25" name="__codelineno-1-25" href="#__codelineno-1-25"></a>                        <span class="s1">&#39;race_number&#39;</span><span class="p">:</span> <span class="n">race</span><span class="p">[</span><span class="s1">&#39;number&#39;</span><span class="p">],</span>
<a id="__codelineno-1-26" name="__codelineno-1-26" href="#__codelineno-1-26"></a>                        <span class="s1">&#39;race_name&#39;</span><span class="p">:</span> <span class="n">race</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
<a id="__codelineno-1-27" name="__codelineno-1-27" href="#__codelineno-1-27"></a>                        <span class="s1">&#39;market_id&#39;</span><span class="p">:</span> <span class="n">race</span><span class="p">[</span><span class="s1">&#39;bfExchangeMarketId&#39;</span><span class="p">],</span>
<a id="__codelineno-1-28" name="__codelineno-1-28" href="#__codelineno-1-28"></a>                        <span class="s1">&#39;selection_id&#39;</span><span class="p">:</span>  <span class="nb">str</span><span class="p">(</span><span class="n">runner</span><span class="p">[</span><span class="s1">&#39;bfExchangeSelectionId&#39;</span><span class="p">]),</span>
<a id="__codelineno-1-29" name="__codelineno-1-29" href="#__codelineno-1-29"></a>                        <span class="s1">&#39;selection_name&#39;</span><span class="p">:</span> <span class="n">runner</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
<a id="__codelineno-1-30" name="__codelineno-1-30" href="#__codelineno-1-30"></a>                        <span class="s1">&#39;model_odds&#39;</span><span class="p">:</span> <span class="n">runner</span><span class="p">[</span><span class="s1">&#39;ratedPrice&#39;</span><span class="p">]</span>
<a id="__codelineno-1-31" name="__codelineno-1-31" href="#__codelineno-1-31"></a>                    <span class="p">}</span>
<a id="__codelineno-1-32" name="__codelineno-1-32" href="#__codelineno-1-32"></a>                <span class="p">)</span>
<a id="__codelineno-1-33" name="__codelineno-1-33" href="#__codelineno-1-33"></a>
<a id="__codelineno-1-34" name="__codelineno-1-34" href="#__codelineno-1-34"></a>    <span class="n">out</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">hubList</span><span class="p">)</span>
<a id="__codelineno-1-35" name="__codelineno-1-35" href="#__codelineno-1-35"></a>
<a id="__codelineno-1-36" name="__codelineno-1-36" href="#__codelineno-1-36"></a>    <span class="k">return</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="c1"># See the response from a single day</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="n">getHubRatings</span><span class="p">(</span><span class="n">date</span><span class="p">(</span><span class="mi">2021</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</code></pre></div>
<table>
<thead>
<tr>
<th>date</th>
<th>track</th>
<th>race_number</th>
<th>race_name</th>
<th>market_id</th>
<th>selection_id</th>
<th>selection_name</th>
<th>model_odds</th>
</tr>
</thead>
<tbody>
<tr>
<td>2021-03-01</td>
<td>COWRA</td>
<td>1</td>
<td>R1 1375m Mdn</td>
<td>1.179845154</td>
<td>38620052</td>
<td>1. Military Affair</td>
<td>6.44</td>
</tr>
<tr>
<td>2021-03-01</td>
<td>COWRA</td>
<td>1</td>
<td>R1 1375m Mdn</td>
<td>1.179845154</td>
<td>5889703</td>
<td>3. Proverbial</td>
<td>21.11</td>
</tr>
<tr>
<td>2021-03-01</td>
<td>COWRA</td>
<td>1</td>
<td>R1 1375m Mdn</td>
<td>1.179845154</td>
<td>38177688</td>
<td>4. A Real Wag</td>
<td>9.97</td>
</tr>
<tr>
<td>2021-03-01</td>
<td>COWRA</td>
<td>1</td>
<td>R1 1375m Mdn</td>
<td>1.179845154</td>
<td>38620053</td>
<td>5. El Jay</td>
<td>44.12</td>
</tr>
<tr>
<td>2021-03-01</td>
<td>COWRA</td>
<td>1</td>
<td>R1 1375m Mdn</td>
<td>1.179845154</td>
<td>37263264</td>
<td>6. Flying Honour</td>
<td>3.39</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="n">dateDFList</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="n">dateList</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">date</span><span class="p">(</span><span class="mi">2021</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">18</span><span class="p">),</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">-</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span><span class="n">freq</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="k">for</span> <span class="n">dte</span> <span class="ow">in</span> <span class="n">dateList</span><span class="p">:</span>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a>    <span class="n">dateDFList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">getHubRatings</span><span class="p">(</span><span class="n">dte</span><span class="p">))</span>
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a>
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a><span class="c1"># Concatenate (add rows to rows) all the dataframes within the list</span>
<a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a><span class="n">hubRatings</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">dateDFList</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="n">hubRatings</span><span class="o">.</span><span class="n">shape</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="p">(</span><span class="mi">32519</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
</code></pre></div>
<hr />
<h2 id="assembling-the-odds-file">Assembling the odds file</h2>
<p>So part 1 was very painless. This is how we like data: served by some API or available in a nice tabular format on a webpage ready to be scraped with standard tools available in popular languages.</p>
<p>Unfortunately, it won't be so painless to assemble our odds file. We'll find out why it's tricky as we go.</p>
<hr />
<h3 id="the-data">The Data</h3>
<p>The data we'll be using is the historical Exchange data available from this website. The data available through this service is called streaming JSON data. There are a few options available relating to granularity (how many time points per second the data updates at) but we'll be using the most granular "PRO" set which has updates every 50 milliseconds.</p>
<p>Essentially what the data allows us to do is, for a particular market, recreate the exact state of the Betfair Exchange at say: 150 milliseconds before the market closed. When people say the state of the Exchange they mean two things a) what are all the current open orders on all the selections b) what are the current traded volumes on each selection at each price point. We obviously don't have access to any information about which accounts are putting up which prices and other things Betfair has themselves. We're essentially getting a snapshot of everything you can see through the website by clicking on each selection manually and looking at the graphs, tables and ladders.</p>
<p>However, with just these 2 sets of information we can build a rich view of the dynamics of exchange and also build out all of the summary metrics (WAP etc) we might have previously needed Betfair to help with.</p>
<p>For our purposes 50 milli-second intervaled data is huge overkill. But you could imagine needing this kind of granularity for other kinds of wagering systems - eg a high frequency trading algorithm of some sort that needs to make many decisions and actions every second.</p>
<p>Let's take a look at what the stream data looks like for a single market:</p>
<p><img alt="Stream Data Example" src="../img/streamDataExample.png" /></p>
<p>So it looks pretty intractable. For this particular market there's 14,384 lines of data where each line consists of a single JSON packet of data. If you're not a data engineer (neither am I) your head might explode thinking about how you could read this into your computer and transform it into something usable.</p>
<p>The data looks like this because it is saved from a special Betfair API called the Stream API which which is used by high end Betfair API users and which delivers fast speeds other performance improvements over the normal "polling" API.</p>
<p>Now what's good about that, for the purposes of our exercise, is that the very nice python package <code>betfairlightweight</code> has the functionality built to not only parse the Stream API when connected live but also these historical saved versions of the stream data. Without it we'd be very far away from the finish line, with <code>betfairlightweight</code> we're pretty close.</p>
<hr />
<h3 id="unpacking-flattening-the-data">Unpacking / flattening the data</h3>
<p>Because these files are so large and unprocessed this process won't look the same as your normal data ETL in python: where you can read a raw data file (csv, JSON, text etc.) into memory and use python functions to transform into usable format.</p>
<p>I personally had no idea how to use python and <code>betfairlightweight</code> to parse these data until I saw <a href="https://betfair-datascientists.github.io/tutorials/jsonToCsvTutorial/">Betfair's very instructive overview</a> which you should read for a more detailed look at some of the below code.</p>
<p>By my count there were 4 key conceptual components that I had to get my head around to understand and be able to re-purpose that code. So if you're like me (a bit confused by some of the steps in that piece) this explanation might help.</p>
<p>I'll assume you don't do any decompression and keep the monthly PRO files as the .tar archives as they are.</p>
<p>Conceptually the process looks something like this:</p>
<ol>
<li>Load the "archives" into a "generator"</li>
<li>Scan across the generator (market_ids) and the market states within those markets to extract useful objects</li>
<li>Process those useful objects to pull out some metadata + useful summary numbers derived from the available orders and traded volumes snapshot data</li>
<li>Write this useful summarised data to a file that can be read and understood with normal data analysis workflows
First we'll run a bunch of setup code setting up my libraries and creating some utility functions that will be used throughout the main parsing component. It'll also point to the two stream files I'll be parsing for this exercise.</li>
</ol>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="c1"># create trading instance (don&#39;t need username/password)</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="n">trading</span> <span class="o">=</span> <span class="n">betfairlightweight</span><span class="o">.</span><span class="n">APIClient</span><span class="p">(</span><span class="s2">&quot;username&quot;</span><span class="p">,</span> <span class="s2">&quot;password&quot;</span><span class="p">)</span>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="c1"># create listener</span>
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="n">listener</span> <span class="o">=</span> <span class="n">StreamListener</span><span class="p">(</span><span class="n">max_latency</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a>
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a><span class="c1">### Utility Functions</span>
<a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a>
<a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a><span class="c1"># rounding to 2 decimal places or returning &#39;&#39; if blank</span>
<a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a><span class="k">def</span><span class="w"> </span><span class="nf">as_str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a>    <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">v</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">float</span> <span class="k">else</span> <span class="n">v</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
<a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a>
<a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a><span class="c1"># splitting race name and returning the parts </span>
<a id="__codelineno-6-14" name="__codelineno-6-14" href="#__codelineno-6-14"></a><span class="k">def</span><span class="w"> </span><span class="nf">split_anz_horse_market_name</span><span class="p">(</span><span class="n">market_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-6-15" name="__codelineno-6-15" href="#__codelineno-6-15"></a>    <span class="c1"># return race no, length, race type</span>
<a id="__codelineno-6-16" name="__codelineno-6-16" href="#__codelineno-6-16"></a>    <span class="c1"># input sample: R6 1400m Grp1</span>
<a id="__codelineno-6-17" name="__codelineno-6-17" href="#__codelineno-6-17"></a>    <span class="n">parts</span> <span class="o">=</span> <span class="n">market_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
<a id="__codelineno-6-18" name="__codelineno-6-18" href="#__codelineno-6-18"></a>    <span class="n">race_no</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># return example R6</span>
<a id="__codelineno-6-19" name="__codelineno-6-19" href="#__codelineno-6-19"></a>    <span class="n">race_len</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># return example 1400m</span>
<a id="__codelineno-6-20" name="__codelineno-6-20" href="#__codelineno-6-20"></a>    <span class="n">race_type</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="c1"># return example grp1, trot, pace</span>
<a id="__codelineno-6-21" name="__codelineno-6-21" href="#__codelineno-6-21"></a>
<a id="__codelineno-6-22" name="__codelineno-6-22" href="#__codelineno-6-22"></a>    <span class="k">return</span> <span class="p">(</span><span class="n">race_no</span><span class="p">,</span> <span class="n">race_len</span><span class="p">,</span> <span class="n">race_type</span><span class="p">)</span>
<a id="__codelineno-6-23" name="__codelineno-6-23" href="#__codelineno-6-23"></a>
<a id="__codelineno-6-24" name="__codelineno-6-24" href="#__codelineno-6-24"></a><span class="c1"># creating a flag that is True when markets are australian thoroughbreds</span>
<a id="__codelineno-6-25" name="__codelineno-6-25" href="#__codelineno-6-25"></a><span class="k">def</span><span class="w"> </span><span class="nf">filter_market</span><span class="p">(</span><span class="n">market</span><span class="p">:</span> <span class="n">MarketBook</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span> 
<a id="__codelineno-6-26" name="__codelineno-6-26" href="#__codelineno-6-26"></a>    <span class="n">d</span> <span class="o">=</span> <span class="n">market</span><span class="o">.</span><span class="n">market_definition</span>
<a id="__codelineno-6-27" name="__codelineno-6-27" href="#__codelineno-6-27"></a>    <span class="k">return</span> <span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">country_code</span> <span class="o">==</span> <span class="s1">&#39;AU&#39;</span> 
<a id="__codelineno-6-28" name="__codelineno-6-28" href="#__codelineno-6-28"></a>        <span class="ow">and</span> <span class="n">d</span><span class="o">.</span><span class="n">market_type</span> <span class="o">==</span> <span class="s1">&#39;WIN&#39;</span> 
<a id="__codelineno-6-29" name="__codelineno-6-29" href="#__codelineno-6-29"></a>        <span class="ow">and</span> <span class="p">(</span><span class="n">c</span> <span class="o">:=</span> <span class="n">split_anz_horse_market_name</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">name</span><span class="p">)[</span><span class="mi">2</span><span class="p">])</span> <span class="o">!=</span> <span class="s1">&#39;trot&#39;</span> <span class="ow">and</span> <span class="n">c</span> <span class="o">!=</span> <span class="s1">&#39;pace&#39;</span><span class="p">)</span>
</code></pre></div>
<h4 id="1-tar-load">1: .tar load</h4>
<ul>
<li>This function I stole from <a href="https://betfair-datascientists.github.io/tutorials/jsonToCsvTutorial/">Betfair's instructional article</a></li>
<li>The stream files are downloaded as .tar archive files which are a special kind of file that we'll need to unpack</li>
<li>Instead of loading each file into memory this function returns a "generator" which is a special python object that is to be iterated over</li>
<li>This basically means it contains the instructions to unpack and scan over files on the fly</li>
<li>This function also contains the logic to deal with if these files are zip archives or you've manually unpacked the archive and have the .bz2 zipped files</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="c1"># loading from tar and extracting files</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">load_markets</span><span class="p">(</span><span class="n">file_paths</span><span class="p">):</span>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>    <span class="k">for</span> <span class="n">file_path</span> <span class="ow">in</span> <span class="n">file_paths</span><span class="p">:</span>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a>        <span class="nb">print</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a>            <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">iglob</span><span class="p">(</span><span class="n">file_path</span> <span class="o">+</span> <span class="s1">&#39;**/**/*.bz2&#39;</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a>                <span class="n">f</span> <span class="o">=</span> <span class="n">bz2</span><span class="o">.</span><span class="n">BZ2File</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a>                <span class="k">yield</span> <span class="n">f</span>
<a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a>                <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a>        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
<a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a>            <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file_path</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a>            <span class="c1"># iterate through a tar archive</span>
<a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a>            <span class="k">if</span> <span class="n">ext</span> <span class="o">==</span> <span class="s1">&#39;.tar&#39;</span><span class="p">:</span>
<a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a>                <span class="k">with</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">TarFile</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">archive</span><span class="p">:</span>
<a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a>                    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">archive</span><span class="p">:</span>
<a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a>                        <span class="k">yield</span> <span class="n">bz2</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">archive</span><span class="o">.</span><span class="n">extractfile</span><span class="p">(</span><span class="n">file</span><span class="p">))</span>
<a id="__codelineno-7-17" name="__codelineno-7-17" href="#__codelineno-7-17"></a>            <span class="c1"># or a zip archive</span>
<a id="__codelineno-7-18" name="__codelineno-7-18" href="#__codelineno-7-18"></a>            <span class="k">elif</span> <span class="n">ext</span> <span class="o">==</span> <span class="s1">&#39;.zip&#39;</span><span class="p">:</span>
<a id="__codelineno-7-19" name="__codelineno-7-19" href="#__codelineno-7-19"></a>                <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">archive</span><span class="p">:</span>
<a id="__codelineno-7-20" name="__codelineno-7-20" href="#__codelineno-7-20"></a>                    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">archive</span><span class="o">.</span><span class="n">namelist</span><span class="p">():</span>
<a id="__codelineno-7-21" name="__codelineno-7-21" href="#__codelineno-7-21"></a>                        <span class="k">yield</span> <span class="n">bz2</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">archive</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file</span><span class="p">))</span>
<a id="__codelineno-7-22" name="__codelineno-7-22" href="#__codelineno-7-22"></a>
<a id="__codelineno-7-23" name="__codelineno-7-23" href="#__codelineno-7-23"></a>    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div>
<h4 id="2-scan-across-market-states-and-extract-useful-objects">2: Scan across market states and extract useful objects</h4>
<ul>
<li>So this function will take a special "stream" object which we'll create with <code>betfairlightweight</code></li>
<li>The function takes a stream object input and returns 4 instances of the market state</li>
<li>The market state 3 mins before the scheduled off</li>
<li>The market state immediately before it goes inplay</li>
<li>The market state immediately before it closes for settlement</li>
<li>The final market state with outcomes</li>
<li>It basically just loops over all the market states and has a few checks to determine if it should save the current market state as key variables and then returns those</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="c1"># Extract Components From Generated Stream</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">extract_components_from_stream</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a>    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s2">&quot;builtins.open&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">f</span><span class="p">,</span> <span class="n">_</span><span class="p">:</span> <span class="n">f</span><span class="p">):</span>   
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a>
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a>        <span class="c1"># Will return 3 market books t-3mins marketbook, the last preplay marketbook and the final market book</span>
<a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a>        <span class="n">evaluate_market</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a>        <span class="n">prev_market</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a>        <span class="n">postplay_market</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a>        <span class="n">preplay_market</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a>        <span class="n">t3m_market</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a>
<a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a>        <span class="n">gen</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">get_generator</span><span class="p">()</span>
<a id="__codelineno-8-14" name="__codelineno-8-14" href="#__codelineno-8-14"></a>
<a id="__codelineno-8-15" name="__codelineno-8-15" href="#__codelineno-8-15"></a>        <span class="k">for</span> <span class="n">market_books</span> <span class="ow">in</span> <span class="n">gen</span><span class="p">():</span>
<a id="__codelineno-8-16" name="__codelineno-8-16" href="#__codelineno-8-16"></a>
<a id="__codelineno-8-17" name="__codelineno-8-17" href="#__codelineno-8-17"></a>            <span class="k">for</span> <span class="n">market_book</span> <span class="ow">in</span> <span class="n">market_books</span><span class="p">:</span>
<a id="__codelineno-8-18" name="__codelineno-8-18" href="#__codelineno-8-18"></a>
<a id="__codelineno-8-19" name="__codelineno-8-19" href="#__codelineno-8-19"></a>                <span class="c1"># If markets don&#39;t meet filter return None&#39;s</span>
<a id="__codelineno-8-20" name="__codelineno-8-20" href="#__codelineno-8-20"></a>                <span class="k">if</span> <span class="n">evaluate_market</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">((</span><span class="n">evaluate_market</span> <span class="o">:=</span> <span class="n">filter_market</span><span class="p">(</span><span class="n">market_book</span><span class="p">))</span> <span class="o">==</span> <span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-8-21" name="__codelineno-8-21" href="#__codelineno-8-21"></a>                    <span class="k">return</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-8-22" name="__codelineno-8-22" href="#__codelineno-8-22"></a>
<a id="__codelineno-8-23" name="__codelineno-8-23" href="#__codelineno-8-23"></a>                <span class="c1"># final market view before market goes in play</span>
<a id="__codelineno-8-24" name="__codelineno-8-24" href="#__codelineno-8-24"></a>                <span class="k">if</span> <span class="n">prev_market</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">prev_market</span><span class="o">.</span><span class="n">inplay</span> <span class="o">!=</span> <span class="n">market_book</span><span class="o">.</span><span class="n">inplay</span><span class="p">:</span>
<a id="__codelineno-8-25" name="__codelineno-8-25" href="#__codelineno-8-25"></a>                    <span class="n">preplay_market</span> <span class="o">=</span> <span class="n">market_book</span>
<a id="__codelineno-8-26" name="__codelineno-8-26" href="#__codelineno-8-26"></a>
<a id="__codelineno-8-27" name="__codelineno-8-27" href="#__codelineno-8-27"></a>                <span class="c1"># final market view before market goes is closed for settlement</span>
<a id="__codelineno-8-28" name="__codelineno-8-28" href="#__codelineno-8-28"></a>                <span class="k">if</span> <span class="n">prev_market</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">prev_market</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;OPEN&quot;</span> <span class="ow">and</span> <span class="n">market_book</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="n">prev_market</span><span class="o">.</span><span class="n">status</span><span class="p">:</span>
<a id="__codelineno-8-29" name="__codelineno-8-29" href="#__codelineno-8-29"></a>                    <span class="n">postplay_market</span> <span class="o">=</span> <span class="n">market_book</span>
<a id="__codelineno-8-30" name="__codelineno-8-30" href="#__codelineno-8-30"></a>
<a id="__codelineno-8-31" name="__codelineno-8-31" href="#__codelineno-8-31"></a>                <span class="c1"># Calculate Seconds Till Scheduled Market Start Time</span>
<a id="__codelineno-8-32" name="__codelineno-8-32" href="#__codelineno-8-32"></a>                <span class="n">seconds_to_start</span> <span class="o">=</span> <span class="p">(</span><span class="n">market_book</span><span class="o">.</span><span class="n">market_definition</span><span class="o">.</span><span class="n">market_time</span> <span class="o">-</span> <span class="n">market_book</span><span class="o">.</span><span class="n">publish_time</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
<a id="__codelineno-8-33" name="__codelineno-8-33" href="#__codelineno-8-33"></a>
<a id="__codelineno-8-34" name="__codelineno-8-34" href="#__codelineno-8-34"></a>                <span class="c1"># Market at 3 mins before scheduled off</span>
<a id="__codelineno-8-35" name="__codelineno-8-35" href="#__codelineno-8-35"></a>                <span class="k">if</span> <span class="n">t3m_market</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">seconds_to_start</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="o">*</span><span class="mi">60</span><span class="p">:</span>
<a id="__codelineno-8-36" name="__codelineno-8-36" href="#__codelineno-8-36"></a>                    <span class="n">t3m_market</span> <span class="o">=</span> <span class="n">market_book</span>
<a id="__codelineno-8-37" name="__codelineno-8-37" href="#__codelineno-8-37"></a>
<a id="__codelineno-8-38" name="__codelineno-8-38" href="#__codelineno-8-38"></a>                <span class="c1"># update reference to previous market</span>
<a id="__codelineno-8-39" name="__codelineno-8-39" href="#__codelineno-8-39"></a>                <span class="n">prev_market</span> <span class="o">=</span> <span class="n">market_book</span>
<a id="__codelineno-8-40" name="__codelineno-8-40" href="#__codelineno-8-40"></a>
<a id="__codelineno-8-41" name="__codelineno-8-41" href="#__codelineno-8-41"></a>        <span class="c1"># If market didn&#39;t go inplay</span>
<a id="__codelineno-8-42" name="__codelineno-8-42" href="#__codelineno-8-42"></a>        <span class="k">if</span> <span class="n">postplay_market</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">preplay_market</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-8-43" name="__codelineno-8-43" href="#__codelineno-8-43"></a>            <span class="n">preplay_market</span> <span class="o">=</span> <span class="n">postplay_market</span>
<a id="__codelineno-8-44" name="__codelineno-8-44" href="#__codelineno-8-44"></a>
<a id="__codelineno-8-45" name="__codelineno-8-45" href="#__codelineno-8-45"></a>        <span class="k">return</span> <span class="p">(</span><span class="n">t3m_market</span><span class="p">,</span> <span class="n">preplay_market</span><span class="p">,</span> <span class="n">postplay_market</span><span class="p">,</span> <span class="n">prev_market</span><span class="p">)</span> <span class="c1"># Final market is last prev_market</span>
</code></pre></div>
<h4 id="3-4-summarise-those-useful-objects-and-write-to-csv">3 &amp; 4: Summarise those useful objects and write to .csv</h4>
<ul>
<li>This next chunk contains a wrapper function that will do all the execution</li>
<li>It will open a csv output file</li>
<li>Use the load_markets utility to iterate over the .tar files</li>
<li>Use <code>betfairlightweight</code> to instantiate the special stream object</li>
<li>Pass that stream object to the extract_components_from_stream which will scan across the market states and pull out 4 key market books</li>
<li>Convert those marketbooks into simple summary numbers or dictionaries that will be written to the output .csv file</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">run_stream_parsing</span><span class="p">():</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a>    <span class="c1"># Run Pipeline</span>
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;outputs/tho-odds.csv&quot;</span><span class="p">,</span> <span class="s2">&quot;w+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">output</span><span class="p">:</span>
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a>
<a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a>        <span class="c1"># Write Column Headers To File</span>
<a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a>        <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;market_id,event_date,country,track,market_name,selection_id,selection_name,result,bsp,ltp,matched_volume,atb_ladder_3m,atl_ladder_3m</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a>
<a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a>        <span class="k">for</span> <span class="n">file_obj</span> <span class="ow">in</span> <span class="n">load_markets</span><span class="p">(</span><span class="n">data_path</span><span class="p">):</span>
<a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a>
<a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a>            <span class="c1"># Instantiate a &quot;stream&quot; object</span>
<a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a>            <span class="n">stream</span> <span class="o">=</span> <span class="n">trading</span><span class="o">.</span><span class="n">streaming</span><span class="o">.</span><span class="n">create_historical_generator_stream</span><span class="p">(</span>
<a id="__codelineno-9-13" name="__codelineno-9-13" href="#__codelineno-9-13"></a>                <span class="n">file_path</span><span class="o">=</span><span class="n">file_obj</span><span class="p">,</span>
<a id="__codelineno-9-14" name="__codelineno-9-14" href="#__codelineno-9-14"></a>                <span class="n">listener</span><span class="o">=</span><span class="n">listener</span><span class="p">,</span>
<a id="__codelineno-9-15" name="__codelineno-9-15" href="#__codelineno-9-15"></a>            <span class="p">)</span>
<a id="__codelineno-9-16" name="__codelineno-9-16" href="#__codelineno-9-16"></a>
<a id="__codelineno-9-17" name="__codelineno-9-17" href="#__codelineno-9-17"></a>            <span class="c1"># Extract key components according to the custom function above (outputs 4 objects)</span>
<a id="__codelineno-9-18" name="__codelineno-9-18" href="#__codelineno-9-18"></a>            <span class="p">(</span><span class="n">t3m_market</span><span class="p">,</span> <span class="n">preplay_market</span><span class="p">,</span> <span class="n">postplay_market</span><span class="p">,</span> <span class="n">final_market</span><span class="p">)</span> <span class="o">=</span> <span class="n">extract_components_from_stream</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
<a id="__codelineno-9-19" name="__codelineno-9-19" href="#__codelineno-9-19"></a>
<a id="__codelineno-9-20" name="__codelineno-9-20" href="#__codelineno-9-20"></a>            <span class="c1"># If no price data for market don&#39;t write to file</span>
<a id="__codelineno-9-21" name="__codelineno-9-21" href="#__codelineno-9-21"></a>            <span class="k">if</span> <span class="n">postplay_market</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-9-22" name="__codelineno-9-22" href="#__codelineno-9-22"></a>                <span class="k">continue</span><span class="p">;</span> 
<a id="__codelineno-9-23" name="__codelineno-9-23" href="#__codelineno-9-23"></a>
<a id="__codelineno-9-24" name="__codelineno-9-24" href="#__codelineno-9-24"></a>            <span class="c1"># Runner metadata and key fields available from final market book</span>
<a id="__codelineno-9-25" name="__codelineno-9-25" href="#__codelineno-9-25"></a>            <span class="n">runner_data</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-9-26" name="__codelineno-9-26" href="#__codelineno-9-26"></a>                <span class="p">{</span>
<a id="__codelineno-9-27" name="__codelineno-9-27" href="#__codelineno-9-27"></a>                    <span class="s1">&#39;selection_id&#39;</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">selection_id</span><span class="p">,</span>
<a id="__codelineno-9-28" name="__codelineno-9-28" href="#__codelineno-9-28"></a>                    <span class="s1">&#39;selection_name&#39;</span><span class="p">:</span> <span class="nb">next</span><span class="p">((</span><span class="n">rd</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">rd</span> <span class="ow">in</span> <span class="n">final_market</span><span class="o">.</span><span class="n">market_definition</span><span class="o">.</span><span class="n">runners</span> <span class="k">if</span> <span class="n">rd</span><span class="o">.</span><span class="n">selection_id</span> <span class="o">==</span> <span class="n">r</span><span class="o">.</span><span class="n">selection_id</span><span class="p">),</span> <span class="kc">None</span><span class="p">),</span>
<a id="__codelineno-9-29" name="__codelineno-9-29" href="#__codelineno-9-29"></a>                    <span class="s1">&#39;selection_status&#39;</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
<a id="__codelineno-9-30" name="__codelineno-9-30" href="#__codelineno-9-30"></a>                    <span class="s1">&#39;sp&#39;</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">actual_sp</span>
<a id="__codelineno-9-31" name="__codelineno-9-31" href="#__codelineno-9-31"></a>                <span class="p">}</span>
<a id="__codelineno-9-32" name="__codelineno-9-32" href="#__codelineno-9-32"></a>                <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">final_market</span><span class="o">.</span><span class="n">runners</span> 
<a id="__codelineno-9-33" name="__codelineno-9-33" href="#__codelineno-9-33"></a>            <span class="p">]</span>
<a id="__codelineno-9-34" name="__codelineno-9-34" href="#__codelineno-9-34"></a>
<a id="__codelineno-9-35" name="__codelineno-9-35" href="#__codelineno-9-35"></a>            <span class="c1"># Last Traded Price</span>
<a id="__codelineno-9-36" name="__codelineno-9-36" href="#__codelineno-9-36"></a>            <span class="c1"># _____________________</span>
<a id="__codelineno-9-37" name="__codelineno-9-37" href="#__codelineno-9-37"></a>
<a id="__codelineno-9-38" name="__codelineno-9-38" href="#__codelineno-9-38"></a>            <span class="c1"># From the last marketbook before inplay or close</span>
<a id="__codelineno-9-39" name="__codelineno-9-39" href="#__codelineno-9-39"></a>            <span class="n">ltp</span> <span class="o">=</span> <span class="p">[</span><span class="n">runner</span><span class="o">.</span><span class="n">last_price_traded</span> <span class="k">for</span> <span class="n">runner</span> <span class="ow">in</span> <span class="n">preplay_market</span><span class="o">.</span><span class="n">runners</span><span class="p">]</span>
<a id="__codelineno-9-40" name="__codelineno-9-40" href="#__codelineno-9-40"></a>
<a id="__codelineno-9-41" name="__codelineno-9-41" href="#__codelineno-9-41"></a>            <span class="c1"># Total Matched Volume  </span>
<a id="__codelineno-9-42" name="__codelineno-9-42" href="#__codelineno-9-42"></a>            <span class="c1"># _____________________</span>
<a id="__codelineno-9-43" name="__codelineno-9-43" href="#__codelineno-9-43"></a>
<a id="__codelineno-9-44" name="__codelineno-9-44" href="#__codelineno-9-44"></a>            <span class="c1"># Calculates the traded volume across all traded price points for each selection</span>
<a id="__codelineno-9-45" name="__codelineno-9-45" href="#__codelineno-9-45"></a>            <span class="k">def</span><span class="w"> </span><span class="nf">ladder_traded_volume</span><span class="p">(</span><span class="n">ladder</span><span class="p">):</span>
<a id="__codelineno-9-46" name="__codelineno-9-46" href="#__codelineno-9-46"></a>                <span class="k">return</span><span class="p">(</span><span class="nb">sum</span><span class="p">([</span><span class="n">rung</span><span class="o">.</span><span class="n">size</span> <span class="k">for</span> <span class="n">rung</span> <span class="ow">in</span> <span class="n">ladder</span><span class="p">]))</span>
<a id="__codelineno-9-47" name="__codelineno-9-47" href="#__codelineno-9-47"></a>
<a id="__codelineno-9-48" name="__codelineno-9-48" href="#__codelineno-9-48"></a>            <span class="n">selection_traded_volume</span> <span class="o">=</span> <span class="p">[</span> <span class="n">ladder_traded_volume</span><span class="p">(</span><span class="n">runner</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">traded_volume</span><span class="p">)</span> <span class="k">for</span> <span class="n">runner</span> <span class="ow">in</span> <span class="n">postplay_market</span><span class="o">.</span><span class="n">runners</span> <span class="p">]</span>
<a id="__codelineno-9-49" name="__codelineno-9-49" href="#__codelineno-9-49"></a>
<a id="__codelineno-9-50" name="__codelineno-9-50" href="#__codelineno-9-50"></a>            <span class="c1"># Top 3 Ladder</span>
<a id="__codelineno-9-51" name="__codelineno-9-51" href="#__codelineno-9-51"></a>            <span class="c1"># ______________________</span>
<a id="__codelineno-9-52" name="__codelineno-9-52" href="#__codelineno-9-52"></a>
<a id="__codelineno-9-53" name="__codelineno-9-53" href="#__codelineno-9-53"></a>            <span class="c1"># Extracts the top 3 price / stakes in available orders on both back and lay sides. Returns python dictionaries</span>
<a id="__codelineno-9-54" name="__codelineno-9-54" href="#__codelineno-9-54"></a>
<a id="__codelineno-9-55" name="__codelineno-9-55" href="#__codelineno-9-55"></a>            <span class="k">def</span><span class="w"> </span><span class="nf">top_3_ladder</span><span class="p">(</span><span class="n">availableLadder</span><span class="p">):</span>
<a id="__codelineno-9-56" name="__codelineno-9-56" href="#__codelineno-9-56"></a>                <span class="n">out</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-9-57" name="__codelineno-9-57" href="#__codelineno-9-57"></a>                <span class="n">price</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-9-58" name="__codelineno-9-58" href="#__codelineno-9-58"></a>                <span class="n">volume</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-9-59" name="__codelineno-9-59" href="#__codelineno-9-59"></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">availableLadder</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-9-60" name="__codelineno-9-60" href="#__codelineno-9-60"></a>                    <span class="k">return</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>        
<a id="__codelineno-9-61" name="__codelineno-9-61" href="#__codelineno-9-61"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-9-62" name="__codelineno-9-62" href="#__codelineno-9-62"></a>                    <span class="k">for</span> <span class="n">rung</span> <span class="ow">in</span> <span class="n">availableLadder</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]:</span>
<a id="__codelineno-9-63" name="__codelineno-9-63" href="#__codelineno-9-63"></a>                        <span class="n">price</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rung</span><span class="o">.</span><span class="n">price</span><span class="p">)</span>
<a id="__codelineno-9-64" name="__codelineno-9-64" href="#__codelineno-9-64"></a>                        <span class="n">volume</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rung</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
<a id="__codelineno-9-65" name="__codelineno-9-65" href="#__codelineno-9-65"></a>                    <span class="n">out</span><span class="p">[</span><span class="s2">&quot;price&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">price</span>
<a id="__codelineno-9-66" name="__codelineno-9-66" href="#__codelineno-9-66"></a>                    <span class="n">out</span><span class="p">[</span><span class="s2">&quot;volume&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">volume</span>
<a id="__codelineno-9-67" name="__codelineno-9-67" href="#__codelineno-9-67"></a>                    <span class="k">return</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
<a id="__codelineno-9-68" name="__codelineno-9-68" href="#__codelineno-9-68"></a>
<a id="__codelineno-9-69" name="__codelineno-9-69" href="#__codelineno-9-69"></a>            <span class="c1"># Sometimes t-3 mins market book is empty</span>
<a id="__codelineno-9-70" name="__codelineno-9-70" href="#__codelineno-9-70"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-9-71" name="__codelineno-9-71" href="#__codelineno-9-71"></a>                <span class="n">atb_ladder_3m</span> <span class="o">=</span> <span class="p">[</span> <span class="n">top_3_ladder</span><span class="p">(</span><span class="n">runner</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">available_to_back</span><span class="p">)</span> <span class="k">for</span> <span class="n">runner</span> <span class="ow">in</span> <span class="n">t3m_market</span><span class="o">.</span><span class="n">runners</span><span class="p">]</span>
<a id="__codelineno-9-72" name="__codelineno-9-72" href="#__codelineno-9-72"></a>                <span class="n">atl_ladder_3m</span> <span class="o">=</span> <span class="p">[</span> <span class="n">top_3_ladder</span><span class="p">(</span><span class="n">runner</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">available_to_lay</span><span class="p">)</span> <span class="k">for</span> <span class="n">runner</span> <span class="ow">in</span> <span class="n">t3m_market</span><span class="o">.</span><span class="n">runners</span><span class="p">]</span>
<a id="__codelineno-9-73" name="__codelineno-9-73" href="#__codelineno-9-73"></a>            <span class="k">except</span><span class="p">:</span>
<a id="__codelineno-9-74" name="__codelineno-9-74" href="#__codelineno-9-74"></a>                <span class="n">atb_ladder_3m</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-9-75" name="__codelineno-9-75" href="#__codelineno-9-75"></a>                <span class="n">atl_ladder_3m</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-9-76" name="__codelineno-9-76" href="#__codelineno-9-76"></a>
<a id="__codelineno-9-77" name="__codelineno-9-77" href="#__codelineno-9-77"></a>            <span class="c1"># Writing To CSV</span>
<a id="__codelineno-9-78" name="__codelineno-9-78" href="#__codelineno-9-78"></a>            <span class="c1"># ______________________</span>
<a id="__codelineno-9-79" name="__codelineno-9-79" href="#__codelineno-9-79"></a>
<a id="__codelineno-9-80" name="__codelineno-9-80" href="#__codelineno-9-80"></a>            <span class="k">for</span> <span class="p">(</span><span class="n">runnerMeta</span><span class="p">,</span> <span class="n">ltp</span><span class="p">,</span> <span class="n">selection_traded_volume</span><span class="p">,</span> <span class="n">atb_ladder_3m</span><span class="p">,</span> <span class="n">atl_ladder_3m</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">runner_data</span><span class="p">,</span> <span class="n">ltp</span><span class="p">,</span> <span class="n">selection_traded_volume</span><span class="p">,</span> <span class="n">atb_ladder_3m</span><span class="p">,</span> <span class="n">atl_ladder_3m</span><span class="p">):</span>
<a id="__codelineno-9-81" name="__codelineno-9-81" href="#__codelineno-9-81"></a>
<a id="__codelineno-9-82" name="__codelineno-9-82" href="#__codelineno-9-82"></a>                <span class="k">if</span> <span class="n">runnerMeta</span><span class="p">[</span><span class="s1">&#39;selection_status&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;REMOVED&#39;</span><span class="p">:</span>
<a id="__codelineno-9-83" name="__codelineno-9-83" href="#__codelineno-9-83"></a>
<a id="__codelineno-9-84" name="__codelineno-9-84" href="#__codelineno-9-84"></a>                    <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
<a id="__codelineno-9-85" name="__codelineno-9-85" href="#__codelineno-9-85"></a>                        <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
<a id="__codelineno-9-86" name="__codelineno-9-86" href="#__codelineno-9-86"></a>                            <span class="nb">str</span><span class="p">(</span><span class="n">final_market</span><span class="o">.</span><span class="n">market_id</span><span class="p">),</span>
<a id="__codelineno-9-87" name="__codelineno-9-87" href="#__codelineno-9-87"></a>                            <span class="n">final_market</span><span class="o">.</span><span class="n">market_definition</span><span class="o">.</span><span class="n">market_time</span><span class="p">,</span>
<a id="__codelineno-9-88" name="__codelineno-9-88" href="#__codelineno-9-88"></a>                            <span class="n">final_market</span><span class="o">.</span><span class="n">market_definition</span><span class="o">.</span><span class="n">country_code</span><span class="p">,</span>
<a id="__codelineno-9-89" name="__codelineno-9-89" href="#__codelineno-9-89"></a>                            <span class="n">final_market</span><span class="o">.</span><span class="n">market_definition</span><span class="o">.</span><span class="n">venue</span><span class="p">,</span>
<a id="__codelineno-9-90" name="__codelineno-9-90" href="#__codelineno-9-90"></a>                            <span class="n">final_market</span><span class="o">.</span><span class="n">market_definition</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-9-91" name="__codelineno-9-91" href="#__codelineno-9-91"></a>                            <span class="n">runnerMeta</span><span class="p">[</span><span class="s1">&#39;selection_id&#39;</span><span class="p">],</span>
<a id="__codelineno-9-92" name="__codelineno-9-92" href="#__codelineno-9-92"></a>                            <span class="n">runnerMeta</span><span class="p">[</span><span class="s1">&#39;selection_name&#39;</span><span class="p">],</span>
<a id="__codelineno-9-93" name="__codelineno-9-93" href="#__codelineno-9-93"></a>                            <span class="n">runnerMeta</span><span class="p">[</span><span class="s1">&#39;selection_status&#39;</span><span class="p">],</span>
<a id="__codelineno-9-94" name="__codelineno-9-94" href="#__codelineno-9-94"></a>                            <span class="n">runnerMeta</span><span class="p">[</span><span class="s1">&#39;sp&#39;</span><span class="p">],</span>
<a id="__codelineno-9-95" name="__codelineno-9-95" href="#__codelineno-9-95"></a>                            <span class="n">ltp</span><span class="p">,</span>
<a id="__codelineno-9-96" name="__codelineno-9-96" href="#__codelineno-9-96"></a>                            <span class="n">selection_traded_volume</span><span class="p">,</span>
<a id="__codelineno-9-97" name="__codelineno-9-97" href="#__codelineno-9-97"></a>                            <span class="s1">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">atb_ladder_3m</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="c1"># Forcing the dictionaries to strings so we don&#39;t run into issues loading the csvs with the dictionary commas</span>
<a id="__codelineno-9-98" name="__codelineno-9-98" href="#__codelineno-9-98"></a>                            <span class="s1">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">atl_ladder_3m</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span>
<a id="__codelineno-9-99" name="__codelineno-9-99" href="#__codelineno-9-99"></a>                        <span class="p">)</span>
<a id="__codelineno-9-100" name="__codelineno-9-100" href="#__codelineno-9-100"></a>                    <span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="c1"># This will execute the files (it took me ~2 hours for 2 months of data)</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="c1">#run_stream_parsing()</span>
</code></pre></div>
<hr />
<h3 id="extending-this-code">Extending this code</h3>
<ul>
<li>Because this process is very slow you might want to save much more information than you think you need</li>
<li>For example I currently think I only want the best back and lay prices at t-3 mins before the off but I've saved the top 3 boxes in the available to back and lay ladders as dictionary strings</li>
<li>From these ladders I can retroactively calculate not only just the best back and lay prices but also WAP prices and also sizes at those boxes which I could use for much more accurate backtesting if I wanted to later without having to scan across the entire stream files again</li>
<li>I could easily save the entire open and traded orders ladders in the same way amongst many other ways of retaining more of the data for post-processing analysis</li>
</ul>
<p><img alt="Stream Ladder Columns" src="../img/ladderColumns.png" /></p>
<hr />
<h2 id="backtesting-analysis">Backtesting Analysis</h2>
<p>Let's take stock of where we are. We currently have model ratings (about 1.5 months worth) and Betfair Odds (2 months worth).</p>
<p>Circling back to the original backtesting context we needed to solve for 2 key questions:</p>
<ol>
<li>What would my predicted chance have been exactly for this selection in this market on this day in the past?</li>
<li>What would have I decided to bet at what odds (exactly) and for how much stake (exactly) based on this prediction?</li>
</ol>
<p>Backtesting with someone else's publicly available and historically logged ratings solves question 1. With these particular ratings we're fine but generally we should just be aware there are some sketchy services that might make retroactive adjustments to historical ratings to juice their performance which obviously violates 1.</p>
<p>For the second part we now have several real Betfair odds values to combine with the ratings and some chosen staking formula to simulate actual bets. I won't dwell too much on the stake size component but it's important.</p>
<p>Similarly we aren't out of the woods with the "what odds exactly" question either. I'll show performance of backtesting at the "Last Traded Price" however, there's literally no way of actually being the last bet matched order on every exchange market so there's some uncertainty in a few of these prices.</p>
<p>Further, and from experience, if you placing bets at the BSP and you're using some form of proportional staking (like Kelly) then you're calculated stake size will need to include a quantity (the BSP) which you will literally never be 100% sure of. You'll need to estimate the BSP as close to market suspension as you can and place your BSP bets with a stake sized derived from that estimation. This imprecision in stake calculation WILL cost you some profit relative to your backtested expectation.</p>
<p>These might seem like minor considerations but you should be aware of some of the gory details of the many ways becoming successful on Betfair is really difficult. To be reliably profitable on Betfair you don't just need a good model, you'll likely need to spend hours and hours thinking about these things: testing things, ironing out all these little kinks and trying to account for all your uncertainties. I'll just be running over the skeleton of what you should do.</p>
<hr />
<h3 id="setting-up-your-master-data">Setting up your master data</h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="c1"># First we&#39;ll load and tidy our odds data</span>
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="c1"># Load in odds file we created above</span>
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="n">bfOdds</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;outputs/tho-odds.csv&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;market_id&#39;</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="s1">&#39;selection_id&#39;</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="s1">&#39;atb_ladder_3m&#39;</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="s1">&#39;atl_ladder_3m&#39;</span><span class="p">:</span> <span class="nb">object</span><span class="p">})</span>
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a>
<a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a><span class="c1"># Convert dictionary columns</span>
<a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a><span class="kn">import</span><span class="w"> </span><span class="nn">ast</span>
<a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a><span class="n">bfOdds</span><span class="p">[</span><span class="s1">&#39;atb_ladder_3m&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">bfOdds</span><span class="p">[</span><span class="s1">&#39;atb_ladder_3m&#39;</span><span class="p">]]</span>
<a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a><span class="n">bfOdds</span><span class="p">[</span><span class="s1">&#39;atl_ladder_3m&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">bfOdds</span><span class="p">[</span><span class="s1">&#39;atl_ladder_3m&#39;</span><span class="p">]]</span>
<a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a>
<a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a><span class="c1"># Convert LTP to Numeric</span>
<a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a><span class="n">bfOdds</span><span class="p">[</span><span class="s1">&#39;ltp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">bfOdds</span><span class="p">[</span><span class="s1">&#39;ltp&#39;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;coerce&#39;</span><span class="p">)</span>
<a id="__codelineno-11-13" name="__codelineno-11-13" href="#__codelineno-11-13"></a>
<a id="__codelineno-11-14" name="__codelineno-11-14" href="#__codelineno-11-14"></a><span class="c1"># Filter after 18th Feb</span>
<a id="__codelineno-11-15" name="__codelineno-11-15" href="#__codelineno-11-15"></a><span class="n">bfOdds</span> <span class="o">=</span> <span class="n">bfOdds</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;event_date &gt;= &quot;2021-02-18&quot;&#39;</span><span class="p">)</span>
<a id="__codelineno-11-16" name="__codelineno-11-16" href="#__codelineno-11-16"></a>
<a id="__codelineno-11-17" name="__codelineno-11-17" href="#__codelineno-11-17"></a><span class="n">bfOdds</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</code></pre></div>
<table>
<thead>
<tr>
<th>market_id</th>
<th>event_date</th>
<th>country</th>
<th>track</th>
<th>market_name</th>
<th>selection_id</th>
<th>selection_name</th>
<th>result</th>
<th>bsp</th>
<th>ltp</th>
<th>matched_volume</th>
<th>atb_ladder_3m</th>
<th>atl_ladder_3m</th>
</tr>
</thead>
<tbody>
<tr>
<td>1.179776179</td>
<td>2021-02-27 10:48:00</td>
<td>AU</td>
<td>Toowoomba</td>
<td>R7 1000m Mdn</td>
<td>31552374</td>
<td>2. Chubascos</td>
<td>LOSER</td>
<td>5.84</td>
<td>5.9</td>
<td>7390.59</td>
<td>{'price': [6, 5.9, 5.8], 'volume': [30.99, 82....</td>
<td>{'price': [6.2, 6.4, 6.6], 'volume': [4.99, 22...</td>
</tr>
<tr>
<td>1.179776179</td>
<td>2021-02-27 10:48:00</td>
<td>AU</td>
<td>Toowoomba</td>
<td>R7 1000m Mdn</td>
<td>38620171</td>
<td>3. Love You More</td>
<td>LOSER</td>
<td>65.00</td>
<td>70.0</td>
<td>1297.27</td>
<td>{'price': [65, 60, 55], 'volume': [2, 2.9, 15....</td>
<td>{'price': [75, 80, 85], 'volume': [0.66, 3.24,...</td>
</tr>
<tr>
<td>1.179776179</td>
<td>2021-02-27 10:48:00</td>
<td>AU</td>
<td>Toowoomba</td>
<td>R7 1000m Mdn</td>
<td>38620172</td>
<td>4. Splashing Rossa</td>
<td>LOSER</td>
<td>10.98</td>
<td>10.5</td>
<td>2665.94</td>
<td>{'price': [9, 8.8, 8.6], 'volume': [21.92, 10....</td>
<td>{'price': [9.6, 9.8, 10], 'volume': [13.43, 7....</td>
</tr>
<tr>
<td>1.179776179</td>
<td>2021-02-27 10:48:00</td>
<td>AU</td>
<td>Toowoomba</td>
<td>R7 1000m Mdn</td>
<td>38620173</td>
<td>5. The Fairytale</td>
<td>LOSER</td>
<td>54.56</td>
<td>50.0</td>
<td>221.13</td>
<td>{'price': [55, 50, 48], 'volume': [4.85, 2.85,...</td>
<td>{'price': [65, 70, 75], 'volume': [2.1, 7.18, ...</td>
</tr>
<tr>
<td>1.179776179</td>
<td>2021-02-27 10:48:00</td>
<td>AU</td>
<td>Toowoomba</td>
<td>R7 1000m Mdn</td>
<td>38620174</td>
<td>6. My Boy Dragon</td>
<td>LOSER</td>
<td>166.90</td>
<td>160.0</td>
<td>199.00</td>
<td>{'price': [140, 120, 110], 'volume': [0.36, 1....</td>
<td>{'price': [260, 270, 340], 'volume': [1.29, 2....</td>
</tr>
</tbody>
</table>
<p>When backtesting, and developing wagering systems more generally, I've found it really helpful to have a set of standard patterns or ways of representing common datasets. For a task like this it's really helpful to keep everything joined and together in a wide table.</p>
<p>So we want a dataframe with everything we need to conduct the backtest: your model ratings, the odds you're betting at, the results on the bets, and ultimately betting logic will all become columns in a dataframe.</p>
<p>It's helpful to have consistent column names so that the code for any new test you run looks much like previous tests and you can leverage custom functions that can be reused across tests and other projects. I like to have the following columns in my backtesting dataframe:</p>
<ul>
<li>date</li>
<li>market_id (can be a surrogate id if dealing with fixed odds markets)</li>
<li>selection_id (could be selection name)</li>
<li>win (a binary win loss)</li>
<li>model_odds</li>
<li>model_prob</li>
<li>market_odds</li>
<li>market_prob</li>
<li>bet_side</li>
<li>stake</li>
<li>gpl</li>
<li>commission</li>
<li>npl</li>
</ul>
<p>This analysis will be a little more complex as we're considering different price points so I'll leave out the <code>market_odds</code> and <code>market_prob</code> columns.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="c1"># Joining the ratings data and odds data and combining</span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="n">rawDF</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a>        <span class="n">hubRatings</span><span class="p">[</span><span class="n">hubRatings</span><span class="p">[</span><span class="s1">&#39;market_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">bfOdds</span><span class="o">.</span><span class="n">market_id</span><span class="o">.</span><span class="n">unique</span><span class="p">())],</span> 
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a>        <span class="n">bfOdds</span><span class="p">[[</span><span class="s1">&#39;market_name&#39;</span><span class="p">,</span> <span class="s1">&#39;market_id&#39;</span><span class="p">,</span> <span class="s1">&#39;selection_id&#39;</span><span class="p">,</span> <span class="s1">&#39;result&#39;</span><span class="p">,</span> <span class="s1">&#39;matched_volume&#39;</span><span class="p">,</span> <span class="s1">&#39;bsp&#39;</span><span class="p">,</span> <span class="s1">&#39;ltp&#39;</span><span class="p">,</span> <span class="s1">&#39;atb_ladder_3m&#39;</span><span class="p">,</span> <span class="s1">&#39;atl_ladder_3m&#39;</span><span class="p">]],</span>
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a>        <span class="n">on</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;market_id&#39;</span><span class="p">,</span> <span class="s1">&#39;selection_id&#39;</span><span class="p">],</span>
<a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a>        <span class="n">how</span> <span class="o">=</span> <span class="s1">&#39;inner&#39;</span>
<a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a>    <span class="p">)</span>
<a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a>
<a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a><span class="n">rawDF</span>
</code></pre></div>
<table>
<thead>
<tr>
<th>date</th>
<th>track</th>
<th>race_number</th>
<th>race_name</th>
<th>market_id</th>
<th>selection_id</th>
<th>selection_name</th>
<th>model_odds</th>
<th>market_name</th>
<th>result</th>
<th>matched_volume</th>
<th>bsp</th>
<th>ltp</th>
<th>atb_ladder_3m</th>
<th>atl_ladder_3m</th>
</tr>
</thead>
<tbody>
<tr>
<td>2021-02-18</td>
<td>DOOMBEN</td>
<td>1</td>
<td>R1 1200m 3yo</td>
<td>1.179418181</td>
<td>38523320</td>
<td>11. Vast Kama</td>
<td>34.28</td>
<td>R1 1200m 3yo</td>
<td>LOSER</td>
<td>1934.49</td>
<td>42.00</td>
<td>42.0</td>
<td>{'price': [30, 29, 28], 'volume': [4.01, 6.15,...</td>
<td>{'price': [32, 34, 36], 'volume': [1.76, 27.55...</td>
</tr>
<tr>
<td>2021-02-18</td>
<td>DOOMBEN</td>
<td>1</td>
<td>R1 1200m 3yo</td>
<td>1.179418181</td>
<td>38523319</td>
<td>10. Triptonic</td>
<td>21.22</td>
<td>R1 1200m 3yo</td>
<td>LOSER</td>
<td>1710.76</td>
<td>23.87</td>
<td>23.0</td>
<td>{'price': [30, 29, 28], 'volume': [24.72, 2.99...</td>
<td>{'price': [32, 34, 36], 'volume': [0.4, 5.87, ...</td>
</tr>
<tr>
<td>2021-02-18</td>
<td>DOOMBEN</td>
<td>1</td>
<td>R1 1200m 3yo</td>
<td>1.179418181</td>
<td>35773035</td>
<td>9. Right Reason</td>
<td>10.23</td>
<td>R1 1200m 3yo</td>
<td>LOSER</td>
<td>5524.11</td>
<td>12.50</td>
<td>11.5</td>
<td>{'price': [9.4, 9.2, 9], 'volume': [6.22, 15.1...</td>
<td>{'price': [9.6, 9.8, 10], 'volume': [11.19, 0....</td>
</tr>
<tr>
<td>2021-02-18</td>
<td>DOOMBEN</td>
<td>1</td>
<td>R1 1200m 3yo</td>
<td>1.179418181</td>
<td>38523318</td>
<td>8. Off Road</td>
<td>40.75</td>
<td>R1 1200m 3yo</td>
<td>LOSER</td>
<td>1506.51</td>
<td>35.31</td>
<td>34.0</td>
<td>{'price': [30, 29, 28], 'volume': [5.52, 3.61,...</td>
<td>{'price': [36, 38, 40], 'volume': [6.37, 3.87,...</td>
</tr>
<tr>
<td>2021-02-18</td>
<td>DOOMBEN</td>
<td>1</td>
<td>R1 1200m 3yo</td>
<td>1.179418181</td>
<td>38523317</td>
<td>7. More Than Value</td>
<td>77.49</td>
<td>R1 1200m 3yo</td>
<td>LOSER</td>
<td>617.18</td>
<td>55.00</td>
<td>55.0</td>
<td>{'price': [65, 60, 55], 'volume': [0.26, 4, 8....</td>
<td>{'price': [70, 75, 80], 'volume': [0.67, 3.68,...</td>
</tr>
<tr>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr>
<td>2021-03-31</td>
<td>WARWICK FARM</td>
<td>8</td>
<td>R8 1300m Hcap</td>
<td>1.181250426</td>
<td>28092381</td>
<td>11. Born A Warrior</td>
<td>10.67</td>
<td>R8 1300m Hcap</td>
<td>LOSER</td>
<td>905.55</td>
<td>6.97</td>
<td>6.2</td>
<td>{'price': [6.2, 5.8, 5.1], 'volume': [7.98, 40...</td>
<td>{'price': [6.8, 7, 7.8], 'volume': [6.26, 41.5...</td>
</tr>
<tr>
<td>2021-03-31</td>
<td>WARWICK FARM</td>
<td>8</td>
<td>R8 1300m Hcap</td>
<td>1.181250426</td>
<td>38698010</td>
<td>12. Diva Bella</td>
<td>25.77</td>
<td>R8 1300m Hcap</td>
<td>LOSER</td>
<td>11.06</td>
<td>23.60</td>
<td>18.5</td>
<td>{'price': [23, 22, 18], 'volume': [0.31, 24.91...</td>
<td>{'price': [70, 75, 95], 'volume': [0.61, 3.5, ...</td>
</tr>
<tr>
<td>2021-03-31</td>
<td>WARWICK FARM</td>
<td>8</td>
<td>R8 1300m Hcap</td>
<td>1.181250426</td>
<td>28224034</td>
<td>13. Twice As Special</td>
<td>51.23</td>
<td>R8 1300m Hcap</td>
<td>LOSER</td>
<td>52.49</td>
<td>36.37</td>
<td>26.0</td>
<td>{'price': [30, 29, 26], 'volume': [13.84, 5.92...</td>
<td>{'price': [44, 50, 95], 'volume': [2.76, 1.66,...</td>
</tr>
<tr>
<td>2021-03-31</td>
<td>WARWICK FARM</td>
<td>8</td>
<td>R8 1300m Hcap</td>
<td>1.181250426</td>
<td>38913296</td>
<td>15. Rosie Riveter</td>
<td>24.92</td>
<td>R8 1300m Hcap</td>
<td>LOSER</td>
<td>58.65</td>
<td>9.72</td>
<td>11.0</td>
<td>{'price': [10.5, 10, 9.6], 'volume': [0.69, 28...</td>
<td>{'price': [11, 12.5, 19], 'volume': [3.87, 2.7...</td>
</tr>
<tr>
<td>2021-03-31</td>
<td>WARWICK FARM</td>
<td>8</td>
<td>R8 1300m Hcap</td>
<td>1.181250426</td>
<td>4973624</td>
<td>8. Celer</td>
<td>26.23</td>
<td>R8 1300m Hcap</td>
<td>LOSER</td>
<td>22.14</td>
<td>21.73</td>
<td>28.0</td>
<td>{'price': [24, 23, 20], 'volume': [1.55, 18.26...</td>
<td>{'price': [30, 65, 70], 'volume': [0.55, 1.55,...</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="n">df</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a>    <span class="n">rawDF</span>
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a>    <span class="c1"># Extra Best Back + Lay 3 mins before of</span>
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a>    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">best_back_3m</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;price&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;price&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;atb_ladder_3m&#39;</span><span class="p">]])</span>
<a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a>    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">best_lay_3m</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;price&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;price&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;atl_ladder_3m&#39;</span><span class="p">]])</span>
<a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a>    <span class="c1"># Coalesce LTP to BSP (about 60 rows)</span>
<a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a>    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">ltp</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;ltp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">(),</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;bsp&quot;</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;ltp&quot;</span><span class="p">]))</span>
<a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a>    <span class="c1"># Add a binary win / loss column</span>
<a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a>    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">win</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;WINNER&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
<a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a>    <span class="c1"># Extra columns</span>
<a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a>    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">model_prob</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;model_odds&#39;</span><span class="p">])</span>
<a id="__codelineno-13-12" name="__codelineno-13-12" href="#__codelineno-13-12"></a>    <span class="c1"># Reorder Columns</span>
<a id="__codelineno-13-13" name="__codelineno-13-13" href="#__codelineno-13-13"></a>    <span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;track&#39;</span><span class="p">,</span> <span class="s1">&#39;race_number&#39;</span><span class="p">,</span> <span class="s1">&#39;market_id&#39;</span><span class="p">,</span> <span class="s1">&#39;selection_id&#39;</span><span class="p">,</span> <span class="s1">&#39;bsp&#39;</span><span class="p">,</span> <span class="s1">&#39;ltp&#39;</span><span class="p">,</span><span class="s1">&#39;best_back_3m&#39;</span><span class="p">,</span><span class="s1">&#39;best_lay_3m&#39;</span><span class="p">,</span><span class="s1">&#39;atb_ladder_3m&#39;</span><span class="p">,</span> <span class="s1">&#39;atl_ladder_3m&#39;</span><span class="p">,</span> <span class="s1">&#39;model_prob&#39;</span><span class="p">,</span> <span class="s1">&#39;model_odds&#39;</span><span class="p">,</span> <span class="s1">&#39;win&#39;</span><span class="p">])</span>
<a id="__codelineno-13-14" name="__codelineno-13-14" href="#__codelineno-13-14"></a>
<a id="__codelineno-13-15" name="__codelineno-13-15" href="#__codelineno-13-15"></a><span class="p">)</span>
<a id="__codelineno-13-16" name="__codelineno-13-16" href="#__codelineno-13-16"></a>
<a id="__codelineno-13-17" name="__codelineno-13-17" href="#__codelineno-13-17"></a><span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</code></pre></div>
<table>
<thead>
<tr>
<th>date</th>
<th>track</th>
<th>race_number</th>
<th>market_id</th>
<th>selection_id</th>
<th>bsp</th>
<th>ltp</th>
<th>best_back_3m</th>
<th>best_lay_3m</th>
<th>atb_ladder_3m</th>
<th>atl_ladder_3m</th>
<th>model_prob</th>
<th>model_odds</th>
<th>win</th>
</tr>
</thead>
<tbody>
<tr>
<td>2021-02-18</td>
<td>DOOMBEN</td>
<td>1</td>
<td>1.179418181</td>
<td>38523320</td>
<td>42.00</td>
<td>42.0</td>
<td>30.0</td>
<td>32.0</td>
<td>{'price': [30, 29, 28], 'volume': [4.01, 6.15,...</td>
<td>{'price': [32, 34, 36], 'volume': [1.76, 27.55...</td>
<td>0.029172</td>
<td>34.28</td>
<td>0</td>
</tr>
<tr>
<td>2021-02-18</td>
<td>DOOMBEN</td>
<td>1</td>
<td>1.179418181</td>
<td>38523319</td>
<td>23.87</td>
<td>23.0</td>
<td>30.0</td>
<td>32.0</td>
<td>{'price': [30, 29, 28], 'volume': [24.72, 2.99...</td>
<td>{'price': [32, 34, 36], 'volume': [0.4, 5.87, ...</td>
<td>0.047125</td>
<td>21.22</td>
<td>0</td>
</tr>
<tr>
<td>2021-02-18</td>
<td>DOOMBEN</td>
<td>1</td>
<td>1.179418181</td>
<td>35773035</td>
<td>12.50</td>
<td>11.5</td>
<td>9.4</td>
<td>9.6</td>
<td>{'price': [9.4, 9.2, 9], 'volume': [6.22, 15.1...</td>
<td>{'price': [9.6, 9.8, 10], 'volume': [11.19, 0....</td>
<td>0.097752</td>
<td>10.23</td>
<td>0</td>
</tr>
<tr>
<td>2021-02-18</td>
<td>DOOMBEN</td>
<td>1</td>
<td>1.179418181</td>
<td>38523318</td>
<td>35.31</td>
<td>34.0</td>
<td>30.0</td>
<td>36.0</td>
<td>{'price': [30, 29, 28], 'volume': [5.52, 3.61,...</td>
<td>{'price': [36, 38, 40], 'volume': [6.37, 3.87,...</td>
<td>0.024540</td>
<td>40.75</td>
<td>0</td>
</tr>
<tr>
<td>2021-02-18</td>
<td>DOOMBEN</td>
<td>1</td>
<td>1.179418181</td>
<td>38523317</td>
<td>55.00</td>
<td>55.0</td>
<td>65.0</td>
<td>70.0</td>
<td>{'price': [65, 60, 55], 'volume': [0.26, 4, 8....</td>
<td>{'price': [70, 75, 80], 'volume': [0.67, 3.68,...</td>
<td>0.012905</td>
<td>77.49</td>
<td>0</td>
</tr>
</tbody>
</table>
<hr />
<h3 id="staking-outcome-functions">Staking + Outcome Functions</h3>
<p>Now we can create a set of standard staking functions that a dataframe with an expected set of columns and add staking and bet outcome fields.</p>
<p>We'll also add the ability of these functions to reference a different odds column so that we can backtest against our different price points.</p>
<p>For simplicity we'll assume you're paying 5% commission on winnings however it could be higher or lower and depends on the MBR of the market.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">bet_apply_commission</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">com</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">):</span>
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a>
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a>    <span class="c1"># Total Market GPL</span>
<a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a>    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;market_gpl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;market_id&#39;</span><span class="p">)[</span><span class="s1">&#39;gpl&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="nb">sum</span><span class="p">)</span>
<a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a>
<a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a>    <span class="c1"># Apply 5% commission</span>
<a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a>    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;market_commission&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;market_gpl&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;market_gpl&#39;</span><span class="p">])</span>
<a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a>
<a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a>    <span class="c1"># Sum of Market Winning Bets</span>
<a id="__codelineno-14-10" name="__codelineno-14-10" href="#__codelineno-14-10"></a>    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;floored_gpl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;gpl&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;gpl&#39;</span><span class="p">])</span>
<a id="__codelineno-14-11" name="__codelineno-14-11" href="#__codelineno-14-11"></a>    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;market_netwinnings&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;market_id&#39;</span><span class="p">)[</span><span class="s1">&#39;floored_gpl&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="nb">sum</span><span class="p">)</span>
<a id="__codelineno-14-12" name="__codelineno-14-12" href="#__codelineno-14-12"></a>
<a id="__codelineno-14-13" name="__codelineno-14-13" href="#__codelineno-14-13"></a>    <span class="c1"># Partition Commission According to Selection GPL</span>
<a id="__codelineno-14-14" name="__codelineno-14-14" href="#__codelineno-14-14"></a>    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;commission&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;market_netwinnings&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;market_commission&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;floored_gpl&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;market_netwinnings&#39;</span><span class="p">]))</span>
<a id="__codelineno-14-15" name="__codelineno-14-15" href="#__codelineno-14-15"></a>
<a id="__codelineno-14-16" name="__codelineno-14-16" href="#__codelineno-14-16"></a>    <span class="c1"># Calculate Selection NPL</span>
<a id="__codelineno-14-17" name="__codelineno-14-17" href="#__codelineno-14-17"></a>    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;npl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;gpl&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;commission&#39;</span><span class="p">]</span>
<a id="__codelineno-14-18" name="__codelineno-14-18" href="#__codelineno-14-18"></a>
<a id="__codelineno-14-19" name="__codelineno-14-19" href="#__codelineno-14-19"></a>    <span class="c1"># Drop excess columns</span>
<a id="__codelineno-14-20" name="__codelineno-14-20" href="#__codelineno-14-20"></a>    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;floored_gpl&#39;</span><span class="p">,</span> <span class="s1">&#39;market_netwinnings&#39;</span><span class="p">,</span> <span class="s1">&#39;market_commission&#39;</span><span class="p">,</span> <span class="s1">&#39;market_gpl&#39;</span><span class="p">])</span>
<a id="__codelineno-14-21" name="__codelineno-14-21" href="#__codelineno-14-21"></a>
<a id="__codelineno-14-22" name="__codelineno-14-22" href="#__codelineno-14-22"></a>    <span class="k">return</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<a id="__codelineno-14-23" name="__codelineno-14-23" href="#__codelineno-14-23"></a>
<a id="__codelineno-14-24" name="__codelineno-14-24" href="#__codelineno-14-24"></a>
<a id="__codelineno-14-25" name="__codelineno-14-25" href="#__codelineno-14-25"></a><span class="k">def</span><span class="w"> </span><span class="nf">bet_flat</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">stake</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">back_odds</span> <span class="o">=</span> <span class="s1">&#39;market_odds&#39;</span><span class="p">,</span> <span class="n">lay_odds</span> <span class="o">=</span> <span class="s1">&#39;market_odds&#39;</span><span class="p">):</span>
<a id="__codelineno-14-26" name="__codelineno-14-26" href="#__codelineno-14-26"></a>
<a id="__codelineno-14-27" name="__codelineno-14-27" href="#__codelineno-14-27"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-14-28" name="__codelineno-14-28" href="#__codelineno-14-28"></a><span class="sd">    Betting DF should always contain: model_odds, and win (binary encoded), and the specified odds column columns</span>
<a id="__codelineno-14-29" name="__codelineno-14-29" href="#__codelineno-14-29"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-14-30" name="__codelineno-14-30" href="#__codelineno-14-30"></a>
<a id="__codelineno-14-31" name="__codelineno-14-31" href="#__codelineno-14-31"></a>    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;bet_side&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;model_odds&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">df</span><span class="p">[</span><span class="n">back_odds</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;model_odds&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">df</span><span class="p">[</span><span class="n">lay_odds</span><span class="p">]),</span>
<a id="__codelineno-14-32" name="__codelineno-14-32" href="#__codelineno-14-32"></a>                        <span class="s2">&quot;P&quot;</span><span class="p">,</span> <span class="c1"># PUSH</span>
<a id="__codelineno-14-33" name="__codelineno-14-33" href="#__codelineno-14-33"></a>                       <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
<a id="__codelineno-14-34" name="__codelineno-14-34" href="#__codelineno-14-34"></a>                            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;model_odds&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">df</span><span class="p">[</span><span class="n">back_odds</span><span class="p">],</span>
<a id="__codelineno-14-35" name="__codelineno-14-35" href="#__codelineno-14-35"></a>                            <span class="s2">&quot;B&quot;</span><span class="p">,</span>
<a id="__codelineno-14-36" name="__codelineno-14-36" href="#__codelineno-14-36"></a>                            <span class="s2">&quot;L&quot;</span>
<a id="__codelineno-14-37" name="__codelineno-14-37" href="#__codelineno-14-37"></a>                        <span class="p">)</span>
<a id="__codelineno-14-38" name="__codelineno-14-38" href="#__codelineno-14-38"></a>                       <span class="p">)</span>
<a id="__codelineno-14-39" name="__codelineno-14-39" href="#__codelineno-14-39"></a>
<a id="__codelineno-14-40" name="__codelineno-14-40" href="#__codelineno-14-40"></a>    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;stake&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;bet_side&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;P&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">stake</span><span class="p">)</span>
<a id="__codelineno-14-41" name="__codelineno-14-41" href="#__codelineno-14-41"></a>
<a id="__codelineno-14-42" name="__codelineno-14-42" href="#__codelineno-14-42"></a>    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;gpl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;bet_side&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;B&quot;</span><span class="p">,</span> 
<a id="__codelineno-14-43" name="__codelineno-14-43" href="#__codelineno-14-43"></a>                         <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;win&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;stake&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">back_odds</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="o">-</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;stake&#39;</span><span class="p">]),</span> <span class="c1"># PL for back bets</span>
<a id="__codelineno-14-44" name="__codelineno-14-44" href="#__codelineno-14-44"></a>                         <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;win&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;stake&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">lay_odds</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;stake&#39;</span><span class="p">])</span> <span class="c1"># PL for lay bets</span>
<a id="__codelineno-14-45" name="__codelineno-14-45" href="#__codelineno-14-45"></a>                        <span class="p">)</span>   
<a id="__codelineno-14-46" name="__codelineno-14-46" href="#__codelineno-14-46"></a>
<a id="__codelineno-14-47" name="__codelineno-14-47" href="#__codelineno-14-47"></a>    <span class="c1"># Apply commission and NPL</span>
<a id="__codelineno-14-48" name="__codelineno-14-48" href="#__codelineno-14-48"></a>    <span class="n">df</span> <span class="o">=</span> <span class="n">bet_apply_commission</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<a id="__codelineno-14-49" name="__codelineno-14-49" href="#__codelineno-14-49"></a>
<a id="__codelineno-14-50" name="__codelineno-14-50" href="#__codelineno-14-50"></a>    <span class="k">return</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<a id="__codelineno-14-51" name="__codelineno-14-51" href="#__codelineno-14-51"></a>
<a id="__codelineno-14-52" name="__codelineno-14-52" href="#__codelineno-14-52"></a><span class="k">def</span><span class="w"> </span><span class="nf">bet_kelly</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">stake</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">back_odds</span> <span class="o">=</span> <span class="s1">&#39;market_odds&#39;</span><span class="p">,</span> <span class="n">lay_odds</span> <span class="o">=</span> <span class="s1">&#39;market_odds&#39;</span><span class="p">):</span>
<a id="__codelineno-14-53" name="__codelineno-14-53" href="#__codelineno-14-53"></a>
<a id="__codelineno-14-54" name="__codelineno-14-54" href="#__codelineno-14-54"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-14-55" name="__codelineno-14-55" href="#__codelineno-14-55"></a><span class="sd">    Betting DF should always contain: model_odds, and win (binary encoded), and the specified odds column columns</span>
<a id="__codelineno-14-56" name="__codelineno-14-56" href="#__codelineno-14-56"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-14-57" name="__codelineno-14-57" href="#__codelineno-14-57"></a>
<a id="__codelineno-14-58" name="__codelineno-14-58" href="#__codelineno-14-58"></a>    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;bet_side&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;model_odds&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">df</span><span class="p">[</span><span class="n">back_odds</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;model_odds&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">df</span><span class="p">[</span><span class="n">lay_odds</span><span class="p">]),</span>
<a id="__codelineno-14-59" name="__codelineno-14-59" href="#__codelineno-14-59"></a>                            <span class="s2">&quot;P&quot;</span><span class="p">,</span> <span class="c1"># PUSH</span>
<a id="__codelineno-14-60" name="__codelineno-14-60" href="#__codelineno-14-60"></a>                            <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
<a id="__codelineno-14-61" name="__codelineno-14-61" href="#__codelineno-14-61"></a>                                <span class="n">df</span><span class="p">[</span><span class="s2">&quot;model_odds&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">df</span><span class="p">[</span><span class="n">back_odds</span><span class="p">],</span>
<a id="__codelineno-14-62" name="__codelineno-14-62" href="#__codelineno-14-62"></a>                                <span class="s2">&quot;B&quot;</span><span class="p">,</span>
<a id="__codelineno-14-63" name="__codelineno-14-63" href="#__codelineno-14-63"></a>                                <span class="s2">&quot;L&quot;</span>
<a id="__codelineno-14-64" name="__codelineno-14-64" href="#__codelineno-14-64"></a>                            <span class="p">)</span>
<a id="__codelineno-14-65" name="__codelineno-14-65" href="#__codelineno-14-65"></a>                       <span class="p">)</span>
<a id="__codelineno-14-66" name="__codelineno-14-66" href="#__codelineno-14-66"></a>
<a id="__codelineno-14-67" name="__codelineno-14-67" href="#__codelineno-14-67"></a>    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;stake&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;bet_side&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;P&quot;</span><span class="p">,</span> <span class="c1"># PUSH</span>
<a id="__codelineno-14-68" name="__codelineno-14-68" href="#__codelineno-14-68"></a>                           <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-14-69" name="__codelineno-14-69" href="#__codelineno-14-69"></a>                           <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
<a id="__codelineno-14-70" name="__codelineno-14-70" href="#__codelineno-14-70"></a>                             <span class="n">df</span><span class="p">[</span><span class="s1">&#39;bet_side&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;B&quot;</span><span class="p">,</span>
<a id="__codelineno-14-71" name="__codelineno-14-71" href="#__codelineno-14-71"></a>                             <span class="p">(</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;model_odds&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="n">back_odds</span><span class="p">])</span> <span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="n">back_odds</span><span class="p">])),</span>
<a id="__codelineno-14-72" name="__codelineno-14-72" href="#__codelineno-14-72"></a>                             <span class="p">(</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="n">lay_odds</span><span class="p">])</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;model_odds&#39;</span><span class="p">])</span> <span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="n">lay_odds</span><span class="p">])),</span>
<a id="__codelineno-14-73" name="__codelineno-14-73" href="#__codelineno-14-73"></a>                           <span class="p">)</span>
<a id="__codelineno-14-74" name="__codelineno-14-74" href="#__codelineno-14-74"></a>                          <span class="p">)</span>
<a id="__codelineno-14-75" name="__codelineno-14-75" href="#__codelineno-14-75"></a>
<a id="__codelineno-14-76" name="__codelineno-14-76" href="#__codelineno-14-76"></a>    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;gpl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;bet_side&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;B&quot;</span><span class="p">,</span> 
<a id="__codelineno-14-77" name="__codelineno-14-77" href="#__codelineno-14-77"></a>                         <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;win&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;stake&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">back_odds</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="o">-</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;stake&#39;</span><span class="p">]),</span> <span class="c1"># PL for back bets</span>
<a id="__codelineno-14-78" name="__codelineno-14-78" href="#__codelineno-14-78"></a>                         <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;win&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;stake&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">lay_odds</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;stake&#39;</span><span class="p">])</span> <span class="c1"># PL for lay bets</span>
<a id="__codelineno-14-79" name="__codelineno-14-79" href="#__codelineno-14-79"></a>                        <span class="p">)</span>
<a id="__codelineno-14-80" name="__codelineno-14-80" href="#__codelineno-14-80"></a>
<a id="__codelineno-14-81" name="__codelineno-14-81" href="#__codelineno-14-81"></a>    <span class="c1"># Apply commission and NPL</span>
<a id="__codelineno-14-82" name="__codelineno-14-82" href="#__codelineno-14-82"></a>    <span class="n">df</span> <span class="o">=</span> <span class="n">bet_apply_commission</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<a id="__codelineno-14-83" name="__codelineno-14-83" href="#__codelineno-14-83"></a>
<a id="__codelineno-14-84" name="__codelineno-14-84" href="#__codelineno-14-84"></a>    <span class="k">return</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="c1"># Testing one of these functions</span>
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="n">flat_bets_bsp</span> <span class="o">=</span> <span class="n">bet_flat</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">stake</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">back_odds</span> <span class="o">=</span> <span class="s1">&#39;bsp&#39;</span><span class="p">,</span> <span class="n">lay_odds</span> <span class="o">=</span> <span class="s1">&#39;bsp&#39;</span><span class="p">)</span>
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a><span class="n">flat_bets_bsp</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</code></pre></div>
<table>
<thead>
<tr>
<th>date</th>
<th>track</th>
<th>race_number</th>
<th>market_id</th>
<th>selection_id</th>
<th>bsp</th>
<th>ltp</th>
<th>best_back_3m</th>
<th>best_lay_3m</th>
<th>atb_ladder_3m</th>
<th>atl_ladder_3m</th>
<th>model_prob</th>
<th>model_odds</th>
<th>win</th>
<th>bet_side</th>
<th>stake</th>
<th>gpl</th>
<th>commission</th>
<th>npl</th>
</tr>
</thead>
<tbody>
<tr>
<td>2021-02-18</td>
<td>DOOMBEN</td>
<td>1</td>
<td>1.179418181</td>
<td>38523320</td>
<td>42.00</td>
<td>42.0</td>
<td>30.0</td>
<td>32.0</td>
<td>{'price': [30, 29, 28], 'volume': [4.01, 6.15,...</td>
<td>{'price': [32, 34, 36], 'volume': [1.76, 27.55...</td>
<td>0.029172</td>
<td>34.28</td>
<td>0</td>
<td>B</td>
<td>1</td>
<td>-1.0</td>
<td>0.0</td>
<td>-1.0</td>
</tr>
<tr>
<td>2021-02-18</td>
<td>DOOMBEN</td>
<td>1</td>
<td>1.179418181</td>
<td>38523319</td>
<td>23.87</td>
<td>23.0</td>
<td>30.0</td>
<td>32.0</td>
<td>{'price': [30, 29, 28], 'volume': [24.72, 2.99...</td>
<td>{'price': [32, 34, 36], 'volume': [0.4, 5.87, ...</td>
<td>0.047125</td>
<td>21.22</td>
<td>0</td>
<td>B</td>
<td>1</td>
<td>-1.0</td>
<td>0.0</td>
<td>-1.0</td>
</tr>
<tr>
<td>2021-02-18</td>
<td>DOOMBEN</td>
<td>1</td>
<td>1.179418181</td>
<td>35773035</td>
<td>12.50</td>
<td>11.5</td>
<td>9.4</td>
<td>9.6</td>
<td>{'price': [9.4, 9.2, 9], 'volume': [6.22, 15.1...</td>
<td>{'price': [9.6, 9.8, 10], 'volume': [11.19, 0....</td>
<td>0.097752</td>
<td>10.23</td>
<td>0</td>
<td>B</td>
<td>1</td>
<td>-1.0</td>
<td>0.0</td>
<td>-1.0</td>
</tr>
<tr>
<td>2021-02-18</td>
<td>DOOMBEN</td>
<td>1</td>
<td>1.179418181</td>
<td>38523318</td>
<td>35.31</td>
<td>34.0</td>
<td>30.0</td>
<td>36.0</td>
<td>{'price': [30, 29, 28], 'volume': [5.52, 3.61,...</td>
<td>{'price': [36, 38, 40], 'volume': [6.37, 3.87,...</td>
<td>0.024540</td>
<td>40.75</td>
<td>0</td>
<td>L</td>
<td>1</td>
<td>1.0</td>
<td>0.0</td>
<td>1.0</td>
</tr>
<tr>
<td>2021-02-18</td>
<td>DOOMBEN</td>
<td>1</td>
<td>1.179418181</td>
<td>38523317</td>
<td>55.00</td>
<td>55.0</td>
<td>65.0</td>
<td>70.0</td>
<td>{'price': [65, 60, 55], 'volume': [0.26, 4, 8....</td>
<td>{'price': [70, 75, 80], 'volume': [0.67, 3.68,...</td>
<td>0.012905</td>
<td>77.49</td>
<td>0</td>
<td>L</td>
<td>1</td>
<td>1.0</td>
<td>0.0</td>
<td>1.0</td>
</tr>
</tbody>
</table>
<hr />
<h3 id="evaluation-functions">Evaluation Functions</h3>
<p>In my experience it's great to develop a suite of functions and analytical tools that really dig into every aspect of your simulated betting performance. You want to be as thorough and critical as possible, even when you're results are good.</p>
<p>Another tip to guide this process is to have a reasonable benchmark. Essentially no one wins at 10% POT on thoroughbreds at the BSP so if your analysis suggests you can... there's a bug. Similarly you almost certainly won't lose at more than &lt;-10%. Different sports and codes will have different realistic profitability ranges depending on the efficiency of the markets (will be roughly correlated to matched volume). Ruling out unreasonable results can save you a lot of time and delusion.</p>
<p>I'm keeping it pretty simple here but you might also want to create functions to analyse:</p>
<ul>
<li>Track / distance based performance</li>
<li>Performance across odds ranges</li>
<li>Profit volatility (maybe using sharpe ratio to optimise volatility - adjusted profit)</li>
<li>Date ranges (weeks / months etc)</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="c1"># Create simple PL and POT table</span>
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">bet_eval_metrics</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">side</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a>
<a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a>    <span class="k">if</span> <span class="n">side</span><span class="p">:</span>
<a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a>        <span class="n">metrics</span> <span class="o">=</span> <span class="p">(</span><span class="n">d</span>
<a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a>         <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;bet_side&#39;</span><span class="p">,</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a>         <span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s2">&quot;npl&quot;</span><span class="p">:</span> <span class="s2">&quot;sum&quot;</span><span class="p">,</span> <span class="s2">&quot;stake&quot;</span><span class="p">:</span> <span class="s2">&quot;sum&quot;</span><span class="p">})</span>
<a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a>         <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">pot</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;npl&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;stake&#39;</span><span class="p">])</span>
<a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a>        <span class="p">)</span>
<a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-16-11" name="__codelineno-16-11" href="#__codelineno-16-11"></a>        <span class="n">metrics</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">d</span>
<a id="__codelineno-16-12" name="__codelineno-16-12" href="#__codelineno-16-12"></a>         <span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s2">&quot;npl&quot;</span><span class="p">:</span> <span class="s2">&quot;sum&quot;</span><span class="p">,</span> <span class="s2">&quot;stake&quot;</span><span class="p">:</span> <span class="s2">&quot;sum&quot;</span><span class="p">})</span>
<a id="__codelineno-16-13" name="__codelineno-16-13" href="#__codelineno-16-13"></a>        <span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">pot</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;npl&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;stake&#39;</span><span class="p">])</span>
<a id="__codelineno-16-14" name="__codelineno-16-14" href="#__codelineno-16-14"></a>
<a id="__codelineno-16-15" name="__codelineno-16-15" href="#__codelineno-16-15"></a>    <span class="k">return</span><span class="p">(</span><span class="n">metrics</span><span class="p">[</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;stake&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">])</span>
<a id="__codelineno-16-16" name="__codelineno-16-16" href="#__codelineno-16-16"></a>
<a id="__codelineno-16-17" name="__codelineno-16-17" href="#__codelineno-16-17"></a><span class="c1"># Cumulative PL by market to visually see trend and consistency</span>
<a id="__codelineno-16-18" name="__codelineno-16-18" href="#__codelineno-16-18"></a><span class="k">def</span><span class="w"> </span><span class="nf">bet_eval_chart_cPl</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
<a id="__codelineno-16-19" name="__codelineno-16-19" href="#__codelineno-16-19"></a>
<a id="__codelineno-16-20" name="__codelineno-16-20" href="#__codelineno-16-20"></a>    <span class="n">d</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-16-21" name="__codelineno-16-21" href="#__codelineno-16-21"></a>        <span class="n">d</span>
<a id="__codelineno-16-22" name="__codelineno-16-22" href="#__codelineno-16-22"></a>        <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;market_id&#39;</span><span class="p">)</span>
<a id="__codelineno-16-23" name="__codelineno-16-23" href="#__codelineno-16-23"></a>        <span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s1">&#39;npl&#39;</span><span class="p">:</span> <span class="s1">&#39;sum&#39;</span><span class="p">})</span>
<a id="__codelineno-16-24" name="__codelineno-16-24" href="#__codelineno-16-24"></a>    <span class="p">)</span>
<a id="__codelineno-16-25" name="__codelineno-16-25" href="#__codelineno-16-25"></a>
<a id="__codelineno-16-26" name="__codelineno-16-26" href="#__codelineno-16-26"></a>    <span class="n">d</span><span class="p">[</span><span class="s1">&#39;market_number&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>
<a id="__codelineno-16-27" name="__codelineno-16-27" href="#__codelineno-16-27"></a>    <span class="n">d</span><span class="p">[</span><span class="s1">&#39;cNpl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">npl</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
<a id="__codelineno-16-28" name="__codelineno-16-28" href="#__codelineno-16-28"></a>
<a id="__codelineno-16-29" name="__codelineno-16-29" href="#__codelineno-16-29"></a>    <span class="n">chart</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;market_number&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;cNpl&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Cumulative Net Profit&#39;</span><span class="p">,</span> <span class="n">template</span><span class="o">=</span><span class="s1">&#39;simple_white&#39;</span><span class="p">)</span>
<a id="__codelineno-16-30" name="__codelineno-16-30" href="#__codelineno-16-30"></a>
<a id="__codelineno-16-31" name="__codelineno-16-31" href="#__codelineno-16-31"></a>    <span class="k">return</span><span class="p">(</span><span class="n">chart</span><span class="p">)</span>
</code></pre></div>
<p>To illustrate these evaluation functions let's analyse flat staking at the BSP.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="n">bets</span> <span class="o">=</span> <span class="n">bet_flat</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">stake</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">back_odds</span> <span class="o">=</span> <span class="s1">&#39;bsp&#39;</span><span class="p">,</span> <span class="n">lay_odds</span> <span class="o">=</span> <span class="s1">&#39;bsp&#39;</span><span class="p">)</span>
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a>
<a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a><span class="n">bet_eval_metrics</span><span class="p">(</span><span class="n">bets</span><span class="p">,</span> <span class="n">side</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</code></pre></div>
<table>
<thead>
<tr>
<th>bet_side</th>
<th>npl</th>
<th>stake</th>
<th>pot</th>
</tr>
</thead>
<tbody>
<tr>
<td>B</td>
<td>-749.493788</td>
<td>8356</td>
<td>-0.089695</td>
</tr>
<tr>
<td>L</td>
<td>-268.499212</td>
<td>8592</td>
<td>-0.031250</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="n">bet_eval_chart_cPl</span><span class="p">(</span><span class="n">bets</span><span class="p">)</span>
</code></pre></div>
<p>So this isn't gonna build us an art gallery! This is to be expected though, it's not easy to make consistent profit certainly from free ratings sources available online.</p>
<p><img alt="Output graph" src="../img/graph1.png" /></p>
<hr />
<h3 id="testing-different-approaches">Testing different approaches</h3>
<p>We pulled those extra price points for a reason. Let's set up a little test harness that enables us to use different price points and bet using different staking functions.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="c1"># We&#39;ll test a 2 different staking schemes on 3 different price points</span>
<a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a><span class="n">grid</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a>        <span class="s2">&quot;flat_bsp&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">bet_flat</span><span class="p">,</span> <span class="s2">&quot;bsp&quot;</span><span class="p">,</span> <span class="s2">&quot;bsp&quot;</span><span class="p">),</span>
<a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a>        <span class="s2">&quot;flat_ltp&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">bet_flat</span><span class="p">,</span> <span class="s2">&quot;ltp&quot;</span><span class="p">,</span> <span class="s2">&quot;ltp&quot;</span><span class="p">),</span>
<a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a>        <span class="s2">&quot;flat_3m&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">bet_flat</span><span class="p">,</span> <span class="s2">&quot;best_back_3m&quot;</span><span class="p">,</span> <span class="s2">&quot;best_lay_3m&quot;</span><span class="p">),</span>
<a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a>        <span class="s2">&quot;kelly_bsp&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">bet_kelly</span><span class="p">,</span> <span class="s2">&quot;bsp&quot;</span><span class="p">,</span> <span class="s2">&quot;bsp&quot;</span><span class="p">),</span>
<a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a>        <span class="s2">&quot;kelly_ltp&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">bet_kelly</span><span class="p">,</span> <span class="s2">&quot;ltp&quot;</span><span class="p">,</span> <span class="s2">&quot;ltp&quot;</span><span class="p">),</span>
<a id="__codelineno-19-8" name="__codelineno-19-8" href="#__codelineno-19-8"></a>        <span class="s2">&quot;kelly_3m&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">bet_kelly</span><span class="p">,</span> <span class="s2">&quot;best_back_3m&quot;</span><span class="p">,</span> <span class="s2">&quot;best_lay_3m&quot;</span><span class="p">)</span>
<a id="__codelineno-19-9" name="__codelineno-19-9" href="#__codelineno-19-9"></a>    <span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="n">metricSummary</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a><span class="k">for</span> <span class="n">strategy</span><span class="p">,</span> <span class="n">objects</span> <span class="ow">in</span> <span class="n">grid</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a>
<a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a>    <span class="c1"># Assemble bets based on staking function and odds column</span>
<a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a>    <span class="c1"># objects[0] is the staking function itself</span>
<a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a>    <span class="n">bets</span> <span class="o">=</span> <span class="n">objects</span><span class="p">[</span><span class="mi">0</span><span class="p">](</span><span class="n">df</span><span class="p">,</span> <span class="n">back_odds</span> <span class="o">=</span> <span class="n">objects</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">lay_odds</span> <span class="o">=</span> <span class="n">objects</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
<a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a>
<a id="__codelineno-20-8" name="__codelineno-20-8" href="#__codelineno-20-8"></a>    <span class="c1"># Calculate the metrics and tag with strategy label</span>
<a id="__codelineno-20-9" name="__codelineno-20-9" href="#__codelineno-20-9"></a>    <span class="n">betMetrics</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-20-10" name="__codelineno-20-10" href="#__codelineno-20-10"></a>        <span class="n">bet_eval_metrics</span><span class="p">(</span><span class="n">bets</span><span class="p">)</span>
<a id="__codelineno-20-11" name="__codelineno-20-11" href="#__codelineno-20-11"></a>        <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">strategy</span><span class="p">)</span>
<a id="__codelineno-20-12" name="__codelineno-20-12" href="#__codelineno-20-12"></a>        <span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;strategy&#39;</span><span class="p">,</span> <span class="s1">&#39;stake&#39;</span><span class="p">,</span> <span class="s1">&#39;npl&#39;</span><span class="p">,</span> <span class="s1">&#39;pot&#39;</span><span class="p">])</span>
<a id="__codelineno-20-13" name="__codelineno-20-13" href="#__codelineno-20-13"></a>    <span class="p">)</span>
<a id="__codelineno-20-14" name="__codelineno-20-14" href="#__codelineno-20-14"></a>
<a id="__codelineno-20-15" name="__codelineno-20-15" href="#__codelineno-20-15"></a>    <span class="c1"># Init the betMetrics df or append if already exists</span>
<a id="__codelineno-20-16" name="__codelineno-20-16" href="#__codelineno-20-16"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-20-17" name="__codelineno-20-17" href="#__codelineno-20-17"></a>        <span class="n">metricSummary</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">metricSummary</span><span class="p">,</span> <span class="n">betMetrics</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-20-18" name="__codelineno-20-18" href="#__codelineno-20-18"></a>    <span class="k">except</span><span class="p">:</span>
<a id="__codelineno-20-19" name="__codelineno-20-19" href="#__codelineno-20-19"></a>        <span class="n">metricSummary</span> <span class="o">=</span> <span class="n">betMetrics</span>
<a id="__codelineno-20-20" name="__codelineno-20-20" href="#__codelineno-20-20"></a>
<a id="__codelineno-20-21" name="__codelineno-20-21" href="#__codelineno-20-21"></a><span class="n">metricSummary</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;pot&#39;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div>
<table>
<thead>
<tr>
<th>strategy</th>
<th>stake</th>
<th>npl</th>
<th>pot</th>
</tr>
</thead>
<tbody>
<tr>
<td>kelly_ltp</td>
<td>754.496453</td>
<td>-31.814150</td>
<td>-0.042166</td>
</tr>
<tr>
<td>kelly_bsp</td>
<td>732.165110</td>
<td>-34.613773</td>
<td>-0.047276</td>
</tr>
<tr>
<td>flat_bsp</td>
<td>16948.000000</td>
<td>-1017.993000</td>
<td>-0.060066</td>
</tr>
<tr>
<td>flat_ltp</td>
<td>16949.000000</td>
<td>-1184.546000</td>
<td>-0.069889</td>
</tr>
<tr>
<td>flat_3m</td>
<td>15712.000000</td>
<td>-1225.123000</td>
<td>-0.077974</td>
</tr>
<tr>
<td>kelly_3m</td>
<td>614.135601</td>
<td>-50.469295</td>
<td>-0.082179</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="c1"># Compare Cumulative PL Charts</span>
<a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a><span class="n">cumulativePLs</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a><span class="k">for</span> <span class="n">strategy</span><span class="p">,</span> <span class="n">objects</span> <span class="ow">in</span> <span class="n">grid</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a>
<a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a>    <span class="c1"># Assemble bets based on staking function and odds column</span>
<a id="__codelineno-21-6" name="__codelineno-21-6" href="#__codelineno-21-6"></a>    <span class="n">bets</span> <span class="o">=</span> <span class="n">objects</span><span class="p">[</span><span class="mi">0</span><span class="p">](</span><span class="n">df</span><span class="p">,</span> <span class="n">back_odds</span> <span class="o">=</span> <span class="n">objects</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">lay_odds</span> <span class="o">=</span> <span class="n">objects</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
<a id="__codelineno-21-7" name="__codelineno-21-7" href="#__codelineno-21-7"></a>
<a id="__codelineno-21-8" name="__codelineno-21-8" href="#__codelineno-21-8"></a>    <span class="n">d</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-21-9" name="__codelineno-21-9" href="#__codelineno-21-9"></a>           <span class="n">bets</span>
<a id="__codelineno-21-10" name="__codelineno-21-10" href="#__codelineno-21-10"></a>           <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;market_id&#39;</span><span class="p">)</span>
<a id="__codelineno-21-11" name="__codelineno-21-11" href="#__codelineno-21-11"></a>           <span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s1">&#39;npl&#39;</span><span class="p">:</span> <span class="s1">&#39;sum&#39;</span><span class="p">,</span> <span class="s1">&#39;stake&#39;</span><span class="p">:</span> <span class="s1">&#39;sum&#39;</span><span class="p">})</span>
<a id="__codelineno-21-12" name="__codelineno-21-12" href="#__codelineno-21-12"></a>    <span class="p">)</span>
<a id="__codelineno-21-13" name="__codelineno-21-13" href="#__codelineno-21-13"></a>
<a id="__codelineno-21-14" name="__codelineno-21-14" href="#__codelineno-21-14"></a>    <span class="n">d</span><span class="p">[</span><span class="s1">&#39;market_number&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>
<a id="__codelineno-21-15" name="__codelineno-21-15" href="#__codelineno-21-15"></a>    <span class="c1"># Normalise to $10,000 stake for visual comparison</span>
<a id="__codelineno-21-16" name="__codelineno-21-16" href="#__codelineno-21-16"></a>    <span class="n">d</span><span class="p">[</span><span class="s1">&#39;npl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;npl&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">stake</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="mi">10000</span><span class="p">)</span>
<a id="__codelineno-21-17" name="__codelineno-21-17" href="#__codelineno-21-17"></a>    <span class="n">d</span><span class="p">[</span><span class="s1">&#39;cNpl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">npl</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
<a id="__codelineno-21-18" name="__codelineno-21-18" href="#__codelineno-21-18"></a>    <span class="n">d</span><span class="p">[</span><span class="s1">&#39;strategy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">strategy</span>
<a id="__codelineno-21-19" name="__codelineno-21-19" href="#__codelineno-21-19"></a>
<a id="__codelineno-21-20" name="__codelineno-21-20" href="#__codelineno-21-20"></a>    <span class="c1"># Init the cumulativePLs df or append if already exists</span>
<a id="__codelineno-21-21" name="__codelineno-21-21" href="#__codelineno-21-21"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-21-22" name="__codelineno-21-22" href="#__codelineno-21-22"></a>        <span class="n">cumulativePLs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">cumulativePLs</span><span class="p">,</span> <span class="n">d</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-21-23" name="__codelineno-21-23" href="#__codelineno-21-23"></a>    <span class="k">except</span><span class="p">:</span>
<a id="__codelineno-21-24" name="__codelineno-21-24" href="#__codelineno-21-24"></a>        <span class="n">cumulativePLs</span> <span class="o">=</span> <span class="n">d</span>
<a id="__codelineno-21-25" name="__codelineno-21-25" href="#__codelineno-21-25"></a>
<a id="__codelineno-21-26" name="__codelineno-21-26" href="#__codelineno-21-26"></a><span class="n">px</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">cumulativePLs</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;market_number&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;cNpl&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;strategy&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Cumulative Net Profit&#39;</span><span class="p">,</span> <span class="n">template</span><span class="o">=</span><span class="s1">&#39;simple_white&#39;</span><span class="p">)</span>
</code></pre></div>
<p><img alt="Output graph" src="../img/graph2.png" /></p>
<hr />
<h3 id="searching-for-profit">Searching For Profit</h3>
<p>So this is often where you're going to arrive developing many wagering models: there's no indication of reliable long term profit. Where do you go from here?</p>
<p>TBH I think most people give up here. Because you're not a quitter though you've got 3 main option categories:</p>
<ol>
<li>Make the underlying model better</li>
<li>Search for better prices via detailed price analysis and clever bet placement</li>
<li>Try to find a subset of these selections with these ratings and these price points that are sustainably profitable</li>
</ol>
<p>Obviously each situation is different but I think option 3 isn't a bad way to go initially because it will definitely help you understand your model better. For a racing model you might want to split your performance by:</p>
<ul>
<li>tracks or states</li>
<li>track conditions or weather</li>
<li>barriers</li>
<li>race quality or grade</li>
<li>odds ranges</li>
<li>selection sample size (you likely perform worse on horses with little form for eg)</li>
<li>perceived model value</li>
</ul>
<p>Finding a big enough slice across those dimensions that's either really profitable or really losing might reveal to you a bug in the data or workflow in your model development that you can go back and fix.</p>
<p>As an example of a simple approach to selectiveness I'll quickly run through how being more selective about your perceived value might make a difference in final profitability.</p>
<p>So our best performing strategy using our simple analysis above was Kelly staking at the last traded price. We'll start with that but be aware of that there's no way of implementing a LTP bet placement engine, you could imagine a proxy being placing limit bets "just before" the race jumps which is a whole other kettle of fish.</p>
<p>Anyway, let's plot our profitability under this strategy at different perceived "edges". If we are more selective of only large overlays according to the hub's rated chance you can see we can increase the profitability.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="n">bets</span> <span class="o">=</span> <span class="n">bet_kelly</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">back_odds</span> <span class="o">=</span> <span class="s1">&#39;ltp&#39;</span><span class="p">,</span> <span class="n">lay_odds</span> <span class="o">=</span> <span class="s1">&#39;ltp&#39;</span><span class="p">)</span>
<a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a>
<a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a><span class="n">metricSummary</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a>
<a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a><span class="k">for</span> <span class="n">bVal</span> <span class="ow">in</span> <span class="p">[</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">]:</span>
<a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a>    <span class="k">for</span> <span class="n">lVal</span> <span class="ow">in</span> <span class="p">[</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">]:</span>
<a id="__codelineno-22-7" name="__codelineno-22-7" href="#__codelineno-22-7"></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">bets</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;((ltp-model_odds) / ltp) &gt; </span><span class="si">{}</span><span class="s1">  | ((model_odds-ltp) / ltp) &gt; </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bVal</span><span class="p">,</span> <span class="n">lVal</span><span class="p">))</span>
<a id="__codelineno-22-8" name="__codelineno-22-8" href="#__codelineno-22-8"></a>
<a id="__codelineno-22-9" name="__codelineno-22-9" href="#__codelineno-22-9"></a>        <span class="n">betMetrics</span> <span class="o">=</span> <span class="n">bet_eval_metrics</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">side</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-22-10" name="__codelineno-22-10" href="#__codelineno-22-10"></a>        <span class="n">betMetrics</span><span class="p">[</span><span class="s1">&#39;bVal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bVal</span>
<a id="__codelineno-22-11" name="__codelineno-22-11" href="#__codelineno-22-11"></a>        <span class="n">betMetrics</span><span class="p">[</span><span class="s1">&#39;lVal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lVal</span>
<a id="__codelineno-22-12" name="__codelineno-22-12" href="#__codelineno-22-12"></a>
<a id="__codelineno-22-13" name="__codelineno-22-13" href="#__codelineno-22-13"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-22-14" name="__codelineno-22-14" href="#__codelineno-22-14"></a>            <span class="n">metricSummary</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">metricSummary</span><span class="p">,</span> <span class="n">betMetrics</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-22-15" name="__codelineno-22-15" href="#__codelineno-22-15"></a>        <span class="k">except</span><span class="p">:</span>
<a id="__codelineno-22-16" name="__codelineno-22-16" href="#__codelineno-22-16"></a>            <span class="n">metricSummary</span> <span class="o">=</span> <span class="n">betMetrics</span>
<a id="__codelineno-22-17" name="__codelineno-22-17" href="#__codelineno-22-17"></a>
<a id="__codelineno-22-18" name="__codelineno-22-18" href="#__codelineno-22-18"></a><span class="n">metricSummary</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;pot&#39;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</code></pre></div>
<table>
<thead>
<tr>
<th>npl</th>
<th>stake</th>
<th>pot</th>
<th>bVal</th>
<th>lVal</th>
</tr>
</thead>
<tbody>
<tr>
<td>-18.059813</td>
<td>574.944431</td>
<td>-0.031411</td>
<td>0.3</td>
<td>0.30</td>
</tr>
<tr>
<td>-22.887791</td>
<td>628.302349</td>
<td>-0.036428</td>
<td>0.3</td>
<td>0.20</td>
</tr>
<tr>
<td>-24.509182</td>
<td>669.482514</td>
<td>-0.036609</td>
<td>0.3</td>
<td>0.05</td>
</tr>
<tr>
<td>-22.997908</td>
<td>614.528386</td>
<td>-0.037424</td>
<td>0.2</td>
<td>0.30</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="n">betsFilters</span> <span class="o">=</span> <span class="n">bets</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;((ltp-model_odds) / ltp) &gt; </span><span class="si">{}</span><span class="s1">  | ((model_odds-ltp) / ltp) &gt; </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">))</span>
<a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a><span class="n">bet_eval_chart_cPl</span><span class="p">(</span><span class="n">betsFilters</span><span class="p">)</span>
</code></pre></div>
<p><img alt="Output graph" src="../img/graph4.png" /></p>
<p>We were doing ok till the last 200 market nightmare! Might be one to test with more data.</p>
<ul>
<li>So we still haven't found a clear profitable edge with these ratings, however we got a bit closer to break even which is positive.</li>
<li>This step also indicates that this rating system performs better for large overlays which is a good model indicator (if you can't improve by selecting for larger overlays it's usually a sign you need to go back to the drawing board)</li>
<li>You could imagine a few more iterations of analysis you might be able to eek out a slight edge</li>
<li>However, be wary as these steps optimisation steps are very prone to overfitting so you need to be careful.</li>
</ul>
<hr />
<h2 id="conclusion-and-next-steps">Conclusion and Next Steps</h2>
<p>While using someone else's model is easy it's also not likely to end in personal riches. Developing your own model with your own tools and on a sport or racing code you know about is probably where you should start. However, hopefully this short guide helps you think about what to do when you finish the modelling component:</p>
<blockquote>
<p>How much money will I win or lose if I started using this system to place bets with real money?</p>
</blockquote>
<p>If you want to expand this backtesting analysis, here's a list (in no particular order) of things that I've omitted or angles I might look at next:</p>
<ul>
<li>Get more data
-- more rating data and odds data is needed for draw a good conclusion about long term expectation</li>
<li>Cross reference performance against race or selection metadata (track, # races run etc.) to improve performance with betting selectivity</li>
<li>Extract more price points from the stream data to try to gain an pricing edge on these ratings</li>
</ul>
<hr />
<h3 id="over-to-you">Over to you</h3>
<p>We're planning on writing some more tutorials to help make it easier to work with the JSON data sets. If there are particular examples or data sets you'd like to see us walk through <a href="mailto:automation@betfair.com.au">please reach out</a>.</p>
<div class="admonition note">
<p class="admonition-title">Community support</p>
<ul>
<li>There's a really active <a href="https://betcode-org.slack.com/ssb/redirect">Betcode (formerly Betfairlightweight) slack group</a> that's a great place to go to ask questions about the library and get support from other people who are also working in the space</li>
</ul>
</div>
<hr />
<h3 id="complete-code">Complete code</h3>
<p>Run the code from your ide by using <code>py &lt;filename&gt;.py</code>, making sure you amend the path to point to your input data. </p>
<p><a href="https://github.com/betfair-down-under/autoHubTutorials/blob/aa76784071aad7703266d53dead7a713815e6107/backtestRatings/main.py">Download from Github</a></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">date</span><span class="p">,</span> <span class="n">timedelta</span>
<a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<a id="__codelineno-24-6" name="__codelineno-24-6" href="#__codelineno-24-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<a id="__codelineno-24-7" name="__codelineno-24-7" href="#__codelineno-24-7"></a><span class="kn">import</span><span class="w"> </span><span class="nn">tarfile</span>
<a id="__codelineno-24-8" name="__codelineno-24-8" href="#__codelineno-24-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">zipfile</span>
<a id="__codelineno-24-9" name="__codelineno-24-9" href="#__codelineno-24-9"></a><span class="kn">import</span><span class="w"> </span><span class="nn">bz2</span>
<a id="__codelineno-24-10" name="__codelineno-24-10" href="#__codelineno-24-10"></a><span class="kn">import</span><span class="w"> </span><span class="nn">glob</span>
<a id="__codelineno-24-11" name="__codelineno-24-11" href="#__codelineno-24-11"></a><span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<a id="__codelineno-24-12" name="__codelineno-24-12" href="#__codelineno-24-12"></a><span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">patch</span>
<a id="__codelineno-24-13" name="__codelineno-24-13" href="#__codelineno-24-13"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Set</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Optional</span>
<a id="__codelineno-24-14" name="__codelineno-24-14" href="#__codelineno-24-14"></a><span class="kn">from</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="kn">import</span> <span class="n">zip_longest</span>
<a id="__codelineno-24-15" name="__codelineno-24-15" href="#__codelineno-24-15"></a><span class="kn">import</span><span class="w"> </span><span class="nn">plotly.express</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">px</span>
<a id="__codelineno-24-16" name="__codelineno-24-16" href="#__codelineno-24-16"></a>
<a id="__codelineno-24-17" name="__codelineno-24-17" href="#__codelineno-24-17"></a><span class="kn">import</span><span class="w"> </span><span class="nn">betfairlightweight</span>
<a id="__codelineno-24-18" name="__codelineno-24-18" href="#__codelineno-24-18"></a><span class="kn">from</span><span class="w"> </span><span class="nn">betfairlightweight</span><span class="w"> </span><span class="kn">import</span> <span class="n">StreamListener</span>
<a id="__codelineno-24-19" name="__codelineno-24-19" href="#__codelineno-24-19"></a><span class="kn">from</span><span class="w"> </span><span class="nn">betfairlightweight.resources.bettingresources</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
<a id="__codelineno-24-20" name="__codelineno-24-20" href="#__codelineno-24-20"></a>    <span class="n">PriceSize</span><span class="p">,</span>
<a id="__codelineno-24-21" name="__codelineno-24-21" href="#__codelineno-24-21"></a>    <span class="n">MarketBook</span>
<a id="__codelineno-24-22" name="__codelineno-24-22" href="#__codelineno-24-22"></a><span class="p">)</span>
<a id="__codelineno-24-23" name="__codelineno-24-23" href="#__codelineno-24-23"></a><span class="c1">#Comment out the below line if not using a Jupyter Notebook (.ipynb)</span>
<a id="__codelineno-24-24" name="__codelineno-24-24" href="#__codelineno-24-24"></a><span class="o">%</span><span class="n">config</span> <span class="n">IPCompleter</span><span class="o">.</span><span class="n">greedy</span><span class="o">=</span><span class="kc">True</span>
<a id="__codelineno-24-25" name="__codelineno-24-25" href="#__codelineno-24-25"></a>
<a id="__codelineno-24-26" name="__codelineno-24-26" href="#__codelineno-24-26"></a><span class="c1">#### --------------------------</span>
<a id="__codelineno-24-27" name="__codelineno-24-27" href="#__codelineno-24-27"></a><span class="c1">#### FUNCTIONS</span>
<a id="__codelineno-24-28" name="__codelineno-24-28" href="#__codelineno-24-28"></a><span class="c1">#### --------------------------</span>
<a id="__codelineno-24-29" name="__codelineno-24-29" href="#__codelineno-24-29"></a>
<a id="__codelineno-24-30" name="__codelineno-24-30" href="#__codelineno-24-30"></a><span class="c1"># Function to return Pandas DF of hub ratings for a particular date</span>
<a id="__codelineno-24-31" name="__codelineno-24-31" href="#__codelineno-24-31"></a><span class="k">def</span><span class="w"> </span><span class="nf">getHubRatings</span><span class="p">(</span><span class="n">dte</span><span class="p">):</span>
<a id="__codelineno-24-32" name="__codelineno-24-32" href="#__codelineno-24-32"></a>
<a id="__codelineno-24-33" name="__codelineno-24-33" href="#__codelineno-24-33"></a>    <span class="c1"># Substitute the date into the URL</span>
<a id="__codelineno-24-34" name="__codelineno-24-34" href="#__codelineno-24-34"></a>    <span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;https://betfair-data-supplier-prod.herokuapp.com/api/widgets/kash-ratings-model/datasets?date=20</span><span class="si">{}</span><span class="s1">&amp;presenter=RatingsPresenter&amp;json=true&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dte</span><span class="p">)</span>
<a id="__codelineno-24-35" name="__codelineno-24-35" href="#__codelineno-24-35"></a>
<a id="__codelineno-24-36" name="__codelineno-24-36" href="#__codelineno-24-36"></a>    <span class="c1"># Convert the response into JSON</span>
<a id="__codelineno-24-37" name="__codelineno-24-37" href="#__codelineno-24-37"></a>    <span class="n">responseJson</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
<a id="__codelineno-24-38" name="__codelineno-24-38" href="#__codelineno-24-38"></a>    <span class="c1"># if SSL.Certificate errors are encountered, replace the above line with: responseJson = requests.get(url,verify=False).json()</span>
<a id="__codelineno-24-39" name="__codelineno-24-39" href="#__codelineno-24-39"></a>
<a id="__codelineno-24-40" name="__codelineno-24-40" href="#__codelineno-24-40"></a>    <span class="n">hubList</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-24-41" name="__codelineno-24-41" href="#__codelineno-24-41"></a>
<a id="__codelineno-24-42" name="__codelineno-24-42" href="#__codelineno-24-42"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">responseJson</span><span class="p">:</span>
<a id="__codelineno-24-43" name="__codelineno-24-43" href="#__codelineno-24-43"></a>        <span class="k">return</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-24-44" name="__codelineno-24-44" href="#__codelineno-24-44"></a>
<a id="__codelineno-24-45" name="__codelineno-24-45" href="#__codelineno-24-45"></a>
<a id="__codelineno-24-46" name="__codelineno-24-46" href="#__codelineno-24-46"></a>    <span class="c1"># Want an normalised table (1 row per selection)</span>
<a id="__codelineno-24-47" name="__codelineno-24-47" href="#__codelineno-24-47"></a>    <span class="c1"># Brute force / simple approach is to loop through meetings / races / runners and pull out the key fields</span>
<a id="__codelineno-24-48" name="__codelineno-24-48" href="#__codelineno-24-48"></a>    <span class="k">for</span> <span class="n">meeting</span> <span class="ow">in</span> <span class="n">responseJson</span><span class="p">[</span><span class="s1">&#39;meetings&#39;</span><span class="p">]:</span>
<a id="__codelineno-24-49" name="__codelineno-24-49" href="#__codelineno-24-49"></a>        <span class="k">for</span> <span class="n">race</span> <span class="ow">in</span> <span class="n">meeting</span><span class="p">[</span><span class="s1">&#39;races&#39;</span><span class="p">]:</span>
<a id="__codelineno-24-50" name="__codelineno-24-50" href="#__codelineno-24-50"></a>            <span class="k">for</span> <span class="n">runner</span> <span class="ow">in</span> <span class="n">race</span><span class="p">[</span><span class="s1">&#39;runners&#39;</span><span class="p">]:</span>
<a id="__codelineno-24-51" name="__codelineno-24-51" href="#__codelineno-24-51"></a>                <span class="n">hubList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
<a id="__codelineno-24-52" name="__codelineno-24-52" href="#__codelineno-24-52"></a>                    <span class="p">{</span>
<a id="__codelineno-24-53" name="__codelineno-24-53" href="#__codelineno-24-53"></a>                        <span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="n">dte</span><span class="p">,</span>
<a id="__codelineno-24-54" name="__codelineno-24-54" href="#__codelineno-24-54"></a>                        <span class="s1">&#39;track&#39;</span><span class="p">:</span> <span class="n">meeting</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
<a id="__codelineno-24-55" name="__codelineno-24-55" href="#__codelineno-24-55"></a>                        <span class="s1">&#39;race_number&#39;</span><span class="p">:</span> <span class="n">race</span><span class="p">[</span><span class="s1">&#39;number&#39;</span><span class="p">],</span>
<a id="__codelineno-24-56" name="__codelineno-24-56" href="#__codelineno-24-56"></a>                        <span class="s1">&#39;race_name&#39;</span><span class="p">:</span> <span class="n">race</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
<a id="__codelineno-24-57" name="__codelineno-24-57" href="#__codelineno-24-57"></a>                        <span class="s1">&#39;market_id&#39;</span><span class="p">:</span> <span class="n">race</span><span class="p">[</span><span class="s1">&#39;bfExchangeMarketId&#39;</span><span class="p">],</span>
<a id="__codelineno-24-58" name="__codelineno-24-58" href="#__codelineno-24-58"></a>                        <span class="s1">&#39;selection_id&#39;</span><span class="p">:</span>  <span class="nb">str</span><span class="p">(</span><span class="n">runner</span><span class="p">[</span><span class="s1">&#39;bfExchangeSelectionId&#39;</span><span class="p">]),</span>
<a id="__codelineno-24-59" name="__codelineno-24-59" href="#__codelineno-24-59"></a>                        <span class="s1">&#39;selection_name&#39;</span><span class="p">:</span> <span class="n">runner</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
<a id="__codelineno-24-60" name="__codelineno-24-60" href="#__codelineno-24-60"></a>                        <span class="s1">&#39;model_odds&#39;</span><span class="p">:</span> <span class="n">runner</span><span class="p">[</span><span class="s1">&#39;ratedPrice&#39;</span><span class="p">]</span>
<a id="__codelineno-24-61" name="__codelineno-24-61" href="#__codelineno-24-61"></a>                    <span class="p">}</span>
<a id="__codelineno-24-62" name="__codelineno-24-62" href="#__codelineno-24-62"></a>                <span class="p">)</span>
<a id="__codelineno-24-63" name="__codelineno-24-63" href="#__codelineno-24-63"></a>
<a id="__codelineno-24-64" name="__codelineno-24-64" href="#__codelineno-24-64"></a>    <span class="n">out</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">hubList</span><span class="p">)</span>
<a id="__codelineno-24-65" name="__codelineno-24-65" href="#__codelineno-24-65"></a>
<a id="__codelineno-24-66" name="__codelineno-24-66" href="#__codelineno-24-66"></a>    <span class="k">return</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
<a id="__codelineno-24-67" name="__codelineno-24-67" href="#__codelineno-24-67"></a>
<a id="__codelineno-24-68" name="__codelineno-24-68" href="#__codelineno-24-68"></a><span class="c1"># rounding to 2 decimal places or returning &#39;&#39; if blank</span>
<a id="__codelineno-24-69" name="__codelineno-24-69" href="#__codelineno-24-69"></a><span class="k">def</span><span class="w"> </span><span class="nf">as_str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-24-70" name="__codelineno-24-70" href="#__codelineno-24-70"></a>    <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">v</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">float</span> <span class="k">else</span> <span class="n">v</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
<a id="__codelineno-24-71" name="__codelineno-24-71" href="#__codelineno-24-71"></a>
<a id="__codelineno-24-72" name="__codelineno-24-72" href="#__codelineno-24-72"></a><span class="c1"># splitting race name and returning the parts </span>
<a id="__codelineno-24-73" name="__codelineno-24-73" href="#__codelineno-24-73"></a><span class="k">def</span><span class="w"> </span><span class="nf">split_anz_horse_market_name</span><span class="p">(</span><span class="n">market_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-24-74" name="__codelineno-24-74" href="#__codelineno-24-74"></a>    <span class="c1"># return race no, length, race type</span>
<a id="__codelineno-24-75" name="__codelineno-24-75" href="#__codelineno-24-75"></a>    <span class="c1"># input sample: R6 1400m Grp1</span>
<a id="__codelineno-24-76" name="__codelineno-24-76" href="#__codelineno-24-76"></a>    <span class="n">parts</span> <span class="o">=</span> <span class="n">market_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
<a id="__codelineno-24-77" name="__codelineno-24-77" href="#__codelineno-24-77"></a>    <span class="n">race_no</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># return example R6</span>
<a id="__codelineno-24-78" name="__codelineno-24-78" href="#__codelineno-24-78"></a>    <span class="n">race_len</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># return example 1400m</span>
<a id="__codelineno-24-79" name="__codelineno-24-79" href="#__codelineno-24-79"></a>    <span class="n">race_type</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="c1"># return example grp1, trot, pace</span>
<a id="__codelineno-24-80" name="__codelineno-24-80" href="#__codelineno-24-80"></a>
<a id="__codelineno-24-81" name="__codelineno-24-81" href="#__codelineno-24-81"></a>    <span class="k">return</span> <span class="p">(</span><span class="n">race_no</span><span class="p">,</span> <span class="n">race_len</span><span class="p">,</span> <span class="n">race_type</span><span class="p">)</span>
<a id="__codelineno-24-82" name="__codelineno-24-82" href="#__codelineno-24-82"></a>
<a id="__codelineno-24-83" name="__codelineno-24-83" href="#__codelineno-24-83"></a><span class="c1"># creating a flag that is True when markets are australian thoroughbreds</span>
<a id="__codelineno-24-84" name="__codelineno-24-84" href="#__codelineno-24-84"></a><span class="k">def</span><span class="w"> </span><span class="nf">filter_market</span><span class="p">(</span><span class="n">market</span><span class="p">:</span> <span class="n">MarketBook</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span> 
<a id="__codelineno-24-85" name="__codelineno-24-85" href="#__codelineno-24-85"></a>    <span class="n">d</span> <span class="o">=</span> <span class="n">market</span><span class="o">.</span><span class="n">market_definition</span>
<a id="__codelineno-24-86" name="__codelineno-24-86" href="#__codelineno-24-86"></a>    <span class="k">return</span> <span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">country_code</span> <span class="o">==</span> <span class="s1">&#39;AU&#39;</span> 
<a id="__codelineno-24-87" name="__codelineno-24-87" href="#__codelineno-24-87"></a>        <span class="ow">and</span> <span class="n">d</span><span class="o">.</span><span class="n">market_type</span> <span class="o">==</span> <span class="s1">&#39;WIN&#39;</span> 
<a id="__codelineno-24-88" name="__codelineno-24-88" href="#__codelineno-24-88"></a>        <span class="ow">and</span> <span class="p">(</span><span class="n">c</span> <span class="o">:=</span> <span class="n">split_anz_horse_market_name</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">name</span><span class="p">)[</span><span class="mi">2</span><span class="p">])</span> <span class="o">!=</span> <span class="s1">&#39;trot&#39;</span> <span class="ow">and</span> <span class="n">c</span> <span class="o">!=</span> <span class="s1">&#39;pace&#39;</span><span class="p">)</span>
<a id="__codelineno-24-89" name="__codelineno-24-89" href="#__codelineno-24-89"></a>
<a id="__codelineno-24-90" name="__codelineno-24-90" href="#__codelineno-24-90"></a><span class="c1"># loading from tar and extracting files</span>
<a id="__codelineno-24-91" name="__codelineno-24-91" href="#__codelineno-24-91"></a><span class="k">def</span><span class="w"> </span><span class="nf">load_markets</span><span class="p">(</span><span class="n">file_paths</span><span class="p">):</span>
<a id="__codelineno-24-92" name="__codelineno-24-92" href="#__codelineno-24-92"></a>    <span class="k">for</span> <span class="n">file_path</span> <span class="ow">in</span> <span class="n">file_paths</span><span class="p">:</span>
<a id="__codelineno-24-93" name="__codelineno-24-93" href="#__codelineno-24-93"></a>        <span class="nb">print</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
<a id="__codelineno-24-94" name="__codelineno-24-94" href="#__codelineno-24-94"></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
<a id="__codelineno-24-95" name="__codelineno-24-95" href="#__codelineno-24-95"></a>            <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">iglob</span><span class="p">(</span><span class="n">file_path</span> <span class="o">+</span> <span class="s1">&#39;**/**/*.bz2&#39;</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<a id="__codelineno-24-96" name="__codelineno-24-96" href="#__codelineno-24-96"></a>                <span class="n">f</span> <span class="o">=</span> <span class="n">bz2</span><span class="o">.</span><span class="n">BZ2File</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
<a id="__codelineno-24-97" name="__codelineno-24-97" href="#__codelineno-24-97"></a>                <span class="k">yield</span> <span class="n">f</span>
<a id="__codelineno-24-98" name="__codelineno-24-98" href="#__codelineno-24-98"></a>                <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<a id="__codelineno-24-99" name="__codelineno-24-99" href="#__codelineno-24-99"></a>        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
<a id="__codelineno-24-100" name="__codelineno-24-100" href="#__codelineno-24-100"></a>            <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file_path</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-24-101" name="__codelineno-24-101" href="#__codelineno-24-101"></a>            <span class="c1"># iterate through a tar archive</span>
<a id="__codelineno-24-102" name="__codelineno-24-102" href="#__codelineno-24-102"></a>            <span class="k">if</span> <span class="n">ext</span> <span class="o">==</span> <span class="s1">&#39;.tar&#39;</span><span class="p">:</span>
<a id="__codelineno-24-103" name="__codelineno-24-103" href="#__codelineno-24-103"></a>                <span class="k">with</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">TarFile</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">archive</span><span class="p">:</span>
<a id="__codelineno-24-104" name="__codelineno-24-104" href="#__codelineno-24-104"></a>                    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">archive</span><span class="p">:</span>
<a id="__codelineno-24-105" name="__codelineno-24-105" href="#__codelineno-24-105"></a>                        <span class="k">yield</span> <span class="n">bz2</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">archive</span><span class="o">.</span><span class="n">extractfile</span><span class="p">(</span><span class="n">file</span><span class="p">))</span>
<a id="__codelineno-24-106" name="__codelineno-24-106" href="#__codelineno-24-106"></a>            <span class="c1"># or a zip archive</span>
<a id="__codelineno-24-107" name="__codelineno-24-107" href="#__codelineno-24-107"></a>            <span class="k">elif</span> <span class="n">ext</span> <span class="o">==</span> <span class="s1">&#39;.zip&#39;</span><span class="p">:</span>
<a id="__codelineno-24-108" name="__codelineno-24-108" href="#__codelineno-24-108"></a>                <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">archive</span><span class="p">:</span>
<a id="__codelineno-24-109" name="__codelineno-24-109" href="#__codelineno-24-109"></a>                    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">archive</span><span class="o">.</span><span class="n">namelist</span><span class="p">():</span>
<a id="__codelineno-24-110" name="__codelineno-24-110" href="#__codelineno-24-110"></a>                        <span class="k">yield</span> <span class="n">bz2</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">archive</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file</span><span class="p">))</span>
<a id="__codelineno-24-111" name="__codelineno-24-111" href="#__codelineno-24-111"></a>
<a id="__codelineno-24-112" name="__codelineno-24-112" href="#__codelineno-24-112"></a>    <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-24-113" name="__codelineno-24-113" href="#__codelineno-24-113"></a>
<a id="__codelineno-24-114" name="__codelineno-24-114" href="#__codelineno-24-114"></a><span class="c1"># Extract Components From Generated Stream</span>
<a id="__codelineno-24-115" name="__codelineno-24-115" href="#__codelineno-24-115"></a><span class="k">def</span><span class="w"> </span><span class="nf">extract_components_from_stream</span><span class="p">(</span><span class="n">stream</span><span class="p">):</span>
<a id="__codelineno-24-116" name="__codelineno-24-116" href="#__codelineno-24-116"></a>
<a id="__codelineno-24-117" name="__codelineno-24-117" href="#__codelineno-24-117"></a>    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s2">&quot;builtins.open&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">f</span><span class="p">,</span> <span class="n">_</span><span class="p">:</span> <span class="n">f</span><span class="p">):</span>   
<a id="__codelineno-24-118" name="__codelineno-24-118" href="#__codelineno-24-118"></a>
<a id="__codelineno-24-119" name="__codelineno-24-119" href="#__codelineno-24-119"></a>        <span class="c1"># Will return 3 market books t-3mins marketbook, the last preplay marketbook and the final market book</span>
<a id="__codelineno-24-120" name="__codelineno-24-120" href="#__codelineno-24-120"></a>        <span class="n">evaluate_market</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-24-121" name="__codelineno-24-121" href="#__codelineno-24-121"></a>        <span class="n">prev_market</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-24-122" name="__codelineno-24-122" href="#__codelineno-24-122"></a>        <span class="n">postplay_market</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-24-123" name="__codelineno-24-123" href="#__codelineno-24-123"></a>        <span class="n">preplay_market</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-24-124" name="__codelineno-24-124" href="#__codelineno-24-124"></a>        <span class="n">t3m_market</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-24-125" name="__codelineno-24-125" href="#__codelineno-24-125"></a>
<a id="__codelineno-24-126" name="__codelineno-24-126" href="#__codelineno-24-126"></a>        <span class="n">gen</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">get_generator</span><span class="p">()</span>
<a id="__codelineno-24-127" name="__codelineno-24-127" href="#__codelineno-24-127"></a>
<a id="__codelineno-24-128" name="__codelineno-24-128" href="#__codelineno-24-128"></a>        <span class="k">for</span> <span class="n">market_books</span> <span class="ow">in</span> <span class="n">gen</span><span class="p">():</span>
<a id="__codelineno-24-129" name="__codelineno-24-129" href="#__codelineno-24-129"></a>
<a id="__codelineno-24-130" name="__codelineno-24-130" href="#__codelineno-24-130"></a>            <span class="k">for</span> <span class="n">market_book</span> <span class="ow">in</span> <span class="n">market_books</span><span class="p">:</span>
<a id="__codelineno-24-131" name="__codelineno-24-131" href="#__codelineno-24-131"></a>
<a id="__codelineno-24-132" name="__codelineno-24-132" href="#__codelineno-24-132"></a>                <span class="c1"># If markets don&#39;t meet filter return None&#39;s</span>
<a id="__codelineno-24-133" name="__codelineno-24-133" href="#__codelineno-24-133"></a>                <span class="k">if</span> <span class="n">evaluate_market</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">((</span><span class="n">evaluate_market</span> <span class="o">:=</span> <span class="n">filter_market</span><span class="p">(</span><span class="n">market_book</span><span class="p">))</span> <span class="o">==</span> <span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-24-134" name="__codelineno-24-134" href="#__codelineno-24-134"></a>                    <span class="k">return</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-24-135" name="__codelineno-24-135" href="#__codelineno-24-135"></a>
<a id="__codelineno-24-136" name="__codelineno-24-136" href="#__codelineno-24-136"></a>                <span class="c1"># final market view before market goes in play</span>
<a id="__codelineno-24-137" name="__codelineno-24-137" href="#__codelineno-24-137"></a>                <span class="k">if</span> <span class="n">prev_market</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">prev_market</span><span class="o">.</span><span class="n">inplay</span> <span class="o">!=</span> <span class="n">market_book</span><span class="o">.</span><span class="n">inplay</span><span class="p">:</span>
<a id="__codelineno-24-138" name="__codelineno-24-138" href="#__codelineno-24-138"></a>                    <span class="n">preplay_market</span> <span class="o">=</span> <span class="n">market_book</span>
<a id="__codelineno-24-139" name="__codelineno-24-139" href="#__codelineno-24-139"></a>
<a id="__codelineno-24-140" name="__codelineno-24-140" href="#__codelineno-24-140"></a>                <span class="c1"># final market view before market goes is closed for settlement</span>
<a id="__codelineno-24-141" name="__codelineno-24-141" href="#__codelineno-24-141"></a>                <span class="k">if</span> <span class="n">prev_market</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">prev_market</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;OPEN&quot;</span> <span class="ow">and</span> <span class="n">market_book</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="n">prev_market</span><span class="o">.</span><span class="n">status</span><span class="p">:</span>
<a id="__codelineno-24-142" name="__codelineno-24-142" href="#__codelineno-24-142"></a>                    <span class="n">postplay_market</span> <span class="o">=</span> <span class="n">market_book</span>
<a id="__codelineno-24-143" name="__codelineno-24-143" href="#__codelineno-24-143"></a>
<a id="__codelineno-24-144" name="__codelineno-24-144" href="#__codelineno-24-144"></a>                <span class="c1"># Calculate Seconds Till Scheduled Market Start Time</span>
<a id="__codelineno-24-145" name="__codelineno-24-145" href="#__codelineno-24-145"></a>                <span class="n">seconds_to_start</span> <span class="o">=</span> <span class="p">(</span><span class="n">market_book</span><span class="o">.</span><span class="n">market_definition</span><span class="o">.</span><span class="n">market_time</span> <span class="o">-</span> <span class="n">market_book</span><span class="o">.</span><span class="n">publish_time</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
<a id="__codelineno-24-146" name="__codelineno-24-146" href="#__codelineno-24-146"></a>
<a id="__codelineno-24-147" name="__codelineno-24-147" href="#__codelineno-24-147"></a>                <span class="c1"># Market at 3 mins before scheduled off</span>
<a id="__codelineno-24-148" name="__codelineno-24-148" href="#__codelineno-24-148"></a>                <span class="k">if</span> <span class="n">t3m_market</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">seconds_to_start</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="o">*</span><span class="mi">60</span><span class="p">:</span>
<a id="__codelineno-24-149" name="__codelineno-24-149" href="#__codelineno-24-149"></a>                    <span class="n">t3m_market</span> <span class="o">=</span> <span class="n">market_book</span>
<a id="__codelineno-24-150" name="__codelineno-24-150" href="#__codelineno-24-150"></a>
<a id="__codelineno-24-151" name="__codelineno-24-151" href="#__codelineno-24-151"></a>                <span class="c1"># update reference to previous market</span>
<a id="__codelineno-24-152" name="__codelineno-24-152" href="#__codelineno-24-152"></a>                <span class="n">prev_market</span> <span class="o">=</span> <span class="n">market_book</span>
<a id="__codelineno-24-153" name="__codelineno-24-153" href="#__codelineno-24-153"></a>
<a id="__codelineno-24-154" name="__codelineno-24-154" href="#__codelineno-24-154"></a>        <span class="c1"># If market didn&#39;t go inplay</span>
<a id="__codelineno-24-155" name="__codelineno-24-155" href="#__codelineno-24-155"></a>        <span class="k">if</span> <span class="n">postplay_market</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">preplay_market</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-24-156" name="__codelineno-24-156" href="#__codelineno-24-156"></a>            <span class="n">preplay_market</span> <span class="o">=</span> <span class="n">postplay_market</span>
<a id="__codelineno-24-157" name="__codelineno-24-157" href="#__codelineno-24-157"></a>
<a id="__codelineno-24-158" name="__codelineno-24-158" href="#__codelineno-24-158"></a>        <span class="k">return</span> <span class="p">(</span><span class="n">t3m_market</span><span class="p">,</span> <span class="n">preplay_market</span><span class="p">,</span> <span class="n">postplay_market</span><span class="p">,</span> <span class="n">prev_market</span><span class="p">)</span> <span class="c1"># Final market is last prev_market</span>
<a id="__codelineno-24-159" name="__codelineno-24-159" href="#__codelineno-24-159"></a>
<a id="__codelineno-24-160" name="__codelineno-24-160" href="#__codelineno-24-160"></a><span class="k">def</span><span class="w"> </span><span class="nf">run_stream_parsing</span><span class="p">():</span>
<a id="__codelineno-24-161" name="__codelineno-24-161" href="#__codelineno-24-161"></a>
<a id="__codelineno-24-162" name="__codelineno-24-162" href="#__codelineno-24-162"></a>    <span class="c1"># Run Pipeline</span>
<a id="__codelineno-24-163" name="__codelineno-24-163" href="#__codelineno-24-163"></a>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;outputs/tho-odds.csv&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">output</span><span class="p">:</span>
<a id="__codelineno-24-164" name="__codelineno-24-164" href="#__codelineno-24-164"></a>
<a id="__codelineno-24-165" name="__codelineno-24-165" href="#__codelineno-24-165"></a>        <span class="c1"># Write Column Headers To File</span>
<a id="__codelineno-24-166" name="__codelineno-24-166" href="#__codelineno-24-166"></a>        <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;market_id,event_date,country,track,market_name,selection_id,selection_name,result,bsp,ltp,matched_volume,atb_ladder_3m,atl_ladder_3m</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-24-167" name="__codelineno-24-167" href="#__codelineno-24-167"></a>
<a id="__codelineno-24-168" name="__codelineno-24-168" href="#__codelineno-24-168"></a>        <span class="k">for</span> <span class="n">file_obj</span> <span class="ow">in</span> <span class="n">load_markets</span><span class="p">(</span><span class="s1">&#39;[INPUT LOCATION OF DATA FILES HERE]&#39;</span><span class="p">):</span>
<a id="__codelineno-24-169" name="__codelineno-24-169" href="#__codelineno-24-169"></a>
<a id="__codelineno-24-170" name="__codelineno-24-170" href="#__codelineno-24-170"></a>            <span class="c1"># Instantiate a &quot;stream&quot; object</span>
<a id="__codelineno-24-171" name="__codelineno-24-171" href="#__codelineno-24-171"></a>            <span class="n">stream</span> <span class="o">=</span> <span class="n">trading</span><span class="o">.</span><span class="n">streaming</span><span class="o">.</span><span class="n">create_historical_generator_stream</span><span class="p">(</span>
<a id="__codelineno-24-172" name="__codelineno-24-172" href="#__codelineno-24-172"></a>                <span class="n">file_path</span><span class="o">=</span><span class="n">file_obj</span><span class="p">,</span>
<a id="__codelineno-24-173" name="__codelineno-24-173" href="#__codelineno-24-173"></a>                <span class="n">listener</span><span class="o">=</span><span class="n">listener</span><span class="p">,</span>
<a id="__codelineno-24-174" name="__codelineno-24-174" href="#__codelineno-24-174"></a>            <span class="p">)</span>
<a id="__codelineno-24-175" name="__codelineno-24-175" href="#__codelineno-24-175"></a>
<a id="__codelineno-24-176" name="__codelineno-24-176" href="#__codelineno-24-176"></a>            <span class="c1"># Extract key components according to the custom function above (outputs 4 objects)</span>
<a id="__codelineno-24-177" name="__codelineno-24-177" href="#__codelineno-24-177"></a>            <span class="p">(</span><span class="n">t3m_market</span><span class="p">,</span> <span class="n">preplay_market</span><span class="p">,</span> <span class="n">postplay_market</span><span class="p">,</span> <span class="n">final_market</span><span class="p">)</span> <span class="o">=</span> <span class="n">extract_components_from_stream</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
<a id="__codelineno-24-178" name="__codelineno-24-178" href="#__codelineno-24-178"></a>
<a id="__codelineno-24-179" name="__codelineno-24-179" href="#__codelineno-24-179"></a>            <span class="c1"># If no price data for market don&#39;t write to file</span>
<a id="__codelineno-24-180" name="__codelineno-24-180" href="#__codelineno-24-180"></a>            <span class="k">if</span> <span class="n">postplay_market</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-24-181" name="__codelineno-24-181" href="#__codelineno-24-181"></a>                <span class="k">continue</span><span class="p">;</span> 
<a id="__codelineno-24-182" name="__codelineno-24-182" href="#__codelineno-24-182"></a>
<a id="__codelineno-24-183" name="__codelineno-24-183" href="#__codelineno-24-183"></a>            <span class="c1"># Runner metadata and key fields available from final market book</span>
<a id="__codelineno-24-184" name="__codelineno-24-184" href="#__codelineno-24-184"></a>            <span class="n">runner_data</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-24-185" name="__codelineno-24-185" href="#__codelineno-24-185"></a>                <span class="p">{</span>
<a id="__codelineno-24-186" name="__codelineno-24-186" href="#__codelineno-24-186"></a>                    <span class="s1">&#39;selection_id&#39;</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">selection_id</span><span class="p">,</span>
<a id="__codelineno-24-187" name="__codelineno-24-187" href="#__codelineno-24-187"></a>                    <span class="s1">&#39;selection_name&#39;</span><span class="p">:</span> <span class="nb">next</span><span class="p">((</span><span class="n">rd</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">rd</span> <span class="ow">in</span> <span class="n">final_market</span><span class="o">.</span><span class="n">market_definition</span><span class="o">.</span><span class="n">runners</span> <span class="k">if</span> <span class="n">rd</span><span class="o">.</span><span class="n">selection_id</span> <span class="o">==</span> <span class="n">r</span><span class="o">.</span><span class="n">selection_id</span><span class="p">),</span> <span class="kc">None</span><span class="p">),</span>
<a id="__codelineno-24-188" name="__codelineno-24-188" href="#__codelineno-24-188"></a>                    <span class="s1">&#39;selection_status&#39;</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
<a id="__codelineno-24-189" name="__codelineno-24-189" href="#__codelineno-24-189"></a>                    <span class="s1">&#39;sp&#39;</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">actual_sp</span>
<a id="__codelineno-24-190" name="__codelineno-24-190" href="#__codelineno-24-190"></a>                <span class="p">}</span>
<a id="__codelineno-24-191" name="__codelineno-24-191" href="#__codelineno-24-191"></a>                <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">final_market</span><span class="o">.</span><span class="n">runners</span> 
<a id="__codelineno-24-192" name="__codelineno-24-192" href="#__codelineno-24-192"></a>            <span class="p">]</span>
<a id="__codelineno-24-193" name="__codelineno-24-193" href="#__codelineno-24-193"></a>
<a id="__codelineno-24-194" name="__codelineno-24-194" href="#__codelineno-24-194"></a>            <span class="c1"># Last Traded Price</span>
<a id="__codelineno-24-195" name="__codelineno-24-195" href="#__codelineno-24-195"></a>            <span class="c1"># _____________________</span>
<a id="__codelineno-24-196" name="__codelineno-24-196" href="#__codelineno-24-196"></a>
<a id="__codelineno-24-197" name="__codelineno-24-197" href="#__codelineno-24-197"></a>            <span class="c1"># From the last marketbook before inplay or close</span>
<a id="__codelineno-24-198" name="__codelineno-24-198" href="#__codelineno-24-198"></a>            <span class="n">ltp</span> <span class="o">=</span> <span class="p">[</span><span class="n">runner</span><span class="o">.</span><span class="n">last_price_traded</span> <span class="k">for</span> <span class="n">runner</span> <span class="ow">in</span> <span class="n">preplay_market</span><span class="o">.</span><span class="n">runners</span><span class="p">]</span>
<a id="__codelineno-24-199" name="__codelineno-24-199" href="#__codelineno-24-199"></a>
<a id="__codelineno-24-200" name="__codelineno-24-200" href="#__codelineno-24-200"></a>            <span class="c1"># Total Matched Volume  </span>
<a id="__codelineno-24-201" name="__codelineno-24-201" href="#__codelineno-24-201"></a>            <span class="c1"># _____________________</span>
<a id="__codelineno-24-202" name="__codelineno-24-202" href="#__codelineno-24-202"></a>
<a id="__codelineno-24-203" name="__codelineno-24-203" href="#__codelineno-24-203"></a>            <span class="c1"># Calculates the traded volume across all traded price points for each selection</span>
<a id="__codelineno-24-204" name="__codelineno-24-204" href="#__codelineno-24-204"></a>            <span class="k">def</span><span class="w"> </span><span class="nf">ladder_traded_volume</span><span class="p">(</span><span class="n">ladder</span><span class="p">):</span>
<a id="__codelineno-24-205" name="__codelineno-24-205" href="#__codelineno-24-205"></a>                <span class="k">return</span><span class="p">(</span><span class="nb">sum</span><span class="p">([</span><span class="n">rung</span><span class="o">.</span><span class="n">size</span> <span class="k">for</span> <span class="n">rung</span> <span class="ow">in</span> <span class="n">ladder</span><span class="p">]))</span>
<a id="__codelineno-24-206" name="__codelineno-24-206" href="#__codelineno-24-206"></a>
<a id="__codelineno-24-207" name="__codelineno-24-207" href="#__codelineno-24-207"></a>            <span class="n">selection_traded_volume</span> <span class="o">=</span> <span class="p">[</span> <span class="n">ladder_traded_volume</span><span class="p">(</span><span class="n">runner</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">traded_volume</span><span class="p">)</span> <span class="k">for</span> <span class="n">runner</span> <span class="ow">in</span> <span class="n">postplay_market</span><span class="o">.</span><span class="n">runners</span> <span class="p">]</span>
<a id="__codelineno-24-208" name="__codelineno-24-208" href="#__codelineno-24-208"></a>
<a id="__codelineno-24-209" name="__codelineno-24-209" href="#__codelineno-24-209"></a>            <span class="c1"># Top 3 Ladder</span>
<a id="__codelineno-24-210" name="__codelineno-24-210" href="#__codelineno-24-210"></a>            <span class="c1"># ______________________</span>
<a id="__codelineno-24-211" name="__codelineno-24-211" href="#__codelineno-24-211"></a>
<a id="__codelineno-24-212" name="__codelineno-24-212" href="#__codelineno-24-212"></a>            <span class="c1"># Extracts the top 3 price / stakes in available orders on both back and lay sides. Returns python dictionaries</span>
<a id="__codelineno-24-213" name="__codelineno-24-213" href="#__codelineno-24-213"></a>
<a id="__codelineno-24-214" name="__codelineno-24-214" href="#__codelineno-24-214"></a>            <span class="k">def</span><span class="w"> </span><span class="nf">top_3_ladder</span><span class="p">(</span><span class="n">availableLadder</span><span class="p">):</span>
<a id="__codelineno-24-215" name="__codelineno-24-215" href="#__codelineno-24-215"></a>                <span class="n">out</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-24-216" name="__codelineno-24-216" href="#__codelineno-24-216"></a>                <span class="n">price</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-24-217" name="__codelineno-24-217" href="#__codelineno-24-217"></a>                <span class="n">volume</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-24-218" name="__codelineno-24-218" href="#__codelineno-24-218"></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">availableLadder</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-24-219" name="__codelineno-24-219" href="#__codelineno-24-219"></a>                    <span class="k">return</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>        
<a id="__codelineno-24-220" name="__codelineno-24-220" href="#__codelineno-24-220"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-24-221" name="__codelineno-24-221" href="#__codelineno-24-221"></a>                    <span class="k">for</span> <span class="n">rung</span> <span class="ow">in</span> <span class="n">availableLadder</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]:</span>
<a id="__codelineno-24-222" name="__codelineno-24-222" href="#__codelineno-24-222"></a>                        <span class="n">price</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rung</span><span class="o">.</span><span class="n">price</span><span class="p">)</span>
<a id="__codelineno-24-223" name="__codelineno-24-223" href="#__codelineno-24-223"></a>                        <span class="n">volume</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rung</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
<a id="__codelineno-24-224" name="__codelineno-24-224" href="#__codelineno-24-224"></a>                    <span class="n">out</span><span class="p">[</span><span class="s2">&quot;price&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">price</span>
<a id="__codelineno-24-225" name="__codelineno-24-225" href="#__codelineno-24-225"></a>                    <span class="n">out</span><span class="p">[</span><span class="s2">&quot;volume&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">volume</span>
<a id="__codelineno-24-226" name="__codelineno-24-226" href="#__codelineno-24-226"></a>                    <span class="k">return</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
<a id="__codelineno-24-227" name="__codelineno-24-227" href="#__codelineno-24-227"></a>
<a id="__codelineno-24-228" name="__codelineno-24-228" href="#__codelineno-24-228"></a>            <span class="c1"># Sometimes t-3 mins market book is empty</span>
<a id="__codelineno-24-229" name="__codelineno-24-229" href="#__codelineno-24-229"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-24-230" name="__codelineno-24-230" href="#__codelineno-24-230"></a>                <span class="n">atb_ladder_3m</span> <span class="o">=</span> <span class="p">[</span> <span class="n">top_3_ladder</span><span class="p">(</span><span class="n">runner</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">available_to_back</span><span class="p">)</span> <span class="k">for</span> <span class="n">runner</span> <span class="ow">in</span> <span class="n">t3m_market</span><span class="o">.</span><span class="n">runners</span><span class="p">]</span>
<a id="__codelineno-24-231" name="__codelineno-24-231" href="#__codelineno-24-231"></a>                <span class="n">atl_ladder_3m</span> <span class="o">=</span> <span class="p">[</span> <span class="n">top_3_ladder</span><span class="p">(</span><span class="n">runner</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">available_to_lay</span><span class="p">)</span> <span class="k">for</span> <span class="n">runner</span> <span class="ow">in</span> <span class="n">t3m_market</span><span class="o">.</span><span class="n">runners</span><span class="p">]</span>
<a id="__codelineno-24-232" name="__codelineno-24-232" href="#__codelineno-24-232"></a>            <span class="k">except</span><span class="p">:</span>
<a id="__codelineno-24-233" name="__codelineno-24-233" href="#__codelineno-24-233"></a>                <span class="n">atb_ladder_3m</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-24-234" name="__codelineno-24-234" href="#__codelineno-24-234"></a>                <span class="n">atl_ladder_3m</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-24-235" name="__codelineno-24-235" href="#__codelineno-24-235"></a>
<a id="__codelineno-24-236" name="__codelineno-24-236" href="#__codelineno-24-236"></a>            <span class="c1"># Writing To CSV</span>
<a id="__codelineno-24-237" name="__codelineno-24-237" href="#__codelineno-24-237"></a>            <span class="c1"># ______________________</span>
<a id="__codelineno-24-238" name="__codelineno-24-238" href="#__codelineno-24-238"></a>
<a id="__codelineno-24-239" name="__codelineno-24-239" href="#__codelineno-24-239"></a>            <span class="k">for</span> <span class="p">(</span><span class="n">runnerMeta</span><span class="p">,</span> <span class="n">ltp</span><span class="p">,</span> <span class="n">selection_traded_volume</span><span class="p">,</span> <span class="n">atb_ladder_3m</span><span class="p">,</span> <span class="n">atl_ladder_3m</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">runner_data</span><span class="p">,</span> <span class="n">ltp</span><span class="p">,</span> <span class="n">selection_traded_volume</span><span class="p">,</span> <span class="n">atb_ladder_3m</span><span class="p">,</span> <span class="n">atl_ladder_3m</span><span class="p">):</span>
<a id="__codelineno-24-240" name="__codelineno-24-240" href="#__codelineno-24-240"></a>
<a id="__codelineno-24-241" name="__codelineno-24-241" href="#__codelineno-24-241"></a>                <span class="k">if</span> <span class="n">runnerMeta</span><span class="p">[</span><span class="s1">&#39;selection_status&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;REMOVED&#39;</span><span class="p">:</span>
<a id="__codelineno-24-242" name="__codelineno-24-242" href="#__codelineno-24-242"></a>
<a id="__codelineno-24-243" name="__codelineno-24-243" href="#__codelineno-24-243"></a>                    <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
<a id="__codelineno-24-244" name="__codelineno-24-244" href="#__codelineno-24-244"></a>                        <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
<a id="__codelineno-24-245" name="__codelineno-24-245" href="#__codelineno-24-245"></a>                            <span class="nb">str</span><span class="p">(</span><span class="n">final_market</span><span class="o">.</span><span class="n">market_id</span><span class="p">),</span>
<a id="__codelineno-24-246" name="__codelineno-24-246" href="#__codelineno-24-246"></a>                            <span class="n">final_market</span><span class="o">.</span><span class="n">market_definition</span><span class="o">.</span><span class="n">market_time</span><span class="p">,</span>
<a id="__codelineno-24-247" name="__codelineno-24-247" href="#__codelineno-24-247"></a>                            <span class="n">final_market</span><span class="o">.</span><span class="n">market_definition</span><span class="o">.</span><span class="n">country_code</span><span class="p">,</span>
<a id="__codelineno-24-248" name="__codelineno-24-248" href="#__codelineno-24-248"></a>                            <span class="n">final_market</span><span class="o">.</span><span class="n">market_definition</span><span class="o">.</span><span class="n">venue</span><span class="p">,</span>
<a id="__codelineno-24-249" name="__codelineno-24-249" href="#__codelineno-24-249"></a>                            <span class="n">final_market</span><span class="o">.</span><span class="n">market_definition</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-24-250" name="__codelineno-24-250" href="#__codelineno-24-250"></a>                            <span class="n">runnerMeta</span><span class="p">[</span><span class="s1">&#39;selection_id&#39;</span><span class="p">],</span>
<a id="__codelineno-24-251" name="__codelineno-24-251" href="#__codelineno-24-251"></a>                            <span class="n">runnerMeta</span><span class="p">[</span><span class="s1">&#39;selection_name&#39;</span><span class="p">],</span>
<a id="__codelineno-24-252" name="__codelineno-24-252" href="#__codelineno-24-252"></a>                            <span class="n">runnerMeta</span><span class="p">[</span><span class="s1">&#39;selection_status&#39;</span><span class="p">],</span>
<a id="__codelineno-24-253" name="__codelineno-24-253" href="#__codelineno-24-253"></a>                            <span class="n">runnerMeta</span><span class="p">[</span><span class="s1">&#39;sp&#39;</span><span class="p">],</span>
<a id="__codelineno-24-254" name="__codelineno-24-254" href="#__codelineno-24-254"></a>                            <span class="n">ltp</span><span class="p">,</span>
<a id="__codelineno-24-255" name="__codelineno-24-255" href="#__codelineno-24-255"></a>                            <span class="n">selection_traded_volume</span><span class="p">,</span>
<a id="__codelineno-24-256" name="__codelineno-24-256" href="#__codelineno-24-256"></a>                            <span class="s1">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">atb_ladder_3m</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="c1"># Forcing the dictionaries to strings so we don&#39;t run into issues loading the csvs with the dictionary commas</span>
<a id="__codelineno-24-257" name="__codelineno-24-257" href="#__codelineno-24-257"></a>                            <span class="s1">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">atl_ladder_3m</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span>
<a id="__codelineno-24-258" name="__codelineno-24-258" href="#__codelineno-24-258"></a>                        <span class="p">)</span>
<a id="__codelineno-24-259" name="__codelineno-24-259" href="#__codelineno-24-259"></a>                    <span class="p">)</span>
<a id="__codelineno-24-260" name="__codelineno-24-260" href="#__codelineno-24-260"></a>
<a id="__codelineno-24-261" name="__codelineno-24-261" href="#__codelineno-24-261"></a>
<a id="__codelineno-24-262" name="__codelineno-24-262" href="#__codelineno-24-262"></a><span class="k">def</span><span class="w"> </span><span class="nf">bet_apply_commission</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">com</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">):</span>
<a id="__codelineno-24-263" name="__codelineno-24-263" href="#__codelineno-24-263"></a>
<a id="__codelineno-24-264" name="__codelineno-24-264" href="#__codelineno-24-264"></a>    <span class="c1"># Total Market GPL</span>
<a id="__codelineno-24-265" name="__codelineno-24-265" href="#__codelineno-24-265"></a>    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;market_gpl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;market_id&#39;</span><span class="p">)[</span><span class="s1">&#39;gpl&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="nb">sum</span><span class="p">)</span>
<a id="__codelineno-24-266" name="__codelineno-24-266" href="#__codelineno-24-266"></a>
<a id="__codelineno-24-267" name="__codelineno-24-267" href="#__codelineno-24-267"></a>    <span class="c1"># Apply 5% commission</span>
<a id="__codelineno-24-268" name="__codelineno-24-268" href="#__codelineno-24-268"></a>    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;market_commission&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;market_gpl&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;market_gpl&#39;</span><span class="p">])</span>
<a id="__codelineno-24-269" name="__codelineno-24-269" href="#__codelineno-24-269"></a>
<a id="__codelineno-24-270" name="__codelineno-24-270" href="#__codelineno-24-270"></a>    <span class="c1"># Sum of Market Winning Bets</span>
<a id="__codelineno-24-271" name="__codelineno-24-271" href="#__codelineno-24-271"></a>    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;floored_gpl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;gpl&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;gpl&#39;</span><span class="p">])</span>
<a id="__codelineno-24-272" name="__codelineno-24-272" href="#__codelineno-24-272"></a>    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;market_netwinnings&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;market_id&#39;</span><span class="p">)[</span><span class="s1">&#39;floored_gpl&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="nb">sum</span><span class="p">)</span>
<a id="__codelineno-24-273" name="__codelineno-24-273" href="#__codelineno-24-273"></a>
<a id="__codelineno-24-274" name="__codelineno-24-274" href="#__codelineno-24-274"></a>    <span class="c1"># Partition Commission According to Selection GPL</span>
<a id="__codelineno-24-275" name="__codelineno-24-275" href="#__codelineno-24-275"></a>    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;commission&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;market_netwinnings&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;market_commission&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;floored_gpl&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;market_netwinnings&#39;</span><span class="p">]))</span>
<a id="__codelineno-24-276" name="__codelineno-24-276" href="#__codelineno-24-276"></a>
<a id="__codelineno-24-277" name="__codelineno-24-277" href="#__codelineno-24-277"></a>    <span class="c1"># Calculate Selection NPL</span>
<a id="__codelineno-24-278" name="__codelineno-24-278" href="#__codelineno-24-278"></a>    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;npl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;gpl&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;commission&#39;</span><span class="p">]</span>
<a id="__codelineno-24-279" name="__codelineno-24-279" href="#__codelineno-24-279"></a>
<a id="__codelineno-24-280" name="__codelineno-24-280" href="#__codelineno-24-280"></a>    <span class="c1"># Drop excess columns</span>
<a id="__codelineno-24-281" name="__codelineno-24-281" href="#__codelineno-24-281"></a>    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;floored_gpl&#39;</span><span class="p">,</span> <span class="s1">&#39;market_netwinnings&#39;</span><span class="p">,</span> <span class="s1">&#39;market_commission&#39;</span><span class="p">,</span> <span class="s1">&#39;market_gpl&#39;</span><span class="p">])</span>
<a id="__codelineno-24-282" name="__codelineno-24-282" href="#__codelineno-24-282"></a>
<a id="__codelineno-24-283" name="__codelineno-24-283" href="#__codelineno-24-283"></a>    <span class="k">return</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<a id="__codelineno-24-284" name="__codelineno-24-284" href="#__codelineno-24-284"></a>
<a id="__codelineno-24-285" name="__codelineno-24-285" href="#__codelineno-24-285"></a>
<a id="__codelineno-24-286" name="__codelineno-24-286" href="#__codelineno-24-286"></a><span class="k">def</span><span class="w"> </span><span class="nf">bet_flat</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">stake</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">back_odds</span> <span class="o">=</span> <span class="s1">&#39;market_odds&#39;</span><span class="p">,</span> <span class="n">lay_odds</span> <span class="o">=</span> <span class="s1">&#39;market_odds&#39;</span><span class="p">):</span>
<a id="__codelineno-24-287" name="__codelineno-24-287" href="#__codelineno-24-287"></a>
<a id="__codelineno-24-288" name="__codelineno-24-288" href="#__codelineno-24-288"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-24-289" name="__codelineno-24-289" href="#__codelineno-24-289"></a><span class="sd">    Betting DF should always contain: model_odds, and win (binary encoded), and the specified odds column columns</span>
<a id="__codelineno-24-290" name="__codelineno-24-290" href="#__codelineno-24-290"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-24-291" name="__codelineno-24-291" href="#__codelineno-24-291"></a>
<a id="__codelineno-24-292" name="__codelineno-24-292" href="#__codelineno-24-292"></a>    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;bet_side&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;model_odds&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">df</span><span class="p">[</span><span class="n">back_odds</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;model_odds&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">df</span><span class="p">[</span><span class="n">lay_odds</span><span class="p">]),</span>
<a id="__codelineno-24-293" name="__codelineno-24-293" href="#__codelineno-24-293"></a>                        <span class="s2">&quot;P&quot;</span><span class="p">,</span>
<a id="__codelineno-24-294" name="__codelineno-24-294" href="#__codelineno-24-294"></a>                       <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
<a id="__codelineno-24-295" name="__codelineno-24-295" href="#__codelineno-24-295"></a>                            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;model_odds&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">df</span><span class="p">[</span><span class="n">back_odds</span><span class="p">],</span>
<a id="__codelineno-24-296" name="__codelineno-24-296" href="#__codelineno-24-296"></a>                            <span class="s2">&quot;B&quot;</span><span class="p">,</span>
<a id="__codelineno-24-297" name="__codelineno-24-297" href="#__codelineno-24-297"></a>                            <span class="s2">&quot;L&quot;</span>
<a id="__codelineno-24-298" name="__codelineno-24-298" href="#__codelineno-24-298"></a>                        <span class="p">)</span>
<a id="__codelineno-24-299" name="__codelineno-24-299" href="#__codelineno-24-299"></a>                       <span class="p">)</span>
<a id="__codelineno-24-300" name="__codelineno-24-300" href="#__codelineno-24-300"></a>
<a id="__codelineno-24-301" name="__codelineno-24-301" href="#__codelineno-24-301"></a>    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;stake&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;bet_side&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;P&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">stake</span><span class="p">)</span>
<a id="__codelineno-24-302" name="__codelineno-24-302" href="#__codelineno-24-302"></a>
<a id="__codelineno-24-303" name="__codelineno-24-303" href="#__codelineno-24-303"></a>    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;gpl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;bet_side&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;B&quot;</span><span class="p">,</span> 
<a id="__codelineno-24-304" name="__codelineno-24-304" href="#__codelineno-24-304"></a>                         <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;win&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;stake&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">back_odds</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="o">-</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;stake&#39;</span><span class="p">]),</span> <span class="c1"># PL for back bets</span>
<a id="__codelineno-24-305" name="__codelineno-24-305" href="#__codelineno-24-305"></a>                         <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;win&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;stake&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">lay_odds</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;stake&#39;</span><span class="p">])</span> <span class="c1"># PL for lay bets</span>
<a id="__codelineno-24-306" name="__codelineno-24-306" href="#__codelineno-24-306"></a>                        <span class="p">)</span>   
<a id="__codelineno-24-307" name="__codelineno-24-307" href="#__codelineno-24-307"></a>
<a id="__codelineno-24-308" name="__codelineno-24-308" href="#__codelineno-24-308"></a>    <span class="c1"># Apply commission and NPL</span>
<a id="__codelineno-24-309" name="__codelineno-24-309" href="#__codelineno-24-309"></a>    <span class="n">df</span> <span class="o">=</span> <span class="n">bet_apply_commission</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<a id="__codelineno-24-310" name="__codelineno-24-310" href="#__codelineno-24-310"></a>
<a id="__codelineno-24-311" name="__codelineno-24-311" href="#__codelineno-24-311"></a>    <span class="k">return</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<a id="__codelineno-24-312" name="__codelineno-24-312" href="#__codelineno-24-312"></a>
<a id="__codelineno-24-313" name="__codelineno-24-313" href="#__codelineno-24-313"></a><span class="k">def</span><span class="w"> </span><span class="nf">bet_kelly</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">stake</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">back_odds</span> <span class="o">=</span> <span class="s1">&#39;market_odds&#39;</span><span class="p">,</span> <span class="n">lay_odds</span> <span class="o">=</span> <span class="s1">&#39;market_odds&#39;</span><span class="p">):</span>
<a id="__codelineno-24-314" name="__codelineno-24-314" href="#__codelineno-24-314"></a>
<a id="__codelineno-24-315" name="__codelineno-24-315" href="#__codelineno-24-315"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-24-316" name="__codelineno-24-316" href="#__codelineno-24-316"></a><span class="sd">    Betting DF should always contain: model_odds, and win (binary encoded), and the specified odds column columns</span>
<a id="__codelineno-24-317" name="__codelineno-24-317" href="#__codelineno-24-317"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-24-318" name="__codelineno-24-318" href="#__codelineno-24-318"></a>
<a id="__codelineno-24-319" name="__codelineno-24-319" href="#__codelineno-24-319"></a>    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;bet_side&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;model_odds&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">df</span><span class="p">[</span><span class="n">back_odds</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;model_odds&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">df</span><span class="p">[</span><span class="n">lay_odds</span><span class="p">]),</span>
<a id="__codelineno-24-320" name="__codelineno-24-320" href="#__codelineno-24-320"></a>                            <span class="s2">&quot;P&quot;</span><span class="p">,</span>
<a id="__codelineno-24-321" name="__codelineno-24-321" href="#__codelineno-24-321"></a>                            <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
<a id="__codelineno-24-322" name="__codelineno-24-322" href="#__codelineno-24-322"></a>                                <span class="n">df</span><span class="p">[</span><span class="s2">&quot;model_odds&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">df</span><span class="p">[</span><span class="n">back_odds</span><span class="p">],</span>
<a id="__codelineno-24-323" name="__codelineno-24-323" href="#__codelineno-24-323"></a>                                <span class="s2">&quot;B&quot;</span><span class="p">,</span>
<a id="__codelineno-24-324" name="__codelineno-24-324" href="#__codelineno-24-324"></a>                                <span class="s2">&quot;L&quot;</span>
<a id="__codelineno-24-325" name="__codelineno-24-325" href="#__codelineno-24-325"></a>                            <span class="p">)</span>
<a id="__codelineno-24-326" name="__codelineno-24-326" href="#__codelineno-24-326"></a>                       <span class="p">)</span>
<a id="__codelineno-24-327" name="__codelineno-24-327" href="#__codelineno-24-327"></a>
<a id="__codelineno-24-328" name="__codelineno-24-328" href="#__codelineno-24-328"></a>    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;stake&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;bet_side&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;P&quot;</span><span class="p">,</span>
<a id="__codelineno-24-329" name="__codelineno-24-329" href="#__codelineno-24-329"></a>                           <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-24-330" name="__codelineno-24-330" href="#__codelineno-24-330"></a>                           <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
<a id="__codelineno-24-331" name="__codelineno-24-331" href="#__codelineno-24-331"></a>                             <span class="n">df</span><span class="p">[</span><span class="s1">&#39;bet_side&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;B&quot;</span><span class="p">,</span>
<a id="__codelineno-24-332" name="__codelineno-24-332" href="#__codelineno-24-332"></a>                             <span class="p">(</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;model_odds&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="n">back_odds</span><span class="p">])</span> <span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="n">back_odds</span><span class="p">])),</span>
<a id="__codelineno-24-333" name="__codelineno-24-333" href="#__codelineno-24-333"></a>                             <span class="p">(</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="n">lay_odds</span><span class="p">])</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;model_odds&#39;</span><span class="p">])</span> <span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="n">lay_odds</span><span class="p">])),</span>
<a id="__codelineno-24-334" name="__codelineno-24-334" href="#__codelineno-24-334"></a>                           <span class="p">)</span>
<a id="__codelineno-24-335" name="__codelineno-24-335" href="#__codelineno-24-335"></a>                          <span class="p">)</span>
<a id="__codelineno-24-336" name="__codelineno-24-336" href="#__codelineno-24-336"></a>
<a id="__codelineno-24-337" name="__codelineno-24-337" href="#__codelineno-24-337"></a>    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;gpl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;bet_side&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;B&quot;</span><span class="p">,</span> 
<a id="__codelineno-24-338" name="__codelineno-24-338" href="#__codelineno-24-338"></a>                         <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;win&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;stake&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">back_odds</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="o">-</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;stake&#39;</span><span class="p">]),</span> <span class="c1"># PL for back bets</span>
<a id="__codelineno-24-339" name="__codelineno-24-339" href="#__codelineno-24-339"></a>                         <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;win&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;stake&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">lay_odds</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;stake&#39;</span><span class="p">])</span> <span class="c1"># PL for lay bets</span>
<a id="__codelineno-24-340" name="__codelineno-24-340" href="#__codelineno-24-340"></a>                        <span class="p">)</span>
<a id="__codelineno-24-341" name="__codelineno-24-341" href="#__codelineno-24-341"></a>
<a id="__codelineno-24-342" name="__codelineno-24-342" href="#__codelineno-24-342"></a>    <span class="c1"># Apply commission and NPL</span>
<a id="__codelineno-24-343" name="__codelineno-24-343" href="#__codelineno-24-343"></a>    <span class="n">df</span> <span class="o">=</span> <span class="n">bet_apply_commission</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<a id="__codelineno-24-344" name="__codelineno-24-344" href="#__codelineno-24-344"></a>
<a id="__codelineno-24-345" name="__codelineno-24-345" href="#__codelineno-24-345"></a>    <span class="k">return</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<a id="__codelineno-24-346" name="__codelineno-24-346" href="#__codelineno-24-346"></a>
<a id="__codelineno-24-347" name="__codelineno-24-347" href="#__codelineno-24-347"></a>
<a id="__codelineno-24-348" name="__codelineno-24-348" href="#__codelineno-24-348"></a><span class="c1"># Create simple PL and POT table</span>
<a id="__codelineno-24-349" name="__codelineno-24-349" href="#__codelineno-24-349"></a><span class="k">def</span><span class="w"> </span><span class="nf">bet_eval_metrics</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">side</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-24-350" name="__codelineno-24-350" href="#__codelineno-24-350"></a>
<a id="__codelineno-24-351" name="__codelineno-24-351" href="#__codelineno-24-351"></a>    <span class="k">if</span> <span class="n">side</span><span class="p">:</span>
<a id="__codelineno-24-352" name="__codelineno-24-352" href="#__codelineno-24-352"></a>        <span class="n">metrics</span> <span class="o">=</span> <span class="p">(</span><span class="n">d</span>
<a id="__codelineno-24-353" name="__codelineno-24-353" href="#__codelineno-24-353"></a>         <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;bet_side&#39;</span><span class="p">,</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-24-354" name="__codelineno-24-354" href="#__codelineno-24-354"></a>         <span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s2">&quot;npl&quot;</span><span class="p">:</span> <span class="s2">&quot;sum&quot;</span><span class="p">,</span> <span class="s2">&quot;stake&quot;</span><span class="p">:</span> <span class="s2">&quot;sum&quot;</span><span class="p">})</span>
<a id="__codelineno-24-355" name="__codelineno-24-355" href="#__codelineno-24-355"></a>         <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">pot</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;npl&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;stake&#39;</span><span class="p">])</span>
<a id="__codelineno-24-356" name="__codelineno-24-356" href="#__codelineno-24-356"></a>        <span class="p">)</span>
<a id="__codelineno-24-357" name="__codelineno-24-357" href="#__codelineno-24-357"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-24-358" name="__codelineno-24-358" href="#__codelineno-24-358"></a>        <span class="n">metrics</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">d</span>
<a id="__codelineno-24-359" name="__codelineno-24-359" href="#__codelineno-24-359"></a>         <span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s2">&quot;npl&quot;</span><span class="p">:</span> <span class="s2">&quot;sum&quot;</span><span class="p">,</span> <span class="s2">&quot;stake&quot;</span><span class="p">:</span> <span class="s2">&quot;sum&quot;</span><span class="p">})</span>
<a id="__codelineno-24-360" name="__codelineno-24-360" href="#__codelineno-24-360"></a>        <span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">pot</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;npl&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;stake&#39;</span><span class="p">])</span>
<a id="__codelineno-24-361" name="__codelineno-24-361" href="#__codelineno-24-361"></a>
<a id="__codelineno-24-362" name="__codelineno-24-362" href="#__codelineno-24-362"></a>    <span class="k">return</span><span class="p">(</span><span class="n">metrics</span><span class="p">[</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;stake&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">])</span>
<a id="__codelineno-24-363" name="__codelineno-24-363" href="#__codelineno-24-363"></a>
<a id="__codelineno-24-364" name="__codelineno-24-364" href="#__codelineno-24-364"></a><span class="c1"># Cumulative PL by market to visually see trend and consistency</span>
<a id="__codelineno-24-365" name="__codelineno-24-365" href="#__codelineno-24-365"></a><span class="k">def</span><span class="w"> </span><span class="nf">bet_eval_chart_cPl</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
<a id="__codelineno-24-366" name="__codelineno-24-366" href="#__codelineno-24-366"></a>
<a id="__codelineno-24-367" name="__codelineno-24-367" href="#__codelineno-24-367"></a>    <span class="n">d</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-24-368" name="__codelineno-24-368" href="#__codelineno-24-368"></a>        <span class="n">d</span>
<a id="__codelineno-24-369" name="__codelineno-24-369" href="#__codelineno-24-369"></a>        <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;market_id&#39;</span><span class="p">)</span>
<a id="__codelineno-24-370" name="__codelineno-24-370" href="#__codelineno-24-370"></a>        <span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s1">&#39;npl&#39;</span><span class="p">:</span> <span class="s1">&#39;sum&#39;</span><span class="p">})</span>
<a id="__codelineno-24-371" name="__codelineno-24-371" href="#__codelineno-24-371"></a>    <span class="p">)</span>
<a id="__codelineno-24-372" name="__codelineno-24-372" href="#__codelineno-24-372"></a>
<a id="__codelineno-24-373" name="__codelineno-24-373" href="#__codelineno-24-373"></a>    <span class="n">d</span><span class="p">[</span><span class="s1">&#39;market_number&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>
<a id="__codelineno-24-374" name="__codelineno-24-374" href="#__codelineno-24-374"></a>    <span class="n">d</span><span class="p">[</span><span class="s1">&#39;cNpl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">npl</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
<a id="__codelineno-24-375" name="__codelineno-24-375" href="#__codelineno-24-375"></a>
<a id="__codelineno-24-376" name="__codelineno-24-376" href="#__codelineno-24-376"></a>    <span class="n">chart</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;market_number&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;cNpl&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Cumulative Net Profit&#39;</span><span class="p">,</span> <span class="n">template</span><span class="o">=</span><span class="s1">&#39;simple_white&#39;</span><span class="p">)</span>
<a id="__codelineno-24-377" name="__codelineno-24-377" href="#__codelineno-24-377"></a>
<a id="__codelineno-24-378" name="__codelineno-24-378" href="#__codelineno-24-378"></a>    <span class="k">return</span><span class="p">(</span><span class="n">chart</span><span class="p">)</span>
<a id="__codelineno-24-379" name="__codelineno-24-379" href="#__codelineno-24-379"></a>
<a id="__codelineno-24-380" name="__codelineno-24-380" href="#__codelineno-24-380"></a>
<a id="__codelineno-24-381" name="__codelineno-24-381" href="#__codelineno-24-381"></a><span class="c1">#### --------------------------</span>
<a id="__codelineno-24-382" name="__codelineno-24-382" href="#__codelineno-24-382"></a><span class="c1">#### EXECUTION</span>
<a id="__codelineno-24-383" name="__codelineno-24-383" href="#__codelineno-24-383"></a><span class="c1">#### --------------------------</span>
<a id="__codelineno-24-384" name="__codelineno-24-384" href="#__codelineno-24-384"></a>
<a id="__codelineno-24-385" name="__codelineno-24-385" href="#__codelineno-24-385"></a>
<a id="__codelineno-24-386" name="__codelineno-24-386" href="#__codelineno-24-386"></a><span class="c1"># Loop through all recent history</span>
<a id="__codelineno-24-387" name="__codelineno-24-387" href="#__codelineno-24-387"></a><span class="n">dateDFList</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-24-388" name="__codelineno-24-388" href="#__codelineno-24-388"></a><span class="n">dateList</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">date</span><span class="p">(</span><span class="mi">2021</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">18</span><span class="p">),</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">-</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span><span class="n">freq</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
<a id="__codelineno-24-389" name="__codelineno-24-389" href="#__codelineno-24-389"></a>
<a id="__codelineno-24-390" name="__codelineno-24-390" href="#__codelineno-24-390"></a><span class="k">for</span> <span class="n">dte</span> <span class="ow">in</span> <span class="n">dateList</span><span class="p">:</span>
<a id="__codelineno-24-391" name="__codelineno-24-391" href="#__codelineno-24-391"></a>    <span class="n">dte</span> <span class="o">=</span> <span class="n">dte</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-24-392" name="__codelineno-24-392" href="#__codelineno-24-392"></a>    <span class="n">dateDFList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">getHubRatings</span><span class="p">(</span><span class="n">dte</span><span class="p">))</span>
<a id="__codelineno-24-393" name="__codelineno-24-393" href="#__codelineno-24-393"></a>
<a id="__codelineno-24-394" name="__codelineno-24-394" href="#__codelineno-24-394"></a><span class="c1"># Concatenate (add rows to rows) all the dataframes within the list</span>
<a id="__codelineno-24-395" name="__codelineno-24-395" href="#__codelineno-24-395"></a><span class="n">hubRatings</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">dateDFList</span><span class="p">)</span>
<a id="__codelineno-24-396" name="__codelineno-24-396" href="#__codelineno-24-396"></a>
<a id="__codelineno-24-397" name="__codelineno-24-397" href="#__codelineno-24-397"></a><span class="c1"># create trading instance (don&#39;t need username/password)</span>
<a id="__codelineno-24-398" name="__codelineno-24-398" href="#__codelineno-24-398"></a><span class="n">trading</span> <span class="o">=</span> <span class="n">betfairlightweight</span><span class="o">.</span><span class="n">APIClient</span><span class="p">(</span><span class="s2">&quot;username&quot;</span><span class="p">,</span> <span class="s2">&quot;password&quot;</span><span class="p">)</span>
<a id="__codelineno-24-399" name="__codelineno-24-399" href="#__codelineno-24-399"></a>
<a id="__codelineno-24-400" name="__codelineno-24-400" href="#__codelineno-24-400"></a><span class="c1"># create listener</span>
<a id="__codelineno-24-401" name="__codelineno-24-401" href="#__codelineno-24-401"></a><span class="n">listener</span> <span class="o">=</span> <span class="n">StreamListener</span><span class="p">(</span><span class="n">max_latency</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-24-402" name="__codelineno-24-402" href="#__codelineno-24-402"></a>
<a id="__codelineno-24-403" name="__codelineno-24-403" href="#__codelineno-24-403"></a><span class="c1"># This will execute the files (it took me ~2 hours for 2 months of data)</span>
<a id="__codelineno-24-404" name="__codelineno-24-404" href="#__codelineno-24-404"></a><span class="n">run_stream_parsing</span><span class="p">()</span>
<a id="__codelineno-24-405" name="__codelineno-24-405" href="#__codelineno-24-405"></a>
<a id="__codelineno-24-406" name="__codelineno-24-406" href="#__codelineno-24-406"></a><span class="c1"># Load in odds file we created above</span>
<a id="__codelineno-24-407" name="__codelineno-24-407" href="#__codelineno-24-407"></a><span class="n">bfOdds</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;outputs/tho-odds.csv&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;market_id&#39;</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="s1">&#39;selection_id&#39;</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="s1">&#39;atb_ladder_3m&#39;</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="s1">&#39;atl_ladder_3m&#39;</span><span class="p">:</span> <span class="nb">object</span><span class="p">})</span>
<a id="__codelineno-24-408" name="__codelineno-24-408" href="#__codelineno-24-408"></a>
<a id="__codelineno-24-409" name="__codelineno-24-409" href="#__codelineno-24-409"></a><span class="c1"># Convert dictionary columns</span>
<a id="__codelineno-24-410" name="__codelineno-24-410" href="#__codelineno-24-410"></a><span class="kn">import</span><span class="w"> </span><span class="nn">ast</span>
<a id="__codelineno-24-411" name="__codelineno-24-411" href="#__codelineno-24-411"></a><span class="n">bfOdds</span><span class="p">[</span><span class="s1">&#39;atb_ladder_3m&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">bfOdds</span><span class="p">[</span><span class="s1">&#39;atb_ladder_3m&#39;</span><span class="p">]]</span>
<a id="__codelineno-24-412" name="__codelineno-24-412" href="#__codelineno-24-412"></a><span class="n">bfOdds</span><span class="p">[</span><span class="s1">&#39;atl_ladder_3m&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">bfOdds</span><span class="p">[</span><span class="s1">&#39;atl_ladder_3m&#39;</span><span class="p">]]</span>
<a id="__codelineno-24-413" name="__codelineno-24-413" href="#__codelineno-24-413"></a>
<a id="__codelineno-24-414" name="__codelineno-24-414" href="#__codelineno-24-414"></a><span class="c1"># Convert LTP to Numeric</span>
<a id="__codelineno-24-415" name="__codelineno-24-415" href="#__codelineno-24-415"></a><span class="n">bfOdds</span><span class="p">[</span><span class="s1">&#39;ltp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">bfOdds</span><span class="p">[</span><span class="s1">&#39;ltp&#39;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;coerce&#39;</span><span class="p">)</span>
<a id="__codelineno-24-416" name="__codelineno-24-416" href="#__codelineno-24-416"></a>
<a id="__codelineno-24-417" name="__codelineno-24-417" href="#__codelineno-24-417"></a><span class="c1"># Filter after 18th Feb</span>
<a id="__codelineno-24-418" name="__codelineno-24-418" href="#__codelineno-24-418"></a><span class="n">bfOdds</span> <span class="o">=</span> <span class="n">bfOdds</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;event_date &gt;= &quot;2021-02-18&quot;&#39;</span><span class="p">)</span>
<a id="__codelineno-24-419" name="__codelineno-24-419" href="#__codelineno-24-419"></a>
<a id="__codelineno-24-420" name="__codelineno-24-420" href="#__codelineno-24-420"></a><span class="c1"># Joining the ratings data and odds data and combining</span>
<a id="__codelineno-24-421" name="__codelineno-24-421" href="#__codelineno-24-421"></a><span class="n">rawDF</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
<a id="__codelineno-24-422" name="__codelineno-24-422" href="#__codelineno-24-422"></a>        <span class="n">hubRatings</span><span class="p">[</span><span class="n">hubRatings</span><span class="p">[</span><span class="s1">&#39;market_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">bfOdds</span><span class="o">.</span><span class="n">market_id</span><span class="o">.</span><span class="n">unique</span><span class="p">())],</span> 
<a id="__codelineno-24-423" name="__codelineno-24-423" href="#__codelineno-24-423"></a>        <span class="n">bfOdds</span><span class="p">[[</span><span class="s1">&#39;market_name&#39;</span><span class="p">,</span> <span class="s1">&#39;market_id&#39;</span><span class="p">,</span> <span class="s1">&#39;selection_id&#39;</span><span class="p">,</span> <span class="s1">&#39;result&#39;</span><span class="p">,</span> <span class="s1">&#39;matched_volume&#39;</span><span class="p">,</span> <span class="s1">&#39;bsp&#39;</span><span class="p">,</span> <span class="s1">&#39;ltp&#39;</span><span class="p">,</span> <span class="s1">&#39;atb_ladder_3m&#39;</span><span class="p">,</span> <span class="s1">&#39;atl_ladder_3m&#39;</span><span class="p">]],</span>
<a id="__codelineno-24-424" name="__codelineno-24-424" href="#__codelineno-24-424"></a>        <span class="n">on</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;market_id&#39;</span><span class="p">,</span> <span class="s1">&#39;selection_id&#39;</span><span class="p">],</span>
<a id="__codelineno-24-425" name="__codelineno-24-425" href="#__codelineno-24-425"></a>        <span class="n">how</span> <span class="o">=</span> <span class="s1">&#39;inner&#39;</span>
<a id="__codelineno-24-426" name="__codelineno-24-426" href="#__codelineno-24-426"></a>    <span class="p">)</span>
<a id="__codelineno-24-427" name="__codelineno-24-427" href="#__codelineno-24-427"></a>
<a id="__codelineno-24-428" name="__codelineno-24-428" href="#__codelineno-24-428"></a><span class="c1"># Join and clean up columns</span>
<a id="__codelineno-24-429" name="__codelineno-24-429" href="#__codelineno-24-429"></a><span class="n">df</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-24-430" name="__codelineno-24-430" href="#__codelineno-24-430"></a>    <span class="n">rawDF</span>
<a id="__codelineno-24-431" name="__codelineno-24-431" href="#__codelineno-24-431"></a>    <span class="c1"># Extra Best Back + Lay 3 mins before of</span>
<a id="__codelineno-24-432" name="__codelineno-24-432" href="#__codelineno-24-432"></a>    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">best_back_3m</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;price&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;price&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;atb_ladder_3m&#39;</span><span class="p">]])</span>
<a id="__codelineno-24-433" name="__codelineno-24-433" href="#__codelineno-24-433"></a>    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">best_lay_3m</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;price&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;price&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;atl_ladder_3m&#39;</span><span class="p">]])</span>
<a id="__codelineno-24-434" name="__codelineno-24-434" href="#__codelineno-24-434"></a>    <span class="c1"># Coalesce LTP to BSP (about 60 rows)</span>
<a id="__codelineno-24-435" name="__codelineno-24-435" href="#__codelineno-24-435"></a>    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">ltp</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;ltp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">(),</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;bsp&quot;</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;ltp&quot;</span><span class="p">]))</span>
<a id="__codelineno-24-436" name="__codelineno-24-436" href="#__codelineno-24-436"></a>    <span class="c1"># Add a binary win / loss column</span>
<a id="__codelineno-24-437" name="__codelineno-24-437" href="#__codelineno-24-437"></a>    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">win</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;WINNER&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
<a id="__codelineno-24-438" name="__codelineno-24-438" href="#__codelineno-24-438"></a>    <span class="c1"># Extra columns</span>
<a id="__codelineno-24-439" name="__codelineno-24-439" href="#__codelineno-24-439"></a>    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">model_prob</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;model_odds&#39;</span><span class="p">])</span>
<a id="__codelineno-24-440" name="__codelineno-24-440" href="#__codelineno-24-440"></a>    <span class="c1"># Reorder Columns</span>
<a id="__codelineno-24-441" name="__codelineno-24-441" href="#__codelineno-24-441"></a>    <span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;track&#39;</span><span class="p">,</span> <span class="s1">&#39;race_number&#39;</span><span class="p">,</span> <span class="s1">&#39;market_id&#39;</span><span class="p">,</span> <span class="s1">&#39;selection_id&#39;</span><span class="p">,</span> <span class="s1">&#39;bsp&#39;</span><span class="p">,</span> <span class="s1">&#39;ltp&#39;</span><span class="p">,</span><span class="s1">&#39;best_back_3m&#39;</span><span class="p">,</span><span class="s1">&#39;best_lay_3m&#39;</span><span class="p">,</span><span class="s1">&#39;atb_ladder_3m&#39;</span><span class="p">,</span> <span class="s1">&#39;atl_ladder_3m&#39;</span><span class="p">,</span> <span class="s1">&#39;model_prob&#39;</span><span class="p">,</span> <span class="s1">&#39;model_odds&#39;</span><span class="p">,</span> <span class="s1">&#39;win&#39;</span><span class="p">])</span>
<a id="__codelineno-24-442" name="__codelineno-24-442" href="#__codelineno-24-442"></a>
<a id="__codelineno-24-443" name="__codelineno-24-443" href="#__codelineno-24-443"></a><span class="p">)</span>
<a id="__codelineno-24-444" name="__codelineno-24-444" href="#__codelineno-24-444"></a>
<a id="__codelineno-24-445" name="__codelineno-24-445" href="#__codelineno-24-445"></a>
<a id="__codelineno-24-446" name="__codelineno-24-446" href="#__codelineno-24-446"></a><span class="n">bets</span> <span class="o">=</span> <span class="n">bet_flat</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">stake</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">back_odds</span> <span class="o">=</span> <span class="s1">&#39;bsp&#39;</span><span class="p">,</span> <span class="n">lay_odds</span> <span class="o">=</span> <span class="s1">&#39;bsp&#39;</span><span class="p">)</span>
<a id="__codelineno-24-447" name="__codelineno-24-447" href="#__codelineno-24-447"></a>
<a id="__codelineno-24-448" name="__codelineno-24-448" href="#__codelineno-24-448"></a><span class="n">bet_eval_metrics</span><span class="p">(</span><span class="n">bets</span><span class="p">,</span> <span class="n">side</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-24-449" name="__codelineno-24-449" href="#__codelineno-24-449"></a>
<a id="__codelineno-24-450" name="__codelineno-24-450" href="#__codelineno-24-450"></a><span class="n">bet_eval_chart_cPl</span><span class="p">(</span><span class="n">bets</span><span class="p">)</span>
<a id="__codelineno-24-451" name="__codelineno-24-451" href="#__codelineno-24-451"></a>
<a id="__codelineno-24-452" name="__codelineno-24-452" href="#__codelineno-24-452"></a>
<a id="__codelineno-24-453" name="__codelineno-24-453" href="#__codelineno-24-453"></a><span class="c1"># We&#39;ll test a 2 different staking schemes on 3 different price points</span>
<a id="__codelineno-24-454" name="__codelineno-24-454" href="#__codelineno-24-454"></a><span class="n">grid</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-24-455" name="__codelineno-24-455" href="#__codelineno-24-455"></a>        <span class="s2">&quot;flat_bsp&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">bet_flat</span><span class="p">,</span> <span class="s2">&quot;bsp&quot;</span><span class="p">,</span> <span class="s2">&quot;bsp&quot;</span><span class="p">),</span>
<a id="__codelineno-24-456" name="__codelineno-24-456" href="#__codelineno-24-456"></a>        <span class="s2">&quot;flat_ltp&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">bet_flat</span><span class="p">,</span> <span class="s2">&quot;ltp&quot;</span><span class="p">,</span> <span class="s2">&quot;ltp&quot;</span><span class="p">),</span>
<a id="__codelineno-24-457" name="__codelineno-24-457" href="#__codelineno-24-457"></a>        <span class="s2">&quot;flat_3m&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">bet_flat</span><span class="p">,</span> <span class="s2">&quot;best_back_3m&quot;</span><span class="p">,</span> <span class="s2">&quot;best_lay_3m&quot;</span><span class="p">),</span>
<a id="__codelineno-24-458" name="__codelineno-24-458" href="#__codelineno-24-458"></a>        <span class="s2">&quot;kelly_bsp&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">bet_kelly</span><span class="p">,</span> <span class="s2">&quot;bsp&quot;</span><span class="p">,</span> <span class="s2">&quot;bsp&quot;</span><span class="p">),</span>
<a id="__codelineno-24-459" name="__codelineno-24-459" href="#__codelineno-24-459"></a>        <span class="s2">&quot;kelly_ltp&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">bet_kelly</span><span class="p">,</span> <span class="s2">&quot;ltp&quot;</span><span class="p">,</span> <span class="s2">&quot;ltp&quot;</span><span class="p">),</span>
<a id="__codelineno-24-460" name="__codelineno-24-460" href="#__codelineno-24-460"></a>        <span class="s2">&quot;kelly_3m&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">bet_kelly</span><span class="p">,</span> <span class="s2">&quot;best_back_3m&quot;</span><span class="p">,</span> <span class="s2">&quot;best_lay_3m&quot;</span><span class="p">)</span>
<a id="__codelineno-24-461" name="__codelineno-24-461" href="#__codelineno-24-461"></a>    <span class="p">}</span>
<a id="__codelineno-24-462" name="__codelineno-24-462" href="#__codelineno-24-462"></a>
<a id="__codelineno-24-463" name="__codelineno-24-463" href="#__codelineno-24-463"></a>
<a id="__codelineno-24-464" name="__codelineno-24-464" href="#__codelineno-24-464"></a><span class="c1"># Evaluate Metrics For Strategy Grid</span>
<a id="__codelineno-24-465" name="__codelineno-24-465" href="#__codelineno-24-465"></a><span class="n">metricSummary</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-24-466" name="__codelineno-24-466" href="#__codelineno-24-466"></a><span class="k">for</span> <span class="n">strategy</span><span class="p">,</span> <span class="n">objects</span> <span class="ow">in</span> <span class="n">grid</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-24-467" name="__codelineno-24-467" href="#__codelineno-24-467"></a>
<a id="__codelineno-24-468" name="__codelineno-24-468" href="#__codelineno-24-468"></a>    <span class="c1"># Assemble bets based on staking function and odds column</span>
<a id="__codelineno-24-469" name="__codelineno-24-469" href="#__codelineno-24-469"></a>    <span class="c1"># objects[0] is the staking function itself</span>
<a id="__codelineno-24-470" name="__codelineno-24-470" href="#__codelineno-24-470"></a>    <span class="n">bets</span> <span class="o">=</span> <span class="n">objects</span><span class="p">[</span><span class="mi">0</span><span class="p">](</span><span class="n">df</span><span class="p">,</span> <span class="n">back_odds</span> <span class="o">=</span> <span class="n">objects</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">lay_odds</span> <span class="o">=</span> <span class="n">objects</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
<a id="__codelineno-24-471" name="__codelineno-24-471" href="#__codelineno-24-471"></a>
<a id="__codelineno-24-472" name="__codelineno-24-472" href="#__codelineno-24-472"></a>    <span class="n">betMetrics</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-24-473" name="__codelineno-24-473" href="#__codelineno-24-473"></a>        <span class="n">bet_eval_metrics</span><span class="p">(</span><span class="n">bets</span><span class="p">)</span>
<a id="__codelineno-24-474" name="__codelineno-24-474" href="#__codelineno-24-474"></a>        <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">strategy</span><span class="p">)</span>
<a id="__codelineno-24-475" name="__codelineno-24-475" href="#__codelineno-24-475"></a>        <span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;strategy&#39;</span><span class="p">,</span> <span class="s1">&#39;stake&#39;</span><span class="p">,</span> <span class="s1">&#39;npl&#39;</span><span class="p">,</span> <span class="s1">&#39;pot&#39;</span><span class="p">])</span>
<a id="__codelineno-24-476" name="__codelineno-24-476" href="#__codelineno-24-476"></a>    <span class="p">)</span>
<a id="__codelineno-24-477" name="__codelineno-24-477" href="#__codelineno-24-477"></a>
<a id="__codelineno-24-478" name="__codelineno-24-478" href="#__codelineno-24-478"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-24-479" name="__codelineno-24-479" href="#__codelineno-24-479"></a>        <span class="n">metricSummary</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">metricSummary</span><span class="p">,</span> <span class="n">betMetrics</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-24-480" name="__codelineno-24-480" href="#__codelineno-24-480"></a>    <span class="k">except</span><span class="p">:</span>
<a id="__codelineno-24-481" name="__codelineno-24-481" href="#__codelineno-24-481"></a>        <span class="n">metricSummary</span> <span class="o">=</span> <span class="n">betMetrics</span>
<a id="__codelineno-24-482" name="__codelineno-24-482" href="#__codelineno-24-482"></a>
<a id="__codelineno-24-483" name="__codelineno-24-483" href="#__codelineno-24-483"></a><span class="n">metricSummary</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;pot&#39;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-24-484" name="__codelineno-24-484" href="#__codelineno-24-484"></a>
<a id="__codelineno-24-485" name="__codelineno-24-485" href="#__codelineno-24-485"></a>
<a id="__codelineno-24-486" name="__codelineno-24-486" href="#__codelineno-24-486"></a><span class="c1"># Compare Cumulative PL Charts</span>
<a id="__codelineno-24-487" name="__codelineno-24-487" href="#__codelineno-24-487"></a><span class="n">cumulativePLs</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-24-488" name="__codelineno-24-488" href="#__codelineno-24-488"></a><span class="k">for</span> <span class="n">strategy</span><span class="p">,</span> <span class="n">objects</span> <span class="ow">in</span> <span class="n">grid</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-24-489" name="__codelineno-24-489" href="#__codelineno-24-489"></a>
<a id="__codelineno-24-490" name="__codelineno-24-490" href="#__codelineno-24-490"></a>    <span class="c1"># Assemble bets based on staking function and odds column</span>
<a id="__codelineno-24-491" name="__codelineno-24-491" href="#__codelineno-24-491"></a>    <span class="n">bets</span> <span class="o">=</span> <span class="n">objects</span><span class="p">[</span><span class="mi">0</span><span class="p">](</span><span class="n">df</span><span class="p">,</span> <span class="n">back_odds</span> <span class="o">=</span> <span class="n">objects</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">lay_odds</span> <span class="o">=</span> <span class="n">objects</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
<a id="__codelineno-24-492" name="__codelineno-24-492" href="#__codelineno-24-492"></a>
<a id="__codelineno-24-493" name="__codelineno-24-493" href="#__codelineno-24-493"></a>    <span class="n">d</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-24-494" name="__codelineno-24-494" href="#__codelineno-24-494"></a>           <span class="n">bets</span>
<a id="__codelineno-24-495" name="__codelineno-24-495" href="#__codelineno-24-495"></a>           <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;market_id&#39;</span><span class="p">)</span>
<a id="__codelineno-24-496" name="__codelineno-24-496" href="#__codelineno-24-496"></a>           <span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s1">&#39;npl&#39;</span><span class="p">:</span> <span class="s1">&#39;sum&#39;</span><span class="p">,</span> <span class="s1">&#39;stake&#39;</span><span class="p">:</span> <span class="s1">&#39;sum&#39;</span><span class="p">})</span>
<a id="__codelineno-24-497" name="__codelineno-24-497" href="#__codelineno-24-497"></a>    <span class="p">)</span>
<a id="__codelineno-24-498" name="__codelineno-24-498" href="#__codelineno-24-498"></a>
<a id="__codelineno-24-499" name="__codelineno-24-499" href="#__codelineno-24-499"></a>    <span class="n">d</span><span class="p">[</span><span class="s1">&#39;market_number&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>
<a id="__codelineno-24-500" name="__codelineno-24-500" href="#__codelineno-24-500"></a>    <span class="c1"># Normalise to $10,000 stake for visual comparison</span>
<a id="__codelineno-24-501" name="__codelineno-24-501" href="#__codelineno-24-501"></a>    <span class="n">d</span><span class="p">[</span><span class="s1">&#39;npl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;npl&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">stake</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="mi">10000</span><span class="p">)</span>
<a id="__codelineno-24-502" name="__codelineno-24-502" href="#__codelineno-24-502"></a>    <span class="n">d</span><span class="p">[</span><span class="s1">&#39;cNpl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">npl</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
<a id="__codelineno-24-503" name="__codelineno-24-503" href="#__codelineno-24-503"></a>    <span class="n">d</span><span class="p">[</span><span class="s1">&#39;strategy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">strategy</span>
<a id="__codelineno-24-504" name="__codelineno-24-504" href="#__codelineno-24-504"></a>
<a id="__codelineno-24-505" name="__codelineno-24-505" href="#__codelineno-24-505"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-24-506" name="__codelineno-24-506" href="#__codelineno-24-506"></a>        <span class="n">cumulativePLs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">cumulativePLs</span><span class="p">,</span> <span class="n">d</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-24-507" name="__codelineno-24-507" href="#__codelineno-24-507"></a>    <span class="k">except</span><span class="p">:</span>
<a id="__codelineno-24-508" name="__codelineno-24-508" href="#__codelineno-24-508"></a>        <span class="n">cumulativePLs</span> <span class="o">=</span> <span class="n">d</span>
<a id="__codelineno-24-509" name="__codelineno-24-509" href="#__codelineno-24-509"></a>
<a id="__codelineno-24-510" name="__codelineno-24-510" href="#__codelineno-24-510"></a><span class="n">px</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">cumulativePLs</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;market_number&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;cNpl&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;strategy&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Cumulative Net Profit&#39;</span><span class="p">,</span> <span class="n">template</span><span class="o">=</span><span class="s1">&#39;simple_white&#39;</span><span class="p">)</span>
<a id="__codelineno-24-511" name="__codelineno-24-511" href="#__codelineno-24-511"></a>
<a id="__codelineno-24-512" name="__codelineno-24-512" href="#__codelineno-24-512"></a>
<a id="__codelineno-24-513" name="__codelineno-24-513" href="#__codelineno-24-513"></a><span class="n">bets</span> <span class="o">=</span> <span class="n">bet_kelly</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">back_odds</span> <span class="o">=</span> <span class="s1">&#39;ltp&#39;</span><span class="p">,</span> <span class="n">lay_odds</span> <span class="o">=</span> <span class="s1">&#39;ltp&#39;</span><span class="p">)</span>
<a id="__codelineno-24-514" name="__codelineno-24-514" href="#__codelineno-24-514"></a>
<a id="__codelineno-24-515" name="__codelineno-24-515" href="#__codelineno-24-515"></a><span class="n">metricSummary</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-24-516" name="__codelineno-24-516" href="#__codelineno-24-516"></a>
<a id="__codelineno-24-517" name="__codelineno-24-517" href="#__codelineno-24-517"></a><span class="k">for</span> <span class="n">bVal</span> <span class="ow">in</span> <span class="p">[</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">]:</span>
<a id="__codelineno-24-518" name="__codelineno-24-518" href="#__codelineno-24-518"></a>    <span class="k">for</span> <span class="n">lVal</span> <span class="ow">in</span> <span class="p">[</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">]:</span>
<a id="__codelineno-24-519" name="__codelineno-24-519" href="#__codelineno-24-519"></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">bets</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;((ltp-model_odds) / ltp) &gt; </span><span class="si">{}</span><span class="s1">  | ((model_odds-ltp) / ltp) &gt; </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bVal</span><span class="p">,</span> <span class="n">lVal</span><span class="p">))</span>
<a id="__codelineno-24-520" name="__codelineno-24-520" href="#__codelineno-24-520"></a>
<a id="__codelineno-24-521" name="__codelineno-24-521" href="#__codelineno-24-521"></a>        <span class="n">betMetrics</span> <span class="o">=</span> <span class="n">bet_eval_metrics</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">side</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-24-522" name="__codelineno-24-522" href="#__codelineno-24-522"></a>        <span class="n">betMetrics</span><span class="p">[</span><span class="s1">&#39;bVal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bVal</span>
<a id="__codelineno-24-523" name="__codelineno-24-523" href="#__codelineno-24-523"></a>        <span class="n">betMetrics</span><span class="p">[</span><span class="s1">&#39;lVal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lVal</span>
<a id="__codelineno-24-524" name="__codelineno-24-524" href="#__codelineno-24-524"></a>
<a id="__codelineno-24-525" name="__codelineno-24-525" href="#__codelineno-24-525"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-24-526" name="__codelineno-24-526" href="#__codelineno-24-526"></a>            <span class="n">metricSummary</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">metricSummary</span><span class="p">,</span> <span class="n">betMetrics</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-24-527" name="__codelineno-24-527" href="#__codelineno-24-527"></a>        <span class="k">except</span><span class="p">:</span>
<a id="__codelineno-24-528" name="__codelineno-24-528" href="#__codelineno-24-528"></a>            <span class="n">metricSummary</span> <span class="o">=</span> <span class="n">betMetrics</span>
<a id="__codelineno-24-529" name="__codelineno-24-529" href="#__codelineno-24-529"></a>
<a id="__codelineno-24-530" name="__codelineno-24-530" href="#__codelineno-24-530"></a><span class="n">metricSummary</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;pot&#39;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<a id="__codelineno-24-531" name="__codelineno-24-531" href="#__codelineno-24-531"></a>
<a id="__codelineno-24-532" name="__codelineno-24-532" href="#__codelineno-24-532"></a><span class="n">betsFilters</span> <span class="o">=</span> <span class="n">bets</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;((ltp-model_odds) / ltp) &gt; </span><span class="si">{}</span><span class="s1">  | ((model_odds-ltp) / ltp) &gt; </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">))</span>
<a id="__codelineno-24-533" name="__codelineno-24-533" href="#__codelineno-24-533"></a><span class="n">bet_eval_chart_cPl</span><span class="p">(</span><span class="n">betsFilters</span><span class="p">)</span>
</code></pre></div>
<hr />
<h3 id="disclaimer">Disclaimer</h3>
<p>Note that whilst models and automated strategies are fun and rewarding to create, we can't promise that your model or betting strategy will be profitable, and we make no representations in relation to the code shared or information on this page. If you're using this code or implementing your own strategies, you do so entirely at your own risk and you are responsible for any winnings/losses incurred. Under no circumstances will Betfair be liable for any loss or damage you suffer.</p>









  




                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
    
      <nav class="md-footer__inner md-grid" aria-label="footer.title">
        
          
          <a href="../jsonToCsvRevisited/" class="md-footer__link md-footer__link--prev" aria-label="Previous: JSON to CSV | Revisited" rel="prev">
            <div class="md-footer__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <div class="md-ellipsis">
                <span class="md-footer__direction">
                  Previous
                </span>
                JSON to CSV | Revisited
              </div>
            </div>
          </a>
        
        
          
          <a href="../automatedBettingAnglesTutorial/" class="md-footer__link md-footer__link--next" aria-label="Next: Automated betting angles in Python" rel="next">
            <div class="md-footer__title">
              <div class="md-ellipsis">
                <span class="md-footer__direction">
                  Next
                </span>
                Automated betting angles in Python
              </div>
            </div>
            <div class="md-footer__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
    <div class="md-footer-meta md-typeset">
      <div class="md-footer-meta__inner md-grid">
        <div class="md-copyright">
  
  
</div>
        
          <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://twitter.com/Betfair_Aus" target="_blank" rel="noopener" title="twitter.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://linkedin.com/company/betfair-australia" target="_blank" rel="noopener" title="linkedin.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3M135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5m282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://facebook.com/betfairaustralia" target="_blank" rel="noopener" title="facebook.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M512 256C512 114.6 397.4 0 256 0S0 114.6 0 256c0 120 82.7 220.8 194.2 248.5V334.2h-52.8V256h52.8v-33.7c0-87.1 39.4-127.5 125-127.5 16.2 0 44.2 3.2 55.7 6.4V172c-6-.6-16.5-1-29.6-1-42 0-58.2 15.9-58.2 57.2V256h83.6l-14.4 78.2H287v175.9C413.8 494.8 512 386.9 512 256"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://youtube.com/user/betfairaus" target="_blank" rel="noopener" title="youtube.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M549.655 124.083c-6.281-23.65-24.787-42.276-48.284-48.597C458.781 64 288 64 288 64S117.22 64 74.629 75.486c-23.497 6.322-42.003 24.947-48.284 48.597-11.412 42.867-11.412 132.305-11.412 132.305s0 89.438 11.412 132.305c6.281 23.65 24.787 41.5 48.284 47.821C117.22 448 288 448 288 448s170.78 0 213.371-11.486c23.497-6.321 42.003-24.171 48.284-47.821 11.412-42.867 11.412-132.305 11.412-132.305s0-89.438-11.412-132.305m-317.51 213.508V175.185l142.739 81.205z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://github.com/betfair-datascientists" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
</div>
        
      </div>

      <div class="bf-footer">
          <div class="bf-footer-inner">
              <p class="bf-light">Betfair Pty Limited is licensed and regulated by the Northern Territory Government of Australia.</p>
              <p class="bf-dark">Betfair Pty Limited's gambling operations are governed by its <a class='inner-link' href="https://www.betfair.com.au/info/responsible-gambling/">Responsible Gambling Code of Conduct</a> and for South
              Australian residents by the <a class='inner-link' href="https://www.betfair.com.au/info/pdf/SA-GCoP.pdf">South Australian Responsible Gambling Code of Practice.</a></p>
              <p class="bf-dark">BetStop is the Australian National Self-Exclusion Register. For more information, please visit <a class="inner-link" href="https://betstop.gov.au">https://betstop.gov.au</a><br /> <div class="full-screen"> <p style="font-family: Arial, sans-serif; font-size: 1.2rem; font-weight: bold; text-align: center;">What&#39s gambling really costing you&#63</p> <p style="font-family: Arial, sans-serif; font-size: 0.8rem; font-weight: bold; text-align: center;">For free and confidential support call 1800 858 858 or visit <a href="http://www.gamblinghelponline.org.au" style="color: black; text-decoration: underline;">gamblinghelponline.org.au</a></p> </div> </p>
              <ul class="bf-links">
                <li><a href="https://www.betfair.com.au/hub/help/account-help/responsible-gambling/">Responsible Gambling</a><span>|</span></li>
                <li><a href="http://www.betfair.com/AUS_NZL/aboutUs/Terms.and.Conditions/">Terms & Conditions</a><span>|</span></li>
                <li><a href="https://www.betfair.com.au/info/privacy-policy/">Privacy Policy</a><span>|</span></li>
                <li><a href="http://www.betfair.com/en/aboutUs/Rules.and.Regulations/">Rules & Regulations</a><span>|</span></li>
                <li><a href="https://www.betfair.com/AUS_NZL/aboutUs/Dispute.Resolution">Dispute Resolution</a></li>
              </ul>
          </div>
      </div>
    </div>

    <script src="https://js.adsrvr.org/up_loader.1.1.0.js" type="text/javascript"></script>
    <script type="text/javascript">
        ttd_dom_ready( function() {
            if (typeof TTDUniversalPixelApi === 'function') {
                var universalPixelApi = new TTDUniversalPixelApi();
                universalPixelApi.init("y12d1ir", ["8ml4f17"], "https://insight.adsrvr.org/track/up");
            }
        });
    </script>

</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["toc.integrate", "navigation.instant", "navigation.tabs", "navigation.top", "navigation.expand", "navigation.sections", "search.suggest", "search.highlight", "search.share"], "search": "../../assets/javascripts/workers/search.f8cc74c7.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.f1b6f286.min.js"></script>
      
        <script src="../../js/scripts.js"></script>
      
    
  </body>
</html>