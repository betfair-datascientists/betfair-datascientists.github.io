
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Documentation, guides and articles on creating, developing and implementing automated betting strategies, using data analysis to inform betting models and how to interact with the Betfair API.">
      
      
        <meta name="author" content="Betfair Data Scientists">
      
      
        <link rel="canonical" href="https://betfair-datascientists.github.io/tutorials/jsonToCsvRevisited/">
      
      
        <link rel="prev" href="../processingTarFiles101/">
      
      
        <link rel="next" href="../backtestingRatingsTutorial/">
      
      
      <link rel="icon" href="../../img/BetfairFavicon.ico">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.42">
    
    
      
        <title>JSON to CSV | Revisited - The Automation Hub</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.0253249f.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/betfair.css">
    
      <link rel="stylesheet" href="../../css/buttons_and_animations.css">
    
      <link rel="stylesheet" href="../../css/fonts.css">
    
      <link rel="stylesheet" href="../../css/ansi-colours.css">
    
      <link rel="stylesheet" href="../../css/jupyter-cells.css">
    
      <link rel="stylesheet" href="../../css/pandas-dataframe.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","UA-125973915-1"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","UA-125973915-1",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=UA-125973915-1",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="betfair" data-md-color-primary="amber" data-md-color-accent="orange">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#json-to-csv-revisited" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      
  
  <header class="md-header" data-md-component="header">
    <nav class="md-header__inner md-grid" aria-label="header.title">
      <a href="../.." title="The Automation Hub" class="md-header__button md-logo" aria-label="The Automation Hub" data-md-component="logo">
        
  <img src="../../img/logo.svg" alt="logo">

      </a>
      <label class="md-header__button md-icon" for="__drawer">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
      </label>
      <div class="md-header__title" data-md-component="header-title">
        <div class="md-header__ellipsis">
          <div class="md-header__topic">
            <span class="md-ellipsis">
              The Automation Hub
            </span>
          </div>
          <div class="md-header__topic" data-md-component="header-topic">
            <span class="md-ellipsis">
              
                JSON to CSV | Revisited
              
            </span>
          </div>
        </div>
      </div>

      
        <form class="md-header__option" data-md-component="palette">
          
            
            
            <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="betfair" data-md-color-primary="amber" data-md-color-accent="orange"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
            
              <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg>
              </label>
            
          
            
            
            <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="amber" data-md-color-accent="orange"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
            
              <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"/></svg>
              </label>
            
          
        </form>
      
      

      
     
      <div class="bf-nav">
        <a class="bf-hidable" href="https://www.betfair.com.au/exchange/plus/"><svg class="exchangeLogo" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:cc="http://creativecommons.org/ns#"
          xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 38.775 4.59" width="24" height="17">
          <path class="st1" d="m 160.3,-136.95 v 26" />
          <g transform="translate(18.8,-137.15)">
            <path d="m 2.2901089,126.53441 v 5.20093 H -3.3107216 L 7.4888397,144.33446 18.2884,131.73534 h -5.598633 v -5.20093 z m -8.6000974,8.10132 -10.8017585,12.59913 h 5.60083 v 5.2998 h 10.3996581 v -5.2998 h 5.6008306 z" />
          </g>
        </svg><span> Exchange</span></a>
        <a href="https://www.betfair.com.au/hub/">Hub</a>
      </div>

      

    </nav>
    
  </header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../data/dataListing/" class="md-tabs__link">
          
  
  Data

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../wagering/betfairHowTo/" class="md-tabs__link">
          
  
  Wagering

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../api/apiResources/" class="md-tabs__link">
          
  
  API

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../modelling/howToModel/" class="md-tabs__link">
          
  
  Modelling

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../automation/GoldenRulesofAutomation/" class="md-tabs__link">
          
  
  Automation

        </a>
      </li>
    
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../How_to_Automate_1/" class="md-tabs__link">
          
  
  Tutorials

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../mentalGame/intro/" class="md-tabs__link">
          
  
  Mental Game

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../contactUs/test/" class="md-tabs__link">
          
  
  Contact Us

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="The Automation Hub" class="md-nav__button md-logo" aria-label="The Automation Hub" data-md-component="logo">
      
  <img src="../../img/logo.svg" alt="logo">

    </a>
    The Automation Hub
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Data
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Data
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../data/dataListing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CSV Files
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../data/usingHistoricDataSite/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Historic Data Site
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Wagering
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Wagering
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../wagering/betfairHowTo/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Betfair How-To
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../wagering/bettingGlossary/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Betting Glossary
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../wagering/stakingMethods/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Staking Methods and Bankroll Management
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../wagering/valueAndOdds/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Value and Odds
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../wagering/commission/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Commission and other charges
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../wagering/hubPredictionsModel/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Hub Predictions Model
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../wagering/2ndPlaceVoid/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Cashback 2nd Markets
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../wagering/exactaQuinella/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Exactas & Quinella
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    API
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            API
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/apiResources/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    API resources
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/apiappkey/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to access the Betfair API
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/apiRtutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    API tutorial in R
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/apiPythontutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    API tutorial in Python
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Modelling
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Modelling
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/howToModel/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Intro to modelling
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/dataSources/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Pricing Data Sources
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/cloudOrLocalMachine/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Cloud or Local
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/monteCarloSimulations/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Monte Carlo Simulations
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_5" >
        
          
          <label class="md-nav__link" for="__nav_5_5" id="__nav_5_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    AFL
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_5">
            <span class="md-nav__icon md-icon"></span>
            AFL
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/AFLPlayerDisposalsTutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Player Disposal Lines
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/AFLPlayerDisposalsFlumine/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Betting Player Disposal Markets
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/AFLmodellingPython/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    AFL modelling walk through in Python
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/modellingTheBrownlowMedal/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How does a Data Scientist model the Brownlow?
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/brownlowModelTutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Modelling the Brownlow Medal in Python
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_6" >
        
          
          <label class="md-nav__link" for="__nav_5_6" id="__nav_5_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Racing
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_6">
            <span class="md-nav__icon md-icon"></span>
            Racing
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/topazTutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Greyhound Topaz API (Python)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/fasttrackTutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Greyhound FastTrack API (Python)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/greyhoundModellingPython/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Greyhound modelling (Python)
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_7" >
        
          
          <label class="md-nav__link" for="__nav_5_7" id="__nav_5_7_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Soccer
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_7">
            <span class="md-nav__icon md-icon"></span>
            Soccer
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/soccerModellingTutorialPython/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Soccer modelling (Python)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/EPLmlPython/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    EPL Machine Learning (Python)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/soccerModellingELO2022WorldCup/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Soccer modelling (R) - 2022 FIFA World Cup
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/soccerEloTutorialR/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Elo soccer tutorial (R)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/soccerModellingTutorialR/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Soccer modelling (R)
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_8" >
        
          
          <label class="md-nav__link" for="__nav_5_8" id="__nav_5_8_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Tennis
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_8">
            <span class="md-nav__icon md-icon"></span>
            Tennis
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/howToModelTheAusOpen/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to model the Australian Open
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/AusOpenRTutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Aus Open R Tutorial
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/AusOpenPythonTutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Aus Open Python Tutorial
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Automation
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Automation
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/GoldenRulesofAutomation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Golden rules of automation
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/overview/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Tools Overview
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6_3" >
        
          
          <label class="md-nav__link" for="__nav_6_3" id="__nav_6_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Bet Angel
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_3">
            <span class="md-nav__icon md-icon"></span>
            Bet Angel
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/betAngel/betAngel/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Overview
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/betAngelbeginners/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Beginner's guide
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/betAngelintermediate/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Intermediate guide
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/betAngeladvanced/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Advanced guide
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/betAngelRatingsAutomation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Ratings auto
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/betAngelMarketFavouriteAutomation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Market fav auto
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/betAngelTippingAutomation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Tipping auto
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/betAngelSimultaneousMarkets/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Simultaneous markets
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/betAngelKellyStake/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Kelly criterion staking
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6_4" >
        
          
          <label class="md-nav__link" for="__nav_6_4" id="__nav_6_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Gruss Betting Assistant
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_4">
            <span class="md-nav__icon md-icon"></span>
            Gruss Betting Assistant
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/Gruss/Gruss/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Overview
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/GrussSettingupbasicmarketview/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Setup basic market view and one click betting
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/grussRatingsAutomation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Ratings auto
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/grussMarketFavouriteAutomation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Market fav auto
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/grusslSimultaneousMarkets/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Simultaneous markets
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/grussKellyStake/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Kelly criterion staking
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6_5" >
        
          
          <label class="md-nav__link" for="__nav_6_5" id="__nav_6_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Cymatic Trader
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_5">
            <span class="md-nav__icon md-icon"></span>
            Cymatic Trader
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/CymaticTrader/CymaticTrader/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Overview
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/cymaticTraderRatingsAutomation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Ratings auto
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6_6" >
        
          
          <label class="md-nav__link" for="__nav_6_6" id="__nav_6_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Geeks Toy
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_6">
            <span class="md-nav__icon md-icon"></span>
            Geeks Toy
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/GeeksToyinstallationandsetup/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Installation and setup
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/GeeksToybasicmarketviewstakingandoneclickbetting/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Setup basic market view and one click betting
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/geeksToyRefreshSettings/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Optimising refresh settings
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6_7" >
        
          
          <label class="md-nav__link" for="__nav_6_7" id="__nav_6_7_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Bet Jet Pro
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_7">
            <span class="md-nav__icon md-icon"></span>
            Bet Jet Pro
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/betJetOverview/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Overview
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" checked>
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Tutorials
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            Tutorials
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../How_to_Automate_1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to Automate 1
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../How_to_Automate_2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to Automate 2
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../How_to_Automate_3/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to Automate 3
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../How_to_Automate_4/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to Automate 4
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../How_to_Automate_5/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to Automate 5
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../flumineSimulations/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Flumine Simulations
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../processingTarFiles101/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Take away the pain! Processing TAR Files 101
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    JSON to CSV | Revisited
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    JSON to CSV | Revisited
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#lets-get-a-baseline" class="md-nav__link">
    <span class="md-ellipsis">
      Let's get a baseline
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#read-the-documentation" class="md-nav__link">
    <span class="md-ellipsis">
      READ. THE. DOCUMENTATION.
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#riir-rewrite-it-in-rust" class="md-nav__link">
    <span class="md-ellipsis">
      RIIR (Rewrite it in Rust)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing-it-out" class="md-nav__link">
    <span class="md-ellipsis">
      Testing it out
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gotta-go-fast" class="md-nav__link">
    <span class="md-ellipsis">
      Gotta go fast
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#validating-our-results" class="md-nav__link">
    <span class="md-ellipsis">
      Validating our results
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conclusion" class="md-nav__link">
    <span class="md-ellipsis">
      Conclusion
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#completed-code" class="md-nav__link">
    <span class="md-ellipsis">
      Completed code
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#disclaimer" class="md-nav__link">
    <span class="md-ellipsis">
      Disclaimer
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../backtestingRatingsTutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Back testing ratings in Python
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../automatedBettingAnglesTutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Automated betting angles in Python
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../analysingAndPredictingMarketMovements/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Do they know? Analysing Betfair market formation & market movements
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../analysingAndPredictingBSP/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Wisdom of the crowd? Analysing & understanding BSP
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_8" >
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Mental Game
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            Mental Game
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/intro/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Intro
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/roleOfEmotions/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Part 1
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/mapYourEmotions/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Part 2
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/handlingBadVariance/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Part 3
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/winbyBeingGreatatLosing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Part 4
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/correctingyouremotions/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Part 5
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/responsibleGambling/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Part 6
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/InchwormConcept/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Part 7
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/HighExpectations/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Part 8
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/TappingYourIntuition/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Part 9
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_9" >
        
          
          <label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Contact Us
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9">
            <span class="md-nav__icon md-icon"></span>
            Contact Us
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../contactUs/test/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Meet the Team
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="json-to-csv-revisited">JSON to CSV | Revisited</h1>
<hr />
<div class="admonition note">
<p class="admonition-title">Before you start</p>
<p>This tutorial follows on from our <a href="../jsonToCsvTutorial/">previous JSON to CSV tutorial</a> where we stepped through how to work with the historic recordings of Betfair's price data. You should make sure you read that first before continuing here! </p>
</div>
<p>So we're nearly a year on from our original <a href="../jsonToCsvTutorial/">JSON to CSV tutorial</a>, and while it was generally well received a very common (and fair) complaint was how long it took the script to run. Many people said that it could take all day, or they had to leave their PC on over night to finish, which obviously makes the data processing and back testing process a lot less accessible, which was the whole point of the original article. So we're circling back around to see what we can do to decrease the running time and to make working with larger samples of data less of an all-day affair. </p>
<p>You might want to stick around because the final results are really something. </p>
<div class="admonition note">
<p class="admonition-title">Cheat sheet</p>
<ul>
<li>
<p>If you're looking for the complete code <a href="https://betfair-datascientists.github.io/tutorials/jsonToCsvRevisited/#completed-code">head to the bottom of the page</a> or <a href="https://github.com/betfair-down-under/autoHubTutorials/tree/master/jsonToCsvRevisited">download the script from Github</a>.</p>
</li>
<li>
<p>To run the code, save it to your machine, open a command prompt, or a terminal in your text editor of choice (we're using <a href="https://code.visualstudio.com/download">VS code</a>), make sure you've navigated in the terminal to the folder you've saved the script in and then type <code>py main.py</code> (or whatever you've called your script file if not main) then hit enter. To stop the code running use Ctrl C. </p>
</li>
<li>
<p>Make sure you amend your data path to point to your data file. We'll be taking in an input of a historical tar file downloaded from the <a href="https://historicdata.betfair.com/#/help">Betfair historic data site</a>. We're using a PRO version, though the code should work on ADVANCED too. This approach won't work with the BASIC data tier. </p>
</li>
<li>
<p>We're using the  <a href="https://github.com/tarb/betfair_data"><code>betfair_data</code></a> package to do the heavy lifting; it's a Python library with a Rust backend, which makes it incredibly fast (spoiler alert!)</p>
</li>
</ul>
</div>
<hr />
<h2 id="lets-get-a-baseline">Let's get a baseline</h2>
<p>So how slow are we talking? Let's pick some data and run our script as it is from our last tutorial and see how long it takes. We'll be using 3 months worth of PRO Australian Racing data, from October to December 2021, as the basis for this benchmark and our other tests going forward.</p>
<div class="highlight"><span class="filename">Files used through this article</span><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="n">market_paths</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="s2">&quot;data/2021_10_OctRacingAUPro.tar&quot;</span><span class="p">,</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="s2">&quot;data/2021_11_NovRacingAUPro.tar&quot;</span><span class="p">,</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="s2">&quot;data/2021_12_DecRacingAUPro.tar&quot;</span><span class="p">,</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="p">]</span>
</code></pre></div>
<p>Now let's run the <a href="https://github.com/betfair-down-under/autoHubTutorials/blob/master/jsonToCsv/main.py">OG script</a> and time how long it takes with the terminal command below:</p>
<p><div class="highlight"><span class="filename">Terminal</span><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="go">gtime python json2csv.py</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="go">9665.79user 18.27system 2:41:26elapsed 99%CPU (0avgtext+0avgdata 96624maxresident)k</span>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="go">0inputs+0outputs (405major+10862minor)pagefaults 0swaps</span>
</code></pre></div>
... oof. This took a while: <code>2h 41m 26s</code> to be precise. </p>
<p>This is less 'run to the kitchen and grab a cup of coffee' and more 'head to the pub and settle in for the night' territory, and that's on a new, very fast, MacBook Pro... if you have an older pc you should expect this to take significantly longer again.</p>
<p>But <em>is</em> this actually slow? Let's count up how many files there are in our TAR archives, and then how many lines in each of the files, with each line being an update to a market, to give us an ideal of the scale of data we're dealing with:</p>
<p><code>Markets: 22,001 | Updates: 166,677,569</code></p>
<p>Each update can effect any or all of the runners in a market, and, to be fair, we are keeping track of a sizeable amount of data for each runner, including all the prices and volumes available in both back and lay ladders, all the money matched at every price point, the money in the BSP pools at each limit, plus a lot more... how much faster can we really expect this to run?</p>
<hr />
<h2 id="read-the-documentation">READ. THE. DOCUMENTATION.</h2>
<p>The <code>betfairlightweight</code> library is doing all the computationally heavy lifting in our script, and speeding it up even slightly could save us a lot of total run time, so we figured we should probably take a look online to see if there were known ways of speeding it up. </p>
<p>Let's implement these changes and see if that's enough to let us keep this article to just a couple of paragraphs!</p>
<p>Firstly, let's install the speed version of betfairlightweight; it says we should have this by default on Mac but there's no harm in checking anyway.</p>
<div class="highlight"><span class="filename">Terminal</span><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="go">pip install &#39;betfairlightweight[speed]&#39;</span>
</code></pre></div>
<p>There's some quick and easy code changes to throw in as well while we're at it:</p>
<div class="highlight"><span class="filename">Performance parameters</span><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="c1"># create trading instance (don&#39;t need username/password)</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="n">trading</span> <span class="o">=</span> <span class="n">betfairlightweight</span><span class="o">.</span><span class="n">APIClient</span><span class="p">(</span><span class="s2">&quot;username&quot;</span><span class="p">,</span> <span class="s2">&quot;password&quot;</span><span class="p">,</span> <span class="s2">&quot;appkey&quot;</span><span class="p">)</span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="c1"># create listener</span>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="n">listener</span> <span class="o">=</span> <span class="n">betfairlightweight</span><span class="o">.</span><span class="n">StreamListener</span><span class="p">(</span>
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="hll">    <span class="n">max_latency</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># ignore latency errors</span>
</span><a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a><span class="hll">    <span class="n">output_queue</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># use generator rather than a queue (faster)</span>
</span><a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a><span class="hll">    <span class="n">lightweight</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># lightweight mode is faster</span>
</span><a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a><span class="hll">    <span class="n">update_clk</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="c1"># do not update clk on updates (not required when backtesting)</span>
</span><a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a>
<a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a>    <span class="c1"># We need these as were using historic files</span>
<a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a>    <span class="n">cumulative_runner_tv</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  
<a id="__codelineno-3-13" name="__codelineno-3-13" href="#__codelineno-3-13"></a>    <span class="n">calculate_market_tv</span><span class="o">=</span><span class="kc">True</span>
<a id="__codelineno-3-14" name="__codelineno-3-14" href="#__codelineno-3-14"></a><span class="p">)</span>
</code></pre></div>
<p>Okay, so let's give it a go with these changes:</p>
<p><div class="highlight"><span class="filename">Terminal</span><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="go">python json2csv.py      </span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="go">Traceback (most recent call last):</span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="go">  File &quot;xxx/json2csv.py&quot;, line 162, in &lt;module&gt;</span>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="go">    (preplay_market, postplay_market, final_market) = get_pre_post_final(stream)</span>
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="go">  File &quot;xxx/json2csv.py&quot;, line 146, in get_pre_post_final</span>
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="go">    if eval_market is None and ((eval_market := filter_market(market_book)) == False):</span>
<a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a><span class="go">  File &quot;xxx/json2csv.py&quot;, line 104, in filter_market</span>
<a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a><span class="go">    d = market.market_definition</span>
<a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a><span class="go">AttributeError: &#39;dict&#39; object has no attribute &#39;market_definition&#39;</span>
</code></pre></div>
... and now it's broken. Taking another look at the docs reveals the culprit to be <code>lightweight=True</code> which makes the library skip parsing into objects and returns the raw JSON in dicts instead. This reportedly has a decent speed increase, but will come with some pretty significant usability constraints which undermines the point of the tutorial, and we would also need to rewrite our whole script. Let's just set that back to false <code>lightweight=False</code>, and see how much performance we gain from the other changes.</p>
<p><div class="highlight"><span class="filename">Terminal</span><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="go">gtime python json2csv.py  </span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="go">9716.23user 39.08system 2:42:44elapsed 99%CPU (0avgtext+0avgdata 106784maxresident)k</span>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="go">0inputs+0outputs (80major+11965minor)pagefaults 0swaps</span>
</code></pre></div>
... so that's basically the same. Without switching to the slightly faster, but significantly harder to use <code>lightweight</code> mode, this may be the best we are going to get from <code>betfairlightweight</code> in this context. </p>
<p>It's worth noting here that <code>betfairlightweight</code> is a Python library, written predominantly in Python (more on this in a minute). Looking at this execution through a profiler, we can see the vast majority of our time (&gt; 90%) is spent in parsing and creating objects. The only other significant time was a relatively small (~4%) amount spent both reading the file from disk and decompressing the data.</p>
<div class="tabbed-set tabbed-alternate" data-tabs="1:1"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="__tabbed_1_1">Betfairlightweight</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p><img src="img/bflw_py_src.svg" width="100%" alt='bflw flamegraph' /></p>
</div>
</div>
</div>
<p>Python sits in a peculiar space as both a very fast and simultaneously very slow programming language. When your program is spending most of its time running slow interpreted Python code it can be one of the slowest languages around - much slower then many other popular languages. Having said that though, there is a good chance if you're working in Python that a lot of your program isn't actually written in Python, but is instead written in a very fast systems language like C, C++ or Rust; much of the Python standard library, and many popular libraries like numpy, scipy and tensorflow are all examples of this. In these cases when Python is just acting as glue between code written in lower, faster languages a Python program can actually be really fast. </p>
<p>This leaves us with two paths: stay with <code>betfairlightweight</code> and try and optimise the performance up to a sufficiently faster level, or rewrite the portion of <code>betfairlightweight</code> that handles parsing the JSON stream files in a much faster language and expose that back to Python as a new library. It is worth noting that <code>betfairlightweight</code> is not a new library - it's been around for a good period of time and has been actively developed enough that the chance of us finding some ground breaking optimisations that could dramatically speed up performance is low, and we would ideally like to see a very large performance increase to move the dial on our original numbers. </p>
<p>So we took the path less travelled. And that made all the difference. </p>
<p><img style="display: block; float: right;" src="img/rust-logo.png" width="150" alt='Rust mascot, Ferris' /></p>
<hr />
<h2 id="riir-rewrite-it-in-rust">RIIR (Rewrite it in Rust)</h2>
<p>So we've chosen path two: write a new, faster library. I've been playing round in Rust for the last few years - it's a great, modern, and extremely fast language, with a well-loved mascot (hi Ferris!), but most importantly we know it has really great support for writing fast Python libraries. If this was a movie this is where they would show a montage of us staying up late, chugging coffee, and tapping away at our keyboards, but I'll save you that and instead just give you a <a href="https://github.com/tarb/betfair_data">link to our new library, betfair_data</a>. Quite a bit of effort has gone into making this library as fast as we can, and if there's interest we might write a follow up article that discusses the techniques we used to increase it's speed - let us know if you're keen for that - but for the purpose of this discussion the internals of the library don't really matter.</p>
<p>To use our library we'll only need to make a few small changes to our script. You can <a href="https://betfair-datascientists.github.io/tutorials/jsonToCsvRevisited/#complete-code">jump ahead and see the completed file</a> for this stage, but we'll walk through the main changes step by step below.</p>
<p>We need to start by importing the new library - it's available in pypi and can be easily installed with pip.</p>
<div class="highlight"><span class="filename">Terminal</span><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="go">pip install betfair_data</span>
</code></pre></div>
<div class="highlight"><span class="filename">Import the new library</span><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="kn">from</span> <span class="nn">betfair_data</span> <span class="kn">import</span> <span class="n">PriceSize</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="kn">from</span> <span class="nn">betfair_data</span> <span class="kn">import</span> <span class="n">bflw</span>
</code></pre></div>
<p>We'll also need to update our <code>load-markets</code> function to return the bytes of the file, instead of the file object itself. This saves us the complexity of having to make our library know how to read Python files.</p>
<div class="highlight"><span class="filename">Change load_markets function</span><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="c1"># loading from tar and extracting files</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="k">def</span> <span class="nf">load_markets</span><span class="p">(</span><span class="n">file_paths</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>    <span class="k">for</span> <span class="n">file_path</span> <span class="ow">in</span> <span class="n">file_paths</span><span class="p">:</span>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a>            <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">iglob</span><span class="p">(</span><span class="n">file_path</span> <span class="o">+</span> <span class="s1">&#39;**/**/*.bz2&#39;</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a>                <span class="k">with</span> <span class="n">bz2</span><span class="o">.</span><span class="n">BZ2File</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a><span class="hll">                    <span class="nb">bytes</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span><a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a><span class="hll">                    <span class="k">yield</span> <span class="n">bflw</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)</span>
</span><a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a>        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
<a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a>            <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file_path</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a>            <span class="c1"># iterate through a tar archive</span>
<a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a>            <span class="k">if</span> <span class="n">ext</span> <span class="o">==</span> <span class="s1">&#39;.tar&#39;</span><span class="p">:</span>
<a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a>                <span class="k">with</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">TarFile</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">archive</span><span class="p">:</span>
<a id="__codelineno-8-14" name="__codelineno-8-14" href="#__codelineno-8-14"></a>                    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">archive</span><span class="p">:</span>
<a id="__codelineno-8-15" name="__codelineno-8-15" href="#__codelineno-8-15"></a><span class="hll">                        <span class="n">name</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">name</span>
</span><a id="__codelineno-8-16" name="__codelineno-8-16" href="#__codelineno-8-16"></a><span class="hll">                        <span class="nb">bytes</span> <span class="o">=</span> <span class="n">bz2</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">archive</span><span class="o">.</span><span class="n">extractfile</span><span class="p">(</span><span class="n">file</span><span class="p">))</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span><a id="__codelineno-8-17" name="__codelineno-8-17" href="#__codelineno-8-17"></a><span class="hll">                        <span class="k">yield</span> <span class="n">bflw</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)</span>
</span><a id="__codelineno-8-18" name="__codelineno-8-18" href="#__codelineno-8-18"></a>            <span class="c1"># or a zip archive</span>
<a id="__codelineno-8-19" name="__codelineno-8-19" href="#__codelineno-8-19"></a>            <span class="k">elif</span> <span class="n">ext</span> <span class="o">==</span> <span class="s1">&#39;.zip&#39;</span><span class="p">:</span>
<a id="__codelineno-8-20" name="__codelineno-8-20" href="#__codelineno-8-20"></a>                <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">archive</span><span class="p">:</span>
<a id="__codelineno-8-21" name="__codelineno-8-21" href="#__codelineno-8-21"></a>                    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">archive</span><span class="o">.</span><span class="n">namelist</span><span class="p">():</span>
<a id="__codelineno-8-22" name="__codelineno-8-22" href="#__codelineno-8-22"></a><span class="hll">                        <span class="nb">bytes</span> <span class="o">=</span> <span class="n">bz2</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">archive</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">name</span><span class="p">))</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span><a id="__codelineno-8-23" name="__codelineno-8-23" href="#__codelineno-8-23"></a><span class="hll">                        <span class="k">yield</span> <span class="n">bflw</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)</span>
</span><a id="__codelineno-8-24" name="__codelineno-8-24" href="#__codelineno-8-24"></a>    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div>
<p>Then we just need to use these values, passing them to our new library in a similar way to how we previously passed the data to <code>betfairlightweight</code>.</p>
<div class="highlight"><span class="filename">iterate over bflw.File</span><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="hll"><span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">load_markets</span><span class="p">(</span><span class="n">market_paths</span><span class="p">):</span>
</span><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a>    <span class="k">def</span> <span class="nf">get_pre_post_final</span><span class="p">():</span>
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a>        <span class="n">eval_market</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a>        <span class="n">prev_market</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a>        <span class="n">preplay_market</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a>        <span class="n">postplay_market</span> <span class="o">=</span> <span class="kc">None</span>       
<a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a>
<a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a><span class="hll">        <span class="k">for</span> <span class="n">market_books</span> <span class="ow">in</span> <span class="n">file</span><span class="p">:</span>
</span><a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a>            <span class="k">for</span> <span class="n">market_book</span> <span class="ow">in</span> <span class="n">market_books</span><span class="p">:</span>
<a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a>                <span class="c1"># if market doesn&#39;t meet filter return out</span>
<a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a>                <span class="k">if</span> <span class="n">eval_market</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">((</span><span class="n">eval_market</span> <span class="o">:=</span> <span class="n">filter_market</span><span class="p">(</span><span class="n">market_book</span><span class="p">))</span> <span class="o">==</span> <span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-9-13" name="__codelineno-9-13" href="#__codelineno-9-13"></a>                    <span class="k">return</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-9-14" name="__codelineno-9-14" href="#__codelineno-9-14"></a>
<a id="__codelineno-9-15" name="__codelineno-9-15" href="#__codelineno-9-15"></a>                <span class="c1"># final market view before market goes in play</span>
<a id="__codelineno-9-16" name="__codelineno-9-16" href="#__codelineno-9-16"></a>                <span class="k">if</span> <span class="n">prev_market</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">prev_market</span><span class="o">.</span><span class="n">inplay</span> <span class="o">!=</span> <span class="n">market_book</span><span class="o">.</span><span class="n">inplay</span><span class="p">:</span>
<a id="__codelineno-9-17" name="__codelineno-9-17" href="#__codelineno-9-17"></a>                    <span class="n">preplay_market</span> <span class="o">=</span> <span class="n">prev_market</span>
<a id="__codelineno-9-18" name="__codelineno-9-18" href="#__codelineno-9-18"></a>
<a id="__codelineno-9-19" name="__codelineno-9-19" href="#__codelineno-9-19"></a>                <span class="c1"># final market view at the conclusion of the market</span>
<a id="__codelineno-9-20" name="__codelineno-9-20" href="#__codelineno-9-20"></a>                <span class="k">if</span> <span class="n">prev_market</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">prev_market</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;OPEN&quot;</span> <span class="ow">and</span> <span class="n">market_book</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="n">prev_market</span><span class="o">.</span><span class="n">status</span><span class="p">:</span>
<a id="__codelineno-9-21" name="__codelineno-9-21" href="#__codelineno-9-21"></a>                    <span class="n">postplay_market</span> <span class="o">=</span> <span class="n">market_book</span>
<a id="__codelineno-9-22" name="__codelineno-9-22" href="#__codelineno-9-22"></a>
<a id="__codelineno-9-23" name="__codelineno-9-23" href="#__codelineno-9-23"></a>                <span class="c1"># update reference to previous market</span>
<a id="__codelineno-9-24" name="__codelineno-9-24" href="#__codelineno-9-24"></a>                <span class="n">prev_market</span> <span class="o">=</span> <span class="n">market_book</span>
<a id="__codelineno-9-25" name="__codelineno-9-25" href="#__codelineno-9-25"></a>
<a id="__codelineno-9-26" name="__codelineno-9-26" href="#__codelineno-9-26"></a>        <span class="k">return</span> <span class="p">(</span><span class="n">preplay_market</span><span class="p">,</span> <span class="n">postplay_market</span><span class="p">,</span> <span class="n">prev_market</span><span class="p">)</span> 
</code></pre></div>
<hr />
<h2 id="testing-it-out">Testing it out</h2>
<div class="highlight"><span class="filename">Terminal</span><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="go">gtime python json2csv_bfd.py</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="go">618.00user 20.53system 10:38.74elapsed 99%CPU (0avgtext+0avgdata 767712maxresident)k</span>
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a><span class="go">0inputs+0outputs (0major+51396minor)pagefaults 0swaps</span>
</code></pre></div>
<p>Not bad! <code>10m 38s</code> - that's roughly a 93% reduction in run time, and nicely in the range we hoped to achieve. We <em>could</em> stop here, having happily achieved our goals. But can we go <strong>even faster?</strong></p>
<p>Loading up the profiler again shows us some interesting results.</p>
<div class="tabbed-set tabbed-alternate" data-tabs="2:2"><input checked="checked" id="__tabbed_2_1" name="__tabbed_2" type="radio" /><input id="__tabbed_2_2" name="__tabbed_2" type="radio" /><div class="tabbed-labels"><label for="__tabbed_2_1">Rust Library</label><label for="__tabbed_2_2">Betfairlightweight</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p><img src="img/bfd_py_src.svg" width="100%" alt='bflw flamegraph' /></p>
</div>
<div class="tabbed-block">
<p><img src="img/bflw_py_src.svg" width="100%" alt='bflw flamegraph' /></p>
</div>
</div>
</div>
<p>The work seems to be divided into two main areas. On the left you can see <code>load_markets</code> making up about ~70% of the computation time, and the parsing (<code>get_pre_post_final</code>) comprising the majority of the remaining.</p>
<p>Interestingly, we've now sped up our parsing and object creation so much that it no longer comprises the majority of the workload of our script. Looking back at the <code>betfairlightweight</code> example from our original implementation we can see that the parsing took up a touch over 90% of the run time, while reading and decompressing the files only took only ~4%. Now because our parsing and object creation is so much faster, that same decompressing work that was previously only a small fraction is the vast majority of our workload! </p>
<p>This split work loads highlights another opportunity. Unlike the JSON parsing, which needs to interact closely with the Python environment to create new objects and merge data, the process of reading and decompressing the files can be completed completely isolated and can therefor take place concurrently in another thread. </p>
<p>A simple visualisation of our current workload can be seen in the chart below, where between each parsing workload we need to load and decompress the file. </p>
<p><img style="display: block; margin: 0 auto;" src="img/work_serial.png" width="600px" alt='serial workload' /></p>
<p>However if we were to move the file loading and decompression process to another thread we could free up the main Python thread to just spend its time on the JSON parsing, object creation, merging values and execution of our script. Essentially our worker thread would load and decompress the file and free up the main Python thread to complete the tasks that can only run on there.</p>
<p><img style="display: block; margin: 0 auto;" src="img/work_par.png" width="600px" alt='concurrent workload' /></p>
<hr />
<h2 id="gotta-go-fast">Gotta go fast</h2>
<p>This version only has a few additional code changes to the previous <code>betfair_data</code> example - we'll be removing the <code>load_markets</code> generator function from the previous script, and will replace it with a call to a new Rust function that we have added to our library. Now the <code>betfair_data.Files</code> function is doing all the heavy lifting. It creates its own thread, loads the files, decompresses them (if needed) and buffers them for the main Python thread to take as needed.</p>
<div class="highlight"><span class="filename">Loading the files in a separate thread</span><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="hll"><span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">betfair_data</span><span class="o">.</span><span class="n">Files</span><span class="p">(</span><span class="n">market_paths</span><span class="p">)</span><span class="o">.</span><span class="n">bflw</span><span class="p">():</span>
</span><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>    <span class="k">def</span> <span class="nf">get_pre_post_final</span><span class="p">():</span>
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a>        <span class="n">eval_market</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a>        <span class="n">prev_market</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a>        <span class="n">preplay_market</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a>        <span class="n">postplay_market</span> <span class="o">=</span> <span class="kc">None</span>       
<a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a>
<a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a><span class="hll">        <span class="k">for</span> <span class="n">market_books</span> <span class="ow">in</span> <span class="n">file</span><span class="p">:</span>
</span><a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a>            <span class="k">for</span> <span class="n">market_book</span> <span class="ow">in</span> <span class="n">market_books</span><span class="p">:</span>
</code></pre></div>
<p>Now we can run it again as usual.</p>
<div class="highlight"><span class="filename">Terminal</span><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="go">gtime python json2csv_bfd_Rustsrc.py</span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="go">673.28user 18.31system 4:25.71elapsed 260%CPU (0avgtext+0avgdata 878720maxresident)k</span>
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="go">0inputs+0outputs (0major+72667minor)pagefaults 0swaps</span>
</code></pre></div>
<p>Down to <code>4m 25s</code>, an over 100% improvement again! Realistically though it's probably better to think of this change as a reduction of a fixed amount of work, as opposed to a doubling of performance. We are removing the loading and decompressing workload from the main thread, and in all fairness, we could take this exact same approach to the original <code>betfairlightweight</code> solution and expect to save roughly the same amount of time, <code>5mins</code> (from <code>2h 41m</code> to <code>2h 36m</code>). </p>
<p>When this workload is the majority of the computation time, this optimisation feels necessary, but much less so when it represents only a small fraction of the total run time.</p>
<p>Loading up the profiler, we can see that our flamegraph has gotten pretty bare. There's not much Python code left anymore, and what is left is truly just acting as glue between fast systems libraries to join them together and retrieve our result. Future optimisations will probably need to happen inside our new library, but whilst there are probably some performance gains to be found, we'll be unlikely to achieve anywhere near the scale of the speed increase we've already made.</p>
<div class="tabbed-set tabbed-alternate" data-tabs="3:3"><input checked="checked" id="__tabbed_3_1" name="__tabbed_3" type="radio" /><input id="__tabbed_3_2" name="__tabbed_3" type="radio" /><input id="__tabbed_3_3" name="__tabbed_3" type="radio" /><div class="tabbed-labels"><label for="__tabbed_3_1">Rust Library, threaded loading</label><label for="__tabbed_3_2">Rust Library, Python loading</label><label for="__tabbed_3_3"><code>Betfairlightweight</code></label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p><img src="img/bfd_rust_src.svg" width="100%" alt='bflw flamegraph' /></p>
</div>
<div class="tabbed-block">
<p><img src="img/bfd_py_src.svg" width="100%" alt='bflw flamegraph' /></p>
</div>
<div class="tabbed-block">
<p><img src="img/bflw_py_src.svg" width="100%" alt='bflw flamegraph' /></p>
</div>
</div>
</div>
<hr />
<h2 id="validating-our-results">Validating our results</h2>
<p>All of this effort measuring speed, and we haven't actually stopped to look at our output! Getting an answer quickly is only useful if we actually get the right answer, so let's run some comparisons between our original output and the output of the new library.</p>
<p>All of the outputted CSV files are <code>52,483</code> lines long, which is definitely a good start. We do need to go deeper though to make sure the values in every row are the same - we have essentially rewritten all the complex data handling logic so small differences in the output could be expected.</p>
<p>Luckily as CSV files are just plain text we can check the outputs of each line using <code>diff</code>:</p>
<div class="highlight"><span class="filename">Terminal</span><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="go">diff output_bfd.csv output_bflw.csv  </span>
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a>
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="go">&lt;no output&gt;</span>
</code></pre></div>
<p><code>diff</code> found no differences at all between the generated files! This confirms we have produced the exact same CSV.</p>
<hr />
<h2 id="conclusion">Conclusion</h2>
<p>These comparisons leave us confident that we're getting the same outputs from our new library as we were getting from our original implementation, but now we can run a year's worth of data in ~20 minutes, instead of close to 11 hours... </p>
<p>Also, with our new library being able to be a drop in replacement for the <code>betfairlightweights</code> object structure, we only needed to make a small number of changes to our script, and most of those changes were deleting lines (always a good feeling). </p>
<p>We'll clock that up as a win.</p>
<hr />
<h2 id="completed-code">Completed code</h2>
<div class="tabbed-set tabbed-alternate" data-tabs="4:3"><input checked="checked" id="__tabbed_4_1" name="__tabbed_4" type="radio" /><input id="__tabbed_4_2" name="__tabbed_4" type="radio" /><input id="__tabbed_4_3" name="__tabbed_4" type="radio" /><div class="tabbed-labels"><label for="__tabbed_4_1">Rust Library, threaded loading</label><label for="__tabbed_4_2">Rust Library, Python loading</label><label for="__tabbed_4_3"><code>Betfairlightweight</code> implementation</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p><a href="https://github.com/betfair-down-under/autoHubTutorials/blob/master/jsonToCsvRevisited/json2csv_bfd_threaded_loading.py">Download from Github</a></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="kn">import</span> <span class="nn">logging</span>
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="kn">import</span> <span class="nn">functools</span>
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span>
<a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">zip_longest</span>
<a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a><span class="kn">from</span> <span class="nn">betfair_data</span> <span class="kn">import</span> <span class="n">PriceSize</span>
<a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a><span class="kn">from</span> <span class="nn">betfair_data</span> <span class="kn">import</span> <span class="n">bflw</span>
<a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a><span class="kn">import</span> <span class="nn">betfair_data</span>
<a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a>
<a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a><span class="n">file_output</span> <span class="o">=</span> <span class="s2">&quot;output_rust_source.csv&quot;</span>
<a id="__codelineno-14-10" name="__codelineno-14-10" href="#__codelineno-14-10"></a>
<a id="__codelineno-14-11" name="__codelineno-14-11" href="#__codelineno-14-11"></a><span class="n">market_paths</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-14-12" name="__codelineno-14-12" href="#__codelineno-14-12"></a>    <span class="s2">&quot;data/2021_10_OctRacingAUPro.tar&quot;</span><span class="p">,</span>
<a id="__codelineno-14-13" name="__codelineno-14-13" href="#__codelineno-14-13"></a>    <span class="s2">&quot;data/2021_11_NovRacingAUPro.tar&quot;</span><span class="p">,</span>
<a id="__codelineno-14-14" name="__codelineno-14-14" href="#__codelineno-14-14"></a>    <span class="s2">&quot;data/2021_12_DecRacingAUPro.tar&quot;</span><span class="p">,</span>
<a id="__codelineno-14-15" name="__codelineno-14-15" href="#__codelineno-14-15"></a><span class="p">]</span>
<a id="__codelineno-14-16" name="__codelineno-14-16" href="#__codelineno-14-16"></a>
<a id="__codelineno-14-17" name="__codelineno-14-17" href="#__codelineno-14-17"></a><span class="c1"># setup logging</span>
<a id="__codelineno-14-18" name="__codelineno-14-18" href="#__codelineno-14-18"></a><span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">FATAL</span><span class="p">)</span>
<a id="__codelineno-14-19" name="__codelineno-14-19" href="#__codelineno-14-19"></a>
<a id="__codelineno-14-20" name="__codelineno-14-20" href="#__codelineno-14-20"></a><span class="c1"># rounding to 2 decimal places or returning &#39;&#39; if blank</span>
<a id="__codelineno-14-21" name="__codelineno-14-21" href="#__codelineno-14-21"></a><span class="k">def</span> <span class="nf">as_str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-14-22" name="__codelineno-14-22" href="#__codelineno-14-22"></a>    <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">v</span> <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="n">v</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
<a id="__codelineno-14-23" name="__codelineno-14-23" href="#__codelineno-14-23"></a>
<a id="__codelineno-14-24" name="__codelineno-14-24" href="#__codelineno-14-24"></a><span class="c1"># returning smaller of two numbers where min not 0</span>
<a id="__codelineno-14-25" name="__codelineno-14-25" href="#__codelineno-14-25"></a><span class="k">def</span> <span class="nf">min_gr0</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<a id="__codelineno-14-26" name="__codelineno-14-26" href="#__codelineno-14-26"></a>    <span class="k">if</span> <span class="n">a</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-14-27" name="__codelineno-14-27" href="#__codelineno-14-27"></a>        <span class="k">return</span> <span class="n">b</span>
<a id="__codelineno-14-28" name="__codelineno-14-28" href="#__codelineno-14-28"></a>    <span class="k">if</span> <span class="n">b</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-14-29" name="__codelineno-14-29" href="#__codelineno-14-29"></a>        <span class="k">return</span> <span class="n">a</span>
<a id="__codelineno-14-30" name="__codelineno-14-30" href="#__codelineno-14-30"></a>
<a id="__codelineno-14-31" name="__codelineno-14-31" href="#__codelineno-14-31"></a>    <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
<a id="__codelineno-14-32" name="__codelineno-14-32" href="#__codelineno-14-32"></a>
<a id="__codelineno-14-33" name="__codelineno-14-33" href="#__codelineno-14-33"></a><span class="c1"># parsing price data and pulling out weighted avg price, matched, min price and max price</span>
<a id="__codelineno-14-34" name="__codelineno-14-34" href="#__codelineno-14-34"></a><span class="k">def</span> <span class="nf">parse_traded</span><span class="p">(</span><span class="n">traded</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">PriceSize</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<a id="__codelineno-14-35" name="__codelineno-14-35" href="#__codelineno-14-35"></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">traded</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> 
<a id="__codelineno-14-36" name="__codelineno-14-36" href="#__codelineno-14-36"></a>        <span class="k">return</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-14-37" name="__codelineno-14-37" href="#__codelineno-14-37"></a>
<a id="__codelineno-14-38" name="__codelineno-14-38" href="#__codelineno-14-38"></a>    <span class="p">(</span><span class="n">wavg_sum</span><span class="p">,</span> <span class="n">matched</span><span class="p">,</span> <span class="n">min_price</span><span class="p">,</span> <span class="n">max_price</span><span class="p">)</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span>
<a id="__codelineno-14-39" name="__codelineno-14-39" href="#__codelineno-14-39"></a>        <span class="k">lambda</span> <span class="n">total</span><span class="p">,</span> <span class="n">ps</span><span class="p">:</span> <span class="p">(</span>
<a id="__codelineno-14-40" name="__codelineno-14-40" href="#__codelineno-14-40"></a>            <span class="n">total</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">ps</span><span class="o">.</span><span class="n">price</span> <span class="o">*</span> <span class="n">ps</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="c1"># wavg_sum before we divide by total matched</span>
<a id="__codelineno-14-41" name="__codelineno-14-41" href="#__codelineno-14-41"></a>            <span class="n">total</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">ps</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="c1"># total matched</span>
<a id="__codelineno-14-42" name="__codelineno-14-42" href="#__codelineno-14-42"></a>            <span class="nb">min</span><span class="p">(</span><span class="n">total</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">ps</span><span class="o">.</span><span class="n">price</span><span class="p">),</span> <span class="c1"># min price matched</span>
<a id="__codelineno-14-43" name="__codelineno-14-43" href="#__codelineno-14-43"></a>            <span class="nb">max</span><span class="p">(</span><span class="n">total</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">ps</span><span class="o">.</span><span class="n">price</span><span class="p">),</span> <span class="c1"># max price matched</span>
<a id="__codelineno-14-44" name="__codelineno-14-44" href="#__codelineno-14-44"></a>        <span class="p">),</span>
<a id="__codelineno-14-45" name="__codelineno-14-45" href="#__codelineno-14-45"></a>        <span class="n">traded</span><span class="p">,</span>
<a id="__codelineno-14-46" name="__codelineno-14-46" href="#__codelineno-14-46"></a>        <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1001</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c1"># starting default values</span>
<a id="__codelineno-14-47" name="__codelineno-14-47" href="#__codelineno-14-47"></a>    <span class="p">)</span>
<a id="__codelineno-14-48" name="__codelineno-14-48" href="#__codelineno-14-48"></a>
<a id="__codelineno-14-49" name="__codelineno-14-49" href="#__codelineno-14-49"></a>    <span class="n">wavg_sum</span> <span class="o">=</span> <span class="p">(</span><span class="n">wavg_sum</span> <span class="o">/</span> <span class="n">matched</span><span class="p">)</span> <span class="k">if</span> <span class="n">matched</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span> <span class="c1"># dividing sum of wavg by total matched</span>
<a id="__codelineno-14-50" name="__codelineno-14-50" href="#__codelineno-14-50"></a>    <span class="n">matched</span> <span class="o">=</span> <span class="n">matched</span> <span class="k">if</span> <span class="n">matched</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span> 
<a id="__codelineno-14-51" name="__codelineno-14-51" href="#__codelineno-14-51"></a>    <span class="n">min_price</span> <span class="o">=</span> <span class="n">min_price</span> <span class="k">if</span> <span class="n">min_price</span> <span class="o">!=</span> <span class="mi">1001</span> <span class="k">else</span> <span class="kc">None</span>
<a id="__codelineno-14-52" name="__codelineno-14-52" href="#__codelineno-14-52"></a>    <span class="n">max_price</span> <span class="o">=</span> <span class="n">max_price</span> <span class="k">if</span> <span class="n">max_price</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span>
<a id="__codelineno-14-53" name="__codelineno-14-53" href="#__codelineno-14-53"></a>
<a id="__codelineno-14-54" name="__codelineno-14-54" href="#__codelineno-14-54"></a>    <span class="k">return</span> <span class="p">(</span><span class="n">wavg_sum</span><span class="p">,</span> <span class="n">matched</span><span class="p">,</span> <span class="n">min_price</span><span class="p">,</span> <span class="n">max_price</span><span class="p">)</span>
<a id="__codelineno-14-55" name="__codelineno-14-55" href="#__codelineno-14-55"></a>
<a id="__codelineno-14-56" name="__codelineno-14-56" href="#__codelineno-14-56"></a><span class="c1"># splitting race name and returning the parts </span>
<a id="__codelineno-14-57" name="__codelineno-14-57" href="#__codelineno-14-57"></a><span class="k">def</span> <span class="nf">split_anz_horse_market_name</span><span class="p">(</span><span class="n">market_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<a id="__codelineno-14-58" name="__codelineno-14-58" href="#__codelineno-14-58"></a>    <span class="c1"># return race no, length, race type</span>
<a id="__codelineno-14-59" name="__codelineno-14-59" href="#__codelineno-14-59"></a>    <span class="c1"># input samples: </span>
<a id="__codelineno-14-60" name="__codelineno-14-60" href="#__codelineno-14-60"></a>    <span class="c1"># &#39;R6 1400m Grp1&#39; -&gt; (&#39;R6&#39;,&#39;1400m&#39;,&#39;grp1&#39;)</span>
<a id="__codelineno-14-61" name="__codelineno-14-61" href="#__codelineno-14-61"></a>    <span class="c1"># &#39;R1 1609m Trot M&#39; -&gt; (&#39;R1&#39;, &#39;1609m&#39;, &#39;trot&#39;)</span>
<a id="__codelineno-14-62" name="__codelineno-14-62" href="#__codelineno-14-62"></a>    <span class="c1"># &#39;R4 1660m Pace M&#39; -&gt; (&#39;R4&#39;, &#39;1660m&#39;, &#39;pace&#39;)</span>
<a id="__codelineno-14-63" name="__codelineno-14-63" href="#__codelineno-14-63"></a>    <span class="n">parts</span> <span class="o">=</span> <span class="n">market_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
<a id="__codelineno-14-64" name="__codelineno-14-64" href="#__codelineno-14-64"></a>    <span class="n">race_no</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> 
<a id="__codelineno-14-65" name="__codelineno-14-65" href="#__codelineno-14-65"></a>    <span class="n">race_len</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> 
<a id="__codelineno-14-66" name="__codelineno-14-66" href="#__codelineno-14-66"></a>    <span class="n">race_type</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> 
<a id="__codelineno-14-67" name="__codelineno-14-67" href="#__codelineno-14-67"></a>
<a id="__codelineno-14-68" name="__codelineno-14-68" href="#__codelineno-14-68"></a>    <span class="k">return</span> <span class="p">(</span><span class="n">race_no</span><span class="p">,</span> <span class="n">race_len</span><span class="p">,</span> <span class="n">race_type</span><span class="p">)</span>
<a id="__codelineno-14-69" name="__codelineno-14-69" href="#__codelineno-14-69"></a>
<a id="__codelineno-14-70" name="__codelineno-14-70" href="#__codelineno-14-70"></a><span class="c1"># filtering markets to those that fit the following criteria</span>
<a id="__codelineno-14-71" name="__codelineno-14-71" href="#__codelineno-14-71"></a><span class="k">def</span> <span class="nf">filter_market</span><span class="p">(</span><span class="n">market</span><span class="p">:</span> <span class="n">bflw</span><span class="o">.</span><span class="n">MarketBook</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span> 
<a id="__codelineno-14-72" name="__codelineno-14-72" href="#__codelineno-14-72"></a>    <span class="n">d</span> <span class="o">=</span> <span class="n">market</span><span class="o">.</span><span class="n">market_definition</span>
<a id="__codelineno-14-73" name="__codelineno-14-73" href="#__codelineno-14-73"></a>    <span class="k">return</span> <span class="p">(</span><span class="n">d</span> <span class="o">!=</span> <span class="kc">None</span>
<a id="__codelineno-14-74" name="__codelineno-14-74" href="#__codelineno-14-74"></a>        <span class="ow">and</span> <span class="n">d</span><span class="o">.</span><span class="n">country_code</span> <span class="o">==</span> <span class="s1">&#39;AU&#39;</span> 
<a id="__codelineno-14-75" name="__codelineno-14-75" href="#__codelineno-14-75"></a>        <span class="ow">and</span> <span class="n">d</span><span class="o">.</span><span class="n">market_type</span> <span class="o">==</span> <span class="s1">&#39;WIN&#39;</span> 
<a id="__codelineno-14-76" name="__codelineno-14-76" href="#__codelineno-14-76"></a>        <span class="ow">and</span> <span class="p">(</span><span class="n">c</span> <span class="o">:=</span> <span class="n">split_anz_horse_market_name</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">name</span><span class="p">)[</span><span class="mi">2</span><span class="p">])</span> <span class="o">!=</span> <span class="s1">&#39;trot&#39;</span> <span class="ow">and</span> <span class="n">c</span> <span class="o">!=</span> <span class="s1">&#39;pace&#39;</span><span class="p">)</span>
<a id="__codelineno-14-77" name="__codelineno-14-77" href="#__codelineno-14-77"></a>
<a id="__codelineno-14-78" name="__codelineno-14-78" href="#__codelineno-14-78"></a>
<a id="__codelineno-14-79" name="__codelineno-14-79" href="#__codelineno-14-79"></a>
<a id="__codelineno-14-80" name="__codelineno-14-80" href="#__codelineno-14-80"></a><span class="c1"># record prices to a file</span>
<a id="__codelineno-14-81" name="__codelineno-14-81" href="#__codelineno-14-81"></a><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_output</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">output</span><span class="p">:</span>
<a id="__codelineno-14-82" name="__codelineno-14-82" href="#__codelineno-14-82"></a>    <span class="c1"># defining column headers</span>
<a id="__codelineno-14-83" name="__codelineno-14-83" href="#__codelineno-14-83"></a>    <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;market_id,event_date,country,track,market_name,selection_id,selection_name,result,bsp,pp_min,pp_max,pp_wap,pp_ltp,pp_volume,ip_min,ip_max,ip_wap,ip_ltp,ip_volume</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-14-84" name="__codelineno-14-84" href="#__codelineno-14-84"></a>
<a id="__codelineno-14-85" name="__codelineno-14-85" href="#__codelineno-14-85"></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bflw</span><span class="o">.</span><span class="n">Files</span><span class="p">(</span><span class="n">market_paths</span><span class="p">)):</span>
<a id="__codelineno-14-86" name="__codelineno-14-86" href="#__codelineno-14-86"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Market </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-14-87" name="__codelineno-14-87" href="#__codelineno-14-87"></a>
<a id="__codelineno-14-88" name="__codelineno-14-88" href="#__codelineno-14-88"></a>        <span class="k">def</span> <span class="nf">get_pre_post_final</span><span class="p">():</span>
<a id="__codelineno-14-89" name="__codelineno-14-89" href="#__codelineno-14-89"></a>            <span class="n">eval_market</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-14-90" name="__codelineno-14-90" href="#__codelineno-14-90"></a>            <span class="n">prev_market</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-14-91" name="__codelineno-14-91" href="#__codelineno-14-91"></a>            <span class="n">preplay_market</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-14-92" name="__codelineno-14-92" href="#__codelineno-14-92"></a>            <span class="n">postplay_market</span> <span class="o">=</span> <span class="kc">None</span>       
<a id="__codelineno-14-93" name="__codelineno-14-93" href="#__codelineno-14-93"></a>
<a id="__codelineno-14-94" name="__codelineno-14-94" href="#__codelineno-14-94"></a>            <span class="k">for</span> <span class="n">market_books</span> <span class="ow">in</span> <span class="n">g</span><span class="p">:</span>
<a id="__codelineno-14-95" name="__codelineno-14-95" href="#__codelineno-14-95"></a>                <span class="k">for</span> <span class="n">market_book</span> <span class="ow">in</span> <span class="n">market_books</span><span class="p">:</span>
<a id="__codelineno-14-96" name="__codelineno-14-96" href="#__codelineno-14-96"></a>                    <span class="c1"># if market doesn&#39;t meet filter return out</span>
<a id="__codelineno-14-97" name="__codelineno-14-97" href="#__codelineno-14-97"></a>                    <span class="k">if</span> <span class="n">eval_market</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">((</span><span class="n">eval_market</span> <span class="o">:=</span> <span class="n">filter_market</span><span class="p">(</span><span class="n">market_book</span><span class="p">))</span> <span class="o">==</span> <span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-14-98" name="__codelineno-14-98" href="#__codelineno-14-98"></a>                        <span class="k">return</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-14-99" name="__codelineno-14-99" href="#__codelineno-14-99"></a>
<a id="__codelineno-14-100" name="__codelineno-14-100" href="#__codelineno-14-100"></a>                    <span class="c1"># final market view before market goes in play</span>
<a id="__codelineno-14-101" name="__codelineno-14-101" href="#__codelineno-14-101"></a>                    <span class="k">if</span> <span class="n">prev_market</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">prev_market</span><span class="o">.</span><span class="n">inplay</span> <span class="o">!=</span> <span class="n">market_book</span><span class="o">.</span><span class="n">inplay</span><span class="p">:</span>
<a id="__codelineno-14-102" name="__codelineno-14-102" href="#__codelineno-14-102"></a>                        <span class="n">preplay_market</span> <span class="o">=</span> <span class="n">prev_market</span>
<a id="__codelineno-14-103" name="__codelineno-14-103" href="#__codelineno-14-103"></a>
<a id="__codelineno-14-104" name="__codelineno-14-104" href="#__codelineno-14-104"></a>                    <span class="c1"># final market view at the conclusion of the market</span>
<a id="__codelineno-14-105" name="__codelineno-14-105" href="#__codelineno-14-105"></a>                    <span class="k">if</span> <span class="n">prev_market</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">prev_market</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;OPEN&quot;</span> <span class="ow">and</span> <span class="n">market_book</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="n">prev_market</span><span class="o">.</span><span class="n">status</span><span class="p">:</span>
<a id="__codelineno-14-106" name="__codelineno-14-106" href="#__codelineno-14-106"></a>                        <span class="n">postplay_market</span> <span class="o">=</span> <span class="n">market_book</span>
<a id="__codelineno-14-107" name="__codelineno-14-107" href="#__codelineno-14-107"></a>
<a id="__codelineno-14-108" name="__codelineno-14-108" href="#__codelineno-14-108"></a>                    <span class="c1"># update reference to previous market</span>
<a id="__codelineno-14-109" name="__codelineno-14-109" href="#__codelineno-14-109"></a>                    <span class="n">prev_market</span> <span class="o">=</span> <span class="n">market_book</span>
<a id="__codelineno-14-110" name="__codelineno-14-110" href="#__codelineno-14-110"></a>
<a id="__codelineno-14-111" name="__codelineno-14-111" href="#__codelineno-14-111"></a>            <span class="k">return</span> <span class="p">(</span><span class="n">preplay_market</span><span class="p">,</span> <span class="n">postplay_market</span><span class="p">,</span> <span class="n">prev_market</span><span class="p">)</span> <span class="c1"># prev is now final</span>
<a id="__codelineno-14-112" name="__codelineno-14-112" href="#__codelineno-14-112"></a>
<a id="__codelineno-14-113" name="__codelineno-14-113" href="#__codelineno-14-113"></a>        <span class="p">(</span><span class="n">preplay_market</span><span class="p">,</span> <span class="n">postplay_market</span><span class="p">,</span> <span class="n">final_market</span><span class="p">)</span> <span class="o">=</span> <span class="n">get_pre_post_final</span><span class="p">()</span>
<a id="__codelineno-14-114" name="__codelineno-14-114" href="#__codelineno-14-114"></a>
<a id="__codelineno-14-115" name="__codelineno-14-115" href="#__codelineno-14-115"></a>        <span class="c1"># no price data for market</span>
<a id="__codelineno-14-116" name="__codelineno-14-116" href="#__codelineno-14-116"></a>        <span class="k">if</span> <span class="n">postplay_market</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-14-117" name="__codelineno-14-117" href="#__codelineno-14-117"></a>            <span class="k">continue</span><span class="p">;</span> 
<a id="__codelineno-14-118" name="__codelineno-14-118" href="#__codelineno-14-118"></a>
<a id="__codelineno-14-119" name="__codelineno-14-119" href="#__codelineno-14-119"></a>        <span class="n">preplay_traded</span> <span class="o">=</span> <span class="p">[</span> <span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">last_price_traded</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">traded_volume</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">preplay_market</span><span class="o">.</span><span class="n">runners</span> <span class="p">]</span> <span class="k">if</span> <span class="n">preplay_market</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
<a id="__codelineno-14-120" name="__codelineno-14-120" href="#__codelineno-14-120"></a>        <span class="n">postplay_traded</span> <span class="o">=</span> <span class="p">[</span> <span class="p">(</span>
<a id="__codelineno-14-121" name="__codelineno-14-121" href="#__codelineno-14-121"></a>            <span class="n">r</span><span class="o">.</span><span class="n">last_price_traded</span><span class="p">,</span>
<a id="__codelineno-14-122" name="__codelineno-14-122" href="#__codelineno-14-122"></a>            <span class="n">r</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">traded_volume</span><span class="p">,</span>
<a id="__codelineno-14-123" name="__codelineno-14-123" href="#__codelineno-14-123"></a>            <span class="c1"># calculating SP traded vol as smaller of back_stake_taken or (lay_liability_taken / (BSP - 1))        </span>
<a id="__codelineno-14-124" name="__codelineno-14-124" href="#__codelineno-14-124"></a>            <span class="n">min_gr0</span><span class="p">(</span>
<a id="__codelineno-14-125" name="__codelineno-14-125" href="#__codelineno-14-125"></a>                <span class="nb">next</span><span class="p">((</span><span class="n">pv</span><span class="o">.</span><span class="n">size</span> <span class="k">for</span> <span class="n">pv</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">back_stake_taken</span> <span class="k">if</span> <span class="n">pv</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">0</span><span class="p">),</span>
<a id="__codelineno-14-126" name="__codelineno-14-126" href="#__codelineno-14-126"></a>                <span class="nb">next</span><span class="p">((</span><span class="n">pv</span><span class="o">.</span><span class="n">size</span> <span class="k">for</span> <span class="n">pv</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">lay_liability_taken</span> <span class="k">if</span> <span class="n">pv</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>  <span class="o">/</span> <span class="p">((</span><span class="n">r</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">actual_sp</span> <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">actual_sp</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">actual_sp</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-14-127" name="__codelineno-14-127" href="#__codelineno-14-127"></a>            <span class="p">)</span> <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">actual_sp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-14-128" name="__codelineno-14-128" href="#__codelineno-14-128"></a>        <span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">postplay_market</span><span class="o">.</span><span class="n">runners</span> <span class="p">]</span>
<a id="__codelineno-14-129" name="__codelineno-14-129" href="#__codelineno-14-129"></a>
<a id="__codelineno-14-130" name="__codelineno-14-130" href="#__codelineno-14-130"></a>        <span class="c1"># generic runner data</span>
<a id="__codelineno-14-131" name="__codelineno-14-131" href="#__codelineno-14-131"></a>        <span class="n">runner_data</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-14-132" name="__codelineno-14-132" href="#__codelineno-14-132"></a>            <span class="p">{</span>
<a id="__codelineno-14-133" name="__codelineno-14-133" href="#__codelineno-14-133"></a>                <span class="s1">&#39;selection_id&#39;</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">selection_id</span><span class="p">,</span>
<a id="__codelineno-14-134" name="__codelineno-14-134" href="#__codelineno-14-134"></a>                <span class="s1">&#39;selection_name&#39;</span><span class="p">:</span> <span class="nb">next</span><span class="p">((</span><span class="n">rd</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">rd</span> <span class="ow">in</span> <span class="n">final_market</span><span class="o">.</span><span class="n">market_definition</span><span class="o">.</span><span class="n">runners</span> <span class="k">if</span> <span class="n">rd</span><span class="o">.</span><span class="n">selection_id</span> <span class="o">==</span> <span class="n">r</span><span class="o">.</span><span class="n">selection_id</span><span class="p">),</span> <span class="kc">None</span><span class="p">),</span>
<a id="__codelineno-14-135" name="__codelineno-14-135" href="#__codelineno-14-135"></a>                <span class="s1">&#39;selection_status&#39;</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
<a id="__codelineno-14-136" name="__codelineno-14-136" href="#__codelineno-14-136"></a>                <span class="s1">&#39;sp&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">actual_sp</span><span class="p">),</span>
<a id="__codelineno-14-137" name="__codelineno-14-137" href="#__codelineno-14-137"></a>            <span class="p">}</span>
<a id="__codelineno-14-138" name="__codelineno-14-138" href="#__codelineno-14-138"></a>            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">final_market</span><span class="o">.</span><span class="n">runners</span> 
<a id="__codelineno-14-139" name="__codelineno-14-139" href="#__codelineno-14-139"></a>        <span class="p">]</span>
<a id="__codelineno-14-140" name="__codelineno-14-140" href="#__codelineno-14-140"></a>
<a id="__codelineno-14-141" name="__codelineno-14-141" href="#__codelineno-14-141"></a>        <span class="c1"># runner price data for markets that go in play</span>
<a id="__codelineno-14-142" name="__codelineno-14-142" href="#__codelineno-14-142"></a>        <span class="k">if</span> <span class="n">preplay_traded</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-14-143" name="__codelineno-14-143" href="#__codelineno-14-143"></a>            <span class="k">def</span> <span class="nf">runner_vals</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
<a id="__codelineno-14-144" name="__codelineno-14-144" href="#__codelineno-14-144"></a>                <span class="p">(</span><span class="n">pre_ltp</span><span class="p">,</span> <span class="n">pre_traded</span><span class="p">),</span> <span class="p">(</span><span class="n">post_ltp</span><span class="p">,</span> <span class="n">post_traded</span><span class="p">,</span> <span class="n">sp_traded</span><span class="p">)</span> <span class="o">=</span> <span class="n">r</span>
<a id="__codelineno-14-145" name="__codelineno-14-145" href="#__codelineno-14-145"></a>
<a id="__codelineno-14-146" name="__codelineno-14-146" href="#__codelineno-14-146"></a>                <span class="n">inplay_only</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">ps</span><span class="p">:</span> <span class="n">ps</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="p">[</span>
<a id="__codelineno-14-147" name="__codelineno-14-147" href="#__codelineno-14-147"></a>                    <span class="n">PriceSize</span><span class="p">(</span>
<a id="__codelineno-14-148" name="__codelineno-14-148" href="#__codelineno-14-148"></a>                        <span class="n">price</span><span class="o">=</span><span class="n">post_ps</span><span class="o">.</span><span class="n">price</span><span class="p">,</span> 
<a id="__codelineno-14-149" name="__codelineno-14-149" href="#__codelineno-14-149"></a>                        <span class="n">size</span><span class="o">=</span><span class="n">post_ps</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="nb">next</span><span class="p">((</span><span class="n">pre_ps</span><span class="o">.</span><span class="n">size</span> <span class="k">for</span> <span class="n">pre_ps</span> <span class="ow">in</span> <span class="n">pre_traded</span> <span class="k">if</span> <span class="n">pre_ps</span><span class="o">.</span><span class="n">price</span> <span class="o">==</span> <span class="n">post_ps</span><span class="o">.</span><span class="n">price</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-14-150" name="__codelineno-14-150" href="#__codelineno-14-150"></a>                    <span class="p">)</span>
<a id="__codelineno-14-151" name="__codelineno-14-151" href="#__codelineno-14-151"></a>                    <span class="k">for</span> <span class="n">post_ps</span> <span class="ow">in</span> <span class="n">post_traded</span> 
<a id="__codelineno-14-152" name="__codelineno-14-152" href="#__codelineno-14-152"></a>                <span class="p">]))</span>
<a id="__codelineno-14-153" name="__codelineno-14-153" href="#__codelineno-14-153"></a>
<a id="__codelineno-14-154" name="__codelineno-14-154" href="#__codelineno-14-154"></a>                <span class="p">(</span><span class="n">ip_wavg</span><span class="p">,</span> <span class="n">ip_matched</span><span class="p">,</span> <span class="n">ip_min</span><span class="p">,</span> <span class="n">ip_max</span><span class="p">)</span> <span class="o">=</span> <span class="n">parse_traded</span><span class="p">(</span><span class="n">inplay_only</span><span class="p">)</span>
<a id="__codelineno-14-155" name="__codelineno-14-155" href="#__codelineno-14-155"></a>                <span class="p">(</span><span class="n">pre_wavg</span><span class="p">,</span> <span class="n">pre_matched</span><span class="p">,</span> <span class="n">pre_min</span><span class="p">,</span> <span class="n">pre_max</span><span class="p">)</span> <span class="o">=</span> <span class="n">parse_traded</span><span class="p">(</span><span class="n">pre_traded</span><span class="p">)</span>
<a id="__codelineno-14-156" name="__codelineno-14-156" href="#__codelineno-14-156"></a>
<a id="__codelineno-14-157" name="__codelineno-14-157" href="#__codelineno-14-157"></a>                <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-14-158" name="__codelineno-14-158" href="#__codelineno-14-158"></a>                    <span class="s1">&#39;preplay_ltp&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">pre_ltp</span><span class="p">),</span>
<a id="__codelineno-14-159" name="__codelineno-14-159" href="#__codelineno-14-159"></a>                    <span class="s1">&#39;preplay_min&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">pre_min</span><span class="p">),</span>
<a id="__codelineno-14-160" name="__codelineno-14-160" href="#__codelineno-14-160"></a>                    <span class="s1">&#39;preplay_max&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">pre_max</span><span class="p">),</span>
<a id="__codelineno-14-161" name="__codelineno-14-161" href="#__codelineno-14-161"></a>                    <span class="s1">&#39;preplay_wavg&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">pre_wavg</span><span class="p">),</span>
<a id="__codelineno-14-162" name="__codelineno-14-162" href="#__codelineno-14-162"></a>                    <span class="s1">&#39;preplay_matched&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">((</span><span class="n">pre_matched</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">sp_traded</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)),</span>
<a id="__codelineno-14-163" name="__codelineno-14-163" href="#__codelineno-14-163"></a>                    <span class="s1">&#39;inplay_ltp&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">post_ltp</span><span class="p">),</span>
<a id="__codelineno-14-164" name="__codelineno-14-164" href="#__codelineno-14-164"></a>                    <span class="s1">&#39;inplay_min&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">ip_min</span><span class="p">),</span>
<a id="__codelineno-14-165" name="__codelineno-14-165" href="#__codelineno-14-165"></a>                    <span class="s1">&#39;inplay_max&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">ip_max</span><span class="p">),</span>
<a id="__codelineno-14-166" name="__codelineno-14-166" href="#__codelineno-14-166"></a>                    <span class="s1">&#39;inplay_wavg&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">ip_wavg</span><span class="p">),</span>
<a id="__codelineno-14-167" name="__codelineno-14-167" href="#__codelineno-14-167"></a>                    <span class="s1">&#39;inplay_matched&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">ip_matched</span><span class="p">),</span>
<a id="__codelineno-14-168" name="__codelineno-14-168" href="#__codelineno-14-168"></a>                <span class="p">}</span>
<a id="__codelineno-14-169" name="__codelineno-14-169" href="#__codelineno-14-169"></a>
<a id="__codelineno-14-170" name="__codelineno-14-170" href="#__codelineno-14-170"></a>            <span class="n">runner_traded</span> <span class="o">=</span> <span class="p">[</span> <span class="n">runner_vals</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">zip_longest</span><span class="p">(</span><span class="n">preplay_traded</span><span class="p">,</span> <span class="n">postplay_traded</span><span class="p">,</span> <span class="n">fillvalue</span><span class="o">=</span><span class="n">PriceSize</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">]</span>
<a id="__codelineno-14-171" name="__codelineno-14-171" href="#__codelineno-14-171"></a>
<a id="__codelineno-14-172" name="__codelineno-14-172" href="#__codelineno-14-172"></a>        <span class="c1"># runner price data for markets that don&#39;t go in play</span>
<a id="__codelineno-14-173" name="__codelineno-14-173" href="#__codelineno-14-173"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-14-174" name="__codelineno-14-174" href="#__codelineno-14-174"></a>            <span class="k">def</span> <span class="nf">runner_vals</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
<a id="__codelineno-14-175" name="__codelineno-14-175" href="#__codelineno-14-175"></a>                <span class="p">(</span><span class="n">ltp</span><span class="p">,</span> <span class="n">traded</span><span class="p">,</span> <span class="n">sp_traded</span><span class="p">)</span> <span class="o">=</span> <span class="n">r</span>
<a id="__codelineno-14-176" name="__codelineno-14-176" href="#__codelineno-14-176"></a>                <span class="p">(</span><span class="n">wavg</span><span class="p">,</span> <span class="n">matched</span><span class="p">,</span> <span class="n">min_price</span><span class="p">,</span> <span class="n">max_price</span><span class="p">)</span> <span class="o">=</span> <span class="n">parse_traded</span><span class="p">(</span><span class="n">traded</span><span class="p">)</span>
<a id="__codelineno-14-177" name="__codelineno-14-177" href="#__codelineno-14-177"></a>
<a id="__codelineno-14-178" name="__codelineno-14-178" href="#__codelineno-14-178"></a>                <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-14-179" name="__codelineno-14-179" href="#__codelineno-14-179"></a>                    <span class="s1">&#39;preplay_ltp&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">ltp</span><span class="p">),</span>
<a id="__codelineno-14-180" name="__codelineno-14-180" href="#__codelineno-14-180"></a>                    <span class="s1">&#39;preplay_min&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">min_price</span><span class="p">),</span>
<a id="__codelineno-14-181" name="__codelineno-14-181" href="#__codelineno-14-181"></a>                    <span class="s1">&#39;preplay_max&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">max_price</span><span class="p">),</span>
<a id="__codelineno-14-182" name="__codelineno-14-182" href="#__codelineno-14-182"></a>                    <span class="s1">&#39;preplay_wavg&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">wavg</span><span class="p">),</span>
<a id="__codelineno-14-183" name="__codelineno-14-183" href="#__codelineno-14-183"></a>                    <span class="s1">&#39;preplay_matched&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">((</span><span class="n">matched</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">sp_traded</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)),</span>
<a id="__codelineno-14-184" name="__codelineno-14-184" href="#__codelineno-14-184"></a>                    <span class="s1">&#39;inplay_ltp&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
<a id="__codelineno-14-185" name="__codelineno-14-185" href="#__codelineno-14-185"></a>                    <span class="s1">&#39;inplay_min&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
<a id="__codelineno-14-186" name="__codelineno-14-186" href="#__codelineno-14-186"></a>                    <span class="s1">&#39;inplay_max&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
<a id="__codelineno-14-187" name="__codelineno-14-187" href="#__codelineno-14-187"></a>                    <span class="s1">&#39;inplay_wavg&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
<a id="__codelineno-14-188" name="__codelineno-14-188" href="#__codelineno-14-188"></a>                    <span class="s1">&#39;inplay_matched&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
<a id="__codelineno-14-189" name="__codelineno-14-189" href="#__codelineno-14-189"></a>                <span class="p">}</span>
<a id="__codelineno-14-190" name="__codelineno-14-190" href="#__codelineno-14-190"></a>
<a id="__codelineno-14-191" name="__codelineno-14-191" href="#__codelineno-14-191"></a>            <span class="n">runner_traded</span> <span class="o">=</span> <span class="p">[</span> <span class="n">runner_vals</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">postplay_traded</span> <span class="p">]</span>
<a id="__codelineno-14-192" name="__codelineno-14-192" href="#__codelineno-14-192"></a>
<a id="__codelineno-14-193" name="__codelineno-14-193" href="#__codelineno-14-193"></a>        <span class="c1"># printing to csv for each runner</span>
<a id="__codelineno-14-194" name="__codelineno-14-194" href="#__codelineno-14-194"></a>        <span class="k">for</span> <span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="n">rprices</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">runner_data</span><span class="p">,</span> <span class="n">runner_traded</span><span class="p">):</span>
<a id="__codelineno-14-195" name="__codelineno-14-195" href="#__codelineno-14-195"></a>            <span class="c1"># defining data to go in each column</span>
<a id="__codelineno-14-196" name="__codelineno-14-196" href="#__codelineno-14-196"></a>            <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
<a id="__codelineno-14-197" name="__codelineno-14-197" href="#__codelineno-14-197"></a>                <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
<a id="__codelineno-14-198" name="__codelineno-14-198" href="#__codelineno-14-198"></a>                    <span class="n">postplay_market</span><span class="o">.</span><span class="n">market_id</span><span class="p">,</span>
<a id="__codelineno-14-199" name="__codelineno-14-199" href="#__codelineno-14-199"></a>                    <span class="n">postplay_market</span><span class="o">.</span><span class="n">market_definition</span><span class="o">.</span><span class="n">market_time</span><span class="p">,</span>
<a id="__codelineno-14-200" name="__codelineno-14-200" href="#__codelineno-14-200"></a>                    <span class="n">postplay_market</span><span class="o">.</span><span class="n">market_definition</span><span class="o">.</span><span class="n">country_code</span><span class="p">,</span>
<a id="__codelineno-14-201" name="__codelineno-14-201" href="#__codelineno-14-201"></a>                    <span class="n">postplay_market</span><span class="o">.</span><span class="n">market_definition</span><span class="o">.</span><span class="n">venue</span><span class="p">,</span>
<a id="__codelineno-14-202" name="__codelineno-14-202" href="#__codelineno-14-202"></a>                    <span class="n">postplay_market</span><span class="o">.</span><span class="n">market_definition</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-14-203" name="__codelineno-14-203" href="#__codelineno-14-203"></a>                    <span class="n">rdata</span><span class="p">[</span><span class="s1">&#39;selection_id&#39;</span><span class="p">],</span>
<a id="__codelineno-14-204" name="__codelineno-14-204" href="#__codelineno-14-204"></a>                    <span class="n">rdata</span><span class="p">[</span><span class="s1">&#39;selection_name&#39;</span><span class="p">],</span>
<a id="__codelineno-14-205" name="__codelineno-14-205" href="#__codelineno-14-205"></a>                    <span class="n">rdata</span><span class="p">[</span><span class="s1">&#39;selection_status&#39;</span><span class="p">],</span>
<a id="__codelineno-14-206" name="__codelineno-14-206" href="#__codelineno-14-206"></a>                    <span class="n">rdata</span><span class="p">[</span><span class="s1">&#39;sp&#39;</span><span class="p">],</span>
<a id="__codelineno-14-207" name="__codelineno-14-207" href="#__codelineno-14-207"></a>                    <span class="n">rprices</span><span class="p">[</span><span class="s1">&#39;preplay_min&#39;</span><span class="p">],</span>
<a id="__codelineno-14-208" name="__codelineno-14-208" href="#__codelineno-14-208"></a>                    <span class="n">rprices</span><span class="p">[</span><span class="s1">&#39;preplay_max&#39;</span><span class="p">],</span>
<a id="__codelineno-14-209" name="__codelineno-14-209" href="#__codelineno-14-209"></a>                    <span class="n">rprices</span><span class="p">[</span><span class="s1">&#39;preplay_wavg&#39;</span><span class="p">],</span>
<a id="__codelineno-14-210" name="__codelineno-14-210" href="#__codelineno-14-210"></a>                    <span class="n">rprices</span><span class="p">[</span><span class="s1">&#39;preplay_ltp&#39;</span><span class="p">],</span>
<a id="__codelineno-14-211" name="__codelineno-14-211" href="#__codelineno-14-211"></a>                    <span class="n">rprices</span><span class="p">[</span><span class="s1">&#39;preplay_matched&#39;</span><span class="p">],</span>
<a id="__codelineno-14-212" name="__codelineno-14-212" href="#__codelineno-14-212"></a>                    <span class="n">rprices</span><span class="p">[</span><span class="s1">&#39;inplay_min&#39;</span><span class="p">],</span>
<a id="__codelineno-14-213" name="__codelineno-14-213" href="#__codelineno-14-213"></a>                    <span class="n">rprices</span><span class="p">[</span><span class="s1">&#39;inplay_max&#39;</span><span class="p">],</span>
<a id="__codelineno-14-214" name="__codelineno-14-214" href="#__codelineno-14-214"></a>                    <span class="n">rprices</span><span class="p">[</span><span class="s1">&#39;inplay_wavg&#39;</span><span class="p">],</span>
<a id="__codelineno-14-215" name="__codelineno-14-215" href="#__codelineno-14-215"></a>                    <span class="n">rprices</span><span class="p">[</span><span class="s1">&#39;inplay_ltp&#39;</span><span class="p">],</span>
<a id="__codelineno-14-216" name="__codelineno-14-216" href="#__codelineno-14-216"></a>                    <span class="n">rprices</span><span class="p">[</span><span class="s1">&#39;inplay_matched&#39;</span><span class="p">],</span>
<a id="__codelineno-14-217" name="__codelineno-14-217" href="#__codelineno-14-217"></a>                <span class="p">)</span>
<a id="__codelineno-14-218" name="__codelineno-14-218" href="#__codelineno-14-218"></a>            <span class="p">)</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p><a href="https://github.com/betfair-down-under/autoHubTutorials/blob/master/jsonToCsvRevisited/json2csv_bfd_py_loading.py">Download from Github</a></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="kn">import</span> <span class="nn">logging</span>
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span>
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a>
<a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a><span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">zip_longest</span>
<a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a><span class="kn">import</span> <span class="nn">functools</span>
<a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a>
<a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a><span class="kn">import</span> <span class="nn">os</span>
<a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a><span class="kn">import</span> <span class="nn">tarfile</span>
<a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a><span class="kn">import</span> <span class="nn">zipfile</span>
<a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a><span class="kn">import</span> <span class="nn">bz2</span>
<a id="__codelineno-15-11" name="__codelineno-15-11" href="#__codelineno-15-11"></a><span class="kn">import</span> <span class="nn">glob</span>
<a id="__codelineno-15-12" name="__codelineno-15-12" href="#__codelineno-15-12"></a><span class="kn">from</span> <span class="nn">betfair_data</span> <span class="kn">import</span> <span class="n">PriceSize</span>
<a id="__codelineno-15-13" name="__codelineno-15-13" href="#__codelineno-15-13"></a><span class="kn">from</span> <span class="nn">betfair_data</span> <span class="kn">import</span> <span class="n">bflw</span>
<a id="__codelineno-15-14" name="__codelineno-15-14" href="#__codelineno-15-14"></a>
<a id="__codelineno-15-15" name="__codelineno-15-15" href="#__codelineno-15-15"></a><span class="n">file_output</span> <span class="o">=</span> <span class="s2">&quot;output_py_source.csv&quot;</span>
<a id="__codelineno-15-16" name="__codelineno-15-16" href="#__codelineno-15-16"></a>
<a id="__codelineno-15-17" name="__codelineno-15-17" href="#__codelineno-15-17"></a><span class="n">market_paths</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-15-18" name="__codelineno-15-18" href="#__codelineno-15-18"></a>    <span class="s2">&quot;data/2021_10_OctRacingAUPro.tar&quot;</span><span class="p">,</span>
<a id="__codelineno-15-19" name="__codelineno-15-19" href="#__codelineno-15-19"></a>    <span class="s2">&quot;data/2021_11_NovRacingAUPro.tar&quot;</span><span class="p">,</span>
<a id="__codelineno-15-20" name="__codelineno-15-20" href="#__codelineno-15-20"></a>    <span class="s2">&quot;data/2021_12_DecRacingAUPro.tar&quot;</span><span class="p">,</span>
<a id="__codelineno-15-21" name="__codelineno-15-21" href="#__codelineno-15-21"></a><span class="p">]</span>
<a id="__codelineno-15-22" name="__codelineno-15-22" href="#__codelineno-15-22"></a>
<a id="__codelineno-15-23" name="__codelineno-15-23" href="#__codelineno-15-23"></a><span class="c1"># setup logging</span>
<a id="__codelineno-15-24" name="__codelineno-15-24" href="#__codelineno-15-24"></a><span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">FATAL</span><span class="p">)</span>
<a id="__codelineno-15-25" name="__codelineno-15-25" href="#__codelineno-15-25"></a>
<a id="__codelineno-15-26" name="__codelineno-15-26" href="#__codelineno-15-26"></a><span class="c1"># loading from tar and extracting files</span>
<a id="__codelineno-15-27" name="__codelineno-15-27" href="#__codelineno-15-27"></a><span class="k">def</span> <span class="nf">load_markets</span><span class="p">(</span><span class="n">file_paths</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
<a id="__codelineno-15-28" name="__codelineno-15-28" href="#__codelineno-15-28"></a>    <span class="k">for</span> <span class="n">file_path</span> <span class="ow">in</span> <span class="n">file_paths</span><span class="p">:</span>
<a id="__codelineno-15-29" name="__codelineno-15-29" href="#__codelineno-15-29"></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
<a id="__codelineno-15-30" name="__codelineno-15-30" href="#__codelineno-15-30"></a>            <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">iglob</span><span class="p">(</span><span class="n">file_path</span> <span class="o">+</span> <span class="s1">&#39;**/**/*.bz2&#39;</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<a id="__codelineno-15-31" name="__codelineno-15-31" href="#__codelineno-15-31"></a>                <span class="k">with</span> <span class="n">bz2</span><span class="o">.</span><span class="n">BZ2File</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-15-32" name="__codelineno-15-32" href="#__codelineno-15-32"></a>                    <span class="nb">bytes</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<a id="__codelineno-15-33" name="__codelineno-15-33" href="#__codelineno-15-33"></a>                    <span class="k">yield</span> <span class="n">bflw</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)</span>
<a id="__codelineno-15-34" name="__codelineno-15-34" href="#__codelineno-15-34"></a>
<a id="__codelineno-15-35" name="__codelineno-15-35" href="#__codelineno-15-35"></a>        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
<a id="__codelineno-15-36" name="__codelineno-15-36" href="#__codelineno-15-36"></a>            <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file_path</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-15-37" name="__codelineno-15-37" href="#__codelineno-15-37"></a>            <span class="c1"># iterate through a tar archive</span>
<a id="__codelineno-15-38" name="__codelineno-15-38" href="#__codelineno-15-38"></a>            <span class="k">if</span> <span class="n">ext</span> <span class="o">==</span> <span class="s1">&#39;.tar&#39;</span><span class="p">:</span>
<a id="__codelineno-15-39" name="__codelineno-15-39" href="#__codelineno-15-39"></a>                <span class="k">with</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">TarFile</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">archive</span><span class="p">:</span>
<a id="__codelineno-15-40" name="__codelineno-15-40" href="#__codelineno-15-40"></a>                    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">archive</span><span class="p">:</span>
<a id="__codelineno-15-41" name="__codelineno-15-41" href="#__codelineno-15-41"></a>                        <span class="n">name</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">name</span>
<a id="__codelineno-15-42" name="__codelineno-15-42" href="#__codelineno-15-42"></a>                        <span class="nb">bytes</span> <span class="o">=</span> <span class="n">bz2</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">archive</span><span class="o">.</span><span class="n">extractfile</span><span class="p">(</span><span class="n">file</span><span class="p">))</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<a id="__codelineno-15-43" name="__codelineno-15-43" href="#__codelineno-15-43"></a>                        <span class="k">yield</span> <span class="n">bflw</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)</span>
<a id="__codelineno-15-44" name="__codelineno-15-44" href="#__codelineno-15-44"></a>            <span class="c1"># or a zip archive</span>
<a id="__codelineno-15-45" name="__codelineno-15-45" href="#__codelineno-15-45"></a>            <span class="k">elif</span> <span class="n">ext</span> <span class="o">==</span> <span class="s1">&#39;.zip&#39;</span><span class="p">:</span>
<a id="__codelineno-15-46" name="__codelineno-15-46" href="#__codelineno-15-46"></a>                <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">archive</span><span class="p">:</span>
<a id="__codelineno-15-47" name="__codelineno-15-47" href="#__codelineno-15-47"></a>                    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">archive</span><span class="o">.</span><span class="n">namelist</span><span class="p">():</span>
<a id="__codelineno-15-48" name="__codelineno-15-48" href="#__codelineno-15-48"></a>                        <span class="nb">bytes</span> <span class="o">=</span> <span class="n">bz2</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">archive</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">name</span><span class="p">))</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<a id="__codelineno-15-49" name="__codelineno-15-49" href="#__codelineno-15-49"></a>                        <span class="k">yield</span> <span class="n">bflw</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)</span>
<a id="__codelineno-15-50" name="__codelineno-15-50" href="#__codelineno-15-50"></a>    <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-15-51" name="__codelineno-15-51" href="#__codelineno-15-51"></a>
<a id="__codelineno-15-52" name="__codelineno-15-52" href="#__codelineno-15-52"></a><span class="c1"># rounding to 2 decimal places or returning &#39;&#39; if blank</span>
<a id="__codelineno-15-53" name="__codelineno-15-53" href="#__codelineno-15-53"></a><span class="k">def</span> <span class="nf">as_str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-15-54" name="__codelineno-15-54" href="#__codelineno-15-54"></a>    <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">v</span> <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="n">v</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
<a id="__codelineno-15-55" name="__codelineno-15-55" href="#__codelineno-15-55"></a>
<a id="__codelineno-15-56" name="__codelineno-15-56" href="#__codelineno-15-56"></a><span class="c1"># returning smaller of two numbers where min not 0</span>
<a id="__codelineno-15-57" name="__codelineno-15-57" href="#__codelineno-15-57"></a><span class="k">def</span> <span class="nf">min_gr0</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<a id="__codelineno-15-58" name="__codelineno-15-58" href="#__codelineno-15-58"></a>    <span class="k">if</span> <span class="n">a</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-15-59" name="__codelineno-15-59" href="#__codelineno-15-59"></a>        <span class="k">return</span> <span class="n">b</span>
<a id="__codelineno-15-60" name="__codelineno-15-60" href="#__codelineno-15-60"></a>    <span class="k">if</span> <span class="n">b</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-15-61" name="__codelineno-15-61" href="#__codelineno-15-61"></a>        <span class="k">return</span> <span class="n">a</span>
<a id="__codelineno-15-62" name="__codelineno-15-62" href="#__codelineno-15-62"></a>
<a id="__codelineno-15-63" name="__codelineno-15-63" href="#__codelineno-15-63"></a>    <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
<a id="__codelineno-15-64" name="__codelineno-15-64" href="#__codelineno-15-64"></a>
<a id="__codelineno-15-65" name="__codelineno-15-65" href="#__codelineno-15-65"></a><span class="c1"># parsing price data and pulling out weighted avg price, matched, min price and max price</span>
<a id="__codelineno-15-66" name="__codelineno-15-66" href="#__codelineno-15-66"></a><span class="k">def</span> <span class="nf">parse_traded</span><span class="p">(</span><span class="n">traded</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">PriceSize</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<a id="__codelineno-15-67" name="__codelineno-15-67" href="#__codelineno-15-67"></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">traded</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> 
<a id="__codelineno-15-68" name="__codelineno-15-68" href="#__codelineno-15-68"></a>        <span class="k">return</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-15-69" name="__codelineno-15-69" href="#__codelineno-15-69"></a>
<a id="__codelineno-15-70" name="__codelineno-15-70" href="#__codelineno-15-70"></a>    <span class="p">(</span><span class="n">wavg_sum</span><span class="p">,</span> <span class="n">matched</span><span class="p">,</span> <span class="n">min_price</span><span class="p">,</span> <span class="n">max_price</span><span class="p">)</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span>
<a id="__codelineno-15-71" name="__codelineno-15-71" href="#__codelineno-15-71"></a>        <span class="k">lambda</span> <span class="n">total</span><span class="p">,</span> <span class="n">ps</span><span class="p">:</span> <span class="p">(</span>
<a id="__codelineno-15-72" name="__codelineno-15-72" href="#__codelineno-15-72"></a>            <span class="n">total</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">ps</span><span class="o">.</span><span class="n">price</span> <span class="o">*</span> <span class="n">ps</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="c1"># wavg_sum before we divide by total matched</span>
<a id="__codelineno-15-73" name="__codelineno-15-73" href="#__codelineno-15-73"></a>            <span class="n">total</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">ps</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="c1"># total matched</span>
<a id="__codelineno-15-74" name="__codelineno-15-74" href="#__codelineno-15-74"></a>            <span class="nb">min</span><span class="p">(</span><span class="n">total</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">ps</span><span class="o">.</span><span class="n">price</span><span class="p">),</span> <span class="c1"># min price matched</span>
<a id="__codelineno-15-75" name="__codelineno-15-75" href="#__codelineno-15-75"></a>            <span class="nb">max</span><span class="p">(</span><span class="n">total</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">ps</span><span class="o">.</span><span class="n">price</span><span class="p">),</span> <span class="c1"># max price matched</span>
<a id="__codelineno-15-76" name="__codelineno-15-76" href="#__codelineno-15-76"></a>        <span class="p">),</span>
<a id="__codelineno-15-77" name="__codelineno-15-77" href="#__codelineno-15-77"></a>        <span class="n">traded</span><span class="p">,</span>
<a id="__codelineno-15-78" name="__codelineno-15-78" href="#__codelineno-15-78"></a>        <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1001</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c1"># starting default values</span>
<a id="__codelineno-15-79" name="__codelineno-15-79" href="#__codelineno-15-79"></a>    <span class="p">)</span>
<a id="__codelineno-15-80" name="__codelineno-15-80" href="#__codelineno-15-80"></a>
<a id="__codelineno-15-81" name="__codelineno-15-81" href="#__codelineno-15-81"></a>    <span class="n">wavg_sum</span> <span class="o">=</span> <span class="p">(</span><span class="n">wavg_sum</span> <span class="o">/</span> <span class="n">matched</span><span class="p">)</span> <span class="k">if</span> <span class="n">matched</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span> <span class="c1"># dividing sum of wavg by total matched</span>
<a id="__codelineno-15-82" name="__codelineno-15-82" href="#__codelineno-15-82"></a>    <span class="n">matched</span> <span class="o">=</span> <span class="n">matched</span> <span class="k">if</span> <span class="n">matched</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span> 
<a id="__codelineno-15-83" name="__codelineno-15-83" href="#__codelineno-15-83"></a>    <span class="n">min_price</span> <span class="o">=</span> <span class="n">min_price</span> <span class="k">if</span> <span class="n">min_price</span> <span class="o">!=</span> <span class="mi">1001</span> <span class="k">else</span> <span class="kc">None</span>
<a id="__codelineno-15-84" name="__codelineno-15-84" href="#__codelineno-15-84"></a>    <span class="n">max_price</span> <span class="o">=</span> <span class="n">max_price</span> <span class="k">if</span> <span class="n">max_price</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span>
<a id="__codelineno-15-85" name="__codelineno-15-85" href="#__codelineno-15-85"></a>
<a id="__codelineno-15-86" name="__codelineno-15-86" href="#__codelineno-15-86"></a>    <span class="k">return</span> <span class="p">(</span><span class="n">wavg_sum</span><span class="p">,</span> <span class="n">matched</span><span class="p">,</span> <span class="n">min_price</span><span class="p">,</span> <span class="n">max_price</span><span class="p">)</span>
<a id="__codelineno-15-87" name="__codelineno-15-87" href="#__codelineno-15-87"></a>
<a id="__codelineno-15-88" name="__codelineno-15-88" href="#__codelineno-15-88"></a><span class="c1"># splitting race name and returning the parts </span>
<a id="__codelineno-15-89" name="__codelineno-15-89" href="#__codelineno-15-89"></a><span class="k">def</span> <span class="nf">split_anz_horse_market_name</span><span class="p">(</span><span class="n">market_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<a id="__codelineno-15-90" name="__codelineno-15-90" href="#__codelineno-15-90"></a>    <span class="c1"># return race no, length, race type</span>
<a id="__codelineno-15-91" name="__codelineno-15-91" href="#__codelineno-15-91"></a>    <span class="c1"># input samples: </span>
<a id="__codelineno-15-92" name="__codelineno-15-92" href="#__codelineno-15-92"></a>    <span class="c1"># &#39;R6 1400m Grp1&#39; -&gt; (&#39;R6&#39;,&#39;1400m&#39;,&#39;grp1&#39;)</span>
<a id="__codelineno-15-93" name="__codelineno-15-93" href="#__codelineno-15-93"></a>    <span class="c1"># &#39;R1 1609m Trot M&#39; -&gt; (&#39;R1&#39;, &#39;1609m&#39;, &#39;trot&#39;)</span>
<a id="__codelineno-15-94" name="__codelineno-15-94" href="#__codelineno-15-94"></a>    <span class="c1"># &#39;R4 1660m Pace M&#39; -&gt; (&#39;R4&#39;, &#39;1660m&#39;, &#39;pace&#39;)</span>
<a id="__codelineno-15-95" name="__codelineno-15-95" href="#__codelineno-15-95"></a>    <span class="n">parts</span> <span class="o">=</span> <span class="n">market_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
<a id="__codelineno-15-96" name="__codelineno-15-96" href="#__codelineno-15-96"></a>    <span class="n">race_no</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> 
<a id="__codelineno-15-97" name="__codelineno-15-97" href="#__codelineno-15-97"></a>    <span class="n">race_len</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> 
<a id="__codelineno-15-98" name="__codelineno-15-98" href="#__codelineno-15-98"></a>    <span class="n">race_type</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> 
<a id="__codelineno-15-99" name="__codelineno-15-99" href="#__codelineno-15-99"></a>
<a id="__codelineno-15-100" name="__codelineno-15-100" href="#__codelineno-15-100"></a>    <span class="k">return</span> <span class="p">(</span><span class="n">race_no</span><span class="p">,</span> <span class="n">race_len</span><span class="p">,</span> <span class="n">race_type</span><span class="p">)</span>
<a id="__codelineno-15-101" name="__codelineno-15-101" href="#__codelineno-15-101"></a>
<a id="__codelineno-15-102" name="__codelineno-15-102" href="#__codelineno-15-102"></a><span class="c1"># filtering markets to those that fit the following criteria</span>
<a id="__codelineno-15-103" name="__codelineno-15-103" href="#__codelineno-15-103"></a><span class="k">def</span> <span class="nf">filter_market</span><span class="p">(</span><span class="n">market</span><span class="p">:</span> <span class="n">bflw</span><span class="o">.</span><span class="n">MarketBook</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span> 
<a id="__codelineno-15-104" name="__codelineno-15-104" href="#__codelineno-15-104"></a>    <span class="n">d</span> <span class="o">=</span> <span class="n">market</span><span class="o">.</span><span class="n">market_definition</span>
<a id="__codelineno-15-105" name="__codelineno-15-105" href="#__codelineno-15-105"></a>    <span class="k">return</span> <span class="p">(</span><span class="n">d</span> <span class="o">!=</span> <span class="kc">None</span>
<a id="__codelineno-15-106" name="__codelineno-15-106" href="#__codelineno-15-106"></a>        <span class="ow">and</span> <span class="n">d</span><span class="o">.</span><span class="n">country_code</span> <span class="o">==</span> <span class="s1">&#39;AU&#39;</span> 
<a id="__codelineno-15-107" name="__codelineno-15-107" href="#__codelineno-15-107"></a>        <span class="ow">and</span> <span class="n">d</span><span class="o">.</span><span class="n">market_type</span> <span class="o">==</span> <span class="s1">&#39;WIN&#39;</span> 
<a id="__codelineno-15-108" name="__codelineno-15-108" href="#__codelineno-15-108"></a>        <span class="ow">and</span> <span class="p">(</span><span class="n">c</span> <span class="o">:=</span> <span class="n">split_anz_horse_market_name</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">name</span><span class="p">)[</span><span class="mi">2</span><span class="p">])</span> <span class="o">!=</span> <span class="s1">&#39;trot&#39;</span> <span class="ow">and</span> <span class="n">c</span> <span class="o">!=</span> <span class="s1">&#39;pace&#39;</span><span class="p">)</span>
<a id="__codelineno-15-109" name="__codelineno-15-109" href="#__codelineno-15-109"></a>
<a id="__codelineno-15-110" name="__codelineno-15-110" href="#__codelineno-15-110"></a><span class="c1"># record prices to a file</span>
<a id="__codelineno-15-111" name="__codelineno-15-111" href="#__codelineno-15-111"></a><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_output</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">output</span><span class="p">:</span>
<a id="__codelineno-15-112" name="__codelineno-15-112" href="#__codelineno-15-112"></a>    <span class="c1"># defining column headers</span>
<a id="__codelineno-15-113" name="__codelineno-15-113" href="#__codelineno-15-113"></a>    <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;market_id,event_date,country,track,market_name,selection_id,selection_name,result,bsp,pp_min,pp_max,pp_wap,pp_ltp,pp_volume,ip_min,ip_max,ip_wap,ip_ltp,ip_volume</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-15-114" name="__codelineno-15-114" href="#__codelineno-15-114"></a>
<a id="__codelineno-15-115" name="__codelineno-15-115" href="#__codelineno-15-115"></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">file</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">load_markets</span><span class="p">(</span><span class="n">market_paths</span><span class="p">)):</span>
<a id="__codelineno-15-116" name="__codelineno-15-116" href="#__codelineno-15-116"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Market </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-15-117" name="__codelineno-15-117" href="#__codelineno-15-117"></a>
<a id="__codelineno-15-118" name="__codelineno-15-118" href="#__codelineno-15-118"></a>        <span class="k">def</span> <span class="nf">get_pre_post_final</span><span class="p">():</span>
<a id="__codelineno-15-119" name="__codelineno-15-119" href="#__codelineno-15-119"></a>            <span class="n">eval_market</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-15-120" name="__codelineno-15-120" href="#__codelineno-15-120"></a>            <span class="n">prev_market</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-15-121" name="__codelineno-15-121" href="#__codelineno-15-121"></a>            <span class="n">preplay_market</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-15-122" name="__codelineno-15-122" href="#__codelineno-15-122"></a>            <span class="n">postplay_market</span> <span class="o">=</span> <span class="kc">None</span>       
<a id="__codelineno-15-123" name="__codelineno-15-123" href="#__codelineno-15-123"></a>
<a id="__codelineno-15-124" name="__codelineno-15-124" href="#__codelineno-15-124"></a>            <span class="k">for</span> <span class="n">market_books</span> <span class="ow">in</span> <span class="n">file</span><span class="p">:</span>
<a id="__codelineno-15-125" name="__codelineno-15-125" href="#__codelineno-15-125"></a>                <span class="k">for</span> <span class="n">market_book</span> <span class="ow">in</span> <span class="n">market_books</span><span class="p">:</span>
<a id="__codelineno-15-126" name="__codelineno-15-126" href="#__codelineno-15-126"></a>                    <span class="c1"># if market doesn&#39;t meet filter return out</span>
<a id="__codelineno-15-127" name="__codelineno-15-127" href="#__codelineno-15-127"></a>                    <span class="k">if</span> <span class="n">eval_market</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">((</span><span class="n">eval_market</span> <span class="o">:=</span> <span class="n">filter_market</span><span class="p">(</span><span class="n">market_book</span><span class="p">))</span> <span class="o">==</span> <span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-15-128" name="__codelineno-15-128" href="#__codelineno-15-128"></a>                        <span class="k">return</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-15-129" name="__codelineno-15-129" href="#__codelineno-15-129"></a>
<a id="__codelineno-15-130" name="__codelineno-15-130" href="#__codelineno-15-130"></a>                    <span class="c1"># final market view before market goes in play</span>
<a id="__codelineno-15-131" name="__codelineno-15-131" href="#__codelineno-15-131"></a>                    <span class="k">if</span> <span class="n">prev_market</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">prev_market</span><span class="o">.</span><span class="n">inplay</span> <span class="o">!=</span> <span class="n">market_book</span><span class="o">.</span><span class="n">inplay</span><span class="p">:</span>
<a id="__codelineno-15-132" name="__codelineno-15-132" href="#__codelineno-15-132"></a>                        <span class="n">preplay_market</span> <span class="o">=</span> <span class="n">prev_market</span>
<a id="__codelineno-15-133" name="__codelineno-15-133" href="#__codelineno-15-133"></a>
<a id="__codelineno-15-134" name="__codelineno-15-134" href="#__codelineno-15-134"></a>                    <span class="c1"># final market view at the conclusion of the market</span>
<a id="__codelineno-15-135" name="__codelineno-15-135" href="#__codelineno-15-135"></a>                    <span class="k">if</span> <span class="n">prev_market</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">prev_market</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;OPEN&quot;</span> <span class="ow">and</span> <span class="n">market_book</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="n">prev_market</span><span class="o">.</span><span class="n">status</span><span class="p">:</span>
<a id="__codelineno-15-136" name="__codelineno-15-136" href="#__codelineno-15-136"></a>                        <span class="n">postplay_market</span> <span class="o">=</span> <span class="n">market_book</span>
<a id="__codelineno-15-137" name="__codelineno-15-137" href="#__codelineno-15-137"></a>
<a id="__codelineno-15-138" name="__codelineno-15-138" href="#__codelineno-15-138"></a>                    <span class="c1"># update reference to previous market</span>
<a id="__codelineno-15-139" name="__codelineno-15-139" href="#__codelineno-15-139"></a>                    <span class="n">prev_market</span> <span class="o">=</span> <span class="n">market_book</span>
<a id="__codelineno-15-140" name="__codelineno-15-140" href="#__codelineno-15-140"></a>
<a id="__codelineno-15-141" name="__codelineno-15-141" href="#__codelineno-15-141"></a>            <span class="k">return</span> <span class="p">(</span><span class="n">preplay_market</span><span class="p">,</span> <span class="n">postplay_market</span><span class="p">,</span> <span class="n">prev_market</span><span class="p">)</span> <span class="c1"># prev is now final</span>
<a id="__codelineno-15-142" name="__codelineno-15-142" href="#__codelineno-15-142"></a>
<a id="__codelineno-15-143" name="__codelineno-15-143" href="#__codelineno-15-143"></a>        <span class="p">(</span><span class="n">preplay_market</span><span class="p">,</span> <span class="n">postplay_market</span><span class="p">,</span> <span class="n">final_market</span><span class="p">)</span> <span class="o">=</span> <span class="n">get_pre_post_final</span><span class="p">()</span>
<a id="__codelineno-15-144" name="__codelineno-15-144" href="#__codelineno-15-144"></a>
<a id="__codelineno-15-145" name="__codelineno-15-145" href="#__codelineno-15-145"></a>        <span class="c1"># no price data for market</span>
<a id="__codelineno-15-146" name="__codelineno-15-146" href="#__codelineno-15-146"></a>        <span class="k">if</span> <span class="n">postplay_market</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-15-147" name="__codelineno-15-147" href="#__codelineno-15-147"></a>            <span class="k">continue</span><span class="p">;</span> 
<a id="__codelineno-15-148" name="__codelineno-15-148" href="#__codelineno-15-148"></a>
<a id="__codelineno-15-149" name="__codelineno-15-149" href="#__codelineno-15-149"></a>        <span class="n">preplay_traded</span> <span class="o">=</span> <span class="p">[</span> <span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">last_price_traded</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">traded_volume</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">preplay_market</span><span class="o">.</span><span class="n">runners</span> <span class="p">]</span> <span class="k">if</span> <span class="n">preplay_market</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
<a id="__codelineno-15-150" name="__codelineno-15-150" href="#__codelineno-15-150"></a>        <span class="n">postplay_traded</span> <span class="o">=</span> <span class="p">[</span> <span class="p">(</span>
<a id="__codelineno-15-151" name="__codelineno-15-151" href="#__codelineno-15-151"></a>            <span class="n">r</span><span class="o">.</span><span class="n">last_price_traded</span><span class="p">,</span>
<a id="__codelineno-15-152" name="__codelineno-15-152" href="#__codelineno-15-152"></a>            <span class="n">r</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">traded_volume</span><span class="p">,</span>
<a id="__codelineno-15-153" name="__codelineno-15-153" href="#__codelineno-15-153"></a>            <span class="c1"># calculating SP traded vol as smaller of back_stake_taken or (lay_liability_taken / (BSP - 1))        </span>
<a id="__codelineno-15-154" name="__codelineno-15-154" href="#__codelineno-15-154"></a>            <span class="n">min_gr0</span><span class="p">(</span>
<a id="__codelineno-15-155" name="__codelineno-15-155" href="#__codelineno-15-155"></a>                <span class="nb">next</span><span class="p">((</span><span class="n">pv</span><span class="o">.</span><span class="n">size</span> <span class="k">for</span> <span class="n">pv</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">back_stake_taken</span> <span class="k">if</span> <span class="n">pv</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">0</span><span class="p">),</span>
<a id="__codelineno-15-156" name="__codelineno-15-156" href="#__codelineno-15-156"></a>                <span class="nb">next</span><span class="p">((</span><span class="n">pv</span><span class="o">.</span><span class="n">size</span> <span class="k">for</span> <span class="n">pv</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">lay_liability_taken</span> <span class="k">if</span> <span class="n">pv</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>  <span class="o">/</span> <span class="p">((</span><span class="n">r</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">actual_sp</span> <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">actual_sp</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">actual_sp</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-15-157" name="__codelineno-15-157" href="#__codelineno-15-157"></a>            <span class="p">)</span> <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">actual_sp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-15-158" name="__codelineno-15-158" href="#__codelineno-15-158"></a>        <span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">postplay_market</span><span class="o">.</span><span class="n">runners</span> <span class="p">]</span>
<a id="__codelineno-15-159" name="__codelineno-15-159" href="#__codelineno-15-159"></a>
<a id="__codelineno-15-160" name="__codelineno-15-160" href="#__codelineno-15-160"></a>        <span class="c1"># generic runner data</span>
<a id="__codelineno-15-161" name="__codelineno-15-161" href="#__codelineno-15-161"></a>        <span class="n">runner_data</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-15-162" name="__codelineno-15-162" href="#__codelineno-15-162"></a>            <span class="p">{</span>
<a id="__codelineno-15-163" name="__codelineno-15-163" href="#__codelineno-15-163"></a>                <span class="s1">&#39;selection_id&#39;</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">selection_id</span><span class="p">,</span>
<a id="__codelineno-15-164" name="__codelineno-15-164" href="#__codelineno-15-164"></a>                <span class="s1">&#39;selection_name&#39;</span><span class="p">:</span> <span class="nb">next</span><span class="p">((</span><span class="n">rd</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">rd</span> <span class="ow">in</span> <span class="n">final_market</span><span class="o">.</span><span class="n">market_definition</span><span class="o">.</span><span class="n">runners</span> <span class="k">if</span> <span class="n">rd</span><span class="o">.</span><span class="n">selection_id</span> <span class="o">==</span> <span class="n">r</span><span class="o">.</span><span class="n">selection_id</span><span class="p">),</span> <span class="kc">None</span><span class="p">),</span>
<a id="__codelineno-15-165" name="__codelineno-15-165" href="#__codelineno-15-165"></a>                <span class="s1">&#39;selection_status&#39;</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
<a id="__codelineno-15-166" name="__codelineno-15-166" href="#__codelineno-15-166"></a>                <span class="s1">&#39;sp&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">actual_sp</span><span class="p">),</span>
<a id="__codelineno-15-167" name="__codelineno-15-167" href="#__codelineno-15-167"></a>            <span class="p">}</span>
<a id="__codelineno-15-168" name="__codelineno-15-168" href="#__codelineno-15-168"></a>            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">final_market</span><span class="o">.</span><span class="n">runners</span> 
<a id="__codelineno-15-169" name="__codelineno-15-169" href="#__codelineno-15-169"></a>        <span class="p">]</span>
<a id="__codelineno-15-170" name="__codelineno-15-170" href="#__codelineno-15-170"></a>
<a id="__codelineno-15-171" name="__codelineno-15-171" href="#__codelineno-15-171"></a>        <span class="c1"># runner price data for markets that go in play</span>
<a id="__codelineno-15-172" name="__codelineno-15-172" href="#__codelineno-15-172"></a>        <span class="k">if</span> <span class="n">preplay_traded</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-15-173" name="__codelineno-15-173" href="#__codelineno-15-173"></a>            <span class="k">def</span> <span class="nf">runner_vals</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
<a id="__codelineno-15-174" name="__codelineno-15-174" href="#__codelineno-15-174"></a>                <span class="p">(</span><span class="n">pre_ltp</span><span class="p">,</span> <span class="n">pre_traded</span><span class="p">),</span> <span class="p">(</span><span class="n">post_ltp</span><span class="p">,</span> <span class="n">post_traded</span><span class="p">,</span> <span class="n">sp_traded</span><span class="p">)</span> <span class="o">=</span> <span class="n">r</span>
<a id="__codelineno-15-175" name="__codelineno-15-175" href="#__codelineno-15-175"></a>
<a id="__codelineno-15-176" name="__codelineno-15-176" href="#__codelineno-15-176"></a>                <span class="n">inplay_only</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">ps</span><span class="p">:</span> <span class="n">ps</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="p">[</span>
<a id="__codelineno-15-177" name="__codelineno-15-177" href="#__codelineno-15-177"></a>                    <span class="n">PriceSize</span><span class="p">(</span>
<a id="__codelineno-15-178" name="__codelineno-15-178" href="#__codelineno-15-178"></a>                        <span class="n">price</span><span class="o">=</span><span class="n">post_ps</span><span class="o">.</span><span class="n">price</span><span class="p">,</span> 
<a id="__codelineno-15-179" name="__codelineno-15-179" href="#__codelineno-15-179"></a>                        <span class="n">size</span><span class="o">=</span><span class="n">post_ps</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="nb">next</span><span class="p">((</span><span class="n">pre_ps</span><span class="o">.</span><span class="n">size</span> <span class="k">for</span> <span class="n">pre_ps</span> <span class="ow">in</span> <span class="n">pre_traded</span> <span class="k">if</span> <span class="n">pre_ps</span><span class="o">.</span><span class="n">price</span> <span class="o">==</span> <span class="n">post_ps</span><span class="o">.</span><span class="n">price</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-15-180" name="__codelineno-15-180" href="#__codelineno-15-180"></a>                    <span class="p">)</span>
<a id="__codelineno-15-181" name="__codelineno-15-181" href="#__codelineno-15-181"></a>                    <span class="k">for</span> <span class="n">post_ps</span> <span class="ow">in</span> <span class="n">post_traded</span> 
<a id="__codelineno-15-182" name="__codelineno-15-182" href="#__codelineno-15-182"></a>                <span class="p">]))</span>
<a id="__codelineno-15-183" name="__codelineno-15-183" href="#__codelineno-15-183"></a>
<a id="__codelineno-15-184" name="__codelineno-15-184" href="#__codelineno-15-184"></a>                <span class="p">(</span><span class="n">ip_wavg</span><span class="p">,</span> <span class="n">ip_matched</span><span class="p">,</span> <span class="n">ip_min</span><span class="p">,</span> <span class="n">ip_max</span><span class="p">)</span> <span class="o">=</span> <span class="n">parse_traded</span><span class="p">(</span><span class="n">inplay_only</span><span class="p">)</span>
<a id="__codelineno-15-185" name="__codelineno-15-185" href="#__codelineno-15-185"></a>                <span class="p">(</span><span class="n">pre_wavg</span><span class="p">,</span> <span class="n">pre_matched</span><span class="p">,</span> <span class="n">pre_min</span><span class="p">,</span> <span class="n">pre_max</span><span class="p">)</span> <span class="o">=</span> <span class="n">parse_traded</span><span class="p">(</span><span class="n">pre_traded</span><span class="p">)</span>
<a id="__codelineno-15-186" name="__codelineno-15-186" href="#__codelineno-15-186"></a>
<a id="__codelineno-15-187" name="__codelineno-15-187" href="#__codelineno-15-187"></a>                <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-15-188" name="__codelineno-15-188" href="#__codelineno-15-188"></a>                    <span class="s1">&#39;preplay_ltp&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">pre_ltp</span><span class="p">),</span>
<a id="__codelineno-15-189" name="__codelineno-15-189" href="#__codelineno-15-189"></a>                    <span class="s1">&#39;preplay_min&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">pre_min</span><span class="p">),</span>
<a id="__codelineno-15-190" name="__codelineno-15-190" href="#__codelineno-15-190"></a>                    <span class="s1">&#39;preplay_max&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">pre_max</span><span class="p">),</span>
<a id="__codelineno-15-191" name="__codelineno-15-191" href="#__codelineno-15-191"></a>                    <span class="s1">&#39;preplay_wavg&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">pre_wavg</span><span class="p">),</span>
<a id="__codelineno-15-192" name="__codelineno-15-192" href="#__codelineno-15-192"></a>                    <span class="s1">&#39;preplay_matched&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">((</span><span class="n">pre_matched</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">sp_traded</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)),</span>
<a id="__codelineno-15-193" name="__codelineno-15-193" href="#__codelineno-15-193"></a>                    <span class="s1">&#39;inplay_ltp&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">post_ltp</span><span class="p">),</span>
<a id="__codelineno-15-194" name="__codelineno-15-194" href="#__codelineno-15-194"></a>                    <span class="s1">&#39;inplay_min&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">ip_min</span><span class="p">),</span>
<a id="__codelineno-15-195" name="__codelineno-15-195" href="#__codelineno-15-195"></a>                    <span class="s1">&#39;inplay_max&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">ip_max</span><span class="p">),</span>
<a id="__codelineno-15-196" name="__codelineno-15-196" href="#__codelineno-15-196"></a>                    <span class="s1">&#39;inplay_wavg&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">ip_wavg</span><span class="p">),</span>
<a id="__codelineno-15-197" name="__codelineno-15-197" href="#__codelineno-15-197"></a>                    <span class="s1">&#39;inplay_matched&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">ip_matched</span><span class="p">),</span>
<a id="__codelineno-15-198" name="__codelineno-15-198" href="#__codelineno-15-198"></a>                <span class="p">}</span>
<a id="__codelineno-15-199" name="__codelineno-15-199" href="#__codelineno-15-199"></a>
<a id="__codelineno-15-200" name="__codelineno-15-200" href="#__codelineno-15-200"></a>            <span class="n">runner_traded</span> <span class="o">=</span> <span class="p">[</span> <span class="n">runner_vals</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">zip_longest</span><span class="p">(</span><span class="n">preplay_traded</span><span class="p">,</span> <span class="n">postplay_traded</span><span class="p">,</span> <span class="n">fillvalue</span><span class="o">=</span><span class="n">PriceSize</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">]</span>
<a id="__codelineno-15-201" name="__codelineno-15-201" href="#__codelineno-15-201"></a>
<a id="__codelineno-15-202" name="__codelineno-15-202" href="#__codelineno-15-202"></a>        <span class="c1"># runner price data for markets that don&#39;t go in play</span>
<a id="__codelineno-15-203" name="__codelineno-15-203" href="#__codelineno-15-203"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-15-204" name="__codelineno-15-204" href="#__codelineno-15-204"></a>            <span class="k">def</span> <span class="nf">runner_vals</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
<a id="__codelineno-15-205" name="__codelineno-15-205" href="#__codelineno-15-205"></a>                <span class="p">(</span><span class="n">ltp</span><span class="p">,</span> <span class="n">traded</span><span class="p">,</span> <span class="n">sp_traded</span><span class="p">)</span> <span class="o">=</span> <span class="n">r</span>
<a id="__codelineno-15-206" name="__codelineno-15-206" href="#__codelineno-15-206"></a>                <span class="p">(</span><span class="n">wavg</span><span class="p">,</span> <span class="n">matched</span><span class="p">,</span> <span class="n">min_price</span><span class="p">,</span> <span class="n">max_price</span><span class="p">)</span> <span class="o">=</span> <span class="n">parse_traded</span><span class="p">(</span><span class="n">traded</span><span class="p">)</span>
<a id="__codelineno-15-207" name="__codelineno-15-207" href="#__codelineno-15-207"></a>
<a id="__codelineno-15-208" name="__codelineno-15-208" href="#__codelineno-15-208"></a>                <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-15-209" name="__codelineno-15-209" href="#__codelineno-15-209"></a>                    <span class="s1">&#39;preplay_ltp&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">ltp</span><span class="p">),</span>
<a id="__codelineno-15-210" name="__codelineno-15-210" href="#__codelineno-15-210"></a>                    <span class="s1">&#39;preplay_min&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">min_price</span><span class="p">),</span>
<a id="__codelineno-15-211" name="__codelineno-15-211" href="#__codelineno-15-211"></a>                    <span class="s1">&#39;preplay_max&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">max_price</span><span class="p">),</span>
<a id="__codelineno-15-212" name="__codelineno-15-212" href="#__codelineno-15-212"></a>                    <span class="s1">&#39;preplay_wavg&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">wavg</span><span class="p">),</span>
<a id="__codelineno-15-213" name="__codelineno-15-213" href="#__codelineno-15-213"></a>                    <span class="s1">&#39;preplay_matched&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">((</span><span class="n">matched</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">sp_traded</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)),</span>
<a id="__codelineno-15-214" name="__codelineno-15-214" href="#__codelineno-15-214"></a>                    <span class="s1">&#39;inplay_ltp&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
<a id="__codelineno-15-215" name="__codelineno-15-215" href="#__codelineno-15-215"></a>                    <span class="s1">&#39;inplay_min&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
<a id="__codelineno-15-216" name="__codelineno-15-216" href="#__codelineno-15-216"></a>                    <span class="s1">&#39;inplay_max&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
<a id="__codelineno-15-217" name="__codelineno-15-217" href="#__codelineno-15-217"></a>                    <span class="s1">&#39;inplay_wavg&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
<a id="__codelineno-15-218" name="__codelineno-15-218" href="#__codelineno-15-218"></a>                    <span class="s1">&#39;inplay_matched&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
<a id="__codelineno-15-219" name="__codelineno-15-219" href="#__codelineno-15-219"></a>                <span class="p">}</span>
<a id="__codelineno-15-220" name="__codelineno-15-220" href="#__codelineno-15-220"></a>
<a id="__codelineno-15-221" name="__codelineno-15-221" href="#__codelineno-15-221"></a>            <span class="n">runner_traded</span> <span class="o">=</span> <span class="p">[</span> <span class="n">runner_vals</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">postplay_traded</span> <span class="p">]</span>
<a id="__codelineno-15-222" name="__codelineno-15-222" href="#__codelineno-15-222"></a>
<a id="__codelineno-15-223" name="__codelineno-15-223" href="#__codelineno-15-223"></a>        <span class="c1"># printing to csv for each runner</span>
<a id="__codelineno-15-224" name="__codelineno-15-224" href="#__codelineno-15-224"></a>        <span class="k">for</span> <span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="n">rprices</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">runner_data</span><span class="p">,</span> <span class="n">runner_traded</span><span class="p">):</span>
<a id="__codelineno-15-225" name="__codelineno-15-225" href="#__codelineno-15-225"></a>            <span class="c1"># defining data to go in each column</span>
<a id="__codelineno-15-226" name="__codelineno-15-226" href="#__codelineno-15-226"></a>            <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
<a id="__codelineno-15-227" name="__codelineno-15-227" href="#__codelineno-15-227"></a>                <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
<a id="__codelineno-15-228" name="__codelineno-15-228" href="#__codelineno-15-228"></a>                    <span class="n">postplay_market</span><span class="o">.</span><span class="n">market_id</span><span class="p">,</span>
<a id="__codelineno-15-229" name="__codelineno-15-229" href="#__codelineno-15-229"></a>                    <span class="n">postplay_market</span><span class="o">.</span><span class="n">market_definition</span><span class="o">.</span><span class="n">market_time</span><span class="p">,</span>
<a id="__codelineno-15-230" name="__codelineno-15-230" href="#__codelineno-15-230"></a>                    <span class="n">postplay_market</span><span class="o">.</span><span class="n">market_definition</span><span class="o">.</span><span class="n">country_code</span><span class="p">,</span>
<a id="__codelineno-15-231" name="__codelineno-15-231" href="#__codelineno-15-231"></a>                    <span class="n">postplay_market</span><span class="o">.</span><span class="n">market_definition</span><span class="o">.</span><span class="n">venue</span><span class="p">,</span>
<a id="__codelineno-15-232" name="__codelineno-15-232" href="#__codelineno-15-232"></a>                    <span class="n">postplay_market</span><span class="o">.</span><span class="n">market_definition</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-15-233" name="__codelineno-15-233" href="#__codelineno-15-233"></a>                    <span class="n">rdata</span><span class="p">[</span><span class="s1">&#39;selection_id&#39;</span><span class="p">],</span>
<a id="__codelineno-15-234" name="__codelineno-15-234" href="#__codelineno-15-234"></a>                    <span class="n">rdata</span><span class="p">[</span><span class="s1">&#39;selection_name&#39;</span><span class="p">],</span>
<a id="__codelineno-15-235" name="__codelineno-15-235" href="#__codelineno-15-235"></a>                    <span class="n">rdata</span><span class="p">[</span><span class="s1">&#39;selection_status&#39;</span><span class="p">],</span>
<a id="__codelineno-15-236" name="__codelineno-15-236" href="#__codelineno-15-236"></a>                    <span class="n">rdata</span><span class="p">[</span><span class="s1">&#39;sp&#39;</span><span class="p">],</span>
<a id="__codelineno-15-237" name="__codelineno-15-237" href="#__codelineno-15-237"></a>                    <span class="n">rprices</span><span class="p">[</span><span class="s1">&#39;preplay_min&#39;</span><span class="p">],</span>
<a id="__codelineno-15-238" name="__codelineno-15-238" href="#__codelineno-15-238"></a>                    <span class="n">rprices</span><span class="p">[</span><span class="s1">&#39;preplay_max&#39;</span><span class="p">],</span>
<a id="__codelineno-15-239" name="__codelineno-15-239" href="#__codelineno-15-239"></a>                    <span class="n">rprices</span><span class="p">[</span><span class="s1">&#39;preplay_wavg&#39;</span><span class="p">],</span>
<a id="__codelineno-15-240" name="__codelineno-15-240" href="#__codelineno-15-240"></a>                    <span class="n">rprices</span><span class="p">[</span><span class="s1">&#39;preplay_ltp&#39;</span><span class="p">],</span>
<a id="__codelineno-15-241" name="__codelineno-15-241" href="#__codelineno-15-241"></a>                    <span class="n">rprices</span><span class="p">[</span><span class="s1">&#39;preplay_matched&#39;</span><span class="p">],</span>
<a id="__codelineno-15-242" name="__codelineno-15-242" href="#__codelineno-15-242"></a>                    <span class="n">rprices</span><span class="p">[</span><span class="s1">&#39;inplay_min&#39;</span><span class="p">],</span>
<a id="__codelineno-15-243" name="__codelineno-15-243" href="#__codelineno-15-243"></a>                    <span class="n">rprices</span><span class="p">[</span><span class="s1">&#39;inplay_max&#39;</span><span class="p">],</span>
<a id="__codelineno-15-244" name="__codelineno-15-244" href="#__codelineno-15-244"></a>                    <span class="n">rprices</span><span class="p">[</span><span class="s1">&#39;inplay_wavg&#39;</span><span class="p">],</span>
<a id="__codelineno-15-245" name="__codelineno-15-245" href="#__codelineno-15-245"></a>                    <span class="n">rprices</span><span class="p">[</span><span class="s1">&#39;inplay_ltp&#39;</span><span class="p">],</span>
<a id="__codelineno-15-246" name="__codelineno-15-246" href="#__codelineno-15-246"></a>                    <span class="n">rprices</span><span class="p">[</span><span class="s1">&#39;inplay_matched&#39;</span><span class="p">],</span>
<a id="__codelineno-15-247" name="__codelineno-15-247" href="#__codelineno-15-247"></a>                <span class="p">)</span>
<a id="__codelineno-15-248" name="__codelineno-15-248" href="#__codelineno-15-248"></a>            <span class="p">)</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p><a href="https://github.com/betfair-down-under/autoHubTutorials/blob/master/jsonToCsvRevisited/json2csv_bflw.py">Download from Github</a></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="kn">import</span> <span class="nn">logging</span>
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span>
<a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a>
<a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a><span class="kn">from</span> <span class="nn">unittest.mock</span> <span class="kn">import</span> <span class="n">patch</span>
<a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a><span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">zip_longest</span>
<a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a><span class="kn">import</span> <span class="nn">functools</span>
<a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a>
<a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a><span class="kn">import</span> <span class="nn">os</span>
<a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a><span class="kn">import</span> <span class="nn">tarfile</span>
<a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a><span class="kn">import</span> <span class="nn">zipfile</span>
<a id="__codelineno-16-11" name="__codelineno-16-11" href="#__codelineno-16-11"></a><span class="kn">import</span> <span class="nn">bz2</span>
<a id="__codelineno-16-12" name="__codelineno-16-12" href="#__codelineno-16-12"></a><span class="kn">import</span> <span class="nn">glob</span>
<a id="__codelineno-16-13" name="__codelineno-16-13" href="#__codelineno-16-13"></a>
<a id="__codelineno-16-14" name="__codelineno-16-14" href="#__codelineno-16-14"></a><span class="c1"># importing data types</span>
<a id="__codelineno-16-15" name="__codelineno-16-15" href="#__codelineno-16-15"></a><span class="kn">import</span> <span class="nn">betfairlightweight</span>
<a id="__codelineno-16-16" name="__codelineno-16-16" href="#__codelineno-16-16"></a><span class="kn">from</span> <span class="nn">betfairlightweight.resources.bettingresources</span> <span class="kn">import</span> <span class="p">(</span>
<a id="__codelineno-16-17" name="__codelineno-16-17" href="#__codelineno-16-17"></a>    <span class="n">PriceSize</span><span class="p">,</span>
<a id="__codelineno-16-18" name="__codelineno-16-18" href="#__codelineno-16-18"></a>    <span class="n">MarketBook</span> 
<a id="__codelineno-16-19" name="__codelineno-16-19" href="#__codelineno-16-19"></a><span class="p">)</span>
<a id="__codelineno-16-20" name="__codelineno-16-20" href="#__codelineno-16-20"></a>
<a id="__codelineno-16-21" name="__codelineno-16-21" href="#__codelineno-16-21"></a><span class="n">file_output</span> <span class="o">=</span> <span class="s2">&quot;output_bflw.csv&quot;</span>
<a id="__codelineno-16-22" name="__codelineno-16-22" href="#__codelineno-16-22"></a>
<a id="__codelineno-16-23" name="__codelineno-16-23" href="#__codelineno-16-23"></a><span class="n">market_paths</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-16-24" name="__codelineno-16-24" href="#__codelineno-16-24"></a>    <span class="s2">&quot;data/2021_10_OctRacingAUPro.tar&quot;</span><span class="p">,</span>
<a id="__codelineno-16-25" name="__codelineno-16-25" href="#__codelineno-16-25"></a>    <span class="s2">&quot;data/2021_11_NovRacingAUPro.tar&quot;</span><span class="p">,</span>
<a id="__codelineno-16-26" name="__codelineno-16-26" href="#__codelineno-16-26"></a>    <span class="s2">&quot;data/2021_12_DecRacingAUPro.tar&quot;</span><span class="p">,</span>
<a id="__codelineno-16-27" name="__codelineno-16-27" href="#__codelineno-16-27"></a><span class="p">]</span>
<a id="__codelineno-16-28" name="__codelineno-16-28" href="#__codelineno-16-28"></a>
<a id="__codelineno-16-29" name="__codelineno-16-29" href="#__codelineno-16-29"></a><span class="c1"># setup logging</span>
<a id="__codelineno-16-30" name="__codelineno-16-30" href="#__codelineno-16-30"></a><span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">FATAL</span><span class="p">)</span>
<a id="__codelineno-16-31" name="__codelineno-16-31" href="#__codelineno-16-31"></a>
<a id="__codelineno-16-32" name="__codelineno-16-32" href="#__codelineno-16-32"></a><span class="c1"># create trading instance (don&#39;t need username/password)</span>
<a id="__codelineno-16-33" name="__codelineno-16-33" href="#__codelineno-16-33"></a><span class="n">trading</span> <span class="o">=</span> <span class="n">betfairlightweight</span><span class="o">.</span><span class="n">APIClient</span><span class="p">(</span><span class="s2">&quot;username&quot;</span><span class="p">,</span> <span class="s2">&quot;password&quot;</span><span class="p">,</span> <span class="s2">&quot;appkey&quot;</span><span class="p">)</span>
<a id="__codelineno-16-34" name="__codelineno-16-34" href="#__codelineno-16-34"></a>
<a id="__codelineno-16-35" name="__codelineno-16-35" href="#__codelineno-16-35"></a><span class="c1"># create listener</span>
<a id="__codelineno-16-36" name="__codelineno-16-36" href="#__codelineno-16-36"></a><span class="n">listener</span> <span class="o">=</span> <span class="n">betfairlightweight</span><span class="o">.</span><span class="n">StreamListener</span><span class="p">(</span>
<a id="__codelineno-16-37" name="__codelineno-16-37" href="#__codelineno-16-37"></a>    <span class="n">max_latency</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>   <span class="c1"># ignore latency errors</span>
<a id="__codelineno-16-38" name="__codelineno-16-38" href="#__codelineno-16-38"></a>    <span class="n">output_queue</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># use generator rather than a queue (faster)</span>
<a id="__codelineno-16-39" name="__codelineno-16-39" href="#__codelineno-16-39"></a>    <span class="n">lightweight</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="c1"># lightweight mode is faster</span>
<a id="__codelineno-16-40" name="__codelineno-16-40" href="#__codelineno-16-40"></a>    <span class="n">update_clk</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>   <span class="c1"># do not update clk on updates (not required when backtesting)</span>
<a id="__codelineno-16-41" name="__codelineno-16-41" href="#__codelineno-16-41"></a>
<a id="__codelineno-16-42" name="__codelineno-16-42" href="#__codelineno-16-42"></a>    <span class="n">cumulative_runner_tv</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
<a id="__codelineno-16-43" name="__codelineno-16-43" href="#__codelineno-16-43"></a>    <span class="n">calculate_market_tv</span><span class="o">=</span><span class="kc">True</span>
<a id="__codelineno-16-44" name="__codelineno-16-44" href="#__codelineno-16-44"></a><span class="p">)</span>
<a id="__codelineno-16-45" name="__codelineno-16-45" href="#__codelineno-16-45"></a>
<a id="__codelineno-16-46" name="__codelineno-16-46" href="#__codelineno-16-46"></a><span class="c1"># loading from tar and extracting files</span>
<a id="__codelineno-16-47" name="__codelineno-16-47" href="#__codelineno-16-47"></a><span class="k">def</span> <span class="nf">load_markets</span><span class="p">(</span><span class="n">file_paths</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
<a id="__codelineno-16-48" name="__codelineno-16-48" href="#__codelineno-16-48"></a>    <span class="k">for</span> <span class="n">file_path</span> <span class="ow">in</span> <span class="n">file_paths</span><span class="p">:</span>
<a id="__codelineno-16-49" name="__codelineno-16-49" href="#__codelineno-16-49"></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
<a id="__codelineno-16-50" name="__codelineno-16-50" href="#__codelineno-16-50"></a>            <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">iglob</span><span class="p">(</span><span class="n">file_path</span> <span class="o">+</span> <span class="s1">&#39;**/**/*.bz2&#39;</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<a id="__codelineno-16-51" name="__codelineno-16-51" href="#__codelineno-16-51"></a>                <span class="n">f</span> <span class="o">=</span> <span class="n">bz2</span><span class="o">.</span><span class="n">BZ2File</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
<a id="__codelineno-16-52" name="__codelineno-16-52" href="#__codelineno-16-52"></a>                <span class="k">yield</span> <span class="n">f</span>
<a id="__codelineno-16-53" name="__codelineno-16-53" href="#__codelineno-16-53"></a>                <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<a id="__codelineno-16-54" name="__codelineno-16-54" href="#__codelineno-16-54"></a>        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
<a id="__codelineno-16-55" name="__codelineno-16-55" href="#__codelineno-16-55"></a>            <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file_path</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-16-56" name="__codelineno-16-56" href="#__codelineno-16-56"></a>            <span class="c1"># iterate through a tar archive</span>
<a id="__codelineno-16-57" name="__codelineno-16-57" href="#__codelineno-16-57"></a>            <span class="k">if</span> <span class="n">ext</span> <span class="o">==</span> <span class="s1">&#39;.tar&#39;</span><span class="p">:</span>
<a id="__codelineno-16-58" name="__codelineno-16-58" href="#__codelineno-16-58"></a>                <span class="k">with</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">TarFile</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">archive</span><span class="p">:</span>
<a id="__codelineno-16-59" name="__codelineno-16-59" href="#__codelineno-16-59"></a>                    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">archive</span><span class="p">:</span>
<a id="__codelineno-16-60" name="__codelineno-16-60" href="#__codelineno-16-60"></a>                        <span class="k">yield</span> <span class="n">bz2</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">archive</span><span class="o">.</span><span class="n">extractfile</span><span class="p">(</span><span class="n">file</span><span class="p">))</span>
<a id="__codelineno-16-61" name="__codelineno-16-61" href="#__codelineno-16-61"></a>            <span class="c1"># or a zip archive</span>
<a id="__codelineno-16-62" name="__codelineno-16-62" href="#__codelineno-16-62"></a>            <span class="k">elif</span> <span class="n">ext</span> <span class="o">==</span> <span class="s1">&#39;.zip&#39;</span><span class="p">:</span>
<a id="__codelineno-16-63" name="__codelineno-16-63" href="#__codelineno-16-63"></a>                <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">archive</span><span class="p">:</span>
<a id="__codelineno-16-64" name="__codelineno-16-64" href="#__codelineno-16-64"></a>                    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">archive</span><span class="o">.</span><span class="n">namelist</span><span class="p">():</span>
<a id="__codelineno-16-65" name="__codelineno-16-65" href="#__codelineno-16-65"></a>                        <span class="k">yield</span> <span class="n">bz2</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">archive</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file</span><span class="p">))</span>
<a id="__codelineno-16-66" name="__codelineno-16-66" href="#__codelineno-16-66"></a>    <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-16-67" name="__codelineno-16-67" href="#__codelineno-16-67"></a>
<a id="__codelineno-16-68" name="__codelineno-16-68" href="#__codelineno-16-68"></a><span class="c1"># rounding to 2 decimal places or returning &#39;&#39; if blank</span>
<a id="__codelineno-16-69" name="__codelineno-16-69" href="#__codelineno-16-69"></a><span class="k">def</span> <span class="nf">as_str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-16-70" name="__codelineno-16-70" href="#__codelineno-16-70"></a>    <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">v</span> <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="n">v</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
<a id="__codelineno-16-71" name="__codelineno-16-71" href="#__codelineno-16-71"></a>
<a id="__codelineno-16-72" name="__codelineno-16-72" href="#__codelineno-16-72"></a><span class="c1"># returning smaller of two numbers where min not 0</span>
<a id="__codelineno-16-73" name="__codelineno-16-73" href="#__codelineno-16-73"></a><span class="k">def</span> <span class="nf">min_gr0</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<a id="__codelineno-16-74" name="__codelineno-16-74" href="#__codelineno-16-74"></a>    <span class="k">if</span> <span class="n">a</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-16-75" name="__codelineno-16-75" href="#__codelineno-16-75"></a>        <span class="k">return</span> <span class="n">b</span>
<a id="__codelineno-16-76" name="__codelineno-16-76" href="#__codelineno-16-76"></a>    <span class="k">if</span> <span class="n">b</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-16-77" name="__codelineno-16-77" href="#__codelineno-16-77"></a>        <span class="k">return</span> <span class="n">a</span>
<a id="__codelineno-16-78" name="__codelineno-16-78" href="#__codelineno-16-78"></a>
<a id="__codelineno-16-79" name="__codelineno-16-79" href="#__codelineno-16-79"></a>    <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
<a id="__codelineno-16-80" name="__codelineno-16-80" href="#__codelineno-16-80"></a>
<a id="__codelineno-16-81" name="__codelineno-16-81" href="#__codelineno-16-81"></a><span class="c1"># parsing price data and pulling out weighted avg price, matched, min price and max price</span>
<a id="__codelineno-16-82" name="__codelineno-16-82" href="#__codelineno-16-82"></a><span class="k">def</span> <span class="nf">parse_traded</span><span class="p">(</span><span class="n">traded</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">PriceSize</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<a id="__codelineno-16-83" name="__codelineno-16-83" href="#__codelineno-16-83"></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">traded</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> 
<a id="__codelineno-16-84" name="__codelineno-16-84" href="#__codelineno-16-84"></a>        <span class="k">return</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-16-85" name="__codelineno-16-85" href="#__codelineno-16-85"></a>
<a id="__codelineno-16-86" name="__codelineno-16-86" href="#__codelineno-16-86"></a>    <span class="p">(</span><span class="n">wavg_sum</span><span class="p">,</span> <span class="n">matched</span><span class="p">,</span> <span class="n">min_price</span><span class="p">,</span> <span class="n">max_price</span><span class="p">)</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span>
<a id="__codelineno-16-87" name="__codelineno-16-87" href="#__codelineno-16-87"></a>        <span class="k">lambda</span> <span class="n">total</span><span class="p">,</span> <span class="n">ps</span><span class="p">:</span> <span class="p">(</span>
<a id="__codelineno-16-88" name="__codelineno-16-88" href="#__codelineno-16-88"></a>            <span class="n">total</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">ps</span><span class="o">.</span><span class="n">price</span> <span class="o">*</span> <span class="n">ps</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="c1"># wavg_sum before we divide by total matched</span>
<a id="__codelineno-16-89" name="__codelineno-16-89" href="#__codelineno-16-89"></a>            <span class="n">total</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">ps</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="c1"># total matched</span>
<a id="__codelineno-16-90" name="__codelineno-16-90" href="#__codelineno-16-90"></a>            <span class="nb">min</span><span class="p">(</span><span class="n">total</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">ps</span><span class="o">.</span><span class="n">price</span><span class="p">),</span> <span class="c1"># min price matched</span>
<a id="__codelineno-16-91" name="__codelineno-16-91" href="#__codelineno-16-91"></a>            <span class="nb">max</span><span class="p">(</span><span class="n">total</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">ps</span><span class="o">.</span><span class="n">price</span><span class="p">),</span> <span class="c1"># max price matched</span>
<a id="__codelineno-16-92" name="__codelineno-16-92" href="#__codelineno-16-92"></a>        <span class="p">),</span>
<a id="__codelineno-16-93" name="__codelineno-16-93" href="#__codelineno-16-93"></a>        <span class="n">traded</span><span class="p">,</span>
<a id="__codelineno-16-94" name="__codelineno-16-94" href="#__codelineno-16-94"></a>        <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1001</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c1"># starting default values</span>
<a id="__codelineno-16-95" name="__codelineno-16-95" href="#__codelineno-16-95"></a>    <span class="p">)</span>
<a id="__codelineno-16-96" name="__codelineno-16-96" href="#__codelineno-16-96"></a>
<a id="__codelineno-16-97" name="__codelineno-16-97" href="#__codelineno-16-97"></a>    <span class="n">wavg_sum</span> <span class="o">=</span> <span class="p">(</span><span class="n">wavg_sum</span> <span class="o">/</span> <span class="n">matched</span><span class="p">)</span> <span class="k">if</span> <span class="n">matched</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span> <span class="c1"># dividing sum of wavg by total matched</span>
<a id="__codelineno-16-98" name="__codelineno-16-98" href="#__codelineno-16-98"></a>    <span class="n">matched</span> <span class="o">=</span> <span class="n">matched</span> <span class="k">if</span> <span class="n">matched</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span> 
<a id="__codelineno-16-99" name="__codelineno-16-99" href="#__codelineno-16-99"></a>    <span class="n">min_price</span> <span class="o">=</span> <span class="n">min_price</span> <span class="k">if</span> <span class="n">min_price</span> <span class="o">!=</span> <span class="mi">1001</span> <span class="k">else</span> <span class="kc">None</span>
<a id="__codelineno-16-100" name="__codelineno-16-100" href="#__codelineno-16-100"></a>    <span class="n">max_price</span> <span class="o">=</span> <span class="n">max_price</span> <span class="k">if</span> <span class="n">max_price</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span>
<a id="__codelineno-16-101" name="__codelineno-16-101" href="#__codelineno-16-101"></a>
<a id="__codelineno-16-102" name="__codelineno-16-102" href="#__codelineno-16-102"></a>    <span class="k">return</span> <span class="p">(</span><span class="n">wavg_sum</span><span class="p">,</span> <span class="n">matched</span><span class="p">,</span> <span class="n">min_price</span><span class="p">,</span> <span class="n">max_price</span><span class="p">)</span>
<a id="__codelineno-16-103" name="__codelineno-16-103" href="#__codelineno-16-103"></a>
<a id="__codelineno-16-104" name="__codelineno-16-104" href="#__codelineno-16-104"></a><span class="c1"># splitting race name and returning the parts </span>
<a id="__codelineno-16-105" name="__codelineno-16-105" href="#__codelineno-16-105"></a><span class="k">def</span> <span class="nf">split_anz_horse_market_name</span><span class="p">(</span><span class="n">market_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<a id="__codelineno-16-106" name="__codelineno-16-106" href="#__codelineno-16-106"></a>    <span class="c1"># return race no, length, race type</span>
<a id="__codelineno-16-107" name="__codelineno-16-107" href="#__codelineno-16-107"></a>    <span class="c1"># input samples: </span>
<a id="__codelineno-16-108" name="__codelineno-16-108" href="#__codelineno-16-108"></a>    <span class="c1"># &#39;R6 1400m Grp1&#39; -&gt; (&#39;R6&#39;,&#39;1400m&#39;,&#39;grp1&#39;)</span>
<a id="__codelineno-16-109" name="__codelineno-16-109" href="#__codelineno-16-109"></a>    <span class="c1"># &#39;R1 1609m Trot M&#39; -&gt; (&#39;R1&#39;, &#39;1609m&#39;, &#39;trot&#39;)</span>
<a id="__codelineno-16-110" name="__codelineno-16-110" href="#__codelineno-16-110"></a>    <span class="c1"># &#39;R4 1660m Pace M&#39; -&gt; (&#39;R4&#39;, &#39;1660m&#39;, &#39;pace&#39;)</span>
<a id="__codelineno-16-111" name="__codelineno-16-111" href="#__codelineno-16-111"></a>    <span class="n">parts</span> <span class="o">=</span> <span class="n">market_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
<a id="__codelineno-16-112" name="__codelineno-16-112" href="#__codelineno-16-112"></a>    <span class="n">race_no</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> 
<a id="__codelineno-16-113" name="__codelineno-16-113" href="#__codelineno-16-113"></a>    <span class="n">race_len</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> 
<a id="__codelineno-16-114" name="__codelineno-16-114" href="#__codelineno-16-114"></a>    <span class="n">race_type</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> 
<a id="__codelineno-16-115" name="__codelineno-16-115" href="#__codelineno-16-115"></a>
<a id="__codelineno-16-116" name="__codelineno-16-116" href="#__codelineno-16-116"></a>    <span class="k">return</span> <span class="p">(</span><span class="n">race_no</span><span class="p">,</span> <span class="n">race_len</span><span class="p">,</span> <span class="n">race_type</span><span class="p">)</span>
<a id="__codelineno-16-117" name="__codelineno-16-117" href="#__codelineno-16-117"></a>
<a id="__codelineno-16-118" name="__codelineno-16-118" href="#__codelineno-16-118"></a><span class="c1"># filtering markets to those that fit the following criteria</span>
<a id="__codelineno-16-119" name="__codelineno-16-119" href="#__codelineno-16-119"></a><span class="k">def</span> <span class="nf">filter_market</span><span class="p">(</span><span class="n">market</span><span class="p">:</span> <span class="n">MarketBook</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span> 
<a id="__codelineno-16-120" name="__codelineno-16-120" href="#__codelineno-16-120"></a>    <span class="n">d</span> <span class="o">=</span> <span class="n">market</span><span class="o">.</span><span class="n">market_definition</span>
<a id="__codelineno-16-121" name="__codelineno-16-121" href="#__codelineno-16-121"></a>    <span class="k">return</span> <span class="p">(</span><span class="n">d</span> <span class="o">!=</span> <span class="kc">None</span>
<a id="__codelineno-16-122" name="__codelineno-16-122" href="#__codelineno-16-122"></a>        <span class="ow">and</span> <span class="n">d</span><span class="o">.</span><span class="n">country_code</span> <span class="o">==</span> <span class="s1">&#39;AU&#39;</span> 
<a id="__codelineno-16-123" name="__codelineno-16-123" href="#__codelineno-16-123"></a>        <span class="ow">and</span> <span class="n">d</span><span class="o">.</span><span class="n">market_type</span> <span class="o">==</span> <span class="s1">&#39;WIN&#39;</span> 
<a id="__codelineno-16-124" name="__codelineno-16-124" href="#__codelineno-16-124"></a>        <span class="ow">and</span> <span class="p">(</span><span class="n">c</span> <span class="o">:=</span> <span class="n">split_anz_horse_market_name</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">name</span><span class="p">)[</span><span class="mi">2</span><span class="p">])</span> <span class="o">!=</span> <span class="s1">&#39;trot&#39;</span> <span class="ow">and</span> <span class="n">c</span> <span class="o">!=</span> <span class="s1">&#39;pace&#39;</span><span class="p">)</span>
<a id="__codelineno-16-125" name="__codelineno-16-125" href="#__codelineno-16-125"></a>
<a id="__codelineno-16-126" name="__codelineno-16-126" href="#__codelineno-16-126"></a><span class="c1"># record prices to a file</span>
<a id="__codelineno-16-127" name="__codelineno-16-127" href="#__codelineno-16-127"></a><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_output</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">output</span><span class="p">:</span>
<a id="__codelineno-16-128" name="__codelineno-16-128" href="#__codelineno-16-128"></a>    <span class="c1"># defining column headers</span>
<a id="__codelineno-16-129" name="__codelineno-16-129" href="#__codelineno-16-129"></a>    <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;market_id,event_date,country,track,market_name,selection_id,selection_name,result,bsp,pp_min,pp_max,pp_wap,pp_ltp,pp_volume,ip_min,ip_max,ip_wap,ip_ltp,ip_volume</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-16-130" name="__codelineno-16-130" href="#__codelineno-16-130"></a>
<a id="__codelineno-16-131" name="__codelineno-16-131" href="#__codelineno-16-131"></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">file_obj</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">load_markets</span><span class="p">(</span><span class="n">market_paths</span><span class="p">)):</span>
<a id="__codelineno-16-132" name="__codelineno-16-132" href="#__codelineno-16-132"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Market </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-16-133" name="__codelineno-16-133" href="#__codelineno-16-133"></a>
<a id="__codelineno-16-134" name="__codelineno-16-134" href="#__codelineno-16-134"></a>        <span class="n">stream</span> <span class="o">=</span> <span class="n">trading</span><span class="o">.</span><span class="n">streaming</span><span class="o">.</span><span class="n">create_historical_generator_stream</span><span class="p">(</span>
<a id="__codelineno-16-135" name="__codelineno-16-135" href="#__codelineno-16-135"></a>            <span class="n">file_path</span><span class="o">=</span><span class="n">file_obj</span><span class="p">,</span>
<a id="__codelineno-16-136" name="__codelineno-16-136" href="#__codelineno-16-136"></a>            <span class="n">listener</span><span class="o">=</span><span class="n">listener</span><span class="p">,</span>
<a id="__codelineno-16-137" name="__codelineno-16-137" href="#__codelineno-16-137"></a>        <span class="p">)</span>
<a id="__codelineno-16-138" name="__codelineno-16-138" href="#__codelineno-16-138"></a>
<a id="__codelineno-16-139" name="__codelineno-16-139" href="#__codelineno-16-139"></a>        <span class="k">def</span> <span class="nf">get_pre_post_final</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
<a id="__codelineno-16-140" name="__codelineno-16-140" href="#__codelineno-16-140"></a>            <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s2">&quot;builtins.open&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">f</span><span class="p">,</span> <span class="n">_</span><span class="p">:</span> <span class="n">f</span><span class="p">):</span>   
<a id="__codelineno-16-141" name="__codelineno-16-141" href="#__codelineno-16-141"></a>                <span class="n">eval_market</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-16-142" name="__codelineno-16-142" href="#__codelineno-16-142"></a>                <span class="n">prev_market</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-16-143" name="__codelineno-16-143" href="#__codelineno-16-143"></a>                <span class="n">preplay_market</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-16-144" name="__codelineno-16-144" href="#__codelineno-16-144"></a>                <span class="n">postplay_market</span> <span class="o">=</span> <span class="kc">None</span>       
<a id="__codelineno-16-145" name="__codelineno-16-145" href="#__codelineno-16-145"></a>
<a id="__codelineno-16-146" name="__codelineno-16-146" href="#__codelineno-16-146"></a>                <span class="n">gen</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">get_generator</span><span class="p">()</span>
<a id="__codelineno-16-147" name="__codelineno-16-147" href="#__codelineno-16-147"></a>
<a id="__codelineno-16-148" name="__codelineno-16-148" href="#__codelineno-16-148"></a>                <span class="k">for</span> <span class="n">market_books</span> <span class="ow">in</span> <span class="n">gen</span><span class="p">():</span>
<a id="__codelineno-16-149" name="__codelineno-16-149" href="#__codelineno-16-149"></a>                    <span class="k">for</span> <span class="n">market_book</span> <span class="ow">in</span> <span class="n">market_books</span><span class="p">:</span>
<a id="__codelineno-16-150" name="__codelineno-16-150" href="#__codelineno-16-150"></a>                        <span class="c1"># if market doesn&#39;t meet filter return out</span>
<a id="__codelineno-16-151" name="__codelineno-16-151" href="#__codelineno-16-151"></a>                        <span class="k">if</span> <span class="n">eval_market</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">((</span><span class="n">eval_market</span> <span class="o">:=</span> <span class="n">filter_market</span><span class="p">(</span><span class="n">market_book</span><span class="p">))</span> <span class="o">==</span> <span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-16-152" name="__codelineno-16-152" href="#__codelineno-16-152"></a>                            <span class="k">return</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-16-153" name="__codelineno-16-153" href="#__codelineno-16-153"></a>
<a id="__codelineno-16-154" name="__codelineno-16-154" href="#__codelineno-16-154"></a>                        <span class="c1"># final market view before market goes in play</span>
<a id="__codelineno-16-155" name="__codelineno-16-155" href="#__codelineno-16-155"></a>                        <span class="k">if</span> <span class="n">prev_market</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">prev_market</span><span class="o">.</span><span class="n">inplay</span> <span class="o">!=</span> <span class="n">market_book</span><span class="o">.</span><span class="n">inplay</span><span class="p">:</span>
<a id="__codelineno-16-156" name="__codelineno-16-156" href="#__codelineno-16-156"></a>                            <span class="n">preplay_market</span> <span class="o">=</span> <span class="n">prev_market</span>
<a id="__codelineno-16-157" name="__codelineno-16-157" href="#__codelineno-16-157"></a>
<a id="__codelineno-16-158" name="__codelineno-16-158" href="#__codelineno-16-158"></a>                        <span class="c1"># final market view at the conclusion of the market</span>
<a id="__codelineno-16-159" name="__codelineno-16-159" href="#__codelineno-16-159"></a>                        <span class="k">if</span> <span class="n">prev_market</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">prev_market</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;OPEN&quot;</span> <span class="ow">and</span> <span class="n">market_book</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="n">prev_market</span><span class="o">.</span><span class="n">status</span><span class="p">:</span>
<a id="__codelineno-16-160" name="__codelineno-16-160" href="#__codelineno-16-160"></a>                            <span class="n">postplay_market</span> <span class="o">=</span> <span class="n">market_book</span>
<a id="__codelineno-16-161" name="__codelineno-16-161" href="#__codelineno-16-161"></a>
<a id="__codelineno-16-162" name="__codelineno-16-162" href="#__codelineno-16-162"></a>                        <span class="c1"># update reference to previous market</span>
<a id="__codelineno-16-163" name="__codelineno-16-163" href="#__codelineno-16-163"></a>                        <span class="n">prev_market</span> <span class="o">=</span> <span class="n">market_book</span>
<a id="__codelineno-16-164" name="__codelineno-16-164" href="#__codelineno-16-164"></a>
<a id="__codelineno-16-165" name="__codelineno-16-165" href="#__codelineno-16-165"></a>                <span class="k">return</span> <span class="p">(</span><span class="n">preplay_market</span><span class="p">,</span> <span class="n">postplay_market</span><span class="p">,</span> <span class="n">prev_market</span><span class="p">)</span> <span class="c1"># prev is now final</span>
<a id="__codelineno-16-166" name="__codelineno-16-166" href="#__codelineno-16-166"></a>
<a id="__codelineno-16-167" name="__codelineno-16-167" href="#__codelineno-16-167"></a>        <span class="p">(</span><span class="n">preplay_market</span><span class="p">,</span> <span class="n">postplay_market</span><span class="p">,</span> <span class="n">final_market</span><span class="p">)</span> <span class="o">=</span> <span class="n">get_pre_post_final</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
<a id="__codelineno-16-168" name="__codelineno-16-168" href="#__codelineno-16-168"></a>
<a id="__codelineno-16-169" name="__codelineno-16-169" href="#__codelineno-16-169"></a>        <span class="c1"># no price data for market</span>
<a id="__codelineno-16-170" name="__codelineno-16-170" href="#__codelineno-16-170"></a>        <span class="k">if</span> <span class="n">postplay_market</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-16-171" name="__codelineno-16-171" href="#__codelineno-16-171"></a>            <span class="k">continue</span><span class="p">;</span> 
<a id="__codelineno-16-172" name="__codelineno-16-172" href="#__codelineno-16-172"></a>
<a id="__codelineno-16-173" name="__codelineno-16-173" href="#__codelineno-16-173"></a>        <span class="n">preplay_traded</span> <span class="o">=</span> <span class="p">[</span> <span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">last_price_traded</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">traded_volume</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">preplay_market</span><span class="o">.</span><span class="n">runners</span> <span class="p">]</span> <span class="k">if</span> <span class="n">preplay_market</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
<a id="__codelineno-16-174" name="__codelineno-16-174" href="#__codelineno-16-174"></a>        <span class="n">postplay_traded</span> <span class="o">=</span> <span class="p">[</span> <span class="p">(</span>
<a id="__codelineno-16-175" name="__codelineno-16-175" href="#__codelineno-16-175"></a>            <span class="n">r</span><span class="o">.</span><span class="n">last_price_traded</span><span class="p">,</span>
<a id="__codelineno-16-176" name="__codelineno-16-176" href="#__codelineno-16-176"></a>            <span class="n">r</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">traded_volume</span><span class="p">,</span>
<a id="__codelineno-16-177" name="__codelineno-16-177" href="#__codelineno-16-177"></a>            <span class="c1"># calculating SP traded vol as smaller of back_stake_taken or (lay_liability_taken / (BSP - 1))        </span>
<a id="__codelineno-16-178" name="__codelineno-16-178" href="#__codelineno-16-178"></a>            <span class="n">min_gr0</span><span class="p">(</span>
<a id="__codelineno-16-179" name="__codelineno-16-179" href="#__codelineno-16-179"></a>                <span class="nb">next</span><span class="p">((</span><span class="n">pv</span><span class="o">.</span><span class="n">size</span> <span class="k">for</span> <span class="n">pv</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">back_stake_taken</span> <span class="k">if</span> <span class="n">pv</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">0</span><span class="p">),</span>
<a id="__codelineno-16-180" name="__codelineno-16-180" href="#__codelineno-16-180"></a>                <span class="nb">next</span><span class="p">((</span><span class="n">pv</span><span class="o">.</span><span class="n">size</span> <span class="k">for</span> <span class="n">pv</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">lay_liability_taken</span> <span class="k">if</span> <span class="n">pv</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>  <span class="o">/</span> <span class="p">((</span><span class="n">r</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">actual_sp</span> <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">actual_sp</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">actual_sp</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-16-181" name="__codelineno-16-181" href="#__codelineno-16-181"></a>            <span class="p">)</span> <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">actual_sp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-16-182" name="__codelineno-16-182" href="#__codelineno-16-182"></a>        <span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">postplay_market</span><span class="o">.</span><span class="n">runners</span> <span class="p">]</span>
<a id="__codelineno-16-183" name="__codelineno-16-183" href="#__codelineno-16-183"></a>
<a id="__codelineno-16-184" name="__codelineno-16-184" href="#__codelineno-16-184"></a>        <span class="c1"># generic runner data</span>
<a id="__codelineno-16-185" name="__codelineno-16-185" href="#__codelineno-16-185"></a>        <span class="n">runner_data</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-16-186" name="__codelineno-16-186" href="#__codelineno-16-186"></a>            <span class="p">{</span>
<a id="__codelineno-16-187" name="__codelineno-16-187" href="#__codelineno-16-187"></a>                <span class="s1">&#39;selection_id&#39;</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">selection_id</span><span class="p">,</span>
<a id="__codelineno-16-188" name="__codelineno-16-188" href="#__codelineno-16-188"></a>                <span class="s1">&#39;selection_name&#39;</span><span class="p">:</span> <span class="nb">next</span><span class="p">((</span><span class="n">rd</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">rd</span> <span class="ow">in</span> <span class="n">final_market</span><span class="o">.</span><span class="n">market_definition</span><span class="o">.</span><span class="n">runners</span> <span class="k">if</span> <span class="n">rd</span><span class="o">.</span><span class="n">selection_id</span> <span class="o">==</span> <span class="n">r</span><span class="o">.</span><span class="n">selection_id</span><span class="p">),</span> <span class="kc">None</span><span class="p">),</span>
<a id="__codelineno-16-189" name="__codelineno-16-189" href="#__codelineno-16-189"></a>                <span class="s1">&#39;selection_status&#39;</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
<a id="__codelineno-16-190" name="__codelineno-16-190" href="#__codelineno-16-190"></a>                <span class="s1">&#39;sp&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">actual_sp</span><span class="p">),</span>
<a id="__codelineno-16-191" name="__codelineno-16-191" href="#__codelineno-16-191"></a>            <span class="p">}</span>
<a id="__codelineno-16-192" name="__codelineno-16-192" href="#__codelineno-16-192"></a>            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">final_market</span><span class="o">.</span><span class="n">runners</span> 
<a id="__codelineno-16-193" name="__codelineno-16-193" href="#__codelineno-16-193"></a>        <span class="p">]</span>
<a id="__codelineno-16-194" name="__codelineno-16-194" href="#__codelineno-16-194"></a>
<a id="__codelineno-16-195" name="__codelineno-16-195" href="#__codelineno-16-195"></a>        <span class="c1"># runner price data for markets that go in play</span>
<a id="__codelineno-16-196" name="__codelineno-16-196" href="#__codelineno-16-196"></a>        <span class="k">if</span> <span class="n">preplay_traded</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-16-197" name="__codelineno-16-197" href="#__codelineno-16-197"></a>            <span class="k">def</span> <span class="nf">runner_vals</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
<a id="__codelineno-16-198" name="__codelineno-16-198" href="#__codelineno-16-198"></a>                <span class="p">(</span><span class="n">pre_ltp</span><span class="p">,</span> <span class="n">pre_traded</span><span class="p">),</span> <span class="p">(</span><span class="n">post_ltp</span><span class="p">,</span> <span class="n">post_traded</span><span class="p">,</span> <span class="n">sp_traded</span><span class="p">)</span> <span class="o">=</span> <span class="n">r</span>
<a id="__codelineno-16-199" name="__codelineno-16-199" href="#__codelineno-16-199"></a>
<a id="__codelineno-16-200" name="__codelineno-16-200" href="#__codelineno-16-200"></a>                <span class="n">inplay_only</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">ps</span><span class="p">:</span> <span class="n">ps</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="p">[</span>
<a id="__codelineno-16-201" name="__codelineno-16-201" href="#__codelineno-16-201"></a>                    <span class="n">PriceSize</span><span class="p">(</span>
<a id="__codelineno-16-202" name="__codelineno-16-202" href="#__codelineno-16-202"></a>                        <span class="n">price</span><span class="o">=</span><span class="n">post_ps</span><span class="o">.</span><span class="n">price</span><span class="p">,</span> 
<a id="__codelineno-16-203" name="__codelineno-16-203" href="#__codelineno-16-203"></a>                        <span class="n">size</span><span class="o">=</span><span class="n">post_ps</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="nb">next</span><span class="p">((</span><span class="n">pre_ps</span><span class="o">.</span><span class="n">size</span> <span class="k">for</span> <span class="n">pre_ps</span> <span class="ow">in</span> <span class="n">pre_traded</span> <span class="k">if</span> <span class="n">pre_ps</span><span class="o">.</span><span class="n">price</span> <span class="o">==</span> <span class="n">post_ps</span><span class="o">.</span><span class="n">price</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-16-204" name="__codelineno-16-204" href="#__codelineno-16-204"></a>                    <span class="p">)</span>
<a id="__codelineno-16-205" name="__codelineno-16-205" href="#__codelineno-16-205"></a>                    <span class="k">for</span> <span class="n">post_ps</span> <span class="ow">in</span> <span class="n">post_traded</span> 
<a id="__codelineno-16-206" name="__codelineno-16-206" href="#__codelineno-16-206"></a>                <span class="p">]))</span>
<a id="__codelineno-16-207" name="__codelineno-16-207" href="#__codelineno-16-207"></a>
<a id="__codelineno-16-208" name="__codelineno-16-208" href="#__codelineno-16-208"></a>                <span class="p">(</span><span class="n">ip_wavg</span><span class="p">,</span> <span class="n">ip_matched</span><span class="p">,</span> <span class="n">ip_min</span><span class="p">,</span> <span class="n">ip_max</span><span class="p">)</span> <span class="o">=</span> <span class="n">parse_traded</span><span class="p">(</span><span class="n">inplay_only</span><span class="p">)</span>
<a id="__codelineno-16-209" name="__codelineno-16-209" href="#__codelineno-16-209"></a>                <span class="p">(</span><span class="n">pre_wavg</span><span class="p">,</span> <span class="n">pre_matched</span><span class="p">,</span> <span class="n">pre_min</span><span class="p">,</span> <span class="n">pre_max</span><span class="p">)</span> <span class="o">=</span> <span class="n">parse_traded</span><span class="p">(</span><span class="n">pre_traded</span><span class="p">)</span>
<a id="__codelineno-16-210" name="__codelineno-16-210" href="#__codelineno-16-210"></a>
<a id="__codelineno-16-211" name="__codelineno-16-211" href="#__codelineno-16-211"></a>                <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-16-212" name="__codelineno-16-212" href="#__codelineno-16-212"></a>                    <span class="s1">&#39;preplay_ltp&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">pre_ltp</span><span class="p">),</span>
<a id="__codelineno-16-213" name="__codelineno-16-213" href="#__codelineno-16-213"></a>                    <span class="s1">&#39;preplay_min&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">pre_min</span><span class="p">),</span>
<a id="__codelineno-16-214" name="__codelineno-16-214" href="#__codelineno-16-214"></a>                    <span class="s1">&#39;preplay_max&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">pre_max</span><span class="p">),</span>
<a id="__codelineno-16-215" name="__codelineno-16-215" href="#__codelineno-16-215"></a>                    <span class="s1">&#39;preplay_wavg&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">pre_wavg</span><span class="p">),</span>
<a id="__codelineno-16-216" name="__codelineno-16-216" href="#__codelineno-16-216"></a>                    <span class="s1">&#39;preplay_matched&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">((</span><span class="n">pre_matched</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">sp_traded</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)),</span>
<a id="__codelineno-16-217" name="__codelineno-16-217" href="#__codelineno-16-217"></a>                    <span class="s1">&#39;inplay_ltp&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">post_ltp</span><span class="p">),</span>
<a id="__codelineno-16-218" name="__codelineno-16-218" href="#__codelineno-16-218"></a>                    <span class="s1">&#39;inplay_min&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">ip_min</span><span class="p">),</span>
<a id="__codelineno-16-219" name="__codelineno-16-219" href="#__codelineno-16-219"></a>                    <span class="s1">&#39;inplay_max&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">ip_max</span><span class="p">),</span>
<a id="__codelineno-16-220" name="__codelineno-16-220" href="#__codelineno-16-220"></a>                    <span class="s1">&#39;inplay_wavg&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">ip_wavg</span><span class="p">),</span>
<a id="__codelineno-16-221" name="__codelineno-16-221" href="#__codelineno-16-221"></a>                    <span class="s1">&#39;inplay_matched&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">ip_matched</span><span class="p">),</span>
<a id="__codelineno-16-222" name="__codelineno-16-222" href="#__codelineno-16-222"></a>                <span class="p">}</span>
<a id="__codelineno-16-223" name="__codelineno-16-223" href="#__codelineno-16-223"></a>
<a id="__codelineno-16-224" name="__codelineno-16-224" href="#__codelineno-16-224"></a>            <span class="n">runner_traded</span> <span class="o">=</span> <span class="p">[</span> <span class="n">runner_vals</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">zip_longest</span><span class="p">(</span><span class="n">preplay_traded</span><span class="p">,</span> <span class="n">postplay_traded</span><span class="p">,</span> <span class="n">fillvalue</span><span class="o">=</span><span class="n">PriceSize</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">]</span>
<a id="__codelineno-16-225" name="__codelineno-16-225" href="#__codelineno-16-225"></a>
<a id="__codelineno-16-226" name="__codelineno-16-226" href="#__codelineno-16-226"></a>        <span class="c1"># runner price data for markets that don&#39;t go in play</span>
<a id="__codelineno-16-227" name="__codelineno-16-227" href="#__codelineno-16-227"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-16-228" name="__codelineno-16-228" href="#__codelineno-16-228"></a>            <span class="k">def</span> <span class="nf">runner_vals</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
<a id="__codelineno-16-229" name="__codelineno-16-229" href="#__codelineno-16-229"></a>                <span class="p">(</span><span class="n">ltp</span><span class="p">,</span> <span class="n">traded</span><span class="p">,</span> <span class="n">sp_traded</span><span class="p">)</span> <span class="o">=</span> <span class="n">r</span>
<a id="__codelineno-16-230" name="__codelineno-16-230" href="#__codelineno-16-230"></a>                <span class="p">(</span><span class="n">wavg</span><span class="p">,</span> <span class="n">matched</span><span class="p">,</span> <span class="n">min_price</span><span class="p">,</span> <span class="n">max_price</span><span class="p">)</span> <span class="o">=</span> <span class="n">parse_traded</span><span class="p">(</span><span class="n">traded</span><span class="p">)</span>
<a id="__codelineno-16-231" name="__codelineno-16-231" href="#__codelineno-16-231"></a>
<a id="__codelineno-16-232" name="__codelineno-16-232" href="#__codelineno-16-232"></a>                <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-16-233" name="__codelineno-16-233" href="#__codelineno-16-233"></a>                    <span class="s1">&#39;preplay_ltp&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">ltp</span><span class="p">),</span>
<a id="__codelineno-16-234" name="__codelineno-16-234" href="#__codelineno-16-234"></a>                    <span class="s1">&#39;preplay_min&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">min_price</span><span class="p">),</span>
<a id="__codelineno-16-235" name="__codelineno-16-235" href="#__codelineno-16-235"></a>                    <span class="s1">&#39;preplay_max&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">max_price</span><span class="p">),</span>
<a id="__codelineno-16-236" name="__codelineno-16-236" href="#__codelineno-16-236"></a>                    <span class="s1">&#39;preplay_wavg&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">wavg</span><span class="p">),</span>
<a id="__codelineno-16-237" name="__codelineno-16-237" href="#__codelineno-16-237"></a>                    <span class="s1">&#39;preplay_matched&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">((</span><span class="n">matched</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">sp_traded</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)),</span>
<a id="__codelineno-16-238" name="__codelineno-16-238" href="#__codelineno-16-238"></a>                    <span class="s1">&#39;inplay_ltp&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
<a id="__codelineno-16-239" name="__codelineno-16-239" href="#__codelineno-16-239"></a>                    <span class="s1">&#39;inplay_min&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
<a id="__codelineno-16-240" name="__codelineno-16-240" href="#__codelineno-16-240"></a>                    <span class="s1">&#39;inplay_max&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
<a id="__codelineno-16-241" name="__codelineno-16-241" href="#__codelineno-16-241"></a>                    <span class="s1">&#39;inplay_wavg&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
<a id="__codelineno-16-242" name="__codelineno-16-242" href="#__codelineno-16-242"></a>                    <span class="s1">&#39;inplay_matched&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
<a id="__codelineno-16-243" name="__codelineno-16-243" href="#__codelineno-16-243"></a>                <span class="p">}</span>
<a id="__codelineno-16-244" name="__codelineno-16-244" href="#__codelineno-16-244"></a>
<a id="__codelineno-16-245" name="__codelineno-16-245" href="#__codelineno-16-245"></a>            <span class="n">runner_traded</span> <span class="o">=</span> <span class="p">[</span> <span class="n">runner_vals</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">postplay_traded</span> <span class="p">]</span>
<a id="__codelineno-16-246" name="__codelineno-16-246" href="#__codelineno-16-246"></a>
<a id="__codelineno-16-247" name="__codelineno-16-247" href="#__codelineno-16-247"></a>        <span class="c1"># printing to csv for each runner</span>
<a id="__codelineno-16-248" name="__codelineno-16-248" href="#__codelineno-16-248"></a>        <span class="k">for</span> <span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="n">rprices</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">runner_data</span><span class="p">,</span> <span class="n">runner_traded</span><span class="p">):</span>
<a id="__codelineno-16-249" name="__codelineno-16-249" href="#__codelineno-16-249"></a>            <span class="c1"># defining data to go in each column</span>
<a id="__codelineno-16-250" name="__codelineno-16-250" href="#__codelineno-16-250"></a>            <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
<a id="__codelineno-16-251" name="__codelineno-16-251" href="#__codelineno-16-251"></a>                <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
<a id="__codelineno-16-252" name="__codelineno-16-252" href="#__codelineno-16-252"></a>                    <span class="n">postplay_market</span><span class="o">.</span><span class="n">market_id</span><span class="p">,</span>
<a id="__codelineno-16-253" name="__codelineno-16-253" href="#__codelineno-16-253"></a>                    <span class="n">postplay_market</span><span class="o">.</span><span class="n">market_definition</span><span class="o">.</span><span class="n">market_time</span><span class="p">,</span>
<a id="__codelineno-16-254" name="__codelineno-16-254" href="#__codelineno-16-254"></a>                    <span class="n">postplay_market</span><span class="o">.</span><span class="n">market_definition</span><span class="o">.</span><span class="n">country_code</span><span class="p">,</span>
<a id="__codelineno-16-255" name="__codelineno-16-255" href="#__codelineno-16-255"></a>                    <span class="n">postplay_market</span><span class="o">.</span><span class="n">market_definition</span><span class="o">.</span><span class="n">venue</span><span class="p">,</span>
<a id="__codelineno-16-256" name="__codelineno-16-256" href="#__codelineno-16-256"></a>                    <span class="n">postplay_market</span><span class="o">.</span><span class="n">market_definition</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-16-257" name="__codelineno-16-257" href="#__codelineno-16-257"></a>                    <span class="n">rdata</span><span class="p">[</span><span class="s1">&#39;selection_id&#39;</span><span class="p">],</span>
<a id="__codelineno-16-258" name="__codelineno-16-258" href="#__codelineno-16-258"></a>                    <span class="n">rdata</span><span class="p">[</span><span class="s1">&#39;selection_name&#39;</span><span class="p">],</span>
<a id="__codelineno-16-259" name="__codelineno-16-259" href="#__codelineno-16-259"></a>                    <span class="n">rdata</span><span class="p">[</span><span class="s1">&#39;selection_status&#39;</span><span class="p">],</span>
<a id="__codelineno-16-260" name="__codelineno-16-260" href="#__codelineno-16-260"></a>                    <span class="n">rdata</span><span class="p">[</span><span class="s1">&#39;sp&#39;</span><span class="p">],</span>
<a id="__codelineno-16-261" name="__codelineno-16-261" href="#__codelineno-16-261"></a>                    <span class="n">rprices</span><span class="p">[</span><span class="s1">&#39;preplay_min&#39;</span><span class="p">],</span>
<a id="__codelineno-16-262" name="__codelineno-16-262" href="#__codelineno-16-262"></a>                    <span class="n">rprices</span><span class="p">[</span><span class="s1">&#39;preplay_max&#39;</span><span class="p">],</span>
<a id="__codelineno-16-263" name="__codelineno-16-263" href="#__codelineno-16-263"></a>                    <span class="n">rprices</span><span class="p">[</span><span class="s1">&#39;preplay_wavg&#39;</span><span class="p">],</span>
<a id="__codelineno-16-264" name="__codelineno-16-264" href="#__codelineno-16-264"></a>                    <span class="n">rprices</span><span class="p">[</span><span class="s1">&#39;preplay_ltp&#39;</span><span class="p">],</span>
<a id="__codelineno-16-265" name="__codelineno-16-265" href="#__codelineno-16-265"></a>                    <span class="n">rprices</span><span class="p">[</span><span class="s1">&#39;preplay_matched&#39;</span><span class="p">],</span>
<a id="__codelineno-16-266" name="__codelineno-16-266" href="#__codelineno-16-266"></a>                    <span class="n">rprices</span><span class="p">[</span><span class="s1">&#39;inplay_min&#39;</span><span class="p">],</span>
<a id="__codelineno-16-267" name="__codelineno-16-267" href="#__codelineno-16-267"></a>                    <span class="n">rprices</span><span class="p">[</span><span class="s1">&#39;inplay_max&#39;</span><span class="p">],</span>
<a id="__codelineno-16-268" name="__codelineno-16-268" href="#__codelineno-16-268"></a>                    <span class="n">rprices</span><span class="p">[</span><span class="s1">&#39;inplay_wavg&#39;</span><span class="p">],</span>
<a id="__codelineno-16-269" name="__codelineno-16-269" href="#__codelineno-16-269"></a>                    <span class="n">rprices</span><span class="p">[</span><span class="s1">&#39;inplay_ltp&#39;</span><span class="p">],</span>
<a id="__codelineno-16-270" name="__codelineno-16-270" href="#__codelineno-16-270"></a>                    <span class="n">rprices</span><span class="p">[</span><span class="s1">&#39;inplay_matched&#39;</span><span class="p">],</span>
<a id="__codelineno-16-271" name="__codelineno-16-271" href="#__codelineno-16-271"></a>                <span class="p">)</span>
<a id="__codelineno-16-272" name="__codelineno-16-272" href="#__codelineno-16-272"></a>            <span class="p">)</span>
</code></pre></div>
</div>
</div>
</div>
<hr />
<h2 id="disclaimer">Disclaimer</h2>
<p>Note that whilst models and automated strategies are fun and rewarding to create, we can't promise that your model or betting strategy will be profitable, and we make no representations in relation to the code shared or information on this page. If you're using this code or implementing your own strategies, you do so entirely at your own risk and you are responsible for any winnings/losses incurred. Under no circumstances will Betfair be liable for any loss or damage you suffer.</p>









  




                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
    
      <nav class="md-footer__inner md-grid" aria-label="footer.title">
        
          
          <a href="../processingTarFiles101/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Take away the pain! Processing TAR Files 101" rel="prev">
            <div class="md-footer__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <div class="md-ellipsis">
                <span class="md-footer__direction">
                  Previous
                </span>
                Take away the pain! Processing TAR Files 101
              </div>
            </div>
          </a>
        
        
          
          <a href="../backtestingRatingsTutorial/" class="md-footer__link md-footer__link--next" aria-label="Next: Back testing ratings in Python" rel="next">
            <div class="md-footer__title">
              <div class="md-ellipsis">
                <span class="md-footer__direction">
                  Next
                </span>
                Back testing ratings in Python
              </div>
            </div>
            <div class="md-footer__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
    <div class="md-footer-meta md-typeset">
      <div class="md-footer-meta__inner md-grid">
        <div class="md-copyright">
  
  
</div>
        
          <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://twitter.com/Betfair_Aus" target="_blank" rel="noopener" title="twitter.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://linkedin.com/company/betfair-australia" target="_blank" rel="noopener" title="linkedin.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3M135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5m282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://facebook.com/betfairaustralia" target="_blank" rel="noopener" title="facebook.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M512 256C512 114.6 397.4 0 256 0S0 114.6 0 256c0 120 82.7 220.8 194.2 248.5V334.2h-52.8V256h52.8v-33.7c0-87.1 39.4-127.5 125-127.5 16.2 0 44.2 3.2 55.7 6.4V172c-6-.6-16.5-1-29.6-1-42 0-58.2 15.9-58.2 57.2V256h83.6l-14.4 78.2H287v175.9C413.8 494.8 512 386.9 512 256"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://youtube.com/user/betfairaus" target="_blank" rel="noopener" title="youtube.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M549.655 124.083c-6.281-23.65-24.787-42.276-48.284-48.597C458.781 64 288 64 288 64S117.22 64 74.629 75.486c-23.497 6.322-42.003 24.947-48.284 48.597-11.412 42.867-11.412 132.305-11.412 132.305s0 89.438 11.412 132.305c6.281 23.65 24.787 41.5 48.284 47.821C117.22 448 288 448 288 448s170.78 0 213.371-11.486c23.497-6.321 42.003-24.171 48.284-47.821 11.412-42.867 11.412-132.305 11.412-132.305s0-89.438-11.412-132.305m-317.51 213.508V175.185l142.739 81.205z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://github.com/betfair-datascientists" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
</div>
        
      </div>

      <div class="bf-footer">
          <div class="bf-footer-inner">
              <p class="bf-light">Betfair Pty Limited is licensed and regulated by the Northern Territory Government of Australia.</p>
              <p class="bf-dark">Betfair Pty Limited's gambling operations are governed by its <a class='inner-link' href="https://www.betfair.com.au/info/responsible-gambling/">Responsible Gambling Code of Conduct</a> and for South
              Australian residents by the <a class='inner-link' href="https://www.betfair.com.au/info/pdf/SA-GCoP.pdf">South Australian Responsible Gambling Code of Practice.</a></p>
              <p class="bf-dark">BetStop is the Australian National Self-Exclusion Register. For more information, please visit <a class="inner-link" href="https://betstop.gov.au">https://betstop.gov.au</a><br /> <div class="full-screen"> <p style="font-family: Arial, sans-serif; font-size: 1.2rem; font-weight: bold;text-align: center;">Imagine what you could be buying instead</p> <p style="font-family: Arial, sans-serif; font-size: 0.8rem; font-weight: bold;text-align: center;">For free and confidential support call 1800 858 858 or visit <a href="http://www.gamblinghelponline.org.au" style="color: black; text-decoration: underline;">www.gamblinghelponline.org.au</a></p> </div> </p>
              <ul class="bf-links">
                <li><a href="https://www.betfair.com.au/hub/help/account-help/responsible-gambling/">Responsible Gambling</a><span>|</span></li>
                <li><a href="http://www.betfair.com/AUS_NZL/aboutUs/Terms.and.Conditions/">Terms & Conditions</a><span>|</span></li>
                <li><a href="https://www.betfair.com.au/info/privacy-policy/">Privacy Policy</a><span>|</span></li>
                <li><a href="http://www.betfair.com/en/aboutUs/Rules.and.Regulations/">Rules & Regulations</a><span>|</span></li>
                <li><a href="https://www.betfair.com/AUS_NZL/aboutUs/Dispute.Resolution">Dispute Resolution</a></li>
              </ul>
          </div>
      </div>
    </div>

    <script src="https://js.adsrvr.org/up_loader.1.1.0.js" type="text/javascript"></script>
    <script type="text/javascript">
        ttd_dom_ready( function() {
            if (typeof TTDUniversalPixelApi === 'function') {
                var universalPixelApi = new TTDUniversalPixelApi();
                universalPixelApi.init("y12d1ir", ["8ml4f17"], "https://insight.adsrvr.org/track/up");
            }
        });
    </script>

</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["toc.integrate", "navigation.instant", "navigation.tabs", "navigation.top", "navigation.expand", "navigation.sections", "search.suggest", "search.highlight", "search.share"], "search": "../../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.83f73b43.min.js"></script>
      
        <script src="../../js/scripts.js"></script>
      
    
  </body>
</html>