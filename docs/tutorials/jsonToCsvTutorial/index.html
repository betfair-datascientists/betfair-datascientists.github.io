
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Documentation, guides and articles on creating, developing and implementing automated betting strategies, using data analysis to inform betting models and how to interact with the Betfair API.">
      
      
        <meta name="author" content="Betfair Data Scientists">
      
      
        <link rel="canonical" href="https://betfair-datascientists.github.io/tutorials/jsonToCsvTutorial/">
      
      <link rel="icon" href="../../img/BetfairFavicon.ico">
      <meta name="generator" content="mkdocs-1.4.1, mkdocs-material-8.5.7">
    
    
      
        <title>JSON to CSV tutorial: making a market summary - The Automation Hub</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.20d9efc8.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.cbb835fc.min.css">
        
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/betfair.css">
    
      <link rel="stylesheet" href="../../css/buttons_and_animations.css">
    
      <link rel="stylesheet" href="../../css/fonts.css">
    
      <link rel="stylesheet" href="../../css/ansi-colours.css">
    
      <link rel="stylesheet" href="../../css/jupyter-cells.css">
    
      <link rel="stylesheet" href="../../css/pandas-dataframe.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  


  <script id="__analytics">function __md_analytics(){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-125973915-1","auto"),ga("set","anonymizeIp",!0),ga("send","pageview"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){var e;this.value&&(e=document.location.pathname,ga("send","pageview",e+"?q="+this.value))}),document$.subscribe(function(){var a=document.forms.feedback;if(void 0!==a)for(var e of a.querySelectorAll("[type=submit]"))e.addEventListener("click",function(e){e.preventDefault();var t=document.location.pathname,e=this.getAttribute("data-md-value");ga("send","event","feedback","click",t,e),a.firstElementChild.disabled=!0;e=a.querySelector(".md-feedback__note [data-md-value='"+e+"']");e&&(e.hidden=!1)}),a.hidden=!1}),location$.subscribe(function(e){ga("send","pageview",e.pathname)})});var e=document.createElement("script");e.async=!0,e.src="https://www.google-analytics.com/analytics.js",document.getElementById("__analytics").insertAdjacentElement("afterEnd",e)}</script>

  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="betfair" data-md-color-primary="amber" data-md-color-accent="orange">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#json-to-csv-tutorial-making-a-market-summary" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      
  
  <header class="md-header" data-md-component="header">
    <nav class="md-header__inner md-grid" aria-label="Header">
      <a href="../.." title="The Automation Hub" class="md-header__button md-logo" aria-label="The Automation Hub" data-md-component="logo">
        
  <img src="../../img/logo.svg" alt="logo">

      </a>
      <label class="md-header__button md-icon" for="__drawer">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
      </label>
      <div class="md-header__title" data-md-component="header-title">
        <div class="md-header__ellipsis">
          <div class="md-header__topic">
            <span class="md-ellipsis">
              The Automation Hub
            </span>
          </div>
          <div class="md-header__topic" data-md-component="header-topic">
            <span class="md-ellipsis">
              
                JSON to CSV tutorial: making a market summary
              
            </span>
          </div>
        </div>
      </div>

      
        <form class="md-header__option" data-md-component="palette">
          
            
            
            <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="betfair" data-md-color-primary="amber" data-md-color-accent="orange"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
            
              <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3 3.19.09m3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95 2.06.05m-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31Z"/></svg>
              </label>
            
          
            
            
            <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="amber" data-md-color-accent="orange"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
            
              <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5c-.84 0-1.65.15-2.39.42L12 2M3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29L3.34 7m.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14L3.36 17M20.65 7l-1.77 3.79a7.023 7.023 0 0 0-2.38-4.15l4.15.36m-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29L20.64 17M12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44L12 22Z"/></svg>
              </label>
            
          
        </form>
      
      

      
        <label class="md-header__button md-icon" for="__search">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
     
      <div class="bf-nav">
        <a class="bf-hidable" href="https://www.betfair.com.au/exchange/plus/"><svg class="exchangeLogo" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:cc="http://creativecommons.org/ns#"
          xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 38.775 4.59" width="24" height="17">
          <path class="st1" d="m 160.3,-136.95 v 26" />
          <g transform="translate(18.8,-137.15)">
            <path d="m 2.2901089,126.53441 v 5.20093 H -3.3107216 L 7.4888397,144.33446 18.2884,131.73534 h -5.598633 v -5.20093 z m -8.6000974,8.10132 -10.8017585,12.59913 h 5.60083 v 5.2998 h 10.3996581 v -5.2998 h 5.6008306 z" />
          </g>
        </svg><span> Exchange</span></a>
        <a href="https://www.betfair.com.au/hub/">Hub</a>
      </div>

      

    </nav>
    
  </header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href="../.." class="md-tabs__link">
      Home
    </a>
  </li>

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../wagering/betfairHowTo/" class="md-tabs__link">
        Wagering
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../api/apiResources/" class="md-tabs__link">
        API
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../modelling/Brownlow2023Datathon/" class="md-tabs__link">
        Modelling
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../automation/GoldenRulesofAutomation/" class="md-tabs__link">
        Automation
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../How_to_Automate_1/" class="md-tabs__link">
        Tutorials
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../mentalGame/intro/" class="md-tabs__link">
        Mental Game
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../contactUs/test/" class="md-tabs__link">
        Contact Us
      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="The Automation Hub" class="md-nav__button md-logo" aria-label="The Automation Hub" data-md-component="logo">
      
  <img src="../../img/logo.svg" alt="logo">

    </a>
    The Automation Hub
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          Wagering
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Wagering" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Wagering
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../wagering/betfairHowTo/" class="md-nav__link">
        Betfair How-To
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../wagering/bettingGlossary/" class="md-nav__link">
        Betting Glossary
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../wagering/stakingMethods/" class="md-nav__link">
        Staking Methods and Bankroll Management
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../wagering/valueAndOdds/" class="md-nav__link">
        Value and Odds
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../wagering/commission/" class="md-nav__link">
        Commission and other charges
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          API
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="API" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          API
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../api/apiResources/" class="md-nav__link">
        API resources
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../api/apiappkey/" class="md-nav__link">
        How to access the Betfair API
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../api/apiRtutorial/" class="md-nav__link">
        API tutorial in R
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../api/apiPythontutorial/" class="md-nav__link">
        API tutorial in Python
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          Modelling
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Modelling" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Modelling
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/Brownlow2023Datathon/" class="md-nav__link">
        Brownlow 2023 Datathon
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/AFL2023Datathon/" class="md-nav__link">
        AFL 2023 Datathon (concluded)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/howToModel/" class="md-nav__link">
        Intro to modelling
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/dataSources/" class="md-nav__link">
        Pricing Data Sources
      </a>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_4_5" type="checkbox" id="__nav_4_5" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_4_5">
          Racing
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Racing" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_5">
          <span class="md-nav__icon md-icon"></span>
          Racing
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/fasttrackTutorial/" class="md-nav__link">
        Greyhound form FastTrack API
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/greyhoundModellingPython/" class="md-nav__link">
        Greyhound modelling in Python
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_4_6" type="checkbox" id="__nav_4_6" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_4_6">
          Soccer
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Soccer" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_6">
          <span class="md-nav__icon md-icon"></span>
          Soccer
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/soccerModellingELO2022WorldCup/" class="md-nav__link">
        Soccer modelling tutorial in R for 2022 FIFA World Cup
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/soccerModellingTutorialPython/" class="md-nav__link">
        Soccer modelling tutorial in Python
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/EPLmlPython/" class="md-nav__link">
        EPL ML walk through in Python
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_4_7" type="checkbox" id="__nav_4_7" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_4_7">
          AFL
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="AFL" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_7">
          <span class="md-nav__icon md-icon"></span>
          AFL
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/AFLmodellingPython/" class="md-nav__link">
        AFL modelling walk through in Python
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/brownlowModelTutorial/" class="md-nav__link">
        Modelling the Brownlow Medal in Python
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_4_8" type="checkbox" id="__nav_4_8" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_4_8">
          Tennis
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Tennis" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_8">
          <span class="md-nav__icon md-icon"></span>
          Tennis
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/howToModelTheAusOpen/" class="md-nav__link">
        How to model the Australian Open
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/AusOpenRTutorial/" class="md-nav__link">
        Aus Open R Tutorial
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/AusOpenPythonTutorial/" class="md-nav__link">
        Aus Open Python Tutorial
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_5">
          Automation
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Automation" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Automation
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/GoldenRulesofAutomation/" class="md-nav__link">
        Golden rules of automation
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/overview/" class="md-nav__link">
        Tools Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_5_3" type="checkbox" id="__nav_5_3" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_5_3">
          Bet Angel
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Bet Angel" data-md-level="2">
        <label class="md-nav__title" for="__nav_5_3">
          <span class="md-nav__icon md-icon"></span>
          Bet Angel
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/betAngel/betAngel/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/betAngelbeginners/" class="md-nav__link">
        Beginner's guide
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/betAngelintermediate/" class="md-nav__link">
        Intermediate guide
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/betAngeladvanced/" class="md-nav__link">
        Advanced guide
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/betAngelRatingsAutomation/" class="md-nav__link">
        Ratings auto
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/betAngelMarketFavouriteAutomation/" class="md-nav__link">
        Market fav auto
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/betAngelTippingAutomation/" class="md-nav__link">
        Tipping auto
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/betAngelSimultaneousMarkets/" class="md-nav__link">
        Simultaneous markets
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/betAngelKellyStake/" class="md-nav__link">
        Kelly criterion staking
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_5_4" type="checkbox" id="__nav_5_4" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_5_4">
          Gruss Betting Assistant
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Gruss Betting Assistant" data-md-level="2">
        <label class="md-nav__title" for="__nav_5_4">
          <span class="md-nav__icon md-icon"></span>
          Gruss Betting Assistant
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/Gruss/Gruss/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/GrussSettingupbasicmarketview/" class="md-nav__link">
        Setup basic market view and one click betting
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/grussRatingsAutomation/" class="md-nav__link">
        Ratings auto
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/grussMarketFavouriteAutomation/" class="md-nav__link">
        Market fav auto
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/grusslSimultaneousMarkets/" class="md-nav__link">
        Simultaneous markets
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/grussKellyStake/" class="md-nav__link">
        Kelly criterion staking
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_5_5" type="checkbox" id="__nav_5_5" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_5_5">
          Cymatic Trader
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Cymatic Trader" data-md-level="2">
        <label class="md-nav__title" for="__nav_5_5">
          <span class="md-nav__icon md-icon"></span>
          Cymatic Trader
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/CymaticTrader/CymaticTrader/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/cymaticTraderRatingsAutomation/" class="md-nav__link">
        Ratings auto
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_5_6" type="checkbox" id="__nav_5_6" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_5_6">
          Geeks Toy
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Geeks Toy" data-md-level="2">
        <label class="md-nav__title" for="__nav_5_6">
          <span class="md-nav__icon md-icon"></span>
          Geeks Toy
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/GeeksToyinstallationandsetup/" class="md-nav__link">
        Installation and setup
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/GeeksToybasicmarketviewstakingandoneclickbetting/" class="md-nav__link">
        Setup basic market view and one click betting
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/geeksToyRefreshSettings/" class="md-nav__link">
        Optimising refresh settings
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_5_7" type="checkbox" id="__nav_5_7" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_5_7">
          Bet Jet Pro
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Bet Jet Pro" data-md-level="2">
        <label class="md-nav__title" for="__nav_5_7">
          <span class="md-nav__icon md-icon"></span>
          Bet Jet Pro
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/betJetOverview/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_6">
          Tutorials
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Tutorials" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          Tutorials
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../How_to_Automate_1/" class="md-nav__link">
        How to Automate 1
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../How_to_Automate_2/" class="md-nav__link">
        How to Automate 2
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../How_to_Automate_3/" class="md-nav__link">
        How to Automate 3
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../How_to_Automate_4/" class="md-nav__link">
        How to Automate 4
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../How_to_Automate_5/" class="md-nav__link">
        How to Automate 5
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../processingTarFiles101/" class="md-nav__link">
        Take away the pain! Processing TAR Files 101
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../jsonToCsvRevisited/" class="md-nav__link">
        JSON to CSV | Revisited
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../backtestingRatingsTutorial/" class="md-nav__link">
        Back testing ratings in Python
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../automatedBettingAnglesTutorial/" class="md-nav__link">
        Automated betting angles in Python
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../analysingAndPredictingMarketMovements/" class="md-nav__link">
        Do they know? Analysing Betfair market formation & market movements
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../analysingAndPredictingBSP/" class="md-nav__link">
        Wisdom of the crowd? Analysing & understanding BSP
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_7" type="checkbox" id="__nav_7" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_7">
          Mental Game
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Mental Game" data-md-level="1">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          Mental Game
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/intro/" class="md-nav__link">
        Intro
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/roleOfEmotions/" class="md-nav__link">
        Part 1
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/mapYourEmotions/" class="md-nav__link">
        Part 2
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/handlingBadVariance/" class="md-nav__link">
        Part 3
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/winbyBeingGreatatLosing/" class="md-nav__link">
        Part 4
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/correctingyouremotions/" class="md-nav__link">
        Part 5
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/responsibleGambling/" class="md-nav__link">
        Part 6
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/InchwormConcept/" class="md-nav__link">
        Part 7
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/HighExpectations/" class="md-nav__link">
        Part 8
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/TappingYourIntuition/" class="md-nav__link">
        Part 9
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_8" type="checkbox" id="__nav_8" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_8">
          Contact Us
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Contact Us" data-md-level="1">
        <label class="md-nav__title" for="__nav_8">
          <span class="md-nav__icon md-icon"></span>
          Contact Us
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../contactUs/test/" class="md-nav__link">
        Meet the Team
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="json-to-csv-tutorial-making-a-market-summary">JSON to CSV tutorial: making a market summary</h1>
<hr />
<div class="admonition note">
<p class="admonition-title">Before you start</p>
<p>This tutorial was original shared in 2021. Since then a new library has been created that allows you to run the same logic included here with about a 97% reduction in run time, which makes a significant difference in usability. To learn about these changes and how to implement them to speed up your code take a look at our <a href="../jsonToCsvRevisited">JSON to CSV revisited article</a>.</p>
</div>
<p>The historic pricing data available on the <a href="https://historicdata.betfair.com/#/home">Betfair Historic Data site</a> is an excellent resource, including almost every market offered on the Exchange back to 2016. We do appreciate though that the JSON format of the data sets can make it challenging to find value in the data, especially if you're not confident in working with large data sets. </p>
<p>In this tutorial we're going to step through the process of using the Python <code>betfairlightweight</code> library to take in a compressed tar folder, process the historic JSON files, and convert the data into a simple csv output, including basic market summary data for each runner split into pre play and in play values. We're also going to include a filter function, to allow us to filter out markets we're not interested in. </p>
<p>The idea of this tutorial is to share a way of using existing libraries to make working with the JSON data sets easier, and hopefully the provide a foundation that you can build your own code base and data sets from. We'll be focusing on horse racing data; what we want to produce is a csv output that includes one row per runner for each market we're interested in, along with summary pre-play and in-play data for the runner. We'll step through the issues we encountered and how we went about solving the various challenges, including sharing relevant code snips along the way. </p>
<p>We're not Python natives and acknowledge that there are probably more efficient and neater ways of achieving the same end goal! As always please <a href="mailto:data@betfair.com.au">reach out</a> with feedback, suggestions or queries, or feel free to submit a <a href="https://github.com/betfair-down-under/autoHubTutorials/blob/master/jsonToCsv/main.py">pull request</a> if you catch some bugs or have other improvements! </p>
<div class="admonition note">
<p class="admonition-title">Cheat sheet</p>
<ul>
<li>
<p>If you're looking for the complete code <a href="https://betfair-datascientists.github.io/tutorials/jsonToCsvTutorial/#sample-code">head to the bottom of the page</a> or <a href="https://github.com/betfair-down-under/autoHubTutorials/blob/master/jsonToCsv/main.py">download the script from Github</a>.</p>
</li>
<li>
<p>To run the code, save it to your machine, open a command prompt, or a terminal in your text editor of choice (we're using <a href="https://code.visualstudio.com/download">VS code</a>), make sure you've navigated in the terminal to the folder you've saved the script in and then type <code>py main.py</code> (or whatever you've called your script file if not main) then hit enter. To stop the code running use Ctrl C. </p>
</li>
<li>
<p>The script will take some time before it starts outputting to the output.csv file, so let it run for a few minutes before getting worried that it's not working!</p>
</li>
<li>
<p>Make sure you amend your data path to point to your data file (instructions below). We'll be taking in an input of a historical tar file downloaded from the <a href="https://historicdata.betfair.com/#/help">Betfair historic data site</a>. We're using a PRO version, though the code should work on ADVANCED too. This approach won't work with the BASIC data tier. </p>
</li>
<li>
<p>We're using the <a href="https://github.com/liampauling/betfair/tree/master/betfairlightweight"><code>betfairlightweight</code></a> package to do the heavy lifting</p>
</li>
<li>
<p>We've also posted the completed code logic on the <a href="https://github.com/betfair-down-under/autoHubTutorials/blob/master/jsonToCsv/main.py"><code>betfair-downunder</code> Github repo</a>.</p>
</li>
</ul>
</div>
<hr />
<h3 id="setting-up-your-environment">Setting up your environment</h3>
<p>You're going to need to make sure you have <a href="https://www.python.org/downloads/">Python</a> and <a href="https://pypi.org/project/pip/">pip</a> installed to get this code to run. If you're just starting out with Python, you may have to add Python to <a href="https://www.educative.io/edpresso/how-to-add-python-to-path-variable-in-windows">your environment variables</a>. The is generally easiest to do by checking the box when you're installing Python choosing to 'add to PATH'. </p>
<p>The alternative approach to the above is to use a <a href="https://jupyter.org/">Jupyter notebook</a> which has the environment already set up - this might be the easier option for people new to programming. </p>
<p>We're using some pretty new Python features, so it might be worth <a href="https://phoenixnap.com/kb/check-python-version">checking your version</a> and updating if you're keen to follow along. </p>
<p>To install <code>betfairlightweight</code> open a command prompt, or a terminal in your text editor of choice and input <code>pip install betfairlightweight</code> then return. </p>
<hr />
<h3 id="data-input">Data input</h3>
<p>We started with the <a href="https://github.com/liampauling/betfair/blob/master/examples/examplestreaminghistorical.py">historic data parsing example</a> from <a href="https://github.com/liampauling">liampauling</a>'s Github repo. </p>
<p>Our first issue was that the example provided was expecting to take in an individual market file. We wanted to be able to accept data in a tar archive, a zipped folder, or a directory of individual bz2 files.</p>
<p>Here's the code we used for handling the different file formats. </p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="c1"># loading from tar and extracting files</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="k">def</span> <span class="nf">load_markets</span><span class="p">(</span><span class="n">file_paths</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="k">for</span> <span class="n">file_path</span> <span class="ow">in</span> <span class="n">file_paths</span><span class="p">:</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>            <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">iglob</span><span class="p">(</span><span class="n">file_path</span> <span class="o">+</span> <span class="s1">&#39;**/**/*.bz2&#39;</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>                <span class="n">f</span> <span class="o">=</span> <span class="n">bz2</span><span class="o">.</span><span class="n">BZ2File</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>                <span class="k">yield</span> <span class="n">f</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>                <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>            <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file_path</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>            <span class="c1"># iterate through a tar archive</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>            <span class="k">if</span> <span class="n">ext</span> <span class="o">==</span> <span class="s1">&#39;.tar&#39;</span><span class="p">:</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>                <span class="k">with</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">TarFile</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">archive</span><span class="p">:</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>                    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">archive</span><span class="p">:</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>                        <span class="k">yield</span> <span class="n">bz2</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">archive</span><span class="o">.</span><span class="n">extractfile</span><span class="p">(</span><span class="n">file</span><span class="p">))</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>            <span class="c1"># or a zip archive</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>            <span class="k">elif</span> <span class="n">ext</span> <span class="o">==</span> <span class="s1">&#39;.zip&#39;</span><span class="p">:</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>                <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">archive</span><span class="p">:</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>                    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">archive</span><span class="o">.</span><span class="n">namelist</span><span class="p">():</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>                        <span class="k">yield</span> <span class="n">bz2</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">archive</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file</span><span class="p">))</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div>
<p>and then used it like this:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="c1"># the path directories to the data sets</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="c1"># accepts tar files, zipped files or </span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="c1"># directory with bz2 file(s)</span>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="n">market_paths</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>    <span class="s1">&#39;./2020_12_DecRacingPro.zip&#39;</span><span class="p">,</span>
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a>    <span class="s1">&#39;./PRO&#39;</span><span class="p">,</span>
<a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a>    <span class="s1">&#39;./2021_01_JanRacingPro.tar&#39;</span>
<a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a><span class="p">]</span>
<a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a>
<a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a><span class="o">...</span> 
<a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a>
<a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a><span class="k">for</span> <span class="n">file_obj</span> <span class="ow">in</span> <span class="n">load_markets</span><span class="p">(</span><span class="n">market_paths</span><span class="p">):</span>
<a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a>    <span class="n">stream</span> <span class="o">=</span> <span class="n">trading</span><span class="o">.</span><span class="n">streaming</span><span class="o">.</span><span class="n">create_historical_generator_stream</span><span class="p">(</span>
<a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a>        <span class="n">file_path</span><span class="o">=</span><span class="n">file_obj</span><span class="p">,</span>
<a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a>        <span class="n">listener</span><span class="o">=</span><span class="n">listener</span><span class="p">,</span>
<a id="__codelineno-1-16" name="__codelineno-1-16" href="#__codelineno-1-16"></a>    <span class="p">)</span>
<a id="__codelineno-1-17" name="__codelineno-1-17" href="#__codelineno-1-17"></a>
<a id="__codelineno-1-18" name="__codelineno-1-18" href="#__codelineno-1-18"></a>    <span class="k">def</span> <span class="nf">get_pre_post_final</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
<a id="__codelineno-1-19" name="__codelineno-1-19" href="#__codelineno-1-19"></a>        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s2">&quot;builtins.open&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">f</span><span class="p">,</span> <span class="n">_</span><span class="p">:</span> <span class="n">f</span><span class="p">):</span>  
</code></pre></div>
<p>This means we can pass in the tar and/or zipped file in its compressed form and/or directory with individual bz2 files in it and not worry about extracting the file contents, or having to handle the logic of iterating over the inner nested file structure. </p>
<div class="admonition note">
<p class="admonition-title">File paths</p>
<p>The program will look at the file path you pass in relative to the location of the script you're running. So it will start by looking in the same folder it's saved in and then follow your navigation instructions from there, using <code>/</code> to indicate a folder and <code>../</code> to navigate up a level in the folder structure. </p>
<p>If our example the data files sit in the same folder as the script (<code>./PRO</code>).</p>
<p>If it were in a folder at the same level as the folder that our script is in then we'd need to navigate 'up' a level (using <code>../</code>) and then into the folder housing the data, i.e. <code>'../dataFolder/PRO'</code> and if the data were in a different folder within the same folder as our script file we'd use <code>'./dataFolder/PRO'</code> etc.</p>
</div>
<hr />
<h3 id="type-definitions">Type definitions</h3>
<p>If you're used to working in strongly typed languages, especially those with type definitions, you might find it a bit frustrating to try and figure out where you can access the different data types, for example market name or runner BSP. There are some things you can do to make this a bit easier, other than digging into the <code>betfairlightweight</code> source code, which was where we started. </p>
<p>If you want to look at the definitions from the source code:</p>
<ul>
<li><a href="https://github.com/liampauling/betfair/blob/f370d111d2e7adf1ca4221fc8cc4b028e4b2b2f8/betfairlightweight/resources/bettingresources.py#L466"><code>MarketBook, RunnerBook</code></a></li>
<li><a href="https://github.com/liampauling/betfair/blob/f370d111d2e7adf1ca4221fc8cc4b028e4b2b2f8/betfairlightweight/resources/streamingresources.py#L32"><code>MarketDefinitionRunner, MarketDefinition</code></a></li>
</ul>
<p>There are some Python extensions you can use in your ide that go some way to helping here. </p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="c1"># importing data types</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="kn">import</span> <span class="nn">betfairlightweight</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="kn">from</span> <span class="nn">betfairlightweight.resources.bettingresources</span> <span class="kn">import</span> <span class="p">(</span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>    <span class="n">PriceSize</span><span class="p">,</span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a>    <span class="n">MarketBook</span>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="p">)</span>
</code></pre></div>
<hr />
<h3 id="market-summary-data">Market summary data</h3>
<p>The raw files show the data at 50ms (PRO) or 1 second (ADVANCED) intervals. Too produce our csv we will need to look at the state of the market before the market goes in play, and then the state at the end of the market, and calculate from that what the pre play and in play figures are. </p>
<p>This is the data we're going to include in our output csv.</p>
<table>
<thead>
<tr>
<th align="left"><strong>Column</strong></th>
<th align="left"><strong>Definition</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">market_id</td>
<td align="left">unique market identifier</td>
</tr>
<tr>
<td align="left">event_date</td>
<td align="left">scheduled start date/time (UTC)</td>
</tr>
<tr>
<td align="left">country</td>
<td align="left">event country code</td>
</tr>
<tr>
<td align="left">track</td>
<td align="left">track name</td>
</tr>
<tr>
<td align="left">market_name</td>
<td align="left">market name</td>
</tr>
<tr>
<td align="left">selection_id</td>
<td align="left">unique runner identifier</td>
</tr>
<tr>
<td align="left">selection_name</td>
<td align="left">runner name</td>
</tr>
<tr>
<td align="left">result</td>
<td align="left">win/loss/removed</td>
</tr>
<tr>
<td align="left">bsp</td>
<td align="left">Betfair starting price</td>
</tr>
<tr>
<td align="left">pp_min</td>
<td align="left">pre play min price traded</td>
</tr>
<tr>
<td align="left">pp_max</td>
<td align="left">pre play max price traded</td>
</tr>
<tr>
<td align="left">pp_wap</td>
<td align="left">pre play weighted average price</td>
</tr>
<tr>
<td align="left">pp_ltp</td>
<td align="left">pre play last traded price</td>
</tr>
<tr>
<td align="left">pp_volume</td>
<td align="left">pre play matched volume</td>
</tr>
<tr>
<td align="left">ip_min</td>
<td align="left">in play min price traded</td>
</tr>
<tr>
<td align="left">ip_max</td>
<td align="left">in play max price traded</td>
</tr>
<tr>
<td align="left">ip_wap</td>
<td align="left">in play weighted average price</td>
</tr>
<tr>
<td align="left">ip_ltp</td>
<td align="left">in play last traded price</td>
</tr>
<tr>
<td align="left">ip_volume</td>
<td align="left">in play matched volume</td>
</tr>
</tbody>
</table>
<p><code>betfairlightweight</code> exposes snapshots of the market that include all the price data we need. To allow us to compute pre play and in play figures there are three market snapshots we need to find. These are the final view before the market turns in play, the market at the end of the race once it's no longer open but the price ladder hasn't yet been cleared, and the final closed snapshot that shows winner/loser status etc. We can then use the deltas between these market views to calculate the pre play and in play summary statistics. </p>
<p>We iterate over these market snapshots and when we find the first market showing as in play we go back to the previous update, and use this as our pre play view. After this we keep iterating until we find the last time that the market status shows as 'open' and then use the data from the following update for the final pricing data (i.e. the first market view once the market was suspended at the end of the race). The winner/loser statuses come from the final market view. </p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="k">def</span> <span class="nf">get_pre_post_final</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s2">&quot;builtins.open&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">f</span><span class="p">,</span> <span class="n">_</span><span class="p">:</span> <span class="n">f</span><span class="p">):</span>   
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>        <span class="n">eval_market</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a>        <span class="n">prev_market</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a>        <span class="n">preplay_market</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a>        <span class="n">postplay_market</span> <span class="o">=</span> <span class="kc">None</span>       
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a>
<a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a>        <span class="n">gen</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">get_generator</span><span class="p">()</span>
<a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a>
<a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a>        <span class="k">for</span> <span class="n">market_books</span> <span class="ow">in</span> <span class="n">gen</span><span class="p">():</span>
<a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a>            <span class="k">for</span> <span class="n">market_book</span> <span class="ow">in</span> <span class="n">market_books</span><span class="p">:</span>
<a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a>
<a id="__codelineno-3-13" name="__codelineno-3-13" href="#__codelineno-3-13"></a>                <span class="c1"># if market doesn&#39;t meet filter return out</span>
<a id="__codelineno-3-14" name="__codelineno-3-14" href="#__codelineno-3-14"></a>                <span class="k">if</span> <span class="n">eval_market</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">((</span><span class="n">eval_market</span> <span class="o">:=</span> <span class="n">filter_market</span><span class="p">(</span><span class="n">market_book</span><span class="p">))</span> <span class="o">==</span> <span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-3-15" name="__codelineno-3-15" href="#__codelineno-3-15"></a>                    <span class="k">return</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-3-16" name="__codelineno-3-16" href="#__codelineno-3-16"></a>
<a id="__codelineno-3-17" name="__codelineno-3-17" href="#__codelineno-3-17"></a>                <span class="c1"># final market view before market goes in play</span>
<a id="__codelineno-3-18" name="__codelineno-3-18" href="#__codelineno-3-18"></a>                <span class="k">if</span> <span class="n">prev_market</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">prev_market</span><span class="o">.</span><span class="n">inplay</span> <span class="o">!=</span> <span class="n">market_book</span><span class="o">.</span><span class="n">inplay</span><span class="p">:</span>
<a id="__codelineno-3-19" name="__codelineno-3-19" href="#__codelineno-3-19"></a>                    <span class="n">preplay_market</span> <span class="o">=</span> <span class="n">prev_market</span>
<a id="__codelineno-3-20" name="__codelineno-3-20" href="#__codelineno-3-20"></a>
<a id="__codelineno-3-21" name="__codelineno-3-21" href="#__codelineno-3-21"></a>                <span class="c1"># final market view at the conclusion of the market</span>
<a id="__codelineno-3-22" name="__codelineno-3-22" href="#__codelineno-3-22"></a>                <span class="k">if</span> <span class="n">prev_market</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">prev_market</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;OPEN&quot;</span> <span class="ow">and</span> <span class="n">market_book</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="n">prev_market</span><span class="o">.</span><span class="n">status</span><span class="p">:</span>
<a id="__codelineno-3-23" name="__codelineno-3-23" href="#__codelineno-3-23"></a>                    <span class="n">postplay_market</span> <span class="o">=</span> <span class="n">market_book</span>
<a id="__codelineno-3-24" name="__codelineno-3-24" href="#__codelineno-3-24"></a>
<a id="__codelineno-3-25" name="__codelineno-3-25" href="#__codelineno-3-25"></a>                <span class="c1"># update reference to previous market</span>
<a id="__codelineno-3-26" name="__codelineno-3-26" href="#__codelineno-3-26"></a>                <span class="n">prev_market</span> <span class="o">=</span> <span class="n">market_book</span>
<a id="__codelineno-3-27" name="__codelineno-3-27" href="#__codelineno-3-27"></a>
<a id="__codelineno-3-28" name="__codelineno-3-28" href="#__codelineno-3-28"></a>        <span class="k">return</span> <span class="p">(</span><span class="n">preplay_market</span><span class="p">,</span> <span class="n">postplay_market</span><span class="p">,</span> <span class="n">prev_market</span><span class="p">)</span> <span class="c1"># prev is now final</span>
<a id="__codelineno-3-29" name="__codelineno-3-29" href="#__codelineno-3-29"></a>
<a id="__codelineno-3-30" name="__codelineno-3-30" href="#__codelineno-3-30"></a><span class="p">(</span><span class="n">preplay_market</span><span class="p">,</span> <span class="n">postplay_market</span><span class="p">,</span> <span class="n">final_market</span><span class="p">)</span> <span class="o">=</span> <span class="n">get_pre_post_final</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
</code></pre></div>
<p>We needed to write a function to parse the price data (pre play and in play) and pull out the values we're interested in. We used a reduce function to go over each matched price point, and calculate the four necessary values. </p>
<p>To calculate weighted average price we multiplied price by size for each price point, and added them together. Once they're summed, we divided that figure by the total matched value. </p>
<p>The matched volume is simply the sum of all matched stakes. </p>
<p>The min price and max price are the lowest and highest values where money has matched on the runner.</p>
<div class="admonition note">
<p class="admonition-title">Reduce functions</p>
<p>I gather from some actual Python gurus in our community that while reduce functions are very common in other languages (i.e. the ones I normally work in!), apparently they're not very Pythonic... if you're super keen, feel free to rewrite this section into a list/dict comprehension or another more Pythonic solution!</p>
</div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="c1"># parsing price data and pulling out weighted avg price, matched, min price and max price</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="k">def</span> <span class="nf">parse_traded</span><span class="p">(</span><span class="n">traded</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">PriceSize</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">traded</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> 
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a>        <span class="k">return</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a>
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a>    <span class="p">(</span><span class="n">wavg_sum</span><span class="p">,</span> <span class="n">matched</span><span class="p">,</span> <span class="n">min_price</span><span class="p">,</span> <span class="n">max_price</span><span class="p">)</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span>
<a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a>        <span class="k">lambda</span> <span class="n">total</span><span class="p">,</span> <span class="n">ps</span><span class="p">:</span> <span class="p">(</span>
<a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a>            <span class="n">total</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">ps</span><span class="o">.</span><span class="n">price</span> <span class="o">*</span> <span class="n">ps</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="c1"># wavg_sum before we divide by total matched</span>
<a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a>            <span class="n">total</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">ps</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="c1"># total matched</span>
<a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a>            <span class="nb">min</span><span class="p">(</span><span class="n">total</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">ps</span><span class="o">.</span><span class="n">price</span><span class="p">),</span> <span class="c1"># min price matched</span>
<a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a>            <span class="nb">max</span><span class="p">(</span><span class="n">total</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">ps</span><span class="o">.</span><span class="n">price</span><span class="p">),</span> <span class="c1"># max price matched</span>
<a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a>        <span class="p">),</span>
<a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a>        <span class="n">traded</span><span class="p">,</span>
<a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a>        <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1001</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c1"># starting default values</span>
<a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a>    <span class="p">)</span>
<a id="__codelineno-4-16" name="__codelineno-4-16" href="#__codelineno-4-16"></a>
<a id="__codelineno-4-17" name="__codelineno-4-17" href="#__codelineno-4-17"></a>    <span class="n">wavg_sum</span> <span class="o">=</span> <span class="p">(</span><span class="n">wavg_sum</span> <span class="o">/</span> <span class="n">matched</span><span class="p">)</span> <span class="k">if</span> <span class="n">matched</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span> <span class="c1"># dividing sum of wavg by total matched</span>
<a id="__codelineno-4-18" name="__codelineno-4-18" href="#__codelineno-4-18"></a>    <span class="n">matched</span> <span class="o">=</span> <span class="n">matched</span> <span class="k">if</span> <span class="n">matched</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span> 
<a id="__codelineno-4-19" name="__codelineno-4-19" href="#__codelineno-4-19"></a>    <span class="n">min_price</span> <span class="o">=</span> <span class="n">min_price</span> <span class="k">if</span> <span class="n">min_price</span> <span class="o">!=</span> <span class="mi">1001</span> <span class="k">else</span> <span class="kc">None</span>
<a id="__codelineno-4-20" name="__codelineno-4-20" href="#__codelineno-4-20"></a>    <span class="n">max_price</span> <span class="o">=</span> <span class="n">max_price</span> <span class="k">if</span> <span class="n">max_price</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span>
<a id="__codelineno-4-21" name="__codelineno-4-21" href="#__codelineno-4-21"></a>
<a id="__codelineno-4-22" name="__codelineno-4-22" href="#__codelineno-4-22"></a>    <span class="k">return</span> <span class="p">(</span><span class="n">wavg_sum</span><span class="p">,</span> <span class="n">matched</span><span class="p">,</span> <span class="n">min_price</span><span class="p">,</span> <span class="n">max_price</span><span class="p">)</span>
</code></pre></div>
<p>Our volume figures don't include BSP bets yet, so to account for that we're looking at the <code>back_stake_taken</code> and <code>lay_liability_taken</code> values on the SP object from the post play market snapshot, then finding whichever the smaller of those two values is and saving it that so we can add it to the <code>traded_volume</code> field in a later step. We use the smaller value of <code>back_stake_taken</code> or (<code>lay_liability_taken</code>/(BSP - 1)) (i.e. backer's stake for SP lay bets) as any difference between the two values will have matched against non-BSP money and therefore is already accounted for in our matched volume. </p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="n">preplay_traded</span> <span class="o">=</span> <span class="p">[</span> <span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">last_price_traded</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">traded_volume</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">preplay_market</span><span class="o">.</span><span class="n">runners</span> <span class="p">]</span> <span class="k">if</span> <span class="n">preplay_market</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="n">postplay_traded</span> <span class="o">=</span> <span class="p">[</span> <span class="p">(</span>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>    <span class="n">r</span><span class="o">.</span><span class="n">last_price_traded</span><span class="p">,</span>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a>    <span class="n">r</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">traded_volume</span><span class="p">,</span>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a>    <span class="c1"># calculating SP traded vol as smaller of back_stake_taken or (lay_liability_taken / (BSP - 1))        </span>
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a>    <span class="n">min_gr0</span><span class="p">(</span>
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a>        <span class="nb">next</span><span class="p">((</span><span class="n">pv</span><span class="o">.</span><span class="n">size</span> <span class="k">for</span> <span class="n">pv</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">back_stake_taken</span> <span class="k">if</span> <span class="n">pv</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">0</span><span class="p">),</span>
<a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a>        <span class="nb">next</span><span class="p">((</span><span class="n">pv</span><span class="o">.</span><span class="n">size</span> <span class="k">for</span> <span class="n">pv</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">lay_liability_taken</span> <span class="k">if</span> <span class="n">pv</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>  <span class="o">/</span> <span class="p">((</span><span class="n">r</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">actual_sp</span> <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">actual_sp</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">actual_sp</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a>    <span class="p">)</span>
<a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">postplay_market</span><span class="o">.</span><span class="n">runners</span> <span class="p">]</span>
</code></pre></div>
<p>For our csv, we have columns for runner id, runner name, winning status and BSP, so we'll store these values too. The runner name is a bit harder to get, as we need to match up the runner definition with the same <code>selection_id</code> as the <code>market_book</code> object we're currently looking at.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="c1"># generic runner data</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>    <span class="n">runner_data</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a>        <span class="p">{</span>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a>            <span class="s1">&#39;selection_id&#39;</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">selection_id</span><span class="p">,</span>
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a>            <span class="s1">&#39;selection_name&#39;</span><span class="p">:</span> <span class="nb">next</span><span class="p">((</span><span class="n">rd</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">rd</span> <span class="ow">in</span> <span class="n">final_market</span><span class="o">.</span><span class="n">market_definition</span><span class="o">.</span><span class="n">runners</span> <span class="k">if</span> <span class="n">rd</span><span class="o">.</span><span class="n">selection_id</span> <span class="o">==</span> <span class="n">r</span><span class="o">.</span><span class="n">selection_id</span><span class="p">),</span> <span class="kc">None</span><span class="p">),</span>
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a>            <span class="s1">&#39;selection_status&#39;</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a>            <span class="s1">&#39;sp&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">actual_sp</span><span class="p">),</span>
<a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a>        <span class="p">}</span>
<a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a>        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">final_market</span><span class="o">.</span><span class="n">runners</span> 
<a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a>    <span class="p">]</span>
</code></pre></div>
<p>Not all markets go in play, and therefore won't have any values for the in play portion of the csv, so we need to make sure we can handle this case.</p>
<p>We don't have in play figures separate to pre play; we have a snapshot before the market went in play, and then the view at the end of the market, so we need to use the difference between these two sets of figures to figure out what happened in play.</p>
<p>We have two ladders, one post play and one pre play. We go through every price point in the post play ladder, and remove any volume that's showing in the pre play ladder at the corresponding price point. This leaves us with the volumes matched while the market was in play. </p>
<p>One corner case we had to catch is that our resulting list might have prices with 0 volume, which trip up our min and max values, which doesn't use volume in its calculations. To catch this we filter out any items from the ladder with a volume of 0.</p>
<p>Note: there are some markets included in the data files that are effective empty and don't contain any price data. We're disregarding these markets and printing out an error message to the log (<code>market has no price data</code>).</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="c1"># runner price data for markets that go in play</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="k">if</span> <span class="n">preplay_traded</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>    <span class="k">def</span> <span class="nf">runner_vals</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a>        <span class="p">(</span><span class="n">pre_ltp</span><span class="p">,</span> <span class="n">pre_traded</span><span class="p">),</span> <span class="p">(</span><span class="n">post_ltp</span><span class="p">,</span> <span class="n">post_traded</span><span class="p">,</span> <span class="n">sp_traded</span><span class="p">)</span> <span class="o">=</span> <span class="n">r</span>
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a>
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a>        <span class="n">inplay_only</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">ps</span><span class="p">:</span> <span class="n">ps</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="p">[</span>
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a>            <span class="n">PriceSize</span><span class="p">(</span>
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a>                <span class="n">price</span><span class="o">=</span><span class="n">post_ps</span><span class="o">.</span><span class="n">price</span><span class="p">,</span> 
<a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a>                <span class="n">size</span><span class="o">=</span><span class="n">post_ps</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="nb">next</span><span class="p">((</span><span class="n">pre_ps</span><span class="o">.</span><span class="n">size</span> <span class="k">for</span> <span class="n">pre_ps</span> <span class="ow">in</span> <span class="n">pre_traded</span> <span class="k">if</span> <span class="n">pre_ps</span><span class="o">.</span><span class="n">price</span> <span class="o">==</span> <span class="n">post_ps</span><span class="o">.</span><span class="n">price</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a>            <span class="p">)</span>
<a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a>            <span class="k">for</span> <span class="n">post_ps</span> <span class="ow">in</span> <span class="n">post_traded</span> 
<a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a>        <span class="p">]))</span>
<a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a>
<a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a>        <span class="p">(</span><span class="n">ip_wavg</span><span class="p">,</span> <span class="n">ip_matched</span><span class="p">,</span> <span class="n">ip_min</span><span class="p">,</span> <span class="n">ip_max</span><span class="p">)</span> <span class="o">=</span> <span class="n">parse_traded</span><span class="p">(</span><span class="n">inplay_only</span><span class="p">)</span>
<a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a>        <span class="p">(</span><span class="n">pre_wavg</span><span class="p">,</span> <span class="n">pre_matched</span><span class="p">,</span> <span class="n">pre_min</span><span class="p">,</span> <span class="n">pre_max</span><span class="p">)</span> <span class="o">=</span> <span class="n">parse_traded</span><span class="p">(</span><span class="n">pre_traded</span><span class="p">)</span>
<a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a>
<a id="__codelineno-7-17" name="__codelineno-7-17" href="#__codelineno-7-17"></a>        <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-7-18" name="__codelineno-7-18" href="#__codelineno-7-18"></a>            <span class="s1">&#39;preplay_ltp&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">pre_ltp</span><span class="p">),</span>
<a id="__codelineno-7-19" name="__codelineno-7-19" href="#__codelineno-7-19"></a>            <span class="s1">&#39;preplay_min&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">pre_min</span><span class="p">),</span>
<a id="__codelineno-7-20" name="__codelineno-7-20" href="#__codelineno-7-20"></a>            <span class="s1">&#39;preplay_max&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">pre_max</span><span class="p">),</span>
<a id="__codelineno-7-21" name="__codelineno-7-21" href="#__codelineno-7-21"></a>            <span class="s1">&#39;preplay_wavg&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">pre_wavg</span><span class="p">),</span>
<a id="__codelineno-7-22" name="__codelineno-7-22" href="#__codelineno-7-22"></a>            <span class="s1">&#39;preplay_matched&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">((</span><span class="n">pre_matched</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">sp_traded</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)),</span>
<a id="__codelineno-7-23" name="__codelineno-7-23" href="#__codelineno-7-23"></a>            <span class="s1">&#39;inplay_ltp&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">post_ltp</span><span class="p">),</span>
<a id="__codelineno-7-24" name="__codelineno-7-24" href="#__codelineno-7-24"></a>            <span class="s1">&#39;inplay_min&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">ip_min</span><span class="p">),</span>
<a id="__codelineno-7-25" name="__codelineno-7-25" href="#__codelineno-7-25"></a>            <span class="s1">&#39;inplay_max&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">ip_max</span><span class="p">),</span>
<a id="__codelineno-7-26" name="__codelineno-7-26" href="#__codelineno-7-26"></a>            <span class="s1">&#39;inplay_wavg&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">ip_wavg</span><span class="p">),</span>
<a id="__codelineno-7-27" name="__codelineno-7-27" href="#__codelineno-7-27"></a>            <span class="s1">&#39;inplay_matched&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">ip_matched</span><span class="p">),</span>
<a id="__codelineno-7-28" name="__codelineno-7-28" href="#__codelineno-7-28"></a>        <span class="p">}</span>
<a id="__codelineno-7-29" name="__codelineno-7-29" href="#__codelineno-7-29"></a>
<a id="__codelineno-7-30" name="__codelineno-7-30" href="#__codelineno-7-30"></a>    <span class="n">runner_traded</span> <span class="o">=</span> <span class="p">[</span> <span class="n">runner_vals</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">zip_longest</span><span class="p">(</span><span class="n">preplay_traded</span><span class="p">,</span> <span class="n">postplay_traded</span><span class="p">,</span> <span class="n">fillvalue</span><span class="o">=</span><span class="n">PriceSize</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">]</span>
<a id="__codelineno-7-31" name="__codelineno-7-31" href="#__codelineno-7-31"></a>
<a id="__codelineno-7-32" name="__codelineno-7-32" href="#__codelineno-7-32"></a><span class="c1"># runner price data for markets that don&#39;t go in play</span>
<a id="__codelineno-7-33" name="__codelineno-7-33" href="#__codelineno-7-33"></a><span class="k">else</span><span class="p">:</span>
<a id="__codelineno-7-34" name="__codelineno-7-34" href="#__codelineno-7-34"></a>    <span class="k">def</span> <span class="nf">runner_vals</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
<a id="__codelineno-7-35" name="__codelineno-7-35" href="#__codelineno-7-35"></a>        <span class="p">(</span><span class="n">ltp</span><span class="p">,</span> <span class="n">traded</span><span class="p">,</span> <span class="n">sp_traded</span><span class="p">)</span> <span class="o">=</span> <span class="n">r</span>
<a id="__codelineno-7-36" name="__codelineno-7-36" href="#__codelineno-7-36"></a>        <span class="p">(</span><span class="n">wavg</span><span class="p">,</span> <span class="n">matched</span><span class="p">,</span> <span class="n">min_price</span><span class="p">,</span> <span class="n">max_price</span><span class="p">)</span> <span class="o">=</span> <span class="n">parse_traded</span><span class="p">(</span><span class="n">traded</span><span class="p">)</span>
<a id="__codelineno-7-37" name="__codelineno-7-37" href="#__codelineno-7-37"></a>
<a id="__codelineno-7-38" name="__codelineno-7-38" href="#__codelineno-7-38"></a>        <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-7-39" name="__codelineno-7-39" href="#__codelineno-7-39"></a>            <span class="s1">&#39;preplay_ltp&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">ltp</span><span class="p">),</span>
<a id="__codelineno-7-40" name="__codelineno-7-40" href="#__codelineno-7-40"></a>            <span class="s1">&#39;preplay_min&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">min_price</span><span class="p">),</span>
<a id="__codelineno-7-41" name="__codelineno-7-41" href="#__codelineno-7-41"></a>            <span class="s1">&#39;preplay_max&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">max_price</span><span class="p">),</span>
<a id="__codelineno-7-42" name="__codelineno-7-42" href="#__codelineno-7-42"></a>            <span class="s1">&#39;preplay_wavg&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">wavg</span><span class="p">),</span>
<a id="__codelineno-7-43" name="__codelineno-7-43" href="#__codelineno-7-43"></a>            <span class="s1">&#39;preplay_matched&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">((</span><span class="n">matched</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">sp_traded</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)),</span>
<a id="__codelineno-7-44" name="__codelineno-7-44" href="#__codelineno-7-44"></a>            <span class="s1">&#39;inplay_ltp&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
<a id="__codelineno-7-45" name="__codelineno-7-45" href="#__codelineno-7-45"></a>            <span class="s1">&#39;inplay_min&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
<a id="__codelineno-7-46" name="__codelineno-7-46" href="#__codelineno-7-46"></a>            <span class="s1">&#39;inplay_max&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
<a id="__codelineno-7-47" name="__codelineno-7-47" href="#__codelineno-7-47"></a>            <span class="s1">&#39;inplay_wavg&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
<a id="__codelineno-7-48" name="__codelineno-7-48" href="#__codelineno-7-48"></a>            <span class="s1">&#39;inplay_matched&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
<a id="__codelineno-7-49" name="__codelineno-7-49" href="#__codelineno-7-49"></a>        <span class="p">}</span>
<a id="__codelineno-7-50" name="__codelineno-7-50" href="#__codelineno-7-50"></a>
<a id="__codelineno-7-51" name="__codelineno-7-51" href="#__codelineno-7-51"></a>    <span class="n">runner_traded</span> <span class="o">=</span> <span class="p">[</span> <span class="n">runner_vals</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">postplay_traded</span> <span class="p">]</span>
</code></pre></div>
<hr />
<h3 id="writing-to-csv">Writing to CSV</h3>
<p>We defined the columns we want for our csv pretty early in the code. </p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="c1"># record prices to a file</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;output.csv&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">output</span><span class="p">:</span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>    <span class="c1"># defining column headers</span>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a>    <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;market_id,event_date,country,track,market_name,selection_id,selection_name,result,bsp,pp_min,pp_max,pp_wap,pp_ltp,pp_volume,ip_min,ip_max,ip_wap,ip_ltp,ip_volume</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<p>We then assign the values for each column.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="c1"># printing to csv for each runner</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="k">for</span> <span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="n">rprices</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">runner_data</span><span class="p">,</span> <span class="n">runner_traded</span><span class="p">):</span>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a>    <span class="c1"># defining data to go in each column</span>
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a>    <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a>        <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
<a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a>            <span class="n">postplay_market</span><span class="o">.</span><span class="n">market_id</span><span class="p">,</span>
<a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a>            <span class="n">postplay_market</span><span class="o">.</span><span class="n">market_definition</span><span class="o">.</span><span class="n">market_time</span><span class="p">,</span>
<a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a>            <span class="n">postplay_market</span><span class="o">.</span><span class="n">market_definition</span><span class="o">.</span><span class="n">country_code</span><span class="p">,</span>
<a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a>            <span class="n">postplay_market</span><span class="o">.</span><span class="n">market_definition</span><span class="o">.</span><span class="n">venue</span><span class="p">,</span>
<a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a>            <span class="n">postplay_market</span><span class="o">.</span><span class="n">market_definition</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a>            <span class="n">rdata</span><span class="p">[</span><span class="s1">&#39;selection_id&#39;</span><span class="p">],</span>
<a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a>            <span class="n">rdata</span><span class="p">[</span><span class="s1">&#39;selection_name&#39;</span><span class="p">],</span>
<a id="__codelineno-9-13" name="__codelineno-9-13" href="#__codelineno-9-13"></a>            <span class="n">rdata</span><span class="p">[</span><span class="s1">&#39;selection_status&#39;</span><span class="p">],</span>
<a id="__codelineno-9-14" name="__codelineno-9-14" href="#__codelineno-9-14"></a>            <span class="n">rdata</span><span class="p">[</span><span class="s1">&#39;sp&#39;</span><span class="p">],</span>
<a id="__codelineno-9-15" name="__codelineno-9-15" href="#__codelineno-9-15"></a>            <span class="n">rprices</span><span class="p">[</span><span class="s1">&#39;preplay_min&#39;</span><span class="p">],</span>
<a id="__codelineno-9-16" name="__codelineno-9-16" href="#__codelineno-9-16"></a>            <span class="n">rprices</span><span class="p">[</span><span class="s1">&#39;preplay_max&#39;</span><span class="p">],</span>
<a id="__codelineno-9-17" name="__codelineno-9-17" href="#__codelineno-9-17"></a>            <span class="n">rprices</span><span class="p">[</span><span class="s1">&#39;preplay_wavg&#39;</span><span class="p">],</span>
<a id="__codelineno-9-18" name="__codelineno-9-18" href="#__codelineno-9-18"></a>            <span class="n">rprices</span><span class="p">[</span><span class="s1">&#39;preplay_ltp&#39;</span><span class="p">],</span>
<a id="__codelineno-9-19" name="__codelineno-9-19" href="#__codelineno-9-19"></a>            <span class="n">rprices</span><span class="p">[</span><span class="s1">&#39;preplay_matched&#39;</span><span class="p">],</span>
<a id="__codelineno-9-20" name="__codelineno-9-20" href="#__codelineno-9-20"></a>            <span class="n">rprices</span><span class="p">[</span><span class="s1">&#39;inplay_min&#39;</span><span class="p">],</span>
<a id="__codelineno-9-21" name="__codelineno-9-21" href="#__codelineno-9-21"></a>            <span class="n">rprices</span><span class="p">[</span><span class="s1">&#39;inplay_max&#39;</span><span class="p">],</span>
<a id="__codelineno-9-22" name="__codelineno-9-22" href="#__codelineno-9-22"></a>            <span class="n">rprices</span><span class="p">[</span><span class="s1">&#39;inplay_wavg&#39;</span><span class="p">],</span>
<a id="__codelineno-9-23" name="__codelineno-9-23" href="#__codelineno-9-23"></a>            <span class="n">rprices</span><span class="p">[</span><span class="s1">&#39;inplay_ltp&#39;</span><span class="p">],</span>
<a id="__codelineno-9-24" name="__codelineno-9-24" href="#__codelineno-9-24"></a>            <span class="n">rprices</span><span class="p">[</span><span class="s1">&#39;inplay_matched&#39;</span><span class="p">],</span>
<a id="__codelineno-9-25" name="__codelineno-9-25" href="#__codelineno-9-25"></a>        <span class="p">)</span>
<a id="__codelineno-9-26" name="__codelineno-9-26" href="#__codelineno-9-26"></a>    <span class="p">)</span>
</code></pre></div>
<hr />
<h3 id="filtering-markets">Filtering markets</h3>
<p>Currently we're going through every file provided in the raw data folders, which in our case included markets from different countries, all different market types and both gallops and harness races. To save filtering these markets manually later in Excel, and also to avoid processing additional data we don't need and slowing the process down further, we decided to add a market filter so we only kept the markets we were interested in.</p>
<p>We filtered on three things:</p>
<ul>
<li>event country code (i.e. AU, NZ, GB etc)</li>
<li>market type (i.e. win, place etc)</li>
<li>race type (i.e. gallops or harness)</li>
</ul>
<p>Using this logic, we are only keeping Australian win markets for gallops races.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="c1"># filtering markets to those that fit the following criteria</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="k">def</span> <span class="nf">filter_market</span><span class="p">(</span><span class="n">market</span><span class="p">:</span> <span class="n">MarketBook</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span> 
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a>    <span class="n">d</span> <span class="o">=</span> <span class="n">market</span><span class="o">.</span><span class="n">market_definition</span>
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a>    <span class="k">return</span> <span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">country_code</span> <span class="o">==</span> <span class="s1">&#39;AU&#39;</span> 
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a>        <span class="ow">and</span> <span class="n">d</span><span class="o">.</span><span class="n">market_type</span> <span class="o">==</span> <span class="s1">&#39;WIN&#39;</span> 
<a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a>        <span class="ow">and</span> <span class="p">(</span><span class="n">c</span> <span class="o">:=</span> <span class="n">split_anz_horse_market_name</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">name</span><span class="p">)[</span><span class="mi">2</span><span class="p">])</span> <span class="o">!=</span> <span class="s1">&#39;trot&#39;</span> <span class="ow">and</span> <span class="n">c</span> <span class="o">!=</span> <span class="s1">&#39;pace&#39;</span><span class="p">)</span>
</code></pre></div>
<p>Filtering out harness markets was the trickiest part of the process, as there's no neat way of separating harness meetings from gallops. To do this we had to parse the market name and look for the words 'trot' and 'pace', and treat the market as harness if we found either. To make it a little tidier we wrote a function to split the market name into its component parts. </p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="c1"># splitting race name and returning the parts </span>
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="k">def</span> <span class="nf">split_anz_horse_market_name</span><span class="p">(</span><span class="n">market_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a>    <span class="c1"># return race no, length, race type</span>
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a>    <span class="c1"># input samples: </span>
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a>    <span class="c1"># &#39;R6 1400m Grp1&#39; -&gt; (&#39;R6&#39;,&#39;1400m&#39;,&#39;grp1&#39;)</span>
<a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a>    <span class="c1"># &#39;R1 1609m Trot M&#39; -&gt; (&#39;R1&#39;, &#39;1609m&#39;, &#39;trot&#39;)</span>
<a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a>    <span class="c1"># &#39;R4 1660m Pace M&#39; -&gt; (&#39;R4&#39;, &#39;1660m&#39;, &#39;pace&#39;)</span>
<a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a>    <span class="n">parts</span> <span class="o">=</span> <span class="n">market_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
<a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a>    <span class="n">race_no</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> 
<a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a>    <span class="n">race_len</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> 
<a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a>    <span class="n">race_type</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
<a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a>
<a id="__codelineno-11-13" name="__codelineno-11-13" href="#__codelineno-11-13"></a>    <span class="k">return</span> <span class="p">(</span><span class="n">race_no</span><span class="p">,</span> <span class="n">race_len</span><span class="p">,</span> <span class="n">race_type</span><span class="p">)</span>
</code></pre></div>
<p>We declare an <code>evaluate_market</code> flag and set it to none, and then in our loop the first time we evaluate the market we run the filter and skip any markets that don't meet our criteria.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="n">eval_market</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a>
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="n">gen</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">get_generator</span><span class="p">()</span>
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a>
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="k">for</span> <span class="n">market_books</span> <span class="ow">in</span> <span class="n">gen</span><span class="p">():</span>
<a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a>    <span class="k">for</span> <span class="n">market_book</span> <span class="ow">in</span> <span class="n">market_books</span><span class="p">:</span>
<a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a>
<a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a>        <span class="c1"># if market doesn&#39;t meet filter return out</span>
<a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a>        <span class="k">if</span> <span class="n">eval_market</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">((</span><span class="n">eval_market</span> <span class="o">:=</span> <span class="n">filter_market</span><span class="p">(</span><span class="n">market_book</span><span class="p">))</span> <span class="o">==</span> <span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a>            <span class="k">return</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</code></pre></div>
<hr />
<h3 id="helper-functions">Helper functions</h3>
<p>There are a couple of helper functions we wrote along the way to make the rest of the code easier to handle. </p>
<p><strong>As string</strong></p>
<p>Takes in a number and returns a text representation of it, rounding to two decimal places. </p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="c1"># rounding to 2 decimal places or returning &#39;&#39; if blank</span>
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="k">def</span> <span class="nf">as_str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a>    <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">v</span> <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="n">v</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
</code></pre></div>
<p><strong>Min value greater than 0</strong></p>
<p>Returns the smaller of two numbers, where the smaller isn't 0. </p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="c1"># returning smaller of two numbers where min not 0</span>
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="k">def</span> <span class="nf">min_gr0</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a>    <span class="k">if</span> <span class="n">a</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a>        <span class="k">return</span> <span class="n">b</span>
<a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a>    <span class="k">if</span> <span class="n">b</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a>        <span class="k">return</span> <span class="n">a</span>
<a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a>
<a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a>    <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
</code></pre></div>
<hr />
<h3 id="final-thoughts">Final thoughts</h3>
<p><code>betfairlightweight</code> provides a ready made package that makes it easier to work with the JSON data and a pretty easy way to convert the data into a csv format, allowing you to then do your data wrangling in Excel if that's where you're more comfortable. </p>
<p>Our intention is that you don't need a heap of Python experience to be able to work through this tutorial; as long as you're prepared to get the Python environment set up and learn some basic programming skills, the hope is that you'll be able to customise your own csv file and maybe even extend on what we've covered and produced here.</p>
<p>We're planning on writing some more tutorials to help make it easier to work with the JSON data sets. If there are particular examples or data sets you'd like to see us walk through <a href="mailto:data@betfair.com.au">please reach out</a>.</p>
<div class="admonition note">
<p class="admonition-title">Community support</p>
<ul>
<li>There's a really active <a href="https://betcode-org.slack.com/ssb/redirect">Betcode (formerly Betfairlightweight) slack group</a> that's a great place to go to ask questions about the library and get support from other people who are also working in the space</li>
</ul>
</div>
<hr />
<h3 id="complete-code">Complete code</h3>
<p>Run the code from your ide by using <code>py &lt;filename&gt;.py</code>, making sure you amend the path to point to your input data. Please note: the script will take some time before it starts outputting to the output.csv file, so let it run for a few minutes before getting worried that it's not working! You'll also see errors logged to the out file or terminal screen depending on your set up. </p>
<p><a href="https://github.com/betfair-down-under/autoHubTutorials/blob/master/jsonToCsv/main.py">Download from Github</a></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="kn">import</span> <span class="nn">logging</span>
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span>
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a>
<a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a><span class="kn">from</span> <span class="nn">unittest.mock</span> <span class="kn">import</span> <span class="n">patch</span>
<a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a><span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">zip_longest</span>
<a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a><span class="kn">import</span> <span class="nn">functools</span>
<a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a>
<a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a><span class="kn">import</span> <span class="nn">os</span>
<a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a><span class="kn">import</span> <span class="nn">tarfile</span>
<a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a><span class="kn">import</span> <span class="nn">zipfile</span>
<a id="__codelineno-15-11" name="__codelineno-15-11" href="#__codelineno-15-11"></a><span class="kn">import</span> <span class="nn">bz2</span>
<a id="__codelineno-15-12" name="__codelineno-15-12" href="#__codelineno-15-12"></a><span class="kn">import</span> <span class="nn">glob</span>
<a id="__codelineno-15-13" name="__codelineno-15-13" href="#__codelineno-15-13"></a>
<a id="__codelineno-15-14" name="__codelineno-15-14" href="#__codelineno-15-14"></a><span class="c1"># importing data types</span>
<a id="__codelineno-15-15" name="__codelineno-15-15" href="#__codelineno-15-15"></a><span class="kn">import</span> <span class="nn">betfairlightweight</span>
<a id="__codelineno-15-16" name="__codelineno-15-16" href="#__codelineno-15-16"></a><span class="kn">from</span> <span class="nn">betfairlightweight.resources.bettingresources</span> <span class="kn">import</span> <span class="p">(</span>
<a id="__codelineno-15-17" name="__codelineno-15-17" href="#__codelineno-15-17"></a>    <span class="n">PriceSize</span><span class="p">,</span>
<a id="__codelineno-15-18" name="__codelineno-15-18" href="#__codelineno-15-18"></a>    <span class="n">MarketBook</span> 
<a id="__codelineno-15-19" name="__codelineno-15-19" href="#__codelineno-15-19"></a><span class="p">)</span>
<a id="__codelineno-15-20" name="__codelineno-15-20" href="#__codelineno-15-20"></a>
<a id="__codelineno-15-21" name="__codelineno-15-21" href="#__codelineno-15-21"></a><span class="n">file_output</span> <span class="o">=</span> <span class="s2">&quot;output_bflw.csv&quot;</span>
<a id="__codelineno-15-22" name="__codelineno-15-22" href="#__codelineno-15-22"></a>
<a id="__codelineno-15-23" name="__codelineno-15-23" href="#__codelineno-15-23"></a><span class="n">market_paths</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-15-24" name="__codelineno-15-24" href="#__codelineno-15-24"></a>    <span class="s2">&quot;data/2021_10_OctRacingAUPro.tar&quot;</span><span class="p">,</span>
<a id="__codelineno-15-25" name="__codelineno-15-25" href="#__codelineno-15-25"></a>    <span class="s2">&quot;data/2021_11_NovRacingAUPro.tar&quot;</span><span class="p">,</span>
<a id="__codelineno-15-26" name="__codelineno-15-26" href="#__codelineno-15-26"></a>    <span class="s2">&quot;data/2021_12_DecRacingAUPro.tar&quot;</span><span class="p">,</span>
<a id="__codelineno-15-27" name="__codelineno-15-27" href="#__codelineno-15-27"></a><span class="p">]</span>
<a id="__codelineno-15-28" name="__codelineno-15-28" href="#__codelineno-15-28"></a>
<a id="__codelineno-15-29" name="__codelineno-15-29" href="#__codelineno-15-29"></a><span class="c1"># setup logging</span>
<a id="__codelineno-15-30" name="__codelineno-15-30" href="#__codelineno-15-30"></a><span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">FATAL</span><span class="p">)</span>
<a id="__codelineno-15-31" name="__codelineno-15-31" href="#__codelineno-15-31"></a>
<a id="__codelineno-15-32" name="__codelineno-15-32" href="#__codelineno-15-32"></a><span class="c1"># create trading instance (don&#39;t need username/password)</span>
<a id="__codelineno-15-33" name="__codelineno-15-33" href="#__codelineno-15-33"></a><span class="n">trading</span> <span class="o">=</span> <span class="n">betfairlightweight</span><span class="o">.</span><span class="n">APIClient</span><span class="p">(</span><span class="s2">&quot;username&quot;</span><span class="p">,</span> <span class="s2">&quot;password&quot;</span><span class="p">,</span> <span class="s2">&quot;appkey&quot;</span><span class="p">)</span>
<a id="__codelineno-15-34" name="__codelineno-15-34" href="#__codelineno-15-34"></a>
<a id="__codelineno-15-35" name="__codelineno-15-35" href="#__codelineno-15-35"></a><span class="c1"># create listener</span>
<a id="__codelineno-15-36" name="__codelineno-15-36" href="#__codelineno-15-36"></a><span class="n">listener</span> <span class="o">=</span> <span class="n">betfairlightweight</span><span class="o">.</span><span class="n">StreamListener</span><span class="p">(</span>
<a id="__codelineno-15-37" name="__codelineno-15-37" href="#__codelineno-15-37"></a>    <span class="n">max_latency</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>   <span class="c1"># ignore latency errors</span>
<a id="__codelineno-15-38" name="__codelineno-15-38" href="#__codelineno-15-38"></a>    <span class="n">output_queue</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># use generator rather than a queue (faster)</span>
<a id="__codelineno-15-39" name="__codelineno-15-39" href="#__codelineno-15-39"></a>    <span class="n">lightweight</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="c1"># lightweight mode is faster</span>
<a id="__codelineno-15-40" name="__codelineno-15-40" href="#__codelineno-15-40"></a>    <span class="n">update_clk</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>   <span class="c1"># do not update clk on updates (not required when backtesting)</span>
<a id="__codelineno-15-41" name="__codelineno-15-41" href="#__codelineno-15-41"></a>
<a id="__codelineno-15-42" name="__codelineno-15-42" href="#__codelineno-15-42"></a>    <span class="n">cumulative_runner_tv</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
<a id="__codelineno-15-43" name="__codelineno-15-43" href="#__codelineno-15-43"></a>    <span class="n">calculate_market_tv</span><span class="o">=</span><span class="kc">True</span>
<a id="__codelineno-15-44" name="__codelineno-15-44" href="#__codelineno-15-44"></a><span class="p">)</span>
<a id="__codelineno-15-45" name="__codelineno-15-45" href="#__codelineno-15-45"></a>
<a id="__codelineno-15-46" name="__codelineno-15-46" href="#__codelineno-15-46"></a><span class="c1"># loading from tar and extracting files</span>
<a id="__codelineno-15-47" name="__codelineno-15-47" href="#__codelineno-15-47"></a><span class="k">def</span> <span class="nf">load_markets</span><span class="p">(</span><span class="n">file_paths</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
<a id="__codelineno-15-48" name="__codelineno-15-48" href="#__codelineno-15-48"></a>    <span class="k">for</span> <span class="n">file_path</span> <span class="ow">in</span> <span class="n">file_paths</span><span class="p">:</span>
<a id="__codelineno-15-49" name="__codelineno-15-49" href="#__codelineno-15-49"></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
<a id="__codelineno-15-50" name="__codelineno-15-50" href="#__codelineno-15-50"></a>            <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">iglob</span><span class="p">(</span><span class="n">file_path</span> <span class="o">+</span> <span class="s1">&#39;**/**/*.bz2&#39;</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<a id="__codelineno-15-51" name="__codelineno-15-51" href="#__codelineno-15-51"></a>                <span class="n">f</span> <span class="o">=</span> <span class="n">bz2</span><span class="o">.</span><span class="n">BZ2File</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
<a id="__codelineno-15-52" name="__codelineno-15-52" href="#__codelineno-15-52"></a>                <span class="k">yield</span> <span class="n">f</span>
<a id="__codelineno-15-53" name="__codelineno-15-53" href="#__codelineno-15-53"></a>                <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<a id="__codelineno-15-54" name="__codelineno-15-54" href="#__codelineno-15-54"></a>        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
<a id="__codelineno-15-55" name="__codelineno-15-55" href="#__codelineno-15-55"></a>            <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file_path</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-15-56" name="__codelineno-15-56" href="#__codelineno-15-56"></a>            <span class="c1"># iterate through a tar archive</span>
<a id="__codelineno-15-57" name="__codelineno-15-57" href="#__codelineno-15-57"></a>            <span class="k">if</span> <span class="n">ext</span> <span class="o">==</span> <span class="s1">&#39;.tar&#39;</span><span class="p">:</span>
<a id="__codelineno-15-58" name="__codelineno-15-58" href="#__codelineno-15-58"></a>                <span class="k">with</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">TarFile</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">archive</span><span class="p">:</span>
<a id="__codelineno-15-59" name="__codelineno-15-59" href="#__codelineno-15-59"></a>                    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">archive</span><span class="p">:</span>
<a id="__codelineno-15-60" name="__codelineno-15-60" href="#__codelineno-15-60"></a>                        <span class="k">yield</span> <span class="n">bz2</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">archive</span><span class="o">.</span><span class="n">extractfile</span><span class="p">(</span><span class="n">file</span><span class="p">))</span>
<a id="__codelineno-15-61" name="__codelineno-15-61" href="#__codelineno-15-61"></a>            <span class="c1"># or a zip archive</span>
<a id="__codelineno-15-62" name="__codelineno-15-62" href="#__codelineno-15-62"></a>            <span class="k">elif</span> <span class="n">ext</span> <span class="o">==</span> <span class="s1">&#39;.zip&#39;</span><span class="p">:</span>
<a id="__codelineno-15-63" name="__codelineno-15-63" href="#__codelineno-15-63"></a>                <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">archive</span><span class="p">:</span>
<a id="__codelineno-15-64" name="__codelineno-15-64" href="#__codelineno-15-64"></a>                    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">archive</span><span class="o">.</span><span class="n">namelist</span><span class="p">():</span>
<a id="__codelineno-15-65" name="__codelineno-15-65" href="#__codelineno-15-65"></a>                        <span class="k">yield</span> <span class="n">bz2</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">archive</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file</span><span class="p">))</span>
<a id="__codelineno-15-66" name="__codelineno-15-66" href="#__codelineno-15-66"></a>    <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-15-67" name="__codelineno-15-67" href="#__codelineno-15-67"></a>
<a id="__codelineno-15-68" name="__codelineno-15-68" href="#__codelineno-15-68"></a><span class="c1"># rounding to 2 decimal places or returning &#39;&#39; if blank</span>
<a id="__codelineno-15-69" name="__codelineno-15-69" href="#__codelineno-15-69"></a><span class="k">def</span> <span class="nf">as_str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-15-70" name="__codelineno-15-70" href="#__codelineno-15-70"></a>    <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">v</span> <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="n">v</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
<a id="__codelineno-15-71" name="__codelineno-15-71" href="#__codelineno-15-71"></a>
<a id="__codelineno-15-72" name="__codelineno-15-72" href="#__codelineno-15-72"></a><span class="c1"># returning smaller of two numbers where min not 0</span>
<a id="__codelineno-15-73" name="__codelineno-15-73" href="#__codelineno-15-73"></a><span class="k">def</span> <span class="nf">min_gr0</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<a id="__codelineno-15-74" name="__codelineno-15-74" href="#__codelineno-15-74"></a>    <span class="k">if</span> <span class="n">a</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-15-75" name="__codelineno-15-75" href="#__codelineno-15-75"></a>        <span class="k">return</span> <span class="n">b</span>
<a id="__codelineno-15-76" name="__codelineno-15-76" href="#__codelineno-15-76"></a>    <span class="k">if</span> <span class="n">b</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-15-77" name="__codelineno-15-77" href="#__codelineno-15-77"></a>        <span class="k">return</span> <span class="n">a</span>
<a id="__codelineno-15-78" name="__codelineno-15-78" href="#__codelineno-15-78"></a>
<a id="__codelineno-15-79" name="__codelineno-15-79" href="#__codelineno-15-79"></a>    <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
<a id="__codelineno-15-80" name="__codelineno-15-80" href="#__codelineno-15-80"></a>
<a id="__codelineno-15-81" name="__codelineno-15-81" href="#__codelineno-15-81"></a><span class="c1"># parsing price data and pulling out weighted avg price, matched, min price and max price</span>
<a id="__codelineno-15-82" name="__codelineno-15-82" href="#__codelineno-15-82"></a><span class="k">def</span> <span class="nf">parse_traded</span><span class="p">(</span><span class="n">traded</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">PriceSize</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<a id="__codelineno-15-83" name="__codelineno-15-83" href="#__codelineno-15-83"></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">traded</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> 
<a id="__codelineno-15-84" name="__codelineno-15-84" href="#__codelineno-15-84"></a>        <span class="k">return</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-15-85" name="__codelineno-15-85" href="#__codelineno-15-85"></a>
<a id="__codelineno-15-86" name="__codelineno-15-86" href="#__codelineno-15-86"></a>    <span class="p">(</span><span class="n">wavg_sum</span><span class="p">,</span> <span class="n">matched</span><span class="p">,</span> <span class="n">min_price</span><span class="p">,</span> <span class="n">max_price</span><span class="p">)</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span>
<a id="__codelineno-15-87" name="__codelineno-15-87" href="#__codelineno-15-87"></a>        <span class="k">lambda</span> <span class="n">total</span><span class="p">,</span> <span class="n">ps</span><span class="p">:</span> <span class="p">(</span>
<a id="__codelineno-15-88" name="__codelineno-15-88" href="#__codelineno-15-88"></a>            <span class="n">total</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">ps</span><span class="o">.</span><span class="n">price</span> <span class="o">*</span> <span class="n">ps</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="c1"># wavg_sum before we divide by total matched</span>
<a id="__codelineno-15-89" name="__codelineno-15-89" href="#__codelineno-15-89"></a>            <span class="n">total</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">ps</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="c1"># total matched</span>
<a id="__codelineno-15-90" name="__codelineno-15-90" href="#__codelineno-15-90"></a>            <span class="nb">min</span><span class="p">(</span><span class="n">total</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">ps</span><span class="o">.</span><span class="n">price</span><span class="p">),</span> <span class="c1"># min price matched</span>
<a id="__codelineno-15-91" name="__codelineno-15-91" href="#__codelineno-15-91"></a>            <span class="nb">max</span><span class="p">(</span><span class="n">total</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">ps</span><span class="o">.</span><span class="n">price</span><span class="p">),</span> <span class="c1"># max price matched</span>
<a id="__codelineno-15-92" name="__codelineno-15-92" href="#__codelineno-15-92"></a>        <span class="p">),</span>
<a id="__codelineno-15-93" name="__codelineno-15-93" href="#__codelineno-15-93"></a>        <span class="n">traded</span><span class="p">,</span>
<a id="__codelineno-15-94" name="__codelineno-15-94" href="#__codelineno-15-94"></a>        <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1001</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c1"># starting default values</span>
<a id="__codelineno-15-95" name="__codelineno-15-95" href="#__codelineno-15-95"></a>    <span class="p">)</span>
<a id="__codelineno-15-96" name="__codelineno-15-96" href="#__codelineno-15-96"></a>
<a id="__codelineno-15-97" name="__codelineno-15-97" href="#__codelineno-15-97"></a>    <span class="n">wavg_sum</span> <span class="o">=</span> <span class="p">(</span><span class="n">wavg_sum</span> <span class="o">/</span> <span class="n">matched</span><span class="p">)</span> <span class="k">if</span> <span class="n">matched</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span> <span class="c1"># dividing sum of wavg by total matched</span>
<a id="__codelineno-15-98" name="__codelineno-15-98" href="#__codelineno-15-98"></a>    <span class="n">matched</span> <span class="o">=</span> <span class="n">matched</span> <span class="k">if</span> <span class="n">matched</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span> 
<a id="__codelineno-15-99" name="__codelineno-15-99" href="#__codelineno-15-99"></a>    <span class="n">min_price</span> <span class="o">=</span> <span class="n">min_price</span> <span class="k">if</span> <span class="n">min_price</span> <span class="o">!=</span> <span class="mi">1001</span> <span class="k">else</span> <span class="kc">None</span>
<a id="__codelineno-15-100" name="__codelineno-15-100" href="#__codelineno-15-100"></a>    <span class="n">max_price</span> <span class="o">=</span> <span class="n">max_price</span> <span class="k">if</span> <span class="n">max_price</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span>
<a id="__codelineno-15-101" name="__codelineno-15-101" href="#__codelineno-15-101"></a>
<a id="__codelineno-15-102" name="__codelineno-15-102" href="#__codelineno-15-102"></a>    <span class="k">return</span> <span class="p">(</span><span class="n">wavg_sum</span><span class="p">,</span> <span class="n">matched</span><span class="p">,</span> <span class="n">min_price</span><span class="p">,</span> <span class="n">max_price</span><span class="p">)</span>
<a id="__codelineno-15-103" name="__codelineno-15-103" href="#__codelineno-15-103"></a>
<a id="__codelineno-15-104" name="__codelineno-15-104" href="#__codelineno-15-104"></a><span class="c1"># splitting race name and returning the parts </span>
<a id="__codelineno-15-105" name="__codelineno-15-105" href="#__codelineno-15-105"></a><span class="k">def</span> <span class="nf">split_anz_horse_market_name</span><span class="p">(</span><span class="n">market_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<a id="__codelineno-15-106" name="__codelineno-15-106" href="#__codelineno-15-106"></a>    <span class="c1"># return race no, length, race type</span>
<a id="__codelineno-15-107" name="__codelineno-15-107" href="#__codelineno-15-107"></a>    <span class="c1"># input samples: </span>
<a id="__codelineno-15-108" name="__codelineno-15-108" href="#__codelineno-15-108"></a>    <span class="c1"># &#39;R6 1400m Grp1&#39; -&gt; (&#39;R6&#39;,&#39;1400m&#39;,&#39;grp1&#39;)</span>
<a id="__codelineno-15-109" name="__codelineno-15-109" href="#__codelineno-15-109"></a>    <span class="c1"># &#39;R1 1609m Trot M&#39; -&gt; (&#39;R1&#39;, &#39;1609m&#39;, &#39;trot&#39;)</span>
<a id="__codelineno-15-110" name="__codelineno-15-110" href="#__codelineno-15-110"></a>    <span class="c1"># &#39;R4 1660m Pace M&#39; -&gt; (&#39;R4&#39;, &#39;1660m&#39;, &#39;pace&#39;)</span>
<a id="__codelineno-15-111" name="__codelineno-15-111" href="#__codelineno-15-111"></a>    <span class="n">parts</span> <span class="o">=</span> <span class="n">market_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
<a id="__codelineno-15-112" name="__codelineno-15-112" href="#__codelineno-15-112"></a>    <span class="n">race_no</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> 
<a id="__codelineno-15-113" name="__codelineno-15-113" href="#__codelineno-15-113"></a>    <span class="n">race_len</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> 
<a id="__codelineno-15-114" name="__codelineno-15-114" href="#__codelineno-15-114"></a>    <span class="n">race_type</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> 
<a id="__codelineno-15-115" name="__codelineno-15-115" href="#__codelineno-15-115"></a>
<a id="__codelineno-15-116" name="__codelineno-15-116" href="#__codelineno-15-116"></a>    <span class="k">return</span> <span class="p">(</span><span class="n">race_no</span><span class="p">,</span> <span class="n">race_len</span><span class="p">,</span> <span class="n">race_type</span><span class="p">)</span>
<a id="__codelineno-15-117" name="__codelineno-15-117" href="#__codelineno-15-117"></a>
<a id="__codelineno-15-118" name="__codelineno-15-118" href="#__codelineno-15-118"></a><span class="c1"># filtering markets to those that fit the following criteria</span>
<a id="__codelineno-15-119" name="__codelineno-15-119" href="#__codelineno-15-119"></a><span class="k">def</span> <span class="nf">filter_market</span><span class="p">(</span><span class="n">market</span><span class="p">:</span> <span class="n">MarketBook</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span> 
<a id="__codelineno-15-120" name="__codelineno-15-120" href="#__codelineno-15-120"></a>    <span class="n">d</span> <span class="o">=</span> <span class="n">market</span><span class="o">.</span><span class="n">market_definition</span>
<a id="__codelineno-15-121" name="__codelineno-15-121" href="#__codelineno-15-121"></a>    <span class="k">return</span> <span class="p">(</span><span class="n">d</span> <span class="o">!=</span> <span class="kc">None</span>
<a id="__codelineno-15-122" name="__codelineno-15-122" href="#__codelineno-15-122"></a>        <span class="ow">and</span> <span class="n">d</span><span class="o">.</span><span class="n">country_code</span> <span class="o">==</span> <span class="s1">&#39;AU&#39;</span> 
<a id="__codelineno-15-123" name="__codelineno-15-123" href="#__codelineno-15-123"></a>        <span class="ow">and</span> <span class="n">d</span><span class="o">.</span><span class="n">market_type</span> <span class="o">==</span> <span class="s1">&#39;WIN&#39;</span> 
<a id="__codelineno-15-124" name="__codelineno-15-124" href="#__codelineno-15-124"></a>        <span class="ow">and</span> <span class="p">(</span><span class="n">c</span> <span class="o">:=</span> <span class="n">split_anz_horse_market_name</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">name</span><span class="p">)[</span><span class="mi">2</span><span class="p">])</span> <span class="o">!=</span> <span class="s1">&#39;trot&#39;</span> <span class="ow">and</span> <span class="n">c</span> <span class="o">!=</span> <span class="s1">&#39;pace&#39;</span><span class="p">)</span>
<a id="__codelineno-15-125" name="__codelineno-15-125" href="#__codelineno-15-125"></a>
<a id="__codelineno-15-126" name="__codelineno-15-126" href="#__codelineno-15-126"></a><span class="c1"># record prices to a file</span>
<a id="__codelineno-15-127" name="__codelineno-15-127" href="#__codelineno-15-127"></a><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_output</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">output</span><span class="p">:</span>
<a id="__codelineno-15-128" name="__codelineno-15-128" href="#__codelineno-15-128"></a>    <span class="c1"># defining column headers</span>
<a id="__codelineno-15-129" name="__codelineno-15-129" href="#__codelineno-15-129"></a>    <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;market_id,event_date,country,track,market_name,selection_id,selection_name,result,bsp,pp_min,pp_max,pp_wap,pp_ltp,pp_volume,ip_min,ip_max,ip_wap,ip_ltp,ip_volume</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-15-130" name="__codelineno-15-130" href="#__codelineno-15-130"></a>
<a id="__codelineno-15-131" name="__codelineno-15-131" href="#__codelineno-15-131"></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">file_obj</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">load_markets</span><span class="p">(</span><span class="n">market_paths</span><span class="p">)):</span>
<a id="__codelineno-15-132" name="__codelineno-15-132" href="#__codelineno-15-132"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Market </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-15-133" name="__codelineno-15-133" href="#__codelineno-15-133"></a>
<a id="__codelineno-15-134" name="__codelineno-15-134" href="#__codelineno-15-134"></a>        <span class="n">stream</span> <span class="o">=</span> <span class="n">trading</span><span class="o">.</span><span class="n">streaming</span><span class="o">.</span><span class="n">create_historical_generator_stream</span><span class="p">(</span>
<a id="__codelineno-15-135" name="__codelineno-15-135" href="#__codelineno-15-135"></a>            <span class="n">file_path</span><span class="o">=</span><span class="n">file_obj</span><span class="p">,</span>
<a id="__codelineno-15-136" name="__codelineno-15-136" href="#__codelineno-15-136"></a>            <span class="n">listener</span><span class="o">=</span><span class="n">listener</span><span class="p">,</span>
<a id="__codelineno-15-137" name="__codelineno-15-137" href="#__codelineno-15-137"></a>        <span class="p">)</span>
<a id="__codelineno-15-138" name="__codelineno-15-138" href="#__codelineno-15-138"></a>
<a id="__codelineno-15-139" name="__codelineno-15-139" href="#__codelineno-15-139"></a>        <span class="k">def</span> <span class="nf">get_pre_post_final</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
<a id="__codelineno-15-140" name="__codelineno-15-140" href="#__codelineno-15-140"></a>            <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s2">&quot;builtins.open&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">f</span><span class="p">,</span> <span class="n">_</span><span class="p">:</span> <span class="n">f</span><span class="p">):</span>   
<a id="__codelineno-15-141" name="__codelineno-15-141" href="#__codelineno-15-141"></a>                <span class="n">eval_market</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-15-142" name="__codelineno-15-142" href="#__codelineno-15-142"></a>                <span class="n">prev_market</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-15-143" name="__codelineno-15-143" href="#__codelineno-15-143"></a>                <span class="n">preplay_market</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-15-144" name="__codelineno-15-144" href="#__codelineno-15-144"></a>                <span class="n">postplay_market</span> <span class="o">=</span> <span class="kc">None</span>       
<a id="__codelineno-15-145" name="__codelineno-15-145" href="#__codelineno-15-145"></a>
<a id="__codelineno-15-146" name="__codelineno-15-146" href="#__codelineno-15-146"></a>                <span class="n">gen</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">get_generator</span><span class="p">()</span>
<a id="__codelineno-15-147" name="__codelineno-15-147" href="#__codelineno-15-147"></a>
<a id="__codelineno-15-148" name="__codelineno-15-148" href="#__codelineno-15-148"></a>                <span class="k">for</span> <span class="n">market_books</span> <span class="ow">in</span> <span class="n">gen</span><span class="p">():</span>
<a id="__codelineno-15-149" name="__codelineno-15-149" href="#__codelineno-15-149"></a>                    <span class="k">for</span> <span class="n">market_book</span> <span class="ow">in</span> <span class="n">market_books</span><span class="p">:</span>
<a id="__codelineno-15-150" name="__codelineno-15-150" href="#__codelineno-15-150"></a>                        <span class="c1"># if market doesn&#39;t meet filter return out</span>
<a id="__codelineno-15-151" name="__codelineno-15-151" href="#__codelineno-15-151"></a>                        <span class="k">if</span> <span class="n">eval_market</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">((</span><span class="n">eval_market</span> <span class="o">:=</span> <span class="n">filter_market</span><span class="p">(</span><span class="n">market_book</span><span class="p">))</span> <span class="o">==</span> <span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-15-152" name="__codelineno-15-152" href="#__codelineno-15-152"></a>                            <span class="k">return</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-15-153" name="__codelineno-15-153" href="#__codelineno-15-153"></a>
<a id="__codelineno-15-154" name="__codelineno-15-154" href="#__codelineno-15-154"></a>                        <span class="c1"># final market view before market goes in play</span>
<a id="__codelineno-15-155" name="__codelineno-15-155" href="#__codelineno-15-155"></a>                        <span class="k">if</span> <span class="n">prev_market</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">prev_market</span><span class="o">.</span><span class="n">inplay</span> <span class="o">!=</span> <span class="n">market_book</span><span class="o">.</span><span class="n">inplay</span><span class="p">:</span>
<a id="__codelineno-15-156" name="__codelineno-15-156" href="#__codelineno-15-156"></a>                            <span class="n">preplay_market</span> <span class="o">=</span> <span class="n">prev_market</span>
<a id="__codelineno-15-157" name="__codelineno-15-157" href="#__codelineno-15-157"></a>
<a id="__codelineno-15-158" name="__codelineno-15-158" href="#__codelineno-15-158"></a>                        <span class="c1"># final market view at the conclusion of the market</span>
<a id="__codelineno-15-159" name="__codelineno-15-159" href="#__codelineno-15-159"></a>                        <span class="k">if</span> <span class="n">prev_market</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">prev_market</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;OPEN&quot;</span> <span class="ow">and</span> <span class="n">market_book</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="n">prev_market</span><span class="o">.</span><span class="n">status</span><span class="p">:</span>
<a id="__codelineno-15-160" name="__codelineno-15-160" href="#__codelineno-15-160"></a>                            <span class="n">postplay_market</span> <span class="o">=</span> <span class="n">market_book</span>
<a id="__codelineno-15-161" name="__codelineno-15-161" href="#__codelineno-15-161"></a>
<a id="__codelineno-15-162" name="__codelineno-15-162" href="#__codelineno-15-162"></a>                        <span class="c1"># update reference to previous market</span>
<a id="__codelineno-15-163" name="__codelineno-15-163" href="#__codelineno-15-163"></a>                        <span class="n">prev_market</span> <span class="o">=</span> <span class="n">market_book</span>
<a id="__codelineno-15-164" name="__codelineno-15-164" href="#__codelineno-15-164"></a>
<a id="__codelineno-15-165" name="__codelineno-15-165" href="#__codelineno-15-165"></a>                <span class="k">return</span> <span class="p">(</span><span class="n">preplay_market</span><span class="p">,</span> <span class="n">postplay_market</span><span class="p">,</span> <span class="n">prev_market</span><span class="p">)</span> <span class="c1"># prev is now final</span>
<a id="__codelineno-15-166" name="__codelineno-15-166" href="#__codelineno-15-166"></a>
<a id="__codelineno-15-167" name="__codelineno-15-167" href="#__codelineno-15-167"></a>        <span class="p">(</span><span class="n">preplay_market</span><span class="p">,</span> <span class="n">postplay_market</span><span class="p">,</span> <span class="n">final_market</span><span class="p">)</span> <span class="o">=</span> <span class="n">get_pre_post_final</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
<a id="__codelineno-15-168" name="__codelineno-15-168" href="#__codelineno-15-168"></a>
<a id="__codelineno-15-169" name="__codelineno-15-169" href="#__codelineno-15-169"></a>        <span class="c1"># no price data for market</span>
<a id="__codelineno-15-170" name="__codelineno-15-170" href="#__codelineno-15-170"></a>        <span class="k">if</span> <span class="n">postplay_market</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-15-171" name="__codelineno-15-171" href="#__codelineno-15-171"></a>            <span class="k">continue</span><span class="p">;</span> 
<a id="__codelineno-15-172" name="__codelineno-15-172" href="#__codelineno-15-172"></a>
<a id="__codelineno-15-173" name="__codelineno-15-173" href="#__codelineno-15-173"></a>        <span class="n">preplay_traded</span> <span class="o">=</span> <span class="p">[</span> <span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">last_price_traded</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">traded_volume</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">preplay_market</span><span class="o">.</span><span class="n">runners</span> <span class="p">]</span> <span class="k">if</span> <span class="n">preplay_market</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
<a id="__codelineno-15-174" name="__codelineno-15-174" href="#__codelineno-15-174"></a>        <span class="n">postplay_traded</span> <span class="o">=</span> <span class="p">[</span> <span class="p">(</span>
<a id="__codelineno-15-175" name="__codelineno-15-175" href="#__codelineno-15-175"></a>            <span class="n">r</span><span class="o">.</span><span class="n">last_price_traded</span><span class="p">,</span>
<a id="__codelineno-15-176" name="__codelineno-15-176" href="#__codelineno-15-176"></a>            <span class="n">r</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">traded_volume</span><span class="p">,</span>
<a id="__codelineno-15-177" name="__codelineno-15-177" href="#__codelineno-15-177"></a>            <span class="c1"># calculating SP traded vol as smaller of back_stake_taken or (lay_liability_taken / (BSP - 1))        </span>
<a id="__codelineno-15-178" name="__codelineno-15-178" href="#__codelineno-15-178"></a>            <span class="n">min_gr0</span><span class="p">(</span>
<a id="__codelineno-15-179" name="__codelineno-15-179" href="#__codelineno-15-179"></a>                <span class="nb">next</span><span class="p">((</span><span class="n">pv</span><span class="o">.</span><span class="n">size</span> <span class="k">for</span> <span class="n">pv</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">back_stake_taken</span> <span class="k">if</span> <span class="n">pv</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">0</span><span class="p">),</span>
<a id="__codelineno-15-180" name="__codelineno-15-180" href="#__codelineno-15-180"></a>                <span class="nb">next</span><span class="p">((</span><span class="n">pv</span><span class="o">.</span><span class="n">size</span> <span class="k">for</span> <span class="n">pv</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">lay_liability_taken</span> <span class="k">if</span> <span class="n">pv</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>  <span class="o">/</span> <span class="p">((</span><span class="n">r</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">actual_sp</span> <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">actual_sp</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">actual_sp</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-15-181" name="__codelineno-15-181" href="#__codelineno-15-181"></a>            <span class="p">)</span> <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">actual_sp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-15-182" name="__codelineno-15-182" href="#__codelineno-15-182"></a>        <span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">postplay_market</span><span class="o">.</span><span class="n">runners</span> <span class="p">]</span>
<a id="__codelineno-15-183" name="__codelineno-15-183" href="#__codelineno-15-183"></a>
<a id="__codelineno-15-184" name="__codelineno-15-184" href="#__codelineno-15-184"></a>        <span class="c1"># generic runner data</span>
<a id="__codelineno-15-185" name="__codelineno-15-185" href="#__codelineno-15-185"></a>        <span class="n">runner_data</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-15-186" name="__codelineno-15-186" href="#__codelineno-15-186"></a>            <span class="p">{</span>
<a id="__codelineno-15-187" name="__codelineno-15-187" href="#__codelineno-15-187"></a>                <span class="s1">&#39;selection_id&#39;</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">selection_id</span><span class="p">,</span>
<a id="__codelineno-15-188" name="__codelineno-15-188" href="#__codelineno-15-188"></a>                <span class="s1">&#39;selection_name&#39;</span><span class="p">:</span> <span class="nb">next</span><span class="p">((</span><span class="n">rd</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">rd</span> <span class="ow">in</span> <span class="n">final_market</span><span class="o">.</span><span class="n">market_definition</span><span class="o">.</span><span class="n">runners</span> <span class="k">if</span> <span class="n">rd</span><span class="o">.</span><span class="n">selection_id</span> <span class="o">==</span> <span class="n">r</span><span class="o">.</span><span class="n">selection_id</span><span class="p">),</span> <span class="kc">None</span><span class="p">),</span>
<a id="__codelineno-15-189" name="__codelineno-15-189" href="#__codelineno-15-189"></a>                <span class="s1">&#39;selection_status&#39;</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
<a id="__codelineno-15-190" name="__codelineno-15-190" href="#__codelineno-15-190"></a>                <span class="s1">&#39;sp&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">actual_sp</span><span class="p">),</span>
<a id="__codelineno-15-191" name="__codelineno-15-191" href="#__codelineno-15-191"></a>            <span class="p">}</span>
<a id="__codelineno-15-192" name="__codelineno-15-192" href="#__codelineno-15-192"></a>            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">final_market</span><span class="o">.</span><span class="n">runners</span> 
<a id="__codelineno-15-193" name="__codelineno-15-193" href="#__codelineno-15-193"></a>        <span class="p">]</span>
<a id="__codelineno-15-194" name="__codelineno-15-194" href="#__codelineno-15-194"></a>
<a id="__codelineno-15-195" name="__codelineno-15-195" href="#__codelineno-15-195"></a>        <span class="c1"># runner price data for markets that go in play</span>
<a id="__codelineno-15-196" name="__codelineno-15-196" href="#__codelineno-15-196"></a>        <span class="k">if</span> <span class="n">preplay_traded</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-15-197" name="__codelineno-15-197" href="#__codelineno-15-197"></a>            <span class="k">def</span> <span class="nf">runner_vals</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
<a id="__codelineno-15-198" name="__codelineno-15-198" href="#__codelineno-15-198"></a>                <span class="p">(</span><span class="n">pre_ltp</span><span class="p">,</span> <span class="n">pre_traded</span><span class="p">),</span> <span class="p">(</span><span class="n">post_ltp</span><span class="p">,</span> <span class="n">post_traded</span><span class="p">,</span> <span class="n">sp_traded</span><span class="p">)</span> <span class="o">=</span> <span class="n">r</span>
<a id="__codelineno-15-199" name="__codelineno-15-199" href="#__codelineno-15-199"></a>
<a id="__codelineno-15-200" name="__codelineno-15-200" href="#__codelineno-15-200"></a>                <span class="n">inplay_only</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">ps</span><span class="p">:</span> <span class="n">ps</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="p">[</span>
<a id="__codelineno-15-201" name="__codelineno-15-201" href="#__codelineno-15-201"></a>                    <span class="n">PriceSize</span><span class="p">(</span>
<a id="__codelineno-15-202" name="__codelineno-15-202" href="#__codelineno-15-202"></a>                        <span class="n">price</span><span class="o">=</span><span class="n">post_ps</span><span class="o">.</span><span class="n">price</span><span class="p">,</span> 
<a id="__codelineno-15-203" name="__codelineno-15-203" href="#__codelineno-15-203"></a>                        <span class="n">size</span><span class="o">=</span><span class="n">post_ps</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="nb">next</span><span class="p">((</span><span class="n">pre_ps</span><span class="o">.</span><span class="n">size</span> <span class="k">for</span> <span class="n">pre_ps</span> <span class="ow">in</span> <span class="n">pre_traded</span> <span class="k">if</span> <span class="n">pre_ps</span><span class="o">.</span><span class="n">price</span> <span class="o">==</span> <span class="n">post_ps</span><span class="o">.</span><span class="n">price</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-15-204" name="__codelineno-15-204" href="#__codelineno-15-204"></a>                    <span class="p">)</span>
<a id="__codelineno-15-205" name="__codelineno-15-205" href="#__codelineno-15-205"></a>                    <span class="k">for</span> <span class="n">post_ps</span> <span class="ow">in</span> <span class="n">post_traded</span> 
<a id="__codelineno-15-206" name="__codelineno-15-206" href="#__codelineno-15-206"></a>                <span class="p">]))</span>
<a id="__codelineno-15-207" name="__codelineno-15-207" href="#__codelineno-15-207"></a>
<a id="__codelineno-15-208" name="__codelineno-15-208" href="#__codelineno-15-208"></a>                <span class="p">(</span><span class="n">ip_wavg</span><span class="p">,</span> <span class="n">ip_matched</span><span class="p">,</span> <span class="n">ip_min</span><span class="p">,</span> <span class="n">ip_max</span><span class="p">)</span> <span class="o">=</span> <span class="n">parse_traded</span><span class="p">(</span><span class="n">inplay_only</span><span class="p">)</span>
<a id="__codelineno-15-209" name="__codelineno-15-209" href="#__codelineno-15-209"></a>                <span class="p">(</span><span class="n">pre_wavg</span><span class="p">,</span> <span class="n">pre_matched</span><span class="p">,</span> <span class="n">pre_min</span><span class="p">,</span> <span class="n">pre_max</span><span class="p">)</span> <span class="o">=</span> <span class="n">parse_traded</span><span class="p">(</span><span class="n">pre_traded</span><span class="p">)</span>
<a id="__codelineno-15-210" name="__codelineno-15-210" href="#__codelineno-15-210"></a>
<a id="__codelineno-15-211" name="__codelineno-15-211" href="#__codelineno-15-211"></a>                <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-15-212" name="__codelineno-15-212" href="#__codelineno-15-212"></a>                    <span class="s1">&#39;preplay_ltp&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">pre_ltp</span><span class="p">),</span>
<a id="__codelineno-15-213" name="__codelineno-15-213" href="#__codelineno-15-213"></a>                    <span class="s1">&#39;preplay_min&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">pre_min</span><span class="p">),</span>
<a id="__codelineno-15-214" name="__codelineno-15-214" href="#__codelineno-15-214"></a>                    <span class="s1">&#39;preplay_max&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">pre_max</span><span class="p">),</span>
<a id="__codelineno-15-215" name="__codelineno-15-215" href="#__codelineno-15-215"></a>                    <span class="s1">&#39;preplay_wavg&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">pre_wavg</span><span class="p">),</span>
<a id="__codelineno-15-216" name="__codelineno-15-216" href="#__codelineno-15-216"></a>                    <span class="s1">&#39;preplay_matched&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">((</span><span class="n">pre_matched</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">sp_traded</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)),</span>
<a id="__codelineno-15-217" name="__codelineno-15-217" href="#__codelineno-15-217"></a>                    <span class="s1">&#39;inplay_ltp&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">post_ltp</span><span class="p">),</span>
<a id="__codelineno-15-218" name="__codelineno-15-218" href="#__codelineno-15-218"></a>                    <span class="s1">&#39;inplay_min&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">ip_min</span><span class="p">),</span>
<a id="__codelineno-15-219" name="__codelineno-15-219" href="#__codelineno-15-219"></a>                    <span class="s1">&#39;inplay_max&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">ip_max</span><span class="p">),</span>
<a id="__codelineno-15-220" name="__codelineno-15-220" href="#__codelineno-15-220"></a>                    <span class="s1">&#39;inplay_wavg&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">ip_wavg</span><span class="p">),</span>
<a id="__codelineno-15-221" name="__codelineno-15-221" href="#__codelineno-15-221"></a>                    <span class="s1">&#39;inplay_matched&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">ip_matched</span><span class="p">),</span>
<a id="__codelineno-15-222" name="__codelineno-15-222" href="#__codelineno-15-222"></a>                <span class="p">}</span>
<a id="__codelineno-15-223" name="__codelineno-15-223" href="#__codelineno-15-223"></a>
<a id="__codelineno-15-224" name="__codelineno-15-224" href="#__codelineno-15-224"></a>            <span class="n">runner_traded</span> <span class="o">=</span> <span class="p">[</span> <span class="n">runner_vals</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">zip_longest</span><span class="p">(</span><span class="n">preplay_traded</span><span class="p">,</span> <span class="n">postplay_traded</span><span class="p">,</span> <span class="n">fillvalue</span><span class="o">=</span><span class="n">PriceSize</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">]</span>
<a id="__codelineno-15-225" name="__codelineno-15-225" href="#__codelineno-15-225"></a>
<a id="__codelineno-15-226" name="__codelineno-15-226" href="#__codelineno-15-226"></a>        <span class="c1"># runner price data for markets that don&#39;t go in play</span>
<a id="__codelineno-15-227" name="__codelineno-15-227" href="#__codelineno-15-227"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-15-228" name="__codelineno-15-228" href="#__codelineno-15-228"></a>            <span class="k">def</span> <span class="nf">runner_vals</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
<a id="__codelineno-15-229" name="__codelineno-15-229" href="#__codelineno-15-229"></a>                <span class="p">(</span><span class="n">ltp</span><span class="p">,</span> <span class="n">traded</span><span class="p">,</span> <span class="n">sp_traded</span><span class="p">)</span> <span class="o">=</span> <span class="n">r</span>
<a id="__codelineno-15-230" name="__codelineno-15-230" href="#__codelineno-15-230"></a>                <span class="p">(</span><span class="n">wavg</span><span class="p">,</span> <span class="n">matched</span><span class="p">,</span> <span class="n">min_price</span><span class="p">,</span> <span class="n">max_price</span><span class="p">)</span> <span class="o">=</span> <span class="n">parse_traded</span><span class="p">(</span><span class="n">traded</span><span class="p">)</span>
<a id="__codelineno-15-231" name="__codelineno-15-231" href="#__codelineno-15-231"></a>
<a id="__codelineno-15-232" name="__codelineno-15-232" href="#__codelineno-15-232"></a>                <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-15-233" name="__codelineno-15-233" href="#__codelineno-15-233"></a>                    <span class="s1">&#39;preplay_ltp&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">ltp</span><span class="p">),</span>
<a id="__codelineno-15-234" name="__codelineno-15-234" href="#__codelineno-15-234"></a>                    <span class="s1">&#39;preplay_min&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">min_price</span><span class="p">),</span>
<a id="__codelineno-15-235" name="__codelineno-15-235" href="#__codelineno-15-235"></a>                    <span class="s1">&#39;preplay_max&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">max_price</span><span class="p">),</span>
<a id="__codelineno-15-236" name="__codelineno-15-236" href="#__codelineno-15-236"></a>                    <span class="s1">&#39;preplay_wavg&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">wavg</span><span class="p">),</span>
<a id="__codelineno-15-237" name="__codelineno-15-237" href="#__codelineno-15-237"></a>                    <span class="s1">&#39;preplay_matched&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">((</span><span class="n">matched</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">sp_traded</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)),</span>
<a id="__codelineno-15-238" name="__codelineno-15-238" href="#__codelineno-15-238"></a>                    <span class="s1">&#39;inplay_ltp&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
<a id="__codelineno-15-239" name="__codelineno-15-239" href="#__codelineno-15-239"></a>                    <span class="s1">&#39;inplay_min&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
<a id="__codelineno-15-240" name="__codelineno-15-240" href="#__codelineno-15-240"></a>                    <span class="s1">&#39;inplay_max&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
<a id="__codelineno-15-241" name="__codelineno-15-241" href="#__codelineno-15-241"></a>                    <span class="s1">&#39;inplay_wavg&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
<a id="__codelineno-15-242" name="__codelineno-15-242" href="#__codelineno-15-242"></a>                    <span class="s1">&#39;inplay_matched&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
<a id="__codelineno-15-243" name="__codelineno-15-243" href="#__codelineno-15-243"></a>                <span class="p">}</span>
<a id="__codelineno-15-244" name="__codelineno-15-244" href="#__codelineno-15-244"></a>
<a id="__codelineno-15-245" name="__codelineno-15-245" href="#__codelineno-15-245"></a>            <span class="n">runner_traded</span> <span class="o">=</span> <span class="p">[</span> <span class="n">runner_vals</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">postplay_traded</span> <span class="p">]</span>
<a id="__codelineno-15-246" name="__codelineno-15-246" href="#__codelineno-15-246"></a>
<a id="__codelineno-15-247" name="__codelineno-15-247" href="#__codelineno-15-247"></a>        <span class="c1"># printing to csv for each runner</span>
<a id="__codelineno-15-248" name="__codelineno-15-248" href="#__codelineno-15-248"></a>        <span class="k">for</span> <span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="n">rprices</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">runner_data</span><span class="p">,</span> <span class="n">runner_traded</span><span class="p">):</span>
<a id="__codelineno-15-249" name="__codelineno-15-249" href="#__codelineno-15-249"></a>            <span class="c1"># defining data to go in each column</span>
<a id="__codelineno-15-250" name="__codelineno-15-250" href="#__codelineno-15-250"></a>            <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
<a id="__codelineno-15-251" name="__codelineno-15-251" href="#__codelineno-15-251"></a>                <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
<a id="__codelineno-15-252" name="__codelineno-15-252" href="#__codelineno-15-252"></a>                    <span class="n">postplay_market</span><span class="o">.</span><span class="n">market_id</span><span class="p">,</span>
<a id="__codelineno-15-253" name="__codelineno-15-253" href="#__codelineno-15-253"></a>                    <span class="n">postplay_market</span><span class="o">.</span><span class="n">market_definition</span><span class="o">.</span><span class="n">market_time</span><span class="p">,</span>
<a id="__codelineno-15-254" name="__codelineno-15-254" href="#__codelineno-15-254"></a>                    <span class="n">postplay_market</span><span class="o">.</span><span class="n">market_definition</span><span class="o">.</span><span class="n">country_code</span><span class="p">,</span>
<a id="__codelineno-15-255" name="__codelineno-15-255" href="#__codelineno-15-255"></a>                    <span class="n">postplay_market</span><span class="o">.</span><span class="n">market_definition</span><span class="o">.</span><span class="n">venue</span><span class="p">,</span>
<a id="__codelineno-15-256" name="__codelineno-15-256" href="#__codelineno-15-256"></a>                    <span class="n">postplay_market</span><span class="o">.</span><span class="n">market_definition</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-15-257" name="__codelineno-15-257" href="#__codelineno-15-257"></a>                    <span class="n">rdata</span><span class="p">[</span><span class="s1">&#39;selection_id&#39;</span><span class="p">],</span>
<a id="__codelineno-15-258" name="__codelineno-15-258" href="#__codelineno-15-258"></a>                    <span class="n">rdata</span><span class="p">[</span><span class="s1">&#39;selection_name&#39;</span><span class="p">],</span>
<a id="__codelineno-15-259" name="__codelineno-15-259" href="#__codelineno-15-259"></a>                    <span class="n">rdata</span><span class="p">[</span><span class="s1">&#39;selection_status&#39;</span><span class="p">],</span>
<a id="__codelineno-15-260" name="__codelineno-15-260" href="#__codelineno-15-260"></a>                    <span class="n">rdata</span><span class="p">[</span><span class="s1">&#39;sp&#39;</span><span class="p">],</span>
<a id="__codelineno-15-261" name="__codelineno-15-261" href="#__codelineno-15-261"></a>                    <span class="n">rprices</span><span class="p">[</span><span class="s1">&#39;preplay_min&#39;</span><span class="p">],</span>
<a id="__codelineno-15-262" name="__codelineno-15-262" href="#__codelineno-15-262"></a>                    <span class="n">rprices</span><span class="p">[</span><span class="s1">&#39;preplay_max&#39;</span><span class="p">],</span>
<a id="__codelineno-15-263" name="__codelineno-15-263" href="#__codelineno-15-263"></a>                    <span class="n">rprices</span><span class="p">[</span><span class="s1">&#39;preplay_wavg&#39;</span><span class="p">],</span>
<a id="__codelineno-15-264" name="__codelineno-15-264" href="#__codelineno-15-264"></a>                    <span class="n">rprices</span><span class="p">[</span><span class="s1">&#39;preplay_ltp&#39;</span><span class="p">],</span>
<a id="__codelineno-15-265" name="__codelineno-15-265" href="#__codelineno-15-265"></a>                    <span class="n">rprices</span><span class="p">[</span><span class="s1">&#39;preplay_matched&#39;</span><span class="p">],</span>
<a id="__codelineno-15-266" name="__codelineno-15-266" href="#__codelineno-15-266"></a>                    <span class="n">rprices</span><span class="p">[</span><span class="s1">&#39;inplay_min&#39;</span><span class="p">],</span>
<a id="__codelineno-15-267" name="__codelineno-15-267" href="#__codelineno-15-267"></a>                    <span class="n">rprices</span><span class="p">[</span><span class="s1">&#39;inplay_max&#39;</span><span class="p">],</span>
<a id="__codelineno-15-268" name="__codelineno-15-268" href="#__codelineno-15-268"></a>                    <span class="n">rprices</span><span class="p">[</span><span class="s1">&#39;inplay_wavg&#39;</span><span class="p">],</span>
<a id="__codelineno-15-269" name="__codelineno-15-269" href="#__codelineno-15-269"></a>                    <span class="n">rprices</span><span class="p">[</span><span class="s1">&#39;inplay_ltp&#39;</span><span class="p">],</span>
<a id="__codelineno-15-270" name="__codelineno-15-270" href="#__codelineno-15-270"></a>                    <span class="n">rprices</span><span class="p">[</span><span class="s1">&#39;inplay_matched&#39;</span><span class="p">],</span>
<a id="__codelineno-15-271" name="__codelineno-15-271" href="#__codelineno-15-271"></a>                <span class="p">)</span>
<a id="__codelineno-15-272" name="__codelineno-15-272" href="#__codelineno-15-272"></a>            <span class="p">)</span>
</code></pre></div>
<hr />
<h3 id="disclaimer">Disclaimer</h3>
<p>Note that whilst models and automated strategies are fun and rewarding to create, we can't promise that your model or betting strategy will be profitable, and we make no representations in relation to the code shared or information on this page. If you're using this code or implementing your own strategies, you do so entirely at your own risk and you are responsible for any winnings/losses incurred. Under no circumstances will Betfair be liable for any loss or damage you suffer.</p>


  




                
              </article>
            </div>
          
          
        </div>
        
          <a href="#" class="md-top md-icon" data-md-component="top" hidden>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
            Back to top
          </a>
        
      </main>
      
        <footer class="md-footer">
    
    <div class="md-footer-meta md-typeset">
      <div class="md-footer-meta__inner md-grid">
        <div class="md-copyright">
  
  
</div>
        
          <div class="md-social">
  
    
    
      
      
    
    <a href="https://twitter.com/Betfair_Aus" target="_blank" rel="noopener" title="twitter.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
    </a>
  
    
    
      
      
    
    <a href="https://linkedin.com/company/betfair-australia" target="_blank" rel="noopener" title="linkedin.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg>
    </a>
  
    
    
      
      
    
    <a href="https://facebook.com/betfairaustralia" target="_blank" rel="noopener" title="facebook.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M504 256C504 119 393 8 256 8S8 119 8 256c0 123.78 90.69 226.38 209.25 245V327.69h-63V256h63v-54.64c0-62.15 37-96.48 93.67-96.48 27.14 0 55.52 4.84 55.52 4.84v61h-31.28c-30.8 0-40.41 19.12-40.41 38.73V256h68.78l-11 71.69h-57.78V501C413.31 482.38 504 379.78 504 256z"/></svg>
    </a>
  
    
    
      
      
    
    <a href="https://youtube.com/user/betfairaus" target="_blank" rel="noopener" title="youtube.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M549.655 124.083c-6.281-23.65-24.787-42.276-48.284-48.597C458.781 64 288 64 288 64S117.22 64 74.629 75.486c-23.497 6.322-42.003 24.947-48.284 48.597-11.412 42.867-11.412 132.305-11.412 132.305s0 89.438 11.412 132.305c6.281 23.65 24.787 41.5 48.284 47.821C117.22 448 288 448 288 448s170.78 0 213.371-11.486c23.497-6.321 42.003-24.171 48.284-47.821 11.412-42.867 11.412-132.305 11.412-132.305s0-89.438-11.412-132.305zm-317.51 213.508V175.185l142.739 81.205-142.739 81.201z"/></svg>
    </a>
  
    
    
      
      
    
    <a href="https://github.com/betfair-datascientists" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
</div>
        
      </div>

      <div class="bf-footer">
          <div class="bf-footer-inner">
              <p class="bf-light">Betfair Pty Limited is licensed and regulated by the Northern Territory Government of Australia.</p>
              <p class="bf-dark">Betfair Pty Limited's gambling operations are governed by its <a class='inner-link' href="https://www.betfair.com.au/info/responsible-gambling/">Responsible Gambling Code of Conduct</a> and for South
              Australian residents by the <a class='inner-link' href="https://www.betfair.com.au/info/pdf/SA-GCoP.pdf">South Australian Responsible Gambling Code of Practice.</a></p>
              <p class="bf-dark">BetStop is the Australian National Self-Exclusion Register. For more information, please visit <a class="inner-link" href="https://betstop.gov.au">https://betstop.gov.au</a><br /> <div class="full-screen"> <p style="font-family: Arial, sans-serif; font-size: 1.2rem; font-weight: bold;text-align: center;">Imagine what you could be buying instead</p> <p style="font-family: Arial, sans-serif; font-size: 0.8rem; font-weight: bold;text-align: center;">For free and confidential support call 1800 858 858 or visit <a href="http://www.gamblinghelponline.org.au" style="color: black; text-decoration: underline;">www.gamblinghelponline.org.au</a></p> </div> </p>
              <ul class="bf-links">
                <li><a href="https://www.betfair.com.au/hub/help/account-help/responsible-gambling/">Responsible Gambling</a><span>|</span></li>
                <li><a href="http://www.betfair.com/AUS_NZL/aboutUs/Terms.and.Conditions/">Terms & Conditions</a><span>|</span></li>
                <li><a href="https://www.betfair.com.au/info/privacy-policy/">Privacy Policy</a><span>|</span></li>
                <li><a href="http://www.betfair.com/en/aboutUs/Rules.and.Regulations/">Rules & Regulations</a><span>|</span></li>
                <li><a href="https://www.betfair.com/AUS_NZL/aboutUs/Dispute.Resolution">Dispute Resolution</a></li>
              </ul>
          </div>
      </div>
    </div>

    <script src="https://js.adsrvr.org/up_loader.1.1.0.js" type="text/javascript"></script>
    <script type="text/javascript">
        ttd_dom_ready( function() {
            if (typeof TTDUniversalPixelApi === 'function') {
                var universalPixelApi = new TTDUniversalPixelApi();
                universalPixelApi.init("y12d1ir", ["8ml4f17"], "https://insight.adsrvr.org/track/up");
            }
        });
    </script>

</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["toc.integrate", "navigation.instant", "navigation.tabs", "navigation.top", "navigation.expand", "navigation.sections", "search.suggest", "search.highlight", "search.share"], "search": "../../assets/javascripts/workers/search.16e2a7d4.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.8492ddcf.min.js"></script>
      
        <script src="../../js/scripts.js"></script>
      
    
  </body>
</html>