
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Documentation, guides and articles on creating, developing and implementing automated betting strategies, using data analysis to inform betting models and how to interact with the Betfair API.">
      
      
        <meta name="author" content="Betfair Data Scientists">
      
      
        <link rel="canonical" href="https://betfair-datascientists.github.io/tutorials/processingTarFiles101/">
      
      
        <link rel="prev" href="../How_to_Automate_5/">
      
      
        <link rel="next" href="../jsonToCsvRevisited/">
      
      
      <link rel="icon" href="../../img/BetfairFavicon.ico">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.6">
    
    
      
        <title>Take away the pain! Processing TAR Files 101 - The Automation Hub</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.50c56a3b.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/betfair.css">
    
      <link rel="stylesheet" href="../../css/buttons_and_animations.css">
    
      <link rel="stylesheet" href="../../css/fonts.css">
    
      <link rel="stylesheet" href="../../css/ansi-colours.css">
    
      <link rel="stylesheet" href="../../css/jupyter-cells.css">
    
      <link rel="stylesheet" href="../../css/pandas-dataframe.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function n(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],n("js",new Date),n("config","UA-125973915-1"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&n("event","search",{search_term:this.value})}),document$.subscribe(function(){var a=document.forms.feedback;if(void 0!==a)for(var e of a.querySelectorAll("[type=submit]"))e.addEventListener("click",function(e){e.preventDefault();var t=document.location.pathname,e=this.getAttribute("data-md-value");n("event","feedback",{page:t,data:e}),a.firstElementChild.disabled=!0;e=a.querySelector(".md-feedback__note [data-md-value='"+e+"']");e&&(e.hidden=!1)}),a.hidden=!1}),location$.subscribe(function(e){n("config","UA-125973915-1",{page_path:e.pathname})})});var e=document.createElement("script");e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id=UA-125973915-1",document.getElementById("__analytics").insertAdjacentElement("afterEnd",e)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="betfair" data-md-color-primary="amber" data-md-color-accent="orange">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#take-away-the-pain-processing-tar-files-101" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      
  
  <header class="md-header" data-md-component="header">
    <nav class="md-header__inner md-grid" aria-label="header.title">
      <a href="../.." title="The Automation Hub" class="md-header__button md-logo" aria-label="The Automation Hub" data-md-component="logo">
        
  <img src="../../img/logo.svg" alt="logo">

      </a>
      <label class="md-header__button md-icon" for="__drawer">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
      </label>
      <div class="md-header__title" data-md-component="header-title">
        <div class="md-header__ellipsis">
          <div class="md-header__topic">
            <span class="md-ellipsis">
              The Automation Hub
            </span>
          </div>
          <div class="md-header__topic" data-md-component="header-topic">
            <span class="md-ellipsis">
              
                Take away the pain! Processing TAR Files 101
              
            </span>
          </div>
        </div>
      </div>

      
        <form class="md-header__option" data-md-component="palette">
          
            
            
            <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="betfair" data-md-color-primary="amber" data-md-color-accent="orange"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
            
              <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3 3.19.09m3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95 2.06.05m-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31Z"/></svg>
              </label>
            
          
            
            
            <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="amber" data-md-color-accent="orange"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
            
              <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5c-.84 0-1.65.15-2.39.42L12 2M3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29L3.34 7m.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14L3.36 17M20.65 7l-1.77 3.79a7.023 7.023 0 0 0-2.38-4.15l4.15.36m-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29L20.64 17M12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44L12 22Z"/></svg>
              </label>
            
          
        </form>
      
      

      
     
      <div class="bf-nav">
        <a class="bf-hidable" href="https://www.betfair.com.au/exchange/plus/"><svg class="exchangeLogo" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:cc="http://creativecommons.org/ns#"
          xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 38.775 4.59" width="24" height="17">
          <path class="st1" d="m 160.3,-136.95 v 26" />
          <g transform="translate(18.8,-137.15)">
            <path d="m 2.2901089,126.53441 v 5.20093 H -3.3107216 L 7.4888397,144.33446 18.2884,131.73534 h -5.598633 v -5.20093 z m -8.6000974,8.10132 -10.8017585,12.59913 h 5.60083 v 5.2998 h 10.3996581 v -5.2998 h 5.6008306 z" />
          </g>
        </svg><span> Exchange</span></a>
        <a href="https://www.betfair.com.au/hub/">Hub</a>
      </div>

      

    </nav>
    
  </header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../data/dataListing/" class="md-tabs__link">
          
  
  Data

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../wagering/betfairHowTo/" class="md-tabs__link">
          
  
  Wagering

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../api/apiResources/" class="md-tabs__link">
          
  
  API

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../modelling/greyhoundDatathon/" class="md-tabs__link">
          
  
  Modelling

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../automation/GoldenRulesofAutomation/" class="md-tabs__link">
          
  
  Automation

        </a>
      </li>
    
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../How_to_Automate_1/" class="md-tabs__link">
          
  
  Tutorials

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../mentalGame/intro/" class="md-tabs__link">
          
  
  Mental Game

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../contactUs/test/" class="md-tabs__link">
          
  
  Contact Us

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="The Automation Hub" class="md-nav__button md-logo" aria-label="The Automation Hub" data-md-component="logo">
      
  <img src="../../img/logo.svg" alt="logo">

    </a>
    The Automation Hub
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Data
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Data
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../data/dataListing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CSV Files
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Wagering
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Wagering
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../wagering/betfairHowTo/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Betfair How-To
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../wagering/bettingGlossary/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Betting Glossary
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../wagering/stakingMethods/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Staking Methods and Bankroll Management
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../wagering/valueAndOdds/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Value and Odds
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../wagering/commission/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Commission and other charges
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../wagering/hubPredictionsModel/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Hub Predictions Model
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../wagering/exactaQuinella/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Exactas & Quinella
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  <span class="md-ellipsis">
    API
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            API
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/apiResources/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    API resources
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/apiappkey/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to access the Betfair API
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/apiRtutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    API tutorial in R
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/apiPythontutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    API tutorial in Python
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Modelling
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Modelling
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/greyhoundDatathon/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Greyhound Racing Datathon
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/howToModel/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Intro to modelling
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/dataSources/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Pricing Data Sources
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/cloudOrLocalMachine/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Cloud or Local
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_5" >
        
          
          <label class="md-nav__link" for="__nav_5_5" id="__nav_5_5_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Racing
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_5">
            <span class="md-nav__icon md-icon"></span>
            Racing
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/topazTutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Greyhound Topaz API Tutorial (New)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/fasttrackTutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Greyhound form FastTrack API (Old)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/greyhoundModellingPython/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Greyhound modelling in Python (Old)
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_6" >
        
          
          <label class="md-nav__link" for="__nav_5_6" id="__nav_5_6_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Soccer
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_6">
            <span class="md-nav__icon md-icon"></span>
            Soccer
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/soccerModellingELO2022WorldCup/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Soccer modelling tutorial in R for 2022 FIFA World Cup
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/soccerModellingTutorialPython/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Soccer modelling tutorial in Python
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/EPLmlPython/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    EPL ML walk through in Python
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_7" >
        
          
          <label class="md-nav__link" for="__nav_5_7" id="__nav_5_7_label" tabindex="">
            
  
  <span class="md-ellipsis">
    AFL
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_7">
            <span class="md-nav__icon md-icon"></span>
            AFL
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/AFLPlayerDisposalsTutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Player Disposal Lines
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/AFLmodellingPython/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    AFL modelling walk through in Python
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/brownlowModelTutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Modelling the Brownlow Medal in Python
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_8" >
        
          
          <label class="md-nav__link" for="__nav_5_8" id="__nav_5_8_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Tennis
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_8">
            <span class="md-nav__icon md-icon"></span>
            Tennis
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/howToModelTheAusOpen/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to model the Australian Open
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/AusOpenRTutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Aus Open R Tutorial
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/AusOpenPythonTutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Aus Open Python Tutorial
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Automation
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Automation
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/GoldenRulesofAutomation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Golden rules of automation
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/overview/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Tools Overview
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6_3" >
        
          
          <label class="md-nav__link" for="__nav_6_3" id="__nav_6_3_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Bet Angel
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_3">
            <span class="md-nav__icon md-icon"></span>
            Bet Angel
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/betAngel/betAngel/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Overview
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/betAngelbeginners/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Beginner's guide
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/betAngelintermediate/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Intermediate guide
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/betAngeladvanced/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Advanced guide
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/betAngelRatingsAutomation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Ratings auto
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/betAngelMarketFavouriteAutomation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Market fav auto
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/betAngelTippingAutomation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Tipping auto
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/betAngelSimultaneousMarkets/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Simultaneous markets
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/betAngelKellyStake/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Kelly criterion staking
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6_4" >
        
          
          <label class="md-nav__link" for="__nav_6_4" id="__nav_6_4_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Gruss Betting Assistant
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_4">
            <span class="md-nav__icon md-icon"></span>
            Gruss Betting Assistant
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/Gruss/Gruss/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Overview
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/GrussSettingupbasicmarketview/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Setup basic market view and one click betting
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/grussRatingsAutomation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Ratings auto
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/grussMarketFavouriteAutomation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Market fav auto
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/grusslSimultaneousMarkets/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Simultaneous markets
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/grussKellyStake/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Kelly criterion staking
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6_5" >
        
          
          <label class="md-nav__link" for="__nav_6_5" id="__nav_6_5_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Cymatic Trader
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_5">
            <span class="md-nav__icon md-icon"></span>
            Cymatic Trader
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/CymaticTrader/CymaticTrader/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Overview
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/cymaticTraderRatingsAutomation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Ratings auto
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6_6" >
        
          
          <label class="md-nav__link" for="__nav_6_6" id="__nav_6_6_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Geeks Toy
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_6">
            <span class="md-nav__icon md-icon"></span>
            Geeks Toy
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/GeeksToyinstallationandsetup/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Installation and setup
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/GeeksToybasicmarketviewstakingandoneclickbetting/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Setup basic market view and one click betting
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/geeksToyRefreshSettings/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Optimising refresh settings
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6_7" >
        
          
          <label class="md-nav__link" for="__nav_6_7" id="__nav_6_7_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Bet Jet Pro
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_7">
            <span class="md-nav__icon md-icon"></span>
            Bet Jet Pro
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/betJetOverview/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Overview
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" checked>
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Tutorials
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            Tutorials
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../How_to_Automate_1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to Automate 1
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../How_to_Automate_2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to Automate 2
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../How_to_Automate_3/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to Automate 3
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../How_to_Automate_4/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to Automate 4
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../How_to_Automate_5/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to Automate 5
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Take away the pain! Processing TAR Files 101
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Take away the pain! Processing TAR Files 101
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#cheat-sheet" class="md-nav__link">
    <span class="md-ellipsis">
      Cheat sheet
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#10-setup" class="md-nav__link">
    <span class="md-ellipsis">
      1.0 Setup
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1.0 Setup">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#11-importing-libraries" class="md-nav__link">
    <span class="md-ellipsis">
      1.1 Importing libraries
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#12-picking-our-intervals" class="md-nav__link">
    <span class="md-ellipsis">
      1.2 Picking our intervals
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#13-filtering-the-markets" class="md-nav__link">
    <span class="md-ellipsis">
      1.3 Filtering the markets
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#14-utility-functions" class="md-nav__link">
    <span class="md-ellipsis">
      1.4 Utility Functions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#15-parsing-timestamped-prices" class="md-nav__link">
    <span class="md-ellipsis">
      1.5 Parsing Timestamped Prices
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#16-the-good-stuff" class="md-nav__link">
    <span class="md-ellipsis">
      1.6 The Good Stuff
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#17-clean-up" class="md-nav__link">
    <span class="md-ellipsis">
      1.7 Clean-Up
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#18-conclusion-and-next-steps" class="md-nav__link">
    <span class="md-ellipsis">
      1.8 Conclusion and Next Steps
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#20-complete-code" class="md-nav__link">
    <span class="md-ellipsis">
      2.0 Complete Code
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2.0 Complete Code">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21-complete-code-racing-processor" class="md-nav__link">
    <span class="md-ellipsis">
      2.1 Complete Code Racing Processor
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22-complete-code-sports-processor" class="md-nav__link">
    <span class="md-ellipsis">
      2.2 Complete Code Sports Processor
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#disclaimer" class="md-nav__link">
    <span class="md-ellipsis">
      Disclaimer
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../jsonToCsvRevisited/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    JSON to CSV | Revisited
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../backtestingRatingsTutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Back testing ratings in Python
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../automatedBettingAnglesTutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Automated betting angles in Python
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../analysingAndPredictingMarketMovements/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Do they know? Analysing Betfair market formation & market movements
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../analysingAndPredictingBSP/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Wisdom of the crowd? Analysing & understanding BSP
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_8" >
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Mental Game
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            Mental Game
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/intro/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Intro
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/roleOfEmotions/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Part 1
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/mapYourEmotions/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Part 2
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/handlingBadVariance/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Part 3
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/winbyBeingGreatatLosing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Part 4
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/correctingyouremotions/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Part 5
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/responsibleGambling/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Part 6
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/InchwormConcept/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Part 7
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/HighExpectations/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Part 8
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/TappingYourIntuition/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Part 9
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_9" >
        
          
          <label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Contact Us
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9">
            <span class="md-nav__icon md-icon"></span>
            Contact Us
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../contactUs/test/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Meet the Team
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script>
(function() {
  function addWidgetsRenderer() {
    var requireJsScript = document.createElement('script');
    requireJsScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js';

    var mimeElement = document.querySelector('script[type="application/vnd.jupyter.widget-view+json"]');
    var jupyterWidgetsScript = document.createElement('script');
    var widgetRendererSrc = 'https://unpkg.com/@jupyter-widgets/html-manager@*/dist/embed-amd.js';
    var widgetState;

    // Fallback for older version:
    try {
      widgetState = mimeElement && JSON.parse(mimeElement.innerHTML);

      if (widgetState && (widgetState.version_major < 2 || !widgetState.version_major)) {
        widgetRendererSrc = 'jupyter-js-widgets@*/dist/embed.js';
      }
    } catch(e) {}

    jupyterWidgetsScript.src = widgetRendererSrc;

    document.body.appendChild(requireJsScript);
    document.body.appendChild(jupyterWidgetsScript);
  }

  document.addEventListener('DOMContentLoaded', addWidgetsRenderer);
}());
</script>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="take-away-the-pain-processing-tar-files-101">Take away the pain! Processing TAR Files 101</h1>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<hr />
<p>So even though we've got some great tutorials up here on our Automation Hub, a common wish from many an automated customer, is for a simple plug-and-play tutorial and script for parsing the PRO TAR files into CSVs. So here it is, an easy-to-follow tutorial that makes use of existing tutorials by Tom Bishop and others to easily and painlessly process these JSON files into CSVs ready to be modelled.</p>
<p>And don't worry, this tutorial has plenty of error-handling built in so (hopefully) you won't wake up in the morning to find the script failed at 1AM while you were dreaming of the final straight at Moonee Valley. </p>
<p>This tutorial will concern itself primarily with racing, however, at the bottom of the page we have also included <a href="https://betfair-datascientists.github.io/tutorials/processingTarFiles101/#22-complete-code-sports-processor">complete code</a> suited for parsing sports TAR files including handling for line/handicap markets.</p>
<p>So without further ado, let's jump into it!</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="cheat-sheet">Cheat sheet</h3>
<ul>
<li>This is presented as a Jupyter notebook as this format is interactive and lets you run snippets of code from within the notebook. To use this functionality <a href="https://github.com/betfair-down-under/autoHubTutorials/blob/master/processingTarFiles101/tar.ipynb">you'll need to download a copy of the <code>ipynb</code> file locally</a> and open it in a text editor (i.e. VS code).</li>
<li>If you're looking for the complete code <a href="https://betfair-datascientists.github.io/tutorials/processingTarFiles101/#21-complete-code-racing-processor">head to the bottom of the page</a> or <a href="https://github.com/betfair-down-under/autoHubTutorials/tree/master/processingTarFiles101">download the script from Github</a>.</li>
<li>To run the code, save it to your machine, open a command prompt, or a terminal in your text editor of choice (we're using <a href="https://code.visualstudio.com/download">VS code</a>), make sure you've navigated in the terminal to the folder you've saved the script in and then type <code>py main.py</code> (or whatever you've called your script file if not main) then hit enter. To stop the code running use Ctrl C. </li>
<li>Make sure you amend your data path to point to your data file. We'll be taking in an input of a historical tar file downloaded from the <a href="https://historicdata.betfair.com/#/help">Betfair historic data site</a>. We're using a PRO version, though the code should work on ADVANCED too. This approach won't work with the BASIC data tier. For more information on these files please reach out to us at <a href="mailto:automation@betfair.com.au">automation</a></li>
<li>We're using the betfairlightweight and betfair_data package to do the heavy lifting</li>
<li>We've also posted the completed code logic on the <a href="https://github.com/betfair-down-under/autoHubTutorials/tree/master/processingTarFiles101"><code>betfair-downunder</code> Github repo</a>.</li>
</ul>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<hr />
<h2 id="10-setup">1.0 Setup</h2>
<h3 id="11-importing-libraries">1.1 Importing libraries</h3>
<p>Once again I'll be presenting the analysis in a jupyter notebook and will be using python as a programming language.</p>
<p>You'll need <code>betfairlightweight</code> and <code>betfair_data</code> which you can install with something like <code>pip install betfairlightweight</code>.</p>
<p>NOTE: Import 'betfair_data.bflw' could not be resolved from source - This is a known issue, the script should still run</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="kn">import</span> <span class="nn">os</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="kn">import</span> <span class="nn">csv</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="kn">import</span> <span class="nn">csv</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="kn">import</span> <span class="nn">tarfile</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="kn">import</span> <span class="nn">zipfile</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="kn">import</span> <span class="nn">bz2</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="kn">import</span> <span class="nn">glob</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="kn">import</span> <span class="nn">ast</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="kn">from</span> <span class="nn">unittest.mock</span> <span class="kn">import</span> <span class="n">patch</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="kn">import</span> <span class="nn">betfairlightweight</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a><span class="kn">from</span> <span class="nn">betfairlightweight</span> <span class="kn">import</span> <span class="n">StreamListener</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a><span class="kn">from</span> <span class="nn">betfair_data</span> <span class="kn">import</span> <span class="n">bflw</span> 
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a><span class="kn">from</span> <span class="nn">betfair_data</span> <span class="kn">import</span> <span class="n">PriceSize</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a><span class="kn">import</span> <span class="nn">functools</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a><span class="kn">from</span> <span class="nn">pandas.errors</span> <span class="kn">import</span> <span class="n">SettingWithCopyWarning</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a><span class="kn">import</span> <span class="nn">warnings</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a><span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">SettingWithCopyWarning</span><span class="p">)</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a><span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">zip_longest</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a><span class="kn">from</span> <span class="nn">currency_converter</span> <span class="kn">import</span> <span class="n">CurrencyConverter</span>
</code></pre></div>

</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="12-picking-our-intervals">1.2 Picking our intervals</h3>
<p>Here we'll define our working folder and the timestamps for which we want to pull all of our data. 
We've set the script to pull prices from 10 minutes out from the jump at 30 second intervals and then at 5 second intervals from 1 minute out. Feel free to change as you need.</p>
<p>PRO TIP: copying your file path from windows explorer works really well as long as you replace the back-slashes with forward-slashes</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="n">file_directory</span><span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="c1">#INSERT FILE DIRECTORY WHERE TAR FILES ARE STORED</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="n">log1_Start</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">10</span> <span class="c1"># Seconds before scheduled off to start recording data for data segment one</span>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="n">log1_Step</span> <span class="o">=</span> <span class="mi">30</span>       <span class="c1"># Seconds between log steps for first data segment</span>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="n">log2_Start</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">1</span>  <span class="c1"># Seconds before scheduled off to start recording data for data segment two</span>
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="n">log2_Step</span> <span class="o">=</span> <span class="mi">5</span>    <span class="c1"># Seconds between log steps for second data segment</span>
</code></pre></div>

</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="13-filtering-the-markets">1.3 Filtering the markets</h3>
<p>We'll then define a market filter as well as a way to filter out the harness racing markets. The different filter variables are listed below and can be added or removed as required. Some of these aren't that useful but have been listed for the sake of completeness.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="c1"># splitting race name and returning the parts </span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="k">def</span> <span class="nf">split_anz_horse_market_name</span><span class="p">(</span><span class="n">market_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>    <span class="c1"># return race no, length, race type</span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>    <span class="c1"># input samples: </span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a>    <span class="c1"># &#39;R6 1400m Grp1&#39; -&amp;gt; (&#39;R6&#39;,&#39;1400m&#39;,&#39;grp1&#39;)</span>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a>    <span class="c1"># &#39;R1 1609m Trot M&#39; -&amp;gt; (&#39;R1&#39;, &#39;1609m&#39;, &#39;trot&#39;)</span>
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a>    <span class="c1"># &#39;R4 1660m Pace M&#39; -&amp;gt; (&#39;R4&#39;, &#39;1660m&#39;, &#39;pace&#39;)</span>
<a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a>    <span class="n">parts</span> <span class="o">=</span> <span class="n">market_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
<a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a>    <span class="n">race_no</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> 
<a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a>    <span class="n">race_len</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;m&#39;</span><span class="p">)</span>
<a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a>    <span class="n">race_len</span> <span class="o">=</span> <span class="n">race_len</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a>    <span class="n">race_type</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> 
<a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a>    <span class="k">return</span> <span class="p">(</span><span class="n">race_no</span><span class="p">,</span> <span class="n">race_len</span><span class="p">,</span> <span class="n">race_type</span><span class="p">)</span>
<a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a>
<a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a><span class="c1"># filtering markets to those that fit the following criteria</span>
<a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a><span class="k">def</span> <span class="nf">filter_market</span><span class="p">(</span><span class="n">market</span><span class="p">:</span> <span class="n">bflw</span><span class="o">.</span><span class="n">MarketBook</span><span class="p">)</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="nb">bool</span><span class="p">:</span> 
<a id="__codelineno-2-17" name="__codelineno-2-17" href="#__codelineno-2-17"></a>    <span class="n">d</span> <span class="o">=</span> <span class="n">market</span><span class="o">.</span><span class="n">market_definition</span>
<a id="__codelineno-2-18" name="__codelineno-2-18" href="#__codelineno-2-18"></a>    <span class="k">return</span> <span class="p">(</span><span class="n">d</span> <span class="o">!=</span> <span class="kc">None</span>
<a id="__codelineno-2-19" name="__codelineno-2-19" href="#__codelineno-2-19"></a>        <span class="ow">and</span> <span class="n">d</span><span class="o">.</span><span class="n">country_code</span> <span class="o">==</span> <span class="s1">&#39;AU&#39;</span> 
<a id="__codelineno-2-20" name="__codelineno-2-20" href="#__codelineno-2-20"></a>        <span class="ow">and</span> <span class="n">d</span><span class="o">.</span><span class="n">market_type</span> <span class="o">==</span> <span class="s1">&#39;WIN&#39;</span>
<a id="__codelineno-2-21" name="__codelineno-2-21" href="#__codelineno-2-21"></a>        <span class="ow">and</span> <span class="p">(</span><span class="n">c</span> <span class="o">:=</span> <span class="n">split_anz_horse_market_name</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">name</span><span class="p">)[</span><span class="mi">2</span><span class="p">])</span> <span class="o">!=</span> <span class="s1">&#39;trot&#39;</span> <span class="ow">and</span> <span class="n">c</span> <span class="o">!=</span> <span class="s1">&#39;pace&#39;</span> <span class="c1">#strips out Harness Races</span>
<a id="__codelineno-2-22" name="__codelineno-2-22" href="#__codelineno-2-22"></a>        <span class="c1">#and (c := split_anz_horse_market_name(d.name)[2]) == &#39;hcap&#39;#can use this to filter by race type</span>
<a id="__codelineno-2-23" name="__codelineno-2-23" href="#__codelineno-2-23"></a>        <span class="c1">#and (c := split_anz_horse_market_name(d.name)[1]) &amp;gt;= &#39;1200&#39; #can use this to filter by race length</span>
<a id="__codelineno-2-24" name="__codelineno-2-24" href="#__codelineno-2-24"></a>        <span class="p">)</span>
<a id="__codelineno-2-25" name="__codelineno-2-25" href="#__codelineno-2-25"></a>
<a id="__codelineno-2-26" name="__codelineno-2-26" href="#__codelineno-2-26"></a><span class="c1"># Simply add the below variable name to the market filter function above with the filter value</span>
<a id="__codelineno-2-27" name="__codelineno-2-27" href="#__codelineno-2-27"></a><span class="c1"># Equals (== &#39;Value in Quotation&#39; or True/False/None), Does Not Equal (!= &#39;Value in Quotation&#39; or True/False/None) - FOR ALL TYPES</span>
<a id="__codelineno-2-28" name="__codelineno-2-28" href="#__codelineno-2-28"></a><span class="c1"># Greater than (&amp;gt;), Greater than or equal to (&amp;gt;=), Less than (&amp;lt;), Less than or equal to (&amp;lt;=) - FOR INT/FLOAT</span>
<a id="__codelineno-2-29" name="__codelineno-2-29" href="#__codelineno-2-29"></a><span class="c1"># For list of value &#39;in&#39;</span>
<a id="__codelineno-2-30" name="__codelineno-2-30" href="#__codelineno-2-30"></a>
<a id="__codelineno-2-31" name="__codelineno-2-31" href="#__codelineno-2-31"></a><span class="c1"># and d.betting_type: str - ODDS, ASIAN_HANDICAP_SINGLES, ASIAN_HANDICAP_DOUBLES or LINE</span>
<a id="__codelineno-2-32" name="__codelineno-2-32" href="#__codelineno-2-32"></a><span class="c1"># and d.bsp_market: bool - True, False</span>
<a id="__codelineno-2-33" name="__codelineno-2-33" href="#__codelineno-2-33"></a><span class="c1"># and d.country_code: str - list of codes can be found here: https://en.wikipedia.org/wiki/ISO_3166-1_alpha-2 - Default value is &#39;GB&#39; - Australia = &#39;AU&#39;, New Zealand = &#39;NZ&#39;</span>
<a id="__codelineno-2-34" name="__codelineno-2-34" href="#__codelineno-2-34"></a><span class="c1"># and d.event_id: str - PARENT_EVENT_ID</span>
<a id="__codelineno-2-35" name="__codelineno-2-35" href="#__codelineno-2-35"></a><span class="c1"># and d.event_name: Optional[str] - Usually the name of the Match-Up (e.g. Bangladesh v Sri Lanka) or Race Meeting Name (e.g. Wangaratta (AUS) 1st Dec) - Note: Dictionaries don&#39;t support wildcard searches</span>
<a id="__codelineno-2-36" name="__codelineno-2-36" href="#__codelineno-2-36"></a><span class="c1"># and d.event_type_id: str - SportID [Horse Racing - 7, Greyhounds - 4339]</span>
<a id="__codelineno-2-37" name="__codelineno-2-37" href="#__codelineno-2-37"></a><span class="c1"># and d.market_base_rate: float - Market Commission Rate</span>
<a id="__codelineno-2-38" name="__codelineno-2-38" href="#__codelineno-2-38"></a><span class="c1"># and d.market_type: str - e.g. &quot;WIN&quot;</span>
<a id="__codelineno-2-39" name="__codelineno-2-39" href="#__codelineno-2-39"></a><span class="c1"># and d.name: Optional[str] - market name (e.g. R1 1170m Mdn)</span>
<a id="__codelineno-2-40" name="__codelineno-2-40" href="#__codelineno-2-40"></a><span class="c1"># and d.number_of_active_runners: int - number of horses/dogs in the race</span>
<a id="__codelineno-2-41" name="__codelineno-2-41" href="#__codelineno-2-41"></a><span class="c1"># and d.number_of_winners: int - Win market 1, Place markets 2+</span>
<a id="__codelineno-2-42" name="__codelineno-2-42" href="#__codelineno-2-42"></a><span class="c1"># and d.turn_in_play_enabled: bool - True, False</span>
<a id="__codelineno-2-43" name="__codelineno-2-43" href="#__codelineno-2-43"></a><span class="c1"># and d.venue: Optional[str] - Racing Only - Track</span>
</code></pre></div>

</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="14-utility-functions">1.4 Utility Functions</h3>
<p>Here we will define our trading and listener functions which will be able to handle the json file format as well as defining some more working directories. We've also defined a few functions to generate the required output.</p>
<p>NOTE: Input credentials are not required here</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="n">trading</span> <span class="o">=</span> <span class="n">betfairlightweight</span><span class="o">.</span><span class="n">APIClient</span><span class="p">(</span><span class="n">username</span> <span class="o">=</span> <span class="s2">&quot;username&quot;</span><span class="p">,</span> <span class="n">password</span> <span class="o">=</span> <span class="s2">&quot;password&quot;</span><span class="p">,</span> <span class="n">app_key</span><span class="o">=</span><span class="s2">&quot;app_key&quot;</span><span class="p">)</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="n">listener</span> <span class="o">=</span> <span class="n">StreamListener</span><span class="p">(</span><span class="n">max_latency</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="n">stream_files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">file_directory</span><span class="o">+</span><span class="s2">&quot;*.tar&quot;</span><span class="p">)</span> 
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="n">selection_meta</span> <span class="o">=</span> <span class="n">file_directory</span><span class="o">+</span><span class="s2">&quot;metadata.csv&quot;</span>
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="n">prices_path</span> <span class="o">=</span>  <span class="n">file_directory</span><span class="o">+</span><span class="s2">&quot;preplay.csv&quot;</span>
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a>
<a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a><span class="c1"># rounding to 2 decimal places or returning &#39;&#39; if blank</span>
<a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a><span class="k">def</span> <span class="nf">as_str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a>    <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">v</span> <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="n">v</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
<a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a>
<a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a><span class="c1"># returning smaller of two numbers where min not 0</span>
<a id="__codelineno-3-13" name="__codelineno-3-13" href="#__codelineno-3-13"></a><span class="k">def</span> <span class="nf">min_gr0</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="nb">float</span><span class="p">:</span>
<a id="__codelineno-3-14" name="__codelineno-3-14" href="#__codelineno-3-14"></a>    <span class="k">if</span> <span class="n">a</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="o">=</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-3-15" name="__codelineno-3-15" href="#__codelineno-3-15"></a>        <span class="k">return</span> <span class="n">b</span>
<a id="__codelineno-3-16" name="__codelineno-3-16" href="#__codelineno-3-16"></a>    <span class="k">if</span> <span class="n">b</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="o">=</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-3-17" name="__codelineno-3-17" href="#__codelineno-3-17"></a>        <span class="k">return</span> <span class="n">a</span>
<a id="__codelineno-3-18" name="__codelineno-3-18" href="#__codelineno-3-18"></a>
<a id="__codelineno-3-19" name="__codelineno-3-19" href="#__codelineno-3-19"></a>    <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
<a id="__codelineno-3-20" name="__codelineno-3-20" href="#__codelineno-3-20"></a>
<a id="__codelineno-3-21" name="__codelineno-3-21" href="#__codelineno-3-21"></a><span class="c1"># parsing price data and pulling out weighted avg price, matched, min price and max price</span>
<a id="__codelineno-3-22" name="__codelineno-3-22" href="#__codelineno-3-22"></a><span class="k">def</span> <span class="nf">parse_traded</span><span class="p">(</span><span class="n">traded</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">PriceSize</span><span class="p">])</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<a id="__codelineno-3-23" name="__codelineno-3-23" href="#__codelineno-3-23"></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">traded</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> 
<a id="__codelineno-3-24" name="__codelineno-3-24" href="#__codelineno-3-24"></a>        <span class="k">return</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-3-25" name="__codelineno-3-25" href="#__codelineno-3-25"></a>
<a id="__codelineno-3-26" name="__codelineno-3-26" href="#__codelineno-3-26"></a>    <span class="p">(</span><span class="n">wavg_sum</span><span class="p">,</span> <span class="n">matched</span><span class="p">,</span> <span class="n">min_price</span><span class="p">,</span> <span class="n">max_price</span><span class="p">)</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span>
<a id="__codelineno-3-27" name="__codelineno-3-27" href="#__codelineno-3-27"></a>        <span class="k">lambda</span> <span class="n">total</span><span class="p">,</span> <span class="n">ps</span><span class="p">:</span> <span class="p">(</span>
<a id="__codelineno-3-28" name="__codelineno-3-28" href="#__codelineno-3-28"></a>            <span class="n">total</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">ps</span><span class="o">.</span><span class="n">price</span> <span class="o">*</span> <span class="n">ps</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="c1"># wavg_sum before we divide by total matched</span>
<a id="__codelineno-3-29" name="__codelineno-3-29" href="#__codelineno-3-29"></a>            <span class="n">total</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">ps</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="c1"># total matched</span>
<a id="__codelineno-3-30" name="__codelineno-3-30" href="#__codelineno-3-30"></a>            <span class="nb">min</span><span class="p">(</span><span class="n">total</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">ps</span><span class="o">.</span><span class="n">price</span><span class="p">),</span> <span class="c1"># min price matched</span>
<a id="__codelineno-3-31" name="__codelineno-3-31" href="#__codelineno-3-31"></a>            <span class="nb">max</span><span class="p">(</span><span class="n">total</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">ps</span><span class="o">.</span><span class="n">price</span><span class="p">),</span> <span class="c1"># max price matched</span>
<a id="__codelineno-3-32" name="__codelineno-3-32" href="#__codelineno-3-32"></a>        <span class="p">),</span>
<a id="__codelineno-3-33" name="__codelineno-3-33" href="#__codelineno-3-33"></a>        <span class="n">traded</span><span class="p">,</span>
<a id="__codelineno-3-34" name="__codelineno-3-34" href="#__codelineno-3-34"></a>        <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1001</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c1"># starting default values</span>
<a id="__codelineno-3-35" name="__codelineno-3-35" href="#__codelineno-3-35"></a>    <span class="p">)</span>
<a id="__codelineno-3-36" name="__codelineno-3-36" href="#__codelineno-3-36"></a>
<a id="__codelineno-3-37" name="__codelineno-3-37" href="#__codelineno-3-37"></a>    <span class="n">wavg_sum</span> <span class="o">=</span> <span class="p">(</span><span class="n">wavg_sum</span> <span class="o">/</span> <span class="n">matched</span><span class="p">)</span> <span class="k">if</span> <span class="n">matched</span> <span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span> <span class="c1"># dividing sum of wavg by total matched</span>
<a id="__codelineno-3-38" name="__codelineno-3-38" href="#__codelineno-3-38"></a>    <span class="n">matched</span> <span class="o">=</span> <span class="n">matched</span> <span class="k">if</span> <span class="n">matched</span> <span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span> 
<a id="__codelineno-3-39" name="__codelineno-3-39" href="#__codelineno-3-39"></a>    <span class="n">min_price</span> <span class="o">=</span> <span class="n">min_price</span> <span class="k">if</span> <span class="n">min_price</span> <span class="o">!=</span> <span class="mi">1001</span> <span class="k">else</span> <span class="kc">None</span>
<a id="__codelineno-3-40" name="__codelineno-3-40" href="#__codelineno-3-40"></a>    <span class="n">max_price</span> <span class="o">=</span> <span class="n">max_price</span> <span class="k">if</span> <span class="n">max_price</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span>
<a id="__codelineno-3-41" name="__codelineno-3-41" href="#__codelineno-3-41"></a>
<a id="__codelineno-3-42" name="__codelineno-3-42" href="#__codelineno-3-42"></a>    <span class="k">return</span> <span class="p">(</span><span class="n">wavg_sum</span><span class="p">,</span> <span class="n">matched</span><span class="p">,</span> <span class="n">min_price</span><span class="p">,</span> <span class="n">max_price</span><span class="p">)</span>
<a id="__codelineno-3-43" name="__codelineno-3-43" href="#__codelineno-3-43"></a>
<a id="__codelineno-3-44" name="__codelineno-3-44" href="#__codelineno-3-44"></a>
<a id="__codelineno-3-45" name="__codelineno-3-45" href="#__codelineno-3-45"></a><span class="k">def</span> <span class="nf">load_markets</span><span class="p">(</span><span class="n">file_paths</span><span class="p">):</span>
<a id="__codelineno-3-46" name="__codelineno-3-46" href="#__codelineno-3-46"></a>    <span class="k">for</span> <span class="n">file_path</span> <span class="ow">in</span> <span class="n">file_paths</span><span class="p">:</span>
<a id="__codelineno-3-47" name="__codelineno-3-47" href="#__codelineno-3-47"></a>        <span class="nb">print</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
<a id="__codelineno-3-48" name="__codelineno-3-48" href="#__codelineno-3-48"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;__ Parsing Detailed Prices ___ &quot;</span><span class="p">)</span>
<a id="__codelineno-3-49" name="__codelineno-3-49" href="#__codelineno-3-49"></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
<a id="__codelineno-3-50" name="__codelineno-3-50" href="#__codelineno-3-50"></a>            <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">iglob</span><span class="p">(</span><span class="n">file_path</span> <span class="o">+</span> <span class="s1">&#39;**/**/*.bz2&#39;</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<a id="__codelineno-3-51" name="__codelineno-3-51" href="#__codelineno-3-51"></a>                <span class="n">f</span> <span class="o">=</span> <span class="n">bz2</span><span class="o">.</span><span class="n">BZ2File</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
<a id="__codelineno-3-52" name="__codelineno-3-52" href="#__codelineno-3-52"></a>                <span class="k">yield</span> <span class="n">f</span>
<a id="__codelineno-3-53" name="__codelineno-3-53" href="#__codelineno-3-53"></a>                <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<a id="__codelineno-3-54" name="__codelineno-3-54" href="#__codelineno-3-54"></a>        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
<a id="__codelineno-3-55" name="__codelineno-3-55" href="#__codelineno-3-55"></a>            <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file_path</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-3-56" name="__codelineno-3-56" href="#__codelineno-3-56"></a>            <span class="c1"># iterate through a tar archive</span>
<a id="__codelineno-3-57" name="__codelineno-3-57" href="#__codelineno-3-57"></a>            <span class="k">if</span> <span class="n">ext</span> <span class="o">==</span> <span class="s1">&#39;.tar&#39;</span><span class="p">:</span>
<a id="__codelineno-3-58" name="__codelineno-3-58" href="#__codelineno-3-58"></a>                <span class="k">with</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">TarFile</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">archive</span><span class="p">:</span>
<a id="__codelineno-3-59" name="__codelineno-3-59" href="#__codelineno-3-59"></a>                    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">archive</span><span class="p">:</span>
<a id="__codelineno-3-60" name="__codelineno-3-60" href="#__codelineno-3-60"></a>                        <span class="k">yield</span> <span class="n">bz2</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">archive</span><span class="o">.</span><span class="n">extractfile</span><span class="p">(</span><span class="n">file</span><span class="p">))</span>
<a id="__codelineno-3-61" name="__codelineno-3-61" href="#__codelineno-3-61"></a>            <span class="c1"># or a zip archive</span>
<a id="__codelineno-3-62" name="__codelineno-3-62" href="#__codelineno-3-62"></a>            <span class="k">elif</span> <span class="n">ext</span> <span class="o">==</span> <span class="s1">&#39;.zip&#39;</span><span class="p">:</span>
<a id="__codelineno-3-63" name="__codelineno-3-63" href="#__codelineno-3-63"></a>                <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">archive</span><span class="p">:</span>
<a id="__codelineno-3-64" name="__codelineno-3-64" href="#__codelineno-3-64"></a>                    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">archive</span><span class="o">.</span><span class="n">namelist</span><span class="p">():</span>
<a id="__codelineno-3-65" name="__codelineno-3-65" href="#__codelineno-3-65"></a>                        <span class="k">yield</span> <span class="n">bz2</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">archive</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file</span><span class="p">))</span>
<a id="__codelineno-3-66" name="__codelineno-3-66" href="#__codelineno-3-66"></a>
<a id="__codelineno-3-67" name="__codelineno-3-67" href="#__codelineno-3-67"></a>    <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-3-68" name="__codelineno-3-68" href="#__codelineno-3-68"></a>
<a id="__codelineno-3-69" name="__codelineno-3-69" href="#__codelineno-3-69"></a><span class="k">def</span> <span class="nf">slicePrice</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
<a id="__codelineno-3-70" name="__codelineno-3-70" href="#__codelineno-3-70"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-3-71" name="__codelineno-3-71" href="#__codelineno-3-71"></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">price</span>
<a id="__codelineno-3-72" name="__codelineno-3-72" href="#__codelineno-3-72"></a>    <span class="k">except</span><span class="p">:</span>
<a id="__codelineno-3-73" name="__codelineno-3-73" href="#__codelineno-3-73"></a>        <span class="n">x</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-3-74" name="__codelineno-3-74" href="#__codelineno-3-74"></a>    <span class="k">return</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-3-75" name="__codelineno-3-75" href="#__codelineno-3-75"></a>
<a id="__codelineno-3-76" name="__codelineno-3-76" href="#__codelineno-3-76"></a><span class="k">def</span> <span class="nf">sliceSize</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
<a id="__codelineno-3-77" name="__codelineno-3-77" href="#__codelineno-3-77"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-3-78" name="__codelineno-3-78" href="#__codelineno-3-78"></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">size</span>
<a id="__codelineno-3-79" name="__codelineno-3-79" href="#__codelineno-3-79"></a>    <span class="k">except</span><span class="p">:</span>
<a id="__codelineno-3-80" name="__codelineno-3-80" href="#__codelineno-3-80"></a>        <span class="n">x</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-3-81" name="__codelineno-3-81" href="#__codelineno-3-81"></a>    <span class="k">return</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-3-82" name="__codelineno-3-82" href="#__codelineno-3-82"></a>
<a id="__codelineno-3-83" name="__codelineno-3-83" href="#__codelineno-3-83"></a><span class="k">def</span> <span class="nf">pull_ladder</span><span class="p">(</span><span class="n">availableLadder</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">5</span><span class="p">):</span>
<a id="__codelineno-3-84" name="__codelineno-3-84" href="#__codelineno-3-84"></a>        <span class="n">out</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-3-85" name="__codelineno-3-85" href="#__codelineno-3-85"></a>        <span class="n">price</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-3-86" name="__codelineno-3-86" href="#__codelineno-3-86"></a>        <span class="n">volume</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-3-87" name="__codelineno-3-87" href="#__codelineno-3-87"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">availableLadder</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-3-88" name="__codelineno-3-88" href="#__codelineno-3-88"></a>            <span class="k">return</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>        
<a id="__codelineno-3-89" name="__codelineno-3-89" href="#__codelineno-3-89"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-3-90" name="__codelineno-3-90" href="#__codelineno-3-90"></a>            <span class="k">for</span> <span class="n">rung</span> <span class="ow">in</span> <span class="n">availableLadder</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">n</span><span class="p">]:</span>
<a id="__codelineno-3-91" name="__codelineno-3-91" href="#__codelineno-3-91"></a>                <span class="n">price</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rung</span><span class="o">.</span><span class="n">price</span><span class="p">)</span>
<a id="__codelineno-3-92" name="__codelineno-3-92" href="#__codelineno-3-92"></a>                <span class="n">volume</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rung</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
<a id="__codelineno-3-93" name="__codelineno-3-93" href="#__codelineno-3-93"></a>
<a id="__codelineno-3-94" name="__codelineno-3-94" href="#__codelineno-3-94"></a>            <span class="n">out</span><span class="p">[</span><span class="s2">&quot;p&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">price</span>
<a id="__codelineno-3-95" name="__codelineno-3-95" href="#__codelineno-3-95"></a>            <span class="n">out</span><span class="p">[</span><span class="s2">&quot;v&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">volume</span>
<a id="__codelineno-3-96" name="__codelineno-3-96" href="#__codelineno-3-96"></a>            <span class="k">return</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
<a id="__codelineno-3-97" name="__codelineno-3-97" href="#__codelineno-3-97"></a>
<a id="__codelineno-3-98" name="__codelineno-3-98" href="#__codelineno-3-98"></a><span class="k">def</span> <span class="nf">final_market_book</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
<a id="__codelineno-3-99" name="__codelineno-3-99" href="#__codelineno-3-99"></a>
<a id="__codelineno-3-100" name="__codelineno-3-100" href="#__codelineno-3-100"></a>    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s2">&quot;builtins.open&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">f</span><span class="p">,</span> <span class="n">_</span><span class="p">:</span> <span class="n">f</span><span class="p">):</span>
<a id="__codelineno-3-101" name="__codelineno-3-101" href="#__codelineno-3-101"></a>
<a id="__codelineno-3-102" name="__codelineno-3-102" href="#__codelineno-3-102"></a>        <span class="n">gen</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">get_generator</span><span class="p">()</span>
<a id="__codelineno-3-103" name="__codelineno-3-103" href="#__codelineno-3-103"></a>
<a id="__codelineno-3-104" name="__codelineno-3-104" href="#__codelineno-3-104"></a>        <span class="k">for</span> <span class="n">market_books</span> <span class="ow">in</span> <span class="n">gen</span><span class="p">():</span>
<a id="__codelineno-3-105" name="__codelineno-3-105" href="#__codelineno-3-105"></a>
<a id="__codelineno-3-106" name="__codelineno-3-106" href="#__codelineno-3-106"></a>            <span class="c1"># Check if this market book meets our market filter ++++++++++++++++++++++++++++++++++</span>
<a id="__codelineno-3-107" name="__codelineno-3-107" href="#__codelineno-3-107"></a>
<a id="__codelineno-3-108" name="__codelineno-3-108" href="#__codelineno-3-108"></a>            <span class="k">if</span> <span class="p">((</span><span class="n">evaluate_market</span> <span class="o">:=</span> <span class="n">filter_market</span><span class="p">(</span><span class="n">market_books</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">==</span> <span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-3-109" name="__codelineno-3-109" href="#__codelineno-3-109"></a>                    <span class="k">return</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-3-110" name="__codelineno-3-110" href="#__codelineno-3-110"></a>
<a id="__codelineno-3-111" name="__codelineno-3-111" href="#__codelineno-3-111"></a>            <span class="k">for</span> <span class="n">market_book</span> <span class="ow">in</span> <span class="n">market_books</span><span class="p">:</span>
<a id="__codelineno-3-112" name="__codelineno-3-112" href="#__codelineno-3-112"></a>
<a id="__codelineno-3-113" name="__codelineno-3-113" href="#__codelineno-3-113"></a>                <span class="n">last_market_book</span> <span class="o">=</span> <span class="n">market_book</span>
<a id="__codelineno-3-114" name="__codelineno-3-114" href="#__codelineno-3-114"></a>
<a id="__codelineno-3-115" name="__codelineno-3-115" href="#__codelineno-3-115"></a>        <span class="k">return</span><span class="p">(</span><span class="n">last_market_book</span><span class="p">)</span>
</code></pre></div>

</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="15-parsing-timestamped-prices">1.5 Parsing Timestamped Prices</h3>
<p>Next up are the functions that enable us to read the timestamped prices from the json files and output them ready to be joined on the metadata. 
This will provide:</p>
<ul>
<li>Market ID</li>
<li>Number of Active Runners in the market (this can help in the event of late scratchings)</li>
<li>Timestamp (will help us later to calculate time relative to scheduled off time)</li>
<li>Traded Volume on the selection so far</li>
<li>Weighted Average Price</li>
<li>Last Traded Price</li>
<li>Selection Status (this can help in the event of late scratchings)</li>
<li>Reduction Factor (effect on the market if the runner were to be scratched)</li>
<li>Back Ladder (pulls 5 best prices and volume available)</li>
<li>Lay Ladder (pulls 5 best prices and volume available)</li>
<li>BSP Near Price</li>
<li>BSP Far Price</li>
</ul>
<p>NOTE: Projected BSP displayed on the app/website is the Near Price - more information about Near/Far Prices and their accuracy can be found <a href="https://betfair-datascientists.github.io/tutorials/analysingAndPredictingBSP/">here</a></p>
<p>NOTE: The function is defined to stop pulling the prices once the market goes in-play. If in-play prices are required, then simply remove the condition for market_book.inplay. However, you will need to insert an inplay flag in order to distinguish when the market goes inplay in the csv file.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="k">def</span> <span class="nf">loop_prices</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">o</span><span class="p">):</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s2">&quot;builtins.open&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">f</span><span class="p">,</span> <span class="n">_</span><span class="p">:</span> <span class="n">f</span><span class="p">):</span>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a>
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a>        <span class="n">gen</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">get_generator</span><span class="p">()</span>
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a>
<a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a>        <span class="n">marketID</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a>        <span class="n">tradeVols</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a>        <span class="n">time</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a>
<a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a>        <span class="k">for</span> <span class="n">market_books</span> <span class="ow">in</span> <span class="n">gen</span><span class="p">():</span>
<a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a>
<a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a>            <span class="c1"># Check if this market book meets our market filter ++++++++++++++++++++++++++++++++++</span>
<a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a>
<a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a>            <span class="k">if</span> <span class="p">((</span><span class="n">evaluate_market</span> <span class="o">:=</span> <span class="n">filter_market</span><span class="p">(</span><span class="n">market_books</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">==</span> <span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-4-16" name="__codelineno-4-16" href="#__codelineno-4-16"></a>                    <span class="k">break</span>
<a id="__codelineno-4-17" name="__codelineno-4-17" href="#__codelineno-4-17"></a>
<a id="__codelineno-4-18" name="__codelineno-4-18" href="#__codelineno-4-18"></a>            <span class="k">for</span> <span class="n">market_book</span> <span class="ow">in</span> <span class="n">market_books</span><span class="p">:</span>
<a id="__codelineno-4-19" name="__codelineno-4-19" href="#__codelineno-4-19"></a>
<a id="__codelineno-4-20" name="__codelineno-4-20" href="#__codelineno-4-20"></a>                <span class="c1"># Time Step Management ++++++++++++++++++++++++++++++++++</span>
<a id="__codelineno-4-21" name="__codelineno-4-21" href="#__codelineno-4-21"></a>
<a id="__codelineno-4-22" name="__codelineno-4-22" href="#__codelineno-4-22"></a>                <span class="k">if</span> <span class="n">marketID</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-4-23" name="__codelineno-4-23" href="#__codelineno-4-23"></a>
<a id="__codelineno-4-24" name="__codelineno-4-24" href="#__codelineno-4-24"></a>                    <span class="c1"># No market initialised</span>
<a id="__codelineno-4-25" name="__codelineno-4-25" href="#__codelineno-4-25"></a>                    <span class="n">marketID</span> <span class="o">=</span> <span class="n">market_book</span><span class="o">.</span><span class="n">market_id</span>
<a id="__codelineno-4-26" name="__codelineno-4-26" href="#__codelineno-4-26"></a>                    <span class="n">time</span> <span class="o">=</span>  <span class="n">market_book</span><span class="o">.</span><span class="n">publish_time</span>
<a id="__codelineno-4-27" name="__codelineno-4-27" href="#__codelineno-4-27"></a>
<a id="__codelineno-4-28" name="__codelineno-4-28" href="#__codelineno-4-28"></a>                <span class="k">elif</span> <span class="n">market_book</span><span class="o">.</span><span class="n">inplay</span><span class="p">:</span>
<a id="__codelineno-4-29" name="__codelineno-4-29" href="#__codelineno-4-29"></a>
<a id="__codelineno-4-30" name="__codelineno-4-30" href="#__codelineno-4-30"></a>                    <span class="c1"># Stop once market inplay</span>
<a id="__codelineno-4-31" name="__codelineno-4-31" href="#__codelineno-4-31"></a>                    <span class="k">break</span>
<a id="__codelineno-4-32" name="__codelineno-4-32" href="#__codelineno-4-32"></a>
<a id="__codelineno-4-33" name="__codelineno-4-33" href="#__codelineno-4-33"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-4-34" name="__codelineno-4-34" href="#__codelineno-4-34"></a>
<a id="__codelineno-4-35" name="__codelineno-4-35" href="#__codelineno-4-35"></a>                    <span class="n">seconds_to_start</span> <span class="o">=</span> <span class="p">(</span><span class="n">market_book</span><span class="o">.</span><span class="n">market_definition</span><span class="o">.</span><span class="n">market_time</span> <span class="o">-</span> <span class="n">market_book</span><span class="o">.</span><span class="n">publish_time</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
<a id="__codelineno-4-36" name="__codelineno-4-36" href="#__codelineno-4-36"></a>
<a id="__codelineno-4-37" name="__codelineno-4-37" href="#__codelineno-4-37"></a>                    <span class="k">if</span> <span class="n">seconds_to_start</span> <span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="n">log1_Start</span><span class="p">:</span>
<a id="__codelineno-4-38" name="__codelineno-4-38" href="#__codelineno-4-38"></a>
<a id="__codelineno-4-39" name="__codelineno-4-39" href="#__codelineno-4-39"></a>                        <span class="c1"># Too early before off to start logging prices</span>
<a id="__codelineno-4-40" name="__codelineno-4-40" href="#__codelineno-4-40"></a>                        <span class="k">continue</span>
<a id="__codelineno-4-41" name="__codelineno-4-41" href="#__codelineno-4-41"></a>
<a id="__codelineno-4-42" name="__codelineno-4-42" href="#__codelineno-4-42"></a>                    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-4-43" name="__codelineno-4-43" href="#__codelineno-4-43"></a>
<a id="__codelineno-4-44" name="__codelineno-4-44" href="#__codelineno-4-44"></a>                        <span class="c1"># Update data at different time steps depending on seconds to off</span>
<a id="__codelineno-4-45" name="__codelineno-4-45" href="#__codelineno-4-45"></a>                        <span class="n">wait</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">seconds_to_start</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="o">=</span> <span class="n">log2_Start</span><span class="p">,</span> <span class="n">log2_Step</span><span class="p">,</span> <span class="n">log1_Step</span><span class="p">)</span>
<a id="__codelineno-4-46" name="__codelineno-4-46" href="#__codelineno-4-46"></a>
<a id="__codelineno-4-47" name="__codelineno-4-47" href="#__codelineno-4-47"></a>                        <span class="c1"># New Market</span>
<a id="__codelineno-4-48" name="__codelineno-4-48" href="#__codelineno-4-48"></a>                        <span class="k">if</span> <span class="n">market_book</span><span class="o">.</span><span class="n">market_id</span> <span class="o">!=</span> <span class="n">marketID</span><span class="p">:</span>
<a id="__codelineno-4-49" name="__codelineno-4-49" href="#__codelineno-4-49"></a>                            <span class="n">marketID</span> <span class="o">=</span> <span class="n">market_book</span><span class="o">.</span><span class="n">market_id</span>
<a id="__codelineno-4-50" name="__codelineno-4-50" href="#__codelineno-4-50"></a>                            <span class="n">time</span> <span class="o">=</span>  <span class="n">market_book</span><span class="o">.</span><span class="n">publish_time</span>
<a id="__codelineno-4-51" name="__codelineno-4-51" href="#__codelineno-4-51"></a>                        <span class="c1"># (wait) seconds elapsed since last write</span>
<a id="__codelineno-4-52" name="__codelineno-4-52" href="#__codelineno-4-52"></a>                        <span class="k">elif</span> <span class="p">(</span><span class="n">market_book</span><span class="o">.</span><span class="n">publish_time</span> <span class="o">-</span> <span class="n">time</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="n">wait</span><span class="p">:</span>
<a id="__codelineno-4-53" name="__codelineno-4-53" href="#__codelineno-4-53"></a>                            <span class="n">time</span> <span class="o">=</span> <span class="n">market_book</span><span class="o">.</span><span class="n">publish_time</span>
<a id="__codelineno-4-54" name="__codelineno-4-54" href="#__codelineno-4-54"></a>                        <span class="c1"># fewer than (wait) seconds elapsed continue to next loop</span>
<a id="__codelineno-4-55" name="__codelineno-4-55" href="#__codelineno-4-55"></a>                        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-4-56" name="__codelineno-4-56" href="#__codelineno-4-56"></a>                            <span class="k">continue</span>
<a id="__codelineno-4-57" name="__codelineno-4-57" href="#__codelineno-4-57"></a>
<a id="__codelineno-4-58" name="__codelineno-4-58" href="#__codelineno-4-58"></a>                <span class="c1"># Execute Data Logging ++++++++++++++++++++++++++++++++++</span>
<a id="__codelineno-4-59" name="__codelineno-4-59" href="#__codelineno-4-59"></a>
<a id="__codelineno-4-60" name="__codelineno-4-60" href="#__codelineno-4-60"></a>                <span class="k">for</span> <span class="n">runner</span> <span class="ow">in</span> <span class="n">market_book</span><span class="o">.</span><span class="n">runners</span><span class="p">:</span>
<a id="__codelineno-4-61" name="__codelineno-4-61" href="#__codelineno-4-61"></a>
<a id="__codelineno-4-62" name="__codelineno-4-62" href="#__codelineno-4-62"></a>                    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-4-63" name="__codelineno-4-63" href="#__codelineno-4-63"></a>                        <span class="n">selection_status</span> <span class="o">=</span> <span class="n">runner</span><span class="o">.</span><span class="n">status</span>
<a id="__codelineno-4-64" name="__codelineno-4-64" href="#__codelineno-4-64"></a>                        <span class="n">reduction_factor</span> <span class="o">=</span> <span class="n">runner</span><span class="o">.</span><span class="n">adjustment_factor</span>
<a id="__codelineno-4-65" name="__codelineno-4-65" href="#__codelineno-4-65"></a>                        <span class="n">atb_ladder</span> <span class="o">=</span> <span class="n">pull_ladder</span><span class="p">(</span><span class="n">runner</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">available_to_back</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">5</span><span class="p">)</span>
<a id="__codelineno-4-66" name="__codelineno-4-66" href="#__codelineno-4-66"></a>                        <span class="n">atl_ladder</span> <span class="o">=</span> <span class="n">pull_ladder</span><span class="p">(</span><span class="n">runner</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">available_to_lay</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">5</span><span class="p">)</span>
<a id="__codelineno-4-67" name="__codelineno-4-67" href="#__codelineno-4-67"></a>                        <span class="n">spn</span> <span class="o">=</span> <span class="n">runner</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">near_price</span>
<a id="__codelineno-4-68" name="__codelineno-4-68" href="#__codelineno-4-68"></a>                        <span class="n">spf</span> <span class="o">=</span> <span class="n">runner</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">far_price</span>
<a id="__codelineno-4-69" name="__codelineno-4-69" href="#__codelineno-4-69"></a>                    <span class="k">except</span><span class="p">:</span>
<a id="__codelineno-4-70" name="__codelineno-4-70" href="#__codelineno-4-70"></a>                        <span class="n">selection_status</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-4-71" name="__codelineno-4-71" href="#__codelineno-4-71"></a>                        <span class="n">reduction_factor</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-4-72" name="__codelineno-4-72" href="#__codelineno-4-72"></a>                        <span class="n">atb_ladder</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-4-73" name="__codelineno-4-73" href="#__codelineno-4-73"></a>                        <span class="n">atl_ladder</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-4-74" name="__codelineno-4-74" href="#__codelineno-4-74"></a>                        <span class="n">spn</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-4-75" name="__codelineno-4-75" href="#__codelineno-4-75"></a>                        <span class="n">spf</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-4-76" name="__codelineno-4-76" href="#__codelineno-4-76"></a>
<a id="__codelineno-4-77" name="__codelineno-4-77" href="#__codelineno-4-77"></a>                    <span class="c1"># Calculate Current Traded Volume + Traded WAP</span>
<a id="__codelineno-4-78" name="__codelineno-4-78" href="#__codelineno-4-78"></a>                    <span class="n">limitTradedVol</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">rung</span><span class="o">.</span><span class="n">size</span> <span class="k">for</span> <span class="n">rung</span> <span class="ow">in</span> <span class="n">runner</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">traded_volume</span><span class="p">])</span>
<a id="__codelineno-4-79" name="__codelineno-4-79" href="#__codelineno-4-79"></a>                    <span class="k">if</span> <span class="n">limitTradedVol</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-4-80" name="__codelineno-4-80" href="#__codelineno-4-80"></a>                        <span class="n">limitWAP</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-4-81" name="__codelineno-4-81" href="#__codelineno-4-81"></a>                    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-4-82" name="__codelineno-4-82" href="#__codelineno-4-82"></a>                        <span class="n">limitWAP</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">rung</span><span class="o">.</span><span class="n">size</span> <span class="o">*</span> <span class="n">rung</span><span class="o">.</span><span class="n">price</span> <span class="k">for</span> <span class="n">rung</span> <span class="ow">in</span> <span class="n">runner</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">traded_volume</span><span class="p">])</span> <span class="o">/</span> <span class="n">limitTradedVol</span>
<a id="__codelineno-4-83" name="__codelineno-4-83" href="#__codelineno-4-83"></a>                        <span class="n">limitWAP</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">limitWAP</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-4-84" name="__codelineno-4-84" href="#__codelineno-4-84"></a>
<a id="__codelineno-4-85" name="__codelineno-4-85" href="#__codelineno-4-85"></a>                    <span class="n">o</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span>
<a id="__codelineno-4-86" name="__codelineno-4-86" href="#__codelineno-4-86"></a>                        <span class="p">(</span>
<a id="__codelineno-4-87" name="__codelineno-4-87" href="#__codelineno-4-87"></a>                            <span class="n">market_book</span><span class="o">.</span><span class="n">market_id</span><span class="p">,</span>
<a id="__codelineno-4-88" name="__codelineno-4-88" href="#__codelineno-4-88"></a>                            <span class="n">market_book</span><span class="o">.</span><span class="n">number_of_active_runners</span><span class="p">,</span>
<a id="__codelineno-4-89" name="__codelineno-4-89" href="#__codelineno-4-89"></a>                            <span class="n">runner</span><span class="o">.</span><span class="n">selection_id</span><span class="p">,</span>
<a id="__codelineno-4-90" name="__codelineno-4-90" href="#__codelineno-4-90"></a>                            <span class="n">market_book</span><span class="o">.</span><span class="n">publish_time</span><span class="p">,</span>
<a id="__codelineno-4-91" name="__codelineno-4-91" href="#__codelineno-4-91"></a>                            <span class="n">limitTradedVol</span><span class="p">,</span>
<a id="__codelineno-4-92" name="__codelineno-4-92" href="#__codelineno-4-92"></a>                            <span class="n">limitWAP</span><span class="p">,</span>
<a id="__codelineno-4-93" name="__codelineno-4-93" href="#__codelineno-4-93"></a>                            <span class="n">runner</span><span class="o">.</span><span class="n">last_price_traded</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-4-94" name="__codelineno-4-94" href="#__codelineno-4-94"></a>                            <span class="n">selection_status</span><span class="p">,</span>
<a id="__codelineno-4-95" name="__codelineno-4-95" href="#__codelineno-4-95"></a>                            <span class="n">reduction_factor</span><span class="p">,</span>
<a id="__codelineno-4-96" name="__codelineno-4-96" href="#__codelineno-4-96"></a>                            <span class="nb">str</span><span class="p">(</span><span class="n">atb_ladder</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">),</span> 
<a id="__codelineno-4-97" name="__codelineno-4-97" href="#__codelineno-4-97"></a>                            <span class="nb">str</span><span class="p">(</span><span class="n">atl_ladder</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">),</span>
<a id="__codelineno-4-98" name="__codelineno-4-98" href="#__codelineno-4-98"></a>                            <span class="nb">str</span><span class="p">(</span><span class="n">spn</span><span class="p">),</span>
<a id="__codelineno-4-99" name="__codelineno-4-99" href="#__codelineno-4-99"></a>                            <span class="nb">str</span><span class="p">(</span><span class="n">spf</span><span class="p">)</span>
<a id="__codelineno-4-100" name="__codelineno-4-100" href="#__codelineno-4-100"></a>                        <span class="p">)</span>
<a id="__codelineno-4-101" name="__codelineno-4-101" href="#__codelineno-4-101"></a>                    <span class="p">)</span>
<a id="__codelineno-4-102" name="__codelineno-4-102" href="#__codelineno-4-102"></a>
<a id="__codelineno-4-103" name="__codelineno-4-103" href="#__codelineno-4-103"></a>
<a id="__codelineno-4-104" name="__codelineno-4-104" href="#__codelineno-4-104"></a><span class="k">def</span> <span class="nf">parse_prices</span><span class="p">(</span><span class="nb">dir</span><span class="p">,</span> <span class="n">out_file</span><span class="p">):</span>
<a id="__codelineno-4-105" name="__codelineno-4-105" href="#__codelineno-4-105"></a>
<a id="__codelineno-4-106" name="__codelineno-4-106" href="#__codelineno-4-106"></a>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">out_file</span><span class="p">,</span> <span class="s2">&quot;w+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">output</span><span class="p">:</span>
<a id="__codelineno-4-107" name="__codelineno-4-107" href="#__codelineno-4-107"></a>
<a id="__codelineno-4-108" name="__codelineno-4-108" href="#__codelineno-4-108"></a>        <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span>
<a id="__codelineno-4-109" name="__codelineno-4-109" href="#__codelineno-4-109"></a>            <span class="n">output</span><span class="p">,</span> 
<a id="__codelineno-4-110" name="__codelineno-4-110" href="#__codelineno-4-110"></a>            <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span>
<a id="__codelineno-4-111" name="__codelineno-4-111" href="#__codelineno-4-111"></a>            <span class="n">lineterminator</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\r\n</span><span class="s1">&#39;</span><span class="p">,</span>
<a id="__codelineno-4-112" name="__codelineno-4-112" href="#__codelineno-4-112"></a>            <span class="n">quoting</span><span class="o">=</span><span class="n">csv</span><span class="o">.</span><span class="n">QUOTE_ALL</span>
<a id="__codelineno-4-113" name="__codelineno-4-113" href="#__codelineno-4-113"></a>        <span class="p">)</span>
<a id="__codelineno-4-114" name="__codelineno-4-114" href="#__codelineno-4-114"></a>
<a id="__codelineno-4-115" name="__codelineno-4-115" href="#__codelineno-4-115"></a>        <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">((</span><span class="s2">&quot;market_id&quot;</span><span class="p">,</span><span class="s2">&quot;active_runners&quot;</span><span class="p">,</span><span class="s2">&quot;selection_id&quot;</span><span class="p">,</span><span class="s2">&quot;time&quot;</span><span class="p">,</span><span class="s2">&quot;traded_volume&quot;</span><span class="p">,</span><span class="s2">&quot;wap&quot;</span><span class="p">,</span><span class="s2">&quot;ltp&quot;</span><span class="p">,</span><span class="s2">&quot;selection_status&quot;</span><span class="p">,</span><span class="s1">&#39;reduction_factor&#39;</span><span class="p">,</span><span class="s2">&quot;atb_ladder&quot;</span><span class="p">,</span><span class="s2">&quot;atl_ladder&quot;</span><span class="p">,</span><span class="s2">&quot;sp_near&quot;</span><span class="p">,</span><span class="s2">&quot;sp_far&quot;</span><span class="p">))</span>
<a id="__codelineno-4-116" name="__codelineno-4-116" href="#__codelineno-4-116"></a>
<a id="__codelineno-4-117" name="__codelineno-4-117" href="#__codelineno-4-117"></a>        <span class="k">for</span> <span class="n">file_obj</span> <span class="ow">in</span> <span class="n">load_markets</span><span class="p">(</span><span class="nb">dir</span><span class="p">):</span>
<a id="__codelineno-4-118" name="__codelineno-4-118" href="#__codelineno-4-118"></a>
<a id="__codelineno-4-119" name="__codelineno-4-119" href="#__codelineno-4-119"></a>            <span class="n">stream</span> <span class="o">=</span> <span class="n">trading</span><span class="o">.</span><span class="n">streaming</span><span class="o">.</span><span class="n">create_historical_generator_stream</span><span class="p">(</span>
<a id="__codelineno-4-120" name="__codelineno-4-120" href="#__codelineno-4-120"></a>                <span class="n">file_path</span><span class="o">=</span><span class="n">file_obj</span><span class="p">,</span>
<a id="__codelineno-4-121" name="__codelineno-4-121" href="#__codelineno-4-121"></a>                <span class="n">listener</span><span class="o">=</span><span class="n">listener</span><span class="p">,</span>
<a id="__codelineno-4-122" name="__codelineno-4-122" href="#__codelineno-4-122"></a>            <span class="p">)</span>
<a id="__codelineno-4-123" name="__codelineno-4-123" href="#__codelineno-4-123"></a>
<a id="__codelineno-4-124" name="__codelineno-4-124" href="#__codelineno-4-124"></a>            <span class="n">loop_prices</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">writer</span><span class="p">)</span>
</code></pre></div>

</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="16-the-good-stuff">1.6 The Good Stuff</h3>
<p>Now comes the really meaty chunk of code that will do the grunt work for us. We'll generate the timestamped prices for each TAR file separately and then loop over them again to generate the selection metadata. (This is using a chunk of code from our JSON to CSV Revisited tutorial using the Betfair_Data package. This is super speedy because its mainly written in Rust rather than python)
In our metadata files we will provide:</p>
<ul>
<li>Market ID</li>
<li>Market Time</li>
<li>Country Code</li>
<li>Track/Venue</li>
<li>Market Name</li>
<li>Selection ID</li>
<li>Horse Name</li>
<li>Result</li>
<li>BSP</li>
<li>Preplay Minimum Matched Price</li>
<li>Preplay Maximum Matched Price</li>
<li>Preplay Weighted Average Matched Price</li>
<li>Preplay Last Traded Price</li>
<li>Preplay Matched Volume (not including SP volume)</li>
<li>BSP Matched Volume (Back Stake)</li>
<li>Inplay Minimum Matched Price</li>
<li>Inplay Maximum Matched Price</li>
<li>Inplay Weighted Average Matched Price</li>
<li>Inplay Last Traded Price</li>
<li>Inplay Matched Volume</li>
</ul>
<p>Note: For markets that don't go in play (like Greyhounds/Place markets), the 'Inplay' fields will be empty.</p>
<p>Following this metadata generation, we'll then join the dataframes together and add the "seconds to scheduled off" field, as well as converting the GMT time in the TAR Files to Melbourne time (this is useful for when markets are timed for early morning before 10am (or 11am during daylight savings) which causes the local event date to be the previous day in GMT) and converting the currency to Australian Dollars using a historical currency conversion.</p>
<p>The final piece will be outputting the files to CSV. The code is setup to output a separate file for each race which reduces the number of rows per race and enables output to be easily opened and checked for completeness. Changing this to output one CSV file per TAR file or one CSV file per day is fairly straightforward.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="c1">#loop over each TAR file</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="k">for</span> <span class="n">tar</span> <span class="ow">in</span> <span class="n">stream_files</span><span class="p">:</span>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>    <span class="n">parse_prices</span><span class="p">([</span><span class="n">tar</span><span class="p">],</span> <span class="n">prices_path</span><span class="p">)</span> <span class="c1">#This is where the timestamped prices are generated</span>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;__ Parsing Market and Selection Data ___ &quot;</span><span class="p">)</span>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a>
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a>    <span class="c1"># record prices to a file</span>
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">selection_meta</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">output</span><span class="p">:</span>
<a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a>    <span class="c1"># defining column headers</span>
<a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a>        <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;market_id,event_date,country,track,event_name,selection_id,selection_name,result,bsp,pp_min,pp_max,pp_wap,pp_ltp,pp_volume,bsp_volume,ip_min,ip_max,ip_wap,ip_ltp,ip_volume</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a>
<a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bflw</span><span class="o">.</span><span class="n">Files</span><span class="p">([</span><span class="n">tar</span><span class="p">])):</span>
<a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Market </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a>
<a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a>            <span class="k">def</span> <span class="nf">get_pre_post_final</span><span class="p">():</span>
<a id="__codelineno-5-15" name="__codelineno-5-15" href="#__codelineno-5-15"></a>                <span class="n">eval_market</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-5-16" name="__codelineno-5-16" href="#__codelineno-5-16"></a>                <span class="n">prev_market</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-5-17" name="__codelineno-5-17" href="#__codelineno-5-17"></a>                <span class="n">preplay_market</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-5-18" name="__codelineno-5-18" href="#__codelineno-5-18"></a>                <span class="n">postplay_market</span> <span class="o">=</span> <span class="kc">None</span>       
<a id="__codelineno-5-19" name="__codelineno-5-19" href="#__codelineno-5-19"></a>
<a id="__codelineno-5-20" name="__codelineno-5-20" href="#__codelineno-5-20"></a>                <span class="k">for</span> <span class="n">market_books</span> <span class="ow">in</span> <span class="n">g</span><span class="p">:</span>
<a id="__codelineno-5-21" name="__codelineno-5-21" href="#__codelineno-5-21"></a>                    <span class="k">for</span> <span class="n">market_book</span> <span class="ow">in</span> <span class="n">market_books</span><span class="p">:</span>
<a id="__codelineno-5-22" name="__codelineno-5-22" href="#__codelineno-5-22"></a>                        <span class="c1"># if market doesn&#39;t meet filter return out</span>
<a id="__codelineno-5-23" name="__codelineno-5-23" href="#__codelineno-5-23"></a>                        <span class="k">if</span> <span class="n">eval_market</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">((</span><span class="n">eval_market</span> <span class="o">:=</span> <span class="n">filter_market</span><span class="p">(</span><span class="n">market_book</span><span class="p">))</span> <span class="o">==</span> <span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-5-24" name="__codelineno-5-24" href="#__codelineno-5-24"></a>                            <span class="k">return</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-5-25" name="__codelineno-5-25" href="#__codelineno-5-25"></a>
<a id="__codelineno-5-26" name="__codelineno-5-26" href="#__codelineno-5-26"></a>                        <span class="c1"># final market view before market goes in play</span>
<a id="__codelineno-5-27" name="__codelineno-5-27" href="#__codelineno-5-27"></a>                        <span class="k">if</span> <span class="n">prev_market</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">prev_market</span><span class="o">.</span><span class="n">inplay</span> <span class="o">!=</span> <span class="n">market_book</span><span class="o">.</span><span class="n">inplay</span><span class="p">:</span>
<a id="__codelineno-5-28" name="__codelineno-5-28" href="#__codelineno-5-28"></a>                            <span class="n">preplay_market</span> <span class="o">=</span> <span class="n">prev_market</span>
<a id="__codelineno-5-29" name="__codelineno-5-29" href="#__codelineno-5-29"></a>
<a id="__codelineno-5-30" name="__codelineno-5-30" href="#__codelineno-5-30"></a>                        <span class="c1"># final market view at the conclusion of the market</span>
<a id="__codelineno-5-31" name="__codelineno-5-31" href="#__codelineno-5-31"></a>                        <span class="k">if</span> <span class="n">prev_market</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">prev_market</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;OPEN&quot;</span> <span class="ow">and</span> <span class="n">market_book</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="n">prev_market</span><span class="o">.</span><span class="n">status</span><span class="p">:</span>
<a id="__codelineno-5-32" name="__codelineno-5-32" href="#__codelineno-5-32"></a>                            <span class="n">postplay_market</span> <span class="o">=</span> <span class="n">market_book</span>
<a id="__codelineno-5-33" name="__codelineno-5-33" href="#__codelineno-5-33"></a>
<a id="__codelineno-5-34" name="__codelineno-5-34" href="#__codelineno-5-34"></a>                        <span class="c1"># update reference to previous market</span>
<a id="__codelineno-5-35" name="__codelineno-5-35" href="#__codelineno-5-35"></a>                        <span class="n">prev_market</span> <span class="o">=</span> <span class="n">market_book</span>
<a id="__codelineno-5-36" name="__codelineno-5-36" href="#__codelineno-5-36"></a>
<a id="__codelineno-5-37" name="__codelineno-5-37" href="#__codelineno-5-37"></a>                <span class="k">return</span> <span class="p">(</span><span class="n">preplay_market</span><span class="p">,</span> <span class="n">postplay_market</span><span class="p">,</span> <span class="n">prev_market</span><span class="p">)</span> <span class="c1"># prev is now final</span>
<a id="__codelineno-5-38" name="__codelineno-5-38" href="#__codelineno-5-38"></a>
<a id="__codelineno-5-39" name="__codelineno-5-39" href="#__codelineno-5-39"></a>            <span class="p">(</span><span class="n">preplay_market</span><span class="p">,</span> <span class="n">postplay_market</span><span class="p">,</span> <span class="n">final_market</span><span class="p">)</span> <span class="o">=</span> <span class="n">get_pre_post_final</span><span class="p">()</span>
<a id="__codelineno-5-40" name="__codelineno-5-40" href="#__codelineno-5-40"></a>
<a id="__codelineno-5-41" name="__codelineno-5-41" href="#__codelineno-5-41"></a>            <span class="c1"># no price data for market</span>
<a id="__codelineno-5-42" name="__codelineno-5-42" href="#__codelineno-5-42"></a>            <span class="k">if</span> <span class="n">postplay_market</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-5-43" name="__codelineno-5-43" href="#__codelineno-5-43"></a>                <span class="k">continue</span><span class="p">;</span> 
<a id="__codelineno-5-44" name="__codelineno-5-44" href="#__codelineno-5-44"></a>
<a id="__codelineno-5-45" name="__codelineno-5-45" href="#__codelineno-5-45"></a>            <span class="n">preplay_traded</span> <span class="o">=</span> <span class="p">[</span> <span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">last_price_traded</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">traded_volume</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">preplay_market</span><span class="o">.</span><span class="n">runners</span> <span class="p">]</span> <span class="k">if</span> <span class="n">preplay_market</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
<a id="__codelineno-5-46" name="__codelineno-5-46" href="#__codelineno-5-46"></a>
<a id="__codelineno-5-47" name="__codelineno-5-47" href="#__codelineno-5-47"></a>            <span class="n">postplay_traded</span> <span class="o">=</span> <span class="p">[</span> <span class="p">(</span>
<a id="__codelineno-5-48" name="__codelineno-5-48" href="#__codelineno-5-48"></a>                <span class="n">r</span><span class="o">.</span><span class="n">last_price_traded</span><span class="p">,</span>
<a id="__codelineno-5-49" name="__codelineno-5-49" href="#__codelineno-5-49"></a>                <span class="n">r</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">traded_volume</span><span class="p">,</span>
<a id="__codelineno-5-50" name="__codelineno-5-50" href="#__codelineno-5-50"></a>                <span class="c1"># calculating SP traded vol as smaller of back_stake_taken or (lay_liability_taken / (bsp - 1))        </span>
<a id="__codelineno-5-51" name="__codelineno-5-51" href="#__codelineno-5-51"></a>                <span class="n">min_gr0</span><span class="p">(</span>
<a id="__codelineno-5-52" name="__codelineno-5-52" href="#__codelineno-5-52"></a>                    <span class="nb">next</span><span class="p">((</span><span class="n">pv</span><span class="o">.</span><span class="n">size</span> <span class="k">for</span> <span class="n">pv</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">back_stake_taken</span> <span class="k">if</span> <span class="n">pv</span><span class="o">.</span><span class="n">size</span> <span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">0</span><span class="p">),</span>
<a id="__codelineno-5-53" name="__codelineno-5-53" href="#__codelineno-5-53"></a>                    <span class="nb">next</span><span class="p">((</span><span class="n">pv</span><span class="o">.</span><span class="n">size</span> <span class="k">for</span> <span class="n">pv</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">lay_liability_taken</span> <span class="k">if</span> <span class="n">pv</span><span class="o">.</span><span class="n">size</span> <span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>  <span class="o">/</span> <span class="p">((</span><span class="n">r</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">actual_sp</span> <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">actual_sp</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">actual_sp</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-5-54" name="__codelineno-5-54" href="#__codelineno-5-54"></a>                <span class="p">)</span> <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">actual_sp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-5-55" name="__codelineno-5-55" href="#__codelineno-5-55"></a>            <span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">postplay_market</span><span class="o">.</span><span class="n">runners</span> <span class="p">]</span>
<a id="__codelineno-5-56" name="__codelineno-5-56" href="#__codelineno-5-56"></a>
<a id="__codelineno-5-57" name="__codelineno-5-57" href="#__codelineno-5-57"></a>            <span class="n">runner_data</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-5-58" name="__codelineno-5-58" href="#__codelineno-5-58"></a>            <span class="p">{</span>
<a id="__codelineno-5-59" name="__codelineno-5-59" href="#__codelineno-5-59"></a>                <span class="s1">&#39;selection_id&#39;</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">selection_id</span><span class="p">,</span>
<a id="__codelineno-5-60" name="__codelineno-5-60" href="#__codelineno-5-60"></a>                <span class="s1">&#39;selection_name&#39;</span><span class="p">:</span> <span class="nb">next</span><span class="p">((</span><span class="n">rd</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">rd</span> <span class="ow">in</span> <span class="n">final_market</span><span class="o">.</span><span class="n">market_definition</span><span class="o">.</span><span class="n">runners</span> <span class="k">if</span> <span class="n">rd</span><span class="o">.</span><span class="n">selection_id</span> <span class="o">==</span> <span class="n">r</span><span class="o">.</span><span class="n">selection_id</span><span class="p">),</span> <span class="kc">None</span><span class="p">),</span>
<a id="__codelineno-5-61" name="__codelineno-5-61" href="#__codelineno-5-61"></a>                <span class="s1">&#39;selection_status&#39;</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
<a id="__codelineno-5-62" name="__codelineno-5-62" href="#__codelineno-5-62"></a>                <span class="s1">&#39;sp&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">actual_sp</span><span class="p">),</span>
<a id="__codelineno-5-63" name="__codelineno-5-63" href="#__codelineno-5-63"></a>            <span class="p">}</span>
<a id="__codelineno-5-64" name="__codelineno-5-64" href="#__codelineno-5-64"></a>            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">final_market</span><span class="o">.</span><span class="n">runners</span> 
<a id="__codelineno-5-65" name="__codelineno-5-65" href="#__codelineno-5-65"></a>            <span class="p">]</span>
<a id="__codelineno-5-66" name="__codelineno-5-66" href="#__codelineno-5-66"></a>
<a id="__codelineno-5-67" name="__codelineno-5-67" href="#__codelineno-5-67"></a>            <span class="c1"># runner price data for markets that go in play</span>
<a id="__codelineno-5-68" name="__codelineno-5-68" href="#__codelineno-5-68"></a>            <span class="k">if</span> <span class="n">preplay_traded</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-5-69" name="__codelineno-5-69" href="#__codelineno-5-69"></a>                <span class="k">def</span> <span class="nf">runner_vals</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
<a id="__codelineno-5-70" name="__codelineno-5-70" href="#__codelineno-5-70"></a>                    <span class="p">(</span><span class="n">pre_ltp</span><span class="p">,</span> <span class="n">pre_traded</span><span class="p">),</span> <span class="p">(</span><span class="n">post_ltp</span><span class="p">,</span> <span class="n">post_traded</span><span class="p">,</span> <span class="n">sp_traded</span><span class="p">)</span> <span class="o">=</span> <span class="n">r</span>
<a id="__codelineno-5-71" name="__codelineno-5-71" href="#__codelineno-5-71"></a>
<a id="__codelineno-5-72" name="__codelineno-5-72" href="#__codelineno-5-72"></a>                    <span class="n">inplay_only</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">ps</span><span class="p">:</span> <span class="n">ps</span><span class="o">.</span><span class="n">size</span> <span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="mi">0</span><span class="p">,</span> <span class="p">[</span>
<a id="__codelineno-5-73" name="__codelineno-5-73" href="#__codelineno-5-73"></a>                        <span class="n">PriceSize</span><span class="p">(</span>
<a id="__codelineno-5-74" name="__codelineno-5-74" href="#__codelineno-5-74"></a>                            <span class="n">price</span><span class="o">=</span><span class="n">post_ps</span><span class="o">.</span><span class="n">price</span><span class="p">,</span> 
<a id="__codelineno-5-75" name="__codelineno-5-75" href="#__codelineno-5-75"></a>                            <span class="n">size</span><span class="o">=</span><span class="n">post_ps</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="nb">next</span><span class="p">((</span><span class="n">pre_ps</span><span class="o">.</span><span class="n">size</span> <span class="k">for</span> <span class="n">pre_ps</span> <span class="ow">in</span> <span class="n">pre_traded</span> <span class="k">if</span> <span class="n">pre_ps</span><span class="o">.</span><span class="n">price</span> <span class="o">==</span> <span class="n">post_ps</span><span class="o">.</span><span class="n">price</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-5-76" name="__codelineno-5-76" href="#__codelineno-5-76"></a>                        <span class="p">)</span>
<a id="__codelineno-5-77" name="__codelineno-5-77" href="#__codelineno-5-77"></a>                        <span class="k">for</span> <span class="n">post_ps</span> <span class="ow">in</span> <span class="n">post_traded</span> 
<a id="__codelineno-5-78" name="__codelineno-5-78" href="#__codelineno-5-78"></a>                    <span class="p">]))</span>
<a id="__codelineno-5-79" name="__codelineno-5-79" href="#__codelineno-5-79"></a>
<a id="__codelineno-5-80" name="__codelineno-5-80" href="#__codelineno-5-80"></a>                    <span class="p">(</span><span class="n">ip_wavg</span><span class="p">,</span> <span class="n">ip_matched</span><span class="p">,</span> <span class="n">ip_min</span><span class="p">,</span> <span class="n">ip_max</span><span class="p">)</span> <span class="o">=</span> <span class="n">parse_traded</span><span class="p">(</span><span class="n">inplay_only</span><span class="p">)</span>
<a id="__codelineno-5-81" name="__codelineno-5-81" href="#__codelineno-5-81"></a>                    <span class="p">(</span><span class="n">pre_wavg</span><span class="p">,</span> <span class="n">pre_matched</span><span class="p">,</span> <span class="n">pre_min</span><span class="p">,</span> <span class="n">pre_max</span><span class="p">)</span> <span class="o">=</span> <span class="n">parse_traded</span><span class="p">(</span><span class="n">pre_traded</span><span class="p">)</span>
<a id="__codelineno-5-82" name="__codelineno-5-82" href="#__codelineno-5-82"></a>
<a id="__codelineno-5-83" name="__codelineno-5-83" href="#__codelineno-5-83"></a>                    <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-5-84" name="__codelineno-5-84" href="#__codelineno-5-84"></a>                        <span class="s1">&#39;preplay_ltp&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">pre_ltp</span><span class="p">),</span>
<a id="__codelineno-5-85" name="__codelineno-5-85" href="#__codelineno-5-85"></a>                        <span class="s1">&#39;preplay_min&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">pre_min</span><span class="p">),</span>
<a id="__codelineno-5-86" name="__codelineno-5-86" href="#__codelineno-5-86"></a>                        <span class="s1">&#39;preplay_max&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">pre_max</span><span class="p">),</span>
<a id="__codelineno-5-87" name="__codelineno-5-87" href="#__codelineno-5-87"></a>                        <span class="s1">&#39;preplay_wavg&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">pre_wavg</span><span class="p">),</span>
<a id="__codelineno-5-88" name="__codelineno-5-88" href="#__codelineno-5-88"></a>                        <span class="s1">&#39;preplay_matched&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">pre_matched</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">),</span>
<a id="__codelineno-5-89" name="__codelineno-5-89" href="#__codelineno-5-89"></a>                        <span class="s1">&#39;bsp_matched&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">sp_traded</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">),</span>
<a id="__codelineno-5-90" name="__codelineno-5-90" href="#__codelineno-5-90"></a>                        <span class="s1">&#39;inplay_ltp&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">post_ltp</span><span class="p">),</span>
<a id="__codelineno-5-91" name="__codelineno-5-91" href="#__codelineno-5-91"></a>                        <span class="s1">&#39;inplay_min&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">ip_min</span><span class="p">),</span>
<a id="__codelineno-5-92" name="__codelineno-5-92" href="#__codelineno-5-92"></a>                        <span class="s1">&#39;inplay_max&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">ip_max</span><span class="p">),</span>
<a id="__codelineno-5-93" name="__codelineno-5-93" href="#__codelineno-5-93"></a>                        <span class="s1">&#39;inplay_wavg&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">ip_wavg</span><span class="p">),</span>
<a id="__codelineno-5-94" name="__codelineno-5-94" href="#__codelineno-5-94"></a>                        <span class="s1">&#39;inplay_matched&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">ip_matched</span><span class="p">),</span>
<a id="__codelineno-5-95" name="__codelineno-5-95" href="#__codelineno-5-95"></a>                    <span class="p">}</span>
<a id="__codelineno-5-96" name="__codelineno-5-96" href="#__codelineno-5-96"></a>
<a id="__codelineno-5-97" name="__codelineno-5-97" href="#__codelineno-5-97"></a>                <span class="n">runner_traded</span> <span class="o">=</span> <span class="p">[</span> <span class="n">runner_vals</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">zip_longest</span><span class="p">(</span><span class="n">preplay_traded</span><span class="p">,</span> <span class="n">postplay_traded</span><span class="p">,</span> <span class="n">fillvalue</span><span class="o">=</span><span class="n">PriceSize</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">]</span>
<a id="__codelineno-5-98" name="__codelineno-5-98" href="#__codelineno-5-98"></a>
<a id="__codelineno-5-99" name="__codelineno-5-99" href="#__codelineno-5-99"></a>            <span class="c1"># runner price data for markets that don&#39;t go in play</span>
<a id="__codelineno-5-100" name="__codelineno-5-100" href="#__codelineno-5-100"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-5-101" name="__codelineno-5-101" href="#__codelineno-5-101"></a>                <span class="k">def</span> <span class="nf">runner_vals</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
<a id="__codelineno-5-102" name="__codelineno-5-102" href="#__codelineno-5-102"></a>                    <span class="p">(</span><span class="n">ltp</span><span class="p">,</span> <span class="n">traded</span><span class="p">,</span> <span class="n">sp_traded</span><span class="p">)</span> <span class="o">=</span> <span class="n">r</span>
<a id="__codelineno-5-103" name="__codelineno-5-103" href="#__codelineno-5-103"></a>                    <span class="p">(</span><span class="n">wavg</span><span class="p">,</span> <span class="n">matched</span><span class="p">,</span> <span class="n">min_price</span><span class="p">,</span> <span class="n">max_price</span><span class="p">)</span> <span class="o">=</span> <span class="n">parse_traded</span><span class="p">(</span><span class="n">traded</span><span class="p">)</span>
<a id="__codelineno-5-104" name="__codelineno-5-104" href="#__codelineno-5-104"></a>
<a id="__codelineno-5-105" name="__codelineno-5-105" href="#__codelineno-5-105"></a>                    <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-5-106" name="__codelineno-5-106" href="#__codelineno-5-106"></a>                        <span class="s1">&#39;preplay_ltp&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">ltp</span><span class="p">),</span>
<a id="__codelineno-5-107" name="__codelineno-5-107" href="#__codelineno-5-107"></a>                        <span class="s1">&#39;preplay_min&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">min_price</span><span class="p">),</span>
<a id="__codelineno-5-108" name="__codelineno-5-108" href="#__codelineno-5-108"></a>                        <span class="s1">&#39;preplay_max&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">max_price</span><span class="p">),</span>
<a id="__codelineno-5-109" name="__codelineno-5-109" href="#__codelineno-5-109"></a>                        <span class="s1">&#39;preplay_wavg&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">wavg</span><span class="p">),</span>
<a id="__codelineno-5-110" name="__codelineno-5-110" href="#__codelineno-5-110"></a>                        <span class="s1">&#39;preplay_matched&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">matched</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">),</span>
<a id="__codelineno-5-111" name="__codelineno-5-111" href="#__codelineno-5-111"></a>                        <span class="s1">&#39;bsp_matched&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">sp_traded</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">),</span>
<a id="__codelineno-5-112" name="__codelineno-5-112" href="#__codelineno-5-112"></a>                        <span class="s1">&#39;inplay_ltp&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
<a id="__codelineno-5-113" name="__codelineno-5-113" href="#__codelineno-5-113"></a>                        <span class="s1">&#39;inplay_min&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
<a id="__codelineno-5-114" name="__codelineno-5-114" href="#__codelineno-5-114"></a>                        <span class="s1">&#39;inplay_max&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
<a id="__codelineno-5-115" name="__codelineno-5-115" href="#__codelineno-5-115"></a>                        <span class="s1">&#39;inplay_wavg&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
<a id="__codelineno-5-116" name="__codelineno-5-116" href="#__codelineno-5-116"></a>                        <span class="s1">&#39;inplay_matched&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
<a id="__codelineno-5-117" name="__codelineno-5-117" href="#__codelineno-5-117"></a>                    <span class="p">}</span>
<a id="__codelineno-5-118" name="__codelineno-5-118" href="#__codelineno-5-118"></a>
<a id="__codelineno-5-119" name="__codelineno-5-119" href="#__codelineno-5-119"></a>                <span class="n">runner_traded</span> <span class="o">=</span> <span class="p">[</span> <span class="n">runner_vals</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">postplay_traded</span> <span class="p">]</span>
<a id="__codelineno-5-120" name="__codelineno-5-120" href="#__codelineno-5-120"></a>
<a id="__codelineno-5-121" name="__codelineno-5-121" href="#__codelineno-5-121"></a>            <span class="c1"># printing to csv for each runner</span>
<a id="__codelineno-5-122" name="__codelineno-5-122" href="#__codelineno-5-122"></a>            <span class="k">for</span> <span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="n">rprices</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">runner_data</span><span class="p">,</span> <span class="n">runner_traded</span><span class="p">):</span>
<a id="__codelineno-5-123" name="__codelineno-5-123" href="#__codelineno-5-123"></a>                <span class="c1"># defining data to go in each column</span>
<a id="__codelineno-5-124" name="__codelineno-5-124" href="#__codelineno-5-124"></a>                <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
<a id="__codelineno-5-125" name="__codelineno-5-125" href="#__codelineno-5-125"></a>                    <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
<a id="__codelineno-5-126" name="__codelineno-5-126" href="#__codelineno-5-126"></a>                        <span class="n">postplay_market</span><span class="o">.</span><span class="n">market_id</span><span class="p">,</span>
<a id="__codelineno-5-127" name="__codelineno-5-127" href="#__codelineno-5-127"></a>                        <span class="n">postplay_market</span><span class="o">.</span><span class="n">market_definition</span><span class="o">.</span><span class="n">market_time</span><span class="p">,</span>
<a id="__codelineno-5-128" name="__codelineno-5-128" href="#__codelineno-5-128"></a>                        <span class="n">postplay_market</span><span class="o">.</span><span class="n">market_definition</span><span class="o">.</span><span class="n">country_code</span><span class="p">,</span>
<a id="__codelineno-5-129" name="__codelineno-5-129" href="#__codelineno-5-129"></a>                        <span class="n">postplay_market</span><span class="o">.</span><span class="n">market_definition</span><span class="o">.</span><span class="n">venue</span><span class="p">,</span>
<a id="__codelineno-5-130" name="__codelineno-5-130" href="#__codelineno-5-130"></a>                        <span class="n">postplay_market</span><span class="o">.</span><span class="n">market_definition</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-5-131" name="__codelineno-5-131" href="#__codelineno-5-131"></a>                        <span class="n">rdata</span><span class="p">[</span><span class="s1">&#39;selection_id&#39;</span><span class="p">],</span>
<a id="__codelineno-5-132" name="__codelineno-5-132" href="#__codelineno-5-132"></a>                        <span class="n">rdata</span><span class="p">[</span><span class="s1">&#39;selection_name&#39;</span><span class="p">],</span>
<a id="__codelineno-5-133" name="__codelineno-5-133" href="#__codelineno-5-133"></a>                        <span class="n">rdata</span><span class="p">[</span><span class="s1">&#39;selection_status&#39;</span><span class="p">],</span>
<a id="__codelineno-5-134" name="__codelineno-5-134" href="#__codelineno-5-134"></a>                        <span class="n">rdata</span><span class="p">[</span><span class="s1">&#39;sp&#39;</span><span class="p">],</span>
<a id="__codelineno-5-135" name="__codelineno-5-135" href="#__codelineno-5-135"></a>                        <span class="n">rprices</span><span class="p">[</span><span class="s1">&#39;preplay_min&#39;</span><span class="p">],</span>
<a id="__codelineno-5-136" name="__codelineno-5-136" href="#__codelineno-5-136"></a>                        <span class="n">rprices</span><span class="p">[</span><span class="s1">&#39;preplay_max&#39;</span><span class="p">],</span>
<a id="__codelineno-5-137" name="__codelineno-5-137" href="#__codelineno-5-137"></a>                        <span class="n">rprices</span><span class="p">[</span><span class="s1">&#39;preplay_wavg&#39;</span><span class="p">],</span>
<a id="__codelineno-5-138" name="__codelineno-5-138" href="#__codelineno-5-138"></a>                        <span class="n">rprices</span><span class="p">[</span><span class="s1">&#39;preplay_ltp&#39;</span><span class="p">],</span>
<a id="__codelineno-5-139" name="__codelineno-5-139" href="#__codelineno-5-139"></a>                        <span class="n">rprices</span><span class="p">[</span><span class="s1">&#39;preplay_matched&#39;</span><span class="p">],</span>
<a id="__codelineno-5-140" name="__codelineno-5-140" href="#__codelineno-5-140"></a>                        <span class="n">rprices</span><span class="p">[</span><span class="s1">&#39;bsp_matched&#39;</span><span class="p">],</span>
<a id="__codelineno-5-141" name="__codelineno-5-141" href="#__codelineno-5-141"></a>                        <span class="n">rprices</span><span class="p">[</span><span class="s1">&#39;inplay_min&#39;</span><span class="p">],</span>
<a id="__codelineno-5-142" name="__codelineno-5-142" href="#__codelineno-5-142"></a>                        <span class="n">rprices</span><span class="p">[</span><span class="s1">&#39;inplay_max&#39;</span><span class="p">],</span>
<a id="__codelineno-5-143" name="__codelineno-5-143" href="#__codelineno-5-143"></a>                        <span class="n">rprices</span><span class="p">[</span><span class="s1">&#39;inplay_wavg&#39;</span><span class="p">],</span>
<a id="__codelineno-5-144" name="__codelineno-5-144" href="#__codelineno-5-144"></a>                        <span class="n">rprices</span><span class="p">[</span><span class="s1">&#39;inplay_ltp&#39;</span><span class="p">],</span>
<a id="__codelineno-5-145" name="__codelineno-5-145" href="#__codelineno-5-145"></a>                        <span class="n">rprices</span><span class="p">[</span><span class="s1">&#39;inplay_matched&#39;</span><span class="p">],</span>
<a id="__codelineno-5-146" name="__codelineno-5-146" href="#__codelineno-5-146"></a>                    <span class="p">)</span>
<a id="__codelineno-5-147" name="__codelineno-5-147" href="#__codelineno-5-147"></a>                <span class="p">)</span>
<a id="__codelineno-5-148" name="__codelineno-5-148" href="#__codelineno-5-148"></a>
<a id="__codelineno-5-149" name="__codelineno-5-149" href="#__codelineno-5-149"></a>
<a id="__codelineno-5-150" name="__codelineno-5-150" href="#__codelineno-5-150"></a>    <span class="c1">#loading selection file and parsing dates</span>
<a id="__codelineno-5-151" name="__codelineno-5-151" href="#__codelineno-5-151"></a>    <span class="n">selection</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">selection_meta</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;market_id&#39;</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="s1">&#39;selection_id&#39;</span><span class="p">:</span> <span class="nb">object</span><span class="p">},</span> <span class="n">parse_dates</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;event_date&#39;</span><span class="p">])</span>
<a id="__codelineno-5-152" name="__codelineno-5-152" href="#__codelineno-5-152"></a>
<a id="__codelineno-5-153" name="__codelineno-5-153" href="#__codelineno-5-153"></a>    <span class="c1">#loading price file and parsing dates</span>
<a id="__codelineno-5-154" name="__codelineno-5-154" href="#__codelineno-5-154"></a>    <span class="n">prices</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
<a id="__codelineno-5-155" name="__codelineno-5-155" href="#__codelineno-5-155"></a>        <span class="n">prices_path</span><span class="p">,</span> 
<a id="__codelineno-5-156" name="__codelineno-5-156" href="#__codelineno-5-156"></a>        <span class="n">quoting</span><span class="o">=</span><span class="n">csv</span><span class="o">.</span><span class="n">QUOTE_ALL</span><span class="p">,</span>
<a id="__codelineno-5-157" name="__codelineno-5-157" href="#__codelineno-5-157"></a>        <span class="n">dtype</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;market_id&#39;</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span><span class="p">,</span> <span class="s1">&#39;selection_id&#39;</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span><span class="p">,</span> <span class="s1">&#39;atb_ladder&#39;</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span><span class="p">,</span> <span class="s1">&#39;atl_ladder&#39;</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span><span class="p">},</span>
<a id="__codelineno-5-158" name="__codelineno-5-158" href="#__codelineno-5-158"></a>        <span class="n">parse_dates</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span>
<a id="__codelineno-5-159" name="__codelineno-5-159" href="#__codelineno-5-159"></a>    <span class="p">)</span>
<a id="__codelineno-5-160" name="__codelineno-5-160" href="#__codelineno-5-160"></a>
<a id="__codelineno-5-161" name="__codelineno-5-161" href="#__codelineno-5-161"></a>    <span class="c1">#creating the ladder as a dictionary</span>
<a id="__codelineno-5-162" name="__codelineno-5-162" href="#__codelineno-5-162"></a>    <span class="n">prices</span><span class="p">[</span><span class="s1">&#39;atb_ladder&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">prices</span><span class="p">[</span><span class="s1">&#39;atb_ladder&#39;</span><span class="p">]]</span>
<a id="__codelineno-5-163" name="__codelineno-5-163" href="#__codelineno-5-163"></a>    <span class="n">prices</span><span class="p">[</span><span class="s1">&#39;atl_ladder&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">prices</span><span class="p">[</span><span class="s1">&#39;atl_ladder&#39;</span><span class="p">]]</span>
<a id="__codelineno-5-164" name="__codelineno-5-164" href="#__codelineno-5-164"></a>
<a id="__codelineno-5-165" name="__codelineno-5-165" href="#__codelineno-5-165"></a>    <span class="c1">#merging the price and selection files</span>
<a id="__codelineno-5-166" name="__codelineno-5-166" href="#__codelineno-5-166"></a>    <span class="n">df</span> <span class="o">=</span> <span class="n">selection</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">on</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;market_id&#39;</span><span class="p">,</span> <span class="s1">&#39;selection_id&#39;</span><span class="p">])</span>
<a id="__codelineno-5-167" name="__codelineno-5-167" href="#__codelineno-5-167"></a>    <span class="c1">#assigning best prices available and calculating time relative to market start time</span>
<a id="__codelineno-5-168" name="__codelineno-5-168" href="#__codelineno-5-168"></a>    <span class="n">df</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-5-169" name="__codelineno-5-169" href="#__codelineno-5-169"></a>        <span class="n">df</span>
<a id="__codelineno-5-170" name="__codelineno-5-170" href="#__codelineno-5-170"></a>        <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">back_best</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;atb_ladder&#39;</span><span class="p">]])</span>
<a id="__codelineno-5-171" name="__codelineno-5-171" href="#__codelineno-5-171"></a>        <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">lay_best</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;atl_ladder&#39;</span><span class="p">]])</span>
<a id="__codelineno-5-172" name="__codelineno-5-172" href="#__codelineno-5-172"></a>        <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">seconds_before_scheduled_off</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">round</span><span class="p">((</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;event_date&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()))</span>
<a id="__codelineno-5-173" name="__codelineno-5-173" href="#__codelineno-5-173"></a>        <span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;seconds_before_scheduled_off &amp;lt; @log1_Start&#39;</span><span class="p">)</span>
<a id="__codelineno-5-174" name="__codelineno-5-174" href="#__codelineno-5-174"></a>    <span class="p">)</span>
<a id="__codelineno-5-175" name="__codelineno-5-175" href="#__codelineno-5-175"></a>
<a id="__codelineno-5-176" name="__codelineno-5-176" href="#__codelineno-5-176"></a>    <span class="c1">#creating a unique list of market ids</span>
<a id="__codelineno-5-177" name="__codelineno-5-177" href="#__codelineno-5-177"></a>    <span class="n">marketids</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;market_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<a id="__codelineno-5-178" name="__codelineno-5-178" href="#__codelineno-5-178"></a>
<a id="__codelineno-5-179" name="__codelineno-5-179" href="#__codelineno-5-179"></a>    <span class="c1">#writing each market to its own csv file</span>
<a id="__codelineno-5-180" name="__codelineno-5-180" href="#__codelineno-5-180"></a>    <span class="k">for</span> <span class="n">market</span> <span class="ow">in</span> <span class="n">marketids</span><span class="p">:</span>
<a id="__codelineno-5-181" name="__codelineno-5-181" href="#__codelineno-5-181"></a>        <span class="c1">#create a dataframe and a naming convention for this market</span>
<a id="__codelineno-5-182" name="__codelineno-5-182" href="#__codelineno-5-182"></a>        <span class="n">pricing_data</span><span class="o">=</span><span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;market_id&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">market</span><span class="p">)]</span>
<a id="__codelineno-5-183" name="__codelineno-5-183" href="#__codelineno-5-183"></a>        <span class="k">if</span> <span class="n">pricing_data</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
<a id="__codelineno-5-184" name="__codelineno-5-184" href="#__codelineno-5-184"></a>            <span class="k">continue</span>
<a id="__codelineno-5-185" name="__codelineno-5-185" href="#__codelineno-5-185"></a>        <span class="n">race_track</span><span class="o">=</span><span class="n">pricing_data</span><span class="p">[</span><span class="s1">&#39;track&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-5-186" name="__codelineno-5-186" href="#__codelineno-5-186"></a>        <span class="n">market_name</span><span class="o">=</span><span class="n">pricing_data</span><span class="p">[</span><span class="s1">&#39;event_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-5-187" name="__codelineno-5-187" href="#__codelineno-5-187"></a>        <span class="n">market_time</span><span class="o">=</span><span class="n">pricing_data</span><span class="p">[</span><span class="s1">&#39;event_date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-5-188" name="__codelineno-5-188" href="#__codelineno-5-188"></a>        <span class="n">off</span><span class="o">=</span><span class="n">market_time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-5-189" name="__codelineno-5-189" href="#__codelineno-5-189"></a>        <span class="c1">#write race details to the dataframe</span>
<a id="__codelineno-5-190" name="__codelineno-5-190" href="#__codelineno-5-190"></a>        <span class="n">pricing_data</span><span class="p">[</span><span class="s1">&#39;race&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">pricing_data</span><span class="p">[</span><span class="s1">&#39;event_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;R&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-5-191" name="__codelineno-5-191" href="#__codelineno-5-191"></a>        <span class="n">pricing_data</span><span class="p">[</span><span class="s1">&#39;race&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">pricing_data</span><span class="p">[</span><span class="s1">&#39;race&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-5-192" name="__codelineno-5-192" href="#__codelineno-5-192"></a>        <span class="n">pricing_data</span><span class="p">[</span><span class="s1">&#39;distance&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">pricing_data</span><span class="p">[</span><span class="s1">&#39;event_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-5-193" name="__codelineno-5-193" href="#__codelineno-5-193"></a>        <span class="n">pricing_data</span><span class="p">[</span><span class="s1">&#39;distance&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">pricing_data</span><span class="p">[</span><span class="s1">&#39;distance&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;m&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-5-194" name="__codelineno-5-194" href="#__codelineno-5-194"></a>        <span class="n">pricing_data</span><span class="p">[</span><span class="s1">&#39;race_type&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">pricing_data</span><span class="p">[</span><span class="s1">&#39;event_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;m &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-5-195" name="__codelineno-5-195" href="#__codelineno-5-195"></a>        <span class="n">pricing_data</span><span class="p">[</span><span class="s1">&#39;selection_name&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">pricing_data</span><span class="p">[</span><span class="s1">&#39;selection_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;\. &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-5-196" name="__codelineno-5-196" href="#__codelineno-5-196"></a>        <span class="c1">#convert GMT timezone to AEST/AEDT</span>
<a id="__codelineno-5-197" name="__codelineno-5-197" href="#__codelineno-5-197"></a>        <span class="n">pricing_data</span><span class="p">[</span><span class="s1">&#39;event_date&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">pricing_data</span><span class="p">[</span><span class="s1">&#39;event_date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;datetime64[ns]&#39;</span><span class="p">)</span>
<a id="__codelineno-5-198" name="__codelineno-5-198" href="#__codelineno-5-198"></a>        <span class="n">pricing_data</span><span class="p">[</span><span class="s1">&#39;event_date&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">pricing_data</span><span class="p">[</span><span class="s1">&#39;event_date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="s1">&#39;UTC&#39;</span><span class="p">,</span><span class="n">ambiguous</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-5-199" name="__codelineno-5-199" href="#__codelineno-5-199"></a>        <span class="n">pricing_data</span><span class="p">[</span><span class="s1">&#39;event_date&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">pricing_data</span><span class="p">[</span><span class="s1">&#39;event_date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">tz_convert</span><span class="p">(</span><span class="s1">&#39;Australia/Melbourne&#39;</span><span class="p">)</span>
<a id="__codelineno-5-200" name="__codelineno-5-200" href="#__codelineno-5-200"></a>        <span class="n">pricing_data</span><span class="p">[</span><span class="s1">&#39;event_date&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">pricing_data</span><span class="p">[</span><span class="s1">&#39;event_date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-5-201" name="__codelineno-5-201" href="#__codelineno-5-201"></a>        <span class="n">pricing_data</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">pricing_data</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;datetime64[ns]&#39;</span><span class="p">)</span>
<a id="__codelineno-5-202" name="__codelineno-5-202" href="#__codelineno-5-202"></a>        <span class="n">pricing_data</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">pricing_data</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="s1">&#39;UTC&#39;</span><span class="p">,</span><span class="n">ambiguous</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-5-203" name="__codelineno-5-203" href="#__codelineno-5-203"></a>        <span class="n">pricing_data</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">pricing_data</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">tz_convert</span><span class="p">(</span><span class="s1">&#39;Australia/Melbourne&#39;</span><span class="p">)</span>
<a id="__codelineno-5-204" name="__codelineno-5-204" href="#__codelineno-5-204"></a>        <span class="n">pricing_data</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">pricing_data</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-5-205" name="__codelineno-5-205" href="#__codelineno-5-205"></a>        <span class="c1">#covert GBP to AUD</span>
<a id="__codelineno-5-206" name="__codelineno-5-206" href="#__codelineno-5-206"></a>        <span class="n">event_date</span><span class="o">=</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">pricing_data</span><span class="p">[</span><span class="s1">&#39;event_date&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">)</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-5-207" name="__codelineno-5-207" href="#__codelineno-5-207"></a>        <span class="n">conversion_rate</span><span class="o">=</span><span class="n">CurrencyConverter</span><span class="p">(</span><span class="n">fallback_on_missing_rate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;GBP&#39;</span><span class="p">,</span><span class="s1">&#39;AUD&#39;</span><span class="p">,</span><span class="n">date</span><span class="o">=</span><span class="n">event_date</span><span class="p">)</span>
<a id="__codelineno-5-208" name="__codelineno-5-208" href="#__codelineno-5-208"></a>        <span class="n">pricing_data</span><span class="p">[</span><span class="s1">&#39;traded_volume&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">pricing_data</span><span class="p">[</span><span class="s1">&#39;traded_volume&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">conversion_rate</span>
<a id="__codelineno-5-209" name="__codelineno-5-209" href="#__codelineno-5-209"></a>        <span class="n">pricing_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">pricing_data</span><span class="p">[</span><span class="s1">&#39;traded_volume&#39;</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span> <span class="mi">0</span><span class="p">),</span> <span class="s1">&#39;traded_volume&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-5-210" name="__codelineno-5-210" href="#__codelineno-5-210"></a>        <span class="n">pricing_data</span><span class="p">[</span><span class="s1">&#39;traded_volume&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pricing_data</span><span class="p">[</span><span class="s1">&#39;traded_volume&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">decimals</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-5-211" name="__codelineno-5-211" href="#__codelineno-5-211"></a>        <span class="c1">#reorder the dataframe and write to csv</span>
<a id="__codelineno-5-212" name="__codelineno-5-212" href="#__codelineno-5-212"></a>        <span class="n">pricing_data</span><span class="o">=</span><span class="n">pricing_data</span><span class="p">[[</span><span class="s1">&#39;event_date&#39;</span><span class="p">,</span><span class="s1">&#39;country&#39;</span><span class="p">,</span><span class="s1">&#39;track&#39;</span><span class="p">,</span><span class="s1">&#39;race&#39;</span><span class="p">,</span><span class="s1">&#39;distance&#39;</span><span class="p">,</span><span class="s1">&#39;race_type&#39;</span><span class="p">,</span><span class="s1">&#39;market_id&#39;</span><span class="p">,</span><span class="s1">&#39;selection_id&#39;</span><span class="p">,</span><span class="s1">&#39;selection_name&#39;</span><span class="p">,</span><span class="s2">&quot;selection_status&quot;</span><span class="p">,</span><span class="s1">&#39;reduction_factor&#39;</span><span class="p">,</span><span class="s1">&#39;result&#39;</span><span class="p">,</span><span class="s1">&#39;bsp&#39;</span><span class="p">,</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;traded_volume&#39;</span><span class="p">,</span><span class="s1">&#39;wap&#39;</span><span class="p">,</span><span class="s1">&#39;ltp&#39;</span><span class="p">,</span><span class="s1">&#39;atb_ladder&#39;</span><span class="p">,</span><span class="s1">&#39;atl_ladder&#39;</span><span class="p">,</span><span class="s1">&#39;back_best&#39;</span><span class="p">,</span><span class="s1">&#39;lay_best&#39;</span><span class="p">,</span><span class="s1">&#39;seconds_before_scheduled_off&#39;</span><span class="p">,</span><span class="s1">&#39;sp_near&#39;</span><span class="p">,</span><span class="s1">&#39;sp_far&#39;</span><span class="p">,</span><span class="s1">&#39;pp_min&#39;</span><span class="p">,</span><span class="s1">&#39;pp_max&#39;</span><span class="p">,</span><span class="s1">&#39;pp_wap&#39;</span><span class="p">,</span><span class="s1">&#39;pp_ltp&#39;</span><span class="p">,</span><span class="s1">&#39;pp_volume&#39;</span><span class="p">,</span><span class="s1">&#39;bsp_volume&#39;</span><span class="p">,</span><span class="s1">&#39;ip_min&#39;</span><span class="p">,</span><span class="s1">&#39;ip_max&#39;</span><span class="p">,</span><span class="s1">&#39;ip_wap&#39;</span><span class="p">,</span><span class="s1">&#39;ip_ltp&#39;</span><span class="p">,</span><span class="s1">&#39;ip_volume&#39;</span><span class="p">]]</span>
<a id="__codelineno-5-213" name="__codelineno-5-213" href="#__codelineno-5-213"></a>        <span class="n">pricing_data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">file_directory</span><span class="o">+</span><span class="n">off</span><span class="o">+</span><span class="s1">&#39; - &#39;</span><span class="o">+</span><span class="n">race_track</span><span class="o">+</span><span class="s1">&#39; - &#39;</span><span class="o">+</span><span class="n">market_name</span><span class="o">+</span><span class="s1">&#39;.csv&#39;</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div>

</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="17-clean-up">1.7 Clean-Up</h3>
<p>The final piece is just to clean up and remove the intermediate files. If you're encountering errors with the final output, comment this code out so these intermediate files can be viewed.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="c1">#removing intermediate working documents to clean up</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">selection_meta</span><span class="p">)</span>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">prices_path</span><span class="p">)</span>
</code></pre></div>

</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="18-conclusion-and-next-steps">1.8 Conclusion and Next Steps</h3>
<p>If you'd like to expand your datasets, here's a list of other accessible data sources that can add additional datapoints and are fairly simple to join:</p>
<ul>
<li>Unsupported API endpoint for a day's racecard - <code>https://apigateway.betfair.com.au/hub/racecard?date=YYYY-MM-DD</code> (simply substitute your day at the end)</li>
<li>Unsupported API endpoint for market and runner metadata including Barrier, Trainer, Jockey and Best Tote Price - <code>https://apigateway.betfair.com.au/hub/raceevent/market_id</code> (simply substitute your market_id at the end including "1.")</li>
<li>Carrot Cruncher Horse Racing Model (url=<code>https://betfair-data-supplier-prod.herokuapp.com/api/widgets/kash-ratings-model/datasets?date='+YYYY-MM-DD+'&amp;presenter=RatingsPresenter&amp;csv=true</code>) (simply substitute your date in the middle). These ratings are available back to 18/2/21.</li>
<li>Iggy Joey Greyhound Model (url=<code>https://betfair-data-supplier-prod.herokuapp.com/api/widgets/iggy-joey/datasets?date='+YYYY-MM-DD+'&amp;presenter=RatingsPresenter&amp;csv=true</code>) (simply substitute your date in the middle)</li>
</ul>
<p>Hopefully this tutorial has helped and provides a great resource to be able to process these powerful, if cumbersome, TAR files and assists in your data gathering!</p>
<p>For further tutorials on how to handle these new CSV files to create a model - check out our suite of other tutorials in the <a href="https://betfair-datascientists.github.io/modelling/howToModel">modelling section</a> </p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="20-complete-code">2.0 Complete Code</h2>
<h3 id="21-complete-code-racing-processor">2.1 Complete Code Racing Processor</h3>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="kn">import</span> <span class="nn">os</span>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="kn">import</span> <span class="nn">csv</span>
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="kn">import</span> <span class="nn">csv</span>
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="kn">import</span> <span class="nn">tarfile</span>
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a><span class="kn">import</span> <span class="nn">zipfile</span>
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a><span class="kn">import</span> <span class="nn">bz2</span>
<a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a><span class="kn">import</span> <span class="nn">glob</span>
<a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a><span class="kn">import</span> <span class="nn">ast</span>
<a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a><span class="kn">from</span> <span class="nn">unittest.mock</span> <span class="kn">import</span> <span class="n">patch</span>
<a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a><span class="kn">import</span> <span class="nn">betfairlightweight</span>
<a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a><span class="kn">from</span> <span class="nn">betfairlightweight</span> <span class="kn">import</span> <span class="n">StreamListener</span>
<a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a><span class="kn">from</span> <span class="nn">betfair_data</span> <span class="kn">import</span> <span class="n">bflw</span>
<a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a><span class="kn">from</span> <span class="nn">betfair_data</span> <span class="kn">import</span> <span class="n">PriceSize</span>
<a id="__codelineno-7-17" name="__codelineno-7-17" href="#__codelineno-7-17"></a><span class="kn">import</span> <span class="nn">functools</span>
<a id="__codelineno-7-18" name="__codelineno-7-18" href="#__codelineno-7-18"></a><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span>
<a id="__codelineno-7-19" name="__codelineno-7-19" href="#__codelineno-7-19"></a><span class="kn">from</span> <span class="nn">pandas.errors</span> <span class="kn">import</span> <span class="n">SettingWithCopyWarning</span>
<a id="__codelineno-7-20" name="__codelineno-7-20" href="#__codelineno-7-20"></a><span class="kn">import</span> <span class="nn">warnings</span>
<a id="__codelineno-7-21" name="__codelineno-7-21" href="#__codelineno-7-21"></a><span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">SettingWithCopyWarning</span><span class="p">)</span>
<a id="__codelineno-7-22" name="__codelineno-7-22" href="#__codelineno-7-22"></a><span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">zip_longest</span>
<a id="__codelineno-7-23" name="__codelineno-7-23" href="#__codelineno-7-23"></a><span class="kn">from</span> <span class="nn">currency_converter</span> <span class="kn">import</span> <span class="n">CurrencyConverter</span>
<a id="__codelineno-7-24" name="__codelineno-7-24" href="#__codelineno-7-24"></a>
<a id="__codelineno-7-25" name="__codelineno-7-25" href="#__codelineno-7-25"></a><span class="n">file_directory</span><span class="o">=</span> <span class="s1">&#39;C:/Users/motykam/Documents/Thoroughbreds/&#39;</span> <span class="c1">#INSERT FILE DIRECTORY WHERE TAR FILES ARE STORED</span>
<a id="__codelineno-7-26" name="__codelineno-7-26" href="#__codelineno-7-26"></a>
<a id="__codelineno-7-27" name="__codelineno-7-27" href="#__codelineno-7-27"></a><span class="n">log1_Start</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">10</span> <span class="c1"># Seconds before scheduled off to start recording data for data segment one</span>
<a id="__codelineno-7-28" name="__codelineno-7-28" href="#__codelineno-7-28"></a><span class="n">log1_Step</span> <span class="o">=</span> <span class="mi">30</span>       <span class="c1"># Seconds between log steps for first data segment</span>
<a id="__codelineno-7-29" name="__codelineno-7-29" href="#__codelineno-7-29"></a><span class="n">log2_Start</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">1</span>  <span class="c1"># Seconds before scheduled off to start recording data for data segment two</span>
<a id="__codelineno-7-30" name="__codelineno-7-30" href="#__codelineno-7-30"></a><span class="n">log2_Step</span> <span class="o">=</span> <span class="mi">1</span>    <span class="c1"># Seconds between log steps for second data segment</span>
<a id="__codelineno-7-31" name="__codelineno-7-31" href="#__codelineno-7-31"></a>
<a id="__codelineno-7-32" name="__codelineno-7-32" href="#__codelineno-7-32"></a><span class="c1"># splitting race name and returning the parts </span>
<a id="__codelineno-7-33" name="__codelineno-7-33" href="#__codelineno-7-33"></a><span class="k">def</span> <span class="nf">split_anz_horse_market_name</span><span class="p">(</span><span class="n">market_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<a id="__codelineno-7-34" name="__codelineno-7-34" href="#__codelineno-7-34"></a>    <span class="c1"># return race no, length, race type</span>
<a id="__codelineno-7-35" name="__codelineno-7-35" href="#__codelineno-7-35"></a>    <span class="c1"># input samples: </span>
<a id="__codelineno-7-36" name="__codelineno-7-36" href="#__codelineno-7-36"></a>    <span class="c1"># &#39;R6 1400m Grp1&#39; -&amp;gt; (&#39;R6&#39;,&#39;1400m&#39;,&#39;grp1&#39;)</span>
<a id="__codelineno-7-37" name="__codelineno-7-37" href="#__codelineno-7-37"></a>    <span class="c1"># &#39;R1 1609m Trot M&#39; -&amp;gt; (&#39;R1&#39;, &#39;1609m&#39;, &#39;trot&#39;)</span>
<a id="__codelineno-7-38" name="__codelineno-7-38" href="#__codelineno-7-38"></a>    <span class="c1"># &#39;R4 1660m Pace M&#39; -&amp;gt; (&#39;R4&#39;, &#39;1660m&#39;, &#39;pace&#39;)</span>
<a id="__codelineno-7-39" name="__codelineno-7-39" href="#__codelineno-7-39"></a>    <span class="n">parts</span> <span class="o">=</span> <span class="n">market_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
<a id="__codelineno-7-40" name="__codelineno-7-40" href="#__codelineno-7-40"></a>    <span class="n">race_no</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> 
<a id="__codelineno-7-41" name="__codelineno-7-41" href="#__codelineno-7-41"></a>    <span class="n">race_len</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;m&#39;</span><span class="p">)</span>
<a id="__codelineno-7-42" name="__codelineno-7-42" href="#__codelineno-7-42"></a>    <span class="n">race_len</span> <span class="o">=</span> <span class="n">race_len</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-7-43" name="__codelineno-7-43" href="#__codelineno-7-43"></a>    <span class="n">race_type</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> 
<a id="__codelineno-7-44" name="__codelineno-7-44" href="#__codelineno-7-44"></a>    <span class="k">return</span> <span class="p">(</span><span class="n">race_no</span><span class="p">,</span> <span class="n">race_len</span><span class="p">,</span> <span class="n">race_type</span><span class="p">)</span>
<a id="__codelineno-7-45" name="__codelineno-7-45" href="#__codelineno-7-45"></a>
<a id="__codelineno-7-46" name="__codelineno-7-46" href="#__codelineno-7-46"></a><span class="c1"># filtering markets to those that fit the following criteria</span>
<a id="__codelineno-7-47" name="__codelineno-7-47" href="#__codelineno-7-47"></a><span class="k">def</span> <span class="nf">filter_market</span><span class="p">(</span><span class="n">market</span><span class="p">:</span> <span class="n">bflw</span><span class="o">.</span><span class="n">MarketBook</span><span class="p">)</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="nb">bool</span><span class="p">:</span> 
<a id="__codelineno-7-48" name="__codelineno-7-48" href="#__codelineno-7-48"></a>    <span class="n">d</span> <span class="o">=</span> <span class="n">market</span><span class="o">.</span><span class="n">market_definition</span>
<a id="__codelineno-7-49" name="__codelineno-7-49" href="#__codelineno-7-49"></a>    <span class="k">return</span> <span class="p">(</span><span class="n">d</span> <span class="o">!=</span> <span class="kc">None</span>
<a id="__codelineno-7-50" name="__codelineno-7-50" href="#__codelineno-7-50"></a>        <span class="ow">and</span> <span class="n">d</span><span class="o">.</span><span class="n">country_code</span> <span class="o">==</span> <span class="s1">&#39;AU&#39;</span> 
<a id="__codelineno-7-51" name="__codelineno-7-51" href="#__codelineno-7-51"></a>        <span class="ow">and</span> <span class="n">d</span><span class="o">.</span><span class="n">market_type</span> <span class="o">==</span> <span class="s1">&#39;WIN&#39;</span>
<a id="__codelineno-7-52" name="__codelineno-7-52" href="#__codelineno-7-52"></a>        <span class="ow">and</span> <span class="p">(</span><span class="n">c</span> <span class="o">:=</span> <span class="n">split_anz_horse_market_name</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">name</span><span class="p">)[</span><span class="mi">2</span><span class="p">])</span> <span class="o">!=</span> <span class="s1">&#39;trot&#39;</span> <span class="ow">and</span> <span class="n">c</span> <span class="o">!=</span> <span class="s1">&#39;pace&#39;</span> <span class="c1">#strips out Harness Races</span>
<a id="__codelineno-7-53" name="__codelineno-7-53" href="#__codelineno-7-53"></a>        <span class="c1">#and (c := split_anz_horse_market_name(d.name)[2]) == &#39;hcap&#39;</span>
<a id="__codelineno-7-54" name="__codelineno-7-54" href="#__codelineno-7-54"></a>        <span class="ow">and</span> <span class="p">(</span><span class="n">c</span> <span class="o">:=</span> <span class="n">split_anz_horse_market_name</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">name</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span><span class="o">=</span> <span class="s1">&#39;1200&#39;</span>
<a id="__codelineno-7-55" name="__codelineno-7-55" href="#__codelineno-7-55"></a>        <span class="p">)</span>
<a id="__codelineno-7-56" name="__codelineno-7-56" href="#__codelineno-7-56"></a>
<a id="__codelineno-7-57" name="__codelineno-7-57" href="#__codelineno-7-57"></a><span class="c1"># Simply add the below variable name to the market filter function above with the filter value</span>
<a id="__codelineno-7-58" name="__codelineno-7-58" href="#__codelineno-7-58"></a><span class="c1"># Equals (== &#39;Value in Quotation&#39; or True/False/None), Does Not Equal (!= &#39;Value in Quotation&#39; or True/False/None) - FOR ALL TYPES</span>
<a id="__codelineno-7-59" name="__codelineno-7-59" href="#__codelineno-7-59"></a><span class="c1"># Greater than (&amp;gt;), Greater than or equal to (&amp;gt;=), Less than (&amp;lt;), Less than or equal to (&amp;lt;=) - FOR INT/FLOAT</span>
<a id="__codelineno-7-60" name="__codelineno-7-60" href="#__codelineno-7-60"></a><span class="c1"># For list of value &#39;in&#39;</span>
<a id="__codelineno-7-61" name="__codelineno-7-61" href="#__codelineno-7-61"></a>
<a id="__codelineno-7-62" name="__codelineno-7-62" href="#__codelineno-7-62"></a><span class="c1"># and d.betting_type: str - ODDS, ASIAN_HANDICAP_SINGLES, ASIAN_HANDICAP_DOUBLES or LINE</span>
<a id="__codelineno-7-63" name="__codelineno-7-63" href="#__codelineno-7-63"></a><span class="c1"># and d.bsp_market: bool - True, False</span>
<a id="__codelineno-7-64" name="__codelineno-7-64" href="#__codelineno-7-64"></a><span class="c1"># and d.country_code: str - list of codes can be found here: https://en.wikipedia.org/wiki/ISO_3166-1_alpha-2 - Default value is &#39;GB&#39; - Australia = &#39;AU&#39;, New Zealand = &#39;NZ&#39;</span>
<a id="__codelineno-7-65" name="__codelineno-7-65" href="#__codelineno-7-65"></a><span class="c1"># and d.event_id: str - PARENT_EVENT_ID</span>
<a id="__codelineno-7-66" name="__codelineno-7-66" href="#__codelineno-7-66"></a><span class="c1"># and d.event_name: Optional[str] - Usually the name of the Match-Up (e.g. Bangladesh v Sri Lanka) or Race Meeting Name (e.g. Wangaratta (AUS) 1st Dec) - Note: Dictionaries don&#39;t support wildcard searches</span>
<a id="__codelineno-7-67" name="__codelineno-7-67" href="#__codelineno-7-67"></a><span class="c1"># and d.event_type_id: str - SportID [Horse Racing - 7, Greyhounds - 4339]</span>
<a id="__codelineno-7-68" name="__codelineno-7-68" href="#__codelineno-7-68"></a><span class="c1"># and d.market_base_rate: float - Market Commission Rate</span>
<a id="__codelineno-7-69" name="__codelineno-7-69" href="#__codelineno-7-69"></a><span class="c1"># and d.market_type: str - e.g. &quot;WIN&quot;</span>
<a id="__codelineno-7-70" name="__codelineno-7-70" href="#__codelineno-7-70"></a><span class="c1"># and d.name: Optional[str] - market name (e.g. R1 1170m Mdn)</span>
<a id="__codelineno-7-71" name="__codelineno-7-71" href="#__codelineno-7-71"></a><span class="c1"># and d.number_of_active_runners: int - number of horses/dogs in the race</span>
<a id="__codelineno-7-72" name="__codelineno-7-72" href="#__codelineno-7-72"></a><span class="c1"># and d.number_of_winners: int - Win market 1, Place markets 2+</span>
<a id="__codelineno-7-73" name="__codelineno-7-73" href="#__codelineno-7-73"></a><span class="c1"># and d.turn_in_play_enabled: bool - True, False</span>
<a id="__codelineno-7-74" name="__codelineno-7-74" href="#__codelineno-7-74"></a><span class="c1"># and d.venue: Optional[str] - Racing Only - Track</span>
<a id="__codelineno-7-75" name="__codelineno-7-75" href="#__codelineno-7-75"></a>
<a id="__codelineno-7-76" name="__codelineno-7-76" href="#__codelineno-7-76"></a><span class="n">trading</span> <span class="o">=</span> <span class="n">betfairlightweight</span><span class="o">.</span><span class="n">APIClient</span><span class="p">(</span><span class="n">username</span> <span class="o">=</span> <span class="s2">&quot;username&quot;</span><span class="p">,</span> <span class="n">password</span> <span class="o">=</span> <span class="s2">&quot;password&quot;</span><span class="p">,</span> <span class="n">app_key</span><span class="o">=</span><span class="s2">&quot;app_key&quot;</span><span class="p">)</span>
<a id="__codelineno-7-77" name="__codelineno-7-77" href="#__codelineno-7-77"></a><span class="n">listener</span> <span class="o">=</span> <span class="n">StreamListener</span><span class="p">(</span><span class="n">max_latency</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-7-78" name="__codelineno-7-78" href="#__codelineno-7-78"></a>
<a id="__codelineno-7-79" name="__codelineno-7-79" href="#__codelineno-7-79"></a><span class="n">stream_files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">file_directory</span><span class="o">+</span><span class="s2">&quot;*.tar&quot;</span><span class="p">)</span> 
<a id="__codelineno-7-80" name="__codelineno-7-80" href="#__codelineno-7-80"></a><span class="n">selection_meta</span> <span class="o">=</span> <span class="n">file_directory</span><span class="o">+</span><span class="s2">&quot;metadata.csv&quot;</span>
<a id="__codelineno-7-81" name="__codelineno-7-81" href="#__codelineno-7-81"></a><span class="n">prices_path</span> <span class="o">=</span>  <span class="n">file_directory</span><span class="o">+</span><span class="s2">&quot;preplay.csv&quot;</span>
<a id="__codelineno-7-82" name="__codelineno-7-82" href="#__codelineno-7-82"></a>
<a id="__codelineno-7-83" name="__codelineno-7-83" href="#__codelineno-7-83"></a><span class="c1"># rounding to 2 decimal places or returning &#39;&#39; if blank</span>
<a id="__codelineno-7-84" name="__codelineno-7-84" href="#__codelineno-7-84"></a><span class="k">def</span> <span class="nf">as_str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-7-85" name="__codelineno-7-85" href="#__codelineno-7-85"></a>    <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">v</span> <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="n">v</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
<a id="__codelineno-7-86" name="__codelineno-7-86" href="#__codelineno-7-86"></a>
<a id="__codelineno-7-87" name="__codelineno-7-87" href="#__codelineno-7-87"></a><span class="c1"># returning smaller of two numbers where min not 0</span>
<a id="__codelineno-7-88" name="__codelineno-7-88" href="#__codelineno-7-88"></a><span class="k">def</span> <span class="nf">min_gr0</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="nb">float</span><span class="p">:</span>
<a id="__codelineno-7-89" name="__codelineno-7-89" href="#__codelineno-7-89"></a>    <span class="k">if</span> <span class="n">a</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="o">=</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-7-90" name="__codelineno-7-90" href="#__codelineno-7-90"></a>        <span class="k">return</span> <span class="n">b</span>
<a id="__codelineno-7-91" name="__codelineno-7-91" href="#__codelineno-7-91"></a>    <span class="k">if</span> <span class="n">b</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="o">=</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-7-92" name="__codelineno-7-92" href="#__codelineno-7-92"></a>        <span class="k">return</span> <span class="n">a</span>
<a id="__codelineno-7-93" name="__codelineno-7-93" href="#__codelineno-7-93"></a>
<a id="__codelineno-7-94" name="__codelineno-7-94" href="#__codelineno-7-94"></a>    <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
<a id="__codelineno-7-95" name="__codelineno-7-95" href="#__codelineno-7-95"></a>
<a id="__codelineno-7-96" name="__codelineno-7-96" href="#__codelineno-7-96"></a><span class="c1"># parsing price data and pulling out weighted avg price, matched, min price and max price</span>
<a id="__codelineno-7-97" name="__codelineno-7-97" href="#__codelineno-7-97"></a><span class="k">def</span> <span class="nf">parse_traded</span><span class="p">(</span><span class="n">traded</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">PriceSize</span><span class="p">])</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<a id="__codelineno-7-98" name="__codelineno-7-98" href="#__codelineno-7-98"></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">traded</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> 
<a id="__codelineno-7-99" name="__codelineno-7-99" href="#__codelineno-7-99"></a>        <span class="k">return</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-7-100" name="__codelineno-7-100" href="#__codelineno-7-100"></a>
<a id="__codelineno-7-101" name="__codelineno-7-101" href="#__codelineno-7-101"></a>    <span class="p">(</span><span class="n">wavg_sum</span><span class="p">,</span> <span class="n">matched</span><span class="p">,</span> <span class="n">min_price</span><span class="p">,</span> <span class="n">max_price</span><span class="p">)</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span>
<a id="__codelineno-7-102" name="__codelineno-7-102" href="#__codelineno-7-102"></a>        <span class="k">lambda</span> <span class="n">total</span><span class="p">,</span> <span class="n">ps</span><span class="p">:</span> <span class="p">(</span>
<a id="__codelineno-7-103" name="__codelineno-7-103" href="#__codelineno-7-103"></a>            <span class="n">total</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">ps</span><span class="o">.</span><span class="n">price</span> <span class="o">*</span> <span class="n">ps</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="c1"># wavg_sum before we divide by total matched</span>
<a id="__codelineno-7-104" name="__codelineno-7-104" href="#__codelineno-7-104"></a>            <span class="n">total</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">ps</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="c1"># total matched</span>
<a id="__codelineno-7-105" name="__codelineno-7-105" href="#__codelineno-7-105"></a>            <span class="nb">min</span><span class="p">(</span><span class="n">total</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">ps</span><span class="o">.</span><span class="n">price</span><span class="p">),</span> <span class="c1"># min price matched</span>
<a id="__codelineno-7-106" name="__codelineno-7-106" href="#__codelineno-7-106"></a>            <span class="nb">max</span><span class="p">(</span><span class="n">total</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">ps</span><span class="o">.</span><span class="n">price</span><span class="p">),</span> <span class="c1"># max price matched</span>
<a id="__codelineno-7-107" name="__codelineno-7-107" href="#__codelineno-7-107"></a>        <span class="p">),</span>
<a id="__codelineno-7-108" name="__codelineno-7-108" href="#__codelineno-7-108"></a>        <span class="n">traded</span><span class="p">,</span>
<a id="__codelineno-7-109" name="__codelineno-7-109" href="#__codelineno-7-109"></a>        <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1001</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c1"># starting default values</span>
<a id="__codelineno-7-110" name="__codelineno-7-110" href="#__codelineno-7-110"></a>    <span class="p">)</span>
<a id="__codelineno-7-111" name="__codelineno-7-111" href="#__codelineno-7-111"></a>
<a id="__codelineno-7-112" name="__codelineno-7-112" href="#__codelineno-7-112"></a>    <span class="n">wavg_sum</span> <span class="o">=</span> <span class="p">(</span><span class="n">wavg_sum</span> <span class="o">/</span> <span class="n">matched</span><span class="p">)</span> <span class="k">if</span> <span class="n">matched</span> <span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span> <span class="c1"># dividing sum of wavg by total matched</span>
<a id="__codelineno-7-113" name="__codelineno-7-113" href="#__codelineno-7-113"></a>    <span class="n">matched</span> <span class="o">=</span> <span class="n">matched</span> <span class="k">if</span> <span class="n">matched</span> <span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span> 
<a id="__codelineno-7-114" name="__codelineno-7-114" href="#__codelineno-7-114"></a>    <span class="n">min_price</span> <span class="o">=</span> <span class="n">min_price</span> <span class="k">if</span> <span class="n">min_price</span> <span class="o">!=</span> <span class="mi">1001</span> <span class="k">else</span> <span class="kc">None</span>
<a id="__codelineno-7-115" name="__codelineno-7-115" href="#__codelineno-7-115"></a>    <span class="n">max_price</span> <span class="o">=</span> <span class="n">max_price</span> <span class="k">if</span> <span class="n">max_price</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span>
<a id="__codelineno-7-116" name="__codelineno-7-116" href="#__codelineno-7-116"></a>
<a id="__codelineno-7-117" name="__codelineno-7-117" href="#__codelineno-7-117"></a>    <span class="k">return</span> <span class="p">(</span><span class="n">wavg_sum</span><span class="p">,</span> <span class="n">matched</span><span class="p">,</span> <span class="n">min_price</span><span class="p">,</span> <span class="n">max_price</span><span class="p">)</span>
<a id="__codelineno-7-118" name="__codelineno-7-118" href="#__codelineno-7-118"></a>
<a id="__codelineno-7-119" name="__codelineno-7-119" href="#__codelineno-7-119"></a>
<a id="__codelineno-7-120" name="__codelineno-7-120" href="#__codelineno-7-120"></a><span class="k">def</span> <span class="nf">load_markets</span><span class="p">(</span><span class="n">file_paths</span><span class="p">):</span>
<a id="__codelineno-7-121" name="__codelineno-7-121" href="#__codelineno-7-121"></a>    <span class="k">for</span> <span class="n">file_path</span> <span class="ow">in</span> <span class="n">file_paths</span><span class="p">:</span>
<a id="__codelineno-7-122" name="__codelineno-7-122" href="#__codelineno-7-122"></a>        <span class="nb">print</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
<a id="__codelineno-7-123" name="__codelineno-7-123" href="#__codelineno-7-123"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;__ Parsing Detailed Prices ___ &quot;</span><span class="p">)</span>
<a id="__codelineno-7-124" name="__codelineno-7-124" href="#__codelineno-7-124"></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
<a id="__codelineno-7-125" name="__codelineno-7-125" href="#__codelineno-7-125"></a>            <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">iglob</span><span class="p">(</span><span class="n">file_path</span> <span class="o">+</span> <span class="s1">&#39;**/**/*.bz2&#39;</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<a id="__codelineno-7-126" name="__codelineno-7-126" href="#__codelineno-7-126"></a>                <span class="n">f</span> <span class="o">=</span> <span class="n">bz2</span><span class="o">.</span><span class="n">BZ2File</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
<a id="__codelineno-7-127" name="__codelineno-7-127" href="#__codelineno-7-127"></a>                <span class="k">yield</span> <span class="n">f</span>
<a id="__codelineno-7-128" name="__codelineno-7-128" href="#__codelineno-7-128"></a>                <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<a id="__codelineno-7-129" name="__codelineno-7-129" href="#__codelineno-7-129"></a>        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
<a id="__codelineno-7-130" name="__codelineno-7-130" href="#__codelineno-7-130"></a>            <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file_path</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-7-131" name="__codelineno-7-131" href="#__codelineno-7-131"></a>            <span class="c1"># iterate through a tar archive</span>
<a id="__codelineno-7-132" name="__codelineno-7-132" href="#__codelineno-7-132"></a>            <span class="k">if</span> <span class="n">ext</span> <span class="o">==</span> <span class="s1">&#39;.tar&#39;</span><span class="p">:</span>
<a id="__codelineno-7-133" name="__codelineno-7-133" href="#__codelineno-7-133"></a>                <span class="k">with</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">TarFile</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">archive</span><span class="p">:</span>
<a id="__codelineno-7-134" name="__codelineno-7-134" href="#__codelineno-7-134"></a>                    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">archive</span><span class="p">:</span>
<a id="__codelineno-7-135" name="__codelineno-7-135" href="#__codelineno-7-135"></a>                        <span class="k">yield</span> <span class="n">bz2</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">archive</span><span class="o">.</span><span class="n">extractfile</span><span class="p">(</span><span class="n">file</span><span class="p">))</span>
<a id="__codelineno-7-136" name="__codelineno-7-136" href="#__codelineno-7-136"></a>            <span class="c1"># or a zip archive</span>
<a id="__codelineno-7-137" name="__codelineno-7-137" href="#__codelineno-7-137"></a>            <span class="k">elif</span> <span class="n">ext</span> <span class="o">==</span> <span class="s1">&#39;.zip&#39;</span><span class="p">:</span>
<a id="__codelineno-7-138" name="__codelineno-7-138" href="#__codelineno-7-138"></a>                <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">archive</span><span class="p">:</span>
<a id="__codelineno-7-139" name="__codelineno-7-139" href="#__codelineno-7-139"></a>                    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">archive</span><span class="o">.</span><span class="n">namelist</span><span class="p">():</span>
<a id="__codelineno-7-140" name="__codelineno-7-140" href="#__codelineno-7-140"></a>                        <span class="k">yield</span> <span class="n">bz2</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">archive</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file</span><span class="p">))</span>
<a id="__codelineno-7-141" name="__codelineno-7-141" href="#__codelineno-7-141"></a>
<a id="__codelineno-7-142" name="__codelineno-7-142" href="#__codelineno-7-142"></a>    <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-7-143" name="__codelineno-7-143" href="#__codelineno-7-143"></a>
<a id="__codelineno-7-144" name="__codelineno-7-144" href="#__codelineno-7-144"></a><span class="k">def</span> <span class="nf">slicePrice</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
<a id="__codelineno-7-145" name="__codelineno-7-145" href="#__codelineno-7-145"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-7-146" name="__codelineno-7-146" href="#__codelineno-7-146"></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">price</span>
<a id="__codelineno-7-147" name="__codelineno-7-147" href="#__codelineno-7-147"></a>    <span class="k">except</span><span class="p">:</span>
<a id="__codelineno-7-148" name="__codelineno-7-148" href="#__codelineno-7-148"></a>        <span class="n">x</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-7-149" name="__codelineno-7-149" href="#__codelineno-7-149"></a>    <span class="k">return</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-7-150" name="__codelineno-7-150" href="#__codelineno-7-150"></a>
<a id="__codelineno-7-151" name="__codelineno-7-151" href="#__codelineno-7-151"></a><span class="k">def</span> <span class="nf">sliceSize</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
<a id="__codelineno-7-152" name="__codelineno-7-152" href="#__codelineno-7-152"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-7-153" name="__codelineno-7-153" href="#__codelineno-7-153"></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">size</span>
<a id="__codelineno-7-154" name="__codelineno-7-154" href="#__codelineno-7-154"></a>    <span class="k">except</span><span class="p">:</span>
<a id="__codelineno-7-155" name="__codelineno-7-155" href="#__codelineno-7-155"></a>        <span class="n">x</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-7-156" name="__codelineno-7-156" href="#__codelineno-7-156"></a>    <span class="k">return</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-7-157" name="__codelineno-7-157" href="#__codelineno-7-157"></a>
<a id="__codelineno-7-158" name="__codelineno-7-158" href="#__codelineno-7-158"></a><span class="k">def</span> <span class="nf">pull_ladder</span><span class="p">(</span><span class="n">availableLadder</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">5</span><span class="p">):</span>
<a id="__codelineno-7-159" name="__codelineno-7-159" href="#__codelineno-7-159"></a>        <span class="n">out</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-7-160" name="__codelineno-7-160" href="#__codelineno-7-160"></a>        <span class="n">price</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-7-161" name="__codelineno-7-161" href="#__codelineno-7-161"></a>        <span class="n">volume</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-7-162" name="__codelineno-7-162" href="#__codelineno-7-162"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">availableLadder</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-7-163" name="__codelineno-7-163" href="#__codelineno-7-163"></a>            <span class="k">return</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>        
<a id="__codelineno-7-164" name="__codelineno-7-164" href="#__codelineno-7-164"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-7-165" name="__codelineno-7-165" href="#__codelineno-7-165"></a>            <span class="k">for</span> <span class="n">rung</span> <span class="ow">in</span> <span class="n">availableLadder</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">n</span><span class="p">]:</span>
<a id="__codelineno-7-166" name="__codelineno-7-166" href="#__codelineno-7-166"></a>                <span class="n">price</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rung</span><span class="o">.</span><span class="n">price</span><span class="p">)</span>
<a id="__codelineno-7-167" name="__codelineno-7-167" href="#__codelineno-7-167"></a>                <span class="n">volume</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rung</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
<a id="__codelineno-7-168" name="__codelineno-7-168" href="#__codelineno-7-168"></a>
<a id="__codelineno-7-169" name="__codelineno-7-169" href="#__codelineno-7-169"></a>            <span class="n">out</span><span class="p">[</span><span class="s2">&quot;p&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">price</span>
<a id="__codelineno-7-170" name="__codelineno-7-170" href="#__codelineno-7-170"></a>            <span class="n">out</span><span class="p">[</span><span class="s2">&quot;v&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">volume</span>
<a id="__codelineno-7-171" name="__codelineno-7-171" href="#__codelineno-7-171"></a>            <span class="k">return</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
<a id="__codelineno-7-172" name="__codelineno-7-172" href="#__codelineno-7-172"></a>
<a id="__codelineno-7-173" name="__codelineno-7-173" href="#__codelineno-7-173"></a><span class="k">def</span> <span class="nf">final_market_book</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
<a id="__codelineno-7-174" name="__codelineno-7-174" href="#__codelineno-7-174"></a>
<a id="__codelineno-7-175" name="__codelineno-7-175" href="#__codelineno-7-175"></a>    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s2">&quot;builtins.open&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">f</span><span class="p">,</span> <span class="n">_</span><span class="p">:</span> <span class="n">f</span><span class="p">):</span>
<a id="__codelineno-7-176" name="__codelineno-7-176" href="#__codelineno-7-176"></a>
<a id="__codelineno-7-177" name="__codelineno-7-177" href="#__codelineno-7-177"></a>        <span class="n">gen</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">get_generator</span><span class="p">()</span>
<a id="__codelineno-7-178" name="__codelineno-7-178" href="#__codelineno-7-178"></a>
<a id="__codelineno-7-179" name="__codelineno-7-179" href="#__codelineno-7-179"></a>        <span class="k">for</span> <span class="n">market_books</span> <span class="ow">in</span> <span class="n">gen</span><span class="p">():</span>
<a id="__codelineno-7-180" name="__codelineno-7-180" href="#__codelineno-7-180"></a>
<a id="__codelineno-7-181" name="__codelineno-7-181" href="#__codelineno-7-181"></a>            <span class="c1"># Check if this market book meets our market filter ++++++++++++++++++++++++++++++++++</span>
<a id="__codelineno-7-182" name="__codelineno-7-182" href="#__codelineno-7-182"></a>
<a id="__codelineno-7-183" name="__codelineno-7-183" href="#__codelineno-7-183"></a>            <span class="k">if</span> <span class="p">((</span><span class="n">evaluate_market</span> <span class="o">:=</span> <span class="n">filter_market</span><span class="p">(</span><span class="n">market_books</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">==</span> <span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-7-184" name="__codelineno-7-184" href="#__codelineno-7-184"></a>                    <span class="k">return</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-7-185" name="__codelineno-7-185" href="#__codelineno-7-185"></a>
<a id="__codelineno-7-186" name="__codelineno-7-186" href="#__codelineno-7-186"></a>            <span class="k">for</span> <span class="n">market_book</span> <span class="ow">in</span> <span class="n">market_books</span><span class="p">:</span>
<a id="__codelineno-7-187" name="__codelineno-7-187" href="#__codelineno-7-187"></a>
<a id="__codelineno-7-188" name="__codelineno-7-188" href="#__codelineno-7-188"></a>                <span class="n">last_market_book</span> <span class="o">=</span> <span class="n">market_book</span>
<a id="__codelineno-7-189" name="__codelineno-7-189" href="#__codelineno-7-189"></a>
<a id="__codelineno-7-190" name="__codelineno-7-190" href="#__codelineno-7-190"></a>        <span class="k">return</span><span class="p">(</span><span class="n">last_market_book</span><span class="p">)</span>
<a id="__codelineno-7-191" name="__codelineno-7-191" href="#__codelineno-7-191"></a>
<a id="__codelineno-7-192" name="__codelineno-7-192" href="#__codelineno-7-192"></a><span class="k">def</span> <span class="nf">loop_prices</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">o</span><span class="p">):</span>
<a id="__codelineno-7-193" name="__codelineno-7-193" href="#__codelineno-7-193"></a>
<a id="__codelineno-7-194" name="__codelineno-7-194" href="#__codelineno-7-194"></a>    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s2">&quot;builtins.open&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">f</span><span class="p">,</span> <span class="n">_</span><span class="p">:</span> <span class="n">f</span><span class="p">):</span>
<a id="__codelineno-7-195" name="__codelineno-7-195" href="#__codelineno-7-195"></a>
<a id="__codelineno-7-196" name="__codelineno-7-196" href="#__codelineno-7-196"></a>        <span class="n">gen</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">get_generator</span><span class="p">()</span>
<a id="__codelineno-7-197" name="__codelineno-7-197" href="#__codelineno-7-197"></a>
<a id="__codelineno-7-198" name="__codelineno-7-198" href="#__codelineno-7-198"></a>        <span class="n">marketID</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-7-199" name="__codelineno-7-199" href="#__codelineno-7-199"></a>        <span class="n">tradeVols</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-7-200" name="__codelineno-7-200" href="#__codelineno-7-200"></a>        <span class="n">time</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-7-201" name="__codelineno-7-201" href="#__codelineno-7-201"></a>
<a id="__codelineno-7-202" name="__codelineno-7-202" href="#__codelineno-7-202"></a>        <span class="k">for</span> <span class="n">market_books</span> <span class="ow">in</span> <span class="n">gen</span><span class="p">():</span>
<a id="__codelineno-7-203" name="__codelineno-7-203" href="#__codelineno-7-203"></a>
<a id="__codelineno-7-204" name="__codelineno-7-204" href="#__codelineno-7-204"></a>            <span class="c1"># Check if this market book meets our market filter ++++++++++++++++++++++++++++++++++</span>
<a id="__codelineno-7-205" name="__codelineno-7-205" href="#__codelineno-7-205"></a>
<a id="__codelineno-7-206" name="__codelineno-7-206" href="#__codelineno-7-206"></a>            <span class="k">if</span> <span class="p">((</span><span class="n">evaluate_market</span> <span class="o">:=</span> <span class="n">filter_market</span><span class="p">(</span><span class="n">market_books</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">==</span> <span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-7-207" name="__codelineno-7-207" href="#__codelineno-7-207"></a>                    <span class="k">break</span>
<a id="__codelineno-7-208" name="__codelineno-7-208" href="#__codelineno-7-208"></a>
<a id="__codelineno-7-209" name="__codelineno-7-209" href="#__codelineno-7-209"></a>            <span class="k">for</span> <span class="n">market_book</span> <span class="ow">in</span> <span class="n">market_books</span><span class="p">:</span>
<a id="__codelineno-7-210" name="__codelineno-7-210" href="#__codelineno-7-210"></a>
<a id="__codelineno-7-211" name="__codelineno-7-211" href="#__codelineno-7-211"></a>                <span class="c1"># Time Step Management ++++++++++++++++++++++++++++++++++</span>
<a id="__codelineno-7-212" name="__codelineno-7-212" href="#__codelineno-7-212"></a>
<a id="__codelineno-7-213" name="__codelineno-7-213" href="#__codelineno-7-213"></a>                <span class="k">if</span> <span class="n">marketID</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-7-214" name="__codelineno-7-214" href="#__codelineno-7-214"></a>
<a id="__codelineno-7-215" name="__codelineno-7-215" href="#__codelineno-7-215"></a>                    <span class="c1"># No market initialised</span>
<a id="__codelineno-7-216" name="__codelineno-7-216" href="#__codelineno-7-216"></a>                    <span class="n">marketID</span> <span class="o">=</span> <span class="n">market_book</span><span class="o">.</span><span class="n">market_id</span>
<a id="__codelineno-7-217" name="__codelineno-7-217" href="#__codelineno-7-217"></a>                    <span class="n">time</span> <span class="o">=</span>  <span class="n">market_book</span><span class="o">.</span><span class="n">publish_time</span>
<a id="__codelineno-7-218" name="__codelineno-7-218" href="#__codelineno-7-218"></a>
<a id="__codelineno-7-219" name="__codelineno-7-219" href="#__codelineno-7-219"></a>                <span class="k">elif</span> <span class="n">market_book</span><span class="o">.</span><span class="n">inplay</span><span class="p">:</span>
<a id="__codelineno-7-220" name="__codelineno-7-220" href="#__codelineno-7-220"></a>
<a id="__codelineno-7-221" name="__codelineno-7-221" href="#__codelineno-7-221"></a>                    <span class="c1"># Stop once market inplay</span>
<a id="__codelineno-7-222" name="__codelineno-7-222" href="#__codelineno-7-222"></a>                    <span class="k">break</span>
<a id="__codelineno-7-223" name="__codelineno-7-223" href="#__codelineno-7-223"></a>
<a id="__codelineno-7-224" name="__codelineno-7-224" href="#__codelineno-7-224"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-7-225" name="__codelineno-7-225" href="#__codelineno-7-225"></a>
<a id="__codelineno-7-226" name="__codelineno-7-226" href="#__codelineno-7-226"></a>                    <span class="n">seconds_to_start</span> <span class="o">=</span> <span class="p">(</span><span class="n">market_book</span><span class="o">.</span><span class="n">market_definition</span><span class="o">.</span><span class="n">market_time</span> <span class="o">-</span> <span class="n">market_book</span><span class="o">.</span><span class="n">publish_time</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
<a id="__codelineno-7-227" name="__codelineno-7-227" href="#__codelineno-7-227"></a>
<a id="__codelineno-7-228" name="__codelineno-7-228" href="#__codelineno-7-228"></a>                    <span class="k">if</span> <span class="n">seconds_to_start</span> <span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="n">log1_Start</span><span class="p">:</span>
<a id="__codelineno-7-229" name="__codelineno-7-229" href="#__codelineno-7-229"></a>
<a id="__codelineno-7-230" name="__codelineno-7-230" href="#__codelineno-7-230"></a>                        <span class="c1"># Too early before off to start logging prices</span>
<a id="__codelineno-7-231" name="__codelineno-7-231" href="#__codelineno-7-231"></a>                        <span class="k">continue</span>
<a id="__codelineno-7-232" name="__codelineno-7-232" href="#__codelineno-7-232"></a>
<a id="__codelineno-7-233" name="__codelineno-7-233" href="#__codelineno-7-233"></a>                    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-7-234" name="__codelineno-7-234" href="#__codelineno-7-234"></a>
<a id="__codelineno-7-235" name="__codelineno-7-235" href="#__codelineno-7-235"></a>                        <span class="c1"># Update data at different time steps depending on seconds to off</span>
<a id="__codelineno-7-236" name="__codelineno-7-236" href="#__codelineno-7-236"></a>                        <span class="n">wait</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">seconds_to_start</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="o">=</span> <span class="n">log2_Start</span><span class="p">,</span> <span class="n">log2_Step</span><span class="p">,</span> <span class="n">log1_Step</span><span class="p">)</span>
<a id="__codelineno-7-237" name="__codelineno-7-237" href="#__codelineno-7-237"></a>
<a id="__codelineno-7-238" name="__codelineno-7-238" href="#__codelineno-7-238"></a>                        <span class="c1"># New Market</span>
<a id="__codelineno-7-239" name="__codelineno-7-239" href="#__codelineno-7-239"></a>                        <span class="k">if</span> <span class="n">market_book</span><span class="o">.</span><span class="n">market_id</span> <span class="o">!=</span> <span class="n">marketID</span><span class="p">:</span>
<a id="__codelineno-7-240" name="__codelineno-7-240" href="#__codelineno-7-240"></a>                            <span class="n">marketID</span> <span class="o">=</span> <span class="n">market_book</span><span class="o">.</span><span class="n">market_id</span>
<a id="__codelineno-7-241" name="__codelineno-7-241" href="#__codelineno-7-241"></a>                            <span class="n">time</span> <span class="o">=</span>  <span class="n">market_book</span><span class="o">.</span><span class="n">publish_time</span>
<a id="__codelineno-7-242" name="__codelineno-7-242" href="#__codelineno-7-242"></a>                        <span class="c1"># (wait) seconds elapsed since last write</span>
<a id="__codelineno-7-243" name="__codelineno-7-243" href="#__codelineno-7-243"></a>                        <span class="k">elif</span> <span class="p">(</span><span class="n">market_book</span><span class="o">.</span><span class="n">publish_time</span> <span class="o">-</span> <span class="n">time</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="n">wait</span><span class="p">:</span>
<a id="__codelineno-7-244" name="__codelineno-7-244" href="#__codelineno-7-244"></a>                            <span class="n">time</span> <span class="o">=</span> <span class="n">market_book</span><span class="o">.</span><span class="n">publish_time</span>
<a id="__codelineno-7-245" name="__codelineno-7-245" href="#__codelineno-7-245"></a>                        <span class="c1"># fewer than (wait) seconds elapsed continue to next loop</span>
<a id="__codelineno-7-246" name="__codelineno-7-246" href="#__codelineno-7-246"></a>                        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-7-247" name="__codelineno-7-247" href="#__codelineno-7-247"></a>                            <span class="k">continue</span>
<a id="__codelineno-7-248" name="__codelineno-7-248" href="#__codelineno-7-248"></a>
<a id="__codelineno-7-249" name="__codelineno-7-249" href="#__codelineno-7-249"></a>                <span class="c1"># Execute Data Logging ++++++++++++++++++++++++++++++++++</span>
<a id="__codelineno-7-250" name="__codelineno-7-250" href="#__codelineno-7-250"></a>
<a id="__codelineno-7-251" name="__codelineno-7-251" href="#__codelineno-7-251"></a>                <span class="k">for</span> <span class="n">runner</span> <span class="ow">in</span> <span class="n">market_book</span><span class="o">.</span><span class="n">runners</span><span class="p">:</span>
<a id="__codelineno-7-252" name="__codelineno-7-252" href="#__codelineno-7-252"></a>
<a id="__codelineno-7-253" name="__codelineno-7-253" href="#__codelineno-7-253"></a>                    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-7-254" name="__codelineno-7-254" href="#__codelineno-7-254"></a>                        <span class="n">selection_status</span> <span class="o">=</span> <span class="n">runner</span><span class="o">.</span><span class="n">status</span>
<a id="__codelineno-7-255" name="__codelineno-7-255" href="#__codelineno-7-255"></a>                        <span class="n">reduction_factor</span> <span class="o">=</span> <span class="n">runner</span><span class="o">.</span><span class="n">adjustment_factor</span>
<a id="__codelineno-7-256" name="__codelineno-7-256" href="#__codelineno-7-256"></a>                        <span class="n">atb_ladder</span> <span class="o">=</span> <span class="n">pull_ladder</span><span class="p">(</span><span class="n">runner</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">available_to_back</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">5</span><span class="p">)</span>
<a id="__codelineno-7-257" name="__codelineno-7-257" href="#__codelineno-7-257"></a>                        <span class="n">atl_ladder</span> <span class="o">=</span> <span class="n">pull_ladder</span><span class="p">(</span><span class="n">runner</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">available_to_lay</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">5</span><span class="p">)</span>
<a id="__codelineno-7-258" name="__codelineno-7-258" href="#__codelineno-7-258"></a>                        <span class="n">spn</span> <span class="o">=</span> <span class="n">runner</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">near_price</span>
<a id="__codelineno-7-259" name="__codelineno-7-259" href="#__codelineno-7-259"></a>                        <span class="n">spf</span> <span class="o">=</span> <span class="n">runner</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">far_price</span>
<a id="__codelineno-7-260" name="__codelineno-7-260" href="#__codelineno-7-260"></a>                    <span class="k">except</span><span class="p">:</span>
<a id="__codelineno-7-261" name="__codelineno-7-261" href="#__codelineno-7-261"></a>                        <span class="n">selection_status</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-7-262" name="__codelineno-7-262" href="#__codelineno-7-262"></a>                        <span class="n">reduction_factor</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-7-263" name="__codelineno-7-263" href="#__codelineno-7-263"></a>                        <span class="n">atb_ladder</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-7-264" name="__codelineno-7-264" href="#__codelineno-7-264"></a>                        <span class="n">atl_ladder</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-7-265" name="__codelineno-7-265" href="#__codelineno-7-265"></a>                        <span class="n">spn</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-7-266" name="__codelineno-7-266" href="#__codelineno-7-266"></a>                        <span class="n">spf</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-7-267" name="__codelineno-7-267" href="#__codelineno-7-267"></a>
<a id="__codelineno-7-268" name="__codelineno-7-268" href="#__codelineno-7-268"></a>                    <span class="c1"># Calculate Current Traded Volume + Traded WAP</span>
<a id="__codelineno-7-269" name="__codelineno-7-269" href="#__codelineno-7-269"></a>                    <span class="n">limitTradedVol</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">rung</span><span class="o">.</span><span class="n">size</span> <span class="k">for</span> <span class="n">rung</span> <span class="ow">in</span> <span class="n">runner</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">traded_volume</span><span class="p">])</span>
<a id="__codelineno-7-270" name="__codelineno-7-270" href="#__codelineno-7-270"></a>                    <span class="k">if</span> <span class="n">limitTradedVol</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-7-271" name="__codelineno-7-271" href="#__codelineno-7-271"></a>                        <span class="n">limitWAP</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-7-272" name="__codelineno-7-272" href="#__codelineno-7-272"></a>                    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-7-273" name="__codelineno-7-273" href="#__codelineno-7-273"></a>                        <span class="n">limitWAP</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">rung</span><span class="o">.</span><span class="n">size</span> <span class="o">*</span> <span class="n">rung</span><span class="o">.</span><span class="n">price</span> <span class="k">for</span> <span class="n">rung</span> <span class="ow">in</span> <span class="n">runner</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">traded_volume</span><span class="p">])</span> <span class="o">/</span> <span class="n">limitTradedVol</span>
<a id="__codelineno-7-274" name="__codelineno-7-274" href="#__codelineno-7-274"></a>                        <span class="n">limitWAP</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">limitWAP</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-7-275" name="__codelineno-7-275" href="#__codelineno-7-275"></a>
<a id="__codelineno-7-276" name="__codelineno-7-276" href="#__codelineno-7-276"></a>                    <span class="n">o</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span>
<a id="__codelineno-7-277" name="__codelineno-7-277" href="#__codelineno-7-277"></a>                        <span class="p">(</span>
<a id="__codelineno-7-278" name="__codelineno-7-278" href="#__codelineno-7-278"></a>                            <span class="n">market_book</span><span class="o">.</span><span class="n">market_id</span><span class="p">,</span>
<a id="__codelineno-7-279" name="__codelineno-7-279" href="#__codelineno-7-279"></a>                            <span class="n">market_book</span><span class="o">.</span><span class="n">number_of_active_runners</span><span class="p">,</span>
<a id="__codelineno-7-280" name="__codelineno-7-280" href="#__codelineno-7-280"></a>                            <span class="n">runner</span><span class="o">.</span><span class="n">selection_id</span><span class="p">,</span>
<a id="__codelineno-7-281" name="__codelineno-7-281" href="#__codelineno-7-281"></a>                            <span class="n">market_book</span><span class="o">.</span><span class="n">publish_time</span><span class="p">,</span>
<a id="__codelineno-7-282" name="__codelineno-7-282" href="#__codelineno-7-282"></a>                            <span class="n">limitTradedVol</span><span class="p">,</span>
<a id="__codelineno-7-283" name="__codelineno-7-283" href="#__codelineno-7-283"></a>                            <span class="n">limitWAP</span><span class="p">,</span>
<a id="__codelineno-7-284" name="__codelineno-7-284" href="#__codelineno-7-284"></a>                            <span class="n">runner</span><span class="o">.</span><span class="n">last_price_traded</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-7-285" name="__codelineno-7-285" href="#__codelineno-7-285"></a>                            <span class="n">selection_status</span><span class="p">,</span>
<a id="__codelineno-7-286" name="__codelineno-7-286" href="#__codelineno-7-286"></a>                            <span class="n">reduction_factor</span><span class="p">,</span>
<a id="__codelineno-7-287" name="__codelineno-7-287" href="#__codelineno-7-287"></a>                            <span class="nb">str</span><span class="p">(</span><span class="n">atb_ladder</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">),</span> 
<a id="__codelineno-7-288" name="__codelineno-7-288" href="#__codelineno-7-288"></a>                            <span class="nb">str</span><span class="p">(</span><span class="n">atl_ladder</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">),</span>
<a id="__codelineno-7-289" name="__codelineno-7-289" href="#__codelineno-7-289"></a>                            <span class="nb">str</span><span class="p">(</span><span class="n">spn</span><span class="p">),</span>
<a id="__codelineno-7-290" name="__codelineno-7-290" href="#__codelineno-7-290"></a>                            <span class="nb">str</span><span class="p">(</span><span class="n">spf</span><span class="p">)</span>
<a id="__codelineno-7-291" name="__codelineno-7-291" href="#__codelineno-7-291"></a>                        <span class="p">)</span>
<a id="__codelineno-7-292" name="__codelineno-7-292" href="#__codelineno-7-292"></a>                    <span class="p">)</span>
<a id="__codelineno-7-293" name="__codelineno-7-293" href="#__codelineno-7-293"></a>
<a id="__codelineno-7-294" name="__codelineno-7-294" href="#__codelineno-7-294"></a>
<a id="__codelineno-7-295" name="__codelineno-7-295" href="#__codelineno-7-295"></a><span class="k">def</span> <span class="nf">parse_prices</span><span class="p">(</span><span class="nb">dir</span><span class="p">,</span> <span class="n">out_file</span><span class="p">):</span>
<a id="__codelineno-7-296" name="__codelineno-7-296" href="#__codelineno-7-296"></a>
<a id="__codelineno-7-297" name="__codelineno-7-297" href="#__codelineno-7-297"></a>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">out_file</span><span class="p">,</span> <span class="s2">&quot;w+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">output</span><span class="p">:</span>
<a id="__codelineno-7-298" name="__codelineno-7-298" href="#__codelineno-7-298"></a>
<a id="__codelineno-7-299" name="__codelineno-7-299" href="#__codelineno-7-299"></a>        <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span>
<a id="__codelineno-7-300" name="__codelineno-7-300" href="#__codelineno-7-300"></a>            <span class="n">output</span><span class="p">,</span> 
<a id="__codelineno-7-301" name="__codelineno-7-301" href="#__codelineno-7-301"></a>            <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span>
<a id="__codelineno-7-302" name="__codelineno-7-302" href="#__codelineno-7-302"></a>            <span class="n">lineterminator</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\r\n</span><span class="s1">&#39;</span><span class="p">,</span>
<a id="__codelineno-7-303" name="__codelineno-7-303" href="#__codelineno-7-303"></a>            <span class="n">quoting</span><span class="o">=</span><span class="n">csv</span><span class="o">.</span><span class="n">QUOTE_ALL</span>
<a id="__codelineno-7-304" name="__codelineno-7-304" href="#__codelineno-7-304"></a>        <span class="p">)</span>
<a id="__codelineno-7-305" name="__codelineno-7-305" href="#__codelineno-7-305"></a>
<a id="__codelineno-7-306" name="__codelineno-7-306" href="#__codelineno-7-306"></a>        <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">((</span><span class="s2">&quot;market_id&quot;</span><span class="p">,</span><span class="s2">&quot;active_runners&quot;</span><span class="p">,</span><span class="s2">&quot;selection_id&quot;</span><span class="p">,</span><span class="s2">&quot;time&quot;</span><span class="p">,</span><span class="s2">&quot;traded_volume&quot;</span><span class="p">,</span><span class="s2">&quot;wap&quot;</span><span class="p">,</span><span class="s2">&quot;ltp&quot;</span><span class="p">,</span><span class="s2">&quot;selection_status&quot;</span><span class="p">,</span><span class="s1">&#39;reduction_factor&#39;</span><span class="p">,</span><span class="s2">&quot;atb_ladder&quot;</span><span class="p">,</span><span class="s2">&quot;atl_ladder&quot;</span><span class="p">,</span><span class="s2">&quot;sp_near&quot;</span><span class="p">,</span><span class="s2">&quot;sp_far&quot;</span><span class="p">))</span>
<a id="__codelineno-7-307" name="__codelineno-7-307" href="#__codelineno-7-307"></a>
<a id="__codelineno-7-308" name="__codelineno-7-308" href="#__codelineno-7-308"></a>        <span class="k">for</span> <span class="n">file_obj</span> <span class="ow">in</span> <span class="n">load_markets</span><span class="p">(</span><span class="nb">dir</span><span class="p">):</span>
<a id="__codelineno-7-309" name="__codelineno-7-309" href="#__codelineno-7-309"></a>
<a id="__codelineno-7-310" name="__codelineno-7-310" href="#__codelineno-7-310"></a>            <span class="n">stream</span> <span class="o">=</span> <span class="n">trading</span><span class="o">.</span><span class="n">streaming</span><span class="o">.</span><span class="n">create_historical_generator_stream</span><span class="p">(</span>
<a id="__codelineno-7-311" name="__codelineno-7-311" href="#__codelineno-7-311"></a>                <span class="n">file_path</span><span class="o">=</span><span class="n">file_obj</span><span class="p">,</span>
<a id="__codelineno-7-312" name="__codelineno-7-312" href="#__codelineno-7-312"></a>                <span class="n">listener</span><span class="o">=</span><span class="n">listener</span><span class="p">,</span>
<a id="__codelineno-7-313" name="__codelineno-7-313" href="#__codelineno-7-313"></a>            <span class="p">)</span>
<a id="__codelineno-7-314" name="__codelineno-7-314" href="#__codelineno-7-314"></a>
<a id="__codelineno-7-315" name="__codelineno-7-315" href="#__codelineno-7-315"></a>            <span class="n">loop_prices</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">writer</span><span class="p">)</span>
<a id="__codelineno-7-316" name="__codelineno-7-316" href="#__codelineno-7-316"></a>
<a id="__codelineno-7-317" name="__codelineno-7-317" href="#__codelineno-7-317"></a>
<a id="__codelineno-7-318" name="__codelineno-7-318" href="#__codelineno-7-318"></a>
<a id="__codelineno-7-319" name="__codelineno-7-319" href="#__codelineno-7-319"></a><span class="c1">#loop over each TAR file</span>
<a id="__codelineno-7-320" name="__codelineno-7-320" href="#__codelineno-7-320"></a><span class="k">for</span> <span class="n">tar</span> <span class="ow">in</span> <span class="n">stream_files</span><span class="p">:</span>
<a id="__codelineno-7-321" name="__codelineno-7-321" href="#__codelineno-7-321"></a>    <span class="n">parse_prices</span><span class="p">([</span><span class="n">tar</span><span class="p">],</span> <span class="n">prices_path</span><span class="p">)</span>
<a id="__codelineno-7-322" name="__codelineno-7-322" href="#__codelineno-7-322"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;__ Parsing Market and Selection Data ___ &quot;</span><span class="p">)</span>
<a id="__codelineno-7-323" name="__codelineno-7-323" href="#__codelineno-7-323"></a>
<a id="__codelineno-7-324" name="__codelineno-7-324" href="#__codelineno-7-324"></a>    <span class="c1"># record prices to a file</span>
<a id="__codelineno-7-325" name="__codelineno-7-325" href="#__codelineno-7-325"></a>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">selection_meta</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">output</span><span class="p">:</span>
<a id="__codelineno-7-326" name="__codelineno-7-326" href="#__codelineno-7-326"></a>    <span class="c1"># defining column headers</span>
<a id="__codelineno-7-327" name="__codelineno-7-327" href="#__codelineno-7-327"></a>        <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;market_id,event_date,country,track,event_name,selection_id,selection_name,result,bsp,pp_min,pp_max,pp_wap,pp_ltp,pp_volume,bsp_volume,ip_min,ip_max,ip_wap,ip_ltp,ip_volume</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-7-328" name="__codelineno-7-328" href="#__codelineno-7-328"></a>
<a id="__codelineno-7-329" name="__codelineno-7-329" href="#__codelineno-7-329"></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bflw</span><span class="o">.</span><span class="n">Files</span><span class="p">([</span><span class="n">tar</span><span class="p">])):</span>
<a id="__codelineno-7-330" name="__codelineno-7-330" href="#__codelineno-7-330"></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Market </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-7-331" name="__codelineno-7-331" href="#__codelineno-7-331"></a>
<a id="__codelineno-7-332" name="__codelineno-7-332" href="#__codelineno-7-332"></a>            <span class="k">def</span> <span class="nf">get_pre_post_final</span><span class="p">():</span>
<a id="__codelineno-7-333" name="__codelineno-7-333" href="#__codelineno-7-333"></a>                <span class="n">eval_market</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-7-334" name="__codelineno-7-334" href="#__codelineno-7-334"></a>                <span class="n">prev_market</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-7-335" name="__codelineno-7-335" href="#__codelineno-7-335"></a>                <span class="n">preplay_market</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-7-336" name="__codelineno-7-336" href="#__codelineno-7-336"></a>                <span class="n">postplay_market</span> <span class="o">=</span> <span class="kc">None</span>       
<a id="__codelineno-7-337" name="__codelineno-7-337" href="#__codelineno-7-337"></a>
<a id="__codelineno-7-338" name="__codelineno-7-338" href="#__codelineno-7-338"></a>                <span class="k">for</span> <span class="n">market_books</span> <span class="ow">in</span> <span class="n">g</span><span class="p">:</span>
<a id="__codelineno-7-339" name="__codelineno-7-339" href="#__codelineno-7-339"></a>                    <span class="k">for</span> <span class="n">market_book</span> <span class="ow">in</span> <span class="n">market_books</span><span class="p">:</span>
<a id="__codelineno-7-340" name="__codelineno-7-340" href="#__codelineno-7-340"></a>                        <span class="c1"># if market doesn&#39;t meet filter return out</span>
<a id="__codelineno-7-341" name="__codelineno-7-341" href="#__codelineno-7-341"></a>                        <span class="k">if</span> <span class="n">eval_market</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">((</span><span class="n">eval_market</span> <span class="o">:=</span> <span class="n">filter_market</span><span class="p">(</span><span class="n">market_book</span><span class="p">))</span> <span class="o">==</span> <span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-7-342" name="__codelineno-7-342" href="#__codelineno-7-342"></a>                            <span class="k">return</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-7-343" name="__codelineno-7-343" href="#__codelineno-7-343"></a>
<a id="__codelineno-7-344" name="__codelineno-7-344" href="#__codelineno-7-344"></a>                        <span class="c1"># final market view before market goes in play</span>
<a id="__codelineno-7-345" name="__codelineno-7-345" href="#__codelineno-7-345"></a>                        <span class="k">if</span> <span class="n">prev_market</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">prev_market</span><span class="o">.</span><span class="n">inplay</span> <span class="o">!=</span> <span class="n">market_book</span><span class="o">.</span><span class="n">inplay</span><span class="p">:</span>
<a id="__codelineno-7-346" name="__codelineno-7-346" href="#__codelineno-7-346"></a>                            <span class="n">preplay_market</span> <span class="o">=</span> <span class="n">prev_market</span>
<a id="__codelineno-7-347" name="__codelineno-7-347" href="#__codelineno-7-347"></a>
<a id="__codelineno-7-348" name="__codelineno-7-348" href="#__codelineno-7-348"></a>                        <span class="c1"># final market view at the conclusion of the market</span>
<a id="__codelineno-7-349" name="__codelineno-7-349" href="#__codelineno-7-349"></a>                        <span class="k">if</span> <span class="n">prev_market</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">prev_market</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;OPEN&quot;</span> <span class="ow">and</span> <span class="n">market_book</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="n">prev_market</span><span class="o">.</span><span class="n">status</span><span class="p">:</span>
<a id="__codelineno-7-350" name="__codelineno-7-350" href="#__codelineno-7-350"></a>                            <span class="n">postplay_market</span> <span class="o">=</span> <span class="n">market_book</span>
<a id="__codelineno-7-351" name="__codelineno-7-351" href="#__codelineno-7-351"></a>
<a id="__codelineno-7-352" name="__codelineno-7-352" href="#__codelineno-7-352"></a>                        <span class="c1"># update reference to previous market</span>
<a id="__codelineno-7-353" name="__codelineno-7-353" href="#__codelineno-7-353"></a>                        <span class="n">prev_market</span> <span class="o">=</span> <span class="n">market_book</span>
<a id="__codelineno-7-354" name="__codelineno-7-354" href="#__codelineno-7-354"></a>
<a id="__codelineno-7-355" name="__codelineno-7-355" href="#__codelineno-7-355"></a>                <span class="k">return</span> <span class="p">(</span><span class="n">preplay_market</span><span class="p">,</span> <span class="n">postplay_market</span><span class="p">,</span> <span class="n">prev_market</span><span class="p">)</span> <span class="c1"># prev is now final</span>
<a id="__codelineno-7-356" name="__codelineno-7-356" href="#__codelineno-7-356"></a>
<a id="__codelineno-7-357" name="__codelineno-7-357" href="#__codelineno-7-357"></a>            <span class="p">(</span><span class="n">preplay_market</span><span class="p">,</span> <span class="n">postplay_market</span><span class="p">,</span> <span class="n">final_market</span><span class="p">)</span> <span class="o">=</span> <span class="n">get_pre_post_final</span><span class="p">()</span>
<a id="__codelineno-7-358" name="__codelineno-7-358" href="#__codelineno-7-358"></a>
<a id="__codelineno-7-359" name="__codelineno-7-359" href="#__codelineno-7-359"></a>            <span class="c1"># no price data for market</span>
<a id="__codelineno-7-360" name="__codelineno-7-360" href="#__codelineno-7-360"></a>            <span class="k">if</span> <span class="n">postplay_market</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-7-361" name="__codelineno-7-361" href="#__codelineno-7-361"></a>                <span class="k">continue</span><span class="p">;</span> 
<a id="__codelineno-7-362" name="__codelineno-7-362" href="#__codelineno-7-362"></a>
<a id="__codelineno-7-363" name="__codelineno-7-363" href="#__codelineno-7-363"></a>            <span class="n">preplay_traded</span> <span class="o">=</span> <span class="p">[</span> <span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">last_price_traded</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">traded_volume</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">preplay_market</span><span class="o">.</span><span class="n">runners</span> <span class="p">]</span> <span class="k">if</span> <span class="n">preplay_market</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
<a id="__codelineno-7-364" name="__codelineno-7-364" href="#__codelineno-7-364"></a>
<a id="__codelineno-7-365" name="__codelineno-7-365" href="#__codelineno-7-365"></a>            <span class="n">postplay_traded</span> <span class="o">=</span> <span class="p">[</span> <span class="p">(</span>
<a id="__codelineno-7-366" name="__codelineno-7-366" href="#__codelineno-7-366"></a>                <span class="n">r</span><span class="o">.</span><span class="n">last_price_traded</span><span class="p">,</span>
<a id="__codelineno-7-367" name="__codelineno-7-367" href="#__codelineno-7-367"></a>                <span class="n">r</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">traded_volume</span><span class="p">,</span>
<a id="__codelineno-7-368" name="__codelineno-7-368" href="#__codelineno-7-368"></a>                <span class="c1"># calculating SP traded vol as smaller of back_stake_taken or (lay_liability_taken / (bsp - 1))        </span>
<a id="__codelineno-7-369" name="__codelineno-7-369" href="#__codelineno-7-369"></a>                <span class="n">min_gr0</span><span class="p">(</span>
<a id="__codelineno-7-370" name="__codelineno-7-370" href="#__codelineno-7-370"></a>                    <span class="nb">next</span><span class="p">((</span><span class="n">pv</span><span class="o">.</span><span class="n">size</span> <span class="k">for</span> <span class="n">pv</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">back_stake_taken</span> <span class="k">if</span> <span class="n">pv</span><span class="o">.</span><span class="n">size</span> <span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">0</span><span class="p">),</span>
<a id="__codelineno-7-371" name="__codelineno-7-371" href="#__codelineno-7-371"></a>                    <span class="nb">next</span><span class="p">((</span><span class="n">pv</span><span class="o">.</span><span class="n">size</span> <span class="k">for</span> <span class="n">pv</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">lay_liability_taken</span> <span class="k">if</span> <span class="n">pv</span><span class="o">.</span><span class="n">size</span> <span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>  <span class="o">/</span> <span class="p">((</span><span class="n">r</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">actual_sp</span> <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">actual_sp</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">actual_sp</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-7-372" name="__codelineno-7-372" href="#__codelineno-7-372"></a>                <span class="p">)</span> <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">actual_sp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-7-373" name="__codelineno-7-373" href="#__codelineno-7-373"></a>            <span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">postplay_market</span><span class="o">.</span><span class="n">runners</span> <span class="p">]</span>
<a id="__codelineno-7-374" name="__codelineno-7-374" href="#__codelineno-7-374"></a>
<a id="__codelineno-7-375" name="__codelineno-7-375" href="#__codelineno-7-375"></a>            <span class="n">runner_data</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-7-376" name="__codelineno-7-376" href="#__codelineno-7-376"></a>            <span class="p">{</span>
<a id="__codelineno-7-377" name="__codelineno-7-377" href="#__codelineno-7-377"></a>                <span class="s1">&#39;selection_id&#39;</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">selection_id</span><span class="p">,</span>
<a id="__codelineno-7-378" name="__codelineno-7-378" href="#__codelineno-7-378"></a>                <span class="s1">&#39;selection_name&#39;</span><span class="p">:</span> <span class="nb">next</span><span class="p">((</span><span class="n">rd</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">rd</span> <span class="ow">in</span> <span class="n">final_market</span><span class="o">.</span><span class="n">market_definition</span><span class="o">.</span><span class="n">runners</span> <span class="k">if</span> <span class="n">rd</span><span class="o">.</span><span class="n">selection_id</span> <span class="o">==</span> <span class="n">r</span><span class="o">.</span><span class="n">selection_id</span><span class="p">),</span> <span class="kc">None</span><span class="p">),</span>
<a id="__codelineno-7-379" name="__codelineno-7-379" href="#__codelineno-7-379"></a>                <span class="s1">&#39;selection_status&#39;</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
<a id="__codelineno-7-380" name="__codelineno-7-380" href="#__codelineno-7-380"></a>                <span class="s1">&#39;sp&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">actual_sp</span><span class="p">),</span>
<a id="__codelineno-7-381" name="__codelineno-7-381" href="#__codelineno-7-381"></a>            <span class="p">}</span>
<a id="__codelineno-7-382" name="__codelineno-7-382" href="#__codelineno-7-382"></a>            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">final_market</span><span class="o">.</span><span class="n">runners</span> 
<a id="__codelineno-7-383" name="__codelineno-7-383" href="#__codelineno-7-383"></a>            <span class="p">]</span>
<a id="__codelineno-7-384" name="__codelineno-7-384" href="#__codelineno-7-384"></a>
<a id="__codelineno-7-385" name="__codelineno-7-385" href="#__codelineno-7-385"></a>            <span class="c1"># runner price data for markets that go in play</span>
<a id="__codelineno-7-386" name="__codelineno-7-386" href="#__codelineno-7-386"></a>            <span class="k">if</span> <span class="n">preplay_traded</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-7-387" name="__codelineno-7-387" href="#__codelineno-7-387"></a>                <span class="k">def</span> <span class="nf">runner_vals</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
<a id="__codelineno-7-388" name="__codelineno-7-388" href="#__codelineno-7-388"></a>                    <span class="p">(</span><span class="n">pre_ltp</span><span class="p">,</span> <span class="n">pre_traded</span><span class="p">),</span> <span class="p">(</span><span class="n">post_ltp</span><span class="p">,</span> <span class="n">post_traded</span><span class="p">,</span> <span class="n">sp_traded</span><span class="p">)</span> <span class="o">=</span> <span class="n">r</span>
<a id="__codelineno-7-389" name="__codelineno-7-389" href="#__codelineno-7-389"></a>
<a id="__codelineno-7-390" name="__codelineno-7-390" href="#__codelineno-7-390"></a>                    <span class="n">inplay_only</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">ps</span><span class="p">:</span> <span class="n">ps</span><span class="o">.</span><span class="n">size</span> <span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="mi">0</span><span class="p">,</span> <span class="p">[</span>
<a id="__codelineno-7-391" name="__codelineno-7-391" href="#__codelineno-7-391"></a>                        <span class="n">PriceSize</span><span class="p">(</span>
<a id="__codelineno-7-392" name="__codelineno-7-392" href="#__codelineno-7-392"></a>                            <span class="n">price</span><span class="o">=</span><span class="n">post_ps</span><span class="o">.</span><span class="n">price</span><span class="p">,</span> 
<a id="__codelineno-7-393" name="__codelineno-7-393" href="#__codelineno-7-393"></a>                            <span class="n">size</span><span class="o">=</span><span class="n">post_ps</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="nb">next</span><span class="p">((</span><span class="n">pre_ps</span><span class="o">.</span><span class="n">size</span> <span class="k">for</span> <span class="n">pre_ps</span> <span class="ow">in</span> <span class="n">pre_traded</span> <span class="k">if</span> <span class="n">pre_ps</span><span class="o">.</span><span class="n">price</span> <span class="o">==</span> <span class="n">post_ps</span><span class="o">.</span><span class="n">price</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-7-394" name="__codelineno-7-394" href="#__codelineno-7-394"></a>                        <span class="p">)</span>
<a id="__codelineno-7-395" name="__codelineno-7-395" href="#__codelineno-7-395"></a>                        <span class="k">for</span> <span class="n">post_ps</span> <span class="ow">in</span> <span class="n">post_traded</span> 
<a id="__codelineno-7-396" name="__codelineno-7-396" href="#__codelineno-7-396"></a>                    <span class="p">]))</span>
<a id="__codelineno-7-397" name="__codelineno-7-397" href="#__codelineno-7-397"></a>
<a id="__codelineno-7-398" name="__codelineno-7-398" href="#__codelineno-7-398"></a>                    <span class="p">(</span><span class="n">ip_wavg</span><span class="p">,</span> <span class="n">ip_matched</span><span class="p">,</span> <span class="n">ip_min</span><span class="p">,</span> <span class="n">ip_max</span><span class="p">)</span> <span class="o">=</span> <span class="n">parse_traded</span><span class="p">(</span><span class="n">inplay_only</span><span class="p">)</span>
<a id="__codelineno-7-399" name="__codelineno-7-399" href="#__codelineno-7-399"></a>                    <span class="p">(</span><span class="n">pre_wavg</span><span class="p">,</span> <span class="n">pre_matched</span><span class="p">,</span> <span class="n">pre_min</span><span class="p">,</span> <span class="n">pre_max</span><span class="p">)</span> <span class="o">=</span> <span class="n">parse_traded</span><span class="p">(</span><span class="n">pre_traded</span><span class="p">)</span>
<a id="__codelineno-7-400" name="__codelineno-7-400" href="#__codelineno-7-400"></a>
<a id="__codelineno-7-401" name="__codelineno-7-401" href="#__codelineno-7-401"></a>                    <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-7-402" name="__codelineno-7-402" href="#__codelineno-7-402"></a>                        <span class="s1">&#39;preplay_ltp&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">pre_ltp</span><span class="p">),</span>
<a id="__codelineno-7-403" name="__codelineno-7-403" href="#__codelineno-7-403"></a>                        <span class="s1">&#39;preplay_min&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">pre_min</span><span class="p">),</span>
<a id="__codelineno-7-404" name="__codelineno-7-404" href="#__codelineno-7-404"></a>                        <span class="s1">&#39;preplay_max&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">pre_max</span><span class="p">),</span>
<a id="__codelineno-7-405" name="__codelineno-7-405" href="#__codelineno-7-405"></a>                        <span class="s1">&#39;preplay_wavg&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">pre_wavg</span><span class="p">),</span>
<a id="__codelineno-7-406" name="__codelineno-7-406" href="#__codelineno-7-406"></a>                        <span class="s1">&#39;preplay_matched&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">pre_matched</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">),</span>
<a id="__codelineno-7-407" name="__codelineno-7-407" href="#__codelineno-7-407"></a>                        <span class="s1">&#39;bsp_matched&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">sp_traded</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">),</span>
<a id="__codelineno-7-408" name="__codelineno-7-408" href="#__codelineno-7-408"></a>                        <span class="s1">&#39;inplay_ltp&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">post_ltp</span><span class="p">),</span>
<a id="__codelineno-7-409" name="__codelineno-7-409" href="#__codelineno-7-409"></a>                        <span class="s1">&#39;inplay_min&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">ip_min</span><span class="p">),</span>
<a id="__codelineno-7-410" name="__codelineno-7-410" href="#__codelineno-7-410"></a>                        <span class="s1">&#39;inplay_max&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">ip_max</span><span class="p">),</span>
<a id="__codelineno-7-411" name="__codelineno-7-411" href="#__codelineno-7-411"></a>                        <span class="s1">&#39;inplay_wavg&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">ip_wavg</span><span class="p">),</span>
<a id="__codelineno-7-412" name="__codelineno-7-412" href="#__codelineno-7-412"></a>                        <span class="s1">&#39;inplay_matched&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">ip_matched</span><span class="p">),</span>
<a id="__codelineno-7-413" name="__codelineno-7-413" href="#__codelineno-7-413"></a>                    <span class="p">}</span>
<a id="__codelineno-7-414" name="__codelineno-7-414" href="#__codelineno-7-414"></a>
<a id="__codelineno-7-415" name="__codelineno-7-415" href="#__codelineno-7-415"></a>                <span class="n">runner_traded</span> <span class="o">=</span> <span class="p">[</span> <span class="n">runner_vals</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">zip_longest</span><span class="p">(</span><span class="n">preplay_traded</span><span class="p">,</span> <span class="n">postplay_traded</span><span class="p">,</span> <span class="n">fillvalue</span><span class="o">=</span><span class="n">PriceSize</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">]</span>
<a id="__codelineno-7-416" name="__codelineno-7-416" href="#__codelineno-7-416"></a>
<a id="__codelineno-7-417" name="__codelineno-7-417" href="#__codelineno-7-417"></a>            <span class="c1"># runner price data for markets that don&#39;t go in play</span>
<a id="__codelineno-7-418" name="__codelineno-7-418" href="#__codelineno-7-418"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-7-419" name="__codelineno-7-419" href="#__codelineno-7-419"></a>                <span class="k">def</span> <span class="nf">runner_vals</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
<a id="__codelineno-7-420" name="__codelineno-7-420" href="#__codelineno-7-420"></a>                    <span class="p">(</span><span class="n">ltp</span><span class="p">,</span> <span class="n">traded</span><span class="p">,</span> <span class="n">sp_traded</span><span class="p">)</span> <span class="o">=</span> <span class="n">r</span>
<a id="__codelineno-7-421" name="__codelineno-7-421" href="#__codelineno-7-421"></a>                    <span class="p">(</span><span class="n">wavg</span><span class="p">,</span> <span class="n">matched</span><span class="p">,</span> <span class="n">min_price</span><span class="p">,</span> <span class="n">max_price</span><span class="p">)</span> <span class="o">=</span> <span class="n">parse_traded</span><span class="p">(</span><span class="n">traded</span><span class="p">)</span>
<a id="__codelineno-7-422" name="__codelineno-7-422" href="#__codelineno-7-422"></a>
<a id="__codelineno-7-423" name="__codelineno-7-423" href="#__codelineno-7-423"></a>                    <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-7-424" name="__codelineno-7-424" href="#__codelineno-7-424"></a>                        <span class="s1">&#39;preplay_ltp&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">ltp</span><span class="p">),</span>
<a id="__codelineno-7-425" name="__codelineno-7-425" href="#__codelineno-7-425"></a>                        <span class="s1">&#39;preplay_min&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">min_price</span><span class="p">),</span>
<a id="__codelineno-7-426" name="__codelineno-7-426" href="#__codelineno-7-426"></a>                        <span class="s1">&#39;preplay_max&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">max_price</span><span class="p">),</span>
<a id="__codelineno-7-427" name="__codelineno-7-427" href="#__codelineno-7-427"></a>                        <span class="s1">&#39;preplay_wavg&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">wavg</span><span class="p">),</span>
<a id="__codelineno-7-428" name="__codelineno-7-428" href="#__codelineno-7-428"></a>                        <span class="s1">&#39;preplay_matched&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">matched</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">),</span>
<a id="__codelineno-7-429" name="__codelineno-7-429" href="#__codelineno-7-429"></a>                        <span class="s1">&#39;bsp_matched&#39;</span><span class="p">:</span> <span class="n">as_str</span><span class="p">(</span><span class="n">sp_traded</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">),</span>
<a id="__codelineno-7-430" name="__codelineno-7-430" href="#__codelineno-7-430"></a>                        <span class="s1">&#39;inplay_ltp&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
<a id="__codelineno-7-431" name="__codelineno-7-431" href="#__codelineno-7-431"></a>                        <span class="s1">&#39;inplay_min&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
<a id="__codelineno-7-432" name="__codelineno-7-432" href="#__codelineno-7-432"></a>                        <span class="s1">&#39;inplay_max&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
<a id="__codelineno-7-433" name="__codelineno-7-433" href="#__codelineno-7-433"></a>                        <span class="s1">&#39;inplay_wavg&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
<a id="__codelineno-7-434" name="__codelineno-7-434" href="#__codelineno-7-434"></a>                        <span class="s1">&#39;inplay_matched&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
<a id="__codelineno-7-435" name="__codelineno-7-435" href="#__codelineno-7-435"></a>                    <span class="p">}</span>
<a id="__codelineno-7-436" name="__codelineno-7-436" href="#__codelineno-7-436"></a>
<a id="__codelineno-7-437" name="__codelineno-7-437" href="#__codelineno-7-437"></a>                <span class="n">runner_traded</span> <span class="o">=</span> <span class="p">[</span> <span class="n">runner_vals</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">postplay_traded</span> <span class="p">]</span>
<a id="__codelineno-7-438" name="__codelineno-7-438" href="#__codelineno-7-438"></a>
<a id="__codelineno-7-439" name="__codelineno-7-439" href="#__codelineno-7-439"></a>            <span class="c1"># printing to csv for each runner</span>
<a id="__codelineno-7-440" name="__codelineno-7-440" href="#__codelineno-7-440"></a>            <span class="k">for</span> <span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="n">rprices</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">runner_data</span><span class="p">,</span> <span class="n">runner_traded</span><span class="p">):</span>
<a id="__codelineno-7-441" name="__codelineno-7-441" href="#__codelineno-7-441"></a>                <span class="c1"># defining data to go in each column</span>
<a id="__codelineno-7-442" name="__codelineno-7-442" href="#__codelineno-7-442"></a>                <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
<a id="__codelineno-7-443" name="__codelineno-7-443" href="#__codelineno-7-443"></a>                    <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
<a id="__codelineno-7-444" name="__codelineno-7-444" href="#__codelineno-7-444"></a>                        <span class="n">postplay_market</span><span class="o">.</span><span class="n">market_id</span><span class="p">,</span>
<a id="__codelineno-7-445" name="__codelineno-7-445" href="#__codelineno-7-445"></a>                        <span class="n">postplay_market</span><span class="o">.</span><span class="n">market_definition</span><span class="o">.</span><span class="n">market_time</span><span class="p">,</span>
<a id="__codelineno-7-446" name="__codelineno-7-446" href="#__codelineno-7-446"></a>                        <span class="n">postplay_market</span><span class="o">.</span><span class="n">market_definition</span><span class="o">.</span><span class="n">country_code</span><span class="p">,</span>
<a id="__codelineno-7-447" name="__codelineno-7-447" href="#__codelineno-7-447"></a>                        <span class="n">postplay_market</span><span class="o">.</span><span class="n">market_definition</span><span class="o">.</span><span class="n">venue</span><span class="p">,</span>
<a id="__codelineno-7-448" name="__codelineno-7-448" href="#__codelineno-7-448"></a>                        <span class="n">postplay_market</span><span class="o">.</span><span class="n">market_definition</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-7-449" name="__codelineno-7-449" href="#__codelineno-7-449"></a>                        <span class="n">rdata</span><span class="p">[</span><span class="s1">&#39;selection_id&#39;</span><span class="p">],</span>
<a id="__codelineno-7-450" name="__codelineno-7-450" href="#__codelineno-7-450"></a>                        <span class="n">rdata</span><span class="p">[</span><span class="s1">&#39;selection_name&#39;</span><span class="p">],</span>
<a id="__codelineno-7-451" name="__codelineno-7-451" href="#__codelineno-7-451"></a>                        <span class="n">rdata</span><span class="p">[</span><span class="s1">&#39;selection_status&#39;</span><span class="p">],</span>
<a id="__codelineno-7-452" name="__codelineno-7-452" href="#__codelineno-7-452"></a>                        <span class="n">rdata</span><span class="p">[</span><span class="s1">&#39;sp&#39;</span><span class="p">],</span>
<a id="__codelineno-7-453" name="__codelineno-7-453" href="#__codelineno-7-453"></a>                        <span class="n">rprices</span><span class="p">[</span><span class="s1">&#39;preplay_min&#39;</span><span class="p">],</span>
<a id="__codelineno-7-454" name="__codelineno-7-454" href="#__codelineno-7-454"></a>                        <span class="n">rprices</span><span class="p">[</span><span class="s1">&#39;preplay_max&#39;</span><span class="p">],</span>
<a id="__codelineno-7-455" name="__codelineno-7-455" href="#__codelineno-7-455"></a>                        <span class="n">rprices</span><span class="p">[</span><span class="s1">&#39;preplay_wavg&#39;</span><span class="p">],</span>
<a id="__codelineno-7-456" name="__codelineno-7-456" href="#__codelineno-7-456"></a>                        <span class="n">rprices</span><span class="p">[</span><span class="s1">&#39;preplay_ltp&#39;</span><span class="p">],</span>
<a id="__codelineno-7-457" name="__codelineno-7-457" href="#__codelineno-7-457"></a>                        <span class="n">rprices</span><span class="p">[</span><span class="s1">&#39;preplay_matched&#39;</span><span class="p">],</span>
<a id="__codelineno-7-458" name="__codelineno-7-458" href="#__codelineno-7-458"></a>                        <span class="n">rprices</span><span class="p">[</span><span class="s1">&#39;bsp_matched&#39;</span><span class="p">],</span>
<a id="__codelineno-7-459" name="__codelineno-7-459" href="#__codelineno-7-459"></a>                        <span class="n">rprices</span><span class="p">[</span><span class="s1">&#39;inplay_min&#39;</span><span class="p">],</span>
<a id="__codelineno-7-460" name="__codelineno-7-460" href="#__codelineno-7-460"></a>                        <span class="n">rprices</span><span class="p">[</span><span class="s1">&#39;inplay_max&#39;</span><span class="p">],</span>
<a id="__codelineno-7-461" name="__codelineno-7-461" href="#__codelineno-7-461"></a>                        <span class="n">rprices</span><span class="p">[</span><span class="s1">&#39;inplay_wavg&#39;</span><span class="p">],</span>
<a id="__codelineno-7-462" name="__codelineno-7-462" href="#__codelineno-7-462"></a>                        <span class="n">rprices</span><span class="p">[</span><span class="s1">&#39;inplay_ltp&#39;</span><span class="p">],</span>
<a id="__codelineno-7-463" name="__codelineno-7-463" href="#__codelineno-7-463"></a>                        <span class="n">rprices</span><span class="p">[</span><span class="s1">&#39;inplay_matched&#39;</span><span class="p">],</span>
<a id="__codelineno-7-464" name="__codelineno-7-464" href="#__codelineno-7-464"></a>                    <span class="p">)</span>
<a id="__codelineno-7-465" name="__codelineno-7-465" href="#__codelineno-7-465"></a>                <span class="p">)</span>
<a id="__codelineno-7-466" name="__codelineno-7-466" href="#__codelineno-7-466"></a>
<a id="__codelineno-7-467" name="__codelineno-7-467" href="#__codelineno-7-467"></a>
<a id="__codelineno-7-468" name="__codelineno-7-468" href="#__codelineno-7-468"></a>    <span class="c1">#loading selection file and parsing dates</span>
<a id="__codelineno-7-469" name="__codelineno-7-469" href="#__codelineno-7-469"></a>    <span class="n">selection</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">selection_meta</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;market_id&#39;</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="s1">&#39;selection_id&#39;</span><span class="p">:</span> <span class="nb">object</span><span class="p">},</span> <span class="n">parse_dates</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;event_date&#39;</span><span class="p">])</span>
<a id="__codelineno-7-470" name="__codelineno-7-470" href="#__codelineno-7-470"></a>
<a id="__codelineno-7-471" name="__codelineno-7-471" href="#__codelineno-7-471"></a>    <span class="c1">#loading price file and parsing dates</span>
<a id="__codelineno-7-472" name="__codelineno-7-472" href="#__codelineno-7-472"></a>    <span class="n">prices</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
<a id="__codelineno-7-473" name="__codelineno-7-473" href="#__codelineno-7-473"></a>        <span class="n">prices_path</span><span class="p">,</span> 
<a id="__codelineno-7-474" name="__codelineno-7-474" href="#__codelineno-7-474"></a>        <span class="n">quoting</span><span class="o">=</span><span class="n">csv</span><span class="o">.</span><span class="n">QUOTE_ALL</span><span class="p">,</span>
<a id="__codelineno-7-475" name="__codelineno-7-475" href="#__codelineno-7-475"></a>        <span class="n">dtype</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;market_id&#39;</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span><span class="p">,</span> <span class="s1">&#39;selection_id&#39;</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span><span class="p">,</span> <span class="s1">&#39;atb_ladder&#39;</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span><span class="p">,</span> <span class="s1">&#39;atl_ladder&#39;</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span><span class="p">},</span>
<a id="__codelineno-7-476" name="__codelineno-7-476" href="#__codelineno-7-476"></a>        <span class="n">parse_dates</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span>
<a id="__codelineno-7-477" name="__codelineno-7-477" href="#__codelineno-7-477"></a>    <span class="p">)</span>
<a id="__codelineno-7-478" name="__codelineno-7-478" href="#__codelineno-7-478"></a>
<a id="__codelineno-7-479" name="__codelineno-7-479" href="#__codelineno-7-479"></a>    <span class="c1">#creating the ladder as a dictionary</span>
<a id="__codelineno-7-480" name="__codelineno-7-480" href="#__codelineno-7-480"></a>    <span class="n">prices</span><span class="p">[</span><span class="s1">&#39;atb_ladder&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">prices</span><span class="p">[</span><span class="s1">&#39;atb_ladder&#39;</span><span class="p">]]</span>
<a id="__codelineno-7-481" name="__codelineno-7-481" href="#__codelineno-7-481"></a>    <span class="n">prices</span><span class="p">[</span><span class="s1">&#39;atl_ladder&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">prices</span><span class="p">[</span><span class="s1">&#39;atl_ladder&#39;</span><span class="p">]]</span>
<a id="__codelineno-7-482" name="__codelineno-7-482" href="#__codelineno-7-482"></a>
<a id="__codelineno-7-483" name="__codelineno-7-483" href="#__codelineno-7-483"></a>    <span class="c1">#merging the price and selection files</span>
<a id="__codelineno-7-484" name="__codelineno-7-484" href="#__codelineno-7-484"></a>    <span class="n">df</span> <span class="o">=</span> <span class="n">selection</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">on</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;market_id&#39;</span><span class="p">,</span> <span class="s1">&#39;selection_id&#39;</span><span class="p">])</span>
<a id="__codelineno-7-485" name="__codelineno-7-485" href="#__codelineno-7-485"></a>    <span class="c1">#assigning best prices available and calculating time relative to market start time</span>
<a id="__codelineno-7-486" name="__codelineno-7-486" href="#__codelineno-7-486"></a>    <span class="n">df</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-7-487" name="__codelineno-7-487" href="#__codelineno-7-487"></a>        <span class="n">df</span>
<a id="__codelineno-7-488" name="__codelineno-7-488" href="#__codelineno-7-488"></a>        <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">back_best</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;atb_ladder&#39;</span><span class="p">]])</span>
<a id="__codelineno-7-489" name="__codelineno-7-489" href="#__codelineno-7-489"></a>        <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">lay_best</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;atl_ladder&#39;</span><span class="p">]])</span>
<a id="__codelineno-7-490" name="__codelineno-7-490" href="#__codelineno-7-490"></a>        <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">seconds_before_scheduled_off</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">round</span><span class="p">((</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;event_date&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()))</span>
<a id="__codelineno-7-491" name="__codelineno-7-491" href="#__codelineno-7-491"></a>        <span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;seconds_before_scheduled_off &amp;lt; @log1_Start&#39;</span><span class="p">)</span>
<a id="__codelineno-7-492" name="__codelineno-7-492" href="#__codelineno-7-492"></a>    <span class="p">)</span>
<a id="__codelineno-7-493" name="__codelineno-7-493" href="#__codelineno-7-493"></a>
<a id="__codelineno-7-494" name="__codelineno-7-494" href="#__codelineno-7-494"></a>    <span class="c1">#creating a unique list of market ids</span>
<a id="__codelineno-7-495" name="__codelineno-7-495" href="#__codelineno-7-495"></a>    <span class="n">marketids</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;market_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<a id="__codelineno-7-496" name="__codelineno-7-496" href="#__codelineno-7-496"></a>
<a id="__codelineno-7-497" name="__codelineno-7-497" href="#__codelineno-7-497"></a>    <span class="c1">#writing each market to its own csv file</span>
<a id="__codelineno-7-498" name="__codelineno-7-498" href="#__codelineno-7-498"></a>    <span class="k">for</span> <span class="n">market</span> <span class="ow">in</span> <span class="n">marketids</span><span class="p">:</span>
<a id="__codelineno-7-499" name="__codelineno-7-499" href="#__codelineno-7-499"></a>        <span class="c1">#create a dataframe and a naming convention for this market</span>
<a id="__codelineno-7-500" name="__codelineno-7-500" href="#__codelineno-7-500"></a>        <span class="n">pricing_data</span><span class="o">=</span><span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;market_id&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">market</span><span class="p">)]</span>
<a id="__codelineno-7-501" name="__codelineno-7-501" href="#__codelineno-7-501"></a>        <span class="k">if</span> <span class="n">pricing_data</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
<a id="__codelineno-7-502" name="__codelineno-7-502" href="#__codelineno-7-502"></a>            <span class="k">continue</span>
<a id="__codelineno-7-503" name="__codelineno-7-503" href="#__codelineno-7-503"></a>        <span class="n">race_track</span><span class="o">=</span><span class="n">pricing_data</span><span class="p">[</span><span class="s1">&#39;track&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-7-504" name="__codelineno-7-504" href="#__codelineno-7-504"></a>        <span class="n">market_name</span><span class="o">=</span><span class="n">pricing_data</span><span class="p">[</span><span class="s1">&#39;event_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-7-505" name="__codelineno-7-505" href="#__codelineno-7-505"></a>        <span class="n">market_time</span><span class="o">=</span><span class="n">pricing_data</span><span class="p">[</span><span class="s1">&#39;event_date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-7-506" name="__codelineno-7-506" href="#__codelineno-7-506"></a>        <span class="n">off</span><span class="o">=</span><span class="n">market_time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-7-507" name="__codelineno-7-507" href="#__codelineno-7-507"></a>        <span class="c1">#write race details to the dataframe</span>
<a id="__codelineno-7-508" name="__codelineno-7-508" href="#__codelineno-7-508"></a>        <span class="n">pricing_data</span><span class="p">[</span><span class="s1">&#39;race&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">pricing_data</span><span class="p">[</span><span class="s1">&#39;event_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;R&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-7-509" name="__codelineno-7-509" href="#__codelineno-7-509"></a>        <span class="n">pricing_data</span><span class="p">[</span><span class="s1">&#39;race&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">pricing_data</span><span class="p">[</span><span class="s1">&#39;race&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-7-510" name="__codelineno-7-510" href="#__codelineno-7-510"></a>        <span class="n">pricing_data</span><span class="p">[</span><span class="s1">&#39;distance&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">pricing_data</span><span class="p">[</span><span class="s1">&#39;event_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-7-511" name="__codelineno-7-511" href="#__codelineno-7-511"></a>        <span class="n">pricing_data</span><span class="p">[</span><span class="s1">&#39;distance&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">pricing_data</span><span class="p">[</span><span class="s1">&#39;distance&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;m&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-7-512" name="__codelineno-7-512" href="#__codelineno-7-512"></a>        <span class="n">pricing_data</span><span class="p">[</span><span class="s1">&#39;race_type&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">pricing_data</span><span class="p">[</span><span class="s1">&#39;event_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;m &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-7-513" name="__codelineno-7-513" href="#__codelineno-7-513"></a>        <span class="n">pricing_data</span><span class="p">[</span><span class="s1">&#39;selection_name&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">pricing_data</span><span class="p">[</span><span class="s1">&#39;selection_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;\. &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-7-514" name="__codelineno-7-514" href="#__codelineno-7-514"></a>        <span class="c1">#convert GMT timezone to AEST/AEDT</span>
<a id="__codelineno-7-515" name="__codelineno-7-515" href="#__codelineno-7-515"></a>        <span class="n">pricing_data</span><span class="p">[</span><span class="s1">&#39;event_date&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">pricing_data</span><span class="p">[</span><span class="s1">&#39;event_date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;datetime64[ns]&#39;</span><span class="p">)</span>
<a id="__codelineno-7-516" name="__codelineno-7-516" href="#__codelineno-7-516"></a>        <span class="n">pricing_data</span><span class="p">[</span><span class="s1">&#39;event_date&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">pricing_data</span><span class="p">[</span><span class="s1">&#39;event_date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="s1">&#39;UTC&#39;</span><span class="p">,</span><span class="n">ambiguous</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-7-517" name="__codelineno-7-517" href="#__codelineno-7-517"></a>        <span class="n">pricing_data</span><span class="p">[</span><span class="s1">&#39;event_date&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">pricing_data</span><span class="p">[</span><span class="s1">&#39;event_date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">tz_convert</span><span class="p">(</span><span class="s1">&#39;Australia/Melbourne&#39;</span><span class="p">)</span>
<a id="__codelineno-7-518" name="__codelineno-7-518" href="#__codelineno-7-518"></a>        <span class="n">pricing_data</span><span class="p">[</span><span class="s1">&#39;event_date&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">pricing_data</span><span class="p">[</span><span class="s1">&#39;event_date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-7-519" name="__codelineno-7-519" href="#__codelineno-7-519"></a>        <span class="n">pricing_data</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">pricing_data</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;datetime64[ns]&#39;</span><span class="p">)</span>
<a id="__codelineno-7-520" name="__codelineno-7-520" href="#__codelineno-7-520"></a>        <span class="n">pricing_data</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">pricing_data</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="s1">&#39;UTC&#39;</span><span class="p">,</span><span class="n">ambiguous</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-7-521" name="__codelineno-7-521" href="#__codelineno-7-521"></a>        <span class="n">pricing_data</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">pricing_data</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">tz_convert</span><span class="p">(</span><span class="s1">&#39;Australia/Melbourne&#39;</span><span class="p">)</span>
<a id="__codelineno-7-522" name="__codelineno-7-522" href="#__codelineno-7-522"></a>        <span class="n">pricing_data</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">pricing_data</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-7-523" name="__codelineno-7-523" href="#__codelineno-7-523"></a>        <span class="c1">#covert GBP to AUD</span>
<a id="__codelineno-7-524" name="__codelineno-7-524" href="#__codelineno-7-524"></a>        <span class="n">event_date</span><span class="o">=</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">pricing_data</span><span class="p">[</span><span class="s1">&#39;event_date&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">)</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-7-525" name="__codelineno-7-525" href="#__codelineno-7-525"></a>        <span class="n">conversion_rate</span><span class="o">=</span><span class="n">CurrencyConverter</span><span class="p">(</span><span class="n">fallback_on_missing_rate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;GBP&#39;</span><span class="p">,</span><span class="s1">&#39;AUD&#39;</span><span class="p">,</span><span class="n">date</span><span class="o">=</span><span class="n">event_date</span><span class="p">)</span>
<a id="__codelineno-7-526" name="__codelineno-7-526" href="#__codelineno-7-526"></a>        <span class="n">pricing_data</span><span class="p">[</span><span class="s1">&#39;traded_volume&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">pricing_data</span><span class="p">[</span><span class="s1">&#39;traded_volume&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">conversion_rate</span>
<a id="__codelineno-7-527" name="__codelineno-7-527" href="#__codelineno-7-527"></a>        <span class="n">pricing_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">pricing_data</span><span class="p">[</span><span class="s1">&#39;traded_volume&#39;</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span> <span class="mi">0</span><span class="p">),</span> <span class="s1">&#39;traded_volume&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-7-528" name="__codelineno-7-528" href="#__codelineno-7-528"></a>        <span class="n">pricing_data</span><span class="p">[</span><span class="s1">&#39;traded_volume&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pricing_data</span><span class="p">[</span><span class="s1">&#39;traded_volume&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">decimals</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-7-529" name="__codelineno-7-529" href="#__codelineno-7-529"></a>        <span class="c1">#reorder the dataframe and write to csv</span>
<a id="__codelineno-7-530" name="__codelineno-7-530" href="#__codelineno-7-530"></a>        <span class="n">pricing_data</span><span class="o">=</span><span class="n">pricing_data</span><span class="p">[[</span><span class="s1">&#39;event_date&#39;</span><span class="p">,</span><span class="s1">&#39;country&#39;</span><span class="p">,</span><span class="s1">&#39;track&#39;</span><span class="p">,</span><span class="s1">&#39;race&#39;</span><span class="p">,</span><span class="s1">&#39;distance&#39;</span><span class="p">,</span><span class="s1">&#39;race_type&#39;</span><span class="p">,</span><span class="s1">&#39;market_id&#39;</span><span class="p">,</span><span class="s1">&#39;selection_id&#39;</span><span class="p">,</span><span class="s1">&#39;selection_name&#39;</span><span class="p">,</span><span class="s2">&quot;selection_status&quot;</span><span class="p">,</span><span class="s1">&#39;reduction_factor&#39;</span><span class="p">,</span><span class="s1">&#39;result&#39;</span><span class="p">,</span><span class="s1">&#39;bsp&#39;</span><span class="p">,</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;traded_volume&#39;</span><span class="p">,</span><span class="s1">&#39;wap&#39;</span><span class="p">,</span><span class="s1">&#39;ltp&#39;</span><span class="p">,</span><span class="s1">&#39;atb_ladder&#39;</span><span class="p">,</span><span class="s1">&#39;atl_ladder&#39;</span><span class="p">,</span><span class="s1">&#39;back_best&#39;</span><span class="p">,</span><span class="s1">&#39;lay_best&#39;</span><span class="p">,</span><span class="s1">&#39;seconds_before_scheduled_off&#39;</span><span class="p">,</span><span class="s1">&#39;sp_near&#39;</span><span class="p">,</span><span class="s1">&#39;sp_far&#39;</span><span class="p">,</span><span class="s1">&#39;pp_min&#39;</span><span class="p">,</span><span class="s1">&#39;pp_max&#39;</span><span class="p">,</span><span class="s1">&#39;pp_wap&#39;</span><span class="p">,</span><span class="s1">&#39;pp_ltp&#39;</span><span class="p">,</span><span class="s1">&#39;pp_volume&#39;</span><span class="p">,</span><span class="s1">&#39;bsp_volume&#39;</span><span class="p">,</span><span class="s1">&#39;ip_min&#39;</span><span class="p">,</span><span class="s1">&#39;ip_max&#39;</span><span class="p">,</span><span class="s1">&#39;ip_wap&#39;</span><span class="p">,</span><span class="s1">&#39;ip_ltp&#39;</span><span class="p">,</span><span class="s1">&#39;ip_volume&#39;</span><span class="p">]]</span>
<a id="__codelineno-7-531" name="__codelineno-7-531" href="#__codelineno-7-531"></a>        <span class="n">pricing_data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">file_directory</span><span class="o">+</span><span class="n">off</span><span class="o">+</span><span class="s1">&#39; - &#39;</span><span class="o">+</span><span class="n">race_track</span><span class="o">+</span><span class="s1">&#39; - &#39;</span><span class="o">+</span><span class="n">market_name</span><span class="o">+</span><span class="s1">&#39;.csv&#39;</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-7-532" name="__codelineno-7-532" href="#__codelineno-7-532"></a>
<a id="__codelineno-7-533" name="__codelineno-7-533" href="#__codelineno-7-533"></a>
<a id="__codelineno-7-534" name="__codelineno-7-534" href="#__codelineno-7-534"></a><span class="c1">#removing intermediate working documents to clean up</span>
<a id="__codelineno-7-535" name="__codelineno-7-535" href="#__codelineno-7-535"></a><span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">selection_meta</span><span class="p">)</span>
<a id="__codelineno-7-536" name="__codelineno-7-536" href="#__codelineno-7-536"></a><span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">prices_path</span><span class="p">)</span>
</code></pre></div>

</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="22-complete-code-sports-processor">2.2 Complete Code Sports Processor</h3>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="kn">import</span> <span class="nn">os</span>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="kn">import</span> <span class="nn">csv</span>
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a><span class="kn">import</span> <span class="nn">csv</span>
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a><span class="kn">import</span> <span class="nn">tarfile</span>
<a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a><span class="kn">import</span> <span class="nn">zipfile</span>
<a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a><span class="kn">import</span> <span class="nn">bz2</span>
<a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a><span class="kn">import</span> <span class="nn">glob</span>
<a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a><span class="kn">import</span> <span class="nn">ast</span>
<a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a><span class="kn">from</span> <span class="nn">unittest.mock</span> <span class="kn">import</span> <span class="n">patch</span>
<a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a><span class="kn">import</span> <span class="nn">betfairlightweight</span>
<a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a><span class="kn">from</span> <span class="nn">betfairlightweight</span> <span class="kn">import</span> <span class="n">StreamListener</span>
<a id="__codelineno-8-14" name="__codelineno-8-14" href="#__codelineno-8-14"></a><span class="kn">from</span> <span class="nn">betfair_data</span> <span class="kn">import</span> <span class="n">bflw</span> <span class="c1">#&quot;Import &quot;betfair_data.bflw&quot; could not be resolved from source&quot; - This is a known issue, the script should still run</span>
<a id="__codelineno-8-15" name="__codelineno-8-15" href="#__codelineno-8-15"></a><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<a id="__codelineno-8-16" name="__codelineno-8-16" href="#__codelineno-8-16"></a><span class="kn">from</span> <span class="nn">currency_converter</span> <span class="kn">import</span> <span class="n">CurrencyConverter</span>
<a id="__codelineno-8-17" name="__codelineno-8-17" href="#__codelineno-8-17"></a><span class="kn">from</span> <span class="nn">pandas.errors</span> <span class="kn">import</span> <span class="n">SettingWithCopyWarning</span>
<a id="__codelineno-8-18" name="__codelineno-8-18" href="#__codelineno-8-18"></a><span class="kn">import</span> <span class="nn">warnings</span>
<a id="__codelineno-8-19" name="__codelineno-8-19" href="#__codelineno-8-19"></a><span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">SettingWithCopyWarning</span><span class="p">)</span>
<a id="__codelineno-8-20" name="__codelineno-8-20" href="#__codelineno-8-20"></a>
<a id="__codelineno-8-21" name="__codelineno-8-21" href="#__codelineno-8-21"></a><span class="n">file_directory</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="c1"># INSERT FILE DIRECTORY WHERE TAR FILES ARE STORED</span>
<a id="__codelineno-8-22" name="__codelineno-8-22" href="#__codelineno-8-22"></a>
<a id="__codelineno-8-23" name="__codelineno-8-23" href="#__codelineno-8-23"></a><span class="n">log1_Start</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span>  <span class="c1"># seconds before scheduled off to start recording data for data segment one</span>
<a id="__codelineno-8-24" name="__codelineno-8-24" href="#__codelineno-8-24"></a><span class="n">log1_Step</span> <span class="o">=</span> <span class="mi">60</span>  <span class="c1"># seconds between log steps for first data segment</span>
<a id="__codelineno-8-25" name="__codelineno-8-25" href="#__codelineno-8-25"></a><span class="n">log2_Start</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">10</span>  <span class="c1"># seconds before scheduled off to start recording data for data segment two</span>
<a id="__codelineno-8-26" name="__codelineno-8-26" href="#__codelineno-8-26"></a><span class="n">log2_Step</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c1"># seconds between log steps for second data segment</span>
<a id="__codelineno-8-27" name="__codelineno-8-27" href="#__codelineno-8-27"></a>
<a id="__codelineno-8-28" name="__codelineno-8-28" href="#__codelineno-8-28"></a>
<a id="__codelineno-8-29" name="__codelineno-8-29" href="#__codelineno-8-29"></a><span class="k">def</span> <span class="nf">filter_market</span><span class="p">(</span><span class="n">market</span><span class="p">:</span> <span class="n">bflw</span><span class="o">.</span><span class="n">MarketBook</span><span class="p">)</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-8-30" name="__codelineno-8-30" href="#__codelineno-8-30"></a>    <span class="n">d</span> <span class="o">=</span> <span class="n">market</span><span class="o">.</span><span class="n">market_definition</span>
<a id="__codelineno-8-31" name="__codelineno-8-31" href="#__codelineno-8-31"></a>    <span class="k">return</span> <span class="p">(</span>
<a id="__codelineno-8-32" name="__codelineno-8-32" href="#__codelineno-8-32"></a>        <span class="n">d</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
<a id="__codelineno-8-33" name="__codelineno-8-33" href="#__codelineno-8-33"></a>        <span class="c1"># and d.country_code in [&#39;ES&#39;]</span>
<a id="__codelineno-8-34" name="__codelineno-8-34" href="#__codelineno-8-34"></a>        <span class="c1"># and d.market_type == &#39;MATCH_ODDS&#39;</span>
<a id="__codelineno-8-35" name="__codelineno-8-35" href="#__codelineno-8-35"></a>        <span class="ow">and</span> <span class="n">d</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Match Odds&#39;</span><span class="p">,</span> <span class="s1">&#39;1st Innings 20 Overs Line&#39;</span><span class="p">]</span>
<a id="__codelineno-8-36" name="__codelineno-8-36" href="#__codelineno-8-36"></a>        <span class="c1"># and d.betting_type == &#39;ODDS&#39;</span>
<a id="__codelineno-8-37" name="__codelineno-8-37" href="#__codelineno-8-37"></a>    <span class="p">)</span>
<a id="__codelineno-8-38" name="__codelineno-8-38" href="#__codelineno-8-38"></a>
<a id="__codelineno-8-39" name="__codelineno-8-39" href="#__codelineno-8-39"></a><span class="c1"># Simply add the below variable name to the market filter function above with the filter value</span>
<a id="__codelineno-8-40" name="__codelineno-8-40" href="#__codelineno-8-40"></a><span class="c1"># Equals (== &#39;Value in Quotation&#39; or True/False/None), Does Not Equal (!= &#39;Value in Quotation&#39; or True/False/None) - FOR ALL TYPES</span>
<a id="__codelineno-8-41" name="__codelineno-8-41" href="#__codelineno-8-41"></a><span class="c1"># Greater than (&amp;gt;), Greater than or equal to (&amp;gt;=), Less than (&amp;lt;), Less than or equal to (&amp;lt;=) - FOR INT/FLOAT</span>
<a id="__codelineno-8-42" name="__codelineno-8-42" href="#__codelineno-8-42"></a><span class="c1"># For list of value &#39;in&#39;</span>
<a id="__codelineno-8-43" name="__codelineno-8-43" href="#__codelineno-8-43"></a>
<a id="__codelineno-8-44" name="__codelineno-8-44" href="#__codelineno-8-44"></a><span class="c1"># and d.betting_type: str - ODDS, ASIAN_HANDICAP_SINGLES, ASIAN_HANDICAP_DOUBLES or LINE</span>
<a id="__codelineno-8-45" name="__codelineno-8-45" href="#__codelineno-8-45"></a><span class="c1"># and d.bsp_market: bool - True, False</span>
<a id="__codelineno-8-46" name="__codelineno-8-46" href="#__codelineno-8-46"></a><span class="c1"># and d.country_code: str - list of codes can be found here: https://en.wikipedia.org/wiki/ISO_3166-1_alpha-2 - Default value is &#39;GB&#39; - Australia = &#39;AU&#39;, New Zealand = &#39;NZ&#39;</span>
<a id="__codelineno-8-47" name="__codelineno-8-47" href="#__codelineno-8-47"></a><span class="c1"># and d.event_id: str - PARENT_EVENT_ID</span>
<a id="__codelineno-8-48" name="__codelineno-8-48" href="#__codelineno-8-48"></a><span class="c1"># and d.event_name: Optional[str] - Usually the name of the Match-Up (e.g. Bangladesh v Sri Lanka) or Race Name (e.g. R6 1400m Grp1) - Note: Dictionaries don&#39;t support wildcard searches</span>
<a id="__codelineno-8-49" name="__codelineno-8-49" href="#__codelineno-8-49"></a><span class="c1"># and d.event_type_id: str - SportID [Soccer - 1, Tennis - 2, Golf - 3, Cricket - 4, AFL - 61420]</span>
<a id="__codelineno-8-50" name="__codelineno-8-50" href="#__codelineno-8-50"></a><span class="c1"># and d.market_base_rate: float - Market Commission Rate</span>
<a id="__codelineno-8-51" name="__codelineno-8-51" href="#__codelineno-8-51"></a><span class="c1"># and d.market_type: str - e.g. &quot;MATCH_ODDS&quot;, &quot;1ST_INNINGS_RUNS&quot;,&quot;TO_QUALIFY&quot; - always all caps with &quot;_&quot; replacing spaces</span>
<a id="__codelineno-8-52" name="__codelineno-8-52" href="#__codelineno-8-52"></a><span class="c1"># and d.name: Optional[str] - market name (e.g. Sri Lanka 1st Inns Runs)</span>
<a id="__codelineno-8-53" name="__codelineno-8-53" href="#__codelineno-8-53"></a><span class="c1"># and d.number_of_active_runners: int - Head-To-Heads markets will be 2</span>
<a id="__codelineno-8-54" name="__codelineno-8-54" href="#__codelineno-8-54"></a><span class="c1"># and d.number_of_winners: int - Odds Markets usually 1, Line/Handicap markets usually 0</span>
<a id="__codelineno-8-55" name="__codelineno-8-55" href="#__codelineno-8-55"></a><span class="c1"># and d.regulators: str - &#39;MR_INT&#39; to remove ring-fenced exchange markets </span>
<a id="__codelineno-8-56" name="__codelineno-8-56" href="#__codelineno-8-56"></a><span class="c1"># and d.turn_in_play_enabled: bool - True, False</span>
<a id="__codelineno-8-57" name="__codelineno-8-57" href="#__codelineno-8-57"></a>
<a id="__codelineno-8-58" name="__codelineno-8-58" href="#__codelineno-8-58"></a>
<a id="__codelineno-8-59" name="__codelineno-8-59" href="#__codelineno-8-59"></a><span class="n">trading</span> <span class="o">=</span> <span class="n">betfairlightweight</span><span class="o">.</span><span class="n">APIClient</span><span class="p">(</span><span class="n">username</span> <span class="o">=</span> <span class="s2">&quot;username&quot;</span><span class="p">,</span> <span class="n">password</span> <span class="o">=</span> <span class="s2">&quot;password&quot;</span><span class="p">,</span> <span class="n">app_key</span><span class="o">=</span><span class="s2">&quot;app_key&quot;</span><span class="p">)</span>
<a id="__codelineno-8-60" name="__codelineno-8-60" href="#__codelineno-8-60"></a><span class="n">listener</span> <span class="o">=</span> <span class="n">StreamListener</span><span class="p">(</span><span class="n">max_latency</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-8-61" name="__codelineno-8-61" href="#__codelineno-8-61"></a><span class="n">stream_files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">file_directory</span><span class="o">+</span><span class="s2">&quot;*.tar&quot;</span><span class="p">)</span> 
<a id="__codelineno-8-62" name="__codelineno-8-62" href="#__codelineno-8-62"></a><span class="n">selection_meta</span> <span class="o">=</span> <span class="n">file_directory</span><span class="o">+</span><span class="s2">&quot;metadata.csv&quot;</span>
<a id="__codelineno-8-63" name="__codelineno-8-63" href="#__codelineno-8-63"></a><span class="n">prices_path</span> <span class="o">=</span>  <span class="n">file_directory</span><span class="o">+</span><span class="s2">&quot;preplay.csv&quot;</span>
<a id="__codelineno-8-64" name="__codelineno-8-64" href="#__codelineno-8-64"></a>
<a id="__codelineno-8-65" name="__codelineno-8-65" href="#__codelineno-8-65"></a><span class="c1"># rounding to 2 decimal places or returning &#39;&#39; if blank</span>
<a id="__codelineno-8-66" name="__codelineno-8-66" href="#__codelineno-8-66"></a><span class="k">def</span> <span class="nf">as_str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-8-67" name="__codelineno-8-67" href="#__codelineno-8-67"></a>    <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">v</span> <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="n">v</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
<a id="__codelineno-8-68" name="__codelineno-8-68" href="#__codelineno-8-68"></a>
<a id="__codelineno-8-69" name="__codelineno-8-69" href="#__codelineno-8-69"></a><span class="c1"># returning smaller of two numbers where min not 0</span>
<a id="__codelineno-8-70" name="__codelineno-8-70" href="#__codelineno-8-70"></a><span class="k">def</span> <span class="nf">min_gr0</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="nb">float</span><span class="p">:</span>
<a id="__codelineno-8-71" name="__codelineno-8-71" href="#__codelineno-8-71"></a>    <span class="k">if</span> <span class="n">a</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="o">=</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-8-72" name="__codelineno-8-72" href="#__codelineno-8-72"></a>        <span class="k">return</span> <span class="n">b</span>
<a id="__codelineno-8-73" name="__codelineno-8-73" href="#__codelineno-8-73"></a>    <span class="k">if</span> <span class="n">b</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="o">=</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-8-74" name="__codelineno-8-74" href="#__codelineno-8-74"></a>        <span class="k">return</span> <span class="n">a</span>
<a id="__codelineno-8-75" name="__codelineno-8-75" href="#__codelineno-8-75"></a>
<a id="__codelineno-8-76" name="__codelineno-8-76" href="#__codelineno-8-76"></a>    <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
<a id="__codelineno-8-77" name="__codelineno-8-77" href="#__codelineno-8-77"></a>
<a id="__codelineno-8-78" name="__codelineno-8-78" href="#__codelineno-8-78"></a><span class="k">def</span> <span class="nf">load_markets</span><span class="p">(</span><span class="n">file_paths</span><span class="p">):</span>
<a id="__codelineno-8-79" name="__codelineno-8-79" href="#__codelineno-8-79"></a>    <span class="k">for</span> <span class="n">file_path</span> <span class="ow">in</span> <span class="n">file_paths</span><span class="p">:</span>
<a id="__codelineno-8-80" name="__codelineno-8-80" href="#__codelineno-8-80"></a>        <span class="nb">print</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
<a id="__codelineno-8-81" name="__codelineno-8-81" href="#__codelineno-8-81"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;__ Parsing Detailed Prices ___ &quot;</span><span class="p">)</span>
<a id="__codelineno-8-82" name="__codelineno-8-82" href="#__codelineno-8-82"></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
<a id="__codelineno-8-83" name="__codelineno-8-83" href="#__codelineno-8-83"></a>            <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">iglob</span><span class="p">(</span><span class="n">file_path</span> <span class="o">+</span> <span class="s1">&#39;**/**/*.bz2&#39;</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<a id="__codelineno-8-84" name="__codelineno-8-84" href="#__codelineno-8-84"></a>                <span class="n">f</span> <span class="o">=</span> <span class="n">bz2</span><span class="o">.</span><span class="n">BZ2File</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
<a id="__codelineno-8-85" name="__codelineno-8-85" href="#__codelineno-8-85"></a>                <span class="k">yield</span> <span class="n">f</span>
<a id="__codelineno-8-86" name="__codelineno-8-86" href="#__codelineno-8-86"></a>                <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<a id="__codelineno-8-87" name="__codelineno-8-87" href="#__codelineno-8-87"></a>        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
<a id="__codelineno-8-88" name="__codelineno-8-88" href="#__codelineno-8-88"></a>            <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file_path</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-8-89" name="__codelineno-8-89" href="#__codelineno-8-89"></a>            <span class="c1"># iterate through a tar archive</span>
<a id="__codelineno-8-90" name="__codelineno-8-90" href="#__codelineno-8-90"></a>            <span class="k">if</span> <span class="n">ext</span> <span class="o">==</span> <span class="s1">&#39;.tar&#39;</span><span class="p">:</span>
<a id="__codelineno-8-91" name="__codelineno-8-91" href="#__codelineno-8-91"></a>                <span class="k">with</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">TarFile</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">archive</span><span class="p">:</span>
<a id="__codelineno-8-92" name="__codelineno-8-92" href="#__codelineno-8-92"></a>                    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">archive</span><span class="p">:</span>
<a id="__codelineno-8-93" name="__codelineno-8-93" href="#__codelineno-8-93"></a>                        <span class="k">yield</span> <span class="n">bz2</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">archive</span><span class="o">.</span><span class="n">extractfile</span><span class="p">(</span><span class="n">file</span><span class="p">))</span>
<a id="__codelineno-8-94" name="__codelineno-8-94" href="#__codelineno-8-94"></a>            <span class="c1"># or a zip archive</span>
<a id="__codelineno-8-95" name="__codelineno-8-95" href="#__codelineno-8-95"></a>            <span class="k">elif</span> <span class="n">ext</span> <span class="o">==</span> <span class="s1">&#39;.zip&#39;</span><span class="p">:</span>
<a id="__codelineno-8-96" name="__codelineno-8-96" href="#__codelineno-8-96"></a>                <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">archive</span><span class="p">:</span>
<a id="__codelineno-8-97" name="__codelineno-8-97" href="#__codelineno-8-97"></a>                    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">archive</span><span class="o">.</span><span class="n">namelist</span><span class="p">():</span>
<a id="__codelineno-8-98" name="__codelineno-8-98" href="#__codelineno-8-98"></a>                        <span class="k">yield</span> <span class="n">bz2</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">archive</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file</span><span class="p">))</span>
<a id="__codelineno-8-99" name="__codelineno-8-99" href="#__codelineno-8-99"></a>
<a id="__codelineno-8-100" name="__codelineno-8-100" href="#__codelineno-8-100"></a>    <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-8-101" name="__codelineno-8-101" href="#__codelineno-8-101"></a>
<a id="__codelineno-8-102" name="__codelineno-8-102" href="#__codelineno-8-102"></a><span class="k">def</span> <span class="nf">slicePrice</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
<a id="__codelineno-8-103" name="__codelineno-8-103" href="#__codelineno-8-103"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-8-104" name="__codelineno-8-104" href="#__codelineno-8-104"></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">price</span>
<a id="__codelineno-8-105" name="__codelineno-8-105" href="#__codelineno-8-105"></a>    <span class="k">except</span><span class="p">:</span>
<a id="__codelineno-8-106" name="__codelineno-8-106" href="#__codelineno-8-106"></a>        <span class="n">x</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-8-107" name="__codelineno-8-107" href="#__codelineno-8-107"></a>    <span class="k">return</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-8-108" name="__codelineno-8-108" href="#__codelineno-8-108"></a>
<a id="__codelineno-8-109" name="__codelineno-8-109" href="#__codelineno-8-109"></a><span class="k">def</span> <span class="nf">sliceSize</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
<a id="__codelineno-8-110" name="__codelineno-8-110" href="#__codelineno-8-110"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-8-111" name="__codelineno-8-111" href="#__codelineno-8-111"></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">size</span>
<a id="__codelineno-8-112" name="__codelineno-8-112" href="#__codelineno-8-112"></a>    <span class="k">except</span><span class="p">:</span>
<a id="__codelineno-8-113" name="__codelineno-8-113" href="#__codelineno-8-113"></a>        <span class="n">x</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-8-114" name="__codelineno-8-114" href="#__codelineno-8-114"></a>    <span class="k">return</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-8-115" name="__codelineno-8-115" href="#__codelineno-8-115"></a>
<a id="__codelineno-8-116" name="__codelineno-8-116" href="#__codelineno-8-116"></a><span class="k">def</span> <span class="nf">pull_ladder</span><span class="p">(</span><span class="n">availableLadder</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">3</span><span class="p">):</span>
<a id="__codelineno-8-117" name="__codelineno-8-117" href="#__codelineno-8-117"></a>        <span class="n">out</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-8-118" name="__codelineno-8-118" href="#__codelineno-8-118"></a>        <span class="n">price</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-8-119" name="__codelineno-8-119" href="#__codelineno-8-119"></a>        <span class="n">volume</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-8-120" name="__codelineno-8-120" href="#__codelineno-8-120"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">availableLadder</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-8-121" name="__codelineno-8-121" href="#__codelineno-8-121"></a>            <span class="k">return</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>        
<a id="__codelineno-8-122" name="__codelineno-8-122" href="#__codelineno-8-122"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-8-123" name="__codelineno-8-123" href="#__codelineno-8-123"></a>            <span class="k">for</span> <span class="n">rung</span> <span class="ow">in</span> <span class="n">availableLadder</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">n</span><span class="p">]:</span>
<a id="__codelineno-8-124" name="__codelineno-8-124" href="#__codelineno-8-124"></a>                <span class="n">price</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rung</span><span class="o">.</span><span class="n">price</span><span class="p">)</span>
<a id="__codelineno-8-125" name="__codelineno-8-125" href="#__codelineno-8-125"></a>                <span class="n">volume</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rung</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
<a id="__codelineno-8-126" name="__codelineno-8-126" href="#__codelineno-8-126"></a>
<a id="__codelineno-8-127" name="__codelineno-8-127" href="#__codelineno-8-127"></a>            <span class="n">out</span><span class="p">[</span><span class="s2">&quot;p&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">price</span>
<a id="__codelineno-8-128" name="__codelineno-8-128" href="#__codelineno-8-128"></a>            <span class="n">out</span><span class="p">[</span><span class="s2">&quot;v&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">volume</span>
<a id="__codelineno-8-129" name="__codelineno-8-129" href="#__codelineno-8-129"></a>            <span class="k">return</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
<a id="__codelineno-8-130" name="__codelineno-8-130" href="#__codelineno-8-130"></a>
<a id="__codelineno-8-131" name="__codelineno-8-131" href="#__codelineno-8-131"></a><span class="k">def</span> <span class="nf">final_market_book</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
<a id="__codelineno-8-132" name="__codelineno-8-132" href="#__codelineno-8-132"></a>
<a id="__codelineno-8-133" name="__codelineno-8-133" href="#__codelineno-8-133"></a>    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s2">&quot;builtins.open&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">f</span><span class="p">,</span> <span class="n">_</span><span class="p">:</span> <span class="n">f</span><span class="p">):</span>
<a id="__codelineno-8-134" name="__codelineno-8-134" href="#__codelineno-8-134"></a>
<a id="__codelineno-8-135" name="__codelineno-8-135" href="#__codelineno-8-135"></a>        <span class="n">gen</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">get_generator</span><span class="p">()</span>
<a id="__codelineno-8-136" name="__codelineno-8-136" href="#__codelineno-8-136"></a>
<a id="__codelineno-8-137" name="__codelineno-8-137" href="#__codelineno-8-137"></a>        <span class="k">for</span> <span class="n">market_books</span> <span class="ow">in</span> <span class="n">gen</span><span class="p">():</span>
<a id="__codelineno-8-138" name="__codelineno-8-138" href="#__codelineno-8-138"></a>
<a id="__codelineno-8-139" name="__codelineno-8-139" href="#__codelineno-8-139"></a>            <span class="c1"># Check if this market book meets our market filter ++++++++++++++++++++++++++++++++++</span>
<a id="__codelineno-8-140" name="__codelineno-8-140" href="#__codelineno-8-140"></a>
<a id="__codelineno-8-141" name="__codelineno-8-141" href="#__codelineno-8-141"></a>            <span class="k">if</span> <span class="p">((</span><span class="n">evaluate_market</span> <span class="o">:=</span> <span class="n">filter_market</span><span class="p">(</span><span class="n">market_books</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">==</span> <span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-8-142" name="__codelineno-8-142" href="#__codelineno-8-142"></a>                    <span class="k">return</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-8-143" name="__codelineno-8-143" href="#__codelineno-8-143"></a>
<a id="__codelineno-8-144" name="__codelineno-8-144" href="#__codelineno-8-144"></a>            <span class="k">for</span> <span class="n">market_book</span> <span class="ow">in</span> <span class="n">market_books</span><span class="p">:</span>
<a id="__codelineno-8-145" name="__codelineno-8-145" href="#__codelineno-8-145"></a>
<a id="__codelineno-8-146" name="__codelineno-8-146" href="#__codelineno-8-146"></a>                <span class="n">last_market_book</span> <span class="o">=</span> <span class="n">market_book</span>
<a id="__codelineno-8-147" name="__codelineno-8-147" href="#__codelineno-8-147"></a>
<a id="__codelineno-8-148" name="__codelineno-8-148" href="#__codelineno-8-148"></a>        <span class="k">return</span><span class="p">(</span><span class="n">last_market_book</span><span class="p">)</span>
<a id="__codelineno-8-149" name="__codelineno-8-149" href="#__codelineno-8-149"></a>
<a id="__codelineno-8-150" name="__codelineno-8-150" href="#__codelineno-8-150"></a><span class="k">def</span> <span class="nf">loop_prices</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">o</span><span class="p">):</span>
<a id="__codelineno-8-151" name="__codelineno-8-151" href="#__codelineno-8-151"></a>
<a id="__codelineno-8-152" name="__codelineno-8-152" href="#__codelineno-8-152"></a>    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s2">&quot;builtins.open&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">f</span><span class="p">,</span> <span class="n">_</span><span class="p">:</span> <span class="n">f</span><span class="p">):</span>
<a id="__codelineno-8-153" name="__codelineno-8-153" href="#__codelineno-8-153"></a>
<a id="__codelineno-8-154" name="__codelineno-8-154" href="#__codelineno-8-154"></a>        <span class="n">gen</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">get_generator</span><span class="p">()</span>
<a id="__codelineno-8-155" name="__codelineno-8-155" href="#__codelineno-8-155"></a>
<a id="__codelineno-8-156" name="__codelineno-8-156" href="#__codelineno-8-156"></a>        <span class="n">marketID</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-8-157" name="__codelineno-8-157" href="#__codelineno-8-157"></a>        <span class="n">tradeVols</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-8-158" name="__codelineno-8-158" href="#__codelineno-8-158"></a>        <span class="n">time</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-8-159" name="__codelineno-8-159" href="#__codelineno-8-159"></a>
<a id="__codelineno-8-160" name="__codelineno-8-160" href="#__codelineno-8-160"></a>        <span class="k">for</span> <span class="n">market_books</span> <span class="ow">in</span> <span class="n">gen</span><span class="p">():</span>
<a id="__codelineno-8-161" name="__codelineno-8-161" href="#__codelineno-8-161"></a>
<a id="__codelineno-8-162" name="__codelineno-8-162" href="#__codelineno-8-162"></a>            <span class="c1"># Check if this market book meets our market filter ++++++++++++++++++++++++++++++++++</span>
<a id="__codelineno-8-163" name="__codelineno-8-163" href="#__codelineno-8-163"></a>
<a id="__codelineno-8-164" name="__codelineno-8-164" href="#__codelineno-8-164"></a>            <span class="k">if</span> <span class="p">((</span><span class="n">evaluate_market</span> <span class="o">:=</span> <span class="n">filter_market</span><span class="p">(</span><span class="n">market_books</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">==</span> <span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-8-165" name="__codelineno-8-165" href="#__codelineno-8-165"></a>                    <span class="k">break</span>
<a id="__codelineno-8-166" name="__codelineno-8-166" href="#__codelineno-8-166"></a>
<a id="__codelineno-8-167" name="__codelineno-8-167" href="#__codelineno-8-167"></a>            <span class="k">for</span> <span class="n">market_book</span> <span class="ow">in</span> <span class="n">market_books</span><span class="p">:</span>
<a id="__codelineno-8-168" name="__codelineno-8-168" href="#__codelineno-8-168"></a>
<a id="__codelineno-8-169" name="__codelineno-8-169" href="#__codelineno-8-169"></a>                <span class="c1"># Time Step Management ++++++++++++++++++++++++++++++++++</span>
<a id="__codelineno-8-170" name="__codelineno-8-170" href="#__codelineno-8-170"></a>
<a id="__codelineno-8-171" name="__codelineno-8-171" href="#__codelineno-8-171"></a>                <span class="k">if</span> <span class="n">marketID</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-8-172" name="__codelineno-8-172" href="#__codelineno-8-172"></a>
<a id="__codelineno-8-173" name="__codelineno-8-173" href="#__codelineno-8-173"></a>                    <span class="c1"># No market initialised</span>
<a id="__codelineno-8-174" name="__codelineno-8-174" href="#__codelineno-8-174"></a>                    <span class="n">marketID</span> <span class="o">=</span> <span class="n">market_book</span><span class="o">.</span><span class="n">market_id</span>
<a id="__codelineno-8-175" name="__codelineno-8-175" href="#__codelineno-8-175"></a>                    <span class="n">time</span> <span class="o">=</span>  <span class="n">market_book</span><span class="o">.</span><span class="n">publish_time</span>
<a id="__codelineno-8-176" name="__codelineno-8-176" href="#__codelineno-8-176"></a>
<a id="__codelineno-8-177" name="__codelineno-8-177" href="#__codelineno-8-177"></a>                <span class="k">elif</span> <span class="n">market_book</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;CLOSED&quot;</span><span class="p">:</span>
<a id="__codelineno-8-178" name="__codelineno-8-178" href="#__codelineno-8-178"></a>
<a id="__codelineno-8-179" name="__codelineno-8-179" href="#__codelineno-8-179"></a>                    <span class="c1"># Stop once market settled</span>
<a id="__codelineno-8-180" name="__codelineno-8-180" href="#__codelineno-8-180"></a>                    <span class="k">break</span>
<a id="__codelineno-8-181" name="__codelineno-8-181" href="#__codelineno-8-181"></a>
<a id="__codelineno-8-182" name="__codelineno-8-182" href="#__codelineno-8-182"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-8-183" name="__codelineno-8-183" href="#__codelineno-8-183"></a>
<a id="__codelineno-8-184" name="__codelineno-8-184" href="#__codelineno-8-184"></a>                    <span class="n">seconds_to_start</span> <span class="o">=</span> <span class="p">(</span><span class="n">market_book</span><span class="o">.</span><span class="n">market_definition</span><span class="o">.</span><span class="n">market_time</span> <span class="o">-</span> <span class="n">market_book</span><span class="o">.</span><span class="n">publish_time</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
<a id="__codelineno-8-185" name="__codelineno-8-185" href="#__codelineno-8-185"></a>
<a id="__codelineno-8-186" name="__codelineno-8-186" href="#__codelineno-8-186"></a>                    <span class="k">if</span> <span class="n">seconds_to_start</span> <span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="n">log1_Start</span><span class="p">:</span>
<a id="__codelineno-8-187" name="__codelineno-8-187" href="#__codelineno-8-187"></a>
<a id="__codelineno-8-188" name="__codelineno-8-188" href="#__codelineno-8-188"></a>                        <span class="c1"># Too early before off to start logging prices</span>
<a id="__codelineno-8-189" name="__codelineno-8-189" href="#__codelineno-8-189"></a>                        <span class="k">continue</span>
<a id="__codelineno-8-190" name="__codelineno-8-190" href="#__codelineno-8-190"></a>
<a id="__codelineno-8-191" name="__codelineno-8-191" href="#__codelineno-8-191"></a>                    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-8-192" name="__codelineno-8-192" href="#__codelineno-8-192"></a>
<a id="__codelineno-8-193" name="__codelineno-8-193" href="#__codelineno-8-193"></a>                        <span class="c1"># Update data at different time steps depending on seconds to off</span>
<a id="__codelineno-8-194" name="__codelineno-8-194" href="#__codelineno-8-194"></a>                        <span class="n">wait</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">seconds_to_start</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="o">=</span> <span class="n">log2_Start</span><span class="p">,</span> <span class="n">log2_Step</span><span class="p">,</span> <span class="n">log1_Step</span><span class="p">)</span>
<a id="__codelineno-8-195" name="__codelineno-8-195" href="#__codelineno-8-195"></a>
<a id="__codelineno-8-196" name="__codelineno-8-196" href="#__codelineno-8-196"></a>                        <span class="c1"># New Market</span>
<a id="__codelineno-8-197" name="__codelineno-8-197" href="#__codelineno-8-197"></a>                        <span class="k">if</span> <span class="n">market_book</span><span class="o">.</span><span class="n">market_id</span> <span class="o">!=</span> <span class="n">marketID</span><span class="p">:</span>
<a id="__codelineno-8-198" name="__codelineno-8-198" href="#__codelineno-8-198"></a>                            <span class="n">marketID</span> <span class="o">=</span> <span class="n">market_book</span><span class="o">.</span><span class="n">market_id</span>
<a id="__codelineno-8-199" name="__codelineno-8-199" href="#__codelineno-8-199"></a>                            <span class="n">time</span> <span class="o">=</span>  <span class="n">market_book</span><span class="o">.</span><span class="n">publish_time</span>
<a id="__codelineno-8-200" name="__codelineno-8-200" href="#__codelineno-8-200"></a>                        <span class="c1"># (wait) seconds elapsed since last write</span>
<a id="__codelineno-8-201" name="__codelineno-8-201" href="#__codelineno-8-201"></a>                        <span class="k">elif</span> <span class="p">(</span><span class="n">market_book</span><span class="o">.</span><span class="n">publish_time</span> <span class="o">-</span> <span class="n">time</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="n">wait</span><span class="p">:</span>
<a id="__codelineno-8-202" name="__codelineno-8-202" href="#__codelineno-8-202"></a>                            <span class="n">time</span> <span class="o">=</span> <span class="n">market_book</span><span class="o">.</span><span class="n">publish_time</span>
<a id="__codelineno-8-203" name="__codelineno-8-203" href="#__codelineno-8-203"></a>                        <span class="c1"># fewer than (wait) seconds elapsed continue to next loop</span>
<a id="__codelineno-8-204" name="__codelineno-8-204" href="#__codelineno-8-204"></a>                        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-8-205" name="__codelineno-8-205" href="#__codelineno-8-205"></a>                            <span class="k">continue</span>
<a id="__codelineno-8-206" name="__codelineno-8-206" href="#__codelineno-8-206"></a>
<a id="__codelineno-8-207" name="__codelineno-8-207" href="#__codelineno-8-207"></a>                <span class="c1"># Execute Data Logging ++++++++++++++++++++++++++++++++++</span>
<a id="__codelineno-8-208" name="__codelineno-8-208" href="#__codelineno-8-208"></a>
<a id="__codelineno-8-209" name="__codelineno-8-209" href="#__codelineno-8-209"></a>                <span class="k">for</span> <span class="n">runner</span> <span class="ow">in</span> <span class="n">market_book</span><span class="o">.</span><span class="n">runners</span><span class="p">:</span>
<a id="__codelineno-8-210" name="__codelineno-8-210" href="#__codelineno-8-210"></a>
<a id="__codelineno-8-211" name="__codelineno-8-211" href="#__codelineno-8-211"></a>                    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-8-212" name="__codelineno-8-212" href="#__codelineno-8-212"></a>                        <span class="n">atb_ladder</span> <span class="o">=</span> <span class="n">pull_ladder</span><span class="p">(</span><span class="n">runner</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">available_to_back</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>
<a id="__codelineno-8-213" name="__codelineno-8-213" href="#__codelineno-8-213"></a>                        <span class="n">atl_ladder</span> <span class="o">=</span> <span class="n">pull_ladder</span><span class="p">(</span><span class="n">runner</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">available_to_lay</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>
<a id="__codelineno-8-214" name="__codelineno-8-214" href="#__codelineno-8-214"></a>                    <span class="k">except</span><span class="p">:</span>
<a id="__codelineno-8-215" name="__codelineno-8-215" href="#__codelineno-8-215"></a>                        <span class="n">atb_ladder</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-8-216" name="__codelineno-8-216" href="#__codelineno-8-216"></a>                        <span class="n">atl_ladder</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-8-217" name="__codelineno-8-217" href="#__codelineno-8-217"></a>
<a id="__codelineno-8-218" name="__codelineno-8-218" href="#__codelineno-8-218"></a>                    <span class="c1"># Calculate Current Traded Volume + Traded WAP</span>
<a id="__codelineno-8-219" name="__codelineno-8-219" href="#__codelineno-8-219"></a>                    <span class="n">limitTradedVol</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">rung</span><span class="o">.</span><span class="n">size</span> <span class="k">for</span> <span class="n">rung</span> <span class="ow">in</span> <span class="n">runner</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">traded_volume</span><span class="p">])</span>
<a id="__codelineno-8-220" name="__codelineno-8-220" href="#__codelineno-8-220"></a>                    <span class="k">if</span> <span class="n">limitTradedVol</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-8-221" name="__codelineno-8-221" href="#__codelineno-8-221"></a>                        <span class="n">limitWAP</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-8-222" name="__codelineno-8-222" href="#__codelineno-8-222"></a>                    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-8-223" name="__codelineno-8-223" href="#__codelineno-8-223"></a>                        <span class="n">limitWAP</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">rung</span><span class="o">.</span><span class="n">size</span> <span class="o">*</span> <span class="n">rung</span><span class="o">.</span><span class="n">price</span> <span class="k">for</span> <span class="n">rung</span> <span class="ow">in</span> <span class="n">runner</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">traded_volume</span><span class="p">])</span> <span class="o">/</span> <span class="n">limitTradedVol</span>
<a id="__codelineno-8-224" name="__codelineno-8-224" href="#__codelineno-8-224"></a>                        <span class="n">limitWAP</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">limitWAP</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-8-225" name="__codelineno-8-225" href="#__codelineno-8-225"></a>
<a id="__codelineno-8-226" name="__codelineno-8-226" href="#__codelineno-8-226"></a>                    <span class="c1">#Use this section to write rows that are required to join the metadata OR that will change in time</span>
<a id="__codelineno-8-227" name="__codelineno-8-227" href="#__codelineno-8-227"></a>                    <span class="n">o</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span>
<a id="__codelineno-8-228" name="__codelineno-8-228" href="#__codelineno-8-228"></a>                        <span class="p">(</span>
<a id="__codelineno-8-229" name="__codelineno-8-229" href="#__codelineno-8-229"></a>                            <span class="n">market_book</span><span class="o">.</span><span class="n">market_id</span><span class="p">,</span>
<a id="__codelineno-8-230" name="__codelineno-8-230" href="#__codelineno-8-230"></a>                            <span class="n">runner</span><span class="o">.</span><span class="n">selection_id</span><span class="p">,</span>
<a id="__codelineno-8-231" name="__codelineno-8-231" href="#__codelineno-8-231"></a>                            <span class="n">market_book</span><span class="o">.</span><span class="n">publish_time</span><span class="p">,</span>
<a id="__codelineno-8-232" name="__codelineno-8-232" href="#__codelineno-8-232"></a>                            <span class="n">market_book</span><span class="o">.</span><span class="n">inplay</span><span class="p">,</span>
<a id="__codelineno-8-233" name="__codelineno-8-233" href="#__codelineno-8-233"></a>                            <span class="n">limitTradedVol</span><span class="p">,</span>
<a id="__codelineno-8-234" name="__codelineno-8-234" href="#__codelineno-8-234"></a>                            <span class="n">limitWAP</span><span class="p">,</span>
<a id="__codelineno-8-235" name="__codelineno-8-235" href="#__codelineno-8-235"></a>                            <span class="n">runner</span><span class="o">.</span><span class="n">last_price_traded</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-8-236" name="__codelineno-8-236" href="#__codelineno-8-236"></a>                            <span class="nb">str</span><span class="p">(</span><span class="n">atb_ladder</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">),</span> 
<a id="__codelineno-8-237" name="__codelineno-8-237" href="#__codelineno-8-237"></a>                            <span class="nb">str</span><span class="p">(</span><span class="n">atl_ladder</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<a id="__codelineno-8-238" name="__codelineno-8-238" href="#__codelineno-8-238"></a>                        <span class="p">)</span>
<a id="__codelineno-8-239" name="__codelineno-8-239" href="#__codelineno-8-239"></a>                    <span class="p">)</span>
<a id="__codelineno-8-240" name="__codelineno-8-240" href="#__codelineno-8-240"></a>
<a id="__codelineno-8-241" name="__codelineno-8-241" href="#__codelineno-8-241"></a>
<a id="__codelineno-8-242" name="__codelineno-8-242" href="#__codelineno-8-242"></a><span class="k">def</span> <span class="nf">parse_prices</span><span class="p">(</span><span class="nb">dir</span><span class="p">,</span> <span class="n">out_file</span><span class="p">):</span>
<a id="__codelineno-8-243" name="__codelineno-8-243" href="#__codelineno-8-243"></a>
<a id="__codelineno-8-244" name="__codelineno-8-244" href="#__codelineno-8-244"></a>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">out_file</span><span class="p">,</span> <span class="s2">&quot;w+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">output</span><span class="p">:</span>
<a id="__codelineno-8-245" name="__codelineno-8-245" href="#__codelineno-8-245"></a>
<a id="__codelineno-8-246" name="__codelineno-8-246" href="#__codelineno-8-246"></a>        <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span>
<a id="__codelineno-8-247" name="__codelineno-8-247" href="#__codelineno-8-247"></a>            <span class="n">output</span><span class="p">,</span> 
<a id="__codelineno-8-248" name="__codelineno-8-248" href="#__codelineno-8-248"></a>            <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span>
<a id="__codelineno-8-249" name="__codelineno-8-249" href="#__codelineno-8-249"></a>            <span class="n">lineterminator</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\r\n</span><span class="s1">&#39;</span><span class="p">,</span>
<a id="__codelineno-8-250" name="__codelineno-8-250" href="#__codelineno-8-250"></a>            <span class="n">quoting</span><span class="o">=</span><span class="n">csv</span><span class="o">.</span><span class="n">QUOTE_ALL</span>
<a id="__codelineno-8-251" name="__codelineno-8-251" href="#__codelineno-8-251"></a>        <span class="p">)</span>
<a id="__codelineno-8-252" name="__codelineno-8-252" href="#__codelineno-8-252"></a>
<a id="__codelineno-8-253" name="__codelineno-8-253" href="#__codelineno-8-253"></a>        <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">((</span><span class="s2">&quot;market_id&quot;</span><span class="p">,</span><span class="s2">&quot;selection_id&quot;</span><span class="p">,</span><span class="s2">&quot;time&quot;</span><span class="p">,</span><span class="s2">&quot;inplay&quot;</span><span class="p">,</span><span class="s2">&quot;traded_volume&quot;</span><span class="p">,</span><span class="s2">&quot;wap&quot;</span><span class="p">,</span><span class="s2">&quot;ltp&quot;</span><span class="p">,</span><span class="s2">&quot;atb_ladder&quot;</span><span class="p">,</span><span class="s2">&quot;atl_ladder&quot;</span><span class="p">))</span>
<a id="__codelineno-8-254" name="__codelineno-8-254" href="#__codelineno-8-254"></a>
<a id="__codelineno-8-255" name="__codelineno-8-255" href="#__codelineno-8-255"></a>        <span class="k">for</span> <span class="n">file_obj</span> <span class="ow">in</span> <span class="n">load_markets</span><span class="p">(</span><span class="nb">dir</span><span class="p">):</span>
<a id="__codelineno-8-256" name="__codelineno-8-256" href="#__codelineno-8-256"></a>
<a id="__codelineno-8-257" name="__codelineno-8-257" href="#__codelineno-8-257"></a>            <span class="n">stream</span> <span class="o">=</span> <span class="n">trading</span><span class="o">.</span><span class="n">streaming</span><span class="o">.</span><span class="n">create_historical_generator_stream</span><span class="p">(</span>
<a id="__codelineno-8-258" name="__codelineno-8-258" href="#__codelineno-8-258"></a>                <span class="n">file_path</span><span class="o">=</span><span class="n">file_obj</span><span class="p">,</span>
<a id="__codelineno-8-259" name="__codelineno-8-259" href="#__codelineno-8-259"></a>                <span class="n">listener</span><span class="o">=</span><span class="n">listener</span><span class="p">,</span>
<a id="__codelineno-8-260" name="__codelineno-8-260" href="#__codelineno-8-260"></a>            <span class="p">)</span>
<a id="__codelineno-8-261" name="__codelineno-8-261" href="#__codelineno-8-261"></a>
<a id="__codelineno-8-262" name="__codelineno-8-262" href="#__codelineno-8-262"></a>            <span class="n">loop_prices</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">writer</span><span class="p">)</span>
<a id="__codelineno-8-263" name="__codelineno-8-263" href="#__codelineno-8-263"></a>
<a id="__codelineno-8-264" name="__codelineno-8-264" href="#__codelineno-8-264"></a><span class="c1">#loop over each TAR file</span>
<a id="__codelineno-8-265" name="__codelineno-8-265" href="#__codelineno-8-265"></a><span class="k">for</span> <span class="n">tar</span> <span class="ow">in</span> <span class="n">stream_files</span><span class="p">:</span>
<a id="__codelineno-8-266" name="__codelineno-8-266" href="#__codelineno-8-266"></a>    <span class="n">parse_prices</span><span class="p">([</span><span class="n">tar</span><span class="p">],</span> <span class="n">prices_path</span><span class="p">)</span>
<a id="__codelineno-8-267" name="__codelineno-8-267" href="#__codelineno-8-267"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;__ Parsing Market and Selection Data ___ &quot;</span><span class="p">)</span>
<a id="__codelineno-8-268" name="__codelineno-8-268" href="#__codelineno-8-268"></a>
<a id="__codelineno-8-269" name="__codelineno-8-269" href="#__codelineno-8-269"></a>    <span class="c1"># record prices to a file</span>
<a id="__codelineno-8-270" name="__codelineno-8-270" href="#__codelineno-8-270"></a>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">selection_meta</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">output</span><span class="p">:</span>
<a id="__codelineno-8-271" name="__codelineno-8-271" href="#__codelineno-8-271"></a>        <span class="c1"># defining column headers</span>
<a id="__codelineno-8-272" name="__codelineno-8-272" href="#__codelineno-8-272"></a>        <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;market_id,market_time,market_type,event_name,market_name,selection_id,x,selection_name,y,result</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-8-273" name="__codelineno-8-273" href="#__codelineno-8-273"></a>        <span class="c1">#loop over each market in the TAR file</span>
<a id="__codelineno-8-274" name="__codelineno-8-274" href="#__codelineno-8-274"></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bflw</span><span class="o">.</span><span class="n">Files</span><span class="p">([</span><span class="n">tar</span><span class="p">])):</span>
<a id="__codelineno-8-275" name="__codelineno-8-275" href="#__codelineno-8-275"></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Market </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-8-276" name="__codelineno-8-276" href="#__codelineno-8-276"></a>
<a id="__codelineno-8-277" name="__codelineno-8-277" href="#__codelineno-8-277"></a>            <span class="k">def</span> <span class="nf">get_pre_post_final</span><span class="p">():</span>
<a id="__codelineno-8-278" name="__codelineno-8-278" href="#__codelineno-8-278"></a>                <span class="n">eval_market</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-8-279" name="__codelineno-8-279" href="#__codelineno-8-279"></a>                <span class="n">prev_market</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-8-280" name="__codelineno-8-280" href="#__codelineno-8-280"></a>                <span class="n">preplay_market</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-8-281" name="__codelineno-8-281" href="#__codelineno-8-281"></a>                <span class="n">postplay_market</span> <span class="o">=</span> <span class="kc">None</span>       
<a id="__codelineno-8-282" name="__codelineno-8-282" href="#__codelineno-8-282"></a>
<a id="__codelineno-8-283" name="__codelineno-8-283" href="#__codelineno-8-283"></a>                <span class="k">for</span> <span class="n">market_books</span> <span class="ow">in</span> <span class="n">g</span><span class="p">:</span>
<a id="__codelineno-8-284" name="__codelineno-8-284" href="#__codelineno-8-284"></a>                    <span class="k">for</span> <span class="n">market_book</span> <span class="ow">in</span> <span class="n">market_books</span><span class="p">:</span>
<a id="__codelineno-8-285" name="__codelineno-8-285" href="#__codelineno-8-285"></a>                        <span class="c1"># if market doesn&#39;t meet filter return out</span>
<a id="__codelineno-8-286" name="__codelineno-8-286" href="#__codelineno-8-286"></a>                        <span class="k">if</span> <span class="n">eval_market</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">((</span><span class="n">eval_market</span> <span class="o">:=</span> <span class="n">filter_market</span><span class="p">(</span><span class="n">market_book</span><span class="p">))</span> <span class="o">==</span> <span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-8-287" name="__codelineno-8-287" href="#__codelineno-8-287"></a>                            <span class="k">return</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-8-288" name="__codelineno-8-288" href="#__codelineno-8-288"></a>
<a id="__codelineno-8-289" name="__codelineno-8-289" href="#__codelineno-8-289"></a>                        <span class="c1"># final market view before market goes in play</span>
<a id="__codelineno-8-290" name="__codelineno-8-290" href="#__codelineno-8-290"></a>                        <span class="k">if</span> <span class="n">prev_market</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">prev_market</span><span class="o">.</span><span class="n">inplay</span> <span class="o">!=</span> <span class="n">market_book</span><span class="o">.</span><span class="n">inplay</span><span class="p">:</span>
<a id="__codelineno-8-291" name="__codelineno-8-291" href="#__codelineno-8-291"></a>                            <span class="n">preplay_market</span> <span class="o">=</span> <span class="n">prev_market</span>
<a id="__codelineno-8-292" name="__codelineno-8-292" href="#__codelineno-8-292"></a>
<a id="__codelineno-8-293" name="__codelineno-8-293" href="#__codelineno-8-293"></a>                        <span class="c1"># final market view at the conclusion of the market</span>
<a id="__codelineno-8-294" name="__codelineno-8-294" href="#__codelineno-8-294"></a>                        <span class="k">if</span> <span class="n">prev_market</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">prev_market</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;OPEN&quot;</span> <span class="ow">and</span> <span class="n">market_book</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="n">prev_market</span><span class="o">.</span><span class="n">status</span><span class="p">:</span>
<a id="__codelineno-8-295" name="__codelineno-8-295" href="#__codelineno-8-295"></a>                            <span class="n">postplay_market</span> <span class="o">=</span> <span class="n">market_book</span>
<a id="__codelineno-8-296" name="__codelineno-8-296" href="#__codelineno-8-296"></a>
<a id="__codelineno-8-297" name="__codelineno-8-297" href="#__codelineno-8-297"></a>                        <span class="c1"># update reference to previous market</span>
<a id="__codelineno-8-298" name="__codelineno-8-298" href="#__codelineno-8-298"></a>                        <span class="n">prev_market</span> <span class="o">=</span> <span class="n">market_book</span>
<a id="__codelineno-8-299" name="__codelineno-8-299" href="#__codelineno-8-299"></a>
<a id="__codelineno-8-300" name="__codelineno-8-300" href="#__codelineno-8-300"></a>                <span class="k">return</span> <span class="p">(</span><span class="n">preplay_market</span><span class="p">,</span> <span class="n">postplay_market</span><span class="p">,</span> <span class="n">prev_market</span><span class="p">)</span> <span class="c1"># prev is now final</span>
<a id="__codelineno-8-301" name="__codelineno-8-301" href="#__codelineno-8-301"></a>
<a id="__codelineno-8-302" name="__codelineno-8-302" href="#__codelineno-8-302"></a>            <span class="p">(</span><span class="n">preplay_market</span><span class="p">,</span> <span class="n">postplay_market</span><span class="p">,</span> <span class="n">final_market</span><span class="p">)</span> <span class="o">=</span> <span class="n">get_pre_post_final</span><span class="p">()</span>
<a id="__codelineno-8-303" name="__codelineno-8-303" href="#__codelineno-8-303"></a>
<a id="__codelineno-8-304" name="__codelineno-8-304" href="#__codelineno-8-304"></a>            <span class="c1"># no price data for market</span>
<a id="__codelineno-8-305" name="__codelineno-8-305" href="#__codelineno-8-305"></a>            <span class="k">if</span> <span class="n">postplay_market</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-8-306" name="__codelineno-8-306" href="#__codelineno-8-306"></a>                <span class="k">continue</span><span class="p">;</span> 
<a id="__codelineno-8-307" name="__codelineno-8-307" href="#__codelineno-8-307"></a>
<a id="__codelineno-8-308" name="__codelineno-8-308" href="#__codelineno-8-308"></a>            <span class="n">preplay_traded</span> <span class="o">=</span> <span class="p">[</span> <span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">last_price_traded</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">traded_volume</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">preplay_market</span><span class="o">.</span><span class="n">runners</span> <span class="p">]</span> <span class="k">if</span> <span class="n">preplay_market</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
<a id="__codelineno-8-309" name="__codelineno-8-309" href="#__codelineno-8-309"></a>
<a id="__codelineno-8-310" name="__codelineno-8-310" href="#__codelineno-8-310"></a>            <span class="n">postplay_traded</span> <span class="o">=</span> <span class="p">[</span> <span class="p">(</span>
<a id="__codelineno-8-311" name="__codelineno-8-311" href="#__codelineno-8-311"></a>                <span class="n">r</span><span class="o">.</span><span class="n">last_price_traded</span><span class="p">,</span>
<a id="__codelineno-8-312" name="__codelineno-8-312" href="#__codelineno-8-312"></a>                <span class="n">r</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">traded_volume</span><span class="p">,</span>
<a id="__codelineno-8-313" name="__codelineno-8-313" href="#__codelineno-8-313"></a>                <span class="c1"># calculating SP traded vol as smaller of back_stake_taken or (lay_liability_taken / (BSP - 1))        </span>
<a id="__codelineno-8-314" name="__codelineno-8-314" href="#__codelineno-8-314"></a>                <span class="n">min_gr0</span><span class="p">(</span>
<a id="__codelineno-8-315" name="__codelineno-8-315" href="#__codelineno-8-315"></a>                    <span class="nb">next</span><span class="p">((</span><span class="n">pv</span><span class="o">.</span><span class="n">size</span> <span class="k">for</span> <span class="n">pv</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">back_stake_taken</span> <span class="k">if</span> <span class="n">pv</span><span class="o">.</span><span class="n">size</span> <span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">0</span><span class="p">),</span>
<a id="__codelineno-8-316" name="__codelineno-8-316" href="#__codelineno-8-316"></a>                    <span class="nb">next</span><span class="p">((</span><span class="n">pv</span><span class="o">.</span><span class="n">size</span> <span class="k">for</span> <span class="n">pv</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">lay_liability_taken</span> <span class="k">if</span> <span class="n">pv</span><span class="o">.</span><span class="n">size</span> <span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>  <span class="o">/</span> <span class="p">((</span><span class="n">r</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">actual_sp</span> <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">actual_sp</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">actual_sp</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-8-317" name="__codelineno-8-317" href="#__codelineno-8-317"></a>                <span class="p">)</span> <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">actual_sp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-8-318" name="__codelineno-8-318" href="#__codelineno-8-318"></a>            <span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">postplay_market</span><span class="o">.</span><span class="n">runners</span> <span class="p">]</span>
<a id="__codelineno-8-319" name="__codelineno-8-319" href="#__codelineno-8-319"></a>
<a id="__codelineno-8-320" name="__codelineno-8-320" href="#__codelineno-8-320"></a>            <span class="c1"># generic selection data</span>
<a id="__codelineno-8-321" name="__codelineno-8-321" href="#__codelineno-8-321"></a>            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">final_market</span><span class="o">.</span><span class="n">runners</span><span class="p">:</span>
<a id="__codelineno-8-322" name="__codelineno-8-322" href="#__codelineno-8-322"></a>                <span class="n">selection_id</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">selection_id</span><span class="p">,</span>
<a id="__codelineno-8-323" name="__codelineno-8-323" href="#__codelineno-8-323"></a>                <span class="n">selection_name</span><span class="o">=</span><span class="nb">next</span><span class="p">((</span><span class="n">rd</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">rd</span> <span class="ow">in</span> <span class="n">final_market</span><span class="o">.</span><span class="n">market_definition</span><span class="o">.</span><span class="n">runners</span> <span class="k">if</span> <span class="n">rd</span><span class="o">.</span><span class="n">selection_id</span> <span class="o">==</span> <span class="n">r</span><span class="o">.</span><span class="n">selection_id</span><span class="p">),</span> <span class="kc">None</span><span class="p">),</span>
<a id="__codelineno-8-324" name="__codelineno-8-324" href="#__codelineno-8-324"></a>                <span class="n">selection_status</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">status</span>
<a id="__codelineno-8-325" name="__codelineno-8-325" href="#__codelineno-8-325"></a>
<a id="__codelineno-8-326" name="__codelineno-8-326" href="#__codelineno-8-326"></a>            <span class="c1"># printing to csv for each selection</span>
<a id="__codelineno-8-327" name="__codelineno-8-327" href="#__codelineno-8-327"></a>                <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
<a id="__codelineno-8-328" name="__codelineno-8-328" href="#__codelineno-8-328"></a>                    <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
<a id="__codelineno-8-329" name="__codelineno-8-329" href="#__codelineno-8-329"></a>                        <span class="n">postplay_market</span><span class="o">.</span><span class="n">market_id</span><span class="p">,</span>
<a id="__codelineno-8-330" name="__codelineno-8-330" href="#__codelineno-8-330"></a>                        <span class="n">postplay_market</span><span class="o">.</span><span class="n">market_definition</span><span class="o">.</span><span class="n">market_time</span><span class="p">,</span>
<a id="__codelineno-8-331" name="__codelineno-8-331" href="#__codelineno-8-331"></a>                        <span class="n">postplay_market</span><span class="o">.</span><span class="n">market_definition</span><span class="o">.</span><span class="n">market_type</span><span class="p">,</span>
<a id="__codelineno-8-332" name="__codelineno-8-332" href="#__codelineno-8-332"></a>                        <span class="n">postplay_market</span><span class="o">.</span><span class="n">market_definition</span><span class="o">.</span><span class="n">event_name</span><span class="p">,</span>
<a id="__codelineno-8-333" name="__codelineno-8-333" href="#__codelineno-8-333"></a>                        <span class="n">postplay_market</span><span class="o">.</span><span class="n">market_definition</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-8-334" name="__codelineno-8-334" href="#__codelineno-8-334"></a>                        <span class="n">selection_id</span><span class="p">,</span>
<a id="__codelineno-8-335" name="__codelineno-8-335" href="#__codelineno-8-335"></a>                        <span class="n">selection_name</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span>
<a id="__codelineno-8-336" name="__codelineno-8-336" href="#__codelineno-8-336"></a>                        <span class="n">selection_status</span>
<a id="__codelineno-8-337" name="__codelineno-8-337" href="#__codelineno-8-337"></a>                    <span class="p">)</span>
<a id="__codelineno-8-338" name="__codelineno-8-338" href="#__codelineno-8-338"></a>                <span class="p">)</span>
<a id="__codelineno-8-339" name="__codelineno-8-339" href="#__codelineno-8-339"></a>
<a id="__codelineno-8-340" name="__codelineno-8-340" href="#__codelineno-8-340"></a>    <span class="c1">#loading selection file, parsing dates and cleaning the table</span>
<a id="__codelineno-8-341" name="__codelineno-8-341" href="#__codelineno-8-341"></a>    <span class="c1"># loading selection file, parsing dates and cleaning the table</span>
<a id="__codelineno-8-342" name="__codelineno-8-342" href="#__codelineno-8-342"></a>    <span class="n">selection</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
<a id="__codelineno-8-343" name="__codelineno-8-343" href="#__codelineno-8-343"></a>        <span class="n">selection_meta</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;market_id&#39;</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="s1">&#39;selection_id&#39;</span><span class="p">:</span> <span class="nb">object</span><span class="p">},</span> <span class="n">parse_dates</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;market_time&#39;</span><span class="p">]</span>
<a id="__codelineno-8-344" name="__codelineno-8-344" href="#__codelineno-8-344"></a>    <span class="p">)</span>
<a id="__codelineno-8-345" name="__codelineno-8-345" href="#__codelineno-8-345"></a>    <span class="n">selection</span><span class="o">.</span><span class="n">set_axis</span><span class="p">(</span>
<a id="__codelineno-8-346" name="__codelineno-8-346" href="#__codelineno-8-346"></a>        <span class="p">[</span>
<a id="__codelineno-8-347" name="__codelineno-8-347" href="#__codelineno-8-347"></a>            <span class="s1">&#39;market_id&#39;</span><span class="p">,</span>
<a id="__codelineno-8-348" name="__codelineno-8-348" href="#__codelineno-8-348"></a>            <span class="s1">&#39;market_time&#39;</span><span class="p">,</span>
<a id="__codelineno-8-349" name="__codelineno-8-349" href="#__codelineno-8-349"></a>            <span class="s1">&#39;market_type&#39;</span><span class="p">,</span>
<a id="__codelineno-8-350" name="__codelineno-8-350" href="#__codelineno-8-350"></a>            <span class="s1">&#39;event_name&#39;</span><span class="p">,</span>
<a id="__codelineno-8-351" name="__codelineno-8-351" href="#__codelineno-8-351"></a>            <span class="s1">&#39;market_name&#39;</span><span class="p">,</span>
<a id="__codelineno-8-352" name="__codelineno-8-352" href="#__codelineno-8-352"></a>            <span class="s1">&#39;selection_id&#39;</span><span class="p">,</span>
<a id="__codelineno-8-353" name="__codelineno-8-353" href="#__codelineno-8-353"></a>            <span class="s1">&#39;x&#39;</span><span class="p">,</span>
<a id="__codelineno-8-354" name="__codelineno-8-354" href="#__codelineno-8-354"></a>            <span class="s1">&#39;selection_name&#39;</span><span class="p">,</span>
<a id="__codelineno-8-355" name="__codelineno-8-355" href="#__codelineno-8-355"></a>            <span class="s1">&#39;y&#39;</span><span class="p">,</span>
<a id="__codelineno-8-356" name="__codelineno-8-356" href="#__codelineno-8-356"></a>            <span class="s1">&#39;result&#39;</span>
<a id="__codelineno-8-357" name="__codelineno-8-357" href="#__codelineno-8-357"></a>        <span class="p">],</span>
<a id="__codelineno-8-358" name="__codelineno-8-358" href="#__codelineno-8-358"></a>        <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
<a id="__codelineno-8-359" name="__codelineno-8-359" href="#__codelineno-8-359"></a>    <span class="p">)</span>
<a id="__codelineno-8-360" name="__codelineno-8-360" href="#__codelineno-8-360"></a>
<a id="__codelineno-8-361" name="__codelineno-8-361" href="#__codelineno-8-361"></a>    <span class="n">selection</span> <span class="o">=</span> <span class="n">selection</span><span class="p">[[</span><span class="s1">&#39;market_id&#39;</span><span class="p">,</span><span class="s1">&#39;market_time&#39;</span><span class="p">,</span><span class="s1">&#39;market_type&#39;</span><span class="p">,</span><span class="s1">&#39;event_name&#39;</span><span class="p">,</span><span class="s1">&#39;market_name&#39;</span><span class="p">,</span><span class="s1">&#39;selection_id&#39;</span><span class="p">,</span><span class="s1">&#39;selection_name&#39;</span><span class="p">,</span><span class="s1">&#39;result&#39;</span><span class="p">]]</span>
<a id="__codelineno-8-362" name="__codelineno-8-362" href="#__codelineno-8-362"></a>    <span class="n">selection</span><span class="p">[</span><span class="s1">&#39;selection_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">selection</span><span class="p">[</span><span class="s1">&#39;selection_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;\(&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-8-363" name="__codelineno-8-363" href="#__codelineno-8-363"></a>    <span class="n">selection</span><span class="p">[</span><span class="s1">&#39;selection_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">selection</span><span class="p">[</span><span class="s1">&#39;selection_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;\(&#39;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-8-364" name="__codelineno-8-364" href="#__codelineno-8-364"></a>    <span class="n">selection</span><span class="p">[</span><span class="s1">&#39;selection_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">selection</span><span class="p">[</span><span class="s1">&#39;selection_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-8-365" name="__codelineno-8-365" href="#__codelineno-8-365"></a>
<a id="__codelineno-8-366" name="__codelineno-8-366" href="#__codelineno-8-366"></a>    <span class="c1"># loading price file and parsing dates</span>
<a id="__codelineno-8-367" name="__codelineno-8-367" href="#__codelineno-8-367"></a>    <span class="n">prices</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
<a id="__codelineno-8-368" name="__codelineno-8-368" href="#__codelineno-8-368"></a>        <span class="n">prices_path</span><span class="p">,</span>
<a id="__codelineno-8-369" name="__codelineno-8-369" href="#__codelineno-8-369"></a>        <span class="n">quoting</span><span class="o">=</span><span class="n">csv</span><span class="o">.</span><span class="n">QUOTE_ALL</span><span class="p">,</span>
<a id="__codelineno-8-370" name="__codelineno-8-370" href="#__codelineno-8-370"></a>        <span class="n">dtype</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;market_id&#39;</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span><span class="p">,</span> <span class="s1">&#39;selection_id&#39;</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span><span class="p">,</span> <span class="s1">&#39;atb_ladder&#39;</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span><span class="p">,</span> <span class="s1">&#39;atl_ladder&#39;</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span><span class="p">},</span>
<a id="__codelineno-8-371" name="__codelineno-8-371" href="#__codelineno-8-371"></a>        <span class="n">parse_dates</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span>
<a id="__codelineno-8-372" name="__codelineno-8-372" href="#__codelineno-8-372"></a>    <span class="p">)</span>
<a id="__codelineno-8-373" name="__codelineno-8-373" href="#__codelineno-8-373"></a>
<a id="__codelineno-8-374" name="__codelineno-8-374" href="#__codelineno-8-374"></a>    <span class="c1"># creating the ladder as a dictionary</span>
<a id="__codelineno-8-375" name="__codelineno-8-375" href="#__codelineno-8-375"></a>    <span class="n">prices</span><span class="p">[</span><span class="s1">&#39;atb_ladder&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">prices</span><span class="p">[</span><span class="s1">&#39;atb_ladder&#39;</span><span class="p">]]</span>
<a id="__codelineno-8-376" name="__codelineno-8-376" href="#__codelineno-8-376"></a>    <span class="n">prices</span><span class="p">[</span><span class="s1">&#39;atl_ladder&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">prices</span><span class="p">[</span><span class="s1">&#39;atl_ladder&#39;</span><span class="p">]]</span>
<a id="__codelineno-8-377" name="__codelineno-8-377" href="#__codelineno-8-377"></a>
<a id="__codelineno-8-378" name="__codelineno-8-378" href="#__codelineno-8-378"></a>    <span class="c1"># merging the price and selection files</span>
<a id="__codelineno-8-379" name="__codelineno-8-379" href="#__codelineno-8-379"></a>    <span class="n">df</span> <span class="o">=</span> <span class="n">selection</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">prices</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;market_id&#39;</span><span class="p">,</span> <span class="s1">&#39;selection_id&#39;</span><span class="p">])</span>
<a id="__codelineno-8-380" name="__codelineno-8-380" href="#__codelineno-8-380"></a>
<a id="__codelineno-8-381" name="__codelineno-8-381" href="#__codelineno-8-381"></a>    <span class="c1"># assigning best prices available and calculating time relative to market start time</span>
<a id="__codelineno-8-382" name="__codelineno-8-382" href="#__codelineno-8-382"></a>    <span class="n">df</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-8-383" name="__codelineno-8-383" href="#__codelineno-8-383"></a>        <span class="n">df</span>
<a id="__codelineno-8-384" name="__codelineno-8-384" href="#__codelineno-8-384"></a>        <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">back_best</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;atb_ladder&#39;</span><span class="p">]])</span>
<a id="__codelineno-8-385" name="__codelineno-8-385" href="#__codelineno-8-385"></a>        <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">lay_best</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;atl_ladder&#39;</span><span class="p">]])</span>
<a id="__codelineno-8-386" name="__codelineno-8-386" href="#__codelineno-8-386"></a>        <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
<a id="__codelineno-8-387" name="__codelineno-8-387" href="#__codelineno-8-387"></a>            <span class="n">seconds_before_scheduled_off</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">round</span><span class="p">((</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;market_time&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">())</span>
<a id="__codelineno-8-388" name="__codelineno-8-388" href="#__codelineno-8-388"></a>        <span class="p">)</span>
<a id="__codelineno-8-389" name="__codelineno-8-389" href="#__codelineno-8-389"></a>        <span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;seconds_before_scheduled_off &amp;lt; @log1_start&#39;</span><span class="p">)</span>
<a id="__codelineno-8-390" name="__codelineno-8-390" href="#__codelineno-8-390"></a>    <span class="p">)</span>
<a id="__codelineno-8-391" name="__codelineno-8-391" href="#__codelineno-8-391"></a>
<a id="__codelineno-8-392" name="__codelineno-8-392" href="#__codelineno-8-392"></a>    <span class="c1"># Writing each processed market to its own csv file</span>
<a id="__codelineno-8-393" name="__codelineno-8-393" href="#__codelineno-8-393"></a>    <span class="n">market_ids</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;market_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<a id="__codelineno-8-394" name="__codelineno-8-394" href="#__codelineno-8-394"></a>    <span class="k">for</span> <span class="n">market</span> <span class="ow">in</span> <span class="n">market_ids</span><span class="p">:</span>
<a id="__codelineno-8-395" name="__codelineno-8-395" href="#__codelineno-8-395"></a>        <span class="c1"># Create a dataframe and a naming convention for this market</span>
<a id="__codelineno-8-396" name="__codelineno-8-396" href="#__codelineno-8-396"></a>        <span class="n">pricing_data</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;market_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">market</span><span class="p">]</span>
<a id="__codelineno-8-397" name="__codelineno-8-397" href="#__codelineno-8-397"></a>        <span class="n">fixture</span> <span class="o">=</span> <span class="n">pricing_data</span><span class="p">[</span><span class="s1">&#39;event_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;/&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-8-398" name="__codelineno-8-398" href="#__codelineno-8-398"></a>        <span class="n">market_name</span> <span class="o">=</span> <span class="n">pricing_data</span><span class="p">[</span><span class="s1">&#39;market_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-8-399" name="__codelineno-8-399" href="#__codelineno-8-399"></a>        <span class="n">market_time</span> <span class="o">=</span> <span class="n">pricing_data</span><span class="p">[</span><span class="s1">&#39;market_time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-8-400" name="__codelineno-8-400" href="#__codelineno-8-400"></a>        <span class="n">off</span> <span class="o">=</span> <span class="n">market_time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-8-401" name="__codelineno-8-401" href="#__codelineno-8-401"></a>        <span class="c1"># Convert GBP to AUD</span>
<a id="__codelineno-8-402" name="__codelineno-8-402" href="#__codelineno-8-402"></a>        <span class="n">event_date</span> <span class="o">=</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">pricing_data</span><span class="p">[</span><span class="s1">&#39;market_time&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">)</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-8-403" name="__codelineno-8-403" href="#__codelineno-8-403"></a>        <span class="n">conversion_rate</span> <span class="o">=</span> <span class="n">CurrencyConverter</span><span class="p">(</span><span class="n">fallback_on_missing_rate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;GBP&#39;</span><span class="p">,</span> <span class="s1">&#39;AUD&#39;</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="n">event_date</span><span class="p">)</span>
<a id="__codelineno-8-404" name="__codelineno-8-404" href="#__codelineno-8-404"></a>        <span class="n">pricing_data</span><span class="p">[</span><span class="s1">&#39;traded_volume&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pricing_data</span><span class="p">[</span><span class="s1">&#39;traded_volume&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">conversion_rate</span>
<a id="__codelineno-8-405" name="__codelineno-8-405" href="#__codelineno-8-405"></a>        <span class="n">pricing_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pricing_data</span><span class="p">[</span><span class="s1">&#39;traded_volume&#39;</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;traded_volume&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-8-406" name="__codelineno-8-406" href="#__codelineno-8-406"></a>        <span class="n">pricing_data</span><span class="p">[</span><span class="s1">&#39;traded_volume&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pricing_data</span><span class="p">[</span><span class="s1">&#39;traded_volume&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">decimals</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-8-407" name="__codelineno-8-407" href="#__codelineno-8-407"></a>        <span class="n">pricing_data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">file_directory</span> <span class="o">+</span> <span class="n">off</span> <span class="o">+</span> <span class="s1">&#39; - &#39;</span> <span class="o">+</span> <span class="n">fixture</span> <span class="o">+</span> <span class="s1">&#39; - &#39;</span> <span class="o">+</span> <span class="n">market_name</span> <span class="o">+</span> <span class="s1">&#39;.csv&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-8-408" name="__codelineno-8-408" href="#__codelineno-8-408"></a>
<a id="__codelineno-8-409" name="__codelineno-8-409" href="#__codelineno-8-409"></a><span class="c1">#removing intermediate working documents to clean up</span>
<a id="__codelineno-8-410" name="__codelineno-8-410" href="#__codelineno-8-410"></a><span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">selection_meta</span><span class="p">)</span>
<a id="__codelineno-8-411" name="__codelineno-8-411" href="#__codelineno-8-411"></a><span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">prices_path</span><span class="p">)</span>
</code></pre></div>

</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<hr />
<h3 id="disclaimer">Disclaimer</h3>
<p>Note that whilst models and automated strategies are fun and rewarding to create, we can't promise that your model or betting strategy will be profitable, and we make no representations in relation to the code shared or information on this page. If you're using this code or implementing your own strategies, you do so entirely at your own risk and you are responsible for any winnings/losses incurred. Under no circumstances will Betfair be liable for any loss or damage you suffer.</p>
</div>
</div>
</div>









  




                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
    
      <nav class="md-footer__inner md-grid" aria-label="footer.title">
        
          
          <a href="../How_to_Automate_5/" class="md-footer__link md-footer__link--prev" aria-label="Previous: How to Automate 5" rel="prev">
            <div class="md-footer__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
            </div>
            <div class="md-footer__title">
              <div class="md-ellipsis">
                <span class="md-footer__direction">
                  Previous
                </span>
                How to Automate 5
              </div>
            </div>
          </a>
        
        
          
          <a href="../jsonToCsvRevisited/" class="md-footer__link md-footer__link--next" aria-label="Next: JSON to CSV | Revisited" rel="next">
            <div class="md-footer__title">
              <div class="md-ellipsis">
                <span class="md-footer__direction">
                  Next
                </span>
                JSON to CSV | Revisited
              </div>
            </div>
            <div class="md-footer__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
            </div>
          </a>
        
      </nav>
    
    <div class="md-footer-meta md-typeset">
      <div class="md-footer-meta__inner md-grid">
        <div class="md-copyright">
  
  
</div>
        
          <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://twitter.com/Betfair_Aus" target="_blank" rel="noopener" title="twitter.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://linkedin.com/company/betfair-australia" target="_blank" rel="noopener" title="linkedin.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://facebook.com/betfairaustralia" target="_blank" rel="noopener" title="facebook.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M512 256C512 114.6 397.4 0 256 0S0 114.6 0 256c0 120 82.7 220.8 194.2 248.5V334.2h-52.8V256h52.8v-33.7c0-87.1 39.4-127.5 125-127.5 16.2 0 44.2 3.2 55.7 6.4V172c-6-.6-16.5-1-29.6-1-42 0-58.2 15.9-58.2 57.2V256h83.6l-14.4 78.2H287v175.9C413.8 494.8 512 386.9 512 256z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://youtube.com/user/betfairaus" target="_blank" rel="noopener" title="youtube.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M549.655 124.083c-6.281-23.65-24.787-42.276-48.284-48.597C458.781 64 288 64 288 64S117.22 64 74.629 75.486c-23.497 6.322-42.003 24.947-48.284 48.597-11.412 42.867-11.412 132.305-11.412 132.305s0 89.438 11.412 132.305c6.281 23.65 24.787 41.5 48.284 47.821C117.22 448 288 448 288 448s170.78 0 213.371-11.486c23.497-6.321 42.003-24.171 48.284-47.821 11.412-42.867 11.412-132.305 11.412-132.305s0-89.438-11.412-132.305zm-317.51 213.508V175.185l142.739 81.205-142.739 81.201z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://github.com/betfair-datascientists" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
</div>
        
      </div>

      <div class="bf-footer">
          <div class="bf-footer-inner">
              <p class="bf-light">Betfair Pty Limited is licensed and regulated by the Northern Territory Government of Australia.</p>
              <p class="bf-dark">Betfair Pty Limited's gambling operations are governed by its <a class='inner-link' href="https://www.betfair.com.au/info/responsible-gambling/">Responsible Gambling Code of Conduct</a> and for South
              Australian residents by the <a class='inner-link' href="https://www.betfair.com.au/info/pdf/SA-GCoP.pdf">South Australian Responsible Gambling Code of Practice.</a></p>
              <p class="bf-dark">BetStop is the Australian National Self-Exclusion Register. For more information, please visit <a class="inner-link" href="https://betstop.gov.au">https://betstop.gov.au</a><br /> <div class="full-screen"> <p style="font-family: Arial, sans-serif; font-size: 1.2rem; font-weight: bold;text-align: center;">Chances are you&#39re about to lose</p> <p style="font-family: Arial, sans-serif; font-size: 0.8rem; font-weight: bold;text-align: center;">For free and confidential support call 1800 858 858 or visit <a href="http://www.gamblinghelponline.org.au" style="color: black; text-decoration: underline;">www.gamblinghelponline.org.au</a></p> </div> </p>
              <ul class="bf-links">
                <li><a href="https://www.betfair.com.au/hub/help/account-help/responsible-gambling/">Responsible Gambling</a><span>|</span></li>
                <li><a href="http://www.betfair.com/AUS_NZL/aboutUs/Terms.and.Conditions/">Terms & Conditions</a><span>|</span></li>
                <li><a href="https://www.betfair.com.au/info/privacy-policy/">Privacy Policy</a><span>|</span></li>
                <li><a href="http://www.betfair.com/en/aboutUs/Rules.and.Regulations/">Rules & Regulations</a><span>|</span></li>
                <li><a href="https://www.betfair.com/AUS_NZL/aboutUs/Dispute.Resolution">Dispute Resolution</a></li>
              </ul>
          </div>
      </div>
    </div>

    <script src="https://js.adsrvr.org/up_loader.1.1.0.js" type="text/javascript"></script>
    <script type="text/javascript">
        ttd_dom_ready( function() {
            if (typeof TTDUniversalPixelApi === 'function') {
                var universalPixelApi = new TTDUniversalPixelApi();
                universalPixelApi.init("y12d1ir", ["8ml4f17"], "https://insight.adsrvr.org/track/up");
            }
        });
    </script>

</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["toc.integrate", "navigation.instant", "navigation.tabs", "navigation.top", "navigation.expand", "navigation.sections", "search.suggest", "search.highlight", "search.share"], "search": "../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.e1c3ead8.min.js"></script>
      
        <script src="../../js/scripts.js"></script>
      
    
  </body>
</html>