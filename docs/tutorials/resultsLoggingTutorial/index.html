
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Documentation, guides and articles on creating, developing and implementing automated betting strategies, using data analysis to inform betting models and how to interact with the Betfair API.">
      
      
        <meta name="author" content="Betfair Data Scientists">
      
      
        <link rel="canonical" href="https://betfair-datascientists.github.io/tutorials/resultsLoggingTutorial/">
      
      
        <link rel="prev" href="../How_to_Automate_5/">
      
      
        <link rel="next" href="../flumineSimulations/">
      
      
      <link rel="icon" href="../../img/BetfairFavicon.ico">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.5">
    
    
      
        <title>Flumine Results to CSV Files - The Automation Hub</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.8608ea7d.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/betfair.css">
    
      <link rel="stylesheet" href="../../css/buttons_and_animations.css">
    
      <link rel="stylesheet" href="../../css/fonts.css">
    
      <link rel="stylesheet" href="../../css/ansi-colours.css">
    
      <link rel="stylesheet" href="../../css/jupyter-cells.css">
    
      <link rel="stylesheet" href="../../css/pandas-dataframe.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","UA-125973915-1"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","UA-125973915-1",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=UA-125973915-1",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="betfair" data-md-color-primary="amber" data-md-color-accent="orange">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#coding-principles" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      
  
  <header class="md-header" data-md-component="header">
    <nav class="md-header__inner md-grid" aria-label="header.title">
      <a href="../.." title="The Automation Hub" class="md-header__button md-logo" aria-label="The Automation Hub" data-md-component="logo">
        
  <img src="../../img/logo.svg" alt="logo">

      </a>
      <label class="md-header__button md-icon" for="__drawer">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
      </label>
      <div class="md-header__title" data-md-component="header-title">
        <div class="md-header__ellipsis">
          <div class="md-header__topic">
            <span class="md-ellipsis">
              The Automation Hub
            </span>
          </div>
          <div class="md-header__topic" data-md-component="header-topic">
            <span class="md-ellipsis">
              
                Flumine Results to CSV Files
              
            </span>
          </div>
        </div>
      </div>

      
        <form class="md-header__option" data-md-component="palette">
          
            
            
            <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="betfair" data-md-color-primary="amber" data-md-color-accent="orange"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
            
              <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg>
              </label>
            
          
            
            
            <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="amber" data-md-color-accent="orange"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
            
              <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"/></svg>
              </label>
            
          
        </form>
      
      

      
     
      <div class="bf-nav">
        <a class="bf-hidable" href="https://www.betfair.com.au/exchange/plus/"><svg class="exchangeLogo" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:cc="http://creativecommons.org/ns#"
          xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 38.775 4.59" width="24" height="17">
          <path class="st1" d="m 160.3,-136.95 v 26" />
          <g transform="translate(18.8,-137.15)">
            <path d="m 2.2901089,126.53441 v 5.20093 H -3.3107216 L 7.4888397,144.33446 18.2884,131.73534 h -5.598633 v -5.20093 z m -8.6000974,8.10132 -10.8017585,12.59913 h 5.60083 v 5.2998 h 10.3996581 v -5.2998 h 5.6008306 z" />
          </g>
        </svg><span> Exchange</span></a>
        <a href="https://www.betfair.com.au/hub/">Hub</a>
      </div>

      

    </nav>
    
  </header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../data/dataListing/" class="md-tabs__link">
          
  
  Data

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../wagering/betfairHowTo/" class="md-tabs__link">
          
  
  Wagering

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../api/apiResources/" class="md-tabs__link">
          
  
  API

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../modelling/brownlowDatathon/" class="md-tabs__link">
          
  
  Modelling

        </a>
      </li>
    
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../How_to_Automate_1/" class="md-tabs__link">
          
  
  Tutorials

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../mentalGame/intro/" class="md-tabs__link">
          
  
  Mental Game

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../contactUs/test/" class="md-tabs__link">
          
  
  Contact Us

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="The Automation Hub" class="md-nav__button md-logo" aria-label="The Automation Hub" data-md-component="logo">
      
  <img src="../../img/logo.svg" alt="logo">

    </a>
    The Automation Hub
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Data
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Data
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../data/dataListing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CSV Files
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../data/usingHistoricDataSite/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Historic Data Site
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Wagering
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Wagering
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../wagering/betfairHowTo/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Betfair How-To
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../wagering/bettingGlossary/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Betting Glossary
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../wagering/stakingMethods/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Staking Methods and Bankroll Management
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../wagering/valueAndOdds/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Value and Odds
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../wagering/commission/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Commission and other charges
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../wagering/hubPredictionsModel/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Hub Predictions Model
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../wagering/2ndPlaceVoid/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Cashback 2nd Markets
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../wagering/exactaQuinella/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Exactas & Quinella
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    API
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            API
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/apiResources/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    API resources
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/apiappkey/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to access the Betfair API
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/apiRtutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    API tutorial in R
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/apiPythontutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    API tutorial in Python
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Modelling
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Modelling
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/brownlowDatathon/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Brownlow Medal Datathon
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/howToModel/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Intro to modelling
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/dataSources/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Pricing Data Sources
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/cloudOrLocalMachine/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Cloud or Local
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/monteCarloSimulations/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Monte Carlo Simulations
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_6" >
        
          
          <label class="md-nav__link" for="__nav_5_6" id="__nav_5_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    AFL
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_6">
            <span class="md-nav__icon md-icon"></span>
            AFL
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/AFLPlayerDisposalsTutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Player Disposal Lines
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/AFLPlayerDisposalsFlumine/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Betting Player Disposal Markets
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/modellingTheBrownlowMedal/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How does a Data Scientist model the Brownlow?
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_7" >
        
          
          <label class="md-nav__link" for="__nav_5_7" id="__nav_5_7_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    AFL (Archive)
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_7">
            <span class="md-nav__icon md-icon"></span>
            AFL (Archive)
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/AFLmodellingPython/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    AFL modelling walk through in Python
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/brownlowModelTutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Modelling the Brownlow Medal in Python
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_8" >
        
          
          <label class="md-nav__link" for="__nav_5_8" id="__nav_5_8_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Greyhounds
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_8">
            <span class="md-nav__icon md-icon"></span>
            Greyhounds
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/topazTutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Greyhound Topaz API (Python)
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_9" >
        
          
          <label class="md-nav__link" for="__nav_5_9" id="__nav_5_9_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Greyhounds (Archive)
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_9">
            <span class="md-nav__icon md-icon"></span>
            Greyhounds (Archive)
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/fasttrackTutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Greyhound FastTrack API (Python)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/greyhoundModellingPython/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Greyhound modelling (Python)
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_10" >
        
          
          <label class="md-nav__link" for="__nav_5_10" id="__nav_5_10_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Soccer
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_10">
            <span class="md-nav__icon md-icon"></span>
            Soccer
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/howToBuildASoccerBotPartI/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How To Build A Soccer Bot P1
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/howToBuildASoccerBotPartII/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How To Build A Soccer Bot P2
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/howToBuildASoccerBotPartIII/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How To Build A Soccer Bot P3
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_11" >
        
          
          <label class="md-nav__link" for="__nav_5_11" id="__nav_5_11_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Soccer (Archive)
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_11_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_11">
            <span class="md-nav__icon md-icon"></span>
            Soccer (Archive)
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/soccerModellingTutorialPython/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Soccer modelling (Python)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/EPLmlPython/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    EPL Machine Learning (Python)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/soccerModellingELO2022WorldCup/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Soccer modelling (R) - 2022 FIFA World Cup
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/soccerEloTutorialR/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Elo soccer tutorial (R)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/soccerModellingTutorialR/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Soccer modelling (R)
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_12" >
        
          
          <label class="md-nav__link" for="__nav_5_12" id="__nav_5_12_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Tennis (Archive)
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_12_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_12">
            <span class="md-nav__icon md-icon"></span>
            Tennis (Archive)
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/howToModelTheAusOpen/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to model the Australian Open
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/AusOpenRTutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Aus Open R Tutorial
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../modelling/AusOpenPythonTutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Aus Open Python Tutorial
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" checked>
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Tutorials
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Tutorials
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../How_to_Automate_1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to Automate 1
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../How_to_Automate_2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to Automate 2
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../How_to_Automate_3/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to Automate 3
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../How_to_Automate_4/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to Automate 4
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../How_to_Automate_5/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to Automate 5
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Flumine Results to CSV Files
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Flumine Results to CSV Files
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#coding-principles" class="md-nav__link">
    <span class="md-ellipsis">
      Coding Principles
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#structure" class="md-nav__link">
    <span class="md-ellipsis">
      Structure
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mainpy" class="md-nav__link">
    <span class="md-ellipsis">
      Main.py
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cross-matching" class="md-nav__link">
    <span class="md-ellipsis">
      Cross-Matching
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#utilspy" class="md-nav__link">
    <span class="md-ellipsis">
      utils.py
    </span>
  </a>
  
    <nav class="md-nav" aria-label="utils.py">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#inferring-placings-from-market-results" class="md-nav__link">
    <span class="md-ellipsis">
      Inferring placings from market results
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#racing_loggerpy" class="md-nav__link">
    <span class="md-ellipsis">
      racing_logger.py
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#placing_helperspy" class="md-nav__link">
    <span class="md-ellipsis">
      placing_helpers.py
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#discord_helperspy" class="md-nav__link">
    <span class="md-ellipsis">
      discord_helpers.py
    </span>
  </a>
  
    <nav class="md-nav" aria-label="discord_helpers.py">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#disclaimer" class="md-nav__link">
    <span class="md-ellipsis">
      Disclaimer
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../flumineSimulations/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Flumine Simulations
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../processingTarFiles101/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Take away the pain! Processing TAR Files 101
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../jsonToCsvRevisited/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    JSON to CSV | Revisited
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../backtestingRatingsTutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Back testing ratings in Python
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../automatedBettingAnglesTutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Automated betting angles in Python
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../analysingAndPredictingMarketMovements/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Do they know? Analysing Betfair market formation & market movements
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../analysingAndPredictingBSP/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Wisdom of the crowd? Analysing & understanding BSP
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Mental Game
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            Mental Game
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/intro/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Intro
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/roleOfEmotions/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Part 1
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/mapYourEmotions/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Part 2
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/handlingBadVariance/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Part 3
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/winbyBeingGreatatLosing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Part 4
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/correctingyouremotions/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Part 5
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/responsibleGambling/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Part 6
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/InchwormConcept/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Part 7
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/HighExpectations/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Part 8
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mentalGame/TappingYourIntuition/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Part 9
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_8" >
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Contact Us
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            Contact Us
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../contactUs/test/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Meet the Team
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



  <h1>Flumine Results to CSV Files</h1>

<p>A common struggle shared by many a user of Betfair is how to build a database of results from the Betfair Exchange.</p>
<p>There are many different sources of data available, each with its own limitations and lag times.
These sources include:</p>
<ul>
<li><a href="https://promo.betfair.com/betfairsp/prices">Daily CSV Files</a> </li>
<li><a href="https://betfair-datascientists.github.io/data/dataListing/">Monthly CSV Blocks</a></li>
<li><a href="https://www.betfair.com.au/hub/racing/horse-racing/racing-results/">Hub Results Graphical UI</a></li>
<li><a href="https://historicdata.betfair.com/#/mydata">Historical Stream Files</a></li>
</ul>
<p>However, as is often said, the most accurate and valuable source of data that you can use for modelling is data that you collect yourself.
Collecting your own data ensures that data leakage is excluded from your database, as is always a danger when using someone else's data.</p>
<p>The challenge with collecting your own data is, of course, patience. And the fewer events that take place for your chosen sport or racing code, the longer you need to wait to collect a meaningful data set.
Greyhound Racing, sometimes with 150+ Australian races per day, won't take long, maybe 3 months, to collect a meaningful dataset, whereas Thoroughbred racing might be 12 months, and sport data even longer.
And for events like the Olympics, well you'll need to have the patience of a saint.</p>
<p>There goes a saying of unknown origin that states <strong>"The best time to plant a tree is twenty years ago. The second best time is now."</strong>
Well let's look at how we plant the seed of building a database of recordings from the Betfair Streaming and Polling APIs as well as a template for sending alerts to an external service like Discord</p>
<div class="admonition info">
<p class="admonition-title">Read-Only</p>
<p>Read-only access to the live Betfair API is not allowed, so any results recording bot should be supplemented with betting activity to maintain live access</p>
</div>
<h2 id="coding-principles">Coding Principles</h2>
<p>As I'm sure many self-taught coders started out, my early python code consisted of one long script with less than 5 defined functions. This code tended to be a nightmare to maintain, debug and little to no reusability or compartmentalisation. Thankfully, I'm now older and (somewhat) wiser, and I've learned some basic principles of coding that have helped to make code more logical and maintainable.</p>
<p><strong>"Write your code as though the person who has to maintain it is a violent psychopath who knows where you live (and that someone might be you)" - Unknown</strong></p>
<p>Here's a short list of tips to improve the quality of your code</p>
<ul>
<li>Break your code into functions — each function should do one clear job.</li>
<li>Use meaningful names for variables and functions so the code explains itself.</li>
<li>Add comments for “why”, not “what” (the code should show what it’s doing).</li>
<li>Keep your code consistent in style (indentation, naming, spacing).</li>
<li>Test your code in small pieces and use print/logging to trace issues.</li>
<li>Where possible, utilise multiple files to reduce the number of lines in each file</li>
</ul>
<p>This tutorial will be written utilising the flumine python wrapper and using the Visual Studio Code IDE</p>
<h2 id="structure">Structure</h2>
<p>This bot is setup with 5 files to reduce the size of each file:</p>
<ul>
<li>main.py</li>
<li>utils.py</li>
<li>placing_helpers.py</li>
<li>racing_logger.py</li>
<li>discord_helper.py</li>
</ul>
<p>We'll run the main.py file only, and it will import all the other files to assist the process. You could further compartmentalise this to have a config.py file and only ever need to change that file.</p>
<p>The live API key being used to run this bot has a market subscription limit of 1000 for the streaming API, if you need an increased limit please email automation@betfair.com.au (upon application)</p>
<h2 id="mainpy">Main.py</h2>
<div class="highlight"><span class="filename">main.py</span><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="c1"># Import Libraries</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">flumine</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flumine</span><span class="p">,</span> <span class="n">clients</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">betfairlightweight.filters</span><span class="w"> </span><span class="kn">import</span> <span class="n">streaming_market_filter</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">betfairlightweight.filters</span><span class="w"> </span><span class="kn">import</span> <span class="n">streaming_market_data_filter</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="c1"># Import Flumine Class and Util</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="kn">from</span><span class="w"> </span><span class="nn">racing_logger</span><span class="w"> </span><span class="kn">import</span> <span class="n">RacingLogger</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="kn">from</span><span class="w"> </span><span class="nn">utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">bflw_trading</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;results_logger.log&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">CRITICAL</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1">:</span><span class="si">%(levelname)s</span><span class="s1">:</span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>    <span class="c1"># Credentials to login and logging in </span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>    <span class="n">trading</span> <span class="o">=</span> <span class="n">bflw_trading</span><span class="p">()</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>    <span class="n">client</span> <span class="o">=</span> <span class="n">clients</span><span class="o">.</span><span class="n">BetfairClient</span><span class="p">(</span><span class="n">trading</span><span class="p">,</span> <span class="n">interactive_login</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># Not using certificates</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>    <span class="c1"># Define the framework</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>    <span class="n">framework</span> <span class="o">=</span> <span class="n">Flumine</span><span class="p">(</span><span class="n">client</span><span class="o">=</span><span class="n">client</span><span class="p">)</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>    <span class="c1"># Define the flumine strategy</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>    <span class="n">market_monitoring</span> <span class="o">=</span> <span class="n">RacingLogger</span><span class="p">(</span>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>        <span class="n">market_filter</span><span class="o">=</span><span class="n">streaming_market_filter</span><span class="p">(</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>            <span class="n">event_type_ids</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;4339&quot;</span><span class="p">],</span> <span class="c1"># Greyhound Markets</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>            <span class="n">market_types</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;WIN&#39;</span><span class="p">,</span><span class="s1">&#39;PLACE&#39;</span><span class="p">,</span><span class="s1">&#39;EXACTA&#39;</span><span class="p">,</span><span class="s1">&#39;QUINELLA&#39;</span><span class="p">,</span><span class="s1">&#39;FORECAST&#39;</span><span class="p">,</span><span class="s1">&#39;REV_FORECAST&#39;</span><span class="p">],</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>        <span class="p">),</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>        <span class="n">market_data_filter</span><span class="o">=</span><span class="n">streaming_market_data_filter</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>        <span class="s2">&quot;EX_BEST_OFFERS_DISP&quot;</span><span class="p">,</span> <span class="c1"># This imports cross-matching or virtual bets</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>        <span class="s2">&quot;EX_TRADED&quot;</span><span class="p">,</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>        <span class="s2">&quot;EX_TRADED_VOL&quot;</span><span class="p">,</span>
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a>        <span class="s2">&quot;EX_LTP&quot;</span><span class="p">,</span>
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a>        <span class="s2">&quot;EX_MARKET_DEF&quot;</span><span class="p">,</span>
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a>        <span class="s2">&quot;SP_TRADED&quot;</span><span class="p">,</span>
<a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a>        <span class="s2">&quot;SP_PROJECTED&quot;</span><span class="p">],</span> <span class="n">ladder_levels</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span>
<a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a>        <span class="n">streaming_timeout</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a>    <span class="p">)</span>
<a id="__codelineno-0-39" name="__codelineno-0-39" href="#__codelineno-0-39"></a>
<a id="__codelineno-0-40" name="__codelineno-0-40" href="#__codelineno-0-40"></a>    <span class="n">framework</span><span class="o">.</span><span class="n">add_strategy</span><span class="p">(</span><span class="n">market_monitoring</span><span class="p">)</span>
<a id="__codelineno-0-41" name="__codelineno-0-41" href="#__codelineno-0-41"></a>
<a id="__codelineno-0-42" name="__codelineno-0-42" href="#__codelineno-0-42"></a>    <span class="n">framework</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</code></pre></div>
<h2 id="cross-matching">Cross-Matching</h2>
<p>Cross-matching bets are bets automatically placed by an engine within the Betfair infrastructure to extend the reach of bets being offered on the Exchange.</p>
<p>An example of this would be a customer offering a lay bet to lose $50 at a price of $10 on the outcome "Under 0.5 Goals" in the market type "OVER_UNDER_05" for a soccer match.
The opposing customer would then see a back bet available to take of $50 at a price of $10. 
The cross-matching engine could, in theory, offer this bet on the following equivalent selections within the same event:</p>
<table>
<thead>
<tr>
<th>Market Type</th>
<th>Selection</th>
<th>Side</th>
<th>Price</th>
<th>Size</th>
</tr>
</thead>
<tbody>
<tr>
<td>CORRECT_SCORE</td>
<td>0 - 0</td>
<td>BACK</td>
<td>$10.00</td>
<td>$50.00</td>
</tr>
<tr>
<td>OVER_UNDER_05</td>
<td>Over 0.5 Goals</td>
<td>LAY</td>
<td>$1.11</td>
<td>$454.54</td>
</tr>
<tr>
<td>MATCH_ODDS_AND_BTTS</td>
<td>Draw/No</td>
<td>BACK</td>
<td>$10.00</td>
<td>$50.00</td>
</tr>
</tbody>
</table>
<p>These prices and stakes are calculated as <strong>1 / (1 - 1 / (Price))</strong> with the price then rounded down to the nearest tick for back and up for lay.</p>
<p>This logic covers all 2 selection markets like Over/Under markets, but <strong>how is it calculated for markets of 3 or more selections?</strong>.
As the number of runners increase in a market, the calculations become more complex but the cross-matching does help in closing the gap between back and lay prices.</p>
<p>Let's consider a racing win market with 5 runners.</p>
<table>
<thead>
<tr>
<th>Runner</th>
<th>BATB</th>
<th>Prob</th>
<th>100%-SUM_OTHER_RUNNERS</th>
<th>XM Unrounded Lay</th>
<th>XM Rounded Lay</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>$7.00</td>
<td>14.28%</td>
<td>13.49%</td>
<td>$7.41</td>
<td>$7.50</td>
</tr>
<tr>
<td>2</td>
<td>$9.20</td>
<td>10.87%</td>
<td>10.08%</td>
<td>$9.92</td>
<td>$10.00</td>
</tr>
<tr>
<td>3</td>
<td>$2.50</td>
<td>40.00%</td>
<td>39.21%</td>
<td>$2.55</td>
<td>$2.56</td>
</tr>
<tr>
<td>2</td>
<td>$3.90</td>
<td>25.64%</td>
<td>24.85%</td>
<td>$4.02</td>
<td>$4.10</td>
</tr>
<tr>
<td>3</td>
<td>$10.00</td>
<td>10.00%</td>
<td>9.21%</td>
<td>$10.86</td>
<td>$11.00</td>
</tr>
</tbody>
</table>
<p>The column <strong>100%-SUM_OTHER_RUNNERS</strong> indicates how much market percentage is remaining if you took the current best available back prices for each runner excluding the current runner.
Using the fact that backing all other runners is the same as laying just one, the cross-matcher is able to calculate the price to offer on that one runner.</p>
<p>In the event that someone takes the cross-matcher price, then the cross-matcher would take all other back bets to ensure an even position. Obviously it can only offer
valid Betfair ticks, so it will round up the prices where it is backing (a lay bet for someone else to take) and round down lay bets. If someone were to take one of the back
bets available, then the cross matcher price would be invalid and then recalculated.</p>
<p>By default, Flumine does not return the cross-matching bets (also called virtual bets) so we must explicitly call it. These bets are available to take, so it makes sense to call them.
To do this we call <strong>"EX_BEST_OFFERS_DISP"</strong> in the streaming_market_data_filter.</p>
<h2 id="utilspy">utils.py</h2>
<p>'Utils' is a common name for a file where helper functions are defined. These are functions used multiple times and compartmentalising them in another .py file improves readability of the main code.</p>
<div class="highlight"><span class="filename">utils.py</span><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">betfairlightweight</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="sd">&#39;&#39;&#39;</span>
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="sd">This function defines our API login credentials</span>
<a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a><span class="sd">We are using the interactive login which doesn&#39;t use certificates</span>
<a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a><span class="sd">&#39;&#39;&#39;</span>
<a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a>
<a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a><span class="k">def</span><span class="w"> </span><span class="nf">bflw_trading</span><span class="p">():</span>
<a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a>
<a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;credentials.json&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a>        <span class="n">cred</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a>        <span class="n">username</span> <span class="o">=</span> <span class="n">cred</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]</span>
<a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a>        <span class="n">password</span> <span class="o">=</span> <span class="n">cred</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">]</span>
<a id="__codelineno-1-16" name="__codelineno-1-16" href="#__codelineno-1-16"></a>        <span class="n">app_key</span> <span class="o">=</span> <span class="n">cred</span><span class="p">[</span><span class="s1">&#39;app_key&#39;</span><span class="p">]</span>
<a id="__codelineno-1-17" name="__codelineno-1-17" href="#__codelineno-1-17"></a>
<a id="__codelineno-1-18" name="__codelineno-1-18" href="#__codelineno-1-18"></a>    <span class="c1"># Define the betfairlightweight client</span>
<a id="__codelineno-1-19" name="__codelineno-1-19" href="#__codelineno-1-19"></a>    <span class="n">trading</span> <span class="o">=</span> <span class="n">betfairlightweight</span><span class="o">.</span><span class="n">APIClient</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">app_key</span><span class="o">=</span><span class="n">app_key</span><span class="p">)</span>
<a id="__codelineno-1-20" name="__codelineno-1-20" href="#__codelineno-1-20"></a>
<a id="__codelineno-1-21" name="__codelineno-1-21" href="#__codelineno-1-21"></a>    <span class="k">return</span> <span class="n">trading</span>
<a id="__codelineno-1-22" name="__codelineno-1-22" href="#__codelineno-1-22"></a>
<a id="__codelineno-1-23" name="__codelineno-1-23" href="#__codelineno-1-23"></a><span class="sd">&#39;&#39;&#39;</span>
<a id="__codelineno-1-24" name="__codelineno-1-24" href="#__codelineno-1-24"></a><span class="sd">This function here is used with our Discord webhook</span>
<a id="__codelineno-1-25" name="__codelineno-1-25" href="#__codelineno-1-25"></a><span class="sd">We can decide which channel to send the notification to if we want separate out different codes and countries</span>
<a id="__codelineno-1-26" name="__codelineno-1-26" href="#__codelineno-1-26"></a><span class="sd">&#39;&#39;&#39;</span>
<a id="__codelineno-1-27" name="__codelineno-1-27" href="#__codelineno-1-27"></a>
<a id="__codelineno-1-28" name="__codelineno-1-28" href="#__codelineno-1-28"></a><span class="k">def</span><span class="w"> </span><span class="nf">pick_webhook</span><span class="p">(</span><span class="n">sport_name</span><span class="p">,</span><span class="n">race_type</span><span class="p">,</span><span class="n">event_country</span><span class="p">):</span>
<a id="__codelineno-1-29" name="__codelineno-1-29" href="#__codelineno-1-29"></a>
<a id="__codelineno-1-30" name="__codelineno-1-30" href="#__codelineno-1-30"></a>    <span class="k">if</span> <span class="n">sport_name</span> <span class="o">==</span> <span class="s1">&#39;Greyhound Racing&#39;</span><span class="p">:</span>
<a id="__codelineno-1-31" name="__codelineno-1-31" href="#__codelineno-1-31"></a>        <span class="k">return</span> <span class="s1">&#39;Greyhounds&#39;</span>
<a id="__codelineno-1-32" name="__codelineno-1-32" href="#__codelineno-1-32"></a>    <span class="k">elif</span> <span class="n">sport_name</span> <span class="o">==</span> <span class="s1">&#39;Horse Racing&#39;</span> <span class="ow">and</span> <span class="n">event_country</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;AU&#39;</span><span class="p">,</span><span class="s1">&#39;NZ&#39;</span><span class="p">]:</span>
<a id="__codelineno-1-33" name="__codelineno-1-33" href="#__codelineno-1-33"></a>        <span class="k">return</span> <span class="s1">&#39;ROW Horse Racing&#39;</span>
<a id="__codelineno-1-34" name="__codelineno-1-34" href="#__codelineno-1-34"></a>    <span class="k">elif</span> <span class="n">sport_name</span> <span class="o">==</span> <span class="s1">&#39;Horse Racing&#39;</span> <span class="ow">and</span> <span class="n">event_country</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;AU&#39;</span><span class="p">,</span><span class="s1">&#39;NZ&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">race_type</span> <span class="o">!=</span> <span class="s1">&#39;Harness&#39;</span><span class="p">:</span>
<a id="__codelineno-1-35" name="__codelineno-1-35" href="#__codelineno-1-35"></a>        <span class="k">return</span> <span class="s1">&#39;ANZ Thoroughbred Racing&#39;</span>
<a id="__codelineno-1-36" name="__codelineno-1-36" href="#__codelineno-1-36"></a>    <span class="k">elif</span> <span class="n">sport_name</span> <span class="o">==</span> <span class="s1">&#39;Horse Racing&#39;</span> <span class="ow">and</span> <span class="n">event_country</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;AU&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">race_type</span> <span class="o">==</span> <span class="s1">&#39;Harness&#39;</span><span class="p">:</span>
<a id="__codelineno-1-37" name="__codelineno-1-37" href="#__codelineno-1-37"></a>        <span class="k">return</span> <span class="s1">&#39;AUS Harness Racing&#39;</span>
<a id="__codelineno-1-38" name="__codelineno-1-38" href="#__codelineno-1-38"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-1-39" name="__codelineno-1-39" href="#__codelineno-1-39"></a>        <span class="k">return</span>
<a id="__codelineno-1-40" name="__codelineno-1-40" href="#__codelineno-1-40"></a>
<a id="__codelineno-1-41" name="__codelineno-1-41" href="#__codelineno-1-41"></a><span class="sd">&#39;&#39;&#39;</span>
<a id="__codelineno-1-42" name="__codelineno-1-42" href="#__codelineno-1-42"></a><span class="sd">This function is used to fetch the runner metadata from the runner catalogue</span>
<a id="__codelineno-1-43" name="__codelineno-1-43" href="#__codelineno-1-43"></a><span class="sd">We use the line m.get to gracefully retrieve data from the metadata dictionary</span>
<a id="__codelineno-1-44" name="__codelineno-1-44" href="#__codelineno-1-44"></a><span class="sd">This method does not raise an error where a default value is set</span>
<a id="__codelineno-1-45" name="__codelineno-1-45" href="#__codelineno-1-45"></a>
<a id="__codelineno-1-46" name="__codelineno-1-46" href="#__codelineno-1-46"></a><span class="sd">e.g. m.get(&#39;CLOTH_NUMBER&#39;, None) will set CLOTH_NUMBER to None if it does not exist</span>
<a id="__codelineno-1-47" name="__codelineno-1-47" href="#__codelineno-1-47"></a>
<a id="__codelineno-1-48" name="__codelineno-1-48" href="#__codelineno-1-48"></a><span class="sd">It&#39;s good practice to collect as much data as possible here, as the data generally doesn&#39;t persist</span>
<a id="__codelineno-1-49" name="__codelineno-1-49" href="#__codelineno-1-49"></a><span class="sd">&#39;&#39;&#39;</span>
<a id="__codelineno-1-50" name="__codelineno-1-50" href="#__codelineno-1-50"></a>
<a id="__codelineno-1-51" name="__codelineno-1-51" href="#__codelineno-1-51"></a><span class="k">def</span><span class="w"> </span><span class="nf">process_runner_catalogue</span><span class="p">(</span><span class="n">runner_catalogue</span><span class="p">):</span>
<a id="__codelineno-1-52" name="__codelineno-1-52" href="#__codelineno-1-52"></a>
<a id="__codelineno-1-53" name="__codelineno-1-53" href="#__codelineno-1-53"></a>    <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-1-54" name="__codelineno-1-54" href="#__codelineno-1-54"></a>
<a id="__codelineno-1-55" name="__codelineno-1-55" href="#__codelineno-1-55"></a>    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">runner_catalogue</span><span class="p">:</span>
<a id="__codelineno-1-56" name="__codelineno-1-56" href="#__codelineno-1-56"></a>
<a id="__codelineno-1-57" name="__codelineno-1-57" href="#__codelineno-1-57"></a>        <span class="n">m</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">metadata</span>
<a id="__codelineno-1-58" name="__codelineno-1-58" href="#__codelineno-1-58"></a>        <span class="n">runner_name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="s1">&#39;runner_name&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-1-59" name="__codelineno-1-59" href="#__codelineno-1-59"></a>
<a id="__codelineno-1-60" name="__codelineno-1-60" href="#__codelineno-1-60"></a>        <span class="n">cloth_number</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;CLOTH_NUMBER&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-1-61" name="__codelineno-1-61" href="#__codelineno-1-61"></a>        <span class="k">if</span> <span class="n">cloth_number</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">runner_name</span><span class="p">:</span>
<a id="__codelineno-1-62" name="__codelineno-1-62" href="#__codelineno-1-62"></a>            <span class="n">cloth_number</span> <span class="o">=</span> <span class="n">runner_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-1-63" name="__codelineno-1-63" href="#__codelineno-1-63"></a>
<a id="__codelineno-1-64" name="__codelineno-1-64" href="#__codelineno-1-64"></a>        <span class="n">row</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-1-65" name="__codelineno-1-65" href="#__codelineno-1-65"></a>            <span class="s1">&#39;selection_id&#39;</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">selection_id</span><span class="p">,</span>
<a id="__codelineno-1-66" name="__codelineno-1-66" href="#__codelineno-1-66"></a>            <span class="s1">&#39;runner_name&#39;</span><span class="p">:</span> <span class="n">runner_name</span><span class="p">,</span>
<a id="__codelineno-1-67" name="__codelineno-1-67" href="#__codelineno-1-67"></a>            <span class="s1">&#39;runner_id&#39;</span> <span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;runnerId&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
<a id="__codelineno-1-68" name="__codelineno-1-68" href="#__codelineno-1-68"></a>            <span class="s1">&#39;stall_draw&#39;</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;STALL_DRAW&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
<a id="__codelineno-1-69" name="__codelineno-1-69" href="#__codelineno-1-69"></a>            <span class="s1">&#39;cloth_number&#39;</span><span class="p">:</span> <span class="n">cloth_number</span><span class="p">,</span>
<a id="__codelineno-1-70" name="__codelineno-1-70" href="#__codelineno-1-70"></a>            <span class="s1">&#39;cloth_number_alpha&#39;</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;CLOTH_NUMBER_ALPHA&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
<a id="__codelineno-1-71" name="__codelineno-1-71" href="#__codelineno-1-71"></a>            <span class="s1">&#39;official_rating&#39;</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;OFFICIAL_RATING&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
<a id="__codelineno-1-72" name="__codelineno-1-72" href="#__codelineno-1-72"></a>            <span class="s1">&#39;forecast_price&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;FORECASTPRICE_NUMERATOR&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;FORECASTPRICE_DEMONINATOR&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">1</span><span class="p">),</span>
<a id="__codelineno-1-73" name="__codelineno-1-73" href="#__codelineno-1-73"></a>            <span class="s1">&#39;jockey_name&#39;</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;JOCKEY_NAME&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
<a id="__codelineno-1-74" name="__codelineno-1-74" href="#__codelineno-1-74"></a>            <span class="s1">&#39;jockey_claim&#39;</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;JOCKEY_CLAIM&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
<a id="__codelineno-1-75" name="__codelineno-1-75" href="#__codelineno-1-75"></a>            <span class="s1">&#39;trainer_name&#39;</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;TRAINER_NAME&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
<a id="__codelineno-1-76" name="__codelineno-1-76" href="#__codelineno-1-76"></a>            <span class="s1">&#39;owner_name&#39;</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;OWNER_NAME&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
<a id="__codelineno-1-77" name="__codelineno-1-77" href="#__codelineno-1-77"></a>            <span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;FORM&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
<a id="__codelineno-1-78" name="__codelineno-1-78" href="#__codelineno-1-78"></a>            <span class="s1">&#39;weight_carried&#39;</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;WEIGHT_VALUE&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
<a id="__codelineno-1-79" name="__codelineno-1-79" href="#__codelineno-1-79"></a>            <span class="s1">&#39;weight_value&#39;</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;WEIGHT_UNITS&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
<a id="__codelineno-1-80" name="__codelineno-1-80" href="#__codelineno-1-80"></a>            <span class="s1">&#39;days_since_last_run&#39;</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;DAYS_SINCE_LAST_RUN&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
<a id="__codelineno-1-81" name="__codelineno-1-81" href="#__codelineno-1-81"></a>            <span class="s1">&#39;wearing&#39;</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;WEARING&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
<a id="__codelineno-1-82" name="__codelineno-1-82" href="#__codelineno-1-82"></a>            <span class="s1">&#39;sex_type&#39;</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;SEX_TYPE&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
<a id="__codelineno-1-83" name="__codelineno-1-83" href="#__codelineno-1-83"></a>            <span class="s1">&#39;age&#39;</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;AGE&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
<a id="__codelineno-1-84" name="__codelineno-1-84" href="#__codelineno-1-84"></a>            <span class="s1">&#39;bred&#39;</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;BRED&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
<a id="__codelineno-1-85" name="__codelineno-1-85" href="#__codelineno-1-85"></a>            <span class="s1">&#39;colour_type&#39;</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;COLOUR_TYPE&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
<a id="__codelineno-1-86" name="__codelineno-1-86" href="#__codelineno-1-86"></a>            <span class="s1">&#39;dam_year_born&#39;</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;DAM_YEAR_BORN&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
<a id="__codelineno-1-87" name="__codelineno-1-87" href="#__codelineno-1-87"></a>            <span class="s1">&#39;dam_name&#39;</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;DAM_NAME&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
<a id="__codelineno-1-88" name="__codelineno-1-88" href="#__codelineno-1-88"></a>            <span class="s1">&#39;dam_bred&#39;</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;DAM_BRED&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
<a id="__codelineno-1-89" name="__codelineno-1-89" href="#__codelineno-1-89"></a>            <span class="s1">&#39;damsire_year_born&#39;</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;DAMSIRE_YEAR_BORN&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
<a id="__codelineno-1-90" name="__codelineno-1-90" href="#__codelineno-1-90"></a>            <span class="s1">&#39;damsire_name&#39;</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;DAMSIRE_NAME&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
<a id="__codelineno-1-91" name="__codelineno-1-91" href="#__codelineno-1-91"></a>            <span class="s1">&#39;damsire_bred&#39;</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;DAMSIRE_BRED&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
<a id="__codelineno-1-92" name="__codelineno-1-92" href="#__codelineno-1-92"></a>            <span class="s1">&#39;sire_year_born&#39;</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;SIRE_YEAR_BORN&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
<a id="__codelineno-1-93" name="__codelineno-1-93" href="#__codelineno-1-93"></a>            <span class="s1">&#39;sire_name&#39;</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;SIRE_NAME&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
<a id="__codelineno-1-94" name="__codelineno-1-94" href="#__codelineno-1-94"></a>            <span class="s1">&#39;sire_bred&#39;</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;SIRE_BRED&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
<a id="__codelineno-1-95" name="__codelineno-1-95" href="#__codelineno-1-95"></a>        <span class="p">}</span>
<a id="__codelineno-1-96" name="__codelineno-1-96" href="#__codelineno-1-96"></a>
<a id="__codelineno-1-97" name="__codelineno-1-97" href="#__codelineno-1-97"></a>        <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
<a id="__codelineno-1-98" name="__codelineno-1-98" href="#__codelineno-1-98"></a>
<a id="__codelineno-1-99" name="__codelineno-1-99" href="#__codelineno-1-99"></a>    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>
<a id="__codelineno-1-100" name="__codelineno-1-100" href="#__codelineno-1-100"></a>
<a id="__codelineno-1-101" name="__codelineno-1-101" href="#__codelineno-1-101"></a><span class="sd">&#39;&#39;&#39;</span>
<a id="__codelineno-1-102" name="__codelineno-1-102" href="#__codelineno-1-102"></a><span class="sd">This function may not make a whole of sense now but it&#39;s useful in our clean-up</span>
<a id="__codelineno-1-103" name="__codelineno-1-103" href="#__codelineno-1-103"></a><span class="sd">&#39;&#39;&#39;</span>
<a id="__codelineno-1-104" name="__codelineno-1-104" href="#__codelineno-1-104"></a>
<a id="__codelineno-1-105" name="__codelineno-1-105" href="#__codelineno-1-105"></a><span class="k">def</span><span class="w"> </span><span class="nf">clean_dataframe_dict_if_all_settled</span><span class="p">(</span><span class="n">dataframe_dict</span><span class="p">,</span><span class="n">market_groups</span><span class="p">,</span><span class="n">key</span><span class="p">):</span>
<a id="__codelineno-1-106" name="__codelineno-1-106" href="#__codelineno-1-106"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-1-107" name="__codelineno-1-107" href="#__codelineno-1-107"></a><span class="sd">    Checks if all non-None market_ids in self.market_groups[key] are settled.</span>
<a id="__codelineno-1-108" name="__codelineno-1-108" href="#__codelineno-1-108"></a><span class="sd">    If so, removes corresponding entries from self.dataframe_dict.</span>
<a id="__codelineno-1-109" name="__codelineno-1-109" href="#__codelineno-1-109"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-1-110" name="__codelineno-1-110" href="#__codelineno-1-110"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-1-111" name="__codelineno-1-111" href="#__codelineno-1-111"></a>        <span class="n">group</span> <span class="o">=</span> <span class="n">market_groups</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<a id="__codelineno-1-112" name="__codelineno-1-112" href="#__codelineno-1-112"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">group</span><span class="p">:</span>
<a id="__codelineno-1-113" name="__codelineno-1-113" href="#__codelineno-1-113"></a>            <span class="k">return</span>
<a id="__codelineno-1-114" name="__codelineno-1-114" href="#__codelineno-1-114"></a>
<a id="__codelineno-1-115" name="__codelineno-1-115" href="#__codelineno-1-115"></a>        <span class="c1"># Step 1–2: Get all _id keys with non-None values</span>
<a id="__codelineno-1-116" name="__codelineno-1-116" href="#__codelineno-1-116"></a>        <span class="n">active_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">group</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_id&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
<a id="__codelineno-1-117" name="__codelineno-1-117" href="#__codelineno-1-117"></a>
<a id="__codelineno-1-118" name="__codelineno-1-118" href="#__codelineno-1-118"></a>        <span class="c1"># Step 3: Get all _settled keys with value True</span>
<a id="__codelineno-1-119" name="__codelineno-1-119" href="#__codelineno-1-119"></a>        <span class="n">settled_flags</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">group</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_settled&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">]</span>
<a id="__codelineno-1-120" name="__codelineno-1-120" href="#__codelineno-1-120"></a>
<a id="__codelineno-1-121" name="__codelineno-1-121" href="#__codelineno-1-121"></a>        <span class="c1"># Step 4: Check if counts match</span>
<a id="__codelineno-1-122" name="__codelineno-1-122" href="#__codelineno-1-122"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">active_ids</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">settled_flags</span><span class="p">):</span>
<a id="__codelineno-1-123" name="__codelineno-1-123" href="#__codelineno-1-123"></a>            <span class="c1"># Step 5: Remove corresponding entries from self.dataframe_dict</span>
<a id="__codelineno-1-124" name="__codelineno-1-124" href="#__codelineno-1-124"></a>            <span class="k">for</span> <span class="n">market_id</span> <span class="ow">in</span> <span class="n">active_ids</span><span class="p">:</span>
<a id="__codelineno-1-125" name="__codelineno-1-125" href="#__codelineno-1-125"></a>                <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-1-126" name="__codelineno-1-126" href="#__codelineno-1-126"></a>                    <span class="k">if</span> <span class="n">market_id</span> <span class="ow">in</span> <span class="n">dataframe_dict</span><span class="p">:</span>
<a id="__codelineno-1-127" name="__codelineno-1-127" href="#__codelineno-1-127"></a>                        <span class="k">del</span> <span class="n">dataframe_dict</span><span class="p">[</span><span class="n">market_id</span><span class="p">]</span>
<a id="__codelineno-1-128" name="__codelineno-1-128" href="#__codelineno-1-128"></a>                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<a id="__codelineno-1-129" name="__codelineno-1-129" href="#__codelineno-1-129"></a>                    <span class="k">return</span>
<a id="__codelineno-1-130" name="__codelineno-1-130" href="#__codelineno-1-130"></a>    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<a id="__codelineno-1-131" name="__codelineno-1-131" href="#__codelineno-1-131"></a>        <span class="k">return</span>
<a id="__codelineno-1-132" name="__codelineno-1-132" href="#__codelineno-1-132"></a>
<a id="__codelineno-1-133" name="__codelineno-1-133" href="#__codelineno-1-133"></a><span class="sd">&#39;&#39;&#39;</span>
<a id="__codelineno-1-134" name="__codelineno-1-134" href="#__codelineno-1-134"></a><span class="sd">This helper function helps us to group markets together in a dictionary based on the number of winners.</span>
<a id="__codelineno-1-135" name="__codelineno-1-135" href="#__codelineno-1-135"></a><span class="sd">More information about why we use this dictionary can be found in the next section</span>
<a id="__codelineno-1-136" name="__codelineno-1-136" href="#__codelineno-1-136"></a><span class="sd">&#39;&#39;&#39;</span>
<a id="__codelineno-1-137" name="__codelineno-1-137" href="#__codelineno-1-137"></a>
<a id="__codelineno-1-138" name="__codelineno-1-138" href="#__codelineno-1-138"></a><span class="k">def</span><span class="w"> </span><span class="nf">set_market_id</span><span class="p">(</span><span class="n">market_groups</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">market_type</span><span class="p">,</span> <span class="n">number_of_winners</span><span class="p">,</span> <span class="n">market_id</span><span class="p">):</span>
<a id="__codelineno-1-139" name="__codelineno-1-139" href="#__codelineno-1-139"></a>
<a id="__codelineno-1-140" name="__codelineno-1-140" href="#__codelineno-1-140"></a>    <span class="k">if</span> <span class="n">market_type</span> <span class="o">==</span> <span class="s1">&#39;WIN&#39;</span><span class="p">:</span>
<a id="__codelineno-1-141" name="__codelineno-1-141" href="#__codelineno-1-141"></a>        <span class="n">market_groups</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;win_market_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">market_id</span>
<a id="__codelineno-1-142" name="__codelineno-1-142" href="#__codelineno-1-142"></a>    <span class="k">elif</span> <span class="n">market_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;PLACE&#39;</span><span class="p">,</span> <span class="s1">&#39;OTHER_PLACE&#39;</span><span class="p">]:</span>
<a id="__codelineno-1-143" name="__codelineno-1-143" href="#__codelineno-1-143"></a>        <span class="n">tbp_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">number_of_winners</span><span class="si">}</span><span class="s2">tbp_market_id&quot;</span>
<a id="__codelineno-1-144" name="__codelineno-1-144" href="#__codelineno-1-144"></a>        <span class="k">if</span> <span class="n">number_of_winners</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]:</span>
<a id="__codelineno-1-145" name="__codelineno-1-145" href="#__codelineno-1-145"></a>            <span class="n">market_groups</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">tbp_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">market_id</span>
<a id="__codelineno-1-146" name="__codelineno-1-146" href="#__codelineno-1-146"></a>    <span class="k">elif</span> <span class="n">market_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;EXACTA&#39;</span><span class="p">,</span> <span class="s1">&#39;FORECAST&#39;</span><span class="p">]:</span>
<a id="__codelineno-1-147" name="__codelineno-1-147" href="#__codelineno-1-147"></a>        <span class="n">market_groups</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;exacta_market_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">market_id</span>
<a id="__codelineno-1-148" name="__codelineno-1-148" href="#__codelineno-1-148"></a>    <span class="k">elif</span> <span class="n">market_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;QUINELLA&#39;</span><span class="p">,</span> <span class="s1">&#39;REV_FORECAST&#39;</span><span class="p">]:</span>
<a id="__codelineno-1-149" name="__codelineno-1-149" href="#__codelineno-1-149"></a>        <span class="n">market_groups</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;quinella_market_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">market_id</span>
</code></pre></div>
<h3 id="inferring-placings-from-market-results">Inferring placings from market results</h3>
<p><strong>"How do I figure out what position a runner finished in the race?"</strong></p>
<p>Placing information is not something that can be easily inferred from the Betfair API as the runner status only returns whether a runner (or runner/handicap combination) is a winner in a specific market.
While it is possible to get placing info from another source, this can be time consuming and/or costly. So I'll explain how we can do this with the Betfair API and you can decide for yourself whether the resulting information is complete enough for your use case.</p>
<p>An Event ID for a race meeting will cover all markets offered on a race card for all races. This is helpful but not quite enough. All markets concerned with a single race will have a unique event ID / market start time combination. To utilise this information we will set our key for the race to be the set of these two variables, and we'll work to define which markets will help to infer which places.</p>
<p>The dictionary will be in the format:</p>
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>market_groups[key] = {&#39;win_market_id&#39;: market_type == &#39;WIN&#39;,
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>                      &#39;2tbp_market_id&#39;: market_type in [&#39;PLACE&#39;,&#39;OTHER_PLACE&#39;] and number_of_winners == 2,
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>                      &#39;3tbp_market_id&#39;: market_type in [&#39;PLACE&#39;,&#39;OTHER_PLACE&#39;] and number_of_winners == 3,
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>                      &#39;4tbp_market_id&#39;: market_type in [&#39;PLACE&#39;,&#39;OTHER_PLACE&#39;] and number_of_winners == 4,
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a>                      &#39;quinella_market_id&#39;: market_type in [&#39;QUINELLA&#39;,&#39;REV_FORECAST&#39;],
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a>                      &#39;exacta_market_id&#39;: market_type in [&#39;EXACTA&#39;,&#39;FORECAST&#39;]
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a>                      }
</code></pre></div>
Not every race will have all of these markets, but we will use the data we do have to great effect.</p>
<p>Notes:</p>
<ul>
<li>'OTHER_PLACE' refers to alternate place markets with a differing number of winners from the main place market. (BSP may not be offered on these markets).</li>
<li>Both Exacta and Quinella markets are used as redundancies in case one is present and not the other, or 'Any Other Result' is the result of one of them.</li>
</ul>
<p>The logic used to infer placings is as follows (assuming all markets are present and settled):</p>
<ul>
<li>4th Place = 'WINNER' in 4TBP market and 'LOSER' in 3TBP market</li>
<li>3rd Place = 'WINNER' in 3TBP market and 'LOSER' in 2TBP market OR cloth number not part of winning selection in Quinella/Exacta market</li>
<li>2nd Place = ('WINNER' in 2TBP market or cloth number part of winning selection in Quinella/Exacta market) and 'LOSER' in WIN market</li>
<li>1st Place = 'WINNER' in Win Market</li>
</ul>
<p>It can occur that the 2nd and 3rd place runners' order cannot be determined due to the 2TBP not being offered or the Quinella/Exacta markets being voided/not offered or 'Any Other Result' being the winning selection in those markets.
In these instances we will define the result as 'P' instead of the numerical value. This is common for Harness markets where 'OTHER_PLACE' is not commonly offered and no exotics are normally offered.</p>
<h2 id="racing_loggerpy">racing_logger.py</h2>
<p>Now let's outline our custom flumine class. While this code could be refactored further, keeping the process_market_book function as flat as possible enables better readability.</p>
<div class="highlight"><span class="filename">Imports and Global Variables</span><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="c1"># Import libraries</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">flumine</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseStrategy</span> 
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">flumine.markets.market</span><span class="w"> </span><span class="kn">import</span> <span class="n">Market</span>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">betfairlightweight.resources</span><span class="w"> </span><span class="kn">import</span> <span class="n">MarketBook</span>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timezone</span>
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">pytz</span>
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a>
<a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a><span class="c1"># Import custom functions</span>
<a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a><span class="kn">from</span><span class="w"> </span><span class="nn">placing_helpers</span><span class="w"> </span><span class="kn">import</span> <span class="n">save_with_placings</span><span class="p">,</span> <span class="n">save_market_csv</span><span class="p">,</span> <span class="n">determine_placings</span><span class="p">,</span> <span class="n">merge_place_into_win</span>
<a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a><span class="kn">from</span><span class="w"> </span><span class="nn">discord_helpers</span><span class="w"> </span><span class="kn">import</span> <span class="n">discord_placings_report</span><span class="p">,</span> <span class="n">run_all_discord_alerts</span><span class="p">,</span> <span class="n">send_market_void_alert</span>
<a id="__codelineno-3-13" name="__codelineno-3-13" href="#__codelineno-3-13"></a><span class="kn">from</span><span class="w"> </span><span class="nn">utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">process_runner_catalogue</span><span class="p">,</span> <span class="n">clean_dataframe_dict_if_all_settled</span><span class="p">,</span> <span class="n">set_market_id</span><span class="p">,</span> <span class="n">pick_webhook</span>
<a id="__codelineno-3-14" name="__codelineno-3-14" href="#__codelineno-3-14"></a>
<a id="__codelineno-3-15" name="__codelineno-3-15" href="#__codelineno-3-15"></a><span class="c1"># Set Global Variables</span>
<a id="__codelineno-3-16" name="__codelineno-3-16" href="#__codelineno-3-16"></a><span class="n">DISCORD_ALERTS_WEBHOOK</span> <span class="o">=</span> <span class="s1">&#39;INSERT WEBHOOK URL&#39;</span>
<a id="__codelineno-3-17" name="__codelineno-3-17" href="#__codelineno-3-17"></a>
<a id="__codelineno-3-18" name="__codelineno-3-18" href="#__codelineno-3-18"></a><span class="n">DISCORD_WEBHOOKS</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-3-19" name="__codelineno-3-19" href="#__codelineno-3-19"></a>    <span class="s1">&#39;ANZ Thoroughbred Racing&#39;</span><span class="p">:</span><span class="s1">&#39;INSERT WEBHOOK URL&#39;</span><span class="p">,</span>
<a id="__codelineno-3-20" name="__codelineno-3-20" href="#__codelineno-3-20"></a>    <span class="s1">&#39;AUS Harness Racing&#39;</span><span class="p">:</span><span class="s1">&#39;INSERT WEBHOOK URL&#39;</span><span class="p">,</span>
<a id="__codelineno-3-21" name="__codelineno-3-21" href="#__codelineno-3-21"></a>    <span class="s1">&#39;ROW Horse Racing&#39;</span><span class="p">:</span><span class="s1">&#39;INSERT WEBHOOK URL&#39;</span><span class="p">,</span>
<a id="__codelineno-3-22" name="__codelineno-3-22" href="#__codelineno-3-22"></a>    <span class="s1">&#39;Greyhounds&#39;</span><span class="p">:</span><span class="s1">&#39;INSERT WEBHOOK URL&#39;</span>
<a id="__codelineno-3-23" name="__codelineno-3-23" href="#__codelineno-3-23"></a>    <span class="p">}</span>
<a id="__codelineno-3-24" name="__codelineno-3-24" href="#__codelineno-3-24"></a>
<a id="__codelineno-3-25" name="__codelineno-3-25" href="#__codelineno-3-25"></a><span class="n">MARKET_TYPES</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;win&#39;</span><span class="p">,</span> <span class="s1">&#39;2tbp&#39;</span><span class="p">,</span> <span class="s1">&#39;3tbp&#39;</span><span class="p">,</span> <span class="s1">&#39;4tbp&#39;</span><span class="p">,</span> <span class="s1">&#39;exacta&#39;</span><span class="p">,</span> <span class="s1">&#39;quinella&#39;</span><span class="p">]</span>
<a id="__codelineno-3-26" name="__codelineno-3-26" href="#__codelineno-3-26"></a>
<a id="__codelineno-3-27" name="__codelineno-3-27" href="#__codelineno-3-27"></a><span class="c1"># Columns for Metadata CSV Files</span>
<a id="__codelineno-3-28" name="__codelineno-3-28" href="#__codelineno-3-28"></a><span class="n">METADATA_COLUMNS</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-3-29" name="__codelineno-3-29" href="#__codelineno-3-29"></a>    <span class="s1">&#39;event_name&#39;</span><span class="p">,</span>
<a id="__codelineno-3-30" name="__codelineno-3-30" href="#__codelineno-3-30"></a>    <span class="s1">&#39;event_date_local&#39;</span><span class="p">,</span>
<a id="__codelineno-3-31" name="__codelineno-3-31" href="#__codelineno-3-31"></a>    <span class="s1">&#39;event_timezone&#39;</span><span class="p">,</span>
<a id="__codelineno-3-32" name="__codelineno-3-32" href="#__codelineno-3-32"></a>    <span class="s1">&#39;event_country&#39;</span><span class="p">,</span>
<a id="__codelineno-3-33" name="__codelineno-3-33" href="#__codelineno-3-33"></a>    <span class="s1">&#39;event_id&#39;</span><span class="p">,</span>
<a id="__codelineno-3-34" name="__codelineno-3-34" href="#__codelineno-3-34"></a>    <span class="s1">&#39;track&#39;</span><span class="p">,</span>
<a id="__codelineno-3-35" name="__codelineno-3-35" href="#__codelineno-3-35"></a>    <span class="s1">&#39;market_id&#39;</span><span class="p">,</span>
<a id="__codelineno-3-36" name="__codelineno-3-36" href="#__codelineno-3-36"></a>    <span class="s1">&#39;market_name&#39;</span><span class="p">,</span>
<a id="__codelineno-3-37" name="__codelineno-3-37" href="#__codelineno-3-37"></a>    <span class="s1">&#39;market_time&#39;</span><span class="p">,</span>
<a id="__codelineno-3-38" name="__codelineno-3-38" href="#__codelineno-3-38"></a>    <span class="s1">&#39;selection_id&#39;</span><span class="p">,</span>
<a id="__codelineno-3-39" name="__codelineno-3-39" href="#__codelineno-3-39"></a>    <span class="s1">&#39;runner_name&#39;</span><span class="p">,</span>
<a id="__codelineno-3-40" name="__codelineno-3-40" href="#__codelineno-3-40"></a>    <span class="s1">&#39;runner_id&#39;</span><span class="p">,</span>
<a id="__codelineno-3-41" name="__codelineno-3-41" href="#__codelineno-3-41"></a>    <span class="s1">&#39;stall_draw&#39;</span><span class="p">,</span>
<a id="__codelineno-3-42" name="__codelineno-3-42" href="#__codelineno-3-42"></a>    <span class="s1">&#39;cloth_number&#39;</span><span class="p">,</span>
<a id="__codelineno-3-43" name="__codelineno-3-43" href="#__codelineno-3-43"></a>    <span class="s1">&#39;cloth_number_alpha&#39;</span><span class="p">,</span>
<a id="__codelineno-3-44" name="__codelineno-3-44" href="#__codelineno-3-44"></a>    <span class="s1">&#39;official_rating&#39;</span><span class="p">,</span>
<a id="__codelineno-3-45" name="__codelineno-3-45" href="#__codelineno-3-45"></a>    <span class="s1">&#39;forecast_price&#39;</span><span class="p">,</span>
<a id="__codelineno-3-46" name="__codelineno-3-46" href="#__codelineno-3-46"></a>    <span class="s1">&#39;jockey_name&#39;</span><span class="p">,</span>
<a id="__codelineno-3-47" name="__codelineno-3-47" href="#__codelineno-3-47"></a>    <span class="s1">&#39;jockey_claim&#39;</span><span class="p">,</span>
<a id="__codelineno-3-48" name="__codelineno-3-48" href="#__codelineno-3-48"></a>    <span class="s1">&#39;trainer_name&#39;</span><span class="p">,</span>
<a id="__codelineno-3-49" name="__codelineno-3-49" href="#__codelineno-3-49"></a>    <span class="s1">&#39;owner_name&#39;</span><span class="p">,</span>
<a id="__codelineno-3-50" name="__codelineno-3-50" href="#__codelineno-3-50"></a>    <span class="s1">&#39;form&#39;</span><span class="p">,</span>
<a id="__codelineno-3-51" name="__codelineno-3-51" href="#__codelineno-3-51"></a>    <span class="s1">&#39;weight_carried&#39;</span><span class="p">,</span>
<a id="__codelineno-3-52" name="__codelineno-3-52" href="#__codelineno-3-52"></a>    <span class="s1">&#39;weight_value&#39;</span><span class="p">,</span>
<a id="__codelineno-3-53" name="__codelineno-3-53" href="#__codelineno-3-53"></a>    <span class="s1">&#39;days_since_last_run&#39;</span><span class="p">,</span>
<a id="__codelineno-3-54" name="__codelineno-3-54" href="#__codelineno-3-54"></a>    <span class="s1">&#39;wearing&#39;</span><span class="p">,</span>
<a id="__codelineno-3-55" name="__codelineno-3-55" href="#__codelineno-3-55"></a>    <span class="s1">&#39;sex_type&#39;</span><span class="p">,</span>
<a id="__codelineno-3-56" name="__codelineno-3-56" href="#__codelineno-3-56"></a>    <span class="s1">&#39;age&#39;</span><span class="p">,</span>
<a id="__codelineno-3-57" name="__codelineno-3-57" href="#__codelineno-3-57"></a>    <span class="s1">&#39;bred&#39;</span><span class="p">,</span>
<a id="__codelineno-3-58" name="__codelineno-3-58" href="#__codelineno-3-58"></a>    <span class="s1">&#39;colour_type&#39;</span><span class="p">,</span>
<a id="__codelineno-3-59" name="__codelineno-3-59" href="#__codelineno-3-59"></a>    <span class="s1">&#39;dam_year_born&#39;</span><span class="p">,</span>
<a id="__codelineno-3-60" name="__codelineno-3-60" href="#__codelineno-3-60"></a>    <span class="s1">&#39;dam_name&#39;</span><span class="p">,</span>
<a id="__codelineno-3-61" name="__codelineno-3-61" href="#__codelineno-3-61"></a>    <span class="s1">&#39;dam_bred&#39;</span><span class="p">,</span>
<a id="__codelineno-3-62" name="__codelineno-3-62" href="#__codelineno-3-62"></a>    <span class="s1">&#39;damsire_year_born&#39;</span><span class="p">,</span>
<a id="__codelineno-3-63" name="__codelineno-3-63" href="#__codelineno-3-63"></a>    <span class="s1">&#39;damsire_name&#39;</span><span class="p">,</span>
<a id="__codelineno-3-64" name="__codelineno-3-64" href="#__codelineno-3-64"></a>    <span class="s1">&#39;damsire_bred&#39;</span><span class="p">,</span>
<a id="__codelineno-3-65" name="__codelineno-3-65" href="#__codelineno-3-65"></a>    <span class="s1">&#39;sire_year_born&#39;</span><span class="p">,</span>
<a id="__codelineno-3-66" name="__codelineno-3-66" href="#__codelineno-3-66"></a>    <span class="s1">&#39;sire_name&#39;</span><span class="p">,</span>
<a id="__codelineno-3-67" name="__codelineno-3-67" href="#__codelineno-3-67"></a>    <span class="s1">&#39;sire_bred&#39;</span><span class="p">]</span>
<a id="__codelineno-3-68" name="__codelineno-3-68" href="#__codelineno-3-68"></a>
<a id="__codelineno-3-69" name="__codelineno-3-69" href="#__codelineno-3-69"></a><span class="c1"># Columns for CSV Output Files</span>
<a id="__codelineno-3-70" name="__codelineno-3-70" href="#__codelineno-3-70"></a><span class="n">MARKET_COLUMNS</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-3-71" name="__codelineno-3-71" href="#__codelineno-3-71"></a>    <span class="s1">&#39;sport_id&#39;</span><span class="p">,</span>
<a id="__codelineno-3-72" name="__codelineno-3-72" href="#__codelineno-3-72"></a>    <span class="s1">&#39;sport_name&#39;</span><span class="p">,</span>
<a id="__codelineno-3-73" name="__codelineno-3-73" href="#__codelineno-3-73"></a>    <span class="s1">&#39;event_date_local&#39;</span><span class="p">,</span>
<a id="__codelineno-3-74" name="__codelineno-3-74" href="#__codelineno-3-74"></a>    <span class="s1">&#39;event_timezone&#39;</span><span class="p">,</span>
<a id="__codelineno-3-75" name="__codelineno-3-75" href="#__codelineno-3-75"></a>    <span class="s1">&#39;event_country&#39;</span><span class="p">,</span>
<a id="__codelineno-3-76" name="__codelineno-3-76" href="#__codelineno-3-76"></a>    <span class="s1">&#39;event_name&#39;</span><span class="p">,</span>
<a id="__codelineno-3-77" name="__codelineno-3-77" href="#__codelineno-3-77"></a>    <span class="s1">&#39;event_id&#39;</span><span class="p">,</span>
<a id="__codelineno-3-78" name="__codelineno-3-78" href="#__codelineno-3-78"></a>    <span class="s1">&#39;track&#39;</span><span class="p">,</span>
<a id="__codelineno-3-79" name="__codelineno-3-79" href="#__codelineno-3-79"></a>    <span class="s1">&#39;market_id&#39;</span><span class="p">,</span>
<a id="__codelineno-3-80" name="__codelineno-3-80" href="#__codelineno-3-80"></a>    <span class="s1">&#39;market_name&#39;</span><span class="p">,</span>
<a id="__codelineno-3-81" name="__codelineno-3-81" href="#__codelineno-3-81"></a>    <span class="s1">&#39;total_runners&#39;</span><span class="p">,</span>
<a id="__codelineno-3-82" name="__codelineno-3-82" href="#__codelineno-3-82"></a>    <span class="s1">&#39;number_of_winners&#39;</span><span class="p">,</span>
<a id="__codelineno-3-83" name="__codelineno-3-83" href="#__codelineno-3-83"></a>    <span class="s1">&#39;clarifications&#39;</span><span class="p">,</span>
<a id="__codelineno-3-84" name="__codelineno-3-84" href="#__codelineno-3-84"></a>    <span class="s1">&#39;market_base_rate&#39;</span><span class="p">,</span>
<a id="__codelineno-3-85" name="__codelineno-3-85" href="#__codelineno-3-85"></a>    <span class="s1">&#39;market_time&#39;</span><span class="p">,</span>
<a id="__codelineno-3-86" name="__codelineno-3-86" href="#__codelineno-3-86"></a>    <span class="s1">&#39;inplay_time_local&#39;</span><span class="p">,</span>
<a id="__codelineno-3-87" name="__codelineno-3-87" href="#__codelineno-3-87"></a>    <span class="s1">&#39;market_type&#39;</span><span class="p">,</span>
<a id="__codelineno-3-88" name="__codelineno-3-88" href="#__codelineno-3-88"></a>    <span class="s1">&#39;race_type&#39;</span><span class="p">,</span>
<a id="__codelineno-3-89" name="__codelineno-3-89" href="#__codelineno-3-89"></a>    <span class="s1">&#39;selection_id&#39;</span><span class="p">,</span>
<a id="__codelineno-3-90" name="__codelineno-3-90" href="#__codelineno-3-90"></a>    <span class="s1">&#39;cloth_number&#39;</span><span class="p">,</span>
<a id="__codelineno-3-91" name="__codelineno-3-91" href="#__codelineno-3-91"></a>    <span class="s1">&#39;runner_name&#39;</span><span class="p">,</span>
<a id="__codelineno-3-92" name="__codelineno-3-92" href="#__codelineno-3-92"></a>    <span class="s1">&#39;runner_status&#39;</span><span class="p">,</span>
<a id="__codelineno-3-93" name="__codelineno-3-93" href="#__codelineno-3-93"></a>    <span class="s1">&#39;runner_removal_date&#39;</span><span class="p">,</span>
<a id="__codelineno-3-94" name="__codelineno-3-94" href="#__codelineno-3-94"></a>    <span class="s1">&#39;runner_adjustment_factor&#39;</span><span class="p">,</span>
<a id="__codelineno-3-95" name="__codelineno-3-95" href="#__codelineno-3-95"></a>    <span class="s1">&#39;runner_traded_before_scheduled_off&#39;</span><span class="p">,</span>
<a id="__codelineno-3-96" name="__codelineno-3-96" href="#__codelineno-3-96"></a>    <span class="s1">&#39;runner_max_price_traded_before_scheduled_off&#39;</span><span class="p">,</span>
<a id="__codelineno-3-97" name="__codelineno-3-97" href="#__codelineno-3-97"></a>    <span class="s1">&#39;runner_min_price_traded_before_scheduled_off&#39;</span><span class="p">,</span>
<a id="__codelineno-3-98" name="__codelineno-3-98" href="#__codelineno-3-98"></a>    <span class="s1">&#39;runner_wap_traded_before_scheduled_off&#39;</span><span class="p">,</span>
<a id="__codelineno-3-99" name="__codelineno-3-99" href="#__codelineno-3-99"></a>    <span class="s1">&#39;runner_ltp_at_scheduled_off&#39;</span><span class="p">,</span>
<a id="__codelineno-3-100" name="__codelineno-3-100" href="#__codelineno-3-100"></a>    <span class="s1">&#39;runner_batb_at_scheduled_off&#39;</span><span class="p">,</span>
<a id="__codelineno-3-101" name="__codelineno-3-101" href="#__codelineno-3-101"></a>    <span class="s1">&#39;runner_batl_at_scheduled_off&#39;</span><span class="p">,</span>
<a id="__codelineno-3-102" name="__codelineno-3-102" href="#__codelineno-3-102"></a>    <span class="s1">&#39;runner_sp_back_available_at_scheduled_off&#39;</span><span class="p">,</span>
<a id="__codelineno-3-103" name="__codelineno-3-103" href="#__codelineno-3-103"></a>    <span class="s1">&#39;runner_sp_lay_available_at_scheduled_off&#39;</span><span class="p">,</span>
<a id="__codelineno-3-104" name="__codelineno-3-104" href="#__codelineno-3-104"></a>    <span class="s1">&#39;runner_spf_at_scheduled_off&#39;</span><span class="p">,</span>
<a id="__codelineno-3-105" name="__codelineno-3-105" href="#__codelineno-3-105"></a>    <span class="s1">&#39;runner_spn_at_scheduled_off&#39;</span><span class="p">,</span>
<a id="__codelineno-3-106" name="__codelineno-3-106" href="#__codelineno-3-106"></a>    <span class="s1">&#39;runner_bsp&#39;</span><span class="p">,</span>
<a id="__codelineno-3-107" name="__codelineno-3-107" href="#__codelineno-3-107"></a>    <span class="s1">&#39;runner_sp_traded&#39;</span><span class="p">,</span>
<a id="__codelineno-3-108" name="__codelineno-3-108" href="#__codelineno-3-108"></a>    <span class="s1">&#39;runner_traded_volume_total&#39;</span><span class="p">,</span>
<a id="__codelineno-3-109" name="__codelineno-3-109" href="#__codelineno-3-109"></a>    <span class="s1">&#39;runner_max_price_total&#39;</span><span class="p">,</span>
<a id="__codelineno-3-110" name="__codelineno-3-110" href="#__codelineno-3-110"></a>    <span class="s1">&#39;runner_min_price_total&#39;</span><span class="p">,</span>
<a id="__codelineno-3-111" name="__codelineno-3-111" href="#__codelineno-3-111"></a>    <span class="s1">&#39;runner_wap_traded_total&#39;</span><span class="p">,</span>
<a id="__codelineno-3-112" name="__codelineno-3-112" href="#__codelineno-3-112"></a>    <span class="s1">&#39;runner_final_traded_price&#39;</span>
<a id="__codelineno-3-113" name="__codelineno-3-113" href="#__codelineno-3-113"></a><span class="p">]</span>
</code></pre></div>
<p>So we've defined everything, now lets launch straight into the flumine class. There are four main flumine base methods that we will customise in this bot:</p>
<ul>
<li>__init___</li>
<li>check_market_book</li>
<li>process_market_book</li>
<li>process_closed_market</li>
</ul>
<div class="highlight"><span class="filename">Custom Flumine Class</span><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">RacingLogger</span><span class="p">(</span><span class="n">BaseStrategy</span><span class="p">):</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a>
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a>
<a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_market_expiration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;market_expiration&quot;</span><span class="p">,</span> <span class="mi">3600</span><span class="p">)</span> <span class="c1"># Increases the default time</span>
<a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">market_info_gathered</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># Logging which markets we have gathered the initial info (including metadata)</span>
<a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">scheduled_off_info_gathered</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># Logging Markets at the scheduled start time</span>
<a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">bsp_info_gathered</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># Logging BSP reconciliation</span>
<a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">final_volume_info_gathered</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># Logging final traded volume info</span>
<a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">market_results</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># Logging closed markets</span>
<a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dataframe_dict</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># Holding dataframes in memory</span>
<a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">market_groups</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># Grouping markets together</span>
<a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">win_markets_written</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># Logging markets written to the CSV Files</span>
<a id="__codelineno-4-16" name="__codelineno-4-16" href="#__codelineno-4-16"></a>
<a id="__codelineno-4-17" name="__codelineno-4-17" href="#__codelineno-4-17"></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<a id="__codelineno-4-18" name="__codelineno-4-18" href="#__codelineno-4-18"></a><span class="sd">        The reason we log all these completed items is to prevent processes being run repeatedly and </span>
<a id="__codelineno-4-19" name="__codelineno-4-19" href="#__codelineno-4-19"></a><span class="sd">        potentially causing KeyErrors further down the line</span>
<a id="__codelineno-4-20" name="__codelineno-4-20" href="#__codelineno-4-20"></a><span class="sd">        &#39;&#39;&#39;</span>
<a id="__codelineno-4-21" name="__codelineno-4-21" href="#__codelineno-4-21"></a>
<a id="__codelineno-4-22" name="__codelineno-4-22" href="#__codelineno-4-22"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">check_market_book</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">market</span><span class="p">:</span> <span class="n">Market</span><span class="p">,</span> <span class="n">market_book</span><span class="p">:</span> <span class="n">MarketBook</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-4-23" name="__codelineno-4-23" href="#__codelineno-4-23"></a><span class="w">        </span><span class="sd">&#39;&#39;&#39; </span>
<a id="__codelineno-4-24" name="__codelineno-4-24" href="#__codelineno-4-24"></a><span class="sd">        Flumine has a default worker to fetch the market catalogue as it needs to call the polling API.</span>
<a id="__codelineno-4-25" name="__codelineno-4-25" href="#__codelineno-4-25"></a><span class="sd">        This means that it will run for the first minute or so with no market_catalogue.</span>
<a id="__codelineno-4-26" name="__codelineno-4-26" href="#__codelineno-4-26"></a><span class="sd">        Pausing until the market_catalogue is not None removes a host of errors</span>
<a id="__codelineno-4-27" name="__codelineno-4-27" href="#__codelineno-4-27"></a><span class="sd">        &#39;&#39;&#39;</span>
<a id="__codelineno-4-28" name="__codelineno-4-28" href="#__codelineno-4-28"></a>        <span class="k">if</span> <span class="n">market</span><span class="o">.</span><span class="n">market_catalogue</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> 
<a id="__codelineno-4-29" name="__codelineno-4-29" href="#__codelineno-4-29"></a>            <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-4-30" name="__codelineno-4-30" href="#__codelineno-4-30"></a>        <span class="k">elif</span> <span class="n">market</span><span class="o">.</span><span class="n">race_type</span> <span class="o">==</span> <span class="s1">&#39;Harness&#39;</span> <span class="ow">and</span> <span class="n">market</span><span class="o">.</span><span class="n">country_code</span> <span class="o">==</span> <span class="s1">&#39;NZ&#39;</span><span class="p">:</span> <span class="c1"># BSP is not offered on NZ Harness</span>
<a id="__codelineno-4-31" name="__codelineno-4-31" href="#__codelineno-4-31"></a>            <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-4-32" name="__codelineno-4-32" href="#__codelineno-4-32"></a>        <span class="k">elif</span> <span class="n">market</span><span class="o">.</span><span class="n">market_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">market_results</span><span class="p">:</span>
<a id="__codelineno-4-33" name="__codelineno-4-33" href="#__codelineno-4-33"></a>            <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-4-34" name="__codelineno-4-34" href="#__codelineno-4-34"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-4-35" name="__codelineno-4-35" href="#__codelineno-4-35"></a>            <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-4-36" name="__codelineno-4-36" href="#__codelineno-4-36"></a>
<a id="__codelineno-4-37" name="__codelineno-4-37" href="#__codelineno-4-37"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">process_market_book</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">market</span><span class="p">:</span> <span class="n">Market</span><span class="p">,</span> <span class="n">market_book</span><span class="p">:</span> <span class="n">MarketBook</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-4-38" name="__codelineno-4-38" href="#__codelineno-4-38"></a>
<a id="__codelineno-4-39" name="__codelineno-4-39" href="#__codelineno-4-39"></a>        <span class="k">if</span> <span class="n">market</span><span class="o">.</span><span class="n">seconds_to_start</span> <span class="o">&lt;</span> <span class="mi">300</span><span class="p">:</span>
<a id="__codelineno-4-40" name="__codelineno-4-40" href="#__codelineno-4-40"></a>
<a id="__codelineno-4-41" name="__codelineno-4-41" href="#__codelineno-4-41"></a>            <span class="c1"># Pull dataframe or initialise dataframe for this market</span>
<a id="__codelineno-4-42" name="__codelineno-4-42" href="#__codelineno-4-42"></a>            <span class="n">market_dataframe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe_dict</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">market</span><span class="o">.</span><span class="n">market_id</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">())</span>
<a id="__codelineno-4-43" name="__codelineno-4-43" href="#__codelineno-4-43"></a>
<a id="__codelineno-4-44" name="__codelineno-4-44" href="#__codelineno-4-44"></a>            <span class="c1"># Define key for this race</span>
<a id="__codelineno-4-45" name="__codelineno-4-45" href="#__codelineno-4-45"></a>            <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">market</span><span class="o">.</span><span class="n">event_id</span><span class="p">,</span> <span class="n">market</span><span class="o">.</span><span class="n">market_start_datetime</span><span class="p">)</span>
<a id="__codelineno-4-46" name="__codelineno-4-46" href="#__codelineno-4-46"></a>
<a id="__codelineno-4-47" name="__codelineno-4-47" href="#__codelineno-4-47"></a>            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">market_groups</span><span class="p">:</span>
<a id="__codelineno-4-48" name="__codelineno-4-48" href="#__codelineno-4-48"></a>
<a id="__codelineno-4-49" name="__codelineno-4-49" href="#__codelineno-4-49"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">market_groups</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-4-50" name="__codelineno-4-50" href="#__codelineno-4-50"></a>                    <span class="s1">&#39;event_id&#39;</span><span class="p">:</span> <span class="n">market</span><span class="o">.</span><span class="n">event_id</span><span class="p">,</span>
<a id="__codelineno-4-51" name="__codelineno-4-51" href="#__codelineno-4-51"></a>                    <span class="s1">&#39;market_time&#39;</span><span class="p">:</span> <span class="n">market</span><span class="o">.</span><span class="n">market_start_datetime</span><span class="p">,</span>
<a id="__codelineno-4-52" name="__codelineno-4-52" href="#__codelineno-4-52"></a>                    <span class="s1">&#39;win_market_id&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-4-53" name="__codelineno-4-53" href="#__codelineno-4-53"></a>                    <span class="s1">&#39;2tbp_market_id&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-4-54" name="__codelineno-4-54" href="#__codelineno-4-54"></a>                    <span class="s1">&#39;3tbp_market_id&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-4-55" name="__codelineno-4-55" href="#__codelineno-4-55"></a>                    <span class="s1">&#39;4tbp_market_id&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-4-56" name="__codelineno-4-56" href="#__codelineno-4-56"></a>                    <span class="s1">&#39;exacta_market_id&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-4-57" name="__codelineno-4-57" href="#__codelineno-4-57"></a>                    <span class="s1">&#39;quinella_market_id&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-4-58" name="__codelineno-4-58" href="#__codelineno-4-58"></a>                    <span class="s1">&#39;win_settled&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-4-59" name="__codelineno-4-59" href="#__codelineno-4-59"></a>                    <span class="s1">&#39;2tbp_settled&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-4-60" name="__codelineno-4-60" href="#__codelineno-4-60"></a>                    <span class="s1">&#39;3tbp_settled&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-4-61" name="__codelineno-4-61" href="#__codelineno-4-61"></a>                    <span class="s1">&#39;4tbp_settled&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-4-62" name="__codelineno-4-62" href="#__codelineno-4-62"></a>                    <span class="s1">&#39;exacta_settled&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-4-63" name="__codelineno-4-63" href="#__codelineno-4-63"></a>                    <span class="s1">&#39;quinella_settled&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-4-64" name="__codelineno-4-64" href="#__codelineno-4-64"></a>                <span class="p">}</span>
<a id="__codelineno-4-65" name="__codelineno-4-65" href="#__codelineno-4-65"></a>
<a id="__codelineno-4-66" name="__codelineno-4-66" href="#__codelineno-4-66"></a>            <span class="n">set_market_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">market_groups</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">market</span><span class="o">.</span><span class="n">market_type</span><span class="p">,</span> <span class="n">market_book</span><span class="o">.</span><span class="n">number_of_winners</span><span class="p">,</span> <span class="n">market</span><span class="o">.</span><span class="n">market_id</span><span class="p">)</span>
<a id="__codelineno-4-67" name="__codelineno-4-67" href="#__codelineno-4-67"></a>
<a id="__codelineno-4-68" name="__codelineno-4-68" href="#__codelineno-4-68"></a>            <span class="c1"># --- BASIC MARKET INFO ---</span>
<a id="__codelineno-4-69" name="__codelineno-4-69" href="#__codelineno-4-69"></a>            <span class="k">if</span> <span class="n">market</span><span class="o">.</span><span class="n">market_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">market_info_gathered</span><span class="p">:</span>
<a id="__codelineno-4-70" name="__codelineno-4-70" href="#__codelineno-4-70"></a>
<a id="__codelineno-4-71" name="__codelineno-4-71" href="#__codelineno-4-71"></a>                <span class="c1"># --- Event Info ---</span>
<a id="__codelineno-4-72" name="__codelineno-4-72" href="#__codelineno-4-72"></a>                <span class="n">event_data</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-4-73" name="__codelineno-4-73" href="#__codelineno-4-73"></a>                    <span class="s1">&#39;sport_id&#39;</span><span class="p">:</span> <span class="n">market</span><span class="o">.</span><span class="n">market_catalogue</span><span class="o">.</span><span class="n">event_type</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
<a id="__codelineno-4-74" name="__codelineno-4-74" href="#__codelineno-4-74"></a>                    <span class="s1">&#39;sport_name&#39;</span><span class="p">:</span> <span class="n">market</span><span class="o">.</span><span class="n">market_catalogue</span><span class="o">.</span><span class="n">event_type</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-4-75" name="__codelineno-4-75" href="#__codelineno-4-75"></a>                    <span class="s1">&#39;event_date&#39;</span><span class="p">:</span> <span class="n">market</span><span class="o">.</span><span class="n">market_catalogue</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">open_date</span><span class="p">,</span>
<a id="__codelineno-4-76" name="__codelineno-4-76" href="#__codelineno-4-76"></a>                    <span class="s1">&#39;event_name&#39;</span> <span class="p">:</span> <span class="n">market</span><span class="o">.</span><span class="n">market_catalogue</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-4-77" name="__codelineno-4-77" href="#__codelineno-4-77"></a>                    <span class="s1">&#39;event_timezone&#39;</span><span class="p">:</span> <span class="n">market</span><span class="o">.</span><span class="n">market_catalogue</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">time_zone</span><span class="p">,</span>
<a id="__codelineno-4-78" name="__codelineno-4-78" href="#__codelineno-4-78"></a>                    <span class="s1">&#39;event_date_local&#39;</span><span class="p">:</span> <span class="n">pytz</span><span class="o">.</span><span class="n">utc</span><span class="o">.</span><span class="n">localize</span><span class="p">(</span><span class="n">market</span><span class="o">.</span><span class="n">market_catalogue</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">open_date</span><span class="p">)</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">pytz</span><span class="o">.</span><span class="n">timezone</span><span class="p">(</span><span class="n">market</span><span class="o">.</span><span class="n">market_catalogue</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">time_zone</span><span class="p">))</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">-%m-%y %H:%M:%S&quot;</span><span class="p">),</span>
<a id="__codelineno-4-79" name="__codelineno-4-79" href="#__codelineno-4-79"></a>                    <span class="s1">&#39;event_country&#39;</span><span class="p">:</span> <span class="n">market</span><span class="o">.</span><span class="n">market_catalogue</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">country_code</span><span class="p">,</span>
<a id="__codelineno-4-80" name="__codelineno-4-80" href="#__codelineno-4-80"></a>                    <span class="s1">&#39;event_id&#39;</span><span class="p">:</span> <span class="n">market</span><span class="o">.</span><span class="n">market_catalogue</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
<a id="__codelineno-4-81" name="__codelineno-4-81" href="#__codelineno-4-81"></a>                    <span class="s1">&#39;track&#39;</span><span class="p">:</span> <span class="n">market</span><span class="o">.</span><span class="n">market_catalogue</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">venue</span> <span class="k">if</span> <span class="n">market</span><span class="o">.</span><span class="n">market_catalogue</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">venue</span> <span class="k">else</span> <span class="n">market</span><span class="o">.</span><span class="n">market_catalogue</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39; (&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
<a id="__codelineno-4-82" name="__codelineno-4-82" href="#__codelineno-4-82"></a>                <span class="p">}</span>
<a id="__codelineno-4-83" name="__codelineno-4-83" href="#__codelineno-4-83"></a>
<a id="__codelineno-4-84" name="__codelineno-4-84" href="#__codelineno-4-84"></a>                <span class="c1"># --- Market Info ---</span>
<a id="__codelineno-4-85" name="__codelineno-4-85" href="#__codelineno-4-85"></a>                <span class="n">market_data</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-4-86" name="__codelineno-4-86" href="#__codelineno-4-86"></a>                    <span class="s1">&#39;market_id&#39;</span><span class="p">:</span> <span class="n">market_book</span><span class="o">.</span><span class="n">market_id</span><span class="p">,</span>
<a id="__codelineno-4-87" name="__codelineno-4-87" href="#__codelineno-4-87"></a>                    <span class="s1">&#39;market_name&#39;</span><span class="p">:</span> <span class="n">market</span><span class="o">.</span><span class="n">market_catalogue</span><span class="o">.</span><span class="n">market_name</span><span class="p">,</span>
<a id="__codelineno-4-88" name="__codelineno-4-88" href="#__codelineno-4-88"></a>                    <span class="s1">&#39;total_runners&#39;</span><span class="p">:</span> <span class="n">market_book</span><span class="o">.</span><span class="n">number_of_runners</span><span class="p">,</span>
<a id="__codelineno-4-89" name="__codelineno-4-89" href="#__codelineno-4-89"></a>                    <span class="s1">&#39;number_of_winners&#39;</span><span class="p">:</span> <span class="n">market_book</span><span class="o">.</span><span class="n">number_of_winners</span><span class="p">,</span>
<a id="__codelineno-4-90" name="__codelineno-4-90" href="#__codelineno-4-90"></a>                    <span class="s1">&#39;runners_voidable&#39;</span><span class="p">:</span> <span class="n">market_book</span><span class="o">.</span><span class="n">runners_voidable</span><span class="p">,</span>
<a id="__codelineno-4-91" name="__codelineno-4-91" href="#__codelineno-4-91"></a>                    <span class="s1">&#39;bsp_market&#39;</span><span class="p">:</span> <span class="n">market</span><span class="o">.</span><span class="n">market_catalogue</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">bsp_market</span><span class="p">,</span>
<a id="__codelineno-4-92" name="__codelineno-4-92" href="#__codelineno-4-92"></a>                    <span class="s1">&#39;clarifications&#39;</span><span class="p">:</span> <span class="n">market</span><span class="o">.</span><span class="n">market_catalogue</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">clarifications</span> <span class="k">if</span> <span class="n">market</span><span class="o">.</span><span class="n">market_catalogue</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">clarifications</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-4-93" name="__codelineno-4-93" href="#__codelineno-4-93"></a>                    <span class="s1">&#39;market_base_rate&#39;</span><span class="p">:</span> <span class="n">market</span><span class="o">.</span><span class="n">market_catalogue</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">market_base_rate</span><span class="p">,</span>
<a id="__codelineno-4-94" name="__codelineno-4-94" href="#__codelineno-4-94"></a>                    <span class="s1">&#39;market_time&#39;</span><span class="p">:</span> <span class="n">pytz</span><span class="o">.</span><span class="n">utc</span><span class="o">.</span><span class="n">localize</span><span class="p">(</span><span class="n">market</span><span class="o">.</span><span class="n">market_catalogue</span><span class="o">.</span><span class="n">market_start_time</span><span class="p">)</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">pytz</span><span class="o">.</span><span class="n">timezone</span><span class="p">(</span><span class="n">market</span><span class="o">.</span><span class="n">market_catalogue</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">time_zone</span><span class="p">))</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">-%m-%y %H:%M:%S&quot;</span><span class="p">),</span>
<a id="__codelineno-4-95" name="__codelineno-4-95" href="#__codelineno-4-95"></a>                    <span class="s1">&#39;market_type&#39;</span><span class="p">:</span> <span class="n">market</span><span class="o">.</span><span class="n">market_catalogue</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">market_type</span><span class="p">,</span>
<a id="__codelineno-4-96" name="__codelineno-4-96" href="#__codelineno-4-96"></a>                    <span class="s1">&#39;inplay_market&#39;</span><span class="p">:</span> <span class="n">market</span><span class="o">.</span><span class="n">market_catalogue</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">turn_in_play_enabled</span><span class="p">,</span>
<a id="__codelineno-4-97" name="__codelineno-4-97" href="#__codelineno-4-97"></a>                    <span class="s1">&#39;race_type&#39;</span><span class="p">:</span> <span class="n">market</span><span class="o">.</span><span class="n">market_catalogue</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">race_type</span> <span class="k">if</span> <span class="n">market</span><span class="o">.</span><span class="n">market_catalogue</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">race_type</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-4-98" name="__codelineno-4-98" href="#__codelineno-4-98"></a>                <span class="p">}</span>
<a id="__codelineno-4-99" name="__codelineno-4-99" href="#__codelineno-4-99"></a>
<a id="__codelineno-4-100" name="__codelineno-4-100" href="#__codelineno-4-100"></a>                <span class="c1"># Combine event and market info into a one-row DataFrame</span>
<a id="__codelineno-4-101" name="__codelineno-4-101" href="#__codelineno-4-101"></a>                <span class="n">event_market_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([{</span><span class="o">**</span><span class="n">event_data</span><span class="p">,</span> <span class="o">**</span><span class="n">market_data</span><span class="p">}])</span>
<a id="__codelineno-4-102" name="__codelineno-4-102" href="#__codelineno-4-102"></a>
<a id="__codelineno-4-103" name="__codelineno-4-103" href="#__codelineno-4-103"></a>                <span class="c1"># Process runners</span>
<a id="__codelineno-4-104" name="__codelineno-4-104" href="#__codelineno-4-104"></a>                <span class="n">runners_df</span> <span class="o">=</span> <span class="n">process_runner_catalogue</span><span class="p">(</span><span class="n">market</span><span class="o">.</span><span class="n">market_catalogue</span><span class="o">.</span><span class="n">runners</span><span class="p">)</span>
<a id="__codelineno-4-105" name="__codelineno-4-105" href="#__codelineno-4-105"></a>
<a id="__codelineno-4-106" name="__codelineno-4-106" href="#__codelineno-4-106"></a>                <span class="c1"># Broadcast the event/market info across all runners (same length as runners_df)</span>
<a id="__codelineno-4-107" name="__codelineno-4-107" href="#__codelineno-4-107"></a>                <span class="n">repeated_info_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">event_market_df</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">runners_df</span><span class="p">),</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-4-108" name="__codelineno-4-108" href="#__codelineno-4-108"></a>
<a id="__codelineno-4-109" name="__codelineno-4-109" href="#__codelineno-4-109"></a>                <span class="c1"># Concatenate horizontally</span>
<a id="__codelineno-4-110" name="__codelineno-4-110" href="#__codelineno-4-110"></a>                <span class="n">market_dataframe</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">repeated_info_df</span><span class="p">,</span> <span class="n">runners_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-4-111" name="__codelineno-4-111" href="#__codelineno-4-111"></a>
<a id="__codelineno-4-112" name="__codelineno-4-112" href="#__codelineno-4-112"></a>                <span class="c1"># Extract values (only one expected)</span>
<a id="__codelineno-4-113" name="__codelineno-4-113" href="#__codelineno-4-113"></a>                <span class="n">country_code</span> <span class="o">=</span> <span class="n">market_dataframe</span><span class="p">[</span><span class="s1">&#39;event_country&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-4-114" name="__codelineno-4-114" href="#__codelineno-4-114"></a>                <span class="n">today_str</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-4-115" name="__codelineno-4-115" href="#__codelineno-4-115"></a>
<a id="__codelineno-4-116" name="__codelineno-4-116" href="#__codelineno-4-116"></a>                <span class="c1"># This safely avoids Key Errors</span>
<a id="__codelineno-4-117" name="__codelineno-4-117" href="#__codelineno-4-117"></a>                <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">METADATA_COLUMNS</span><span class="p">:</span>
<a id="__codelineno-4-118" name="__codelineno-4-118" href="#__codelineno-4-118"></a>                    <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">market_dataframe</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
<a id="__codelineno-4-119" name="__codelineno-4-119" href="#__codelineno-4-119"></a>                        <span class="n">market_dataframe</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-4-120" name="__codelineno-4-120" href="#__codelineno-4-120"></a>
<a id="__codelineno-4-121" name="__codelineno-4-121" href="#__codelineno-4-121"></a>                <span class="c1"># Define and write metadata dataframe (Metadata only available for Throughbred Racing)</span>
<a id="__codelineno-4-122" name="__codelineno-4-122" href="#__codelineno-4-122"></a>                <span class="k">if</span> <span class="n">market</span><span class="o">.</span><span class="n">event_type_id</span> <span class="o">==</span> <span class="s1">&#39;7&#39;</span> <span class="ow">and</span> <span class="n">market</span><span class="o">.</span><span class="n">market_catalogue</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">race_type</span> <span class="o">!=</span> <span class="s1">&#39;Harness&#39;</span> <span class="ow">and</span> <span class="n">market</span><span class="o">.</span><span class="n">market_type</span> <span class="o">==</span> <span class="s1">&#39;WIN&#39;</span><span class="p">:</span>
<a id="__codelineno-4-123" name="__codelineno-4-123" href="#__codelineno-4-123"></a>
<a id="__codelineno-4-124" name="__codelineno-4-124" href="#__codelineno-4-124"></a>                    <span class="n">metadata_dataframe</span> <span class="o">=</span> <span class="n">market_dataframe</span><span class="p">[</span><span class="n">METADATA_COLUMNS</span><span class="p">]</span>
<a id="__codelineno-4-125" name="__codelineno-4-125" href="#__codelineno-4-125"></a>
<a id="__codelineno-4-126" name="__codelineno-4-126" href="#__codelineno-4-126"></a>                    <span class="n">metadata_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;metadata-</span><span class="si">{</span><span class="n">country_code</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">today_str</span><span class="si">}</span><span class="s2">.csv&quot;</span>
<a id="__codelineno-4-127" name="__codelineno-4-127" href="#__codelineno-4-127"></a>                    <span class="n">file_exists</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">metadata_filename</span><span class="p">)</span>
<a id="__codelineno-4-128" name="__codelineno-4-128" href="#__codelineno-4-128"></a>
<a id="__codelineno-4-129" name="__codelineno-4-129" href="#__codelineno-4-129"></a>                    <span class="n">metadata_dataframe</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span>
<a id="__codelineno-4-130" name="__codelineno-4-130" href="#__codelineno-4-130"></a>                        <span class="n">metadata_filename</span><span class="p">,</span>
<a id="__codelineno-4-131" name="__codelineno-4-131" href="#__codelineno-4-131"></a>                        <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">,</span>
<a id="__codelineno-4-132" name="__codelineno-4-132" href="#__codelineno-4-132"></a>                        <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-4-133" name="__codelineno-4-133" href="#__codelineno-4-133"></a>                        <span class="n">header</span><span class="o">=</span><span class="ow">not</span> <span class="n">file_exists</span>
<a id="__codelineno-4-134" name="__codelineno-4-134" href="#__codelineno-4-134"></a>                    <span class="p">)</span>
<a id="__codelineno-4-135" name="__codelineno-4-135" href="#__codelineno-4-135"></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved Runner Metadata Info for </span><span class="si">{</span><span class="n">market</span><span class="o">.</span><span class="n">venue</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">market</span><span class="o">.</span><span class="n">market_catalogue</span><span class="o">.</span><span class="n">market_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-4-136" name="__codelineno-4-136" href="#__codelineno-4-136"></a>
<a id="__codelineno-4-137" name="__codelineno-4-137" href="#__codelineno-4-137"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">market_info_gathered</span><span class="p">[</span><span class="n">market</span><span class="o">.</span><span class="n">market_id</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-4-138" name="__codelineno-4-138" href="#__codelineno-4-138"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">dataframe_dict</span><span class="p">[</span><span class="n">market</span><span class="o">.</span><span class="n">market_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">market_dataframe</span>
<a id="__codelineno-4-139" name="__codelineno-4-139" href="#__codelineno-4-139"></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Added Market Data for </span><span class="si">{</span><span class="n">market</span><span class="o">.</span><span class="n">venue</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">market</span><span class="o">.</span><span class="n">market_catalogue</span><span class="o">.</span><span class="n">market_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-4-140" name="__codelineno-4-140" href="#__codelineno-4-140"></a>
<a id="__codelineno-4-141" name="__codelineno-4-141" href="#__codelineno-4-141"></a>        <span class="c1"># --- MARKET_BOOK INFO AT SCHEDULED OFF TIME ---</span>
<a id="__codelineno-4-142" name="__codelineno-4-142" href="#__codelineno-4-142"></a>        <span class="k">if</span> <span class="n">market</span><span class="o">.</span><span class="n">market_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scheduled_off_info_gathered</span> <span class="ow">and</span> <span class="p">(</span><span class="n">market</span><span class="o">.</span><span class="n">seconds_to_start</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">market_book</span><span class="o">.</span><span class="n">bsp_reconciled</span> <span class="o">==</span> <span class="kc">True</span><span class="p">):</span>
<a id="__codelineno-4-143" name="__codelineno-4-143" href="#__codelineno-4-143"></a>
<a id="__codelineno-4-144" name="__codelineno-4-144" href="#__codelineno-4-144"></a>            <span class="n">runners_at_scheduled_off</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-4-145" name="__codelineno-4-145" href="#__codelineno-4-145"></a>
<a id="__codelineno-4-146" name="__codelineno-4-146" href="#__codelineno-4-146"></a>            <span class="k">for</span> <span class="n">runner</span> <span class="ow">in</span> <span class="n">market_book</span><span class="o">.</span><span class="n">runners</span><span class="p">:</span>
<a id="__codelineno-4-147" name="__codelineno-4-147" href="#__codelineno-4-147"></a>
<a id="__codelineno-4-148" name="__codelineno-4-148" href="#__codelineno-4-148"></a>                <span class="n">runner_data</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-4-149" name="__codelineno-4-149" href="#__codelineno-4-149"></a>                    <span class="s1">&#39;selection_id&#39;</span><span class="p">:</span> <span class="n">runner</span><span class="o">.</span><span class="n">selection_id</span><span class="p">,</span>
<a id="__codelineno-4-150" name="__codelineno-4-150" href="#__codelineno-4-150"></a>                    <span class="s1">&#39;runner_removal_date&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">pytz</span><span class="o">.</span><span class="n">utc</span><span class="o">.</span><span class="n">localize</span><span class="p">(</span><span class="n">runner</span><span class="o">.</span><span class="n">removal_date</span><span class="p">)</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">pytz</span><span class="o">.</span><span class="n">timezone</span><span class="p">(</span><span class="n">market</span><span class="o">.</span><span class="n">market_catalogue</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">time_zone</span><span class="p">))</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">-%m-%y %H:%M:%S&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">runner</span><span class="o">.</span><span class="n">removal_date</span> <span class="k">else</span> <span class="kc">None</span><span class="p">),</span>
<a id="__codelineno-4-151" name="__codelineno-4-151" href="#__codelineno-4-151"></a>                    <span class="s1">&#39;runner_adjustment_factor&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">runner</span><span class="o">.</span><span class="n">adjustment_factor</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="k">if</span> <span class="n">runner</span><span class="o">.</span><span class="n">adjustment_factor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-4-152" name="__codelineno-4-152" href="#__codelineno-4-152"></a>                    <span class="s1">&#39;runner_traded_before_scheduled_off&#39;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">ps</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">ps</span> <span class="ow">in</span> <span class="n">runner</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">traded_volume</span><span class="p">)</span> <span class="k">if</span> <span class="n">runner</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">traded_volume</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-4-153" name="__codelineno-4-153" href="#__codelineno-4-153"></a>                    <span class="s1">&#39;runner_max_price_traded_before_scheduled_off&#39;</span><span class="p">:</span> <span class="nb">max</span><span class="p">(</span><span class="n">ps</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">ps</span> <span class="ow">in</span> <span class="n">runner</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">traded_volume</span><span class="p">)</span> <span class="k">if</span> <span class="n">runner</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">traded_volume</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-4-154" name="__codelineno-4-154" href="#__codelineno-4-154"></a>                    <span class="s1">&#39;runner_min_price_traded_before_scheduled_off&#39;</span><span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">ps</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">ps</span> <span class="ow">in</span> <span class="n">runner</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">traded_volume</span><span class="p">)</span> <span class="k">if</span> <span class="n">runner</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">traded_volume</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-4-155" name="__codelineno-4-155" href="#__codelineno-4-155"></a>                    <span class="s1">&#39;runner_wap_traded_before_scheduled_off&#39;</span><span class="p">:</span> <span class="p">(</span>
<a id="__codelineno-4-156" name="__codelineno-4-156" href="#__codelineno-4-156"></a>                        <span class="nb">round</span><span class="p">(</span>
<a id="__codelineno-4-157" name="__codelineno-4-157" href="#__codelineno-4-157"></a>                            <span class="nb">sum</span><span class="p">(</span><span class="n">ps</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">ps</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">ps</span> <span class="ow">in</span> <span class="n">runner</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">traded_volume</span> <span class="k">if</span> <span class="n">ps</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">ps</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="o">/</span>
<a id="__codelineno-4-158" name="__codelineno-4-158" href="#__codelineno-4-158"></a>                            <span class="nb">sum</span><span class="p">(</span><span class="n">ps</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">ps</span> <span class="ow">in</span> <span class="n">runner</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">traded_volume</span> <span class="k">if</span> <span class="n">ps</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">),</span>
<a id="__codelineno-4-159" name="__codelineno-4-159" href="#__codelineno-4-159"></a>                            <span class="mi">2</span>
<a id="__codelineno-4-160" name="__codelineno-4-160" href="#__codelineno-4-160"></a>                        <span class="p">)</span>
<a id="__codelineno-4-161" name="__codelineno-4-161" href="#__codelineno-4-161"></a>                        <span class="k">if</span> <span class="n">runner</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">traded_volume</span> <span class="ow">and</span> <span class="nb">sum</span><span class="p">(</span><span class="n">ps</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">ps</span> <span class="ow">in</span> <span class="n">runner</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">traded_volume</span> <span class="k">if</span> <span class="n">ps</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
<a id="__codelineno-4-162" name="__codelineno-4-162" href="#__codelineno-4-162"></a>                        <span class="k">else</span> <span class="kc">None</span>
<a id="__codelineno-4-163" name="__codelineno-4-163" href="#__codelineno-4-163"></a>                    <span class="p">),</span>
<a id="__codelineno-4-164" name="__codelineno-4-164" href="#__codelineno-4-164"></a>                    <span class="s1">&#39;runner_ltp_at_scheduled_off&#39;</span><span class="p">:</span> <span class="n">runner</span><span class="o">.</span><span class="n">last_price_traded</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-4-165" name="__codelineno-4-165" href="#__codelineno-4-165"></a>                    <span class="s1">&#39;runner_batb_at_scheduled_off&#39;</span><span class="p">:</span> <span class="p">[(</span><span class="n">o</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">],</span> <span class="n">o</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">runner</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">available_to_back</span><span class="p">]</span> <span class="k">if</span> <span class="n">runner</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">available_to_back</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-4-166" name="__codelineno-4-166" href="#__codelineno-4-166"></a>                    <span class="s1">&#39;runner_batl_at_scheduled_off&#39;</span><span class="p">:</span> <span class="p">[(</span><span class="n">o</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">],</span> <span class="n">o</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">runner</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">available_to_lay</span><span class="p">]</span> <span class="k">if</span> <span class="n">runner</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">available_to_lay</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-4-167" name="__codelineno-4-167" href="#__codelineno-4-167"></a>                    <span class="s1">&#39;runner_sp_back_available_at_scheduled_off&#39;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">ps</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">ps</span> <span class="ow">in</span> <span class="n">runner</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">back_stake_taken</span><span class="p">)</span> <span class="k">if</span> <span class="n">runner</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">back_stake_taken</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-4-168" name="__codelineno-4-168" href="#__codelineno-4-168"></a>                    <span class="s1">&#39;runner_sp_lay_available_at_scheduled_off&#39;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">ps</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">ps</span> <span class="ow">in</span> <span class="n">runner</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">lay_liability_taken</span><span class="p">)</span> <span class="k">if</span> <span class="n">runner</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">lay_liability_taken</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-4-169" name="__codelineno-4-169" href="#__codelineno-4-169"></a>                    <span class="s1">&#39;runner_spf_at_scheduled_off&#39;</span><span class="p">:</span> <span class="n">runner</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">far_price</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-4-170" name="__codelineno-4-170" href="#__codelineno-4-170"></a>                    <span class="s1">&#39;runner_spn_at_scheduled_off&#39;</span><span class="p">:</span> <span class="n">runner</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">near_price</span> <span class="ow">or</span> <span class="kc">None</span>
<a id="__codelineno-4-171" name="__codelineno-4-171" href="#__codelineno-4-171"></a>                <span class="p">}</span>
<a id="__codelineno-4-172" name="__codelineno-4-172" href="#__codelineno-4-172"></a>                <span class="n">runners_at_scheduled_off</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">runner_data</span><span class="p">)</span>
<a id="__codelineno-4-173" name="__codelineno-4-173" href="#__codelineno-4-173"></a>
<a id="__codelineno-4-174" name="__codelineno-4-174" href="#__codelineno-4-174"></a>            <span class="n">runners_at_scheduled_off_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">runners_at_scheduled_off</span><span class="p">)</span>
<a id="__codelineno-4-175" name="__codelineno-4-175" href="#__codelineno-4-175"></a>            <span class="n">market_dataframe</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">market_dataframe</span><span class="p">,</span><span class="n">runners_at_scheduled_off_df</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span><span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;selection_id&#39;</span><span class="p">],</span><span class="n">suffixes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;_x&#39;</span><span class="p">])</span>
<a id="__codelineno-4-176" name="__codelineno-4-176" href="#__codelineno-4-176"></a>
<a id="__codelineno-4-177" name="__codelineno-4-177" href="#__codelineno-4-177"></a>            <span class="c1"># Set dict to true and reassign dataframe</span>
<a id="__codelineno-4-178" name="__codelineno-4-178" href="#__codelineno-4-178"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">scheduled_off_info_gathered</span><span class="p">[</span><span class="n">market</span><span class="o">.</span><span class="n">market_id</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-4-179" name="__codelineno-4-179" href="#__codelineno-4-179"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dataframe_dict</span><span class="p">[</span><span class="n">market</span><span class="o">.</span><span class="n">market_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">market_dataframe</span>
<a id="__codelineno-4-180" name="__codelineno-4-180" href="#__codelineno-4-180"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Added Market Book Info at Scheduled Off for </span><span class="si">{</span><span class="n">market</span><span class="o">.</span><span class="n">venue</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">market</span><span class="o">.</span><span class="n">market_catalogue</span><span class="o">.</span><span class="n">market_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-4-181" name="__codelineno-4-181" href="#__codelineno-4-181"></a>
<a id="__codelineno-4-182" name="__codelineno-4-182" href="#__codelineno-4-182"></a>        <span class="c1"># --- BSP RECONCILIATION INFO ---</span>
<a id="__codelineno-4-183" name="__codelineno-4-183" href="#__codelineno-4-183"></a>        <span class="k">if</span> <span class="n">market</span><span class="o">.</span><span class="n">market_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bsp_info_gathered</span> <span class="ow">and</span> <span class="n">market_book</span><span class="o">.</span><span class="n">bsp_reconciled</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
<a id="__codelineno-4-184" name="__codelineno-4-184" href="#__codelineno-4-184"></a>
<a id="__codelineno-4-185" name="__codelineno-4-185" href="#__codelineno-4-185"></a>            <span class="n">bsp_reconciled</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-4-186" name="__codelineno-4-186" href="#__codelineno-4-186"></a>
<a id="__codelineno-4-187" name="__codelineno-4-187" href="#__codelineno-4-187"></a>            <span class="k">for</span> <span class="n">runner</span> <span class="ow">in</span> <span class="n">market_book</span><span class="o">.</span><span class="n">runners</span><span class="p">:</span>
<a id="__codelineno-4-188" name="__codelineno-4-188" href="#__codelineno-4-188"></a>
<a id="__codelineno-4-189" name="__codelineno-4-189" href="#__codelineno-4-189"></a>                <span class="n">runner_data</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-4-190" name="__codelineno-4-190" href="#__codelineno-4-190"></a>                    <span class="s1">&#39;selection_id&#39;</span><span class="p">:</span> <span class="n">runner</span><span class="o">.</span><span class="n">selection_id</span><span class="p">,</span>
<a id="__codelineno-4-191" name="__codelineno-4-191" href="#__codelineno-4-191"></a>                    <span class="s1">&#39;inplay_time_local&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">pytz</span><span class="o">.</span><span class="n">timezone</span><span class="p">(</span><span class="n">market</span><span class="o">.</span><span class="n">market_catalogue</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">time_zone</span><span class="p">))</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">),</span>
<a id="__codelineno-4-192" name="__codelineno-4-192" href="#__codelineno-4-192"></a>                    <span class="s1">&#39;runner_bsp&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">runner</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">actual_sp</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="k">if</span> <span class="n">runner</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">actual_sp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-4-193" name="__codelineno-4-193" href="#__codelineno-4-193"></a>                    <span class="s1">&#39;runner_sp_traded&#39;</span><span class="p">:</span> <span class="n">runner</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">back_stake_taken</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;size&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">runner</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">back_stake_taken</span> <span class="k">else</span> <span class="kc">None</span>
<a id="__codelineno-4-194" name="__codelineno-4-194" href="#__codelineno-4-194"></a>                <span class="p">}</span>
<a id="__codelineno-4-195" name="__codelineno-4-195" href="#__codelineno-4-195"></a>                <span class="n">bsp_reconciled</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">runner_data</span><span class="p">)</span>
<a id="__codelineno-4-196" name="__codelineno-4-196" href="#__codelineno-4-196"></a>
<a id="__codelineno-4-197" name="__codelineno-4-197" href="#__codelineno-4-197"></a>            <span class="n">bsp_reconciled_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">bsp_reconciled</span><span class="p">)</span>
<a id="__codelineno-4-198" name="__codelineno-4-198" href="#__codelineno-4-198"></a>            <span class="n">market_dataframe</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">market_dataframe</span><span class="p">,</span><span class="n">bsp_reconciled_df</span><span class="p">,</span><span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span><span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;selection_id&#39;</span><span class="p">],</span><span class="n">suffixes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;_x&#39;</span><span class="p">])</span>
<a id="__codelineno-4-199" name="__codelineno-4-199" href="#__codelineno-4-199"></a>
<a id="__codelineno-4-200" name="__codelineno-4-200" href="#__codelineno-4-200"></a>            <span class="c1"># Set dict to true and reassign dataframe</span>
<a id="__codelineno-4-201" name="__codelineno-4-201" href="#__codelineno-4-201"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">bsp_info_gathered</span><span class="p">[</span><span class="n">market</span><span class="o">.</span><span class="n">market_id</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-4-202" name="__codelineno-4-202" href="#__codelineno-4-202"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dataframe_dict</span><span class="p">[</span><span class="n">market</span><span class="o">.</span><span class="n">market_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">market_dataframe</span>
<a id="__codelineno-4-203" name="__codelineno-4-203" href="#__codelineno-4-203"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Added BSP Info for </span><span class="si">{</span><span class="n">market</span><span class="o">.</span><span class="n">venue</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">market</span><span class="o">.</span><span class="n">market_catalogue</span><span class="o">.</span><span class="n">market_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-4-204" name="__codelineno-4-204" href="#__codelineno-4-204"></a>
<a id="__codelineno-4-205" name="__codelineno-4-205" href="#__codelineno-4-205"></a>        <span class="c1"># --- MARKET_BOOK INFO AT SUSPENSION BEFORE MARKET CLOSURE</span>
<a id="__codelineno-4-206" name="__codelineno-4-206" href="#__codelineno-4-206"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">market</span><span class="o">.</span><span class="n">market_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_volume_info_gathered</span> <span class="ow">and</span> 
<a id="__codelineno-4-207" name="__codelineno-4-207" href="#__codelineno-4-207"></a>            <span class="n">market_book</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;SUSPENDED&#39;</span> <span class="ow">and</span> 
<a id="__codelineno-4-208" name="__codelineno-4-208" href="#__codelineno-4-208"></a>            <span class="p">((</span><span class="n">market_book</span><span class="o">.</span><span class="n">bsp_reconciled</span> <span class="o">==</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">market_book</span><span class="o">.</span><span class="n">inplay</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span> <span class="ow">or</span> 
<a id="__codelineno-4-209" name="__codelineno-4-209" href="#__codelineno-4-209"></a>            <span class="p">(</span><span class="n">market_book</span><span class="o">.</span><span class="n">bsp_reconciled</span> <span class="o">==</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">market</span><span class="o">.</span><span class="n">market_catalogue</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">turn_in_play_enabled</span> <span class="o">==</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">or</span> 
<a id="__codelineno-4-210" name="__codelineno-4-210" href="#__codelineno-4-210"></a>            <span class="p">(</span><span class="n">market_book</span><span class="o">.</span><span class="n">inplay</span> <span class="o">==</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">market</span><span class="o">.</span><span class="n">market_catalogue</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">bsp_market</span> <span class="o">==</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">or</span> 
<a id="__codelineno-4-211" name="__codelineno-4-211" href="#__codelineno-4-211"></a>            <span class="p">(</span><span class="n">market</span><span class="o">.</span><span class="n">market_catalogue</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">turn_in_play_enabled</span> <span class="o">==</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">market</span><span class="o">.</span><span class="n">market_catalogue</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">bsp_market</span> <span class="o">==</span> <span class="kc">False</span><span class="p">))):</span>
<a id="__codelineno-4-212" name="__codelineno-4-212" href="#__codelineno-4-212"></a>
<a id="__codelineno-4-213" name="__codelineno-4-213" href="#__codelineno-4-213"></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<a id="__codelineno-4-214" name="__codelineno-4-214" href="#__codelineno-4-214"></a><span class="sd">        This set of conditions is rather convoluted but is designed as an exhaustive list of conditions that indicate that no further bets can be placed on a market</span>
<a id="__codelineno-4-215" name="__codelineno-4-215" href="#__codelineno-4-215"></a><span class="sd">        For this, the market must be suspended AND:</span>
<a id="__codelineno-4-216" name="__codelineno-4-216" href="#__codelineno-4-216"></a>
<a id="__codelineno-4-217" name="__codelineno-4-217" href="#__codelineno-4-217"></a><span class="sd">         - Market has BSP reconciled and is inplay; OR</span>
<a id="__codelineno-4-218" name="__codelineno-4-218" href="#__codelineno-4-218"></a><span class="sd">         - Market has BSP reconciled and does not go inplay; OR</span>
<a id="__codelineno-4-219" name="__codelineno-4-219" href="#__codelineno-4-219"></a><span class="sd">         - Market does not offer BSP and is inplay: OR</span>
<a id="__codelineno-4-220" name="__codelineno-4-220" href="#__codelineno-4-220"></a><span class="sd">         - Market does not offer BSP and does not go inplay</span>
<a id="__codelineno-4-221" name="__codelineno-4-221" href="#__codelineno-4-221"></a><span class="sd">        &#39;&#39;&#39;</span>
<a id="__codelineno-4-222" name="__codelineno-4-222" href="#__codelineno-4-222"></a>
<a id="__codelineno-4-223" name="__codelineno-4-223" href="#__codelineno-4-223"></a>            <span class="n">final_pricing_info</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-4-224" name="__codelineno-4-224" href="#__codelineno-4-224"></a>
<a id="__codelineno-4-225" name="__codelineno-4-225" href="#__codelineno-4-225"></a>            <span class="k">for</span> <span class="n">runner</span> <span class="ow">in</span> <span class="n">market_book</span><span class="o">.</span><span class="n">runners</span><span class="p">:</span>
<a id="__codelineno-4-226" name="__codelineno-4-226" href="#__codelineno-4-226"></a>
<a id="__codelineno-4-227" name="__codelineno-4-227" href="#__codelineno-4-227"></a>                <span class="n">runner_data</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-4-228" name="__codelineno-4-228" href="#__codelineno-4-228"></a>                    <span class="s1">&#39;selection_id&#39;</span><span class="p">:</span> <span class="n">runner</span><span class="o">.</span><span class="n">selection_id</span><span class="p">,</span>
<a id="__codelineno-4-229" name="__codelineno-4-229" href="#__codelineno-4-229"></a>                    <span class="s1">&#39;runner_traded_volume_total&#39;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">ps</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">ps</span> <span class="ow">in</span> <span class="n">runner</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">traded_volume</span><span class="p">)</span> <span class="k">if</span> <span class="n">runner</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">traded_volume</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-4-230" name="__codelineno-4-230" href="#__codelineno-4-230"></a>                    <span class="s1">&#39;runner_max_price_total&#39;</span><span class="p">:</span> <span class="nb">max</span><span class="p">(</span><span class="n">ps</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">ps</span> <span class="ow">in</span> <span class="n">runner</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">traded_volume</span><span class="p">)</span> <span class="k">if</span> <span class="n">runner</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">traded_volume</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-4-231" name="__codelineno-4-231" href="#__codelineno-4-231"></a>                    <span class="s1">&#39;runner_min_price_total&#39;</span><span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">ps</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">ps</span> <span class="ow">in</span> <span class="n">runner</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">traded_volume</span><span class="p">)</span> <span class="k">if</span> <span class="n">runner</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">traded_volume</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-4-232" name="__codelineno-4-232" href="#__codelineno-4-232"></a>                    <span class="s1">&#39;runner_wap_traded_total&#39;</span><span class="p">:</span> <span class="p">(</span>
<a id="__codelineno-4-233" name="__codelineno-4-233" href="#__codelineno-4-233"></a>                        <span class="nb">round</span><span class="p">(</span>
<a id="__codelineno-4-234" name="__codelineno-4-234" href="#__codelineno-4-234"></a>                            <span class="nb">sum</span><span class="p">(</span><span class="n">ps</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">ps</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">ps</span> <span class="ow">in</span> <span class="n">runner</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">traded_volume</span> <span class="k">if</span> <span class="n">ps</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">ps</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-4-235" name="__codelineno-4-235" href="#__codelineno-4-235"></a>                            <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="n">ps</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">ps</span> <span class="ow">in</span> <span class="n">runner</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">traded_volume</span> <span class="k">if</span> <span class="n">ps</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">),</span> <span class="mi">2</span>
<a id="__codelineno-4-236" name="__codelineno-4-236" href="#__codelineno-4-236"></a>                        <span class="p">)</span>
<a id="__codelineno-4-237" name="__codelineno-4-237" href="#__codelineno-4-237"></a>                        <span class="k">if</span> <span class="n">runner</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">traded_volume</span> <span class="ow">and</span> <span class="nb">sum</span><span class="p">(</span><span class="n">ps</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">ps</span> <span class="ow">in</span> <span class="n">runner</span><span class="o">.</span><span class="n">ex</span><span class="o">.</span><span class="n">traded_volume</span> <span class="k">if</span> <span class="n">ps</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
<a id="__codelineno-4-238" name="__codelineno-4-238" href="#__codelineno-4-238"></a>                        <span class="k">else</span> <span class="kc">None</span>
<a id="__codelineno-4-239" name="__codelineno-4-239" href="#__codelineno-4-239"></a>                    <span class="p">),</span>
<a id="__codelineno-4-240" name="__codelineno-4-240" href="#__codelineno-4-240"></a>                    <span class="s1">&#39;runner_final_traded_price&#39;</span><span class="p">:</span> <span class="n">runner</span><span class="o">.</span><span class="n">last_price_traded</span> <span class="ow">or</span> <span class="kc">None</span>
<a id="__codelineno-4-241" name="__codelineno-4-241" href="#__codelineno-4-241"></a>                <span class="p">}</span>
<a id="__codelineno-4-242" name="__codelineno-4-242" href="#__codelineno-4-242"></a>                <span class="n">final_pricing_info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">runner_data</span><span class="p">)</span>
<a id="__codelineno-4-243" name="__codelineno-4-243" href="#__codelineno-4-243"></a>
<a id="__codelineno-4-244" name="__codelineno-4-244" href="#__codelineno-4-244"></a>            <span class="n">final_pricing_info_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">final_pricing_info</span><span class="p">)</span>
<a id="__codelineno-4-245" name="__codelineno-4-245" href="#__codelineno-4-245"></a>            <span class="n">market_dataframe</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">market_dataframe</span><span class="p">,</span><span class="n">final_pricing_info_df</span><span class="p">,</span><span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span><span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;selection_id&#39;</span><span class="p">],</span><span class="n">suffixes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;_x&#39;</span><span class="p">])</span>
<a id="__codelineno-4-246" name="__codelineno-4-246" href="#__codelineno-4-246"></a>
<a id="__codelineno-4-247" name="__codelineno-4-247" href="#__codelineno-4-247"></a>            <span class="c1"># Set dict to true and reassign dataframe</span>
<a id="__codelineno-4-248" name="__codelineno-4-248" href="#__codelineno-4-248"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">final_volume_info_gathered</span><span class="p">[</span><span class="n">market</span><span class="o">.</span><span class="n">market_id</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-4-249" name="__codelineno-4-249" href="#__codelineno-4-249"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">dataframe_dict</span><span class="p">[</span><span class="n">market</span><span class="o">.</span><span class="n">market_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">market_dataframe</span>
<a id="__codelineno-4-250" name="__codelineno-4-250" href="#__codelineno-4-250"></a>
<a id="__codelineno-4-251" name="__codelineno-4-251" href="#__codelineno-4-251"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Added Final Market Book Info for </span><span class="si">{</span><span class="n">market</span><span class="o">.</span><span class="n">venue</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">market</span><span class="o">.</span><span class="n">market_catalogue</span><span class="o">.</span><span class="n">market_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-4-252" name="__codelineno-4-252" href="#__codelineno-4-252"></a>
<a id="__codelineno-4-253" name="__codelineno-4-253" href="#__codelineno-4-253"></a><span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<a id="__codelineno-4-254" name="__codelineno-4-254" href="#__codelineno-4-254"></a><span class="sd">    The process_closed_market function is a base method in flumine that is usually very short.</span>
<a id="__codelineno-4-255" name="__codelineno-4-255" href="#__codelineno-4-255"></a><span class="sd">    However, we will customise it to record the market results and send our notifications to Discord</span>
<a id="__codelineno-4-256" name="__codelineno-4-256" href="#__codelineno-4-256"></a>
<a id="__codelineno-4-257" name="__codelineno-4-257" href="#__codelineno-4-257"></a><span class="sd">    The order of market settlement is not uniform, so there are checks in place to handle for any order of market settlement</span>
<a id="__codelineno-4-258" name="__codelineno-4-258" href="#__codelineno-4-258"></a><span class="sd">    Not all markets are required to deduce a placing either, we will wait until the minimum number of markets have been settled</span>
<a id="__codelineno-4-259" name="__codelineno-4-259" href="#__codelineno-4-259"></a><span class="sd">    before logging the results and sending the Discord alert</span>
<a id="__codelineno-4-260" name="__codelineno-4-260" href="#__codelineno-4-260"></a><span class="sd">    &#39;&#39;&#39;</span>
<a id="__codelineno-4-261" name="__codelineno-4-261" href="#__codelineno-4-261"></a>
<a id="__codelineno-4-262" name="__codelineno-4-262" href="#__codelineno-4-262"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">process_closed_market</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">market</span><span class="p">:</span> <span class="n">Market</span><span class="p">,</span> <span class="n">market_book</span><span class="p">:</span> <span class="n">MarketBook</span><span class="p">):</span>
<a id="__codelineno-4-263" name="__codelineno-4-263" href="#__codelineno-4-263"></a>
<a id="__codelineno-4-264" name="__codelineno-4-264" href="#__codelineno-4-264"></a>        <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">market</span><span class="o">.</span><span class="n">event_id</span><span class="p">,</span> <span class="n">market</span><span class="o">.</span><span class="n">market_start_datetime</span><span class="p">)</span>
<a id="__codelineno-4-265" name="__codelineno-4-265" href="#__codelineno-4-265"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">market_groups</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">{})</span>
<a id="__codelineno-4-266" name="__codelineno-4-266" href="#__codelineno-4-266"></a>
<a id="__codelineno-4-267" name="__codelineno-4-267" href="#__codelineno-4-267"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">market</span><span class="o">.</span><span class="n">market_catalogue</span><span class="p">:</span>
<a id="__codelineno-4-268" name="__codelineno-4-268" href="#__codelineno-4-268"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">market_results</span><span class="p">[</span><span class="n">market</span><span class="o">.</span><span class="n">market_id</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-4-269" name="__codelineno-4-269" href="#__codelineno-4-269"></a>            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">process_closed_market</span><span class="p">(</span><span class="n">market</span><span class="p">,</span> <span class="n">market_book</span><span class="p">)</span>
<a id="__codelineno-4-270" name="__codelineno-4-270" href="#__codelineno-4-270"></a>
<a id="__codelineno-4-271" name="__codelineno-4-271" href="#__codelineno-4-271"></a>        <span class="c1"># Flag market type as settled</span>
<a id="__codelineno-4-272" name="__codelineno-4-272" href="#__codelineno-4-272"></a>        <span class="n">market_type</span> <span class="o">=</span> <span class="n">market</span><span class="o">.</span><span class="n">market_type</span>
<a id="__codelineno-4-273" name="__codelineno-4-273" href="#__codelineno-4-273"></a>        <span class="n">num_winners</span> <span class="o">=</span> <span class="n">market_book</span><span class="o">.</span><span class="n">number_of_winners</span>
<a id="__codelineno-4-274" name="__codelineno-4-274" href="#__codelineno-4-274"></a>
<a id="__codelineno-4-275" name="__codelineno-4-275" href="#__codelineno-4-275"></a>        <span class="c1"># Check if market is voided first</span>
<a id="__codelineno-4-276" name="__codelineno-4-276" href="#__codelineno-4-276"></a>        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;REMOVED&quot;</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">market_book</span><span class="o">.</span><span class="n">runners</span><span class="p">):</span>
<a id="__codelineno-4-277" name="__codelineno-4-277" href="#__codelineno-4-277"></a>            <span class="n">send_market_void_alert</span><span class="p">(</span><span class="n">market</span><span class="p">,</span> <span class="n">market_book</span><span class="p">,</span> <span class="n">DISCORD_ALERTS_WEBHOOK</span><span class="p">)</span>
<a id="__codelineno-4-278" name="__codelineno-4-278" href="#__codelineno-4-278"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Market voided for </span><span class="si">{</span><span class="n">market</span><span class="o">.</span><span class="n">event_name</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">market</span><span class="o">.</span><span class="n">market_id</span><span class="si">}</span><span class="s2">. Alert sent.&quot;</span><span class="p">)</span>
<a id="__codelineno-4-279" name="__codelineno-4-279" href="#__codelineno-4-279"></a>            <span class="c1"># Be warned that if an entire meeting is abandoned, then a notification will be sent for every market for the event</span>
<a id="__codelineno-4-280" name="__codelineno-4-280" href="#__codelineno-4-280"></a>
<a id="__codelineno-4-281" name="__codelineno-4-281" href="#__codelineno-4-281"></a>            <span class="c1"># If the market is voided, we will set this market to None in our grouping function</span>
<a id="__codelineno-4-282" name="__codelineno-4-282" href="#__codelineno-4-282"></a>            <span class="c1"># This means that we won&#39;t wait for the market to be settled before logging results</span>
<a id="__codelineno-4-283" name="__codelineno-4-283" href="#__codelineno-4-283"></a>            <span class="c1"># Usually this will occur for Exactas/Quinellas in the case of a late scratching</span>
<a id="__codelineno-4-284" name="__codelineno-4-284" href="#__codelineno-4-284"></a>            <span class="k">if</span> <span class="n">market_type</span> <span class="o">==</span> <span class="s1">&#39;WIN&#39;</span><span class="p">:</span>
<a id="__codelineno-4-285" name="__codelineno-4-285" href="#__codelineno-4-285"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">market_groups</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;win_market_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-4-286" name="__codelineno-4-286" href="#__codelineno-4-286"></a>            <span class="k">elif</span> <span class="n">market_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;PLACE&#39;</span><span class="p">,</span> <span class="s1">&#39;OTHER_PLACE&#39;</span><span class="p">]:</span>
<a id="__codelineno-4-287" name="__codelineno-4-287" href="#__codelineno-4-287"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">market_groups</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">num_winners</span><span class="si">}</span><span class="s1">tbp_market_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-4-288" name="__codelineno-4-288" href="#__codelineno-4-288"></a>            <span class="k">elif</span> <span class="n">market_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;FORECAST&#39;</span><span class="p">,</span> <span class="s1">&#39;EXACTA&#39;</span><span class="p">]:</span>
<a id="__codelineno-4-289" name="__codelineno-4-289" href="#__codelineno-4-289"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">market_groups</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;exacta_market_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-4-290" name="__codelineno-4-290" href="#__codelineno-4-290"></a>            <span class="k">elif</span> <span class="n">market_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;REV_FORECAST&#39;</span><span class="p">,</span> <span class="s1">&#39;QUINELLA&#39;</span><span class="p">]:</span>
<a id="__codelineno-4-291" name="__codelineno-4-291" href="#__codelineno-4-291"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">market_groups</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;quinella_market_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-4-292" name="__codelineno-4-292" href="#__codelineno-4-292"></a>            <span class="k">return</span>
<a id="__codelineno-4-293" name="__codelineno-4-293" href="#__codelineno-4-293"></a>
<a id="__codelineno-4-294" name="__codelineno-4-294" href="#__codelineno-4-294"></a>        <span class="c1"># Fetch market dataframe and skip if the market is empty</span>
<a id="__codelineno-4-295" name="__codelineno-4-295" href="#__codelineno-4-295"></a>        <span class="n">market_dataframe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">market</span><span class="o">.</span><span class="n">market_id</span><span class="p">)</span>
<a id="__codelineno-4-296" name="__codelineno-4-296" href="#__codelineno-4-296"></a>        <span class="k">if</span> <span class="n">market_dataframe</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">market_dataframe</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
<a id="__codelineno-4-297" name="__codelineno-4-297" href="#__codelineno-4-297"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No data available for </span><span class="si">{</span><span class="n">market</span><span class="o">.</span><span class="n">event_name</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">market</span><span class="o">.</span><span class="n">market_id</span><span class="si">}</span><span class="s2">. Skipping.&quot;</span><span class="p">)</span>
<a id="__codelineno-4-298" name="__codelineno-4-298" href="#__codelineno-4-298"></a>            <span class="c1"># This usually only occurs on start-up </span>
<a id="__codelineno-4-299" name="__codelineno-4-299" href="#__codelineno-4-299"></a>            <span class="k">return</span>
<a id="__codelineno-4-300" name="__codelineno-4-300" href="#__codelineno-4-300"></a>
<a id="__codelineno-4-301" name="__codelineno-4-301" href="#__codelineno-4-301"></a>        <span class="c1"># Here we note which market type in the race group is settled</span>
<a id="__codelineno-4-302" name="__codelineno-4-302" href="#__codelineno-4-302"></a>        <span class="k">if</span> <span class="n">market_type</span> <span class="o">==</span> <span class="s1">&#39;WIN&#39;</span><span class="p">:</span>
<a id="__codelineno-4-303" name="__codelineno-4-303" href="#__codelineno-4-303"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">market_groups</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;win_settled&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-4-304" name="__codelineno-4-304" href="#__codelineno-4-304"></a>        <span class="k">elif</span> <span class="n">market_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;PLACE&#39;</span><span class="p">,</span> <span class="s1">&#39;OTHER_PLACE&#39;</span><span class="p">]:</span>
<a id="__codelineno-4-305" name="__codelineno-4-305" href="#__codelineno-4-305"></a>            <span class="k">if</span> <span class="n">num_winners</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
<a id="__codelineno-4-306" name="__codelineno-4-306" href="#__codelineno-4-306"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">market_groups</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;2tbp_settled&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-4-307" name="__codelineno-4-307" href="#__codelineno-4-307"></a>            <span class="k">elif</span> <span class="n">num_winners</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
<a id="__codelineno-4-308" name="__codelineno-4-308" href="#__codelineno-4-308"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">market_groups</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;3tbp_settled&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-4-309" name="__codelineno-4-309" href="#__codelineno-4-309"></a>            <span class="k">elif</span> <span class="n">num_winners</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
<a id="__codelineno-4-310" name="__codelineno-4-310" href="#__codelineno-4-310"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">market_groups</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;4tbp_settled&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-4-311" name="__codelineno-4-311" href="#__codelineno-4-311"></a>        <span class="k">elif</span> <span class="n">market_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;EXACTA&#39;</span><span class="p">,</span> <span class="s1">&#39;FORECAST&#39;</span><span class="p">]:</span>
<a id="__codelineno-4-312" name="__codelineno-4-312" href="#__codelineno-4-312"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">market_groups</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;exacta_settled&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-4-313" name="__codelineno-4-313" href="#__codelineno-4-313"></a>        <span class="k">elif</span> <span class="n">market_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;QUINELLA&#39;</span><span class="p">,</span> <span class="s1">&#39;REV_FORECAST&#39;</span><span class="p">]:</span>
<a id="__codelineno-4-314" name="__codelineno-4-314" href="#__codelineno-4-314"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">market_groups</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;quinella_settled&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-4-315" name="__codelineno-4-315" href="#__codelineno-4-315"></a>
<a id="__codelineno-4-316" name="__codelineno-4-316" href="#__codelineno-4-316"></a>        <span class="c1"># Add runner status</span>
<a id="__codelineno-4-317" name="__codelineno-4-317" href="#__codelineno-4-317"></a>        <span class="n">runner_status_map</span> <span class="o">=</span> <span class="p">{</span><span class="n">r</span><span class="o">.</span><span class="n">selection_id</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">status</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">market_book</span><span class="o">.</span><span class="n">runners</span><span class="p">}</span>
<a id="__codelineno-4-318" name="__codelineno-4-318" href="#__codelineno-4-318"></a>        <span class="n">market_dataframe</span><span class="p">[</span><span class="s2">&quot;runner_status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">market_dataframe</span><span class="p">[</span><span class="s2">&quot;selection_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">runner_status_map</span><span class="p">)</span>
<a id="__codelineno-4-319" name="__codelineno-4-319" href="#__codelineno-4-319"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">market</span><span class="o">.</span><span class="n">market_id</span><span class="si">}</span><span class="s2">] Added runner status for </span><span class="si">{</span><span class="n">market</span><span class="o">.</span><span class="n">venue</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">market</span><span class="o">.</span><span class="n">market_catalogue</span><span class="o">.</span><span class="n">market_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-4-320" name="__codelineno-4-320" href="#__codelineno-4-320"></a>
<a id="__codelineno-4-321" name="__codelineno-4-321" href="#__codelineno-4-321"></a>        <span class="c1"># Remap Removal Date for Late Scratchings</span>
<a id="__codelineno-4-322" name="__codelineno-4-322" href="#__codelineno-4-322"></a>        <span class="n">removal_date_map</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-4-323" name="__codelineno-4-323" href="#__codelineno-4-323"></a>        <span class="n">r</span><span class="o">.</span><span class="n">selection_id</span><span class="p">:</span> <span class="p">(</span><span class="n">pytz</span><span class="o">.</span><span class="n">utc</span><span class="o">.</span><span class="n">localize</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">removal_date</span><span class="p">)</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">pytz</span><span class="o">.</span><span class="n">timezone</span><span class="p">(</span><span class="n">market</span><span class="o">.</span><span class="n">market_catalogue</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">time_zone</span><span class="p">))</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">-%m-%y %H:%M:%S&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">removal_date</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">market_book</span><span class="o">.</span><span class="n">runners</span><span class="p">}</span>
<a id="__codelineno-4-324" name="__codelineno-4-324" href="#__codelineno-4-324"></a>        <span class="n">market_dataframe</span><span class="p">[</span><span class="s2">&quot;runner_removal_date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">market_dataframe</span><span class="p">[</span><span class="s2">&quot;selection_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">removal_date_map</span><span class="p">)</span>
<a id="__codelineno-4-325" name="__codelineno-4-325" href="#__codelineno-4-325"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">market</span><span class="o">.</span><span class="n">market_id</span><span class="si">}</span><span class="s2">] Processed any late scratchings for </span><span class="si">{</span><span class="n">market</span><span class="o">.</span><span class="n">venue</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">market</span><span class="o">.</span><span class="n">market_catalogue</span><span class="o">.</span><span class="n">market_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-4-326" name="__codelineno-4-326" href="#__codelineno-4-326"></a>
<a id="__codelineno-4-327" name="__codelineno-4-327" href="#__codelineno-4-327"></a>        <span class="c1"># Prepare output</span>
<a id="__codelineno-4-328" name="__codelineno-4-328" href="#__codelineno-4-328"></a>        <span class="n">country_code</span> <span class="o">=</span> <span class="n">market_dataframe</span><span class="p">[</span><span class="s1">&#39;event_country&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-4-329" name="__codelineno-4-329" href="#__codelineno-4-329"></a>        <span class="n">market_type_code</span> <span class="o">=</span> <span class="n">market_dataframe</span><span class="p">[</span><span class="s1">&#39;market_type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-4-330" name="__codelineno-4-330" href="#__codelineno-4-330"></a>        <span class="n">today_str</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">market_dataframe</span><span class="p">[</span><span class="s1">&#39;event_date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-4-331" name="__codelineno-4-331" href="#__codelineno-4-331"></a>        <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;results-</span><span class="si">{</span><span class="n">country_code</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">market_type_code</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">today_str</span><span class="si">}</span><span class="s2">.csv&quot;</span>
<a id="__codelineno-4-332" name="__codelineno-4-332" href="#__codelineno-4-332"></a>
<a id="__codelineno-4-333" name="__codelineno-4-333" href="#__codelineno-4-333"></a>        <span class="c1"># Ensure that all the correct columns are in the dataframe to prevent key errors</span>
<a id="__codelineno-4-334" name="__codelineno-4-334" href="#__codelineno-4-334"></a>        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">MARKET_COLUMNS</span><span class="p">:</span>
<a id="__codelineno-4-335" name="__codelineno-4-335" href="#__codelineno-4-335"></a>            <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">market_dataframe</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
<a id="__codelineno-4-336" name="__codelineno-4-336" href="#__codelineno-4-336"></a>                <span class="n">market_dataframe</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-4-337" name="__codelineno-4-337" href="#__codelineno-4-337"></a>
<a id="__codelineno-4-338" name="__codelineno-4-338" href="#__codelineno-4-338"></a>        <span class="c1"># Reorder the dataframe (and remove any double-up columns)</span>
<a id="__codelineno-4-339" name="__codelineno-4-339" href="#__codelineno-4-339"></a>        <span class="n">final_market_dataframe</span> <span class="o">=</span> <span class="n">market_dataframe</span><span class="p">[</span><span class="n">MARKET_COLUMNS</span><span class="p">]</span>
<a id="__codelineno-4-340" name="__codelineno-4-340" href="#__codelineno-4-340"></a>
<a id="__codelineno-4-341" name="__codelineno-4-341" href="#__codelineno-4-341"></a>        <span class="c1"># This can be triggered in the case of resettlements or other issues</span>
<a id="__codelineno-4-342" name="__codelineno-4-342" href="#__codelineno-4-342"></a>        <span class="n">time_since_start</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-</span> <span class="n">market</span><span class="o">.</span><span class="n">market_start_datetime</span><span class="p">)</span>
<a id="__codelineno-4-343" name="__codelineno-4-343" href="#__codelineno-4-343"></a>        <span class="k">if</span> <span class="n">time_since_start</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">3000</span><span class="p">:</span>
<a id="__codelineno-4-344" name="__codelineno-4-344" href="#__codelineno-4-344"></a>            <span class="n">save_market_csv</span><span class="p">(</span><span class="n">final_market_dataframe</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span> <span class="n">MARKET_COLUMNS</span><span class="p">)</span>
<a id="__codelineno-4-345" name="__codelineno-4-345" href="#__codelineno-4-345"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">market</span><span class="o">.</span><span class="n">market_id</span><span class="si">}</span><span class="s2">] Over 50m. Saved basic info for </span><span class="si">{</span><span class="n">market</span><span class="o">.</span><span class="n">venue</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-4-346" name="__codelineno-4-346" href="#__codelineno-4-346"></a>
<a id="__codelineno-4-347" name="__codelineno-4-347" href="#__codelineno-4-347"></a>        <span class="c1"># Now attempt to get placings</span>
<a id="__codelineno-4-348" name="__codelineno-4-348" href="#__codelineno-4-348"></a>        <span class="c1"># This where the magic happens, the whole function will be displayed further down</span>
<a id="__codelineno-4-349" name="__codelineno-4-349" href="#__codelineno-4-349"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-4-350" name="__codelineno-4-350" href="#__codelineno-4-350"></a>            <span class="n">placings_df</span> <span class="o">=</span> <span class="n">determine_placings</span><span class="p">(</span>
<a id="__codelineno-4-351" name="__codelineno-4-351" href="#__codelineno-4-351"></a>                <span class="n">market</span><span class="o">=</span><span class="n">market</span><span class="p">,</span>
<a id="__codelineno-4-352" name="__codelineno-4-352" href="#__codelineno-4-352"></a>                <span class="n">market_groups</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">market_groups</span><span class="p">,</span>
<a id="__codelineno-4-353" name="__codelineno-4-353" href="#__codelineno-4-353"></a>                <span class="n">dataframe_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dataframe_dict</span><span class="p">,</span>
<a id="__codelineno-4-354" name="__codelineno-4-354" href="#__codelineno-4-354"></a>                <span class="n">market_types</span><span class="o">=</span><span class="n">MARKET_TYPES</span>
<a id="__codelineno-4-355" name="__codelineno-4-355" href="#__codelineno-4-355"></a>            <span class="p">)</span>
<a id="__codelineno-4-356" name="__codelineno-4-356" href="#__codelineno-4-356"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-4-357" name="__codelineno-4-357" href="#__codelineno-4-357"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">market</span><span class="o">.</span><span class="n">market_id</span><span class="si">}</span><span class="s2">] Error determining placings: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-4-358" name="__codelineno-4-358" href="#__codelineno-4-358"></a>            <span class="n">placings_df</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-4-359" name="__codelineno-4-359" href="#__codelineno-4-359"></a>
<a id="__codelineno-4-360" name="__codelineno-4-360" href="#__codelineno-4-360"></a>        <span class="n">file_exists</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
<a id="__codelineno-4-361" name="__codelineno-4-361" href="#__codelineno-4-361"></a>
<a id="__codelineno-4-362" name="__codelineno-4-362" href="#__codelineno-4-362"></a>        <span class="c1"># Placings not available yet</span>
<a id="__codelineno-4-363" name="__codelineno-4-363" href="#__codelineno-4-363"></a>        <span class="k">if</span> <span class="n">placings_df</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">placings_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
<a id="__codelineno-4-364" name="__codelineno-4-364" href="#__codelineno-4-364"></a>            <span class="k">if</span> <span class="n">market_type</span> <span class="o">==</span> <span class="s1">&#39;WIN&#39;</span><span class="p">:</span>
<a id="__codelineno-4-365" name="__codelineno-4-365" href="#__codelineno-4-365"></a>                <span class="c1"># For WIN market with no placings, skip writing entirely</span>
<a id="__codelineno-4-366" name="__codelineno-4-366" href="#__codelineno-4-366"></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">market</span><span class="o">.</span><span class="n">market_id</span><span class="si">}</span><span class="s2">] WIN market placings not ready. Skipping write for </span><span class="si">{</span><span class="n">market</span><span class="o">.</span><span class="n">venue</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-4-367" name="__codelineno-4-367" href="#__codelineno-4-367"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-4-368" name="__codelineno-4-368" href="#__codelineno-4-368"></a>                <span class="c1"># Non-WIN market with no placings: save basic market info</span>
<a id="__codelineno-4-369" name="__codelineno-4-369" href="#__codelineno-4-369"></a>                <span class="n">save_market_csv</span><span class="p">(</span><span class="n">final_market_dataframe</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">file_exists</span><span class="p">,</span> <span class="n">MARKET_COLUMNS</span><span class="p">)</span>
<a id="__codelineno-4-370" name="__codelineno-4-370" href="#__codelineno-4-370"></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">market</span><span class="o">.</span><span class="n">market_id</span><span class="si">}</span><span class="s2">] Placings unavailable or empty. Saved basic info for </span><span class="si">{</span><span class="n">market</span><span class="o">.</span><span class="n">venue</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-4-371" name="__codelineno-4-371" href="#__codelineno-4-371"></a>
<a id="__codelineno-4-372" name="__codelineno-4-372" href="#__codelineno-4-372"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-4-373" name="__codelineno-4-373" href="#__codelineno-4-373"></a>            <span class="c1"># Placings available</span>
<a id="__codelineno-4-374" name="__codelineno-4-374" href="#__codelineno-4-374"></a>            <span class="k">if</span> <span class="n">market_type</span> <span class="o">==</span> <span class="s1">&#39;WIN&#39;</span><span class="p">:</span>
<a id="__codelineno-4-375" name="__codelineno-4-375" href="#__codelineno-4-375"></a>                <span class="n">final_market_dataframe</span> <span class="o">=</span> <span class="n">merge_place_into_win</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">market_groups</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe_dict</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">final_market_dataframe</span><span class="p">)</span>
<a id="__codelineno-4-376" name="__codelineno-4-376" href="#__codelineno-4-376"></a>                <span class="c1"># WIN market: save with placings, send alerts</span>
<a id="__codelineno-4-377" name="__codelineno-4-377" href="#__codelineno-4-377"></a>                <span class="n">win_market_df</span> <span class="o">=</span> <span class="n">save_with_placings</span><span class="p">(</span><span class="n">final_market_dataframe</span><span class="p">,</span> <span class="n">placings_df</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">file_exists</span><span class="p">,</span> <span class="n">MARKET_COLUMNS</span><span class="p">,</span> <span class="n">extra_cols</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;placing&#39;</span><span class="p">,</span><span class="s1">&#39;places_paid&#39;</span><span class="p">,</span><span class="s1">&#39;place_bsp&#39;</span><span class="p">])</span>
<a id="__codelineno-4-378" name="__codelineno-4-378" href="#__codelineno-4-378"></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">market</span><span class="o">.</span><span class="n">market_id</span><span class="si">}</span><span class="s2">] Saved WIN market info with placings for </span><span class="si">{</span><span class="n">market</span><span class="o">.</span><span class="n">venue</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-4-379" name="__codelineno-4-379" href="#__codelineno-4-379"></a>
<a id="__codelineno-4-380" name="__codelineno-4-380" href="#__codelineno-4-380"></a>                <span class="n">run_all_discord_alerts</span><span class="p">(</span><span class="n">win_market_df</span><span class="p">,</span> <span class="n">DISCORD_ALERTS_WEBHOOK</span><span class="p">)</span>
<a id="__codelineno-4-381" name="__codelineno-4-381" href="#__codelineno-4-381"></a>                <span class="n">discord_placings_report</span><span class="p">(</span>
<a id="__codelineno-4-382" name="__codelineno-4-382" href="#__codelineno-4-382"></a>                    <span class="n">win_market_df</span><span class="p">,</span>
<a id="__codelineno-4-383" name="__codelineno-4-383" href="#__codelineno-4-383"></a>                    <span class="n">DISCORD_WEBHOOKS</span><span class="p">[</span>
<a id="__codelineno-4-384" name="__codelineno-4-384" href="#__codelineno-4-384"></a>                        <span class="n">pick_webhook</span><span class="p">(</span>
<a id="__codelineno-4-385" name="__codelineno-4-385" href="#__codelineno-4-385"></a>                            <span class="n">market</span><span class="o">.</span><span class="n">market_catalogue</span><span class="o">.</span><span class="n">event_type</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-4-386" name="__codelineno-4-386" href="#__codelineno-4-386"></a>                            <span class="n">market</span><span class="o">.</span><span class="n">race_type</span><span class="p">,</span>
<a id="__codelineno-4-387" name="__codelineno-4-387" href="#__codelineno-4-387"></a>                            <span class="n">market</span><span class="o">.</span><span class="n">market_catalogue</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">country_code</span>
<a id="__codelineno-4-388" name="__codelineno-4-388" href="#__codelineno-4-388"></a>                        <span class="p">)</span>
<a id="__codelineno-4-389" name="__codelineno-4-389" href="#__codelineno-4-389"></a>                    <span class="p">]</span>
<a id="__codelineno-4-390" name="__codelineno-4-390" href="#__codelineno-4-390"></a>                <span class="p">)</span>
<a id="__codelineno-4-391" name="__codelineno-4-391" href="#__codelineno-4-391"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">win_markets_written</span><span class="p">[</span><span class="n">market</span><span class="o">.</span><span class="n">market_id</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-4-392" name="__codelineno-4-392" href="#__codelineno-4-392"></a>
<a id="__codelineno-4-393" name="__codelineno-4-393" href="#__codelineno-4-393"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-4-394" name="__codelineno-4-394" href="#__codelineno-4-394"></a>                <span class="c1"># Non-WIN market: check if WIN placings have been written</span>
<a id="__codelineno-4-395" name="__codelineno-4-395" href="#__codelineno-4-395"></a>                <span class="n">win_market_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">market_groups</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;win_market_id&#39;</span><span class="p">)</span>
<a id="__codelineno-4-396" name="__codelineno-4-396" href="#__codelineno-4-396"></a>
<a id="__codelineno-4-397" name="__codelineno-4-397" href="#__codelineno-4-397"></a>                <span class="k">if</span> <span class="p">(</span><span class="n">win_market_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">win_markets_written</span>
<a id="__codelineno-4-398" name="__codelineno-4-398" href="#__codelineno-4-398"></a>                    <span class="ow">and</span> <span class="n">win_market_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">market_results</span><span class="p">):</span>
<a id="__codelineno-4-399" name="__codelineno-4-399" href="#__codelineno-4-399"></a>
<a id="__codelineno-4-400" name="__codelineno-4-400" href="#__codelineno-4-400"></a>                    <span class="n">win_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;results-</span><span class="si">{</span><span class="n">country_code</span><span class="si">}</span><span class="s2">-WIN-</span><span class="si">{</span><span class="n">today_str</span><span class="si">}</span><span class="s2">.csv&quot;</span>
<a id="__codelineno-4-401" name="__codelineno-4-401" href="#__codelineno-4-401"></a>                    <span class="n">win_file_exists</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">win_filename</span><span class="p">)</span>
<a id="__codelineno-4-402" name="__codelineno-4-402" href="#__codelineno-4-402"></a>
<a id="__codelineno-4-403" name="__codelineno-4-403" href="#__codelineno-4-403"></a>                    <span class="n">win_market_df</span> <span class="o">=</span> <span class="n">merge_place_into_win</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">market_groups</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe_dict</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe_dict</span><span class="p">[</span><span class="n">win_market_id</span><span class="p">])</span>
<a id="__codelineno-4-404" name="__codelineno-4-404" href="#__codelineno-4-404"></a>
<a id="__codelineno-4-405" name="__codelineno-4-405" href="#__codelineno-4-405"></a>                    <span class="n">win_market_df</span> <span class="o">=</span> <span class="n">save_with_placings</span><span class="p">(</span>
<a id="__codelineno-4-406" name="__codelineno-4-406" href="#__codelineno-4-406"></a>                        <span class="n">win_market_df</span><span class="p">,</span>
<a id="__codelineno-4-407" name="__codelineno-4-407" href="#__codelineno-4-407"></a>                        <span class="n">placings_df</span><span class="p">,</span>
<a id="__codelineno-4-408" name="__codelineno-4-408" href="#__codelineno-4-408"></a>                        <span class="n">win_filename</span><span class="p">,</span>
<a id="__codelineno-4-409" name="__codelineno-4-409" href="#__codelineno-4-409"></a>                        <span class="n">win_file_exists</span><span class="p">,</span>
<a id="__codelineno-4-410" name="__codelineno-4-410" href="#__codelineno-4-410"></a>                        <span class="n">MARKET_COLUMNS</span><span class="p">,</span>
<a id="__codelineno-4-411" name="__codelineno-4-411" href="#__codelineno-4-411"></a>                        <span class="n">extra_cols</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;placing&#39;</span><span class="p">,</span><span class="s1">&#39;place_BSP&#39;</span><span class="p">]</span>
<a id="__codelineno-4-412" name="__codelineno-4-412" href="#__codelineno-4-412"></a>                    <span class="p">)</span>
<a id="__codelineno-4-413" name="__codelineno-4-413" href="#__codelineno-4-413"></a>                    <span class="n">save_market_csv</span><span class="p">(</span><span class="n">final_market_dataframe</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">file_exists</span><span class="p">,</span> <span class="n">MARKET_COLUMNS</span><span class="p">)</span>
<a id="__codelineno-4-414" name="__codelineno-4-414" href="#__codelineno-4-414"></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">market</span><span class="o">.</span><span class="n">market_id</span><span class="si">}</span><span class="s2">] Saved WIN market with placings and </span><span class="si">{</span><span class="n">market_type</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="n">market</span><span class="o">.</span><span class="n">venue</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-4-415" name="__codelineno-4-415" href="#__codelineno-4-415"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">win_markets_written</span><span class="p">[</span><span class="n">win_market_id</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-4-416" name="__codelineno-4-416" href="#__codelineno-4-416"></a>
<a id="__codelineno-4-417" name="__codelineno-4-417" href="#__codelineno-4-417"></a>                    <span class="n">run_all_discord_alerts</span><span class="p">(</span><span class="n">win_market_df</span><span class="p">,</span> <span class="n">DISCORD_ALERTS_WEBHOOK</span><span class="p">)</span>
<a id="__codelineno-4-418" name="__codelineno-4-418" href="#__codelineno-4-418"></a>                    <span class="n">discord_placings_report</span><span class="p">(</span>
<a id="__codelineno-4-419" name="__codelineno-4-419" href="#__codelineno-4-419"></a>                        <span class="n">win_market_df</span><span class="p">,</span>
<a id="__codelineno-4-420" name="__codelineno-4-420" href="#__codelineno-4-420"></a>                        <span class="n">DISCORD_WEBHOOKS</span><span class="p">[</span>
<a id="__codelineno-4-421" name="__codelineno-4-421" href="#__codelineno-4-421"></a>                            <span class="n">pick_webhook</span><span class="p">(</span>
<a id="__codelineno-4-422" name="__codelineno-4-422" href="#__codelineno-4-422"></a>                                <span class="n">market</span><span class="o">.</span><span class="n">market_catalogue</span><span class="o">.</span><span class="n">event_type</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-4-423" name="__codelineno-4-423" href="#__codelineno-4-423"></a>                                <span class="n">market</span><span class="o">.</span><span class="n">race_type</span><span class="p">,</span>
<a id="__codelineno-4-424" name="__codelineno-4-424" href="#__codelineno-4-424"></a>                                <span class="n">market</span><span class="o">.</span><span class="n">market_catalogue</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">country_code</span>
<a id="__codelineno-4-425" name="__codelineno-4-425" href="#__codelineno-4-425"></a>                            <span class="p">)</span>
<a id="__codelineno-4-426" name="__codelineno-4-426" href="#__codelineno-4-426"></a>                        <span class="p">]</span>
<a id="__codelineno-4-427" name="__codelineno-4-427" href="#__codelineno-4-427"></a>                    <span class="p">)</span>
<a id="__codelineno-4-428" name="__codelineno-4-428" href="#__codelineno-4-428"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">win_markets_written</span><span class="p">[</span><span class="n">market</span><span class="o">.</span><span class="n">market_id</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-4-429" name="__codelineno-4-429" href="#__codelineno-4-429"></a>
<a id="__codelineno-4-430" name="__codelineno-4-430" href="#__codelineno-4-430"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-4-431" name="__codelineno-4-431" href="#__codelineno-4-431"></a>                    <span class="c1"># Either WIN market already written or win_market_id not ready</span>
<a id="__codelineno-4-432" name="__codelineno-4-432" href="#__codelineno-4-432"></a>                    <span class="n">save_market_csv</span><span class="p">(</span><span class="n">final_market_dataframe</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">file_exists</span><span class="p">,</span> <span class="n">MARKET_COLUMNS</span><span class="p">)</span>
<a id="__codelineno-4-433" name="__codelineno-4-433" href="#__codelineno-4-433"></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">market</span><span class="o">.</span><span class="n">market_id</span><span class="si">}</span><span class="s2">] Saved basic non-WIN info for </span><span class="si">{</span><span class="n">market_type</span><span class="si">}</span><span class="s2"> at </span><span class="si">{</span><span class="n">market</span><span class="o">.</span><span class="n">venue</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-4-434" name="__codelineno-4-434" href="#__codelineno-4-434"></a>
<a id="__codelineno-4-435" name="__codelineno-4-435" href="#__codelineno-4-435"></a>        <span class="c1"># Mark market as processed and clean up</span>
<a id="__codelineno-4-436" name="__codelineno-4-436" href="#__codelineno-4-436"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">market_results</span><span class="p">[</span><span class="n">market</span><span class="o">.</span><span class="n">market_id</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-4-437" name="__codelineno-4-437" href="#__codelineno-4-437"></a>        <span class="c1"># If every market for the race has been settled and written, then we erase the data from the class context</span>
<a id="__codelineno-4-438" name="__codelineno-4-438" href="#__codelineno-4-438"></a>        <span class="n">clean_dataframe_dict_if_all_settled</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataframe_dict</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">market_groups</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
<a id="__codelineno-4-439" name="__codelineno-4-439" href="#__codelineno-4-439"></a>        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">process_closed_market</span><span class="p">(</span><span class="n">market</span><span class="p">,</span> <span class="n">market_book</span><span class="p">)</span>
</code></pre></div>
<p>Wow, that was a lot of code. Hopefully you're still with me!</p>
<p>As mentioned earlier, the code could be further compartmentalised but, for a tutorial, I felt it better to leave the detail here for improved reader comprehension.</p>
<p>So, our custom flumine class will:</p>
<ul>
<li>Read and store market info and runner metadata (where applicable)</li>
<li>Read and store market_book info at the scheduled off</li>
<li>Read and store BSP info when the BSP has been reconciled</li>
<li>Read and store final market_book info upon final market suspension before closure</li>
<li>Read and store final market results</li>
<li>Combine all relevant data before writing to csv</li>
<li>Infer placings based on related market settlements</li>
<li>send an alert to our chosen Discord channels</li>
</ul>
<p>There were a lot of functions in there which still haven't been shown. These belong to our placing_helpers.py and discord_helpers.py.
Let's outline these</p>
<h2 id="placing_helperspy">placing_helpers.py</h2>
<div class="highlight"><span class="filename">Placing Helper Functions</span><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">flumine.markets.market</span><span class="w"> </span><span class="kn">import</span> <span class="n">Market</span>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_market_ids</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">market_groups</span><span class="p">,</span> <span class="n">market_types</span><span class="p">):</span>
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Safely retrieve market IDs from market_groups for the given key and market_types.&quot;&quot;&quot;</span>
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a>    <span class="n">market_ids</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a>    <span class="n">market_group</span> <span class="o">=</span> <span class="n">market_groups</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">{})</span>
<a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a>
<a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a>    <span class="k">for</span> <span class="n">mtype</span> <span class="ow">in</span> <span class="n">market_types</span><span class="p">:</span>
<a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a>        <span class="n">market_ids</span><span class="p">[</span><span class="n">mtype</span><span class="p">]</span> <span class="o">=</span> <span class="n">market_group</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mtype</span><span class="si">}</span><span class="s2">_market_id&quot;</span><span class="p">)</span>
<a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a>
<a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a>    <span class="k">return</span> <span class="n">market_ids</span>
<a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a>
<a id="__codelineno-5-15" name="__codelineno-5-15" href="#__codelineno-5-15"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_place_dataframe</span><span class="p">(</span><span class="n">market_groups</span><span class="p">,</span> <span class="n">dataframe_dict</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
<a id="__codelineno-5-16" name="__codelineno-5-16" href="#__codelineno-5-16"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-5-17" name="__codelineno-5-17" href="#__codelineno-5-17"></a><span class="sd">    Returns the place dataframe for a given market group key.</span>
<a id="__codelineno-5-18" name="__codelineno-5-18" href="#__codelineno-5-18"></a><span class="sd">    Looks for 2TBP first, then 3TBP, and returns the first where market_type = &#39;PLACE&#39;.</span>
<a id="__codelineno-5-19" name="__codelineno-5-19" href="#__codelineno-5-19"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-5-20" name="__codelineno-5-20" href="#__codelineno-5-20"></a>    <span class="n">mg</span> <span class="o">=</span> <span class="n">market_groups</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">{})</span>
<a id="__codelineno-5-21" name="__codelineno-5-21" href="#__codelineno-5-21"></a>
<a id="__codelineno-5-22" name="__codelineno-5-22" href="#__codelineno-5-22"></a>    <span class="k">for</span> <span class="n">tbp_key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;2tbp_market_id&#39;</span><span class="p">,</span> <span class="s1">&#39;3tbp_market_id&#39;</span><span class="p">]:</span>
<a id="__codelineno-5-23" name="__codelineno-5-23" href="#__codelineno-5-23"></a>        <span class="n">market_id</span> <span class="o">=</span> <span class="n">mg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tbp_key</span><span class="p">)</span>
<a id="__codelineno-5-24" name="__codelineno-5-24" href="#__codelineno-5-24"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">market_id</span><span class="p">:</span>
<a id="__codelineno-5-25" name="__codelineno-5-25" href="#__codelineno-5-25"></a>            <span class="k">continue</span>
<a id="__codelineno-5-26" name="__codelineno-5-26" href="#__codelineno-5-26"></a>
<a id="__codelineno-5-27" name="__codelineno-5-27" href="#__codelineno-5-27"></a>        <span class="n">df</span> <span class="o">=</span> <span class="n">dataframe_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">market_id</span><span class="p">)</span>
<a id="__codelineno-5-28" name="__codelineno-5-28" href="#__codelineno-5-28"></a>        <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s1">&#39;market_type&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
<a id="__codelineno-5-29" name="__codelineno-5-29" href="#__codelineno-5-29"></a>            <span class="k">if</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;market_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;PLACE&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
<a id="__codelineno-5-30" name="__codelineno-5-30" href="#__codelineno-5-30"></a>                <span class="k">return</span> <span class="n">df</span>
<a id="__codelineno-5-31" name="__codelineno-5-31" href="#__codelineno-5-31"></a>
<a id="__codelineno-5-32" name="__codelineno-5-32" href="#__codelineno-5-32"></a>    <span class="k">return</span> <span class="kc">None</span>  <span class="c1"># No suitable dataframe found</span>
<a id="__codelineno-5-33" name="__codelineno-5-33" href="#__codelineno-5-33"></a>
<a id="__codelineno-5-34" name="__codelineno-5-34" href="#__codelineno-5-34"></a><span class="k">def</span><span class="w"> </span><span class="nf">merge_place_into_win</span><span class="p">(</span><span class="n">market_groups</span><span class="p">,</span> <span class="n">dataframe_dict</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">win_market_df</span><span class="p">):</span>
<a id="__codelineno-5-35" name="__codelineno-5-35" href="#__codelineno-5-35"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-5-36" name="__codelineno-5-36" href="#__codelineno-5-36"></a><span class="sd">    Fetches the place dataframe (2TBP or 3TBP), keeps only selection_id and runner_bsp,</span>
<a id="__codelineno-5-37" name="__codelineno-5-37" href="#__codelineno-5-37"></a><span class="sd">    renames runner_bsp to place_bsp, and merges into win_market_df on selection_id.</span>
<a id="__codelineno-5-38" name="__codelineno-5-38" href="#__codelineno-5-38"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-5-39" name="__codelineno-5-39" href="#__codelineno-5-39"></a>    <span class="n">place_df</span> <span class="o">=</span> <span class="n">get_place_dataframe</span><span class="p">(</span><span class="n">market_groups</span><span class="p">,</span> <span class="n">dataframe_dict</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
<a id="__codelineno-5-40" name="__codelineno-5-40" href="#__codelineno-5-40"></a>
<a id="__codelineno-5-41" name="__codelineno-5-41" href="#__codelineno-5-41"></a>    <span class="k">if</span> <span class="n">place_df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-5-42" name="__codelineno-5-42" href="#__codelineno-5-42"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No valid place dataframe found for market group </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-5-43" name="__codelineno-5-43" href="#__codelineno-5-43"></a>        <span class="k">return</span> <span class="n">win_market_df</span>
<a id="__codelineno-5-44" name="__codelineno-5-44" href="#__codelineno-5-44"></a>
<a id="__codelineno-5-45" name="__codelineno-5-45" href="#__codelineno-5-45"></a>    <span class="c1"># Keep only necessary columns and rename</span>
<a id="__codelineno-5-46" name="__codelineno-5-46" href="#__codelineno-5-46"></a>    <span class="n">place_df_subset</span> <span class="o">=</span> <span class="n">place_df</span><span class="p">[[</span><span class="s1">&#39;selection_id&#39;</span><span class="p">,</span> <span class="s1">&#39;number_of_winners&#39;</span><span class="p">,</span> <span class="s1">&#39;runner_bsp&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;runner_bsp&#39;</span><span class="p">:</span> <span class="s1">&#39;place_bsp&#39;</span><span class="p">,</span><span class="s1">&#39;number_of_winners&#39;</span><span class="p">:</span><span class="s1">&#39;places_paid&#39;</span><span class="p">})</span>
<a id="__codelineno-5-47" name="__codelineno-5-47" href="#__codelineno-5-47"></a>
<a id="__codelineno-5-48" name="__codelineno-5-48" href="#__codelineno-5-48"></a>    <span class="c1"># Merge on selection_id, avoiding duplication</span>
<a id="__codelineno-5-49" name="__codelineno-5-49" href="#__codelineno-5-49"></a>    <span class="n">merged_df</span> <span class="o">=</span> <span class="n">win_market_df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">place_df_subset</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;selection_id&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
<a id="__codelineno-5-50" name="__codelineno-5-50" href="#__codelineno-5-50"></a>
<a id="__codelineno-5-51" name="__codelineno-5-51" href="#__codelineno-5-51"></a>    <span class="k">return</span> <span class="n">merged_df</span>
<a id="__codelineno-5-52" name="__codelineno-5-52" href="#__codelineno-5-52"></a>
<a id="__codelineno-5-53" name="__codelineno-5-53" href="#__codelineno-5-53"></a><span class="k">def</span><span class="w"> </span><span class="nf">check_market_settlements</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">market_groups</span><span class="p">,</span> <span class="n">market_ids</span><span class="p">):</span>
<a id="__codelineno-5-54" name="__codelineno-5-54" href="#__codelineno-5-54"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-5-55" name="__codelineno-5-55" href="#__codelineno-5-55"></a><span class="sd">    This function returns a boolean value only</span>
<a id="__codelineno-5-56" name="__codelineno-5-56" href="#__codelineno-5-56"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-5-57" name="__codelineno-5-57" href="#__codelineno-5-57"></a>    <span class="n">mg</span> <span class="o">=</span> <span class="n">market_groups</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">{})</span>
<a id="__codelineno-5-58" name="__codelineno-5-58" href="#__codelineno-5-58"></a>
<a id="__codelineno-5-59" name="__codelineno-5-59" href="#__codelineno-5-59"></a>    <span class="c1"># TBP markets</span>
<a id="__codelineno-5-60" name="__codelineno-5-60" href="#__codelineno-5-60"></a>    <span class="k">for</span> <span class="n">tbp</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;4tbp&#39;</span><span class="p">,</span> <span class="s1">&#39;3tbp&#39;</span><span class="p">,</span> <span class="s1">&#39;2tbp&#39;</span><span class="p">]:</span>
<a id="__codelineno-5-61" name="__codelineno-5-61" href="#__codelineno-5-61"></a>        <span class="k">if</span> <span class="n">market_ids</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tbp</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">mg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tbp</span><span class="si">}</span><span class="s2">_settled&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-5-62" name="__codelineno-5-62" href="#__codelineno-5-62"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tbp</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2"> market not yet settled&quot;</span><span class="p">)</span>
<a id="__codelineno-5-63" name="__codelineno-5-63" href="#__codelineno-5-63"></a>            <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-5-64" name="__codelineno-5-64" href="#__codelineno-5-64"></a>
<a id="__codelineno-5-65" name="__codelineno-5-65" href="#__codelineno-5-65"></a>    <span class="c1"># Special case: No 2TBP and exotics not settled</span>
<a id="__codelineno-5-66" name="__codelineno-5-66" href="#__codelineno-5-66"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">market_ids</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;2tbp&#39;</span><span class="p">):</span>
<a id="__codelineno-5-67" name="__codelineno-5-67" href="#__codelineno-5-67"></a>        <span class="n">exotics_settled</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-5-68" name="__codelineno-5-68" href="#__codelineno-5-68"></a>        <span class="k">for</span> <span class="n">exotic</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;exacta&#39;</span><span class="p">,</span> <span class="s1">&#39;quinella&#39;</span><span class="p">]:</span>
<a id="__codelineno-5-69" name="__codelineno-5-69" href="#__codelineno-5-69"></a>            <span class="k">if</span> <span class="n">market_ids</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">exotic</span><span class="p">):</span>
<a id="__codelineno-5-70" name="__codelineno-5-70" href="#__codelineno-5-70"></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">mg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">exotic</span><span class="si">}</span><span class="s1">_settled&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-5-71" name="__codelineno-5-71" href="#__codelineno-5-71"></a>                    <span class="n">exotics_settled</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-5-72" name="__codelineno-5-72" href="#__codelineno-5-72"></a>                    <span class="k">break</span>
<a id="__codelineno-5-73" name="__codelineno-5-73" href="#__codelineno-5-73"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">exotics_settled</span><span class="p">:</span>
<a id="__codelineno-5-74" name="__codelineno-5-74" href="#__codelineno-5-74"></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No 2TBP market and Exotics not yet settled&quot;</span><span class="p">)</span>
<a id="__codelineno-5-75" name="__codelineno-5-75" href="#__codelineno-5-75"></a>            <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-5-76" name="__codelineno-5-76" href="#__codelineno-5-76"></a>
<a id="__codelineno-5-77" name="__codelineno-5-77" href="#__codelineno-5-77"></a>    <span class="c1"># WIN market</span>
<a id="__codelineno-5-78" name="__codelineno-5-78" href="#__codelineno-5-78"></a>    <span class="k">if</span> <span class="n">market_ids</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;win&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">mg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;win_settled&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-5-79" name="__codelineno-5-79" href="#__codelineno-5-79"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WIN market not yet settled&quot;</span><span class="p">)</span>
<a id="__codelineno-5-80" name="__codelineno-5-80" href="#__codelineno-5-80"></a>        <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-5-81" name="__codelineno-5-81" href="#__codelineno-5-81"></a>
<a id="__codelineno-5-82" name="__codelineno-5-82" href="#__codelineno-5-82"></a>    <span class="k">return</span> <span class="kc">True</span>  <span class="c1"># All checks passed</span>
<a id="__codelineno-5-83" name="__codelineno-5-83" href="#__codelineno-5-83"></a>
<a id="__codelineno-5-84" name="__codelineno-5-84" href="#__codelineno-5-84"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_winners</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
<a id="__codelineno-5-85" name="__codelineno-5-85" href="#__codelineno-5-85"></a>    <span class="c1"># Function returns winners from the market</span>
<a id="__codelineno-5-86" name="__codelineno-5-86" href="#__codelineno-5-86"></a>    <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
<a id="__codelineno-5-87" name="__codelineno-5-87" href="#__codelineno-5-87"></a>        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[])</span>
<a id="__codelineno-5-88" name="__codelineno-5-88" href="#__codelineno-5-88"></a>
<a id="__codelineno-5-89" name="__codelineno-5-89" href="#__codelineno-5-89"></a>    <span class="k">return</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;runner_status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;WINNER&#39;</span><span class="p">]</span>
<a id="__codelineno-5-90" name="__codelineno-5-90" href="#__codelineno-5-90"></a>
<a id="__codelineno-5-91" name="__codelineno-5-91" href="#__codelineno-5-91"></a><span class="k">def</span><span class="w"> </span><span class="nf">assign_placing</span><span class="p">(</span><span class="n">placing_dict</span><span class="p">,</span> <span class="n">cloth_numbers</span><span class="p">,</span> <span class="n">place</span><span class="p">):</span>
<a id="__codelineno-5-92" name="__codelineno-5-92" href="#__codelineno-5-92"></a>
<a id="__codelineno-5-93" name="__codelineno-5-93" href="#__codelineno-5-93"></a>    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cloth_numbers</span><span class="p">:</span>
<a id="__codelineno-5-94" name="__codelineno-5-94" href="#__codelineno-5-94"></a>        <span class="k">if</span> <span class="n">placing_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-5-95" name="__codelineno-5-95" href="#__codelineno-5-95"></a>            <span class="n">placing_dict</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">place</span>
<a id="__codelineno-5-96" name="__codelineno-5-96" href="#__codelineno-5-96"></a>
<a id="__codelineno-5-97" name="__codelineno-5-97" href="#__codelineno-5-97"></a><span class="k">def</span><span class="w"> </span><span class="nf">assign_first_place</span><span class="p">(</span><span class="n">placing_dict</span><span class="p">,</span> <span class="n">dataframe_dict</span><span class="p">,</span> <span class="n">market_id</span><span class="p">):</span>
<a id="__codelineno-5-98" name="__codelineno-5-98" href="#__codelineno-5-98"></a>
<a id="__codelineno-5-99" name="__codelineno-5-99" href="#__codelineno-5-99"></a>    <span class="n">df</span> <span class="o">=</span> <span class="n">dataframe_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">market_id</span><span class="p">)</span>
<a id="__codelineno-5-100" name="__codelineno-5-100" href="#__codelineno-5-100"></a>    <span class="n">winners</span> <span class="o">=</span> <span class="n">get_winners</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<a id="__codelineno-5-101" name="__codelineno-5-101" href="#__codelineno-5-101"></a>    <span class="n">assign_placing</span><span class="p">(</span><span class="n">placing_dict</span><span class="p">,</span> <span class="n">winners</span><span class="p">[</span><span class="s1">&#39;cloth_number&#39;</span><span class="p">],</span> <span class="s1">&#39;1&#39;</span><span class="p">)</span>
<a id="__codelineno-5-102" name="__codelineno-5-102" href="#__codelineno-5-102"></a>
<a id="__codelineno-5-103" name="__codelineno-5-103" href="#__codelineno-5-103"></a><span class="k">def</span><span class="w"> </span><span class="nf">assign_second_place_tbp</span><span class="p">(</span><span class="n">placing_dict</span><span class="p">,</span> <span class="n">dataframe_dict</span><span class="p">,</span> <span class="n">market_id</span><span class="p">):</span>
<a id="__codelineno-5-104" name="__codelineno-5-104" href="#__codelineno-5-104"></a>
<a id="__codelineno-5-105" name="__codelineno-5-105" href="#__codelineno-5-105"></a>    <span class="n">df</span> <span class="o">=</span> <span class="n">dataframe_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">market_id</span><span class="p">)</span>
<a id="__codelineno-5-106" name="__codelineno-5-106" href="#__codelineno-5-106"></a>    <span class="n">winners</span> <span class="o">=</span> <span class="n">get_winners</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<a id="__codelineno-5-107" name="__codelineno-5-107" href="#__codelineno-5-107"></a>
<a id="__codelineno-5-108" name="__codelineno-5-108" href="#__codelineno-5-108"></a>    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">winners</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
<a id="__codelineno-5-109" name="__codelineno-5-109" href="#__codelineno-5-109"></a>        <span class="n">c</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;cloth_number&#39;</span><span class="p">]</span>
<a id="__codelineno-5-110" name="__codelineno-5-110" href="#__codelineno-5-110"></a>        <span class="k">if</span> <span class="n">placing_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;1&#39;</span><span class="p">:</span>
<a id="__codelineno-5-111" name="__codelineno-5-111" href="#__codelineno-5-111"></a>            <span class="n">placing_dict</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;2&#39;</span>
<a id="__codelineno-5-112" name="__codelineno-5-112" href="#__codelineno-5-112"></a>    <span class="k">return</span> <span class="ow">not</span> <span class="n">winners</span><span class="o">.</span><span class="n">empty</span>
<a id="__codelineno-5-113" name="__codelineno-5-113" href="#__codelineno-5-113"></a>
<a id="__codelineno-5-114" name="__codelineno-5-114" href="#__codelineno-5-114"></a><span class="k">def</span><span class="w"> </span><span class="nf">assign_second_place_exotics</span><span class="p">(</span><span class="n">placing_dict</span><span class="p">,</span> <span class="n">dataframe_dict</span><span class="p">,</span> <span class="n">exacta_id</span><span class="p">,</span> <span class="n">quinella_id</span><span class="p">):</span>
<a id="__codelineno-5-115" name="__codelineno-5-115" href="#__codelineno-5-115"></a>
<a id="__codelineno-5-116" name="__codelineno-5-116" href="#__codelineno-5-116"></a>    <span class="c1"># Exacta</span>
<a id="__codelineno-5-117" name="__codelineno-5-117" href="#__codelineno-5-117"></a>    <span class="n">exacta_df</span> <span class="o">=</span> <span class="n">dataframe_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">exacta_id</span><span class="p">)</span>
<a id="__codelineno-5-118" name="__codelineno-5-118" href="#__codelineno-5-118"></a>    <span class="k">if</span> <span class="n">exacta_df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-5-119" name="__codelineno-5-119" href="#__codelineno-5-119"></a>        <span class="n">exf_winners</span> <span class="o">=</span> <span class="n">get_winners</span><span class="p">(</span><span class="n">exacta_df</span><span class="p">)</span>
<a id="__codelineno-5-120" name="__codelineno-5-120" href="#__codelineno-5-120"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">exf_winners</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
<a id="__codelineno-5-121" name="__codelineno-5-121" href="#__codelineno-5-121"></a>            <span class="n">runner_name</span> <span class="o">=</span> <span class="n">exf_winners</span><span class="p">[</span><span class="s1">&#39;runner_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-5-122" name="__codelineno-5-122" href="#__codelineno-5-122"></a>            <span class="k">if</span> <span class="n">runner_name</span> <span class="o">!=</span> <span class="s2">&quot;Any Other Result&quot;</span><span class="p">:</span>
<a id="__codelineno-5-123" name="__codelineno-5-123" href="#__codelineno-5-123"></a>                <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-5-124" name="__codelineno-5-124" href="#__codelineno-5-124"></a>                    <span class="n">number_1</span><span class="p">,</span> <span class="n">number_2</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(\d+)\s*-\s*(\d+)&#39;</span><span class="p">,</span> <span class="n">runner_name</span><span class="p">)</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
<a id="__codelineno-5-125" name="__codelineno-5-125" href="#__codelineno-5-125"></a>                    <span class="n">placing_dict</span><span class="p">[</span><span class="n">number_2</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;2&#39;</span>
<a id="__codelineno-5-126" name="__codelineno-5-126" href="#__codelineno-5-126"></a>                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<a id="__codelineno-5-127" name="__codelineno-5-127" href="#__codelineno-5-127"></a>                    <span class="k">pass</span>
<a id="__codelineno-5-128" name="__codelineno-5-128" href="#__codelineno-5-128"></a>
<a id="__codelineno-5-129" name="__codelineno-5-129" href="#__codelineno-5-129"></a>    <span class="c1"># Quinella</span>
<a id="__codelineno-5-130" name="__codelineno-5-130" href="#__codelineno-5-130"></a>    <span class="n">quinella_df</span> <span class="o">=</span> <span class="n">dataframe_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">quinella_id</span><span class="p">)</span>
<a id="__codelineno-5-131" name="__codelineno-5-131" href="#__codelineno-5-131"></a>    <span class="k">if</span> <span class="n">quinella_df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-5-132" name="__codelineno-5-132" href="#__codelineno-5-132"></a>        <span class="n">quin_winners</span> <span class="o">=</span> <span class="n">get_winners</span><span class="p">(</span><span class="n">quinella_df</span><span class="p">)</span>
<a id="__codelineno-5-133" name="__codelineno-5-133" href="#__codelineno-5-133"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">quin_winners</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
<a id="__codelineno-5-134" name="__codelineno-5-134" href="#__codelineno-5-134"></a>            <span class="n">runner_name</span> <span class="o">=</span> <span class="n">quin_winners</span><span class="p">[</span><span class="s1">&#39;runner_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-5-135" name="__codelineno-5-135" href="#__codelineno-5-135"></a>            <span class="k">if</span> <span class="n">runner_name</span> <span class="o">!=</span> <span class="s2">&quot;Any Other Result&quot;</span><span class="p">:</span>
<a id="__codelineno-5-136" name="__codelineno-5-136" href="#__codelineno-5-136"></a>                <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-5-137" name="__codelineno-5-137" href="#__codelineno-5-137"></a>                    <span class="n">matches</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(\d+)\s*-\s*(\d+)&#39;</span><span class="p">,</span> <span class="n">runner_name</span><span class="p">)</span>
<a id="__codelineno-5-138" name="__codelineno-5-138" href="#__codelineno-5-138"></a>                    <span class="k">for</span> <span class="n">number_1</span><span class="p">,</span> <span class="n">number_2</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">:</span>
<a id="__codelineno-5-139" name="__codelineno-5-139" href="#__codelineno-5-139"></a>                        <span class="k">if</span> <span class="n">placing_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">number_1</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;1&#39;</span> <span class="ow">and</span> <span class="n">placing_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">number_2</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;1&#39;</span><span class="p">:</span>
<a id="__codelineno-5-140" name="__codelineno-5-140" href="#__codelineno-5-140"></a>                            <span class="n">placing_dict</span><span class="p">[</span><span class="n">number_2</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;2&#39;</span>
<a id="__codelineno-5-141" name="__codelineno-5-141" href="#__codelineno-5-141"></a>                        <span class="k">elif</span> <span class="n">placing_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">number_2</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;1&#39;</span> <span class="ow">and</span> <span class="n">placing_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">number_1</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;1&#39;</span><span class="p">:</span>
<a id="__codelineno-5-142" name="__codelineno-5-142" href="#__codelineno-5-142"></a>                            <span class="n">placing_dict</span><span class="p">[</span><span class="n">number_1</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;2&#39;</span>
<a id="__codelineno-5-143" name="__codelineno-5-143" href="#__codelineno-5-143"></a>                        <span class="k">elif</span> <span class="n">placing_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">number_1</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;1&#39;</span> <span class="ow">and</span> <span class="n">placing_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">number_2</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;1&#39;</span><span class="p">:</span>
<a id="__codelineno-5-144" name="__codelineno-5-144" href="#__codelineno-5-144"></a>                            <span class="n">placing_dict</span><span class="p">[</span><span class="n">number_1</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;2&#39;</span>
<a id="__codelineno-5-145" name="__codelineno-5-145" href="#__codelineno-5-145"></a>                            <span class="n">placing_dict</span><span class="p">[</span><span class="n">number_2</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;2&#39;</span>
<a id="__codelineno-5-146" name="__codelineno-5-146" href="#__codelineno-5-146"></a>                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<a id="__codelineno-5-147" name="__codelineno-5-147" href="#__codelineno-5-147"></a>                    <span class="k">pass</span>
<a id="__codelineno-5-148" name="__codelineno-5-148" href="#__codelineno-5-148"></a>
<a id="__codelineno-5-149" name="__codelineno-5-149" href="#__codelineno-5-149"></a><span class="k">def</span><span class="w"> </span><span class="nf">assign_place</span><span class="p">(</span><span class="n">placing_dict</span><span class="p">,</span> <span class="n">dataframe_dict</span><span class="p">,</span> <span class="n">market_id</span><span class="p">,</span> <span class="n">place</span><span class="p">,</span> <span class="n">depend_on</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-5-150" name="__codelineno-5-150" href="#__codelineno-5-150"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-5-151" name="__codelineno-5-151" href="#__codelineno-5-151"></a><span class="sd">    This function assigns places to each runner with the possible combinations being:</span>
<a id="__codelineno-5-152" name="__codelineno-5-152" href="#__codelineno-5-152"></a><span class="sd">     - 1 / 2 (No 3TBP market)</span>
<a id="__codelineno-5-153" name="__codelineno-5-153" href="#__codelineno-5-153"></a><span class="sd">     - 1 / 2 / 3 (3TBP market and either 2TBP market or at least one Exotics Market settled not as &#39;Any Other Result&#39;)</span>
<a id="__codelineno-5-154" name="__codelineno-5-154" href="#__codelineno-5-154"></a><span class="sd">     - 1 / P / P (3TBP market and no 2TBP market and no Exotics Market settled not as &#39;Any Other Result&#39;)</span>
<a id="__codelineno-5-155" name="__codelineno-5-155" href="#__codelineno-5-155"></a><span class="sd">     - 1 / 2 / 3 / 4 (4TBP/3TBP market and either 2TBP market or at least one Exotics Market settled not as &#39;Any Other Result&#39;)</span>
<a id="__codelineno-5-156" name="__codelineno-5-156" href="#__codelineno-5-156"></a><span class="sd">     - 1 / P / P / 4 (4TBP/3TBP market and no 2TBP market and no Exotics Market settled not as &#39;Any Other Result&#39;)</span>
<a id="__codelineno-5-157" name="__codelineno-5-157" href="#__codelineno-5-157"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-5-158" name="__codelineno-5-158" href="#__codelineno-5-158"></a>
<a id="__codelineno-5-159" name="__codelineno-5-159" href="#__codelineno-5-159"></a>    <span class="n">df</span> <span class="o">=</span> <span class="n">dataframe_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">market_id</span><span class="p">)</span>
<a id="__codelineno-5-160" name="__codelineno-5-160" href="#__codelineno-5-160"></a>    <span class="n">winners</span> <span class="o">=</span> <span class="n">get_winners</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<a id="__codelineno-5-161" name="__codelineno-5-161" href="#__codelineno-5-161"></a>    <span class="k">if</span> <span class="n">winners</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
<a id="__codelineno-5-162" name="__codelineno-5-162" href="#__codelineno-5-162"></a>        <span class="k">return</span>
<a id="__codelineno-5-163" name="__codelineno-5-163" href="#__codelineno-5-163"></a>
<a id="__codelineno-5-164" name="__codelineno-5-164" href="#__codelineno-5-164"></a>    <span class="n">used</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">placing_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<a id="__codelineno-5-165" name="__codelineno-5-165" href="#__codelineno-5-165"></a>    <span class="n">unknowns</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">winners</span><span class="p">[</span><span class="s1">&#39;cloth_number&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">used</span><span class="p">]</span>
<a id="__codelineno-5-166" name="__codelineno-5-166" href="#__codelineno-5-166"></a>
<a id="__codelineno-5-167" name="__codelineno-5-167" href="#__codelineno-5-167"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">unknowns</span><span class="p">:</span>
<a id="__codelineno-5-168" name="__codelineno-5-168" href="#__codelineno-5-168"></a>        <span class="k">return</span>
<a id="__codelineno-5-169" name="__codelineno-5-169" href="#__codelineno-5-169"></a>
<a id="__codelineno-5-170" name="__codelineno-5-170" href="#__codelineno-5-170"></a>    <span class="c1"># Normal dependent logic</span>
<a id="__codelineno-5-171" name="__codelineno-5-171" href="#__codelineno-5-171"></a>    <span class="k">if</span> <span class="n">depend_on</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="n">p</span> <span class="ow">in</span> <span class="n">placing_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">depend_on</span><span class="p">):</span>
<a id="__codelineno-5-172" name="__codelineno-5-172" href="#__codelineno-5-172"></a>        <span class="n">placing_dict</span><span class="p">[</span><span class="n">unknowns</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">place</span><span class="p">)</span>
<a id="__codelineno-5-173" name="__codelineno-5-173" href="#__codelineno-5-173"></a>
<a id="__codelineno-5-174" name="__codelineno-5-174" href="#__codelineno-5-174"></a>    <span class="c1"># Special case for 4th place with &quot;P&quot;</span>
<a id="__codelineno-5-175" name="__codelineno-5-175" href="#__codelineno-5-175"></a>    <span class="k">elif</span> <span class="n">place</span> <span class="o">==</span> <span class="mi">4</span> <span class="ow">and</span> <span class="n">depend_on</span><span class="p">:</span>
<a id="__codelineno-5-176" name="__codelineno-5-176" href="#__codelineno-5-176"></a>        <span class="c1"># Count how many Ps are already assigned</span>
<a id="__codelineno-5-177" name="__codelineno-5-177" href="#__codelineno-5-177"></a>        <span class="n">ps_assigned</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">placing_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="s2">&quot;P&quot;</span><span class="p">]</span>
<a id="__codelineno-5-178" name="__codelineno-5-178" href="#__codelineno-5-178"></a>
<a id="__codelineno-5-179" name="__codelineno-5-179" href="#__codelineno-5-179"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ps_assigned</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="s2">&quot;1&quot;</span> <span class="ow">in</span> <span class="n">placing_dict</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
<a id="__codelineno-5-180" name="__codelineno-5-180" href="#__codelineno-5-180"></a>            <span class="c1"># Only one unknown remains in 4TBP → must be 4th</span>
<a id="__codelineno-5-181" name="__codelineno-5-181" href="#__codelineno-5-181"></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unknowns</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-5-182" name="__codelineno-5-182" href="#__codelineno-5-182"></a>                <span class="n">placing_dict</span><span class="p">[</span><span class="n">unknowns</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="s2">&quot;4&quot;</span>
<a id="__codelineno-5-183" name="__codelineno-5-183" href="#__codelineno-5-183"></a>                <span class="k">return</span>
<a id="__codelineno-5-184" name="__codelineno-5-184" href="#__codelineno-5-184"></a>
<a id="__codelineno-5-185" name="__codelineno-5-185" href="#__codelineno-5-185"></a>        <span class="c1"># Fall back to generic &quot;P&quot; assignment if still ambiguous</span>
<a id="__codelineno-5-186" name="__codelineno-5-186" href="#__codelineno-5-186"></a>        <span class="n">assign_placing</span><span class="p">(</span><span class="n">placing_dict</span><span class="p">,</span> <span class="n">unknowns</span><span class="p">,</span> <span class="s2">&quot;P&quot;</span><span class="p">)</span>
<a id="__codelineno-5-187" name="__codelineno-5-187" href="#__codelineno-5-187"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-5-188" name="__codelineno-5-188" href="#__codelineno-5-188"></a>        <span class="n">assign_placing</span><span class="p">(</span><span class="n">placing_dict</span><span class="p">,</span> <span class="n">unknowns</span><span class="p">,</span> <span class="s2">&quot;P&quot;</span><span class="p">)</span>
<a id="__codelineno-5-189" name="__codelineno-5-189" href="#__codelineno-5-189"></a>
<a id="__codelineno-5-190" name="__codelineno-5-190" href="#__codelineno-5-190"></a><span class="k">def</span><span class="w"> </span><span class="nf">save_market_csv</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">file_exists</span><span class="p">,</span> <span class="n">market_columns</span><span class="p">):</span>
<a id="__codelineno-5-191" name="__codelineno-5-191" href="#__codelineno-5-191"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Append market dataframe to CSV ensuring columns from market_columns exist.</span>
<a id="__codelineno-5-192" name="__codelineno-5-192" href="#__codelineno-5-192"></a><span class="sd">    Also include &#39;placing&#39; if it exists in df.</span>
<a id="__codelineno-5-193" name="__codelineno-5-193" href="#__codelineno-5-193"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-5-194" name="__codelineno-5-194" href="#__codelineno-5-194"></a>    <span class="c1"># Make a copy of market_columns to avoid modifying original list</span>
<a id="__codelineno-5-195" name="__codelineno-5-195" href="#__codelineno-5-195"></a>    <span class="n">cols_to_write</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">market_columns</span><span class="p">)</span>
<a id="__codelineno-5-196" name="__codelineno-5-196" href="#__codelineno-5-196"></a>
<a id="__codelineno-5-197" name="__codelineno-5-197" href="#__codelineno-5-197"></a>    <span class="c1"># If &#39;placing&#39; exists in the dataframe but is not in market_columns, append it</span>
<a id="__codelineno-5-198" name="__codelineno-5-198" href="#__codelineno-5-198"></a>    <span class="k">if</span> <span class="s1">&#39;placing&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="s1">&#39;placing&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cols_to_write</span><span class="p">:</span>
<a id="__codelineno-5-199" name="__codelineno-5-199" href="#__codelineno-5-199"></a>        <span class="n">cols_to_write</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;placing&#39;</span><span class="p">)</span>
<a id="__codelineno-5-200" name="__codelineno-5-200" href="#__codelineno-5-200"></a>
<a id="__codelineno-5-201" name="__codelineno-5-201" href="#__codelineno-5-201"></a>    <span class="c1"># Add missing columns with None</span>
<a id="__codelineno-5-202" name="__codelineno-5-202" href="#__codelineno-5-202"></a>    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols_to_write</span><span class="p">:</span>
<a id="__codelineno-5-203" name="__codelineno-5-203" href="#__codelineno-5-203"></a>        <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
<a id="__codelineno-5-204" name="__codelineno-5-204" href="#__codelineno-5-204"></a>            <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-5-205" name="__codelineno-5-205" href="#__codelineno-5-205"></a>
<a id="__codelineno-5-206" name="__codelineno-5-206" href="#__codelineno-5-206"></a>    <span class="c1"># Reorder columns</span>
<a id="__codelineno-5-207" name="__codelineno-5-207" href="#__codelineno-5-207"></a>    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">cols_to_write</span><span class="p">)</span>
<a id="__codelineno-5-208" name="__codelineno-5-208" href="#__codelineno-5-208"></a>
<a id="__codelineno-5-209" name="__codelineno-5-209" href="#__codelineno-5-209"></a>    <span class="c1"># Save</span>
<a id="__codelineno-5-210" name="__codelineno-5-210" href="#__codelineno-5-210"></a>    <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="ow">not</span> <span class="n">file_exists</span><span class="p">)</span>
<a id="__codelineno-5-211" name="__codelineno-5-211" href="#__codelineno-5-211"></a>
<a id="__codelineno-5-212" name="__codelineno-5-212" href="#__codelineno-5-212"></a><span class="k">def</span><span class="w"> </span><span class="nf">save_with_placings</span><span class="p">(</span><span class="n">base_df</span><span class="p">,</span> <span class="n">placings_df</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">file_exists</span><span class="p">,</span> <span class="n">market_columns</span><span class="p">,</span> <span class="n">extra_cols</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-5-213" name="__codelineno-5-213" href="#__codelineno-5-213"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Merge placings into base_df, add missing cols, save to CSV.&quot;&quot;&quot;</span>
<a id="__codelineno-5-214" name="__codelineno-5-214" href="#__codelineno-5-214"></a>    <span class="n">merged_df</span> <span class="o">=</span> <span class="n">base_df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
<a id="__codelineno-5-215" name="__codelineno-5-215" href="#__codelineno-5-215"></a>        <span class="n">placings_df</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;market_id&#39;</span><span class="p">,</span> <span class="s1">&#39;cloth_number&#39;</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">suffixes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;_x&#39;</span><span class="p">]</span>
<a id="__codelineno-5-216" name="__codelineno-5-216" href="#__codelineno-5-216"></a>    <span class="p">)</span>
<a id="__codelineno-5-217" name="__codelineno-5-217" href="#__codelineno-5-217"></a>    <span class="k">if</span> <span class="n">extra_cols</span><span class="p">:</span>
<a id="__codelineno-5-218" name="__codelineno-5-218" href="#__codelineno-5-218"></a>        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">extra_cols</span><span class="p">:</span>
<a id="__codelineno-5-219" name="__codelineno-5-219" href="#__codelineno-5-219"></a>            <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">merged_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
<a id="__codelineno-5-220" name="__codelineno-5-220" href="#__codelineno-5-220"></a>                <span class="n">merged_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-5-221" name="__codelineno-5-221" href="#__codelineno-5-221"></a>    <span class="n">save_market_csv</span><span class="p">(</span><span class="n">merged_df</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">file_exists</span><span class="p">,</span> <span class="n">market_columns</span><span class="p">)</span>
<a id="__codelineno-5-222" name="__codelineno-5-222" href="#__codelineno-5-222"></a>
<a id="__codelineno-5-223" name="__codelineno-5-223" href="#__codelineno-5-223"></a>    <span class="k">return</span> <span class="n">merged_df</span>
<a id="__codelineno-5-224" name="__codelineno-5-224" href="#__codelineno-5-224"></a>
<a id="__codelineno-5-225" name="__codelineno-5-225" href="#__codelineno-5-225"></a><span class="k">def</span><span class="w"> </span><span class="nf">determine_placings</span><span class="p">(</span><span class="n">market</span><span class="p">:</span> <span class="n">Market</span><span class="p">,</span> <span class="n">market_groups</span><span class="p">,</span> <span class="n">dataframe_dict</span><span class="p">,</span> <span class="n">market_types</span><span class="p">):</span>
<a id="__codelineno-5-226" name="__codelineno-5-226" href="#__codelineno-5-226"></a>
<a id="__codelineno-5-227" name="__codelineno-5-227" href="#__codelineno-5-227"></a>    <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">market</span><span class="o">.</span><span class="n">event_id</span><span class="p">,</span> <span class="n">market</span><span class="o">.</span><span class="n">market_start_datetime</span><span class="p">)</span>
<a id="__codelineno-5-228" name="__codelineno-5-228" href="#__codelineno-5-228"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">market_groups</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
<a id="__codelineno-5-229" name="__codelineno-5-229" href="#__codelineno-5-229"></a>    <span class="n">market_ids</span> <span class="o">=</span> <span class="n">get_market_ids</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">market_groups</span><span class="p">,</span> <span class="n">market_types</span><span class="p">)</span>
<a id="__codelineno-5-230" name="__codelineno-5-230" href="#__codelineno-5-230"></a>
<a id="__codelineno-5-231" name="__codelineno-5-231" href="#__codelineno-5-231"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">check_market_settlements</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">market_groups</span><span class="p">,</span> <span class="n">market_ids</span><span class="p">):</span>
<a id="__codelineno-5-232" name="__codelineno-5-232" href="#__codelineno-5-232"></a>        <span class="k">return</span>
<a id="__codelineno-5-233" name="__codelineno-5-233" href="#__codelineno-5-233"></a>
<a id="__codelineno-5-234" name="__codelineno-5-234" href="#__codelineno-5-234"></a>    <span class="n">placing_dict</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-5-235" name="__codelineno-5-235" href="#__codelineno-5-235"></a>
<a id="__codelineno-5-236" name="__codelineno-5-236" href="#__codelineno-5-236"></a>    <span class="n">assign_first_place</span><span class="p">(</span><span class="n">placing_dict</span><span class="p">,</span> <span class="n">dataframe_dict</span><span class="p">,</span> <span class="n">market_ids</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;win&#39;</span><span class="p">))</span>
<a id="__codelineno-5-237" name="__codelineno-5-237" href="#__codelineno-5-237"></a>
<a id="__codelineno-5-238" name="__codelineno-5-238" href="#__codelineno-5-238"></a>    <span class="c1"># Assign 2nd place from 2TBP; if none, fallback to exotics</span>
<a id="__codelineno-5-239" name="__codelineno-5-239" href="#__codelineno-5-239"></a>    <span class="n">two_tbp_assigned</span> <span class="o">=</span> <span class="n">assign_second_place_tbp</span><span class="p">(</span><span class="n">placing_dict</span><span class="p">,</span> <span class="n">dataframe_dict</span><span class="p">,</span> <span class="n">market_ids</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;2tbp&#39;</span><span class="p">))</span>
<a id="__codelineno-5-240" name="__codelineno-5-240" href="#__codelineno-5-240"></a>
<a id="__codelineno-5-241" name="__codelineno-5-241" href="#__codelineno-5-241"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">two_tbp_assigned</span><span class="p">:</span>
<a id="__codelineno-5-242" name="__codelineno-5-242" href="#__codelineno-5-242"></a>        <span class="n">assign_second_place_exotics</span><span class="p">(</span>
<a id="__codelineno-5-243" name="__codelineno-5-243" href="#__codelineno-5-243"></a>            <span class="n">placing_dict</span><span class="p">,</span>
<a id="__codelineno-5-244" name="__codelineno-5-244" href="#__codelineno-5-244"></a>            <span class="n">dataframe_dict</span><span class="p">,</span>
<a id="__codelineno-5-245" name="__codelineno-5-245" href="#__codelineno-5-245"></a>            <span class="n">market_ids</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;exacta&#39;</span><span class="p">),</span>
<a id="__codelineno-5-246" name="__codelineno-5-246" href="#__codelineno-5-246"></a>            <span class="n">market_ids</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;quinella&#39;</span><span class="p">),</span>
<a id="__codelineno-5-247" name="__codelineno-5-247" href="#__codelineno-5-247"></a>        <span class="p">)</span>
<a id="__codelineno-5-248" name="__codelineno-5-248" href="#__codelineno-5-248"></a>
<a id="__codelineno-5-249" name="__codelineno-5-249" href="#__codelineno-5-249"></a>    <span class="c1"># Assign 3rd place</span>
<a id="__codelineno-5-250" name="__codelineno-5-250" href="#__codelineno-5-250"></a>    <span class="n">assign_place</span><span class="p">(</span><span class="n">placing_dict</span><span class="p">,</span> <span class="n">dataframe_dict</span><span class="p">,</span> <span class="n">market_ids</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;3tbp&#39;</span><span class="p">),</span> <span class="n">place</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">depend_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;2&#39;</span><span class="p">])</span>
<a id="__codelineno-5-251" name="__codelineno-5-251" href="#__codelineno-5-251"></a>
<a id="__codelineno-5-252" name="__codelineno-5-252" href="#__codelineno-5-252"></a>    <span class="c1"># Assign 4th place</span>
<a id="__codelineno-5-253" name="__codelineno-5-253" href="#__codelineno-5-253"></a>    <span class="n">assign_place</span><span class="p">(</span><span class="n">placing_dict</span><span class="p">,</span> <span class="n">dataframe_dict</span><span class="p">,</span> <span class="n">market_ids</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;4tbp&#39;</span><span class="p">),</span> <span class="n">place</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">depend_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="s1">&#39;3&#39;</span><span class="p">])</span>
<a id="__codelineno-5-254" name="__codelineno-5-254" href="#__codelineno-5-254"></a>
<a id="__codelineno-5-255" name="__codelineno-5-255" href="#__codelineno-5-255"></a>    <span class="n">placing_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">placing_dict</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;placing&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<a id="__codelineno-5-256" name="__codelineno-5-256" href="#__codelineno-5-256"></a>
<a id="__codelineno-5-257" name="__codelineno-5-257" href="#__codelineno-5-257"></a>    <span class="n">placing_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="s1">&#39;cloth_number&#39;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-5-258" name="__codelineno-5-258" href="#__codelineno-5-258"></a>    <span class="n">placing_df</span><span class="p">[</span><span class="s1">&#39;market_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">market_ids</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;win&#39;</span><span class="p">)</span>
<a id="__codelineno-5-259" name="__codelineno-5-259" href="#__codelineno-5-259"></a>
<a id="__codelineno-5-260" name="__codelineno-5-260" href="#__codelineno-5-260"></a>    <span class="n">placing_df</span> <span class="o">=</span> <span class="n">placing_df</span><span class="p">[[</span><span class="s1">&#39;market_id&#39;</span><span class="p">,</span> <span class="s1">&#39;cloth_number&#39;</span><span class="p">,</span> <span class="s1">&#39;placing&#39;</span><span class="p">]]</span>
<a id="__codelineno-5-261" name="__codelineno-5-261" href="#__codelineno-5-261"></a>
<a id="__codelineno-5-262" name="__codelineno-5-262" href="#__codelineno-5-262"></a>    <span class="k">return</span> <span class="n">placing_df</span>
</code></pre></div>
<h2 id="discord_helperspy">discord_helpers.py</h2>
<p>Now if you didn't want to send messages to a Discord or other location, this next section can be disregarded (and some other function references higher up will need to be removed)</p>
<p>This code will send formatted text blocks to your chosen Discord channel. Other formats are possible.
The text blocks are optimised for viewing on Desktop and will overflow when viewed on the mobile app.</p>
<p>We've outlined the race results that we want to send but we also want some other alerts for scratchings, voided markets and other interesting things</p>
<ul>
<li><strong>Longshot Winners</strong> (WIN market winner has a BSP over $50)</li>
<li><strong>Short Priced Losers</strong> (WIN market loser has a BSP under $1.50)</li>
<li><strong>Sick Beat</strong> (WIN market loser has a min price matched less than $1.10)</li>
<li><strong>Victory Snatcher</strong> (WIN market winner has a BSP under $50 and trades at over $100 inplay)</li>
<li><strong>Dead Heat</strong> (More than 1 winner in WIN market)</li>
<li><strong>Short Price Scramble</strong> (More than 2 runners trade under $1.50 or more than 3 trade under $2)</li>
<li><strong>Super Crunchy</strong> (Runner implied win probability improved by more than 10% between scheduled off and BSP)</li>
<li><strong>Set Adrift</strong> (Runner implied win probability worsened by more than 10% between scheduled off and BSP)</li>
<li><strong>Late Scratching</strong> (Runner scratched in last 10 minutes before race or after race)</li>
<li><strong>Voided Market</strong> (Market settled with all runners having status <em>REMOVED</em>)</li>
</ul>
<div class="admonition info">
<p class="admonition-title">Set Adrift</p>
<p>The Set Adrift alert for a Harness race will usually indicate a runner galloping in the score-up!</p>
</div>
<div class="highlight"><span class="filename">Discord Helpers</span><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">betfairlightweight.resources</span><span class="w"> </span><span class="kn">import</span> <span class="n">MarketBook</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">flumine.baseflumine</span><span class="w"> </span><span class="kn">import</span> <span class="n">Market</span>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">pytz</span>
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a>
<a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a><span class="k">def</span><span class="w"> </span><span class="nf">send_discord_message</span><span class="p">(</span><span class="n">message</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">discord_webhook_url</span><span class="p">):</span>
<a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a>    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">message</span><span class="p">}</span>
<a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a>
<a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a>        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">discord_webhook_url</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">payload</span><span class="p">)</span>
<a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a>        <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
<a id="__codelineno-6-14" name="__codelineno-6-14" href="#__codelineno-6-14"></a>    <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-6-15" name="__codelineno-6-15" href="#__codelineno-6-15"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to send message to Discord: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-6-16" name="__codelineno-6-16" href="#__codelineno-6-16"></a>
<a id="__codelineno-6-17" name="__codelineno-6-17" href="#__codelineno-6-17"></a><span class="k">def</span><span class="w"> </span><span class="nf">format_row_message</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">include_bsp</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">include_ltp</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">extra_fields</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-6-18" name="__codelineno-6-18" href="#__codelineno-6-18"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-6-19" name="__codelineno-6-19" href="#__codelineno-6-19"></a><span class="sd">    Format a message line for a runner.</span>
<a id="__codelineno-6-20" name="__codelineno-6-20" href="#__codelineno-6-20"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-6-21" name="__codelineno-6-21" href="#__codelineno-6-21"></a>    <span class="c1"># Market-level details</span>
<a id="__codelineno-6-22" name="__codelineno-6-22" href="#__codelineno-6-22"></a>    <span class="n">market_details</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-6-23" name="__codelineno-6-23" href="#__codelineno-6-23"></a>        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;sport_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> - (</span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;event_country&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">) </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;track&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> - &quot;</span>
<a id="__codelineno-6-24" name="__codelineno-6-24" href="#__codelineno-6-24"></a>        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;market_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;market_time&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-6-25" name="__codelineno-6-25" href="#__codelineno-6-25"></a>    <span class="p">)</span>
<a id="__codelineno-6-26" name="__codelineno-6-26" href="#__codelineno-6-26"></a>
<a id="__codelineno-6-27" name="__codelineno-6-27" href="#__codelineno-6-27"></a>    <span class="c1"># Runner-level details</span>
<a id="__codelineno-6-28" name="__codelineno-6-28" href="#__codelineno-6-28"></a>    <span class="n">runner_parts</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;runner_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
<a id="__codelineno-6-29" name="__codelineno-6-29" href="#__codelineno-6-29"></a>
<a id="__codelineno-6-30" name="__codelineno-6-30" href="#__codelineno-6-30"></a>    <span class="k">if</span> <span class="n">include_bsp</span><span class="p">:</span>
<a id="__codelineno-6-31" name="__codelineno-6-31" href="#__codelineno-6-31"></a>        <span class="n">runner_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;BSP: </span><span class="si">{</span><span class="n">safe_round</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;runner_bsp&#39;</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-6-32" name="__codelineno-6-32" href="#__codelineno-6-32"></a>    <span class="k">if</span> <span class="n">include_ltp</span><span class="p">:</span>
<a id="__codelineno-6-33" name="__codelineno-6-33" href="#__codelineno-6-33"></a>        <span class="n">runner_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;LTP: </span><span class="si">{</span><span class="n">safe_round</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;runner_ltp_at_scheduled_off&#39;</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-6-34" name="__codelineno-6-34" href="#__codelineno-6-34"></a>
<a id="__codelineno-6-35" name="__codelineno-6-35" href="#__codelineno-6-35"></a>    <span class="k">if</span> <span class="n">extra_fields</span><span class="p">:</span>
<a id="__codelineno-6-36" name="__codelineno-6-36" href="#__codelineno-6-36"></a>        <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">extra_fields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-6-37" name="__codelineno-6-37" href="#__codelineno-6-37"></a>            <span class="n">runner_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">safe_round</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-6-38" name="__codelineno-6-38" href="#__codelineno-6-38"></a>
<a id="__codelineno-6-39" name="__codelineno-6-39" href="#__codelineno-6-39"></a>    <span class="n">runner_details</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">runner_parts</span><span class="p">)</span>
<a id="__codelineno-6-40" name="__codelineno-6-40" href="#__codelineno-6-40"></a>
<a id="__codelineno-6-41" name="__codelineno-6-41" href="#__codelineno-6-41"></a>    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">market_details</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">runner_details</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-6-42" name="__codelineno-6-42" href="#__codelineno-6-42"></a>
<a id="__codelineno-6-43" name="__codelineno-6-43" href="#__codelineno-6-43"></a><span class="k">def</span><span class="w"> </span><span class="nf">safe_round</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
<a id="__codelineno-6-44" name="__codelineno-6-44" href="#__codelineno-6-44"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Round if numeric, otherwise return as string.&quot;&quot;&quot;</span>
<a id="__codelineno-6-45" name="__codelineno-6-45" href="#__codelineno-6-45"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-6-46" name="__codelineno-6-46" href="#__codelineno-6-46"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
<a id="__codelineno-6-47" name="__codelineno-6-47" href="#__codelineno-6-47"></a>            <span class="k">return</span> <span class="nb">round</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">places</span><span class="p">)</span>
<a id="__codelineno-6-48" name="__codelineno-6-48" href="#__codelineno-6-48"></a>        <span class="k">return</span> <span class="n">value</span>  <span class="c1"># leave strings and others untouched</span>
<a id="__codelineno-6-49" name="__codelineno-6-49" href="#__codelineno-6-49"></a>    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<a id="__codelineno-6-50" name="__codelineno-6-50" href="#__codelineno-6-50"></a>        <span class="k">return</span> <span class="n">value</span>
<a id="__codelineno-6-51" name="__codelineno-6-51" href="#__codelineno-6-51"></a>
<a id="__codelineno-6-52" name="__codelineno-6-52" href="#__codelineno-6-52"></a><span class="k">def</span><span class="w"> </span><span class="nf">wrap_code_block</span><span class="p">(</span><span class="n">message</span><span class="p">):</span>
<a id="__codelineno-6-53" name="__codelineno-6-53" href="#__codelineno-6-53"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Wrap a message in a Discord code block.&quot;&quot;&quot;</span>
<a id="__codelineno-6-54" name="__codelineno-6-54" href="#__codelineno-6-54"></a>    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;```</span><span class="se">\n</span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="se">\n</span><span class="s2">```&quot;</span>
<a id="__codelineno-6-55" name="__codelineno-6-55" href="#__codelineno-6-55"></a>
<a id="__codelineno-6-56" name="__codelineno-6-56" href="#__codelineno-6-56"></a><span class="k">def</span><span class="w"> </span><span class="nf">alert_longshot</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">webhook</span><span class="p">):</span>
<a id="__codelineno-6-57" name="__codelineno-6-57" href="#__codelineno-6-57"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
<a id="__codelineno-6-58" name="__codelineno-6-58" href="#__codelineno-6-58"></a>        <span class="n">row</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-6-59" name="__codelineno-6-59" href="#__codelineno-6-59"></a>        <span class="n">msg</span> <span class="o">=</span> <span class="n">format_row_message</span><span class="p">(</span><span class="n">row</span><span class="p">,</span>
<a id="__codelineno-6-60" name="__codelineno-6-60" href="#__codelineno-6-60"></a>                                <span class="s2">&quot;LONGSHOT WINNER ALERT&quot;</span><span class="p">,</span>
<a id="__codelineno-6-61" name="__codelineno-6-61" href="#__codelineno-6-61"></a>                                <span class="n">extra_fields</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;runner_status&#39;</span><span class="p">:</span> <span class="s1">&#39;Result&#39;</span><span class="p">})</span>
<a id="__codelineno-6-62" name="__codelineno-6-62" href="#__codelineno-6-62"></a>        <span class="n">send_discord_message</span><span class="p">(</span><span class="n">wrap_code_block</span><span class="p">(</span><span class="n">msg</span><span class="p">),</span> <span class="n">webhook</span><span class="p">)</span>
<a id="__codelineno-6-63" name="__codelineno-6-63" href="#__codelineno-6-63"></a>
<a id="__codelineno-6-64" name="__codelineno-6-64" href="#__codelineno-6-64"></a><span class="k">def</span><span class="w"> </span><span class="nf">alert_fave_soils_the_bed</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">webhook</span><span class="p">):</span>
<a id="__codelineno-6-65" name="__codelineno-6-65" href="#__codelineno-6-65"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
<a id="__codelineno-6-66" name="__codelineno-6-66" href="#__codelineno-6-66"></a>        <span class="n">row</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-6-67" name="__codelineno-6-67" href="#__codelineno-6-67"></a>        <span class="n">msg</span> <span class="o">=</span> <span class="n">format_row_message</span><span class="p">(</span><span class="n">row</span><span class="p">,</span>
<a id="__codelineno-6-68" name="__codelineno-6-68" href="#__codelineno-6-68"></a>                                <span class="s2">&quot;NOT SO SURE THING ALERT&quot;</span><span class="p">,</span>
<a id="__codelineno-6-69" name="__codelineno-6-69" href="#__codelineno-6-69"></a>                                <span class="n">extra_fields</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;runner_status&#39;</span><span class="p">:</span> <span class="s1">&#39;Result&#39;</span><span class="p">})</span>
<a id="__codelineno-6-70" name="__codelineno-6-70" href="#__codelineno-6-70"></a>        <span class="n">send_discord_message</span><span class="p">(</span><span class="n">wrap_code_block</span><span class="p">(</span><span class="n">msg</span><span class="p">),</span> <span class="n">webhook</span><span class="p">)</span>
<a id="__codelineno-6-71" name="__codelineno-6-71" href="#__codelineno-6-71"></a>
<a id="__codelineno-6-72" name="__codelineno-6-72" href="#__codelineno-6-72"></a><span class="k">def</span><span class="w"> </span><span class="nf">alert_short_priced_losers</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">webhook</span><span class="p">):</span>
<a id="__codelineno-6-73" name="__codelineno-6-73" href="#__codelineno-6-73"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
<a id="__codelineno-6-74" name="__codelineno-6-74" href="#__codelineno-6-74"></a>        <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-6-75" name="__codelineno-6-75" href="#__codelineno-6-75"></a>            <span class="n">format_row_message</span><span class="p">(</span>
<a id="__codelineno-6-76" name="__codelineno-6-76" href="#__codelineno-6-76"></a>                <span class="n">row</span><span class="p">,</span> <span class="s2">&quot;SICK BEAT ALERT&quot;</span><span class="p">,</span> <span class="n">include_bsp</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
<a id="__codelineno-6-77" name="__codelineno-6-77" href="#__codelineno-6-77"></a>                <span class="n">extra_fields</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;runner_min_price_total&#39;</span><span class="p">:</span> <span class="s1">&#39;Min Price&#39;</span><span class="p">,</span>
<a id="__codelineno-6-78" name="__codelineno-6-78" href="#__codelineno-6-78"></a>                              <span class="s1">&#39;runner_status&#39;</span><span class="p">:</span> <span class="s1">&#39;Result&#39;</span><span class="p">}</span>
<a id="__codelineno-6-79" name="__codelineno-6-79" href="#__codelineno-6-79"></a>            <span class="p">)</span>
<a id="__codelineno-6-80" name="__codelineno-6-80" href="#__codelineno-6-80"></a>            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()</span>
<a id="__codelineno-6-81" name="__codelineno-6-81" href="#__codelineno-6-81"></a>        <span class="p">]</span>
<a id="__codelineno-6-82" name="__codelineno-6-82" href="#__codelineno-6-82"></a>        <span class="n">final_msg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span>
<a id="__codelineno-6-83" name="__codelineno-6-83" href="#__codelineno-6-83"></a>        <span class="n">send_discord_message</span><span class="p">(</span><span class="n">wrap_code_block</span><span class="p">(</span><span class="n">final_msg</span><span class="p">),</span> <span class="n">webhook</span><span class="p">)</span>
<a id="__codelineno-6-84" name="__codelineno-6-84" href="#__codelineno-6-84"></a>
<a id="__codelineno-6-85" name="__codelineno-6-85" href="#__codelineno-6-85"></a><span class="k">def</span><span class="w"> </span><span class="nf">alert_multiple_shorties</span><span class="p">(</span><span class="n">cond_a_df</span><span class="p">,</span> <span class="n">cond_b_df</span><span class="p">,</span> <span class="n">webhook</span><span class="p">):</span>
<a id="__codelineno-6-86" name="__codelineno-6-86" href="#__codelineno-6-86"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-6-87" name="__codelineno-6-87" href="#__codelineno-6-87"></a><span class="sd">    Trigger alert if more than 3 runners from cond_a_df OR more than 2 from cond_b_df.</span>
<a id="__codelineno-6-88" name="__codelineno-6-88" href="#__codelineno-6-88"></a><span class="sd">    Merges the two sets, removes duplicates safely, and sends Discord alert.</span>
<a id="__codelineno-6-89" name="__codelineno-6-89" href="#__codelineno-6-89"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-6-90" name="__codelineno-6-90" href="#__codelineno-6-90"></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cond_a_df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">cond_b_df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
<a id="__codelineno-6-91" name="__codelineno-6-91" href="#__codelineno-6-91"></a>        <span class="c1"># Combine the two dataframes</span>
<a id="__codelineno-6-92" name="__codelineno-6-92" href="#__codelineno-6-92"></a>        <span class="n">combined</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">cond_a_df</span><span class="p">,</span> <span class="n">cond_b_df</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-6-93" name="__codelineno-6-93" href="#__codelineno-6-93"></a>
<a id="__codelineno-6-94" name="__codelineno-6-94" href="#__codelineno-6-94"></a>        <span class="c1"># Drop duplicates based only on key runner identifiers</span>
<a id="__codelineno-6-95" name="__codelineno-6-95" href="#__codelineno-6-95"></a>        <span class="n">id_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sport_name&#39;</span><span class="p">,</span> <span class="s1">&#39;event_country&#39;</span><span class="p">,</span> <span class="s1">&#39;track&#39;</span><span class="p">,</span> <span class="s1">&#39;market_name&#39;</span><span class="p">,</span> <span class="s1">&#39;runner_name&#39;</span><span class="p">]</span>
<a id="__codelineno-6-96" name="__codelineno-6-96" href="#__codelineno-6-96"></a>        <span class="n">qualifying</span> <span class="o">=</span> <span class="n">combined</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="n">id_cols</span><span class="p">)</span>
<a id="__codelineno-6-97" name="__codelineno-6-97" href="#__codelineno-6-97"></a>
<a id="__codelineno-6-98" name="__codelineno-6-98" href="#__codelineno-6-98"></a>        <span class="k">if</span> <span class="n">qualifying</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
<a id="__codelineno-6-99" name="__codelineno-6-99" href="#__codelineno-6-99"></a>            <span class="k">return</span>
<a id="__codelineno-6-100" name="__codelineno-6-100" href="#__codelineno-6-100"></a>
<a id="__codelineno-6-101" name="__codelineno-6-101" href="#__codelineno-6-101"></a>        <span class="c1"># Use the first row for market-level details</span>
<a id="__codelineno-6-102" name="__codelineno-6-102" href="#__codelineno-6-102"></a>        <span class="n">first_row</span> <span class="o">=</span> <span class="n">qualifying</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-6-103" name="__codelineno-6-103" href="#__codelineno-6-103"></a>        <span class="n">header</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-6-104" name="__codelineno-6-104" href="#__codelineno-6-104"></a>            <span class="sa">f</span><span class="s2">&quot;SHORT PRICE SCRAMBLE ALERT</span><span class="se">\n</span><span class="s2">&quot;</span>
<a id="__codelineno-6-105" name="__codelineno-6-105" href="#__codelineno-6-105"></a>            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">first_row</span><span class="p">[</span><span class="s1">&#39;sport_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> - (</span><span class="si">{</span><span class="n">first_row</span><span class="p">[</span><span class="s1">&#39;event_country&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">) </span><span class="si">{</span><span class="n">first_row</span><span class="p">[</span><span class="s1">&#39;track&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> - &quot;</span>
<a id="__codelineno-6-106" name="__codelineno-6-106" href="#__codelineno-6-106"></a>            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">first_row</span><span class="p">[</span><span class="s1">&#39;market_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">first_row</span><span class="p">[</span><span class="s1">&#39;market_time&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-6-107" name="__codelineno-6-107" href="#__codelineno-6-107"></a>        <span class="p">)</span>
<a id="__codelineno-6-108" name="__codelineno-6-108" href="#__codelineno-6-108"></a>
<a id="__codelineno-6-109" name="__codelineno-6-109" href="#__codelineno-6-109"></a>        <span class="c1"># Build runner lines only</span>
<a id="__codelineno-6-110" name="__codelineno-6-110" href="#__codelineno-6-110"></a>        <span class="n">runner_lines</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-6-111" name="__codelineno-6-111" href="#__codelineno-6-111"></a>        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">qualifying</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
<a id="__codelineno-6-112" name="__codelineno-6-112" href="#__codelineno-6-112"></a>            <span class="n">runner_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
<a id="__codelineno-6-113" name="__codelineno-6-113" href="#__codelineno-6-113"></a>                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;runner_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> &quot;</span>
<a id="__codelineno-6-114" name="__codelineno-6-114" href="#__codelineno-6-114"></a>                <span class="sa">f</span><span class="s2">&quot;(BSP: </span><span class="si">{</span><span class="n">safe_round</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;runner_bsp&#39;</span><span class="p">))</span><span class="si">}</span><span class="s2">) &quot;</span>
<a id="__codelineno-6-115" name="__codelineno-6-115" href="#__codelineno-6-115"></a>                <span class="sa">f</span><span class="s2">&quot;(Min Price: </span><span class="si">{</span><span class="n">safe_round</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;runner_min_price_total&#39;</span><span class="p">))</span><span class="si">}</span><span class="s2">) &quot;</span>
<a id="__codelineno-6-116" name="__codelineno-6-116" href="#__codelineno-6-116"></a>                <span class="sa">f</span><span class="s2">&quot;Status: </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;runner_status&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-6-117" name="__codelineno-6-117" href="#__codelineno-6-117"></a>            <span class="p">)</span>
<a id="__codelineno-6-118" name="__codelineno-6-118" href="#__codelineno-6-118"></a>
<a id="__codelineno-6-119" name="__codelineno-6-119" href="#__codelineno-6-119"></a>        <span class="c1"># Combine into one message</span>
<a id="__codelineno-6-120" name="__codelineno-6-120" href="#__codelineno-6-120"></a>        <span class="n">final_msg</span> <span class="o">=</span> <span class="n">header</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">runner_lines</span><span class="p">)</span>
<a id="__codelineno-6-121" name="__codelineno-6-121" href="#__codelineno-6-121"></a>
<a id="__codelineno-6-122" name="__codelineno-6-122" href="#__codelineno-6-122"></a>        <span class="n">send_discord_message</span><span class="p">(</span><span class="n">wrap_code_block</span><span class="p">(</span><span class="n">final_msg</span><span class="p">),</span> <span class="n">webhook</span><span class="p">)</span>
<a id="__codelineno-6-123" name="__codelineno-6-123" href="#__codelineno-6-123"></a>
<a id="__codelineno-6-124" name="__codelineno-6-124" href="#__codelineno-6-124"></a><span class="k">def</span><span class="w"> </span><span class="nf">alert_traders_dream</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">webhook</span><span class="p">):</span>
<a id="__codelineno-6-125" name="__codelineno-6-125" href="#__codelineno-6-125"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
<a id="__codelineno-6-126" name="__codelineno-6-126" href="#__codelineno-6-126"></a>        <span class="n">row</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-6-127" name="__codelineno-6-127" href="#__codelineno-6-127"></a>        <span class="n">extra</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-6-128" name="__codelineno-6-128" href="#__codelineno-6-128"></a>            <span class="s1">&#39;runner_max_price_total&#39;</span><span class="p">:</span> <span class="s1">&#39;Max Price&#39;</span><span class="p">,</span>
<a id="__codelineno-6-129" name="__codelineno-6-129" href="#__codelineno-6-129"></a>            <span class="s1">&#39;runner_max_price_traded_before_scheduled_off&#39;</span><span class="p">:</span> <span class="s1">&#39;Max Pre-Off&#39;</span><span class="p">,</span>
<a id="__codelineno-6-130" name="__codelineno-6-130" href="#__codelineno-6-130"></a>            <span class="s1">&#39;runner_status&#39;</span><span class="p">:</span> <span class="s1">&#39;Result&#39;</span>
<a id="__codelineno-6-131" name="__codelineno-6-131" href="#__codelineno-6-131"></a>        <span class="p">}</span>
<a id="__codelineno-6-132" name="__codelineno-6-132" href="#__codelineno-6-132"></a>        <span class="n">msg</span> <span class="o">=</span> <span class="n">format_row_message</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="s2">&quot;VICTORY SNATCHER ALERT&quot;</span><span class="p">,</span> <span class="n">extra_fields</span><span class="o">=</span><span class="n">extra</span><span class="p">)</span>
<a id="__codelineno-6-133" name="__codelineno-6-133" href="#__codelineno-6-133"></a>        <span class="n">send_discord_message</span><span class="p">(</span><span class="n">wrap_code_block</span><span class="p">(</span><span class="n">msg</span><span class="p">),</span> <span class="n">webhook</span><span class="p">)</span>
<a id="__codelineno-6-134" name="__codelineno-6-134" href="#__codelineno-6-134"></a>
<a id="__codelineno-6-135" name="__codelineno-6-135" href="#__codelineno-6-135"></a><span class="k">def</span><span class="w"> </span><span class="nf">alert_deadheat</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">webhook</span><span class="p">):</span>
<a id="__codelineno-6-136" name="__codelineno-6-136" href="#__codelineno-6-136"></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-6-137" name="__codelineno-6-137" href="#__codelineno-6-137"></a>        <span class="n">base_info</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-6-138" name="__codelineno-6-138" href="#__codelineno-6-138"></a>        <span class="n">winners</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
<a id="__codelineno-6-139" name="__codelineno-6-139" href="#__codelineno-6-139"></a>            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;runner_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (BSP: </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;runner_bsp&#39;</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>
<a id="__codelineno-6-140" name="__codelineno-6-140" href="#__codelineno-6-140"></a>            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()</span>
<a id="__codelineno-6-141" name="__codelineno-6-141" href="#__codelineno-6-141"></a>        <span class="p">])</span>
<a id="__codelineno-6-142" name="__codelineno-6-142" href="#__codelineno-6-142"></a>        <span class="n">message</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-6-143" name="__codelineno-6-143" href="#__codelineno-6-143"></a>            <span class="sa">f</span><span class="s2">&quot;DEAD HEAT ALERT</span><span class="se">\n</span><span class="s2">&quot;</span>
<a id="__codelineno-6-144" name="__codelineno-6-144" href="#__codelineno-6-144"></a>            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_info</span><span class="p">[</span><span class="s1">&#39;sport_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> - (</span><span class="si">{</span><span class="n">base_info</span><span class="p">[</span><span class="s1">&#39;event_country&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">) </span><span class="si">{</span><span class="n">base_info</span><span class="p">[</span><span class="s1">&#39;track&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> - &quot;</span>
<a id="__codelineno-6-145" name="__codelineno-6-145" href="#__codelineno-6-145"></a>            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_info</span><span class="p">[</span><span class="s1">&#39;market_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">base_info</span><span class="p">[</span><span class="s1">&#39;market_time&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
<a id="__codelineno-6-146" name="__codelineno-6-146" href="#__codelineno-6-146"></a>            <span class="sa">f</span><span class="s2">&quot;Winners: </span><span class="si">{</span><span class="n">winners</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-6-147" name="__codelineno-6-147" href="#__codelineno-6-147"></a>        <span class="p">)</span>
<a id="__codelineno-6-148" name="__codelineno-6-148" href="#__codelineno-6-148"></a>        <span class="n">send_discord_message</span><span class="p">(</span><span class="n">wrap_code_block</span><span class="p">(</span><span class="n">message</span><span class="p">),</span> <span class="n">webhook</span><span class="p">)</span>
<a id="__codelineno-6-149" name="__codelineno-6-149" href="#__codelineno-6-149"></a>
<a id="__codelineno-6-150" name="__codelineno-6-150" href="#__codelineno-6-150"></a><span class="k">def</span><span class="w"> </span><span class="nf">alert_super_crunchy</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">webhook</span><span class="p">):</span>
<a id="__codelineno-6-151" name="__codelineno-6-151" href="#__codelineno-6-151"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
<a id="__codelineno-6-152" name="__codelineno-6-152" href="#__codelineno-6-152"></a>        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
<a id="__codelineno-6-153" name="__codelineno-6-153" href="#__codelineno-6-153"></a>            <span class="n">msg</span> <span class="o">=</span> <span class="n">format_row_message</span><span class="p">(</span><span class="n">row</span><span class="p">,</span>
<a id="__codelineno-6-154" name="__codelineno-6-154" href="#__codelineno-6-154"></a>                                    <span class="s2">&quot;SUPER CRUNCHY ALERT&quot;</span><span class="p">,</span>
<a id="__codelineno-6-155" name="__codelineno-6-155" href="#__codelineno-6-155"></a>                                    <span class="n">include_ltp</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-6-156" name="__codelineno-6-156" href="#__codelineno-6-156"></a>                                    <span class="n">extra_fields</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;runner_status&#39;</span><span class="p">:</span> <span class="s1">&#39;Result&#39;</span><span class="p">})</span>
<a id="__codelineno-6-157" name="__codelineno-6-157" href="#__codelineno-6-157"></a>            <span class="n">send_discord_message</span><span class="p">(</span><span class="n">wrap_code_block</span><span class="p">(</span><span class="n">msg</span><span class="p">),</span> <span class="n">webhook</span><span class="p">)</span>
<a id="__codelineno-6-158" name="__codelineno-6-158" href="#__codelineno-6-158"></a>
<a id="__codelineno-6-159" name="__codelineno-6-159" href="#__codelineno-6-159"></a><span class="k">def</span><span class="w"> </span><span class="nf">alert_set_adrift</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">webhook</span><span class="p">):</span>
<a id="__codelineno-6-160" name="__codelineno-6-160" href="#__codelineno-6-160"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
<a id="__codelineno-6-161" name="__codelineno-6-161" href="#__codelineno-6-161"></a>        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
<a id="__codelineno-6-162" name="__codelineno-6-162" href="#__codelineno-6-162"></a>            <span class="n">msg</span> <span class="o">=</span> <span class="n">format_row_message</span><span class="p">(</span><span class="n">row</span><span class="p">,</span>
<a id="__codelineno-6-163" name="__codelineno-6-163" href="#__codelineno-6-163"></a>                                    <span class="s2">&quot;SET ADRIFT ALERT&quot;</span><span class="p">,</span>
<a id="__codelineno-6-164" name="__codelineno-6-164" href="#__codelineno-6-164"></a>                                    <span class="n">include_ltp</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-6-165" name="__codelineno-6-165" href="#__codelineno-6-165"></a>                                    <span class="n">extra_fields</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;runner_status&#39;</span><span class="p">:</span> <span class="s1">&#39;Result&#39;</span><span class="p">})</span>
<a id="__codelineno-6-166" name="__codelineno-6-166" href="#__codelineno-6-166"></a>            <span class="n">send_discord_message</span><span class="p">(</span><span class="n">wrap_code_block</span><span class="p">(</span><span class="n">msg</span><span class="p">),</span> <span class="n">webhook</span><span class="p">)</span>
<a id="__codelineno-6-167" name="__codelineno-6-167" href="#__codelineno-6-167"></a>
<a id="__codelineno-6-168" name="__codelineno-6-168" href="#__codelineno-6-168"></a><span class="k">def</span><span class="w"> </span><span class="nf">alert_late_scratchings</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">webhook</span><span class="p">):</span>
<a id="__codelineno-6-169" name="__codelineno-6-169" href="#__codelineno-6-169"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-6-170" name="__codelineno-6-170" href="#__codelineno-6-170"></a><span class="sd">    Send an alert for late scratchings.</span>
<a id="__codelineno-6-171" name="__codelineno-6-171" href="#__codelineno-6-171"></a><span class="sd">    Includes removal time and whether the scratching was before or after the race.</span>
<a id="__codelineno-6-172" name="__codelineno-6-172" href="#__codelineno-6-172"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-6-173" name="__codelineno-6-173" href="#__codelineno-6-173"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
<a id="__codelineno-6-174" name="__codelineno-6-174" href="#__codelineno-6-174"></a>        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
<a id="__codelineno-6-175" name="__codelineno-6-175" href="#__codelineno-6-175"></a>            <span class="c1"># Determine before/after relative to race start</span>
<a id="__codelineno-6-176" name="__codelineno-6-176" href="#__codelineno-6-176"></a>            <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;runner_removal_date&#39;</span><span class="p">],</span><span class="nb">format</span><span class="o">=</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">,</span><span class="n">errors</span><span class="o">=</span><span class="s1">&#39;coerce&#39;</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;inplay_time_local&#39;</span><span class="p">],</span><span class="nb">format</span><span class="o">=</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">,</span><span class="n">errors</span><span class="o">=</span><span class="s1">&#39;coerce&#39;</span><span class="p">):</span>
<a id="__codelineno-6-177" name="__codelineno-6-177" href="#__codelineno-6-177"></a>                <span class="n">timing</span> <span class="o">=</span> <span class="s2">&quot;Before Race&quot;</span>
<a id="__codelineno-6-178" name="__codelineno-6-178" href="#__codelineno-6-178"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-6-179" name="__codelineno-6-179" href="#__codelineno-6-179"></a>                <span class="n">timing</span> <span class="o">=</span> <span class="s2">&quot;After Race&quot;</span>
<a id="__codelineno-6-180" name="__codelineno-6-180" href="#__codelineno-6-180"></a>
<a id="__codelineno-6-181" name="__codelineno-6-181" href="#__codelineno-6-181"></a>            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-6-182" name="__codelineno-6-182" href="#__codelineno-6-182"></a>                <span class="n">format_row_message</span><span class="p">(</span>
<a id="__codelineno-6-183" name="__codelineno-6-183" href="#__codelineno-6-183"></a>                    <span class="n">row</span><span class="p">,</span>
<a id="__codelineno-6-184" name="__codelineno-6-184" href="#__codelineno-6-184"></a>                    <span class="s2">&quot;LATE SCRATCHING ALERT&quot;</span><span class="p">,</span>
<a id="__codelineno-6-185" name="__codelineno-6-185" href="#__codelineno-6-185"></a>                    <span class="n">include_bsp</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-6-186" name="__codelineno-6-186" href="#__codelineno-6-186"></a>                    <span class="n">include_ltp</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-6-187" name="__codelineno-6-187" href="#__codelineno-6-187"></a>                    <span class="n">extra_fields</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-6-188" name="__codelineno-6-188" href="#__codelineno-6-188"></a>                        <span class="s1">&#39;runner_removal_date&#39;</span><span class="p">:</span> <span class="s1">&#39;Removal Time&#39;</span><span class="p">,</span>
<a id="__codelineno-6-189" name="__codelineno-6-189" href="#__codelineno-6-189"></a>                        <span class="s1">&#39;runner_status&#39;</span><span class="p">:</span> <span class="s1">&#39;Result&#39;</span>
<a id="__codelineno-6-190" name="__codelineno-6-190" href="#__codelineno-6-190"></a>                    <span class="p">}</span>
<a id="__codelineno-6-191" name="__codelineno-6-191" href="#__codelineno-6-191"></a>                <span class="p">)</span>
<a id="__codelineno-6-192" name="__codelineno-6-192" href="#__codelineno-6-192"></a>                <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot; (</span><span class="si">{</span><span class="n">timing</span><span class="si">}</span><span class="s2">)&quot;</span>
<a id="__codelineno-6-193" name="__codelineno-6-193" href="#__codelineno-6-193"></a>            <span class="p">)</span>
<a id="__codelineno-6-194" name="__codelineno-6-194" href="#__codelineno-6-194"></a>
<a id="__codelineno-6-195" name="__codelineno-6-195" href="#__codelineno-6-195"></a>            <span class="n">send_discord_message</span><span class="p">(</span><span class="n">wrap_code_block</span><span class="p">(</span><span class="n">msg</span><span class="p">),</span> <span class="n">webhook</span><span class="p">)</span>
<a id="__codelineno-6-196" name="__codelineno-6-196" href="#__codelineno-6-196"></a>
<a id="__codelineno-6-197" name="__codelineno-6-197" href="#__codelineno-6-197"></a><span class="k">def</span><span class="w"> </span><span class="nf">run_all_discord_alerts</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">discord_webhook_url</span><span class="p">):</span>
<a id="__codelineno-6-198" name="__codelineno-6-198" href="#__codelineno-6-198"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-6-199" name="__codelineno-6-199" href="#__codelineno-6-199"></a>        <span class="n">longshot_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;runner_bsp&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">50</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;runner_status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;WINNER&#39;</span><span class="p">)]</span>
<a id="__codelineno-6-200" name="__codelineno-6-200" href="#__codelineno-6-200"></a>        <span class="n">losing_fave_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;runner_bsp&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">1.5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;runner_status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;LOSER&#39;</span><span class="p">)]</span>
<a id="__codelineno-6-201" name="__codelineno-6-201" href="#__codelineno-6-201"></a>        <span class="n">short_priced_losers_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;runner_min_price_total&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mf">1.1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;runner_status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;LOSER&#39;</span><span class="p">)]</span>
<a id="__codelineno-6-202" name="__codelineno-6-202" href="#__codelineno-6-202"></a>        <span class="n">cond_a_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;runner_min_price_total&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">]</span>
<a id="__codelineno-6-203" name="__codelineno-6-203" href="#__codelineno-6-203"></a>        <span class="n">cond_b_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;runner_min_price_total&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">1.5</span><span class="p">]</span>
<a id="__codelineno-6-204" name="__codelineno-6-204" href="#__codelineno-6-204"></a>        <span class="n">traders_dream_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span>
<a id="__codelineno-6-205" name="__codelineno-6-205" href="#__codelineno-6-205"></a>            <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;runner_max_price_total&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span> <span class="o">&amp;</span>
<a id="__codelineno-6-206" name="__codelineno-6-206" href="#__codelineno-6-206"></a>            <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;runner_max_price_total&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;runner_max_price_traded_before_scheduled_off&#39;</span><span class="p">])</span> <span class="o">&amp;</span>
<a id="__codelineno-6-207" name="__codelineno-6-207" href="#__codelineno-6-207"></a>            <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;runner_bsp&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="p">)</span> <span class="o">&amp;</span>
<a id="__codelineno-6-208" name="__codelineno-6-208" href="#__codelineno-6-208"></a>            <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;runner_status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;WINNER&#39;</span><span class="p">)</span>
<a id="__codelineno-6-209" name="__codelineno-6-209" href="#__codelineno-6-209"></a>        <span class="p">]</span>
<a id="__codelineno-6-210" name="__codelineno-6-210" href="#__codelineno-6-210"></a>        <span class="n">winners_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;runner_status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;WINNER&#39;</span><span class="p">]</span>
<a id="__codelineno-6-211" name="__codelineno-6-211" href="#__codelineno-6-211"></a>        <span class="n">super_crunchy_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;runner_bsp&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;runner_ltp_at_scheduled_off&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mf">0.1</span><span class="p">]</span>
<a id="__codelineno-6-212" name="__codelineno-6-212" href="#__codelineno-6-212"></a>        <span class="n">set_adrift_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;runner_bsp&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;runner_ltp_at_scheduled_off&#39;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">0.1</span><span class="p">]</span>
<a id="__codelineno-6-213" name="__codelineno-6-213" href="#__codelineno-6-213"></a>
<a id="__codelineno-6-214" name="__codelineno-6-214" href="#__codelineno-6-214"></a>        <span class="c1"># Force both columns to datetime</span>
<a id="__codelineno-6-215" name="__codelineno-6-215" href="#__codelineno-6-215"></a>        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;runner_removal_date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;runner_removal_date&#39;</span><span class="p">],</span><span class="nb">format</span><span class="o">=</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">,</span><span class="n">errors</span><span class="o">=</span><span class="s1">&#39;coerce&#39;</span><span class="p">)</span>
<a id="__codelineno-6-216" name="__codelineno-6-216" href="#__codelineno-6-216"></a>        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;inplay_time_local&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;inplay_time_local&#39;</span><span class="p">],</span><span class="nb">format</span><span class="o">=</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">,</span><span class="n">errors</span><span class="o">=</span><span class="s1">&#39;coerce&#39;</span><span class="p">)</span>
<a id="__codelineno-6-217" name="__codelineno-6-217" href="#__codelineno-6-217"></a>
<a id="__codelineno-6-218" name="__codelineno-6-218" href="#__codelineno-6-218"></a>        <span class="c1"># Filter rows where conversion succeeded and runner was removed</span>
<a id="__codelineno-6-219" name="__codelineno-6-219" href="#__codelineno-6-219"></a>        <span class="n">late_scratchings_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span>
<a id="__codelineno-6-220" name="__codelineno-6-220" href="#__codelineno-6-220"></a>            <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;runner_status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;REMOVED&#39;</span><span class="p">)</span> <span class="o">&amp;</span>
<a id="__codelineno-6-221" name="__codelineno-6-221" href="#__codelineno-6-221"></a>            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;runner_removal_date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span> <span class="o">&amp;</span>
<a id="__codelineno-6-222" name="__codelineno-6-222" href="#__codelineno-6-222"></a>            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;inplay_time_local&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span>
<a id="__codelineno-6-223" name="__codelineno-6-223" href="#__codelineno-6-223"></a>        <span class="p">]</span>
<a id="__codelineno-6-224" name="__codelineno-6-224" href="#__codelineno-6-224"></a>
<a id="__codelineno-6-225" name="__codelineno-6-225" href="#__codelineno-6-225"></a>        <span class="c1"># Filter for removals within 10 minutes of the race</span>
<a id="__codelineno-6-226" name="__codelineno-6-226" href="#__codelineno-6-226"></a>        <span class="n">late_scratchings_df</span> <span class="o">=</span> <span class="n">late_scratchings_df</span><span class="p">[</span>
<a id="__codelineno-6-227" name="__codelineno-6-227" href="#__codelineno-6-227"></a>            <span class="p">(</span><span class="n">late_scratchings_df</span><span class="p">[</span><span class="s1">&#39;inplay_time_local&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">late_scratchings_df</span><span class="p">[</span><span class="s1">&#39;runner_removal_date&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span>
<a id="__codelineno-6-228" name="__codelineno-6-228" href="#__codelineno-6-228"></a>            <span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">10</span>
<a id="__codelineno-6-229" name="__codelineno-6-229" href="#__codelineno-6-229"></a>        <span class="p">]</span>
<a id="__codelineno-6-230" name="__codelineno-6-230" href="#__codelineno-6-230"></a>
<a id="__codelineno-6-231" name="__codelineno-6-231" href="#__codelineno-6-231"></a>        <span class="n">alert_longshot</span><span class="p">(</span><span class="n">longshot_df</span><span class="p">,</span> <span class="n">discord_webhook_url</span><span class="p">)</span>
<a id="__codelineno-6-232" name="__codelineno-6-232" href="#__codelineno-6-232"></a>        <span class="n">alert_fave_soils_the_bed</span><span class="p">(</span><span class="n">losing_fave_df</span><span class="p">,</span> <span class="n">discord_webhook_url</span><span class="p">)</span>
<a id="__codelineno-6-233" name="__codelineno-6-233" href="#__codelineno-6-233"></a>        <span class="n">alert_short_priced_losers</span><span class="p">(</span><span class="n">short_priced_losers_df</span><span class="p">,</span> <span class="n">discord_webhook_url</span><span class="p">)</span>
<a id="__codelineno-6-234" name="__codelineno-6-234" href="#__codelineno-6-234"></a>        <span class="n">alert_multiple_shorties</span><span class="p">(</span><span class="n">cond_a_df</span><span class="p">,</span> <span class="n">cond_b_df</span><span class="p">,</span> <span class="n">discord_webhook_url</span><span class="p">)</span>
<a id="__codelineno-6-235" name="__codelineno-6-235" href="#__codelineno-6-235"></a>        <span class="n">alert_traders_dream</span><span class="p">(</span><span class="n">traders_dream_df</span><span class="p">,</span> <span class="n">discord_webhook_url</span><span class="p">)</span>
<a id="__codelineno-6-236" name="__codelineno-6-236" href="#__codelineno-6-236"></a>        <span class="n">alert_deadheat</span><span class="p">(</span><span class="n">winners_df</span><span class="p">,</span> <span class="n">discord_webhook_url</span><span class="p">)</span>
<a id="__codelineno-6-237" name="__codelineno-6-237" href="#__codelineno-6-237"></a>        <span class="n">alert_super_crunchy</span><span class="p">(</span><span class="n">super_crunchy_df</span><span class="p">,</span> <span class="n">discord_webhook_url</span><span class="p">)</span>
<a id="__codelineno-6-238" name="__codelineno-6-238" href="#__codelineno-6-238"></a>        <span class="n">alert_set_adrift</span><span class="p">(</span><span class="n">set_adrift_df</span><span class="p">,</span> <span class="n">discord_webhook_url</span><span class="p">)</span>
<a id="__codelineno-6-239" name="__codelineno-6-239" href="#__codelineno-6-239"></a>        <span class="n">alert_late_scratchings</span><span class="p">(</span><span class="n">late_scratchings_df</span><span class="p">,</span> <span class="n">discord_webhook_url</span><span class="p">)</span>
<a id="__codelineno-6-240" name="__codelineno-6-240" href="#__codelineno-6-240"></a>
<a id="__codelineno-6-241" name="__codelineno-6-241" href="#__codelineno-6-241"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-6-242" name="__codelineno-6-242" href="#__codelineno-6-242"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error running alerts: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-6-243" name="__codelineno-6-243" href="#__codelineno-6-243"></a>
<a id="__codelineno-6-244" name="__codelineno-6-244" href="#__codelineno-6-244"></a><span class="k">def</span><span class="w"> </span><span class="nf">discord_placings_report</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">discord_webhook_url</span><span class="p">):</span>
<a id="__codelineno-6-245" name="__codelineno-6-245" href="#__codelineno-6-245"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-6-246" name="__codelineno-6-246" href="#__codelineno-6-246"></a>        <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
<a id="__codelineno-6-247" name="__codelineno-6-247" href="#__codelineno-6-247"></a>            <span class="k">return</span>
<a id="__codelineno-6-248" name="__codelineno-6-248" href="#__codelineno-6-248"></a>
<a id="__codelineno-6-249" name="__codelineno-6-249" href="#__codelineno-6-249"></a>        <span class="n">placed</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-6-250" name="__codelineno-6-250" href="#__codelineno-6-250"></a>
<a id="__codelineno-6-251" name="__codelineno-6-251" href="#__codelineno-6-251"></a>        <span class="c1"># Define custom order for placing</span>
<a id="__codelineno-6-252" name="__codelineno-6-252" href="#__codelineno-6-252"></a>        <span class="n">placing_order</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="s1">&#39;3&#39;</span><span class="p">,</span> <span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="s1">&#39;4&#39;</span><span class="p">]</span>
<a id="__codelineno-6-253" name="__codelineno-6-253" href="#__codelineno-6-253"></a>        <span class="n">placed</span><span class="p">[</span><span class="s1">&#39;placing_str&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">placed</span><span class="p">[</span><span class="s1">&#39;placing&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
<a id="__codelineno-6-254" name="__codelineno-6-254" href="#__codelineno-6-254"></a>
<a id="__codelineno-6-255" name="__codelineno-6-255" href="#__codelineno-6-255"></a>        <span class="c1"># Sorting based on placing order</span>
<a id="__codelineno-6-256" name="__codelineno-6-256" href="#__codelineno-6-256"></a>        <span class="n">placed</span><span class="p">[</span><span class="s1">&#39;placing_sort&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">placed</span><span class="p">[</span><span class="s1">&#39;placing_str&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
<a id="__codelineno-6-257" name="__codelineno-6-257" href="#__codelineno-6-257"></a>            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">placing_order</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">placing_order</span> <span class="k">else</span> <span class="mi">999</span>
<a id="__codelineno-6-258" name="__codelineno-6-258" href="#__codelineno-6-258"></a>        <span class="p">)</span>
<a id="__codelineno-6-259" name="__codelineno-6-259" href="#__codelineno-6-259"></a>
<a id="__codelineno-6-260" name="__codelineno-6-260" href="#__codelineno-6-260"></a>        <span class="c1"># Flag SCR runners</span>
<a id="__codelineno-6-261" name="__codelineno-6-261" href="#__codelineno-6-261"></a>        <span class="n">placed</span><span class="p">[</span><span class="s1">&#39;is_scr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">placed</span><span class="p">[</span><span class="s1">&#39;runner_bsp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span>
<a id="__codelineno-6-262" name="__codelineno-6-262" href="#__codelineno-6-262"></a>
<a id="__codelineno-6-263" name="__codelineno-6-263" href="#__codelineno-6-263"></a>        <span class="c1"># Sort so non-SCR first, then SCR, then by placing_sort</span>
<a id="__codelineno-6-264" name="__codelineno-6-264" href="#__codelineno-6-264"></a>        <span class="n">placed_sorted</span> <span class="o">=</span> <span class="n">placed</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;is_scr&#39;</span><span class="p">,</span> <span class="s1">&#39;placing_sort&#39;</span><span class="p">,</span> <span class="s1">&#39;runner_name&#39;</span><span class="p">])</span>
<a id="__codelineno-6-265" name="__codelineno-6-265" href="#__codelineno-6-265"></a>
<a id="__codelineno-6-266" name="__codelineno-6-266" href="#__codelineno-6-266"></a>        <span class="c1"># Market info</span>
<a id="__codelineno-6-267" name="__codelineno-6-267" href="#__codelineno-6-267"></a>        <span class="n">market_info_full</span> <span class="o">=</span> <span class="n">format_row_message</span><span class="p">(</span>
<a id="__codelineno-6-268" name="__codelineno-6-268" href="#__codelineno-6-268"></a>            <span class="n">placed_sorted</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
<a id="__codelineno-6-269" name="__codelineno-6-269" href="#__codelineno-6-269"></a>            <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
<a id="__codelineno-6-270" name="__codelineno-6-270" href="#__codelineno-6-270"></a>            <span class="n">include_bsp</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-6-271" name="__codelineno-6-271" href="#__codelineno-6-271"></a>            <span class="n">include_ltp</span><span class="o">=</span><span class="kc">False</span>
<a id="__codelineno-6-272" name="__codelineno-6-272" href="#__codelineno-6-272"></a>        <span class="p">)</span>
<a id="__codelineno-6-273" name="__codelineno-6-273" href="#__codelineno-6-273"></a>
<a id="__codelineno-6-274" name="__codelineno-6-274" href="#__codelineno-6-274"></a>        <span class="n">runner_name_first</span> <span class="o">=</span> <span class="n">placed_sorted</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;runner_name&#39;</span><span class="p">]</span>
<a id="__codelineno-6-275" name="__codelineno-6-275" href="#__codelineno-6-275"></a>        <span class="k">if</span> <span class="n">runner_name_first</span> <span class="ow">in</span> <span class="n">market_info_full</span><span class="p">:</span>
<a id="__codelineno-6-276" name="__codelineno-6-276" href="#__codelineno-6-276"></a>            <span class="n">market_info</span> <span class="o">=</span> <span class="n">market_info_full</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="n">runner_name_first</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<a id="__codelineno-6-277" name="__codelineno-6-277" href="#__codelineno-6-277"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-6-278" name="__codelineno-6-278" href="#__codelineno-6-278"></a>            <span class="n">market_info</span> <span class="o">=</span> <span class="n">market_info_full</span>
<a id="__codelineno-6-279" name="__codelineno-6-279" href="#__codelineno-6-279"></a>
<a id="__codelineno-6-280" name="__codelineno-6-280" href="#__codelineno-6-280"></a>        <span class="c1"># ===== Dynamic column widths =====</span>
<a id="__codelineno-6-281" name="__codelineno-6-281" href="#__codelineno-6-281"></a>        <span class="n">place_width</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="s2">&quot;Place&quot;</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">))</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">placed_sorted</span><span class="p">[</span><span class="s1">&#39;placing_str&#39;</span><span class="p">]))</span>
<a id="__codelineno-6-282" name="__codelineno-6-282" href="#__codelineno-6-282"></a>
<a id="__codelineno-6-283" name="__codelineno-6-283" href="#__codelineno-6-283"></a>        <span class="n">bsp_width</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
<a id="__codelineno-6-284" name="__codelineno-6-284" href="#__codelineno-6-284"></a>            <span class="nb">len</span><span class="p">(</span><span class="s2">&quot;W_BSP&quot;</span><span class="p">),</span>
<a id="__codelineno-6-285" name="__codelineno-6-285" href="#__codelineno-6-285"></a>            <span class="nb">max</span><span class="p">(</span>
<a id="__codelineno-6-286" name="__codelineno-6-286" href="#__codelineno-6-286"></a>                <span class="nb">len</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;$</span><span class="si">{</span><span class="n">b</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="s2">&quot;SCR&quot;</span><span class="p">)</span>
<a id="__codelineno-6-287" name="__codelineno-6-287" href="#__codelineno-6-287"></a>                <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">placed_sorted</span><span class="p">[</span><span class="s1">&#39;runner_bsp&#39;</span><span class="p">]</span>
<a id="__codelineno-6-288" name="__codelineno-6-288" href="#__codelineno-6-288"></a>            <span class="p">)</span>
<a id="__codelineno-6-289" name="__codelineno-6-289" href="#__codelineno-6-289"></a>        <span class="p">)</span>
<a id="__codelineno-6-290" name="__codelineno-6-290" href="#__codelineno-6-290"></a>
<a id="__codelineno-6-291" name="__codelineno-6-291" href="#__codelineno-6-291"></a>        <span class="n">place_bsp_width</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
<a id="__codelineno-6-292" name="__codelineno-6-292" href="#__codelineno-6-292"></a>            <span class="nb">len</span><span class="p">(</span><span class="s2">&quot;P_BSP&quot;</span><span class="p">),</span>
<a id="__codelineno-6-293" name="__codelineno-6-293" href="#__codelineno-6-293"></a>            <span class="nb">max</span><span class="p">(</span>
<a id="__codelineno-6-294" name="__codelineno-6-294" href="#__codelineno-6-294"></a>                <span class="nb">len</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;$</span><span class="si">{</span><span class="n">pb</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">pb</span><span class="p">)</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-6-295" name="__codelineno-6-295" href="#__codelineno-6-295"></a>                <span class="k">for</span> <span class="n">pb</span> <span class="ow">in</span> <span class="n">placed_sorted</span><span class="p">[</span><span class="s1">&#39;place_bsp&#39;</span><span class="p">]</span>
<a id="__codelineno-6-296" name="__codelineno-6-296" href="#__codelineno-6-296"></a>            <span class="p">)</span>
<a id="__codelineno-6-297" name="__codelineno-6-297" href="#__codelineno-6-297"></a>        <span class="p">)</span>
<a id="__codelineno-6-298" name="__codelineno-6-298" href="#__codelineno-6-298"></a>
<a id="__codelineno-6-299" name="__codelineno-6-299" href="#__codelineno-6-299"></a>        <span class="n">runner_width</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
<a id="__codelineno-6-300" name="__codelineno-6-300" href="#__codelineno-6-300"></a>            <span class="nb">len</span><span class="p">(</span><span class="s2">&quot;Runner&quot;</span><span class="p">),</span>
<a id="__codelineno-6-301" name="__codelineno-6-301" href="#__codelineno-6-301"></a>            <span class="nb">max</span><span class="p">(</span>
<a id="__codelineno-6-302" name="__codelineno-6-302" href="#__codelineno-6-302"></a>                <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">[:</span><span class="mi">30</span><span class="p">])</span> <span class="o">+</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; — </span><span class="si">{</span><span class="n">rd</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-6-303" name="__codelineno-6-303" href="#__codelineno-6-303"></a>                <span class="k">for</span> <span class="n">r</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">pb</span><span class="p">,</span> <span class="n">rd</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
<a id="__codelineno-6-304" name="__codelineno-6-304" href="#__codelineno-6-304"></a>                    <span class="n">placed_sorted</span><span class="p">[</span><span class="s1">&#39;runner_name&#39;</span><span class="p">],</span>
<a id="__codelineno-6-305" name="__codelineno-6-305" href="#__codelineno-6-305"></a>                    <span class="n">placed_sorted</span><span class="p">[</span><span class="s1">&#39;runner_bsp&#39;</span><span class="p">],</span>
<a id="__codelineno-6-306" name="__codelineno-6-306" href="#__codelineno-6-306"></a>                    <span class="n">placed_sorted</span><span class="p">[</span><span class="s1">&#39;place_bsp&#39;</span><span class="p">],</span>
<a id="__codelineno-6-307" name="__codelineno-6-307" href="#__codelineno-6-307"></a>                    <span class="n">placed_sorted</span><span class="p">[</span><span class="s1">&#39;runner_removal_date&#39;</span><span class="p">]</span>
<a id="__codelineno-6-308" name="__codelineno-6-308" href="#__codelineno-6-308"></a>                <span class="p">)</span>
<a id="__codelineno-6-309" name="__codelineno-6-309" href="#__codelineno-6-309"></a>            <span class="p">)</span>
<a id="__codelineno-6-310" name="__codelineno-6-310" href="#__codelineno-6-310"></a>        <span class="p">)</span>
<a id="__codelineno-6-311" name="__codelineno-6-311" href="#__codelineno-6-311"></a>
<a id="__codelineno-6-312" name="__codelineno-6-312" href="#__codelineno-6-312"></a>        <span class="c1"># ===== Build header &amp; rows =====</span>
<a id="__codelineno-6-313" name="__codelineno-6-313" href="#__codelineno-6-313"></a>        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">market_info</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">]</span>
<a id="__codelineno-6-314" name="__codelineno-6-314" href="#__codelineno-6-314"></a>
<a id="__codelineno-6-315" name="__codelineno-6-315" href="#__codelineno-6-315"></a>        <span class="c1"># Add Actual Start Time &amp; Places Paid line</span>
<a id="__codelineno-6-316" name="__codelineno-6-316" href="#__codelineno-6-316"></a>        <span class="n">inplay_time_val</span> <span class="o">=</span> <span class="n">placed_sorted</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;inplay_time_local&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-6-317" name="__codelineno-6-317" href="#__codelineno-6-317"></a>        <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">inplay_time_val</span><span class="p">):</span>
<a id="__codelineno-6-318" name="__codelineno-6-318" href="#__codelineno-6-318"></a>            <span class="n">inplay_time</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">inplay_time_val</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%H:%M:%S&quot;</span><span class="p">)</span>
<a id="__codelineno-6-319" name="__codelineno-6-319" href="#__codelineno-6-319"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-6-320" name="__codelineno-6-320" href="#__codelineno-6-320"></a>            <span class="n">inplay_time</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-6-321" name="__codelineno-6-321" href="#__codelineno-6-321"></a>
<a id="__codelineno-6-322" name="__codelineno-6-322" href="#__codelineno-6-322"></a>        <span class="n">places_paid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">placed_sorted</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;places_paid&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
<a id="__codelineno-6-323" name="__codelineno-6-323" href="#__codelineno-6-323"></a>        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Actual Start Time: </span><span class="si">{</span><span class="n">inplay_time</span><span class="si">}</span><span class="s2"> | Places Paid: </span><span class="si">{</span><span class="n">places_paid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-6-324" name="__codelineno-6-324" href="#__codelineno-6-324"></a>        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-6-325" name="__codelineno-6-325" href="#__codelineno-6-325"></a>
<a id="__codelineno-6-326" name="__codelineno-6-326" href="#__codelineno-6-326"></a>        <span class="n">header</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;Place&#39;</span><span class="si">:</span><span class="s2">&lt;</span><span class="si">{</span><span class="n">place_width</span><span class="si">}}</span><span class="s2"> | </span><span class="si">{</span><span class="s1">&#39;W_BSP&#39;</span><span class="si">:</span><span class="s2">&gt;</span><span class="si">{</span><span class="n">bsp_width</span><span class="si">}}</span><span class="s2"> | </span><span class="si">{</span><span class="s1">&#39;P_BSP&#39;</span><span class="si">:</span><span class="s2">&gt;</span><span class="si">{</span><span class="n">place_bsp_width</span><span class="si">}}</span><span class="s2"> | </span><span class="si">{</span><span class="s1">&#39;Runner&#39;</span><span class="si">:</span><span class="s2">&lt;</span><span class="si">{</span><span class="n">runner_width</span><span class="si">}}</span><span class="s2">&quot;</span>
<a id="__codelineno-6-327" name="__codelineno-6-327" href="#__codelineno-6-327"></a>        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
<a id="__codelineno-6-328" name="__codelineno-6-328" href="#__codelineno-6-328"></a>
<a id="__codelineno-6-329" name="__codelineno-6-329" href="#__codelineno-6-329"></a>        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">placed_sorted</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
<a id="__codelineno-6-330" name="__codelineno-6-330" href="#__codelineno-6-330"></a>            <span class="n">place</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;placing_str&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">&lt;</span><span class="si">{</span><span class="n">place_width</span><span class="si">}}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;placing_str&#39;</span><span class="p">])</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-6-331" name="__codelineno-6-331" href="#__codelineno-6-331"></a>
<a id="__codelineno-6-332" name="__codelineno-6-332" href="#__codelineno-6-332"></a>            <span class="c1"># W_BSP</span>
<a id="__codelineno-6-333" name="__codelineno-6-333" href="#__codelineno-6-333"></a>            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;runner_status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;REMOVED&#39;</span> <span class="ow">or</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;runner_bsp&#39;</span><span class="p">]):</span>
<a id="__codelineno-6-334" name="__codelineno-6-334" href="#__codelineno-6-334"></a>                <span class="n">bsp</span> <span class="o">=</span> <span class="s2">&quot;SCR&quot;</span>
<a id="__codelineno-6-335" name="__codelineno-6-335" href="#__codelineno-6-335"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-6-336" name="__codelineno-6-336" href="#__codelineno-6-336"></a>                <span class="n">bsp</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;$</span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;runner_bsp&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-6-337" name="__codelineno-6-337" href="#__codelineno-6-337"></a>
<a id="__codelineno-6-338" name="__codelineno-6-338" href="#__codelineno-6-338"></a>            <span class="c1"># P_BSP</span>
<a id="__codelineno-6-339" name="__codelineno-6-339" href="#__codelineno-6-339"></a>            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;runner_status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;REMOVED&#39;</span><span class="p">:</span>
<a id="__codelineno-6-340" name="__codelineno-6-340" href="#__codelineno-6-340"></a>                <span class="n">place_bsp</span> <span class="o">=</span> <span class="s2">&quot;SCR&quot;</span>
<a id="__codelineno-6-341" name="__codelineno-6-341" href="#__codelineno-6-341"></a>            <span class="k">elif</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;place_bsp&#39;</span><span class="p">]):</span>
<a id="__codelineno-6-342" name="__codelineno-6-342" href="#__codelineno-6-342"></a>                <span class="n">place_bsp</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;$</span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;place_bsp&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-6-343" name="__codelineno-6-343" href="#__codelineno-6-343"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-6-344" name="__codelineno-6-344" href="#__codelineno-6-344"></a>                <span class="n">place_bsp</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>   <span class="c1"># handle PLACE markets with no BSP</span>
<a id="__codelineno-6-345" name="__codelineno-6-345" href="#__codelineno-6-345"></a>
<a id="__codelineno-6-346" name="__codelineno-6-346" href="#__codelineno-6-346"></a>            <span class="n">bsp</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">bsp</span><span class="si">:</span><span class="s2">&gt;</span><span class="si">{</span><span class="n">bsp_width</span><span class="si">}}</span><span class="s2">&quot;</span>
<a id="__codelineno-6-347" name="__codelineno-6-347" href="#__codelineno-6-347"></a>            <span class="n">place_bsp</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">place_bsp</span><span class="si">:</span><span class="s2">&gt;</span><span class="si">{</span><span class="n">place_bsp_width</span><span class="si">}}</span><span class="s2">&quot;</span>
<a id="__codelineno-6-348" name="__codelineno-6-348" href="#__codelineno-6-348"></a>
<a id="__codelineno-6-349" name="__codelineno-6-349" href="#__codelineno-6-349"></a>            <span class="n">runner</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;runner_name&#39;</span><span class="p">][:</span><span class="mi">30</span><span class="p">]</span>
<a id="__codelineno-6-350" name="__codelineno-6-350" href="#__codelineno-6-350"></a>            <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;runner_bsp&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;runner_removal_date&#39;</span><span class="p">]):</span>
<a id="__codelineno-6-351" name="__codelineno-6-351" href="#__codelineno-6-351"></a>                <span class="n">runner</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; — </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;runner_removal_date&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-6-352" name="__codelineno-6-352" href="#__codelineno-6-352"></a>            <span class="n">runner</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">runner</span><span class="si">:</span><span class="s2">&lt;</span><span class="si">{</span><span class="n">runner_width</span><span class="si">}}</span><span class="s2">&quot;</span>
<a id="__codelineno-6-353" name="__codelineno-6-353" href="#__codelineno-6-353"></a>
<a id="__codelineno-6-354" name="__codelineno-6-354" href="#__codelineno-6-354"></a>            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">place</span><span class="si">}</span><span class="s2"> | </span><span class="si">{</span><span class="n">bsp</span><span class="si">}</span><span class="s2"> | </span><span class="si">{</span><span class="n">place_bsp</span><span class="si">}</span><span class="s2"> | </span><span class="si">{</span><span class="n">runner</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-6-355" name="__codelineno-6-355" href="#__codelineno-6-355"></a>
<a id="__codelineno-6-356" name="__codelineno-6-356" href="#__codelineno-6-356"></a>        <span class="c1"># ===== Send to Discord in monospaced block =====</span>
<a id="__codelineno-6-357" name="__codelineno-6-357" href="#__codelineno-6-357"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
<a id="__codelineno-6-358" name="__codelineno-6-358" href="#__codelineno-6-358"></a>            <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;```&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;```&quot;</span>
<a id="__codelineno-6-359" name="__codelineno-6-359" href="#__codelineno-6-359"></a>            <span class="n">send_discord_message</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">discord_webhook_url</span><span class="p">)</span>
<a id="__codelineno-6-360" name="__codelineno-6-360" href="#__codelineno-6-360"></a>
<a id="__codelineno-6-361" name="__codelineno-6-361" href="#__codelineno-6-361"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-6-362" name="__codelineno-6-362" href="#__codelineno-6-362"></a>        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
<a id="__codelineno-6-363" name="__codelineno-6-363" href="#__codelineno-6-363"></a>        <span class="k">pass</span>
<a id="__codelineno-6-364" name="__codelineno-6-364" href="#__codelineno-6-364"></a>
<a id="__codelineno-6-365" name="__codelineno-6-365" href="#__codelineno-6-365"></a><span class="k">def</span><span class="w"> </span><span class="nf">send_market_void_alert</span><span class="p">(</span><span class="n">market</span><span class="p">:</span> <span class="n">Market</span><span class="p">,</span> <span class="n">market_book</span><span class="p">:</span> <span class="n">MarketBook</span><span class="p">,</span> <span class="n">webhook_url</span><span class="p">):</span>
<a id="__codelineno-6-366" name="__codelineno-6-366" href="#__codelineno-6-366"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-6-367" name="__codelineno-6-367" href="#__codelineno-6-367"></a><span class="sd">    Sends a Discord alert if all runners in a market are removed (market voided).</span>
<a id="__codelineno-6-368" name="__codelineno-6-368" href="#__codelineno-6-368"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-6-369" name="__codelineno-6-369" href="#__codelineno-6-369"></a>    <span class="k">if</span> <span class="n">market</span><span class="o">.</span><span class="n">event_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-6-370" name="__codelineno-6-370" href="#__codelineno-6-370"></a>        <span class="k">return</span>
<a id="__codelineno-6-371" name="__codelineno-6-371" href="#__codelineno-6-371"></a>
<a id="__codelineno-6-372" name="__codelineno-6-372" href="#__codelineno-6-372"></a>    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-6-373" name="__codelineno-6-373" href="#__codelineno-6-373"></a>        <span class="sa">f</span><span class="s2">&quot;⚠️ MARKET VOIDED ⚠️</span><span class="se">\n</span><span class="s2">&quot;</span>
<a id="__codelineno-6-374" name="__codelineno-6-374" href="#__codelineno-6-374"></a>        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">market</span><span class="o">.</span><span class="n">event_name</span><span class="si">}</span><span class="s2"> (Event ID:</span><span class="si">{</span><span class="n">market</span><span class="o">.</span><span class="n">event_id</span><span class="si">}</span><span class="s2">) - </span><span class="si">{</span><span class="n">market</span><span class="o">.</span><span class="n">market_catalogue</span><span class="o">.</span><span class="n">event_type</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
<a id="__codelineno-6-375" name="__codelineno-6-375" href="#__codelineno-6-375"></a>        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">market</span><span class="o">.</span><span class="n">market_catalogue</span><span class="o">.</span><span class="n">market_name</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">market</span><span class="o">.</span><span class="n">market_id</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
<a id="__codelineno-6-376" name="__codelineno-6-376" href="#__codelineno-6-376"></a>        <span class="sa">f</span><span class="s2">&quot;Market Time: </span><span class="si">{</span><span class="n">pytz</span><span class="o">.</span><span class="n">UTC</span><span class="o">.</span><span class="n">localize</span><span class="p">(</span><span class="n">market</span><span class="o">.</span><span class="n">market_start_datetime</span><span class="p">)</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">pytz</span><span class="o">.</span><span class="n">timezone</span><span class="p">(</span><span class="s1">&#39;Australia/Sydney&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S %Z&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> | &quot;</span>
<a id="__codelineno-6-377" name="__codelineno-6-377" href="#__codelineno-6-377"></a>        <span class="sa">f</span><span class="s2">&quot;Voided: </span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">pytz</span><span class="o">.</span><span class="n">timezone</span><span class="p">(</span><span class="s2">&quot;Australia/Sydney&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S %Z&quot;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-6-378" name="__codelineno-6-378" href="#__codelineno-6-378"></a>    <span class="p">)</span>
<a id="__codelineno-6-379" name="__codelineno-6-379" href="#__codelineno-6-379"></a>
<a id="__codelineno-6-380" name="__codelineno-6-380" href="#__codelineno-6-380"></a>    <span class="n">send_discord_message</span><span class="p">(</span><span class="n">wrap_code_block</span><span class="p">(</span><span class="n">msg</span><span class="p">),</span> <span class="n">webhook_url</span><span class="p">)</span>
</code></pre></div>
<p>This concludes the tutorial on logging results to csv files and using Discord to place alerts for resulted markets.
This logic and functionality could further be expanded to:</p>
<ul>
<li>Alerts for Firmers and Drifters in live markets</li>
<li>Alerts for large unmatched bets being placed into live markets</li>
<li>Alerts for runners with large implied probability differences to publicly available models like the Betfair Prediction Models</li>
</ul>
<p>If you have any questions please reach out to automation@betfair.com.au to discuss!</p>
<h3 id="disclaimer">Disclaimer</h3>
<p>Note that whilst models and automated strategies are fun and rewarding to create, we can't promise that your model or betting strategy will be profitable, and we make no representations in relation to the code shared or information on this page. If you're using this code or implementing your own strategies, you do so entirely at your own risk and you are responsible for any winnings/losses incurred. Under no circumstances will Betfair be liable for any loss or damage you suffer.</p>









  




                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
    
      <nav class="md-footer__inner md-grid" aria-label="footer.title">
        
          
          <a href="../How_to_Automate_5/" class="md-footer__link md-footer__link--prev" aria-label="Previous: How to Automate 5" rel="prev">
            <div class="md-footer__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <div class="md-ellipsis">
                <span class="md-footer__direction">
                  Previous
                </span>
                How to Automate 5
              </div>
            </div>
          </a>
        
        
          
          <a href="../flumineSimulations/" class="md-footer__link md-footer__link--next" aria-label="Next: Flumine Simulations" rel="next">
            <div class="md-footer__title">
              <div class="md-ellipsis">
                <span class="md-footer__direction">
                  Next
                </span>
                Flumine Simulations
              </div>
            </div>
            <div class="md-footer__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
    <div class="md-footer-meta md-typeset">
      <div class="md-footer-meta__inner md-grid">
        <div class="md-copyright">
  
  
</div>
        
          <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://twitter.com/Betfair_Aus" target="_blank" rel="noopener" title="twitter.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://linkedin.com/company/betfair-australia" target="_blank" rel="noopener" title="linkedin.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3M135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5m282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://facebook.com/betfairaustralia" target="_blank" rel="noopener" title="facebook.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M512 256C512 114.6 397.4 0 256 0S0 114.6 0 256c0 120 82.7 220.8 194.2 248.5V334.2h-52.8V256h52.8v-33.7c0-87.1 39.4-127.5 125-127.5 16.2 0 44.2 3.2 55.7 6.4V172c-6-.6-16.5-1-29.6-1-42 0-58.2 15.9-58.2 57.2V256h83.6l-14.4 78.2H287v175.9C413.8 494.8 512 386.9 512 256"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://youtube.com/user/betfairaus" target="_blank" rel="noopener" title="youtube.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M549.655 124.083c-6.281-23.65-24.787-42.276-48.284-48.597C458.781 64 288 64 288 64S117.22 64 74.629 75.486c-23.497 6.322-42.003 24.947-48.284 48.597-11.412 42.867-11.412 132.305-11.412 132.305s0 89.438 11.412 132.305c6.281 23.65 24.787 41.5 48.284 47.821C117.22 448 288 448 288 448s170.78 0 213.371-11.486c23.497-6.321 42.003-24.171 48.284-47.821 11.412-42.867 11.412-132.305 11.412-132.305s0-89.438-11.412-132.305m-317.51 213.508V175.185l142.739 81.205z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://github.com/betfair-datascientists" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
</div>
        
      </div>

      <div class="bf-footer">
          <div class="bf-footer-inner">
              <p class="bf-light">Betfair Pty Limited is licensed and regulated by the Northern Territory Government of Australia.</p>
              <p class="bf-dark">Betfair Pty Limited's gambling operations are governed by its <a class='inner-link' href="https://www.betfair.com.au/info/responsible-gambling/">Responsible Gambling Code of Conduct</a> and for South
              Australian residents by the <a class='inner-link' href="https://www.betfair.com.au/info/pdf/SA-GCoP.pdf">South Australian Responsible Gambling Code of Practice.</a></p>
              <!-- BetStop block in white box -->
              <div class="full-screen">
                  <p style="font-family: Arial, sans-serif; font-size: 1.2rem; font-weight: bold; text-align: center;">
                    BetStop is the Australian National Self-Exclusion Register. For more information, please visit 
                    <a href="https://betstop.gov.au" style="font-family: Arial, sans-serif; font-size: 1.2rem; font-weight: bold; color: black; text-decoration: none;">
                      https://betstop.gov.au
                    </a>
                  </p>
              </div>
              <br />
              <!-- RG footer block -->
              <div class="full-screen"> <p style="font-family: Arial, sans-serif; font-size: 1.2rem; font-weight: bold; text-align: center;">Imagine what you could be buying instead.</p> <p style="font-family: Arial, sans-serif; font-size: 0.8rem; font-weight: bold; text-align: center;">For free and confidential support call 1800 858 858 or visit <a href="http://www.gamblinghelponline.org.au" style="color: black; text-decoration: underline;">gamblinghelponline.org.au</a></p> </div>
              <ul class="bf-links">
                <li><a href="https://www.betfair.com.au/hub/help/account-help/responsible-gambling/">Responsible Gambling</a><span>|</span></li>
                <li><a href="http://www.betfair.com/AUS_NZL/aboutUs/Terms.and.Conditions/">Terms & Conditions</a><span>|</span></li>
                <li><a href="https://www.betfair.com.au/info/privacy-policy/">Privacy Policy</a><span>|</span></li>
                <li><a href="http://www.betfair.com/en/aboutUs/Rules.and.Regulations/">Rules & Regulations</a><span>|</span></li>
                <li><a href="https://www.betfair.com/AUS_NZL/aboutUs/Dispute.Resolution">Dispute Resolution</a></li>
              </ul>
          </div>
      </div>
    </div>

    <script src="https://js.adsrvr.org/up_loader.1.1.0.js" type="text/javascript"></script>
    <script type="text/javascript">
        ttd_dom_ready( function() {
            if (typeof TTDUniversalPixelApi === 'function') {
                var universalPixelApi = new TTDUniversalPixelApi();
                universalPixelApi.init("y12d1ir", ["8ml4f17"], "https://insight.adsrvr.org/track/up");
            }
        });
    </script>

</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["toc.integrate", "navigation.instant", "navigation.tabs", "navigation.top", "navigation.expand", "navigation.sections", "search.suggest", "search.highlight", "search.share"], "search": "../../assets/javascripts/workers/search.f8cc74c7.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.f1b6f286.min.js"></script>
      
        <script src="../../js/scripts.js"></script>
      
    
  </body>
</html>