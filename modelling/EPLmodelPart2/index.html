



<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="Documentation, guides and articles on creating, developing and implementing automated betting strategies, using data analysis to inform betting models and how to interact with the Betfair API.">
      
      
        <link rel="canonical" href="https://betfair-datascientists.github.io/modelling/EPLmodelPart2/">
      
      
        <meta name="author" content="Betfair Data Scientists">
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../img/BetfairFavicon.ico">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-3.0.4">
    
    
      
        <title>EPL 02. Data preparation & feature engineering - The Automation Hub</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application.9a8eeed6.css">
      
      
    
    
      <script src="../../assets/javascripts/modernizr.1aa3b519.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../assets/fonts/material-icons.css">
    <link rel="stylesheet" href="../../assets/fonts/clarke-regular.css">
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="../../#epl-machine-learning-walkthrough" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="https://betfair-datascientists.github.io" title="The Automation Hub" class="md-header-nav__button md-logo">
          
            <img src="../../img/logo.svg" height="24">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                The Automation Hub
              </span>
              <span class="md-header-nav__topic">
                EPL 02. Data preparation & feature engineering
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      <div class="bf-nav md-flex__cell">
        <a class="bf-hidable" href="https://www.betfair.com.au/exchange/plus/"><svg class="exchangeLogo" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:cc="http://creativecommons.org/ns#" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 38.775 4.59" width="24" height="17">
          <path class="st1" d="m 160.3,-136.95 v 26"/>
          <g transform="translate(18.8,-137.15)">
            <path d="m 2.2901089,126.53441 v 5.20093 H -3.3107216 L 7.4888397,144.33446 18.2884,131.73534 h -5.598633 v -5.20093 z m -8.6000974,8.10132 -10.8017585,12.59913 h 5.60083 v 5.2998 h 10.3996581 v -5.2998 h 5.6008306 z"/>
          </g>
        </svg><span> Exchange</span></a>
        <a href="https://www.betfair.com.au/hub/">Hub</a>
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
        

  

<nav class="md-tabs md-tabs--active" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../.." title="Home" class="md-tabs__link">
          Home
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../thirdPartyTools/overview/" title="Tutorials" class="md-tabs__link">
          Tutorials
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../api/apiappkey/" title="API" class="md-tabs__link">
          API
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../historicData/dataSources/" title="Historic Data" class="md-tabs__link">
          Historic Data
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../howToModel/" title="Modelling" class="md-tabs__link md-tabs__link--active">
          Modelling
        </a>
      
    </li>
  

      
    </ul>
  </div>
</nav>
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="https://betfair-datascientists.github.io" title="The Automation Hub" class="md-nav__button md-logo">
      
        <img src="../../img/logo.svg" width="48" height="48">
      
    </a>
    The Automation Hub
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-1" type="checkbox" id="nav-1">
    
    <label class="md-nav__link" for="nav-1">
      Home
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-1">
        Home
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../.." title="The Automation Hub" class="md-nav__link">
      The Automation Hub
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      Tutorials
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Tutorials
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../thirdPartyTools/overview/" title="Tools Overview" class="md-nav__link">
      Tools Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-2" type="checkbox" id="nav-2-2">
    
    <label class="md-nav__link" for="nav-2-2">
      Bet Angel Professional
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-2-2">
        Bet Angel Professional
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../thirdPartyTools/betAngel/betAngel/" title="Overview - Bet Angel Pro" class="md-nav__link">
      Overview - Bet Angel Pro
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../thirdPartyTools/betAngelRatingsAutomation/" title="Ratings automation" class="md-nav__link">
      Ratings automation
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../thirdPartyTools/betAngelMarketFavouriteAutomation/" title="Market favourite automation" class="md-nav__link">
      Market favourite automation
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../thirdPartyTools/betAngelTippingAutomation/" title="Tipping automation" class="md-nav__link">
      Tipping automation
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../thirdPartyTools/betAngelSimultaneousMarkets/" title="Simultaneous markets" class="md-nav__link">
      Simultaneous markets
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../thirdPartyTools/betAngelKellyStake/" title="Kelly Criterion staking" class="md-nav__link">
      Kelly Criterion staking
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-3" type="checkbox" id="nav-2-3">
    
    <label class="md-nav__link" for="nav-2-3">
      Gruss Betting Assistant
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-2-3">
        Gruss Betting Assistant
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../thirdPartyTools/Gruss/Gruss/" title="Overview - Gruss" class="md-nav__link">
      Overview - Gruss
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../thirdPartyTools/grussRatingsAutomation/" title="Ratings automation" class="md-nav__link">
      Ratings automation
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../thirdPartyTools/grussMarketFavouriteAutomation/" title="Market favourite automation" class="md-nav__link">
      Market favourite automation
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../thirdPartyTools/grusslSimultaneousMarkets/" title="Simultaneous markets" class="md-nav__link">
      Simultaneous markets
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../thirdPartyTools/grussKellyStake/" title="Kelly Criterion staking" class="md-nav__link">
      Kelly Criterion staking
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-4" type="checkbox" id="nav-2-4">
    
    <label class="md-nav__link" for="nav-2-4">
      Cymatic Trader
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-2-4">
        Cymatic Trader
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../thirdPartyTools/CymaticTrader/CymaticTrader/" title="Overview - Cymatic Trader" class="md-nav__link">
      Overview - Cymatic Trader
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../thirdPartyTools/cymaticTraderRatingsAutomation/" title="Ratings automation" class="md-nav__link">
      Ratings automation
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      API
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        API
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../api/apiappkey/" title="How to access the Betfair API" class="md-nav__link">
      How to access the Betfair API
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../api/apiRtutorial/" title="API tutorials in R" class="md-nav__link">
      API tutorials in R
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../api/apiPythontutorial/" title="API tutorial in Python" class="md-nav__link">
      API tutorial in Python
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      Historic Data
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        Historic Data
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../historicData/dataSources/" title="Historic Data Sources" class="md-nav__link">
      Historic Data Sources
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../historicData/usingHistoricDataSite/" title="Downloading from the Historic Data site" class="md-nav__link">
      Downloading from the Historic Data site
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5" checked>
    
    <label class="md-nav__link" for="nav-5">
      Modelling
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        Modelling
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../howToModel/" title="Intro to modelling" class="md-nav__link">
      Intro to modelling
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../howToModelTheAusOpen/" title="How to model the Australian Open" class="md-nav__link">
      How to model the Australian Open
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../AusOpenRTutorial/" title="Aus Open R Tutorial" class="md-nav__link">
      Aus Open R Tutorial
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../AusOpenPythonTutorial/" title="Aus Open Python Tutorial" class="md-nav__link">
      Aus Open Python Tutorial
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../EPLmodelPart1/" title="EPL 01. Data acquisition & exploration" class="md-nav__link">
      EPL 01. Data acquisition & exploration
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
    <a href="./" title="EPL 02. Data preparation & feature engineering" class="md-nav__link md-nav__link--active">
      EPL 02. Data preparation & feature engineering
    </a>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../EPLmodelPart3/" title="EPL 03. Model building & hyperparameter tuning" class="md-nav__link">
      EPL 03. Model building & hyperparameter tuning
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../EPLmodelPart4/" title="EPL 04. Weekly predictions" class="md-nav__link">
      EPL 04. Weekly predictions
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../AFLmodelPart1/" title="AFL 01. Data cleaning" class="md-nav__link">
      AFL 01. Data cleaning
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../AFLmodelPart2/" title="AFL 02. Feature creation" class="md-nav__link">
      AFL 02. Feature creation
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../AFLmodelPart3/" title="AFL 03. Modelling" class="md-nav__link">
      AFL 03. Modelling
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../AFLmodelPart4/" title="AFL 04. Weekly predictions" class="md-nav__link">
      AFL 04. Weekly predictions
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../brownlowModelTutorial/" title="Modelling the Brownlow Medal" class="md-nav__link">
      Modelling the Brownlow Medal
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="epl-machine-learning-walkthrough">EPL Machine Learning Walkthrough<a class="headerlink" href="#epl-machine-learning-walkthrough" title="Permanent link">&para;</a></h1>
<h1 id="02-data-preparation-feature-engineering">02. Data Preparation &amp; Feature Engineering<a class="headerlink" href="#02-data-preparation-feature-engineering" title="Permanent link">&para;</a></h1>
<p>Welcome to the second part of this Machine Learning Walkthrough. This tutorial will focus on data preparation and feature creation, before we dive into modelling in the <a href="/modelling/EPLmodelPart3">next tutorial</a>.</p>
<p>Specifically, this tutorial will cover a few things:</p>
<ol>
<li>Data wrangling specifically for sport</li>
<li>Feature creation - focussing on commonly used features in sports modelling, such as exponential moving averages</li>
<li>Using functions to modularise the data preparation process</li>
</ol>
<hr />
<h2 id="data-wrangling">Data Wrangling<a class="headerlink" href="#data-wrangling" title="Permanent link">&para;</a></h2>
<p>We will begin by utilising functions we have defined in our data_preparation_functions script to wrangle our data into a format that can be consumed by Machine Learning algorithms.</p>
<p>A typical issue faced by aspect of modelling sport is the issue of Machine Learning algorithms requiring all features for the teams playing to be on the same row of a table, whereas when we actual calculate these features, we usually require the teams to be on separate rows as it makes it a lot easier to calculate typical features, such as <a href="https://en.wikipedia.org/wiki/Moving_average#Exponential_moving_average">expontentially weighted moving averages</a>. We will explore this issue and show how we deal with issues like these.</p>
<div class="codehilite" style="background: #f8f8f8"><pre style="line-height: 125%"><span></span><span style="color: #408080; font-style: italic"># Import libraries</span>
<span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">data_preparation_functions</span> <span style="color: #008000; font-weight: bold">import</span> <span style="color: #666666">*</span>
<span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">sklearn.metrics</span> <span style="color: #008000; font-weight: bold">import</span> log_loss
<span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">sklearn.linear_model</span> <span style="color: #008000; font-weight: bold">import</span> LogisticRegression
<span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">sklearn.preprocessing</span> <span style="color: #008000; font-weight: bold">import</span> LabelEncoder
<span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">sklearn.model_selection</span> <span style="color: #008000; font-weight: bold">import</span> StratifiedKFold, cross_val_score
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">matplotlib.pyplot</span> <span style="color: #008000; font-weight: bold">as</span> <span style="color: #0000FF; font-weight: bold">plt</span>
pd<span style="color: #666666">.</span>set_option(<span style="color: #BA2121">&#39;display.max_columns&#39;</span>, <span style="color: #666666">100</span>)
</pre></div>

<p>We have created some functions which prepare the data for you. For thoroughly commented explanation of how the functions work, read through the data_preparation_functions.py script along side this walkthrough.</p>
<p>Essentially, each functions wrangles the data through a similar process. It first reads in the data from a csv file, then converts the columns to datatypes that we can work with, such as converting the Date column to a datetime data type. It then adds a Game ID column, so each game is easily identifiable and joined on. We then assign the DataFrame some other columns which may be useful, such as 'Year', 'Result' and 'homeWin'. Finally, we drop redundant column and return the DataFrame.</p>
<p>Let us now create six different DataFrames, which we will use to create features. Later, we will join these features back into one main feature DataFrame.</p>
<h3 id="create-6-distinct-dataframes">Create 6 distinct DataFrames<a class="headerlink" href="#create-6-distinct-dataframes" title="Permanent link">&para;</a></h3>
<div class="codehilite" style="background: #f8f8f8"><pre style="line-height: 125%"><span></span><span style="color: #408080; font-style: italic"># This table includes all of our data in one big DataFrame</span>
df <span style="color: #666666">=</span> create_df(<span style="color: #BA2121">&#39;data/epl_data.csv&#39;</span>)
df<span style="color: #666666">.</span>head(<span style="color: #666666">3</span>)
</pre></div>

<table>
<thead>
<tr>
<th></th>
<th>AC</th>
<th>AF</th>
<th>AR</th>
<th>AS</th>
<th>AST</th>
<th>AY</th>
<th>AwayTeam</th>
<th>B365A</th>
<th>B365D</th>
<th>B365H</th>
<th>BWA</th>
<th>BWD</th>
<th>BWH</th>
<th>Bb1X2</th>
<th>BbAH</th>
<th>BbAHh</th>
<th>BbAv&lt;2.5</th>
<th>BbAv&gt;2.5</th>
<th>BbAvA</th>
<th>BbAvAHA</th>
<th>BbAvAHH</th>
<th>BbAvD</th>
<th>BbAvH</th>
<th>BbMx&lt;2.5</th>
<th>BbMx&gt;2.5</th>
<th>BbMxA</th>
<th>BbMxAHA</th>
<th>BbMxAHH</th>
<th>BbMxD</th>
<th>BbMxH</th>
<th>BbOU</th>
<th>Date</th>
<th>Day</th>
<th>Div</th>
<th>FTAG</th>
<th>FTHG</th>
<th>FTR</th>
<th>HC</th>
<th>HF</th>
<th>HR</th>
<th>HS</th>
<th>HST</th>
<th>HTAG</th>
<th>HTHG</th>
<th>HTR</th>
<th>HY</th>
<th>HomeTeam</th>
<th>IWA</th>
<th>IWD</th>
<th>IWH</th>
<th>LBA</th>
<th>LBD</th>
<th>LBH</th>
<th>Month</th>
<th>Referee</th>
<th>VCA</th>
<th>VCD</th>
<th>VCH</th>
<th>Year</th>
<th>season</th>
<th>gameId</th>
<th>homeWin</th>
<th>awayWin</th>
<th>result</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>6.0</td>
<td>14.0</td>
<td>1.0</td>
<td>11.0</td>
<td>5.0</td>
<td>1.0</td>
<td>Blackburn</td>
<td>2.75</td>
<td>3.20</td>
<td>2.5</td>
<td>2.90</td>
<td>3.30</td>
<td>2.20</td>
<td>55.0</td>
<td>20.0</td>
<td>0.00</td>
<td>1.71</td>
<td>2.02</td>
<td>2.74</td>
<td>2.04</td>
<td>1.82</td>
<td>3.16</td>
<td>2.40</td>
<td>1.80</td>
<td>2.25</td>
<td>2.9</td>
<td>2.08</td>
<td>1.86</td>
<td>3.35</td>
<td>2.60</td>
<td>35.0</td>
<td>2005-08-13</td>
<td>13</td>
<td>E0</td>
<td>1.0</td>
<td>3.0</td>
<td>H</td>
<td>2.0</td>
<td>11.0</td>
<td>0.0</td>
<td>13.0</td>
<td>5.0</td>
<td>1.0</td>
<td>0.0</td>
<td>A</td>
<td>0.0</td>
<td>West Ham</td>
<td>2.7</td>
<td>3.0</td>
<td>2.3</td>
<td>2.75</td>
<td>3.0</td>
<td>2.38</td>
<td>8</td>
<td>A Wiley</td>
<td>2.75</td>
<td>3.25</td>
<td>2.4</td>
<td>2005</td>
<td>0506</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>home</td>
</tr>
<tr>
<td>1</td>
<td>8.0</td>
<td>16.0</td>
<td>0.0</td>
<td>13.0</td>
<td>6.0</td>
<td>2.0</td>
<td>Bolton</td>
<td>3.00</td>
<td>3.25</td>
<td>2.3</td>
<td>3.15</td>
<td>3.25</td>
<td>2.10</td>
<td>56.0</td>
<td>22.0</td>
<td>-0.25</td>
<td>1.70</td>
<td>2.01</td>
<td>3.05</td>
<td>1.84</td>
<td>2.01</td>
<td>3.16</td>
<td>2.20</td>
<td>1.87</td>
<td>2.20</td>
<td>3.4</td>
<td>1.92</td>
<td>2.10</td>
<td>3.30</td>
<td>2.40</td>
<td>36.0</td>
<td>2005-08-13</td>
<td>13</td>
<td>E0</td>
<td>2.0</td>
<td>2.0</td>
<td>D</td>
<td>7.0</td>
<td>14.0</td>
<td>0.0</td>
<td>3.0</td>
<td>2.0</td>
<td>2.0</td>
<td>2.0</td>
<td>D</td>
<td>0.0</td>
<td>Aston Villa</td>
<td>3.1</td>
<td>3.0</td>
<td>2.1</td>
<td>3.20</td>
<td>3.0</td>
<td>2.10</td>
<td>8</td>
<td>M Riley</td>
<td>3.10</td>
<td>3.25</td>
<td>2.2</td>
<td>2005</td>
<td>0506</td>
<td>2</td>
<td>0</td>
<td>0</td>
<td>draw</td>
</tr>
<tr>
<td>2</td>
<td>6.0</td>
<td>14.0</td>
<td>0.0</td>
<td>12.0</td>
<td>5.0</td>
<td>1.0</td>
<td>Man United</td>
<td>1.72</td>
<td>3.40</td>
<td>5.0</td>
<td>1.75</td>
<td>3.35</td>
<td>4.35</td>
<td>56.0</td>
<td>23.0</td>
<td>0.75</td>
<td>1.79</td>
<td>1.93</td>
<td>1.69</td>
<td>1.86</td>
<td>2.00</td>
<td>3.36</td>
<td>4.69</td>
<td>1.87</td>
<td>2.10</td>
<td>1.8</td>
<td>1.93</td>
<td>2.05</td>
<td>3.70</td>
<td>5.65</td>
<td>36.0</td>
<td>2005-08-13</td>
<td>13</td>
<td>E0</td>
<td>2.0</td>
<td>0.0</td>
<td>A</td>
<td>8.0</td>
<td>15.0</td>
<td>0.0</td>
<td>10.0</td>
<td>5.0</td>
<td>1.0</td>
<td>0.0</td>
<td>A</td>
<td>3.0</td>
<td>Everton</td>
<td>1.8</td>
<td>3.1</td>
<td>3.8</td>
<td>1.83</td>
<td>3.2</td>
<td>3.75</td>
<td>8</td>
<td>G Poll</td>
<td>1.80</td>
<td>3.30</td>
<td>4.5</td>
<td>2005</td>
<td>0506</td>
<td>3</td>
<td>0</td>
<td>1</td>
<td>away</td>
</tr>
</tbody>
</table>
<div class="codehilite" style="background: #f8f8f8"><pre style="line-height: 125%"><span></span><span style="color: #408080; font-style: italic"># This includes only the typical soccer stats, like home corners, home shots on target etc.</span>
stats <span style="color: #666666">=</span> create_stats_df(<span style="color: #BA2121">&#39;data/epl_data.csv&#39;</span>)
stats<span style="color: #666666">.</span>head(<span style="color: #666666">3</span>)
</pre></div>

<table>
<thead>
<tr>
<th></th>
<th>gameId</th>
<th>HomeTeam</th>
<th>AwayTeam</th>
<th>FTHG</th>
<th>FTAG</th>
<th>HTHG</th>
<th>HTAG</th>
<th>HS</th>
<th>AS</th>
<th>HST</th>
<th>AST</th>
<th>HF</th>
<th>AF</th>
<th>HC</th>
<th>AC</th>
<th>HY</th>
<th>AY</th>
<th>HR</th>
<th>AR</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>1</td>
<td>West Ham</td>
<td>Blackburn</td>
<td>3.0</td>
<td>1.0</td>
<td>0.0</td>
<td>1.0</td>
<td>13.0</td>
<td>11.0</td>
<td>5.0</td>
<td>5.0</td>
<td>11.0</td>
<td>14.0</td>
<td>2.0</td>
<td>6.0</td>
<td>0.0</td>
<td>1.0</td>
<td>0.0</td>
<td>1.0</td>
</tr>
<tr>
<td>1</td>
<td>2</td>
<td>Aston Villa</td>
<td>Bolton</td>
<td>2.0</td>
<td>2.0</td>
<td>2.0</td>
<td>2.0</td>
<td>3.0</td>
<td>13.0</td>
<td>2.0</td>
<td>6.0</td>
<td>14.0</td>
<td>16.0</td>
<td>7.0</td>
<td>8.0</td>
<td>0.0</td>
<td>2.0</td>
<td>0.0</td>
<td>0.0</td>
</tr>
<tr>
<td>2</td>
<td>3</td>
<td>Everton</td>
<td>Man United</td>
<td>0.0</td>
<td>2.0</td>
<td>0.0</td>
<td>1.0</td>
<td>10.0</td>
<td>12.0</td>
<td>5.0</td>
<td>5.0</td>
<td>15.0</td>
<td>14.0</td>
<td>8.0</td>
<td>6.0</td>
<td>3.0</td>
<td>1.0</td>
<td>0.0</td>
<td>0.0</td>
</tr>
</tbody>
</table>
<div class="codehilite" style="background: #f8f8f8"><pre style="line-height: 125%"><span></span><span style="color: #408080; font-style: italic"># This includes all of our betting related data, such as win/draw/lose odds, asian handicaps etc.</span>
betting <span style="color: #666666">=</span> create_betting_df(<span style="color: #BA2121">&#39;data/epl_data.csv&#39;</span>)
betting<span style="color: #666666">.</span>head(<span style="color: #666666">3</span>)
</pre></div>

<table>
<thead>
<tr>
<th></th>
<th>B365A</th>
<th>B365D</th>
<th>B365H</th>
<th>BWA</th>
<th>BWD</th>
<th>BWH</th>
<th>Bb1X2</th>
<th>BbAH</th>
<th>BbAHh</th>
<th>BbAv&lt;2.5</th>
<th>BbAv&gt;2.5</th>
<th>BbAvA</th>
<th>BbAvAHA</th>
<th>BbAvAHH</th>
<th>BbAvD</th>
<th>BbAvH</th>
<th>BbMx&lt;2.5</th>
<th>BbMx&gt;2.5</th>
<th>BbMxA</th>
<th>BbMxAHA</th>
<th>BbMxAHH</th>
<th>BbMxD</th>
<th>BbMxH</th>
<th>BbOU</th>
<th>Day</th>
<th>Div</th>
<th>IWA</th>
<th>IWD</th>
<th>IWH</th>
<th>LBA</th>
<th>LBD</th>
<th>LBH</th>
<th>Month</th>
<th>VCA</th>
<th>VCD</th>
<th>VCH</th>
<th>Year</th>
<th>homeWin</th>
<th>awayWin</th>
<th>result</th>
<th>HomeTeam</th>
<th>AwayTeam</th>
<th>gameId</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>2.75</td>
<td>3.20</td>
<td>2.5</td>
<td>2.90</td>
<td>3.30</td>
<td>2.20</td>
<td>55.0</td>
<td>20.0</td>
<td>0.00</td>
<td>1.71</td>
<td>2.02</td>
<td>2.74</td>
<td>2.04</td>
<td>1.82</td>
<td>3.16</td>
<td>2.40</td>
<td>1.80</td>
<td>2.25</td>
<td>2.9</td>
<td>2.08</td>
<td>1.86</td>
<td>3.35</td>
<td>2.60</td>
<td>35.0</td>
<td>13</td>
<td>E0</td>
<td>2.7</td>
<td>3.0</td>
<td>2.3</td>
<td>2.75</td>
<td>3.0</td>
<td>2.38</td>
<td>8</td>
<td>2.75</td>
<td>3.25</td>
<td>2.4</td>
<td>2005</td>
<td>1</td>
<td>0</td>
<td>home</td>
<td>West Ham</td>
<td>Blackburn</td>
<td>1</td>
</tr>
<tr>
<td>1</td>
<td>3.00</td>
<td>3.25</td>
<td>2.3</td>
<td>3.15</td>
<td>3.25</td>
<td>2.10</td>
<td>56.0</td>
<td>22.0</td>
<td>-0.25</td>
<td>1.70</td>
<td>2.01</td>
<td>3.05</td>
<td>1.84</td>
<td>2.01</td>
<td>3.16</td>
<td>2.20</td>
<td>1.87</td>
<td>2.20</td>
<td>3.4</td>
<td>1.92</td>
<td>2.10</td>
<td>3.30</td>
<td>2.40</td>
<td>36.0</td>
<td>13</td>
<td>E0</td>
<td>3.1</td>
<td>3.0</td>
<td>2.1</td>
<td>3.20</td>
<td>3.0</td>
<td>2.10</td>
<td>8</td>
<td>3.10</td>
<td>3.25</td>
<td>2.2</td>
<td>2005</td>
<td>0</td>
<td>0</td>
<td>draw</td>
<td>Aston Villa</td>
<td>Bolton</td>
<td>2</td>
</tr>
<tr>
<td>2</td>
<td>1.72</td>
<td>3.40</td>
<td>5.0</td>
<td>1.75</td>
<td>3.35</td>
<td>4.35</td>
<td>56.0</td>
<td>23.0</td>
<td>0.75</td>
<td>1.79</td>
<td>1.93</td>
<td>1.69</td>
<td>1.86</td>
<td>2.00</td>
<td>3.36</td>
<td>4.69</td>
<td>1.87</td>
<td>2.10</td>
<td>1.8</td>
<td>1.93</td>
<td>2.05</td>
<td>3.70</td>
<td>5.65</td>
<td>36.0</td>
<td>13</td>
<td>E0</td>
<td>1.8</td>
<td>3.1</td>
<td>3.8</td>
<td>1.83</td>
<td>3.2</td>
<td>3.75</td>
<td>8</td>
<td>1.80</td>
<td>3.30</td>
<td>4.5</td>
<td>2005</td>
<td>0</td>
<td>1</td>
<td>away</td>
<td>Everton</td>
<td>Man United</td>
<td>3</td>
</tr>
</tbody>
</table>
<div class="codehilite" style="background: #f8f8f8"><pre style="line-height: 125%"><span></span><span style="color: #408080; font-style: italic"># This includes all of the team information for each game.</span>
team_info <span style="color: #666666">=</span> create_team_info_df(<span style="color: #BA2121">&#39;data/epl_data.csv&#39;</span>)
team_info<span style="color: #666666">.</span>head(<span style="color: #666666">3</span>)
</pre></div>

<table>
<thead>
<tr>
<th></th>
<th>gameId</th>
<th>Date</th>
<th>season</th>
<th>HomeTeam</th>
<th>AwayTeam</th>
<th>FTR</th>
<th>HTR</th>
<th>Referee</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>1</td>
<td>2005-08-13</td>
<td>0506</td>
<td>West Ham</td>
<td>Blackburn</td>
<td>H</td>
<td>A</td>
<td>A Wiley</td>
</tr>
<tr>
<td>1</td>
<td>2</td>
<td>2005-08-13</td>
<td>0506</td>
<td>Aston Villa</td>
<td>Bolton</td>
<td>D</td>
<td>D</td>
<td>M Riley</td>
</tr>
<tr>
<td>2</td>
<td>3</td>
<td>2005-08-13</td>
<td>0506</td>
<td>Everton</td>
<td>Man United</td>
<td>A</td>
<td>A</td>
<td>G Poll</td>
</tr>
</tbody>
</table>
<div class="codehilite" style="background: #f8f8f8"><pre style="line-height: 125%"><span></span><span style="color: #408080; font-style: italic"># Whilst the other DataFrames date back to 2005, this DataFrame has data from 2001 to 2005.</span>
historic_games <span style="color: #666666">=</span> create_historic_games_df(<span style="color: #BA2121">&#39;data/historic_games_pre2005.csv&#39;</span>)
historic_games<span style="color: #666666">.</span>head(<span style="color: #666666">3</span>)
</pre></div>

<table>
<thead>
<tr>
<th></th>
<th>Date</th>
<th>HomeTeam</th>
<th>AwayTeam</th>
<th>FTHG</th>
<th>FTAG</th>
<th>gameId</th>
<th>season</th>
<th>homeWin</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>2001-08-18</td>
<td>Charlton</td>
<td>Everton</td>
<td>1</td>
<td>2</td>
<td>-1</td>
<td>20012002</td>
<td>0</td>
</tr>
<tr>
<td>1</td>
<td>2001-08-18</td>
<td>Derby</td>
<td>Blackburn</td>
<td>2</td>
<td>1</td>
<td>-1</td>
<td>20012002</td>
<td>1</td>
</tr>
<tr>
<td>2</td>
<td>2001-08-18</td>
<td>Leeds</td>
<td>Southampton</td>
<td>2</td>
<td>0</td>
<td>-1</td>
<td>20012002</td>
<td>1</td>
</tr>
</tbody>
</table>
<div class="codehilite" style="background: #f8f8f8"><pre style="line-height: 125%"><span></span><span style="color: #408080; font-style: italic"># This is the historic_games DataFrame appended to the df DataFrame.</span>
all_games <span style="color: #666666">=</span> create_all_games_df(<span style="color: #BA2121">&#39;data/epl_data.csv&#39;</span>, <span style="color: #BA2121">&#39;data/historic_games_pre2005.csv&#39;</span>)
all_games<span style="color: #666666">.</span>head(<span style="color: #666666">3</span>)
</pre></div>

<table>
<thead>
<tr>
<th></th>
<th>Date</th>
<th>HomeTeam</th>
<th>AwayTeam</th>
<th>FTHG</th>
<th>FTAG</th>
<th>gameId</th>
<th>season</th>
<th>homeWin</th>
<th>awayWin</th>
<th>homeWinPc5</th>
<th>homeWinPc38</th>
<th>awayWinPc5</th>
<th>awayWinPc38</th>
<th>gameIdHistoric</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>2001-08-18</td>
<td>Charlton</td>
<td>Everton</td>
<td>1.0</td>
<td>2.0</td>
<td>-1</td>
<td>20012002</td>
<td>0</td>
<td>1</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>1</td>
</tr>
<tr>
<td>1</td>
<td>2001-08-18</td>
<td>Derby</td>
<td>Blackburn</td>
<td>2.0</td>
<td>1.0</td>
<td>-1</td>
<td>20012002</td>
<td>1</td>
<td>0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>2</td>
</tr>
<tr>
<td>2</td>
<td>2001-08-18</td>
<td>Leeds</td>
<td>Southampton</td>
<td>2.0</td>
<td>0.0</td>
<td>-1</td>
<td>20012002</td>
<td>1</td>
<td>0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>3</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="feature-creation">Feature Creation<a class="headerlink" href="#feature-creation" title="Permanent link">&para;</a></h2>
<p>Now that we have all of our pre-prepared DataFrames, and we know that the data is clean, we can move onto feature creation. As is common practice with sports modelling, we are going to start by creating expontentially weighted moving averages (EMA) as features. To get a better understanding of how EMAs work, read <a href="https://en.wikipedia.org/wiki/Moving_average#Exponential_moving_average">here</a>. </p>
<p>In short, an EMA is like a simple moving average, except it weights recent instances more than older instances based on an alpha parameter. The documentation for the pandas (emw method)[<a href="https://pandas.pydata.org/pandas-docs/stable/generated/pandas.DataFrame.ewm.html">https://pandas.pydata.org/pandas-docs/stable/generated/pandas.DataFrame.ewm.html</a>] we will be using states that we can specify alpha in a number of ways. We will specify it in terms of span, where $\alpha = 2 / (span+1), span â‰¥ 1 $.</p>
<p>Let's first define a function which calculates the exponential moving average for each column in the stats DataFrame. We will then apply this function with other functions we have created, such as create_betting_features_ema, which creates moving averages of betting data.</p>
<p>However, we must first change the structure of our data. Notice that currently each row has both the Home Team's data and the Away Team's data on a single row. This makes it difficult to calculate rolling averages, so we will restructure our DataFrames to ensure each row only contains single team's data. To do this, we will define a function, reate_multiline_df_stats.</p>
<div class="codehilite" style="background: #f8f8f8"><pre style="line-height: 125%"><span></span><span style="color: #408080; font-style: italic"># Define a function which restructures our DataFrame</span>
<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">create_multiline_df_stats</span>(old_stats_df):
    <span style="color: #408080; font-style: italic"># Create a list of columns we want and their mappings to more interpretable names</span>
    home_stats_cols <span style="color: #666666">=</span> [<span style="color: #BA2121">&#39;HomeTeam&#39;</span>, <span style="color: #BA2121">&#39;FTHG&#39;</span>, <span style="color: #BA2121">&#39;FTAG&#39;</span>, <span style="color: #BA2121">&#39;HTHG&#39;</span>, <span style="color: #BA2121">&#39;HTAG&#39;</span>, <span style="color: #BA2121">&#39;HS&#39;</span>, <span style="color: #BA2121">&#39;AS&#39;</span>, <span style="color: #BA2121">&#39;HST&#39;</span>, <span style="color: #BA2121">&#39;AST&#39;</span>, <span style="color: #BA2121">&#39;HF&#39;</span>, <span style="color: #BA2121">&#39;AF&#39;</span>, <span style="color: #BA2121">&#39;HC&#39;</span>, <span style="color: #BA2121">&#39;AC&#39;</span>, <span style="color: #BA2121">&#39;HY&#39;</span>, <span style="color: #BA2121">&#39;AY&#39;</span>,
                       <span style="color: #BA2121">&#39;HR&#39;</span>, <span style="color: #BA2121">&#39;AR&#39;</span>]

    away_stats_cols <span style="color: #666666">=</span> [<span style="color: #BA2121">&#39;AwayTeam&#39;</span>, <span style="color: #BA2121">&#39;FTAG&#39;</span>, <span style="color: #BA2121">&#39;FTHG&#39;</span>, <span style="color: #BA2121">&#39;HTAG&#39;</span>, <span style="color: #BA2121">&#39;HTHG&#39;</span>, <span style="color: #BA2121">&#39;AS&#39;</span>, <span style="color: #BA2121">&#39;HS&#39;</span>, <span style="color: #BA2121">&#39;AST&#39;</span>, <span style="color: #BA2121">&#39;HST&#39;</span>, <span style="color: #BA2121">&#39;AF&#39;</span>, <span style="color: #BA2121">&#39;HF&#39;</span>, <span style="color: #BA2121">&#39;AC&#39;</span>, <span style="color: #BA2121">&#39;HC&#39;</span>, <span style="color: #BA2121">&#39;AY&#39;</span>, <span style="color: #BA2121">&#39;HY&#39;</span>,
                       <span style="color: #BA2121">&#39;AR&#39;</span>, <span style="color: #BA2121">&#39;HR&#39;</span>]

    stats_cols_mapping <span style="color: #666666">=</span> [<span style="color: #BA2121">&#39;team&#39;</span>, <span style="color: #BA2121">&#39;goalsFor&#39;</span>, <span style="color: #BA2121">&#39;goalsAgainst&#39;</span>, <span style="color: #BA2121">&#39;halfTimeGoalsFor&#39;</span>, <span style="color: #BA2121">&#39;halfTimeGoalsAgainst&#39;</span>, <span style="color: #BA2121">&#39;shotsFor&#39;</span>,
                          <span style="color: #BA2121">&#39;shotsAgainst&#39;</span>, <span style="color: #BA2121">&#39;shotsOnTargetFor&#39;</span>, <span style="color: #BA2121">&#39;shotsOnTargetAgainst&#39;</span>, <span style="color: #BA2121">&#39;freesFor&#39;</span>, <span style="color: #BA2121">&#39;freesAgainst&#39;</span>, 
                          <span style="color: #BA2121">&#39;cornersFor&#39;</span>, <span style="color: #BA2121">&#39;cornersAgainst&#39;</span>, <span style="color: #BA2121">&#39;yellowsFor&#39;</span>, <span style="color: #BA2121">&#39;yellowsAgainst&#39;</span>, <span style="color: #BA2121">&#39;redsFor&#39;</span>, <span style="color: #BA2121">&#39;redsAgainst&#39;</span>]

    <span style="color: #408080; font-style: italic"># Create a dictionary of the old column names to new column names</span>
    home_mapping <span style="color: #666666">=</span> {old_col: new_col <span style="color: #008000; font-weight: bold">for</span> old_col, new_col <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">zip</span>(home_stats_cols, stats_cols_mapping)}
    away_mapping <span style="color: #666666">=</span> {old_col: new_col <span style="color: #008000; font-weight: bold">for</span> old_col, new_col <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">zip</span>(away_stats_cols, stats_cols_mapping)}

    <span style="color: #408080; font-style: italic"># Put each team onto an individual row</span>
    multi_line_stats <span style="color: #666666">=</span> (old_stats_df[[<span style="color: #BA2121">&#39;gameId&#39;</span>] <span style="color: #666666">+</span> home_stats_cols] <span style="color: #408080; font-style: italic"># Filter for only the home team columns</span>
                    <span style="color: #666666">.</span>rename(columns<span style="color: #666666">=</span>home_mapping) <span style="color: #408080; font-style: italic"># Rename the columns</span>
                    <span style="color: #666666">.</span>assign(homeGame<span style="color: #666666">=1</span>) <span style="color: #408080; font-style: italic"># Assign homeGame=1 so that we can use a general function later</span>
                    <span style="color: #666666">.</span>append((old_stats_df[[<span style="color: #BA2121">&#39;gameId&#39;</span>] <span style="color: #666666">+</span> away_stats_cols]) <span style="color: #408080; font-style: italic"># Append the away team columns</span>
                            <span style="color: #666666">.</span>rename(columns<span style="color: #666666">=</span>away_mapping) <span style="color: #408080; font-style: italic"># Rename the away team columns</span>
                            <span style="color: #666666">.</span>assign(homeGame<span style="color: #666666">=0</span>), sort<span style="color: #666666">=</span><span style="color: #008000">True</span>)
                    <span style="color: #666666">.</span>sort_values(by<span style="color: #666666">=</span><span style="color: #BA2121">&#39;gameId&#39;</span>) <span style="color: #408080; font-style: italic"># Sort the values</span>
                    <span style="color: #666666">.</span>reset_index(drop<span style="color: #666666">=</span><span style="color: #008000">True</span>))
    <span style="color: #008000; font-weight: bold">return</span> multi_line_stats
</pre></div>

<div class="codehilite" style="background: #f8f8f8"><pre style="line-height: 125%"><span></span><span style="color: #408080; font-style: italic"># Define a function which creates an EMA DataFrame from the stats DataFrame</span>
<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">create_stats_features_ema</span>(stats, span):
    <span style="color: #408080; font-style: italic"># Create a restructured DataFrames so that we can calculate EMA</span>
    multi_line_stats <span style="color: #666666">=</span> create_multiline_df_stats(stats)

    <span style="color: #408080; font-style: italic"># Create a copy of the DataFrame</span>
    ema_features <span style="color: #666666">=</span> multi_line_stats[[<span style="color: #BA2121">&#39;gameId&#39;</span>, <span style="color: #BA2121">&#39;team&#39;</span>, <span style="color: #BA2121">&#39;homeGame&#39;</span>]]<span style="color: #666666">.</span>copy()

    <span style="color: #408080; font-style: italic"># Get the columns that we want to create EMA for</span>
    feature_names <span style="color: #666666">=</span> multi_line_stats<span style="color: #666666">.</span>drop(columns<span style="color: #666666">=</span>[<span style="color: #BA2121">&#39;gameId&#39;</span>, <span style="color: #BA2121">&#39;team&#39;</span>, <span style="color: #BA2121">&#39;homeGame&#39;</span>])<span style="color: #666666">.</span>columns

    <span style="color: #408080; font-style: italic"># Loop over the features</span>
    <span style="color: #008000; font-weight: bold">for</span> feature_name <span style="color: #AA22FF; font-weight: bold">in</span> feature_names:
        feature_ema <span style="color: #666666">=</span> (multi_line_stats<span style="color: #666666">.</span>groupby(<span style="color: #BA2121">&#39;team&#39;</span>)[feature_name] <span style="color: #408080; font-style: italic"># Calculate the EMA</span>
                                                  <span style="color: #666666">.</span>transform(<span style="color: #008000; font-weight: bold">lambda</span> row: row<span style="color: #666666">.</span>ewm(span<span style="color: #666666">=</span>span, min_periods<span style="color: #666666">=2</span>)
                                                             <span style="color: #666666">.</span>mean()
                                                             <span style="color: #666666">.</span>shift(<span style="color: #666666">1</span>))) <span style="color: #408080; font-style: italic"># Shift the data down 1 so we don&#39;t leak data</span>
        ema_features[feature_name] <span style="color: #666666">=</span> feature_ema <span style="color: #408080; font-style: italic"># Add the new feature to the DataFrame</span>
    <span style="color: #008000; font-weight: bold">return</span> ema_features
</pre></div>

<div class="codehilite" style="background: #f8f8f8"><pre style="line-height: 125%"><span></span><span style="color: #408080; font-style: italic"># Apply the function</span>
stats_features <span style="color: #666666">=</span> create_stats_features_ema(stats, span<span style="color: #666666">=5</span>)
stats_features<span style="color: #666666">.</span>tail()
</pre></div>

<table>
<thead>
<tr>
<th></th>
<th>gameId</th>
<th>team</th>
<th>homeGame</th>
<th>cornersAgainst</th>
<th>cornersFor</th>
<th>freesAgainst</th>
<th>freesFor</th>
<th>goalsAgainst</th>
<th>goalsFor</th>
<th>halfTimeGoalsAgainst</th>
<th>halfTimeGoalsFor</th>
<th>redsAgainst</th>
<th>redsFor</th>
<th>shotsAgainst</th>
<th>shotsFor</th>
<th>shotsOnTargetAgainst</th>
<th>shotsOnTargetFor</th>
<th>yellowsAgainst</th>
<th>yellowsFor</th>
</tr>
</thead>
<tbody>
<tr>
<td>9903</td>
<td>4952</td>
<td>Newcastle</td>
<td>1</td>
<td>4.301743</td>
<td>4.217300</td>
<td>11.789345</td>
<td>12.245066</td>
<td>0.797647</td>
<td>0.833658</td>
<td>0.644214</td>
<td>0.420832</td>
<td>2.323450e-10</td>
<td>3.333631e-01</td>
<td>11.335147</td>
<td>13.265955</td>
<td>3.211345</td>
<td>4.067990</td>
<td>1.848860</td>
<td>1.627140</td>
</tr>
<tr>
<td>9904</td>
<td>4953</td>
<td>Burnley</td>
<td>0</td>
<td>4.880132</td>
<td>5.165915</td>
<td>13.326703</td>
<td>8.800033</td>
<td>1.945502</td>
<td>0.667042</td>
<td>0.609440</td>
<td>0.529409</td>
<td>3.874405e-03</td>
<td>3.356120e-10</td>
<td>13.129631</td>
<td>10.642381</td>
<td>4.825874</td>
<td>3.970285</td>
<td>0.963527</td>
<td>0.847939</td>
</tr>
<tr>
<td>9905</td>
<td>4953</td>
<td>Fulham</td>
<td>1</td>
<td>4.550255</td>
<td>4.403060</td>
<td>10.188263</td>
<td>8.555589</td>
<td>2.531046</td>
<td>1.003553</td>
<td>0.860573</td>
<td>0.076949</td>
<td>1.002518e-04</td>
<td>8.670776e-03</td>
<td>17.463779</td>
<td>12.278877</td>
<td>8.334019</td>
<td>4.058213</td>
<td>0.980097</td>
<td>1.102974</td>
</tr>
<tr>
<td>9906</td>
<td>4954</td>
<td>Man United</td>
<td>1</td>
<td>3.832573</td>
<td>4.759683</td>
<td>11.640608</td>
<td>10.307946</td>
<td>1.397234</td>
<td>1.495032</td>
<td>1.034251</td>
<td>0.809280</td>
<td>6.683080e-05</td>
<td>1.320468e-05</td>
<td>8.963022</td>
<td>10.198642</td>
<td>3.216957</td>
<td>3.776900</td>
<td>1.040077</td>
<td>1.595650</td>
</tr>
<tr>
<td>9907</td>
<td>4954</td>
<td>Tottenham</td>
<td>0</td>
<td>3.042034</td>
<td>5.160211</td>
<td>8.991460</td>
<td>9.955635</td>
<td>1.332704</td>
<td>2.514789</td>
<td>0.573728</td>
<td>1.010491</td>
<td>4.522878e-08</td>
<td>1.354409e-05</td>
<td>12.543406</td>
<td>17.761004</td>
<td>3.757437</td>
<td>7.279845</td>
<td>1.478976</td>
<td>1.026601</td>
</tr>
</tbody>
</table>
<p>As we can see, we now have averages for each team. Let's create a quick table to see the top 10 teams' goalsFor average EMAs since 2005.</p>
<div class="codehilite" style="background: #f8f8f8"><pre style="line-height: 125%"><span></span>pd<span style="color: #666666">.</span>DataFrame(stats_features<span style="color: #666666">.</span>groupby(<span style="color: #BA2121">&#39;team&#39;</span>)
                           <span style="color: #666666">.</span>goalsFor
                           <span style="color: #666666">.</span>mean()
                           <span style="color: #666666">.</span>sort_values(ascending<span style="color: #666666">=</span><span style="color: #008000">False</span>)[:<span style="color: #666666">10</span>])
</pre></div>

<table>
<thead>
<tr>
<th></th>
<th>goalsFor</th>
</tr>
</thead>
<tbody>
<tr>
<td>team</td>
<td></td>
</tr>
<tr>
<td>Man United</td>
<td>1.895026</td>
</tr>
<tr>
<td>Chelsea</td>
<td>1.888892</td>
</tr>
<tr>
<td>Arsenal</td>
<td>1.876770</td>
</tr>
<tr>
<td>Man City</td>
<td>1.835863</td>
</tr>
<tr>
<td>Liverpool</td>
<td>1.771125</td>
</tr>
<tr>
<td>Tottenham</td>
<td>1.655063</td>
</tr>
<tr>
<td>Leicester</td>
<td>1.425309</td>
</tr>
<tr>
<td>Blackpool</td>
<td>1.390936</td>
</tr>
<tr>
<td>Everton</td>
<td>1.387110</td>
</tr>
<tr>
<td>Southampton</td>
<td>1.288349</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="optimising-alpha">Optimising Alpha<a class="headerlink" href="#optimising-alpha" title="Permanent link">&para;</a></h2>
<p>It looks like Man United and Chelsea have been two of the best teams since 2005, based on goalsFor. Now that we have our stats features, we may be tempted to move on. However, we have arbitrarily chosen a span of 5. How do we know that this is the best value? We don't. Let's try and optimise this value. </p>
<p>To do this, we will use a simple Logistic Regression model to create probabilistic predictions based on the stats features we created before. We will iterate a range of span values, from say, 3 to 15, and choose the value which produces a model with the lowest log loss, based on cross validation.</p>
<p>To do this, we need to restructure our DataFrame back to how it was before.</p>
<div class="codehilite" style="background: #f8f8f8"><pre style="line-height: 125%"><span></span><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">restructure_stats_features</span>(stats_features):
    non_features <span style="color: #666666">=</span> [<span style="color: #BA2121">&#39;homeGame&#39;</span>, <span style="color: #BA2121">&#39;team&#39;</span>, <span style="color: #BA2121">&#39;gameId&#39;</span>]

    stats_features_restructured <span style="color: #666666">=</span> (stats_features<span style="color: #666666">.</span>query(<span style="color: #BA2121">&#39;homeGame == 1&#39;</span>)
                                    <span style="color: #666666">.</span>rename(columns<span style="color: #666666">=</span>{col: <span style="color: #BA2121">&#39;f_&#39;</span> <span style="color: #666666">+</span> col <span style="color: #666666">+</span> <span style="color: #BA2121">&#39;Home&#39;</span> <span style="color: #008000; font-weight: bold">for</span> col <span style="color: #AA22FF; font-weight: bold">in</span> stats_features<span style="color: #666666">.</span>columns <span style="color: #008000; font-weight: bold">if</span> col <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #AA22FF; font-weight: bold">in</span> non_features})
                                    <span style="color: #666666">.</span>rename(columns<span style="color: #666666">=</span>{<span style="color: #BA2121">&#39;team&#39;</span>: <span style="color: #BA2121">&#39;HomeTeam&#39;</span>})
                                    <span style="color: #666666">.</span>pipe(pd<span style="color: #666666">.</span>merge, (stats_features<span style="color: #666666">.</span>query(<span style="color: #BA2121">&#39;homeGame == 0&#39;</span>)
                                                        <span style="color: #666666">.</span>rename(columns<span style="color: #666666">=</span>{<span style="color: #BA2121">&#39;team&#39;</span>: <span style="color: #BA2121">&#39;AwayTeam&#39;</span>})
                                                        <span style="color: #666666">.</span>rename(columns<span style="color: #666666">=</span>{col: <span style="color: #BA2121">&#39;f_&#39;</span> <span style="color: #666666">+</span> col <span style="color: #666666">+</span> <span style="color: #BA2121">&#39;Away&#39;</span> <span style="color: #008000; font-weight: bold">for</span> col <span style="color: #AA22FF; font-weight: bold">in</span> stats_features<span style="color: #666666">.</span>columns 
                                                                         <span style="color: #008000; font-weight: bold">if</span> col <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #AA22FF; font-weight: bold">in</span> non_features})), on<span style="color: #666666">=</span>[<span style="color: #BA2121">&#39;gameId&#39;</span>])
                                    <span style="color: #666666">.</span>pipe(pd<span style="color: #666666">.</span>merge, df[[<span style="color: #BA2121">&#39;gameId&#39;</span>, <span style="color: #BA2121">&#39;result&#39;</span>]], on<span style="color: #666666">=</span><span style="color: #BA2121">&#39;gameId&#39;</span>)
                                    <span style="color: #666666">.</span>dropna())
    <span style="color: #008000; font-weight: bold">return</span> stats_features_restructured

restructure_stats_features(stats_features)<span style="color: #666666">.</span>head()
</pre></div>

<table>
<thead>
<tr>
<th></th>
<th>gameId</th>
<th>HomeTeam</th>
<th>homeGame_x</th>
<th>f_cornersAgainstHome</th>
<th>f_cornersForHome</th>
<th>f_freesAgainstHome</th>
<th>f_freesForHome</th>
<th>f_goalsAgainstHome</th>
<th>f_goalsForHome</th>
<th>f_halfTimeGoalsAgainstHome</th>
<th>f_halfTimeGoalsForHome</th>
<th>f_redsAgainstHome</th>
<th>f_redsForHome</th>
<th>f_shotsAgainstHome</th>
<th>f_shotsForHome</th>
<th>f_shotsOnTargetAgainstHome</th>
<th>f_shotsOnTargetForHome</th>
<th>f_yellowsAgainstHome</th>
<th>f_yellowsForHome</th>
<th>AwayTeam</th>
<th>homeGame_y</th>
<th>f_cornersAgainstAway</th>
<th>f_cornersForAway</th>
<th>f_freesAgainstAway</th>
<th>f_freesForAway</th>
<th>f_goalsAgainstAway</th>
<th>f_goalsForAway</th>
<th>f_halfTimeGoalsAgainstAway</th>
<th>f_halfTimeGoalsForAway</th>
<th>f_redsAgainstAway</th>
<th>f_redsForAway</th>
<th>f_shotsAgainstAway</th>
<th>f_shotsForAway</th>
<th>f_shotsOnTargetAgainstAway</th>
<th>f_shotsOnTargetForAway</th>
<th>f_yellowsAgainstAway</th>
<th>f_yellowsForAway</th>
<th>result</th>
</tr>
</thead>
<tbody>
<tr>
<td>20</td>
<td>21</td>
<td>Birmingham</td>
<td>1</td>
<td>4.8</td>
<td>7.8</td>
<td>12.0</td>
<td>9.4</td>
<td>1.2</td>
<td>0.6</td>
<td>0.6</td>
<td>0.6</td>
<td>0.0</td>
<td>0.0</td>
<td>11.4</td>
<td>8.2</td>
<td>6.4</td>
<td>2.8</td>
<td>1.0</td>
<td>2.6</td>
<td>Middlesbrough</td>
<td>0</td>
<td>3.0</td>
<td>5.6</td>
<td>14.0</td>
<td>12.8</td>
<td>1.2</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.4</td>
<td>17.2</td>
<td>8.8</td>
<td>7.6</td>
<td>2.6</td>
<td>3.0</td>
<td>1.4</td>
<td>away</td>
</tr>
<tr>
<td>21</td>
<td>22</td>
<td>Portsmouth</td>
<td>1</td>
<td>2.6</td>
<td>4.6</td>
<td>21.8</td>
<td>16.6</td>
<td>2.0</td>
<td>0.6</td>
<td>1.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>8.0</td>
<td>10.4</td>
<td>3.6</td>
<td>4.0</td>
<td>3.2</td>
<td>1.8</td>
<td>Aston Villa</td>
<td>0</td>
<td>9.8</td>
<td>7.0</td>
<td>14.2</td>
<td>18.2</td>
<td>1.4</td>
<td>0.8</td>
<td>0.8</td>
<td>0.8</td>
<td>0.0</td>
<td>0.0</td>
<td>16.0</td>
<td>3.0</td>
<td>9.6</td>
<td>2.6</td>
<td>2.0</td>
<td>0.6</td>
<td>draw</td>
</tr>
<tr>
<td>22</td>
<td>23</td>
<td>Sunderland</td>
<td>1</td>
<td>5.0</td>
<td>5.0</td>
<td>11.6</td>
<td>18.0</td>
<td>1.8</td>
<td>0.4</td>
<td>1.0</td>
<td>0.4</td>
<td>0.4</td>
<td>0.6</td>
<td>14.6</td>
<td>6.0</td>
<td>5.2</td>
<td>3.2</td>
<td>1.2</td>
<td>2.6</td>
<td>Man City</td>
<td>0</td>
<td>7.8</td>
<td>3.6</td>
<td>8.6</td>
<td>12.4</td>
<td>0.6</td>
<td>1.2</td>
<td>0.6</td>
<td>0.6</td>
<td>0.0</td>
<td>0.0</td>
<td>10.6</td>
<td>11.4</td>
<td>2.4</td>
<td>6.8</td>
<td>3.0</td>
<td>1.4</td>
<td>away</td>
</tr>
<tr>
<td>23</td>
<td>24</td>
<td>Arsenal</td>
<td>1</td>
<td>3.0</td>
<td>7.4</td>
<td>17.0</td>
<td>18.6</td>
<td>0.6</td>
<td>0.8</td>
<td>0.0</td>
<td>0.0</td>
<td>0.4</td>
<td>0.0</td>
<td>6.2</td>
<td>11.4</td>
<td>4.0</td>
<td>6.6</td>
<td>1.6</td>
<td>1.8</td>
<td>Fulham</td>
<td>0</td>
<td>7.2</td>
<td>3.0</td>
<td>20.8</td>
<td>13.2</td>
<td>1.2</td>
<td>0.6</td>
<td>0.6</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>12.4</td>
<td>10.8</td>
<td>7.0</td>
<td>5.2</td>
<td>2.0</td>
<td>1.6</td>
<td>home</td>
</tr>
<tr>
<td>24</td>
<td>25</td>
<td>Blackburn</td>
<td>1</td>
<td>1.4</td>
<td>7.2</td>
<td>12.8</td>
<td>21.2</td>
<td>1.8</td>
<td>1.6</td>
<td>0.0</td>
<td>1.0</td>
<td>0.0</td>
<td>0.4</td>
<td>10.0</td>
<td>14.0</td>
<td>4.4</td>
<td>7.4</td>
<td>1.2</td>
<td>1.6</td>
<td>Tottenham</td>
<td>0</td>
<td>6.4</td>
<td>3.8</td>
<td>11.2</td>
<td>18.8</td>
<td>0.0</td>
<td>2.0</td>
<td>0.0</td>
<td>0.4</td>
<td>0.0</td>
<td>0.0</td>
<td>11.6</td>
<td>15.2</td>
<td>4.6</td>
<td>7.2</td>
<td>0.6</td>
<td>2.6</td>
<td>draw</td>
</tr>
</tbody>
</table>
<p>Now let's write a function that optimises our span based on log loss of the output of a Logistic Regression model.</p>
<div class="codehilite" style="background: #f8f8f8"><pre style="line-height: 125%"><span></span><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">optimise_alpha</span>(features):
    le <span style="color: #666666">=</span> LabelEncoder()
    y <span style="color: #666666">=</span> le<span style="color: #666666">.</span>fit_transform(features<span style="color: #666666">.</span>result) <span style="color: #408080; font-style: italic"># Encode the result from away, draw, home win to 0, 1, 2</span>
    X <span style="color: #666666">=</span> features[[col <span style="color: #008000; font-weight: bold">for</span> col <span style="color: #AA22FF; font-weight: bold">in</span> features<span style="color: #666666">.</span>columns <span style="color: #008000; font-weight: bold">if</span> col<span style="color: #666666">.</span>startswith(<span style="color: #BA2121">&#39;f_&#39;</span>)]] <span style="color: #408080; font-style: italic"># Only get the features - these all start with f_</span>
    lr <span style="color: #666666">=</span> LogisticRegression()

    kfold <span style="color: #666666">=</span> StratifiedKFold(n_splits<span style="color: #666666">=5</span>)
    ave_cv_score <span style="color: #666666">=</span> cross_val_score(lr, X, y, scoring<span style="color: #666666">=</span><span style="color: #BA2121">&#39;neg_log_loss&#39;</span>, cv<span style="color: #666666">=</span>kfold)<span style="color: #666666">.</span>mean()
    <span style="color: #008000; font-weight: bold">return</span> ave_cv_score
</pre></div>

<div class="codehilite" style="background: #f8f8f8"><pre style="line-height: 125%"><span></span>best_score <span style="color: #666666">=</span> np<span style="color: #666666">.</span>float(<span style="color: #BA2121">&#39;inf&#39;</span>)
best_span <span style="color: #666666">=</span> <span style="color: #666666">0</span>
cv_scores <span style="color: #666666">=</span> []

<span style="color: #408080; font-style: italic"># Iterate over a range of spans</span>
<span style="color: #008000; font-weight: bold">for</span> span <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">range</span>(<span style="color: #666666">1</span>, <span style="color: #666666">120</span>, <span style="color: #666666">3</span>):
    stats_features <span style="color: #666666">=</span> create_stats_features_ema(stats, span<span style="color: #666666">=</span>span)
    restructured_stats_features <span style="color: #666666">=</span> restructure_stats_features(stats_features)
    cv_score <span style="color: #666666">=</span> optimise_alpha(restructured_stats_features)
    cv_scores<span style="color: #666666">.</span>append(cv_score)

    <span style="color: #008000; font-weight: bold">if</span> cv_score <span style="color: #666666">*</span> <span style="color: #666666">-1</span> <span style="color: #666666">&lt;</span> best_score:
        best_score <span style="color: #666666">=</span> cv_score <span style="color: #666666">*</span> <span style="color: #666666">-1</span>
        best_span <span style="color: #666666">=</span> span
</pre></div>

<div class="codehilite" style="background: #f8f8f8"><pre style="line-height: 125%"><span></span>plt<span style="color: #666666">.</span>style<span style="color: #666666">.</span>use(<span style="color: #BA2121">&#39;ggplot&#39;</span>)
plt<span style="color: #666666">.</span>plot(<span style="color: #008000">list</span>(<span style="color: #008000">range</span>(<span style="color: #666666">1</span>, <span style="color: #666666">120</span>, <span style="color: #666666">3</span>)), (pd<span style="color: #666666">.</span>Series(cv_scores)<span style="color: #666666">*-1</span>)) <span style="color: #408080; font-style: italic"># Plot our results</span>

plt<span style="color: #666666">.</span>title(<span style="color: #BA2121">&quot;Optimising alpha&quot;</span>)
plt<span style="color: #666666">.</span>xlabel(<span style="color: #BA2121">&quot;Span&quot;</span>)
plt<span style="color: #666666">.</span>ylabel(<span style="color: #BA2121">&quot;Log Loss&quot;</span>)
plt<span style="color: #666666">.</span>show()

<span style="color: #008000; font-weight: bold">print</span>(<span style="color: #BA2121">&quot;Our lowest log loss ({:2f}) occurred at a span of {}&quot;</span><span style="color: #666666">.</span>format(best_score, best_span))
</pre></div>

<p><img alt="png" src="../img/output_20_0_EPL.png" /></p>
<div class="codehilite" style="background: #f8f8f8"><pre style="line-height: 125%"><span></span>Our lowest log loss (0.980835) occurred at a span of 55
</pre></div>


<p>The above method is just an example of how you can optimise hyparameters. Obviously this example has many limitations, such as attempting to optimise each statistic with the same alpha. However, for the rest of these tutorial series we will use this span value.</p>
<p>Now let's create the rest of our features. For thorough explanations and the actual code behind some of the functions used, please refer to the data_preparation_functions.py script.</p>
<hr />
<h2 id="creating-our-features-dataframe">Creating our Features DataFrame<a class="headerlink" href="#creating-our-features-dataframe" title="Permanent link">&para;</a></h2>
<p>We will utilise pre-made functions to create all of our features in just a few lines of code.</p>
<p>As part of this process we will create features which include margin weighted elo, an exponential average for asian handicap data, and odds as features.</p>
<p>Our Elo function is essentially the same as the one we created in the AFL tutorial; if you would like to know more about Elo models please read <a href="https://www.betfair.com.au/hub/better-betting/betting-strategies/tennis/tennis-elo-modelling/">this</a> article.</p>
<p>Note that the cell below may take a few minutes to run.</p>
<p><div class="codehilite" style="background: #f8f8f8"><pre style="line-height: 125%"><span></span><span style="color: #408080; font-style: italic"># Create feature DataFrames</span>
features_all_games <span style="color: #666666">=</span> create_all_games_features(all_games)
</pre></div>
    C:\Users\wardj\Documents\Betfair Public Github\predictive-models\epl\data_preparation_functions.py:419: RuntimeWarning: invalid value encountered in double_scalars
      .pipe(lambda df: (df.eloAgainst * df[goalsForOrAgainstCol]).sum() / df.eloAgainst.sum()))</p>
<p>The features_all_games df includes elo for each team, as well as their win percentage at home and away over the past 5 and 38 games. For more information on how it was calculated, read through the data_preparation_functions script.</p>
<div class="codehilite" style="background: #f8f8f8"><pre style="line-height: 125%"><span></span>features_all_games<span style="color: #666666">.</span>head(<span style="color: #666666">3</span>)
</pre></div>

<table>
<thead>
<tr>
<th></th>
<th>Date</th>
<th>awayWin</th>
<th>awayWinPc38</th>
<th>awayWinPc5</th>
<th>eloAgainst</th>
<th>eloFor</th>
<th>gameId</th>
<th>gameIdHistoric</th>
<th>goalsAgainst</th>
<th>goalsFor</th>
<th>homeGame</th>
<th>homeWin</th>
<th>homeWinPc38</th>
<th>homeWinPc5</th>
<th>season</th>
<th>team</th>
<th>wtEloGoalsFor</th>
<th>wtEloGoalsAgainst</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>2001-08-18</td>
<td>1</td>
<td>NaN</td>
<td>NaN</td>
<td>1500.0</td>
<td>1500.0</td>
<td>-1</td>
<td>1</td>
<td>2.0</td>
<td>1.0</td>
<td>1</td>
<td>0</td>
<td>NaN</td>
<td>NaN</td>
<td>20012002</td>
<td>Charlton</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr>
<td>1</td>
<td>2001-08-18</td>
<td>1</td>
<td>NaN</td>
<td>NaN</td>
<td>1500.0</td>
<td>1500.0</td>
<td>-1</td>
<td>1</td>
<td>1.0</td>
<td>2.0</td>
<td>0</td>
<td>0</td>
<td>NaN</td>
<td>NaN</td>
<td>20012002</td>
<td>Everton</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr>
<td>2</td>
<td>2001-08-18</td>
<td>0</td>
<td>NaN</td>
<td>NaN</td>
<td>1500.0</td>
<td>1500.0</td>
<td>-1</td>
<td>2</td>
<td>1.0</td>
<td>2.0</td>
<td>1</td>
<td>1</td>
<td>NaN</td>
<td>NaN</td>
<td>20012002</td>
<td>Derby</td>
<td>NaN</td>
<td>NaN</td>
</tr>
</tbody>
</table>
<p>The features_stats df includes all the expontential weighted averages for each stat in the stats df.</p>
<div class="codehilite" style="background: #f8f8f8"><pre style="line-height: 125%"><span></span><span style="color: #408080; font-style: italic"># Create feature stats df</span>
features_stats <span style="color: #666666">=</span> create_stats_features_ema(stats, span<span style="color: #666666">=</span>best_span)
features_stats<span style="color: #666666">.</span>tail(<span style="color: #666666">3</span>)
</pre></div>

<table>
<thead>
<tr>
<th></th>
<th>gameId</th>
<th>team</th>
<th>homeGame</th>
<th>cornersAgainst</th>
<th>cornersFor</th>
<th>freesAgainst</th>
<th>freesFor</th>
<th>goalsAgainst</th>
<th>goalsFor</th>
<th>halfTimeGoalsAgainst</th>
<th>halfTimeGoalsFor</th>
<th>redsAgainst</th>
<th>redsFor</th>
<th>shotsAgainst</th>
<th>shotsFor</th>
<th>shotsOnTargetAgainst</th>
<th>shotsOnTargetFor</th>
<th>yellowsAgainst</th>
<th>yellowsFor</th>
</tr>
</thead>
<tbody>
<tr>
<td>9905</td>
<td>4953</td>
<td>Fulham</td>
<td>1</td>
<td>6.006967</td>
<td>5.045733</td>
<td>10.228997</td>
<td>9.965651</td>
<td>2.147069</td>
<td>1.093550</td>
<td>0.630485</td>
<td>0.364246</td>
<td>0.032937</td>
<td>0.043696</td>
<td>16.510067</td>
<td>11.718122</td>
<td>7.184386</td>
<td>4.645762</td>
<td>1.310424</td>
<td>1.389716</td>
</tr>
<tr>
<td>9906</td>
<td>4954</td>
<td>Man United</td>
<td>1</td>
<td>4.463018</td>
<td>5.461075</td>
<td>11.605712</td>
<td>10.870367</td>
<td>0.843222</td>
<td>1.586308</td>
<td>0.427065</td>
<td>0.730650</td>
<td>0.042588</td>
<td>0.027488</td>
<td>10.865754</td>
<td>13.003121</td>
<td>3.562675</td>
<td>4.626450</td>
<td>1.740735</td>
<td>1.712785</td>
</tr>
<tr>
<td>9907</td>
<td>4954</td>
<td>Tottenham</td>
<td>0</td>
<td>3.868619</td>
<td>6.362901</td>
<td>10.784145</td>
<td>10.140388</td>
<td>0.954928</td>
<td>2.100166</td>
<td>0.439129</td>
<td>0.799968</td>
<td>0.024351</td>
<td>0.026211</td>
<td>9.947515</td>
<td>16.460598</td>
<td>3.370010</td>
<td>6.136120</td>
<td>1.925005</td>
<td>1.364268</td>
</tr>
</tbody>
</table>
<p>The features_odds df includes a moving average of some of the odds data.</p>
<div class="codehilite" style="background: #f8f8f8"><pre style="line-height: 125%"><span></span><span style="color: #408080; font-style: italic"># Create feature_odds df</span>
features_odds <span style="color: #666666">=</span> create_betting_features_ema(betting, span<span style="color: #666666">=10</span>)
features_odds<span style="color: #666666">.</span>tail(<span style="color: #666666">3</span>)
</pre></div>

<table>
<thead>
<tr>
<th></th>
<th>gameId</th>
<th>team</th>
<th>avAsianHandicapOddsAgainst</th>
<th>avAsianHandicapOddsFor</th>
<th>avgreaterthan2.5</th>
<th>avlessthan2.5</th>
<th>sizeOfHandicap</th>
</tr>
</thead>
<tbody>
<tr>
<td>9905</td>
<td>4953</td>
<td>Fulham</td>
<td>1.884552</td>
<td>1.985978</td>
<td>1.756776</td>
<td>2.128261</td>
<td>0.502253</td>
</tr>
<tr>
<td>9906</td>
<td>4954</td>
<td>Man United</td>
<td>1.871586</td>
<td>2.031787</td>
<td>1.900655</td>
<td>1.963478</td>
<td>-0.942445</td>
</tr>
<tr>
<td>9907</td>
<td>4954</td>
<td>Tottenham</td>
<td>1.947833</td>
<td>1.919607</td>
<td>1.629089</td>
<td>2.383593</td>
<td>-1.235630</td>
</tr>
</tbody>
</table>
<p>The features market values has market values and the % of total market for each position. These values are in millions.</p>
<div class="codehilite" style="background: #f8f8f8"><pre style="line-height: 125%"><span></span><span style="color: #408080; font-style: italic"># Create feature market values df</span>
features_market_values <span style="color: #666666">=</span> create_market_values_features(df) <span style="color: #408080; font-style: italic"># This creates a df with one game per row</span>
features_market_values<span style="color: #666666">.</span>head(<span style="color: #666666">3</span>)
</pre></div>

<table>
<thead>
<tr>
<th></th>
<th>gameId</th>
<th>Year</th>
<th>HomeTeam</th>
<th>AwayTeam</th>
<th>defMktValH</th>
<th>attMktValH</th>
<th>gkMktValH</th>
<th>totalMktValH</th>
<th>midMktValH</th>
<th>defMktValA</th>
<th>attMktValA</th>
<th>gkMktValA</th>
<th>totalMktValA</th>
<th>midMktValA</th>
<th>attMktH%</th>
<th>attMktA%</th>
<th>midMktH%</th>
<th>midMktA%</th>
<th>defMktH%</th>
<th>defMktA%</th>
<th>gkMktH%</th>
<th>gkMktA%</th>
<th>totalMktH%</th>
<th>totalMktA%</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>1</td>
<td>2005</td>
<td>West Ham</td>
<td>Blackburn</td>
<td>16.90</td>
<td>18.50</td>
<td>6.40</td>
<td>46.40</td>
<td>4.60</td>
<td>27.25</td>
<td>13.00</td>
<td>3.25</td>
<td>70.70</td>
<td>27.20</td>
<td>2.252911</td>
<td>1.583126</td>
<td>0.588168</td>
<td>3.477861</td>
<td>2.486940</td>
<td>4.010007</td>
<td>4.524247</td>
<td>2.297469</td>
<td>1.913986</td>
<td>2.916354</td>
</tr>
<tr>
<td>1</td>
<td>2</td>
<td>2005</td>
<td>Aston Villa</td>
<td>Bolton</td>
<td>27.63</td>
<td>31.85</td>
<td>7.60</td>
<td>105.83</td>
<td>38.75</td>
<td>9.60</td>
<td>24.55</td>
<td>8.50</td>
<td>72.40</td>
<td>29.75</td>
<td>3.878659</td>
<td>2.989673</td>
<td>4.954673</td>
<td>3.803910</td>
<td>4.065926</td>
<td>1.412700</td>
<td>5.372543</td>
<td>6.008766</td>
<td>4.365456</td>
<td>2.986478</td>
</tr>
<tr>
<td>2</td>
<td>3</td>
<td>2005</td>
<td>Everton</td>
<td>Man United</td>
<td>44.35</td>
<td>31.38</td>
<td>8.55</td>
<td>109.78</td>
<td>25.50</td>
<td>82.63</td>
<td>114.60</td>
<td>9.25</td>
<td>288.48</td>
<td>82.00</td>
<td>3.821423</td>
<td>13.955867</td>
<td>3.260494</td>
<td>10.484727</td>
<td>6.526378</td>
<td>12.159517</td>
<td>6.044111</td>
<td>6.538951</td>
<td>4.528392</td>
<td>11.899714</td>
</tr>
</tbody>
</table>
<div class="codehilite" style="background: #f8f8f8"><pre style="line-height: 125%"><span></span>all_games_cols <span style="color: #666666">=</span> [<span style="color: #BA2121">&#39;Date&#39;</span>, <span style="color: #BA2121">&#39;gameId&#39;</span>, <span style="color: #BA2121">&#39;team&#39;</span>, <span style="color: #BA2121">&#39;season&#39;</span>, <span style="color: #BA2121">&#39;homeGame&#39;</span>, <span style="color: #BA2121">&#39;homeWinPc38&#39;</span>, <span style="color: #BA2121">&#39;homeWinPc5&#39;</span>, <span style="color: #BA2121">&#39;awayWinPc38&#39;</span>, <span style="color: #BA2121">&#39;awayWinPc5&#39;</span>, <span style="color: #BA2121">&#39;eloFor&#39;</span>, <span style="color: #BA2121">&#39;eloAgainst&#39;</span>, <span style="color: #BA2121">&#39;wtEloGoalsFor&#39;</span>, <span style="color: #BA2121">&#39;wtEloGoalsAgainst&#39;</span>]

<span style="color: #408080; font-style: italic"># Join the features together</span>
features_multi_line <span style="color: #666666">=</span> (features_all_games[all_games_cols]
                                         <span style="color: #666666">.</span>pipe(pd<span style="color: #666666">.</span>merge, features_stats<span style="color: #666666">.</span>drop(columns<span style="color: #666666">=</span><span style="color: #BA2121">&#39;homeGame&#39;</span>), on<span style="color: #666666">=</span>[<span style="color: #BA2121">&#39;gameId&#39;</span>, <span style="color: #BA2121">&#39;team&#39;</span>])
                                         <span style="color: #666666">.</span>pipe(pd<span style="color: #666666">.</span>merge, features_odds, on<span style="color: #666666">=</span>[<span style="color: #BA2121">&#39;gameId&#39;</span>, <span style="color: #BA2121">&#39;team&#39;</span>]))
</pre></div>

<div class="codehilite" style="background: #f8f8f8"><pre style="line-height: 125%"><span></span><span style="color: #408080; font-style: italic"># Put each instance on an individual row</span>
features_with_na <span style="color: #666666">=</span> put_features_on_one_line(features_multi_line)

market_val_feature_names <span style="color: #666666">=</span> [<span style="color: #BA2121">&#39;attMktH%&#39;</span>, <span style="color: #BA2121">&#39;attMktA%&#39;</span>, <span style="color: #BA2121">&#39;midMktH%&#39;</span>, <span style="color: #BA2121">&#39;midMktA%&#39;</span>, <span style="color: #BA2121">&#39;defMktH%&#39;</span>, <span style="color: #BA2121">&#39;defMktA%&#39;</span>, <span style="color: #BA2121">&#39;gkMktH%&#39;</span>, <span style="color: #BA2121">&#39;gkMktA%&#39;</span>, <span style="color: #BA2121">&#39;totalMktH%&#39;</span>, <span style="color: #BA2121">&#39;totalMktA%&#39;</span>]

<span style="color: #408080; font-style: italic"># Merge our team values dataframe to features and result from df</span>
features_with_na <span style="color: #666666">=</span> (features_with_na<span style="color: #666666">.</span>pipe(pd<span style="color: #666666">.</span>merge, (features_market_values[market_val_feature_names <span style="color: #666666">+</span> [<span style="color: #BA2121">&#39;gameId&#39;</span>]])
                                                      <span style="color: #666666">.</span>rename({col: <span style="color: #BA2121">&#39;f_&#39;</span> <span style="color: #666666">+</span> col <span style="color: #008000; font-weight: bold">for</span> col <span style="color: #AA22FF; font-weight: bold">in</span> market_val_feature_names}), on<span style="color: #666666">=</span><span style="color: #BA2121">&#39;gameId&#39;</span>)
                            <span style="color: #666666">.</span>pipe(pd<span style="color: #666666">.</span>merge, df[[<span style="color: #BA2121">&#39;HomeTeam&#39;</span>, <span style="color: #BA2121">&#39;AwayTeam&#39;</span>, <span style="color: #BA2121">&#39;gameId&#39;</span>, <span style="color: #BA2121">&#39;result&#39;</span>, <span style="color: #BA2121">&#39;B365A&#39;</span>, <span style="color: #BA2121">&#39;B365D&#39;</span>, <span style="color: #BA2121">&#39;B365H&#39;</span>]], on<span style="color: #666666">=</span>[<span style="color: #BA2121">&#39;HomeTeam&#39;</span>, <span style="color: #BA2121">&#39;AwayTeam&#39;</span>, <span style="color: #BA2121">&#39;gameId&#39;</span>]))

<span style="color: #408080; font-style: italic"># Drop NAs from calculating the rolling averages - don&#39;t drop Win Pc 38 and Win Pc 5 columns</span>
features <span style="color: #666666">=</span> features_with_na<span style="color: #666666">.</span>dropna(subset<span style="color: #666666">=</span>features_with_na<span style="color: #666666">.</span>drop(columns<span style="color: #666666">=</span>[col <span style="color: #008000; font-weight: bold">for</span> col <span style="color: #AA22FF; font-weight: bold">in</span> features_with_na<span style="color: #666666">.</span>columns <span style="color: #008000; font-weight: bold">if</span> <span style="color: #BA2121">&#39;WinPc&#39;</span> <span style="color: #AA22FF; font-weight: bold">in</span> col])<span style="color: #666666">.</span>columns)

<span style="color: #408080; font-style: italic"># Fill NAs for the Win Pc columns</span>
features <span style="color: #666666">=</span> features<span style="color: #666666">.</span>fillna(features<span style="color: #666666">.</span>mean())
</pre></div>

<div class="codehilite" style="background: #f8f8f8"><pre style="line-height: 125%"><span></span>features<span style="color: #666666">.</span>head(<span style="color: #666666">3</span>)
</pre></div>

<table>
<thead>
<tr>
<th></th>
<th>Date</th>
<th>gameId</th>
<th>HomeTeam</th>
<th>season</th>
<th>homeGame</th>
<th>f_homeWinPc38Home</th>
<th>f_homeWinPc5Home</th>
<th>f_awayWinPc38Home</th>
<th>f_awayWinPc5Home</th>
<th>f_eloForHome</th>
<th>f_eloAgainstHome</th>
<th>f_wtEloGoalsForHome</th>
<th>f_wtEloGoalsAgainstHome</th>
<th>f_cornersAgainstHome</th>
<th>f_cornersForHome</th>
<th>f_freesAgainstHome</th>
<th>f_freesForHome</th>
<th>f_goalsAgainstHome</th>
<th>f_goalsForHome</th>
<th>f_halfTimeGoalsAgainstHome</th>
<th>f_halfTimeGoalsForHome</th>
<th>f_redsAgainstHome</th>
<th>f_redsForHome</th>
<th>f_shotsAgainstHome</th>
<th>f_shotsForHome</th>
<th>f_shotsOnTargetAgainstHome</th>
<th>f_shotsOnTargetForHome</th>
<th>f_yellowsAgainstHome</th>
<th>f_yellowsForHome</th>
<th>f_avAsianHandicapOddsAgainstHome</th>
<th>f_avAsianHandicapOddsForHome</th>
<th>f_avgreaterthan2.5Home</th>
<th>f_avlessthan2.5Home</th>
<th>f_sizeOfHandicapHome</th>
<th>AwayTeam</th>
<th>f_homeWinPc38Away</th>
<th>f_homeWinPc5Away</th>
<th>f_awayWinPc38Away</th>
<th>f_awayWinPc5Away</th>
<th>f_eloForAway</th>
<th>f_eloAgainstAway</th>
<th>f_wtEloGoalsForAway</th>
<th>f_wtEloGoalsAgainstAway</th>
<th>f_cornersAgainstAway</th>
<th>f_cornersForAway</th>
<th>f_freesAgainstAway</th>
<th>f_freesForAway</th>
<th>f_goalsAgainstAway</th>
<th>f_goalsForAway</th>
<th>f_halfTimeGoalsAgainstAway</th>
<th>f_halfTimeGoalsForAway</th>
<th>f_redsAgainstAway</th>
<th>f_redsForAway</th>
<th>f_shotsAgainstAway</th>
<th>f_shotsForAway</th>
<th>f_shotsOnTargetAgainstAway</th>
<th>f_shotsOnTargetForAway</th>
<th>f_yellowsAgainstAway</th>
<th>f_yellowsForAway</th>
<th>f_avAsianHandicapOddsAgainstAway</th>
<th>f_avAsianHandicapOddsForAway</th>
<th>f_avgreaterthan2.5Away</th>
<th>f_avlessthan2.5Away</th>
<th>f_sizeOfHandicapAway</th>
<th>attMktH%</th>
<th>attMktA%</th>
<th>midMktH%</th>
<th>midMktA%</th>
<th>defMktH%</th>
<th>defMktA%</th>
<th>gkMktH%</th>
<th>gkMktA%</th>
<th>totalMktH%</th>
<th>totalMktA%</th>
<th>result</th>
<th>B365A</th>
<th>B365D</th>
<th>B365H</th>
</tr>
</thead>
<tbody>
<tr>
<td>20</td>
<td>2005-08-23</td>
<td>21</td>
<td>Birmingham</td>
<td>0506</td>
<td>1</td>
<td>0.394737</td>
<td>0.4</td>
<td>0.263158</td>
<td>0.2</td>
<td>1478.687038</td>
<td>1492.866048</td>
<td>1.061763</td>
<td>1.260223</td>
<td>4.981818</td>
<td>7.527273</td>
<td>12.000000</td>
<td>9.945455</td>
<td>1.018182</td>
<td>0.509091</td>
<td>0.509091</td>
<td>0.509091</td>
<td>0.000000</td>
<td>0.000000</td>
<td>11.945455</td>
<td>8.018182</td>
<td>6.490909</td>
<td>2.981818</td>
<td>1.000000</td>
<td>2.509091</td>
<td>1.9090</td>
<td>1.9455</td>
<td>2.0510</td>
<td>1.6735</td>
<td>-0.1375</td>
<td>Middlesbrough</td>
<td>0.394737</td>
<td>0.4</td>
<td>0.263158</td>
<td>0.2</td>
<td>1492.866048</td>
<td>1478.687038</td>
<td>1.12994</td>
<td>1.279873</td>
<td>2.545455</td>
<td>5.509091</td>
<td>13.545455</td>
<td>13.436364</td>
<td>1.018182</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.0</td>
<td>0.490909</td>
<td>17.018182</td>
<td>8.072727</td>
<td>7.509091</td>
<td>2.509091</td>
<td>3.0</td>
<td>1.490909</td>
<td>1.9395</td>
<td>1.9095</td>
<td>2.0035</td>
<td>1.7155</td>
<td>0.3875</td>
<td>5.132983</td>
<td>5.260851</td>
<td>3.341048</td>
<td>4.289788</td>
<td>3.502318</td>
<td>4.168935</td>
<td>2.332815</td>
<td>3.216457</td>
<td>3.934396</td>
<td>4.522205</td>
<td>away</td>
<td>2.75</td>
<td>3.2</td>
<td>2.50</td>
</tr>
<tr>
<td>21</td>
<td>2005-08-23</td>
<td>22</td>
<td>Portsmouth</td>
<td>0506</td>
<td>1</td>
<td>0.447368</td>
<td>0.4</td>
<td>0.263158</td>
<td>0.4</td>
<td>1405.968416</td>
<td>1489.229314</td>
<td>1.147101</td>
<td>1.503051</td>
<td>2.509091</td>
<td>4.963636</td>
<td>21.981818</td>
<td>16.054545</td>
<td>2.000000</td>
<td>0.509091</td>
<td>1.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>8.454545</td>
<td>10.490909</td>
<td>3.963636</td>
<td>4.454545</td>
<td>3.018182</td>
<td>1.527273</td>
<td>1.8965</td>
<td>1.9690</td>
<td>2.0040</td>
<td>1.7005</td>
<td>0.2500</td>
<td>Aston Villa</td>
<td>0.447368</td>
<td>0.4</td>
<td>0.263158</td>
<td>0.4</td>
<td>1489.229314</td>
<td>1405.968416</td>
<td>1.17516</td>
<td>1.263229</td>
<td>9.527273</td>
<td>7.000000</td>
<td>14.472727</td>
<td>17.563636</td>
<td>1.490909</td>
<td>0.981818</td>
<td>0.981818</td>
<td>0.981818</td>
<td>0.0</td>
<td>0.000000</td>
<td>15.545455</td>
<td>3.000000</td>
<td>9.054545</td>
<td>2.509091</td>
<td>2.0</td>
<td>0.509091</td>
<td>1.8565</td>
<td>1.9770</td>
<td>1.8505</td>
<td>1.8485</td>
<td>0.7125</td>
<td>3.738614</td>
<td>3.878659</td>
<td>4.494368</td>
<td>4.954673</td>
<td>2.884262</td>
<td>4.065926</td>
<td>3.746642</td>
<td>5.372543</td>
<td>3.743410</td>
<td>4.365456</td>
<td>draw</td>
<td>2.75</td>
<td>3.2</td>
<td>2.50</td>
</tr>
<tr>
<td>22</td>
<td>2005-08-23</td>
<td>23</td>
<td>Sunderland</td>
<td>0506</td>
<td>1</td>
<td>0.236842</td>
<td>0.0</td>
<td>0.236842</td>
<td>0.4</td>
<td>1277.888970</td>
<td>1552.291880</td>
<td>0.650176</td>
<td>1.543716</td>
<td>5.000000</td>
<td>5.000000</td>
<td>12.418182</td>
<td>17.545455</td>
<td>1.981818</td>
<td>0.490909</td>
<td>1.000000</td>
<td>0.490909</td>
<td>0.490909</td>
<td>0.509091</td>
<td>14.509091</td>
<td>6.909091</td>
<td>5.018182</td>
<td>3.927273</td>
<td>1.018182</td>
<td>2.509091</td>
<td>1.8520</td>
<td>1.9915</td>
<td>1.8535</td>
<td>1.8500</td>
<td>0.7125</td>
<td>Man City</td>
<td>0.236842</td>
<td>0.0</td>
<td>0.236842</td>
<td>0.4</td>
<td>1552.291880</td>
<td>1277.888970</td>
<td>1.28875</td>
<td>1.287367</td>
<td>7.527273</td>
<td>3.509091</td>
<td>8.963636</td>
<td>12.490909</td>
<td>0.509091</td>
<td>1.018182</td>
<td>0.509091</td>
<td>0.509091</td>
<td>0.0</td>
<td>0.000000</td>
<td>10.963636</td>
<td>11.945455</td>
<td>2.490909</td>
<td>6.981818</td>
<td>3.0</td>
<td>1.490909</td>
<td>1.8150</td>
<td>2.0395</td>
<td>2.0060</td>
<td>1.7095</td>
<td>-0.2000</td>
<td>0.706318</td>
<td>3.750792</td>
<td>1.476812</td>
<td>1.070209</td>
<td>2.634096</td>
<td>4.455890</td>
<td>0.777605</td>
<td>4.913050</td>
<td>1.499427</td>
<td>3.151477</td>
<td>away</td>
<td>2.50</td>
<td>3.2</td>
<td>2.75</td>
</tr>
</tbody>
</table>
<p>We now have a features DataFrame ready, with all the feature columns beginning with the "f_". In the next tutorial, we will walk through the modelling process to try and find the best type of model to use.</p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../EPLmodelPart1/" title="EPL 01. Data acquisition & exploration" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                EPL 01. Data acquisition & exploration
              </span>
            </div>
          </a>
        
        
          <a href="../EPLmodelPart3/" title="EPL 03. Model building & hyperparameter tuning" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                EPL 03. Model building & hyperparameter tuning
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
      </div>
      
        
  <div class="md-footer-social">
    <link rel="stylesheet" href="../../assets/fonts/font-awesome.css">
    
      <a href="https://twitter.com/Betfair_Aus" class="md-footer-social__link fa fa-twitter"></a>
    
      <a href="https://linkedin.com/company/betfair-australia" class="md-footer-social__link fa fa-linkedin"></a>
    
      <a href="https://facebook.com/betfairaustralia" class="md-footer-social__link fa fa-facebook"></a>
    
      <a href="https://youtube.com/user/betfairaus" class="md-footer-social__link fa fa-youtube"></a>
    
      <a href="https://github.com/betfair-datascientists" class="md-footer-social__link fa fa-github"></a>
    
  </div>

      
    </div>
    <div class="bf-footer">
      <p class="bf-light">Betfair Pty Limited is licensed and regulated by the Northern Territory Government of Australia.</p>
      <p class="bf-dark">Betfair Pty Limited's gambling operations are governed by its Responsible Gambling Code of Conduct and for South
      Australian residents by the South Australian Responsible Gambling Code of Practice.<br>Think! About your choices. Know when to stop. Donâ€™t go over the top. Gamble responsibly. Call Gambling Help 1800 858 858 <a href="www.gamblinghelponline.org.au">www.gamblinghelponline.org.au</a></p>
      <ul class="bf-links">
        <li><a href="https://www.betfair.com.au/hub/help/account-help/responsible-gambling/">Responsible Gambling</a><span>|</span></li>
        <li><a href="http://www.betfair.com/AUS_NZL/aboutUs/Terms.and.Conditions/">Terms & Conditions</a><span>|</span></li>
        <li><a href="https://www.betfair.com.au/info/privacy-policy/">Privacy Policy</a><span>|</span></li>
        <li><a href="http://www.betfair.com/en/aboutUs/Rules.and.Regulations/">Rules & Regulations</a><span>|</span></li>
        <li><a href="https://www.betfair.com/AUS_NZL/aboutUs/Dispute.Resolution">Dispute Resolution</a></li>
      </ul>
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application.83382bb6.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:"../.."}})</script>
      
        <script src="../../search/main.js"></script>
      
    
    
      
        <script>!function(e,a,t,n,o,c,i){e.GoogleAnalyticsObject=o,e.ga=e.ga||function(){(e.ga.q=e.ga.q||[]).push(arguments)},e.ga.l=1*new Date,c=a.createElement(t),i=a.getElementsByTagName(t)[0],c.async=1,c.src="https://www.google-analytics.com/analytics.js",i.parentNode.insertBefore(c,i)}(window,document,"script",0,"ga"),ga("create","UA-125973915-1","auto"),ga("set","anonymizeIp",!0),ga("send","pageview");var links=document.getElementsByTagName("a");if(Array.prototype.map.call(links,function(e){e.host!=document.location.host&&e.addEventListener("click",function(){var a=e.getAttribute("data-md-action")||"follow";ga("send","event","outbound",a,e.href)})}),document.forms.search){var query=document.forms.search.query;query.addEventListener("blur",function(){if(this.value){var e=document.location.pathname;ga("send","pageview",e+"?q="+this.value)}})}</script>
      
    
  </body>
</html>